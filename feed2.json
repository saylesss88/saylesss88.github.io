{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "nix-book",
  "home_page_url": "https://saylesss88.github.io/",
  "feed_url": "https://saylesss88.github.io/feed2.json",
  "description": "An mdBook-generated site",
  "next_url": "https://saylesss88.github.io/feed3.json",
  "items": [
    {
      "id": "https://saylesss88.github.io/nix/nix_language.html",
      "url": "https://saylesss88.github.io/nix/nix_language.html",
      "title": "Nix Lang",
      "content_html": "<h1>Nix Language</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<!-- ![lambda1](../images/lambda1.png) -->\n<h2>Nix Expression Language Syntax Overview</h2>\n<p>The Nix language is designed for conveniently creating and composing\n<em>derivations</em> precise descriptions of how contents of files are used to derive\nnew files. ‚Äì<a href=\"https://nix.dev/manual/nix/2.28/language/\">Nix Reference Manual</a></p>\n<p>Nix is often described as ‚ÄúJSON with functions.‚Äù It‚Äôs a declarative language\nwhere you define outcomes, not step-by-step instructions. Instead of writing\nsequential code, you create expressions that describe data structures,\nfunctions, and dependencies. These expressions are evaluated lazily, meaning Nix\ncomputes values only when needed, making it efficient for managing large\nsystems.</p>\n<p>You can plug most of the following into the <code>nix repl</code> I‚Äôm showing it in a\nsingle code block here for brevity:</p>\n<pre><code class=\"language-nix\"># Comments Look Like This!\n\n# Strings\n\"This is a string\"          # String literal\n\n''\none\ntwo                        # multi-line String\nthree\n''\n\n(\"foo\" + \"bar\")           # =&gt; \"foobar\"\n\n\"foo\" != \"bar\"   # Inequality test  # =&gt; true\n\n!false      # =&gt; true\n\n(\"Home dir is ${builtins.getEnv \"HOME\"}\")  # String Interpolation\n# =&gt; \"Home dir is /home/jr\"\n\n\"3 6 ${builtins.toString 9}\"\n# =&gt; \"3 6 9\"\n\n\"goodbye ${ { d = \"world\";}.d}\"\n# =&gt; \"goodbye world\"\n\n# Booleans\n\n(false &amp;&amp; true)    # AND         # =&gt; false\n\n(true || false)    # OR         # =&gt; true\n\n(if 6 &lt; 9 then \"yay\" else \"nay\")  # =&gt; \"yay\"\n\nnull      # Null Value\n\n679       # Integer\n\n(6 + 7 + 9) # =&gt; 22   # Addition\n\n(9 - 3  - 2) # =&gt; 4   # Subtraction\n\n(6 / 3)  # =&gt; 2       # Division\n6.79      # Floating Point\n\n/etc/nixos      # Absolute Path\n\n../modules/nixos/boot.nix    # relative\n\n# Let expressions\n\n(let a = \"2\"; in                   # Let expressions are a way to create variables\na + a + builtins.toString \"4\")\n# =&gt; \"224\"\n\n(let first = \"firstname\"; in\n\"lastname \" first)\n# =&gt; \"lastname firstname\"\n\n# Lists\n\n[ 1 2 \"three\" \"bar\" \"baz\" ]   # lists are whitespace separated\n\nbuiltins.elemAt [ 1 2 3 4 5 ] 3\n# =&gt; 4\n\nbuiltins.length [ 1 2 3 4 ]\n# =&gt; 4\n\n# Attrsets\n\n{ first = \"Jim\"; last = \"Bo\"; }.last # Attribute selection\n# =&gt; \"Bo\"\n\n{ a = 1; b = 3; } // { c = 4; b = 2; }   # Attribute Set merging\n# =&gt; { a = 1; b = 2; c = 4; }               # Right Side takes precedence\n\nbuiltins.listToAttrs [ { name = \"Jr\"; value = \"Jr Juniorville\"; } {name = \"$\"; value = \"JR\"; } { name = \"jr\"; value = \"jr\nville\"; }]\n# =&gt; { \"$\" = \"JR\"; Jr = \"Jr Juniorville\"; jr = \"jrville\"; }\n\n# Control Flow\n\nif 2 * 2 == 4\nthen \"yes!\"\nelse \"no!\"\n# =&gt; \"yes!\"\n\nassert 2 * 2\n== 4; \"yes!\"\n# =&gt; \"yes!\"\n\nwith builtins;\nhead [ 5 6 7 ]\n# =&gt; 5\n\n# or\n\nbuiltins.head[ 5 6 7 ]\n\ninherit pkgs     # pkgs = pkgs;\nsrc;             # src = src;\n</code></pre>\n<h3>Understanding Laziness</h3>\n<p>Nix expressions are evaluated lazily, meaning Nix computes values only when\nneeded. This is a powerful feature that makes Nix efficient for managing large\nsystems, as it avoids unnecessary computations.</p>\n<p>For example, observe how <code>a</code> is never evaluated in the following <code>nix-repl</code>\nsession:</p>\n<pre><code class=\"language-nix\">nix-repl&gt; let a = builtins.div 4 0; b = 6; in b\n6\n</code></pre>\n<ul>\n<li>Since <code>a</code> isn‚Äôt used in the final result, there‚Äôs no division by zero error.</li>\n</ul>\n<h3>Strings and String Interpolation</h3>\n<p><strong>Strings</strong>: Strings are enclosed in double quotes (<code>\"</code>) or two single quotes\n(<code>''</code>).</p>\n<pre><code class=\"language-nix\">nix-repl&gt; \"stringDaddy\"\n\"stringDaddy\"\nnix-repl&gt; ''\n  This is a\n  multi-line\n  string\n''\n\"This is a\\nmulti-line\\nstring.\\n\"\n</code></pre>\n<p><a href=\"https://nix.dev/manual/nix/2.24/language/string-interpolation\">string interpolation</a>.\nis a language feature where a string, path, or attribute name can contain an\nexpressions enclosed in <code>${ }</code>. This construct is called an <em>interpolated\nstring</em>, and the expression inside is an <em>interpolated expression</em>.</p>\n<p>Rather than writing:</p>\n<pre><code class=\"language-nix\">let path = \"/usr/local\"; in \"--prefix=${path}\"\n</code></pre>\n<p>This evaluates to <code>\"--prefix=/usr/local\"</code>. Interpolated expressions must\nevaluate to a string, path, or an attribute set with an <code>outPath</code> or\n<code>__toString</code> attribute.</p>\n<h3>Attribute Sets</h3>\n<p><strong>Attribute sets</strong> are all over Nix code and deserve their own section, they are\nname-value pairs wrapped in curly braces, where the names must be unique:</p>\n<pre><code class=\"language-nix\">{\n  string = \"hello\";\n  int = 8;\n}\n</code></pre>\n<p>Attribute names usually don‚Äôt need quotes.</p>\n<p>You can access attributes using <em>dot notation</em>:</p>\n<pre><code class=\"language-nix\">let person = { name = \"Alice\"; age = 30; }; in person.name\n\"Alice\"\n</code></pre>\n<p>You will sometimes see attribute sets with <code>rec</code> prepended. This allows access\nto attributes within the set:</p>\n<pre><code class=\"language-nix\">rec {\n  x = y;\n  y = 123;\n}.x\n</code></pre>\n<p><strong>Output</strong>: <code>123</code></p>\n<p>or</p>\n<pre><code class=\"language-nix\">rec {\n  one = 1;\n  two = one + 1;\n  three = two + 1;\n}\n</code></pre>\n<p><strong>Output</strong>:</p>\n<pre><code class=\"language-nix\"> {\n  one = 1;\n  three = 3;\n  two = 2;\n }\n</code></pre>\n<pre><code class=\"language-nix\"># This would fail:\n{\n  one = 1;\n  two = one + 1;  # Error: undefined variable 'one'\n  three = two + 1;\n}\n</code></pre>\n<p>Recursive sets introduce the danger of <em>infinite recursion</em> For example:</p>\n<pre><code class=\"language-nix\">rec {\n  x = y;\n  y = x;\n}.x\n</code></pre>\n<p>Will crash with an <code>infinite recursion encountered</code> error message.</p>\n<p>The\n<a href=\"https://nix.dev/manual/nix/2.24/language/operators.html#update\">attribute set update operator</a>\nmerges two attribute sets.</p>\n<p><strong>Example</strong>:</p>\n<pre><code class=\"language-nix\">{ a = 1; b = 2; } // { b = 3; c = 4; }\n</code></pre>\n<p><strong>Output</strong>:</p>\n<pre><code class=\"language-nix\">{ a = 1; b = 3; c = 4; }\n</code></pre>\n<p>However, names on the right take precedence, and updates are shallow.</p>\n<p><strong>Example</strong>:</p>\n<pre><code class=\"language-nix\">{ a = { b = 1; }; } // { a = { c = 3; }; }\n</code></pre>\n<p><strong>Output</strong>:</p>\n<pre><code class=\"language-nix\">{ a = { c = 3; }; }\n</code></pre>\n<p>Above, key <code>b</code> was completely removed, because the whole <code>a</code> value was replaced.</p>\n<p><strong>Inheriting Attributes</strong></p>\n<ul>\n<li>Click to see Output:</li>\n</ul>\n<pre><code class=\"language-nix\">let x = 123; in\n{\n  inherit x;\n  y = 456;\n}\n</code></pre>\n<p>is equivalent to</p>\n<pre><code class=\"language-nix\">let x = 123; in\n{\n  x = x;\n  y = 456;\n}\n</code></pre>\n<p>which are both equivalent to</p>\n<pre><code class=\"language-nix\">{\n  x = 123;\n  y = 456;\n}\n</code></pre>\n<blockquote>\n<p>‚ùó: This works because <code>x</code> is added to the lexical scope by the <code>let</code>\nconstruct.</p>\n</blockquote>\n<p>Now that we understand attribute sets lets move on to functions, a powerful\nfeature of the Nix language that gives you the ability to reuse and share\nlogical pieces of code.</p>\n<h3>Functions(lambdas):</h3>\n<p>Functions in Nix help you build reusable components and are the the building\nblocks of Nix. In the next chapter we‚Äôll go even further into Nix functions and\nhow to use them but I will touch on them here.</p>\n<p>Nix functions have this form:</p>\n<pre><code class=\"language-nix\">pattern: body\n</code></pre>\n<p>The following is a function that expects an integer and returns it increased by\n1:</p>\n<pre><code class=\"language-nix\">x: x + 1   # lambda function, not bound to a variable\n</code></pre>\n<p>The pattern tells us what the argument of the function has to look like, and\nbinds variables in the body to (parts of) the argument.</p>\n<pre><code class=\"language-nix\">(x: x + 5) 200\n205\n</code></pre>\n<p>They are all lambdas (i.e. anonymous functions without names) until we assign\nthem to a variable like the following example.</p>\n<p>Functions are defined using this syntax, where <code>x</code> and <code>y</code> are attributes passed\ninto the function:</p>\n<pre><code class=\"language-nix\">{\n  my_function = x: y: x + y;\n}\n</code></pre>\n<p>The code below calls a function called <code>my_function</code> with the parameters <code>2</code> and\n<code>3</code>, and assigns its output to the <code>my_value</code> field:</p>\n<pre><code class=\"language-nix\">{\n  my_value = my_function 2 3;\n}\nmy_value\n5\n</code></pre>\n<p>The body of the function automatically returns the result of the function.\nFunctions are called by spaces between it and its parameters. No commas are\nneeded to separate parameters.</p>\n<p>The following is a function that expects an attribute set with required\nattributes <code>a</code> and <code>b</code> and concatenates them:</p>\n<pre><code class=\"language-nix\">{ a, b }: a + b\n</code></pre>\n<p><strong>Default Values in Functions</strong>:</p>\n<p>Functions in Nix can define <strong>default values</strong> for their arguments. This allows\nfor more flexible function calls where some arguments are optional.</p>\n<pre><code class=\"language-nix\">{ x, y ? \"foo\", z ? \"bar\" }: z + y + x\n</code></pre>\n<ul>\n<li>Specifies a function that only requires an attribute named <code>x</code>, but optionally\naccepts <code>y</code> and <code>z</code>.</li>\n</ul>\n<p><strong>@-patterns in functions</strong>:</p>\n<p>An <code>@-pattern</code> provides a means of referring to the whole value being matched by\nthe function‚Äôs argument pattern, in addition to destructuring it. This is\nespecially useful when you want to access attributes that are not explicitly\ndestructured in the pattern:</p>\n<pre><code class=\"language-nix\">args@{ x, y, z, ... }: z + y + x + args.a\n# or\n{ x, y, z, ... } @ args: z + y + x + args.a\n</code></pre>\n<ul>\n<li>\n<p>Here, <code>args</code> is bound to the argument as <em>passed</em>, which is further matched\nagainst the pattern <code>{ x, y, z, ... }</code>. The <code>@-pattern</code> makes mainly sense\nwith an ellipsis(<code>...</code>) as you can access attribute names as <code>a</code>, using\n<code>args.a</code>, which was given as an additional attribute to the function.</p>\n</li>\n<li>\n<p>We will expand on Functions in\n<a href=\"https://saylesss88.github.io/Understanding_Nix_Functions_2.html\">This Chapter</a></p>\n</li>\n</ul>\n<h3>If, Let, and With Expressions</h3>\n<p>Nix is a pure expression language, meaning every construct evaluates to a value\n‚Äî there are no statements. Because of this, <strong>if expressions</strong> in Nix work\ndifferently than in imperative languages, where conditional logic often relies\non statements (<code>if</code>, <code>elsif</code>, etc.).</p>\n<p><strong>If expressions in Nix</strong>:</p>\n<p>Since everything in Nix is an expression, an <code>if</code> expression must always produce\na value:</p>\n<pre><code class=\"language-nix\">nix-repl&gt; a = 6\nnix-repl&gt; b = 10\nnix-repl&gt; if a &gt; b then \"yes\" else \"no\"\n\"no\"\n</code></pre>\n<p>Here, <code>\"no\"</code> is the result because <code>a</code>(6) is not greater than <code>b</code>(10). Notice\nthat there‚Äôs no separate conditional statement ‚Äì the entire construct evaluates\nto a value.</p>\n<p>Another example, integrating built-in functions:</p>\n<pre><code class=\"language-nix\">{\n  key = if builtins.pathExists ./path then \"YES\" else \"NO!\";\n}\n</code></pre>\n<p>If <code>./path</code> exists it will evaluate to the value <code>\"YES\"</code> or else it will\nevaluate to <code>\"NO!\"</code>.</p>\n<p>Thus, the final result of the expression would be:</p>\n<pre><code class=\"language-nix\">{ key = \"YES\"; }\n# or\n{ key = \"NO!\"; }\n</code></pre>\n<p>Since Nix does not have statements, Nix‚Äôs <code>if</code> statements behave more like\n<a href=\"https://en.wikipedia.org/wiki/Ternary_conditional_operator\">ternary operators</a>\n(<code>condition ? value_if_true : value_if_false</code>) in other languages.</p>\n<p><strong>Let expressions</strong>:</p>\n<p>Let expressions in Nix is primarily a mechanism for local variable binding and\nscoping. It allows you to define named values that are only accessible within\nthe <code>in</code> block of the <code>let</code> expression. This is useful for keeping code clean\nand avoiding repitition.</p>\n<p>For example:</p>\n<pre><code class=\"language-nix\">let\n  a = \"foo\";\n  b = \"fighter\";\nin a + b\n\"foofighter\"\n</code></pre>\n<p>Here, <code>a</code> and <code>b</code> are defined inside the <code>let</code> block, and their values are used\nin the <code>in</code> expression. Since everything in Nix is an expression, <code>a + b</code>\nevaluates to <code>\"foofighter\"</code></p>\n<p><strong>Using Let Expressions Inside Attribute Sets</strong></p>\n<p>Let expressions are commonly used when defining attribute sets (Click for\noutput):</p>\n<pre><code class=\"language-nix\">let\n  appName = \"nix-app\";\n  version = \"1.0\";\nin {\n  name = appName;\n  fullName = appName + \"-\" + version;\n}\n~{\n~  name = \"nix-app\";\n~  fullName = \"nix-app-1.0\";\n~}\n</code></pre>\n<p>This allows you to reuse values within an attribute set, making the code more\nmodular and preventing duplication.</p>\n<p><strong>Let Expressions in Function Arguments</strong></p>\n<p>You can also use let expressions within function arguments to define\nintermediate values before returning an output:</p>\n<pre><code class=\"language-nix\">{ pkgs, lib }:\nlet\n  someVar = \"hello\";\n  otherVar = \"world\";\nin\n{ inherit pkgs lib someVar otherVar; }\n</code></pre>\n<p>Result:</p>\n<pre><code class=\"language-nix\">{\n  pkgs = &lt;value&gt;;\n  lib = &lt;value&gt;;\n  someVar = \"hello\";\n  otherVar = \"world\";\n}\n</code></pre>\n<p>Here, <code>inherit</code> brings <code>pkgs</code> and <code>lib</code> into the resulting attribute set,\nalongside the locally defined variables <code>someVar</code> and <code>otherVar</code>.</p>\n<p><strong>Key Takeaways</strong>:</p>\n<ul>\n<li>\n<p>Let expressions allow local variable bindings that are only visible inside the\nin block. They also help avoid repitition and improve readability.</p>\n</li>\n<li>\n<p>Commonly used inside attribute sets or function arguments.</p>\n</li>\n<li>\n<p>Their scope is limited to the expression in which they are declared.</p>\n</li>\n</ul>\n<p><strong>With expressions</strong>:</p>\n<p>A <code>with</code> expression in Nix is primarily used to simplify access to attributes\nwithin an attribute set. Instead of repeatedly referring to a long attribute\npath, with temporarily brings the attributes into scope, allowing direct access\nwithout prefixing them.</p>\n<p><strong>Basic Example: Reducing Attribute Path Usage</strong></p>\n<p>Consider the following expressions:</p>\n<pre><code class=\"language-nix\">nix-repl&gt; longName = { a = 3; b = 4; }\nnix-repl&gt; longName.a + longName.b\n7\n</code></pre>\n<p>Here, we must explicitly reference <code>longName.a</code> and <code>longName.b</code>. Using a <code>with</code>\nexpression simplifies this:</p>\n<pre><code class=\"language-nix\">nix-repl&gt; with longName; a + b\n7\n</code></pre>\n<p>Now, within the scope of the with expression, <code>a</code> and <code>b</code> are accessible without\nprefixing them with <code>longName</code>.</p>\n<p><strong>Practical Use Case: Working with <code>pkgs</code></strong></p>\n<p>One of the most common uses of <code>with</code> that you‚Äôll see is when dealing with\npackages from <code>nixpkgs</code> is writing the following:</p>\n<pre><code class=\"language-nix\">{ pkgs }:\nwith pkgs; {\n  myPackages = [ vim git neofetch ];\n}\n</code></pre>\n<p>Instead of writing this:</p>\n<pre><code class=\"language-nix\">{ pkgs }:\n{\n  myPackages = [ pkgs.vim pkgs.git pkgs.neofetch ];\n}\n</code></pre>\n<blockquote>\n<p>Tip: Overusing <code>with lib;</code> or <code>with pkgs;</code> can reduce clarity, it may be fine\nfor smaller modules where the scope is limited. For larger configurations,\nexplicit references (<code>pkgs.something</code>) often make dependencies clearer and\nprevent ambiguity.</p>\n</blockquote>\n<h3>Nix Language Quirks</h3>\n<ol>\n<li><code>with</code> gets less priority than <code>let</code>. This can be confusing, especially if\nyou like to write <code>with pkgs;</code>:</li>\n</ol>\n<pre><code class=\"language-nix\">nix-repl&gt; pkgs = { x = 2; }\n\nnix-repl&gt; with pkgs; x\n2\n\nnix-repl&gt; with pkgs; let x = 4; in x\n4\n</code></pre>\n<p>This shows us that the <code>let</code> binding overrides the <code>with</code> binding.</p>\n<pre><code class=\"language-nix\">let x = 4; in with pkgs; x\n4\n</code></pre>\n<p>Still returns <code>4</code>, but the reasoning is different. The <code>with</code> expression doesn‚Äôt\ndefine new bindings; it simply makes attributes from <code>pkgs</code> available as\nunqualified names. However, because <code>let x = 4</code> is <strong>outside</strong> the <code>with</code>, it\nalready extablished <code>x = 4</code>, so when <code>with pkgs; x</code> is evaluated inside, <code>x</code>\nstill refers to the <strong>outer</strong> <code>let</code> binding, not the one from <code>pkgs</code>.</p>\n<ol start=\"2\">\n<li>Default values aren‚Äôt bound in <code>@-patterns</code></li>\n</ol>\n<p>In the following example, calling a function that binds a default value <code>\"baz\"</code>\nto the attribute <code>b</code> of an argument using an alias (<code>@</code>) pattern, with an empty\nattribute set as argument, results in the alias variable inputs being bound to\nthe original empty attribute set instead of including the default value:</p>\n<pre><code class=\"language-nix\">(inputs@(b ? \"baz\"): inputs) {}\n</code></pre>\n<p>Output:</p>\n<pre><code class=\"language-nix\">{}\n</code></pre>\n<p>This happens because the alias <code>inputs@</code> binds to the argument as passed, before\nthe default value for <code>b</code> is applied.</p>\n<p>The syntax requires curly brackets around the attribute set pattern for\ncorrectness, so the fixed syntax would be:</p>\n<pre><code class=\"language-nix\">(inputs@{b ? \"baz\"}: inputs) {}\n</code></pre>\n<p>However, even with this fix, the inputs alias still refers to the original\nargument without defaults applied. So the quirk persists, showing how default\nvalues in <code>@-patterns</code> do not propagate into the aliased variable.</p>\n<ol start=\"3\">\n<li>Destructuring function arguments:</li>\n</ol>\n<pre><code class=\"language-nix\">nix-repl&gt; f = { x ? 2, y ? 4 }: x + y\n\nnix-repl&gt; f { }\n6\n</code></pre>\n<p>The function <code>f</code> takes an attribute set with default values (<code>x = 2</code>, <code>y = 4</code>)</p>\n<p>When called with <code>{}</code> (an empty set), it falls back to the default values\n(<code>2 + 4</code> -&gt; <code>6</code>)</p>\n<p>Using <code>@args</code> to capture the entire input set:</p>\n<p>The <code>@args</code> syntax allows us to retain access to the full attribute set, even\nafter destructuring:</p>\n<pre><code class=\"language-nix\">nix-repl&gt; f = { x ? 1, y ? 2, ... }@args: with args; x + y + z\n\nnix-repl&gt; f { z = 3; }\n6\n</code></pre>\n<p>The <code>{ x ? 1, y ? 2, ... }</code> syntax means <code>x</code> and <code>y</code> have defaults, while <code>...</code>\nallows additional attributes.</p>\n<p><code>@args</code> binds the entire attribute set (<code>args</code>) so that we can access <code>z</code>, which\nwouldn‚Äôt be destructured by default.</p>\n<p>When calling <code>f { z = 3; }</code>, we pass an extra attribute (<code>z = 3</code>), making\n<code>x + y + z</code> ‚Üí <code>1 + 2 + 3 = 6</code>.</p>\n<ol start=\"4\">\n<li>Imports and namespaces</li>\n</ol>\n<p>There is a keyword import, but it‚Äôs equivalent in other languages is eval. It\ncan be used for namespacing too:</p>\n<pre><code class=\"language-nix\">let\n  pkgs = import &lt;nixpkgs&gt; {};\n  lib = import &lt;nixpkgs/lib&gt;;\nin\n  pkgs.runCommand (lib.strings.removePrefix \"....\n</code></pre>\n<p>consider using <code>import</code> here as using <code>qualified import ...</code> in Haskell or\n<code>import ...</code> in Python.</p>\n<p>Another way of importing is with <code>import ...;</code>, which corresponds to Python\n<code>from ... import *</code>.</p>\n<p>But because of not very great IDE support in Nix, <code>with import ...;</code> is\ndiscouraged. Rather use inherit, especially if you are targeting source code for\nNix newcomers:</p>\n<pre><code class=\"language-nix\">let\n  lib = import &lt;nixpkgs/lib&gt;;\n  inherit (lib.strings)\n    removePrefix removeSuffix\n  ;\n  inherit (lib.lists)\n    isList init drop\n  ;\nin\n  removePrefix ...\n</code></pre>\n<p><code>inherit</code> has higher priority than <code>with</code>, and conflicts with <code>let</code></p>\n<pre><code class=\"language-nix\">nix-repl&gt; let pkgs = { x = 1; }; x = 2; x = 3; inherit (pkgs) x; in x\nerror: attribute ‚Äòx‚Äô at (string):1:31 already defined at (string):1:24\n</code></pre>\n<p>This makes it a sane citizen of Nix lanugage‚Ä¶ except it has a twin, called\n<code>{ inherit ...; }</code>. They DON‚ÄôT do the same - <code>let inherit ...</code> adds\nlet-bindings, and <code>{ inherit ...; }</code> adds attributes to a record.\n‚Äì<a href=\"https://nixos.wiki/wiki/Nix_Language_Quirks\">https://nixos.wiki/wiki/Nix_Language_Quirks</a></p>\n<ol start=\"5\">\n<li>Only attribute names can be interpolated, not Nix code:</li>\n</ol>\n<pre><code class=\"language-nix\">nix-repl&gt; let ${\"y\"} = 4; in y\n4\n\nnix-repl&gt; with { ${\"y\"} = 4; }; y\n4\n\nlet y = 1; x = ${y}; in x\nerror: syntax error, unexpected DOLLAR_CURLY\n</code></pre>\n<p><strong>Conclusion</strong></p>\n<ul>\n<li>\n<p><code>let</code> bindings introduce new local values and override anything from <code>with</code>.</p>\n</li>\n<li>\n<p><code>with</code> doesn‚Äôt create bindings - it only makes attributes available within its\nscope.</p>\n</li>\n<li>\n<p>The order matters: If <code>let x = 4</code> is outside <code>with</code>, then <code>x = 4</code> already\nexists before <code>with</code> runs, so <code>with pkgs; x</code> resolves to <code>4</code>, not the value\nfrom <code>pkgs</code>.</p>\n</li>\n</ul>\n<h4>Resources</h4>\n<details>\n<summary> ‚úîÔ∏è Resources (Click to Expand) </summary>\n<p>A few resources to help get you started with the Nix Language, I have actually\ngrown to love the language. I find it fairly simple but powerful!</p>\n<ul>\n<li>\n<p><a href=\"https://nix.dev/tutorials/nix-language.html\">nix.dev nixlang-basics</a></p>\n</li>\n<li>\n<p><a href=\"https://nix.dev/manual/nix/2.24/language/\">Nix Language Overview</a></p>\n</li>\n<li>\n<p><a href=\"https://learnxinyminutes.com/nix/\">learn nix in y minutes</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/tazjin/nix-1p\">nix onepager</a></p>\n</li>\n<li>\n<p><a href=\"https://zero-to-nix.com/concepts/nix-language/\">zero-to-nix nix lang</a></p>\n</li>\n<li>\n<p><a href=\"https://nixos.org/guides/nix-pills/04-basics-of-language.html\">nix-pills basics of nixlang</a></p>\n</li>\n<li>\n<p><a href=\"https://nixos.org/guides/nix-pills/04-basics-of-language\">Basics of the Language Pill</a></p>\n</li>\n</ul>\n</details>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/index.html",
      "url": "https://saylesss88.github.io/nix/index.html",
      "title": "Readme1",
      "content_html": "<h1>Hardening README</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p>üìå <strong>How to Use This Guide</strong></p>\n<p><strong>Read warnings</strong>: Advanced hardening can break compatibility or cause data\nloss! Pause and research before enabling anything not listed above unless you\nunderstand the consequences.</p>\n<p>The guide is broken up into 2 chapters:</p>\n<ul>\n<li>\n<p><a href=\"https://saylesss88.github.io/nix/hardening_NixOS.html\">Hardening NixOS</a></p>\n</li>\n<li>\n<p><a href=\"https://saylesss88.github.io/nix/hardening_networking.html\">Hardening Networking</a></p>\n</li>\n</ul>\n<h2>Getting Started</h2>\n<p>There is a lot covered in this guide which can get overwhelming when trying to\ndecide what is worth implementing. Here, I will list some common recommendations\nthat most users should follow to harden their stance.</p>\n<blockquote>\n<p>‚ÄúThe major problem with current systems is their inability to provide\neffective isolation between various programs running on one machine. E.g. if\nthe user‚Äôs Web browser gets compromised (due to a bug exploited by a malicious\nweb site), the OS is usually unable to protect other user‚Äôs applications and\ndata from also being compromised.‚Äù‚ÄìQubes arch-spec</p>\n</blockquote>\n<h2>Threat Modeling</h2>\n<p>You should always start by conducting a personal threat assesment to identify\npotential threats and vulnerabilities that you need to develop strategies to\ndefend against.</p>\n<p>Threat modeling in computing involves evaluating the security risks to your\ncomputer or network. It helps uncover possible threats and weaknesses so you can\ncreate plans to safeguard your systems and data effectively. By examining\nvarious attack scenarios, you can anticipate potential cyber threats and better\nprotect your digital resources.</p>\n<p>It‚Äôs not possible to protect yourself against every attack(er), focus on the\nmost probable threats to your specific situation.</p>\n<ul>\n<li>\n<p><a href=\"https://ssd.eff.org/playlist/want-security-starter-pack\">EFF Security Starter Pack</a></p>\n</li>\n<li>\n<p><a href=\"https://ssd.eff.org/module/your-security-plan\">EFF Your Security Plan</a></p>\n</li>\n<li>\n<p><a href=\"https://www.kicksecure.com/wiki/Threat_Modeling\">Kicksecure Computer Security Threat Modeling</a></p>\n</li>\n</ul>\n<h3>Baseline Hardening</h3>\n<p>Before diving into advanced or specialized hardening, apply these baseline\nsecurity measures suitable for all NixOS users. These settings help protect your\nsystem with minimal risk of breaking workflows or causing admin headaches.</p>\n<p>There is something to be said about the window manager you use. GNOME, KDE\nPlasma, and Sway secure privileged Wayland protocols like screencopy. This means\nthat on environments outside of GNOME, KDE, and Sway, applications can access\nscreen content of the entire desktop. This implicitly includes the content of\nother applications. It‚Äôs primarily for this reason that Silverblue, Kinoite, and\nSericea images are recommended. COSMIC has plans to fix this.\n‚Äì<a href=\"https://secureblue.dev/images\">secureblue Images</a></p>\n<p>Secureblue recommends disabling Xwayland and finding alternatives for those apps\nas well as disabling <code>xdg-desktop-portal-wlr</code>, this is because the wlroots\ndesktop portal reintroduces the screencopy vulnerability.</p>\n<ul>\n<li>\n<p>Use Disk Encryption (LUKS) to protect your data at rest.</p>\n</li>\n<li>\n<p>Keep your system up to date (update regularly).</p>\n</li>\n<li>\n<p>Use strong, unique passwords. To generate one from the command-line, there is\n<code>pkgs.diceware</code>. Generate a password with: <code>diceware -n 12 -w en_eff</code>, add\nspaces between the words for higher entropy.</p>\n<ul>\n<li><a href=\"https://www.kicksecure.com/wiki/Passwords#Password_Generation\">Kicksecure Password_Generation</a></li>\n</ul>\n</li>\n<li>\n<p>Avoid reusing passwords, use a password manager.</p>\n</li>\n<li>\n<p>Avoid storing files directly in the root home folder (i.e., <code>/home/user</code>),\ncreate sub-folders instead.(i.e., Instead of creating <code>~/notes.txt</code>, create\n<code>~/my-notes/notes.txt</code> or <code>~/Documents/notes.txt</code>).</p>\n<ul>\n<li>\n<p>If you are able to implement a Mandatory Access Control framework, there are\nmore sub-folders that should be avoided such as <code>~/Downloads</code>. Another\nreason to use non-default sub-dirs is to avoid typos deleting important\nfiles.</p>\n</li>\n<li>\n<p>Home-Manager has an option <code>xdg.userDirs.enable</code></p>\n</li>\n</ul>\n</li>\n</ul>\n<pre><code class=\"language-nix\"># home.nix or equivalent\n{\n  xdg.userDirs.enable = true;\n  xdg.userDirs.createDirectories = true;\n  # Optionally create non-default sub-dirs\n  # xdg.userDirs.documents = \"/home/jr/my-documents\";\n  # xdg.userDirs.download = \"/home/jr/my-downloads\";\n}\n</code></pre>\n<ul>\n<li>\n<p>The XDG Base Directory Specification defines a consistent way for apps and\ndesktops to store and find files. It helps prevent ‚Äúdotfile clutter‚Äù by\ndirecting application files into clear, organized locations.</p>\n</li>\n<li>\n<p>Only enable what you use, and actively disable what‚Äôs no longer in use.</p>\n</li>\n<li>\n<p>Enable at least a basic firewall, a more complex firewall example that\nutilizes nftables is shared in the\n<a href=\"https://saylesss88.github.io/nix/hardening_networking.html\">Hardening Networking Chapter</a></p>\n</li>\n</ul>\n<p>Although the firewall is enabled by default on NixOS, let‚Äôs be explicit about\nit, add the following to your <code>configuration.nix</code> or equivalent:</p>\n<pre><code class=\"language-nix\"># configuration.nix\n# this denies incoming connections but allows outgoing and established connections\nnetworking.firewall.enable = true;\n</code></pre>\n<p>Many services provide an option to open the required firewall ports\nautomatically. For example:</p>\n<pre><code class=\"language-nix\">services.tor.openFirewall = true;\n</code></pre>\n<p>This prevents you from having to manually open ports</p>\n<p><strong>Audit and remove local user accounts that are no longer needed</strong>: Regularly\nreview and remove unused or outdated accounts to reduce your system‚Äôs attack\nsurface, improve compliance, and ensure only authorized users have access. The\nfollowing setting ensures that user (and group) management is fully declarative:</p>\n<pre><code class=\"language-nix\"># configuration.nix\n# All users must be declared\nusers.mutableUsers = false;\n</code></pre>\n<p>With <code>users.mutableUsers = false;</code>, all non-declaratively managed (imperative)\nuser management including creation, modification, or password changes will fail\nor be reset on rebuild. User and group definitions become entirely controlled by\nyour system configuration for maximum reproducibility and security. If you need\nto add, remove, or modify users, you must do so in your <code>configuration.nix</code> and\nrebuild the system.</p>\n<p>Don‚Äôt log in as <code>root</code>, it‚Äôs unnecessary.</p>\n<p>Commands that require <code>root</code> permissions should be run individually using <code>sudo</code>\nin all cases. Avoid logging in as <code>root</code> &amp; using <code>sudo su</code>.</p>\n<p>Never run GUI applications as <code>root</code>. If there is a legitimate reason for doing\nthis, use <code>lxsudo</code> instead.</p>\n<hr />\n<blockquote>\n<p>NOTE: There is mention of making\n<a href=\"https://github.com/nikstur/userborn\">userborn</a> the default for NixOS in the\nfuture. It can be more secure by prohibiting UID/GID re-use and giving\nwarnings about insecure password hashing schemes.</p>\n</blockquote>\n<p>I have personally had nothing but problems with <code>userborn</code> and find the docs\nextremely lacking, you need to read the source code to figure anything out which\nis ridiculous. I don‚Äôt personally use this but if you figure it out, more power\nto ya.</p>\n<p>To enable <code>userborn</code>, just add the following to your <code>configuration.nix</code> or\nequivalent:</p>\n<pre><code class=\"language-nix\"># users.nix\n{pkgs,...}:{\nservices.userborn = {\n    enable = true;\n    # Only needed if `/etc` is immutable\n    # passwordFilesLocation = \"/var/lib/nixos/userborn\"\n};\n    users.users = {\n       \"newuser\" = {\n         homeMode = \"755\";\n         uid = 1000;\n         isNormalUser = true;\n         description = \"New user account\";\n         extraGroups = [ \"networkmanager\" \"wheel\" \"libvirtd\" ];\n         shell = pkgs.bash;\n         ignoreShellProgramCheck = true;\n         packages = with pkgs; [];\n       };\n    };\n    }\n</code></pre>\n<p>With <code>userborn</code>, you configure your users as you normally would declaratively\nwith NixOS with <code>users.users</code>, change <code>\"newuser\"</code> to your desired username.</p>\n<p>Explicitly setting <code>uid = 1000;</code> is a best practice for compatibility and\npredictability.</p>\n<hr />\n<p><strong>Only install, enable, and run what is needed</strong>: Disable or uninstall\nunnecessary software and services to minimize potential vulnerabilities. Take\nadvantage of NixOS‚Äôs easy package management and minimalism to keep your system\nlean and secure.</p>\n<p><strong>Avoid permanently installing temporary tools</strong>: Use tools like <code>nix-shell</code>,\n<code>comma</code>, <code>devShells</code> and <code>nix-direnv</code> to test or run software temporarily. This\nprevents clutter and reduces potential risks from unused software lingering on\nthe system.</p>\n<p><strong>Update regularly</strong>: Keep your system and software up to date to receive the\nlatest security patches. Delaying updates leaves known vulnerabilities open to\nexploitation.</p>\n<p><strong>Apply the Principle of Least Privilege</strong>: Never run tools or services as root\nunless absolutely necessary. Create dedicated users and groups with the minimum\nrequired permissions to limit potential damage if compromised.</p>\n<p><strong>Use strong passwords and passphrases</strong>: Aim for at least 14‚Äì16 characters by\ncombining several unrelated words, symbols, and numbers. For example:\n<code>sunset-CoffeeHorse$guitar!</code>. Strong passphrases are both memorable and secure.</p>\n<p><strong>Use a password manager and enable multi-factor authentication (MFA)</strong>: Manage\nunique, strong passwords effectively with a trusted manager and protect accounts\nwith MFA wherever possible for a second layer of defense.</p>\n<p><strong>Check logs regularly</strong>: Reviewing your system logs helps you spot unusual\nactivity, errors, or failed login attempts that could indicate a security\nproblem. NixOS uses <code>journald</code> by default, which makes this easy. For example,\nto see the logs for your current boot session:</p>\n<pre><code class=\"language-bash\">journalctl -b\n# for the previous session\njournalctl -b -1\n</code></pre>\n<p>After establishing some standard best practices and a hardened base, it‚Äôs time\nto dive deeper into system hardening, the process of adding layered safeguards\nthroughout your NixOS setup. This next section guides you through concrete steps\nand options for hardening critical areas of your system: from encryption and\nsecure boot to managing secrets, tightening kernel security, and leveraging\nplatform-specific tools.\n<a href=\"https://saylesss88.github.io/nix/hardening_NixOS.html\">Hardening NixOS</a></p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/gpg-agent.html",
      "url": "https://saylesss88.github.io/nix/gpg-agent.html",
      "title": "GnuPG gpg-agent",
      "content_html": "<h1>GnuPG &amp; <code>gpg-agent</code> on NixOS</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<blockquote>\n<p>‚ö†Ô∏è <strong>SECURITY WARNING</strong>: This guide involves sensitive cryptographic material.\n<strong>Never share your private key or passphrase</strong>. Backup your keys and handle\nthem with extreme care.</p>\n</blockquote>\n<h2>üîë Key Concepts</h2>\n<p><strong>GnuPG</strong> is a complete and free implementation of the OpenPGP standard. It\nallows you to encrypt and sign your data and communications, has a versatile key\nmanagement system, and access modules for many kinds of public key directories.\nGnuPG (GPG), is a command line tool for secure communication.</p>\n<p><strong>PGP (Pretty Good Privacy)</strong> and <strong>GPG (GNU Privacy Guard)</strong>. While distinct,\nthey are deeply interconnected and, for the rest of this section, I‚Äôll use the\nterms interchangeably.</p>\n<p><strong>PGP</strong> was the original, groundbreaking software that brought robust public-key\ncryptography to the masses. It set the standard for secure email communication.\nHowever, PGP later became a commercial product.</p>\n<p>To provide a free and open-source alternative that anyone could use and inspect,\n<strong>GPG</strong> was created. Crucially, <strong>GPG</strong> is a complete implementation of the\nOpenPGP standard. This open standard acts as a universal language for encryption\nand digital signatures.</p>\n<p>GnuPG uses a more complex scheme in which a user has a primary keypair and then\nzero or more additional subordinate keypairs.</p>\n<p>Signing public keys with the corresponding private key is called <em>self-signing</em>,\nand a public key that has self-signed user IDs bound to it is called a\n<em>certificate</em>.</p>\n<p><strong>Web of Trust</strong>: Rather than validate every single key individually, you can\nrely on other factors such as if it has been signed by a key that you fully\ntrust or if it has been signed by three marginally trusted keys to validate\nkeys.</p>\n<p><code>gpg-agent</code> is a daemon to manage secret (private) keys independently from any\nprotocol. It is used as a backed for <code>gpg</code> and <code>gpgsm</code> as well as for a couple\nof other utilities. ‚Äì<a href=\"https://man.cx/gpg-agent\">man gpg-agent</a></p>\n<p>There are numerous front-ends for gpg as well, i.e., GUI apps that simplify many\nof the commands and processes. Two that I touch on in this overview are\n<code>seahorse</code> and <code>kleopatra</code>.</p>\n<h3>Asymmetric Encryption (Public-Key cryptography)</h3>\n<p>E2ee requires that every sender and recipient does a one time preparation, which\ninvolves the generation of personal random numbers. Two such random numbers are\nnecessary, one will be called your secret key and another one will be called\nyour public key (together your <em>personal key</em>). These numbers are very big, they\nconsist of hundreds or thousands of digits.</p>\n<p>A message can be encrypted using the recipients public key and can only be\ndecrypted with the matching private key. In other words, if you exchange\n<strong>public keys</strong> with someone you both can encrypt messages that only the other\ncan decrypt with their own <strong>private key</strong>. <strong>You must never share the private\nkey or the private keys passphrase with anyone else</strong>.</p>\n<p><strong>What‚Äôs safe to share?</strong></p>\n<ul>\n<li>\n<p>Your public key (used to encrypt files and verify signatures)</p>\n</li>\n<li>\n<p>Your key ID (identifies your key, useful for sharing public keys or configs)</p>\n</li>\n<li>\n<p>Your keys fingerprint <code>gpg --fingerprint</code></p>\n</li>\n</ul>\n<p><strong>What must never be shared?</strong></p>\n<ul>\n<li>\n<p>Your private (secret) key, usually in your <code>~/.gnupg/private-keys-v1.d/</code>\ndirectory. Usually called your <em>private keyring</em>. <strong>Your main goal should be\nthe protection of your private key</strong>.</p>\n</li>\n<li>\n<p><strong>Your passphrase for your private key</strong>. Even if someone is able to somehow\nget your private key, they need to break the passphrase to access it\nunencrypted. <strong>Protect this passphrase</strong>!</p>\n</li>\n</ul>\n<p><strong>Best Practices</strong></p>\n<p>Don‚Äôt rely on the short KeyID, at least use long OpenPGP Key IDs (for example\n0xA1E6148633874A3D), they are 64 bits long and harder to spoof. Even better, use\nthe fingerprint.This is accomplished in the configuration with\n<code>keyid-format = \"0xlong\";</code>, and <code>with-fingerprint</code>.</p>\n<p>Always sign your public keys before you publish them to prevent man in the\nmiddle attacks and other modifications. When a subkey or userID is generated it\nis self-signed automatically, which is why you need to enter your password.</p>\n<p>Don‚Äôt blindly trust keys from keyservers. You should verify the full key\nfingerprint with the owner over the phone if possible.</p>\n<ul>\n<li><a href=\"https://www.kicksecure.com/wiki/Verifying_Software_Signatures\">Verifying software signatures</a></li>\n</ul>\n<p>Use a strong primary key, don‚Äôt use 1024-bit DSA, 1024-bit RSA, or SHA-1 for\nsigning they are no longer recommended.</p>\n<p>Choose an expiration date less than 2 years, you can add time if needed.\nRemember this date.</p>\n<p>Rotate your subkeys.</p>\n<p>Keep your primary key offline, this ensures that it can‚Äôt be stolen by an\nattacker allowing him to create new identities. We accomplish this by creating\nsubkeys and only adding the subkeys keygrip and the subkeys <code>default-key</code> to our\nconfiguration keeping the primary key out of it.</p>\n<p>Since we will be removing our primary key, even we won‚Äôt be able to create\nadditional keys so it‚Äôs important to think ahead and make all the keys you‚Äôll\nneed. However, it is as easy as reimporting it to give yourself access again.</p>\n<p>Many of these best practices come from the following guide:</p>\n<ul>\n<li><a href=\"https://riseup.net/ru/security/message-security/openpgp/gpg-best-practices\">RiseUp gpg-best-practices</a></li>\n</ul>\n<hr />\n<p>Home Manager module with <code>gpg-agent</code>, <code>gnupg</code>, and <code>pinentry-gnome3</code>:</p>\n<pre><code class=\"language-nix\"># gpg-agent.nix\n{\n  config,\n  lib,\n  pkgs,\n  ...\n}: {\n  options = {\n    custom.pgp = {\n      enable = lib.mkEnableOption {\n        description = \"Enable PGP Gnupgp\";\n        default = false;\n      };\n    };\n  };\n\n  config = lib.mkIf config.custom.pgp.enable {\n    services = {\n      ## Enable gpg-agent with ssh support\n      gpg-agent = {\n        enable = true;\n        enableSshSupport = true;\n        enableZshIntegration = true;\n        # pinentry is a collection of simple PIN or passphrase dialogs used for\n        # password entry\n        pinentryPackage = pkgs.pinentry-gnome3;\n      };\n\n      ## We will put our keygrip here\n      gpg-agent.sshKeys = [];\n    };\n    home.packages = [pkgs.gnupg];\n    programs = {\n      # Gui for OpenPGP\n      seahorse.enable = true;\n      gpg = {\n        ## Enable GnuPG\n        enable = true;\n\n        # homedir = \"/home/userName/.config/gnupg\";\n        settings = {\n          # Default/trusted key ID (helpful with throw-keyids)\n          # Example, you will put your own keyid here\n          # Use `gpg --list-keys`\n          # default-key = \"0x37ACBCDA569C5C44788\";\n          # trusted-key = \"0x37ACBCDA569C5C44788\";\n          # https://github.com/drduh/config/blob/master/gpg.conf\n          # https://www.gnupg.org/documentation/manuals/gnupg/GPG-Configuration-Options.html\n          # https://www.gnupg.org/documentation/manuals/gnupg/GPG-Esoteric-Options.html\n          # Some Best Practices, stronger algos etc\n          # Use AES256, 192, or 128 as cipher\n          personal-cipher-preferences = \"AES256 AES192 AES\";\n          # Use SHA512, 384, or 256 as digest\n          personal-digest-preferences = \"SHA512 SHA384 SHA256\";\n          # Use ZLIB, BZIP2, ZIP, or no compression\n          personal-compress-preferences = \"ZLIB BZIP2 ZIP Uncompressed\";\n          # Default preferences for new keys\n          default-preference-list = \"SHA512 SHA384 SHA256 AES256 AES192 AES ZLIB BZIP2 ZIP Uncompressed\";\n          # SHA512 as digest to sign keys\n          cert-digest-algo = \"SHA512\";\n          # SHA512 as digest for symmetric ops\n          s2k-digest-algo = \"SHA512\";\n          # AES256 as cipher for symmetric ops\n          s2k-cipher-algo = \"AES256\";\n          # UTF-8 support for compatibility\n          charset = \"utf-8\";\n          # Show Unix timestamps\n          fixed-list-mode = \"\";\n          # No comments in signature\n          no-comments = \"\";\n          # No version in signature\n          no-emit-version = \"\";\n          # Disable banner\n          no-greeting = \"\";\n          # Long hexidecimal key format\n          keyid-format = \"0xlong\";\n          # Display UID validity\n          list-options = \"show-uid-validity\";\n          verify-options = \"show-uid-validity\";\n          # Display all keys and their fingerprints\n          with-fingerprint = \"\";\n          # Cross-certify subkeys are present and valid\n          require-cross-certification = \"\";\n          # Disable caching of passphrase for symmetrical ops\n          no-symkey-cache = \"\";\n          # Enable smartcard\n          # use-agent = \"\";\n        };\n      };\n    };\n  };\n}\n</code></pre>\n<blockquote>\n<p>ü§î Fun Fact: Elliot Alderson mentions encrypting Evil Corps files with 256 bit\nAES encryption ensuring that it‚Äôs impossible to break in <code>eps1.9_zer0.daY.avi</code>\nof Mr. Robot.</p>\n</blockquote>\n<ul>\n<li>\n<p>The default path is <code>~/.gnupg</code>, if you prefer placing it in the <code>~/.config</code>\ndirectory or elsewhere, uncomment the <code>homedir</code> line and change <code>userName</code> to\nyour username.</p>\n</li>\n<li>\n<p>I use hyprland so <code>pinentry-gnome3</code> works for me, there is also the following\noptions for this attribute:</p>\n</li>\n<li>\n<p><code>pinentry-tty</code></p>\n</li>\n<li>\n<p><code>pinentry-qt</code></p>\n</li>\n<li>\n<p><code>pinentry-gtk2</code></p>\n</li>\n</ul>\n<p>And more, research what you need and use the correct one.</p>\n<p>Enable in your <code>home.nix</code> or equivalent:</p>\n<pre><code class=\"language-nix\"># home.nix\n# ... snip ...\nimports = [\n    ./gpg-agent.nix\n];\ncustom.pgp.enable = true;\n# ... snip ...\n</code></pre>\n<p><code>gpg --full-generate-key</code> can be used to generate a basic keypair.</p>\n<p><code>gpg --expert --full-generate-key</code> can be used for keys that require more\ncapabilities.</p>\n<blockquote>\n<p>‚ùó NOTE: We will first generate our GPG primary key that is required to\natleast have sign capabilities, we will then derive subkeys from said primary\nkey and use them for signing and encrypting. It is recommended to generate a\nrevoke certificate right after creating your primary key.</p>\n</blockquote>\n<p>To generate your gpg primary key you can do the following:</p>\n<pre><code class=\"language-bash\">gpg --full-generate-key\n</code></pre>\n<ul>\n<li>\n<p>Choose <code>(10) (sign only)</code></p>\n</li>\n<li>\n<p>Give it a name and description</p>\n</li>\n<li>\n<p>Give it an expiration date, 1y is common</p>\n</li>\n<li>\n<p>Use a strong passphrase or password</p>\n</li>\n<li>\n<p>Give it a comment, I typically add the date</p>\n</li>\n</ul>\n<p>If you see a warning about incorrect permissions, you can run the following:</p>\n<pre><code class=\"language-bash\">chmod 700 ~/.gnupg\nchmod 600 ~/.gnupg/*\n</code></pre>\n<p>Verify:</p>\n<pre><code class=\"language-bash\">ls -ld ~/.gnupg\n# Should show: drwx------\n\nls -l ~/.gnupg\n# Files should show: -rw-------\n</code></pre>\n<h3>Generate a Revocation Certificate</h3>\n<p><code>mykey</code> must be a key specifier, either the keyID of the primary keypair or any\npart of the user ID that identifies the keypair:</p>\n<p>Replace <code>mykeyID</code> with the keyID of your primary key and store the cert in a\nsafe place:</p>\n<pre><code class=\"language-bash\">gpg --output revoke.asc --gen-revoke mykeyID\nCreate a revocation certificate for this key? (y/N)\nPlease select the reason for the revocation:\n  0 = No reason specified\n  1 = Key has been compromised\n  2 = Key is superseded\n  3 = Key is no longer used\n  Q = Cancel\n(Probably you want to select 1 here)\nYour decision?\n</code></pre>\n<p>The certificate will be output to a file <code>revoke.asc</code>. If the <code>--output</code> is\nommitted, the result will be placed on stdout.</p>\n<p>Since it‚Äôs a short certificate, you can print a hardcopy and store it somewhere\nsafe. The cert shouldn‚Äôt be somewhere that others can access it since anyone\ncould publish the revoke cert and render the corresponding public key useless.</p>\n<p>To apply the revoke cert, import it:</p>\n<pre><code class=\"language-bash\">gpg --import revoke.asc\n# And optionally push the revoked key to public keyservers to notify others:\ngpg --keyserver keyserver.ubuntu.com --send-keys YOUR_KEYID\n</code></pre>\n<hr />\n<p>After fixing, run <code>gpg --list-keys --with-fingerprint</code>, which lists your public\nkeys:</p>\n<pre><code class=\"language-bash\"># Take note of your public key\ngpg --list-keys --with-fingerprint\n/home/jr/.gnupg/pubring.kbx\n---------------------------\npub   ed25519/0x095782A1B124AF15 2025-08-23 [SCA] [expires: 2026-08-23]\nKey fingerprint = 5908 9C5B FEC8 0D75 FCB0  E206 0958 82C1 A124 CF15\nuid                   [ultimate] Jr (08-23-25) &lt;sayls8@proton.me&gt;\n</code></pre>\n<ul>\n<li>Copy the KeyID, in this example it would be <code>0x095722B2A123CF15</code>. We will use\nit for the command below.</li>\n</ul>\n<p>The warning should be gone.</p>\n<p>Now we will generate 2 subkeys, 1 for encryption and 1 for authentication.</p>\n<pre><code class=\"language-bash\">gpg --expert --edit-key 0x095722B2A123CF15\n</code></pre>\n<p>Choose 11 (set your own capabilities) and add A (Authenticate) and type <code>save</code>\nto save and exit. Repeat this again and choose ECC (encrypt only).</p>\n<blockquote>\n<p>‚ùó <code>gpg --edit-key</code> has many more capabilities, after launching type <code>help</code>.</p>\n</blockquote>\n<p><strong>Add Keygrip of Authenticate Subkey to <code>sshcontrol</code> for gpg-agent</strong></p>\n<pre><code class=\"language-bash\">gpg --list-secret-keys --with-keygrip --keyid-format LONG\n</code></pre>\n<p>Copy the keygrip of the subkey with Authenticate capabilities</p>\n<p>Add the keygrip number to your <code>gpg-agent.sshKeys</code> and rebuild, this adds an SSH\nkey to <code>gpg-agent</code>. This is for the SSH key functionality of <code>gpg-agent</code>, while\nthe key ID (<code>default-key</code>) is for GPG-specific operations like signing commits:</p>\n<pre><code class=\"language-nix\"># gpg-agent.nix\ngpg-agent.sshKeys = [\"6BD11826F3845BC222127FE3D22C92C91BB3FB32\"];\n</code></pre>\n<ul>\n<li>By itself, a keygrip cannot be used to reconstruct your private key. It‚Äôs\nderived from the public key material, not from the secret key itself so it‚Äôs\nsafe to version control. Don‚Äôt put your keygrip in a public repo if you don‚Äôt\nwant people to know you use that key for signing/authentication. It‚Äôs not a\nsecurity risk, but it leaks a tiny bit of metadata.</li>\n</ul>\n<p>The following article mentions the keygrip being computed from public elements\nof the key:</p>\n<ul>\n<li><a href=\"https://gnupg-users.gnupg.narkive.com/q5JtahdV/gpg-agent-what-is-a-keygrip\">gnupg-users what-is-a-keygrip</a></li>\n</ul>\n<p>Add the KeyId to your <code>gpg-agent.nix</code>, this declares your default-key to persist\nthrough rebuilds:</p>\n<p>Copy the public key of the same subkey with Authenticate capabilities you will\nsee something like <code>[SA]</code> next to it for Sign and Authenticate:</p>\n<pre><code class=\"language-nix\"># gpg-agent.nix\ngpg.settings = {\n    # Replace with your own Subkeys KeyID `gpg --list-keys --keyid-format LONG`\n    default-key = \"Ox37ACA569C5C44787\";\n    trusted-key = \"Ox37ACA569C5C44787\";\n};\n</code></pre>\n<p>This key should be signed automatically, ensure that it is:</p>\n<pre><code class=\"language-bash\">gpg --sign-key Ox37ACA569C5C44787\n</code></pre>\n<p>Rebuild, and check that everything is correct with:</p>\n<pre><code class=\"language-bash\">ssh-add -L\n# you should see something like:\nssh-ed25519 AABCC3NzaC1lZDI1NTE5ABBAIHyujgyCjjBTqIuFM3EMUSo6RGklmOXQW3uWRhWdJ1Mm (none)\n</code></pre>\n<ul>\n<li>Never version-control your private key files or <code>.gnupg</code> contents.</li>\n</ul>\n<p>Add the following to your shell config:</p>\n<pre><code class=\"language-bash\"># zsh.nix\n# ... snip ...\ninitContent = ''\n    export GPG_TTY=$(tty)\n    export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)\n    gpgconf --launch gpg-agent\n'';\n# ... snip ...\n</code></pre>\n<p>Rebuild and then restart <code>gpg-agent</code> if necessary:</p>\n<pre><code class=\"language-bash\">gpgconf --kill gpg-agent\ngpgconf --launch gpg-agent\n</code></pre>\n<p>Test, these should match:</p>\n<pre><code class=\"language-bash\">echo \"$SSH_AUTH_SOCK\"\n# output\n/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76534j/S.gpg-agent.ssh\n\ngpgconf --list-dirs agent-ssh-socket\n# output\n/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76834j/S.gpg-agent.ssh\n</code></pre>\n<pre><code class=\"language-bash\">ssh-add -L\n# Copy the entire following line:\nssh-ed25519 AABBC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I (none)\n</code></pre>\n<ul>\n<li>Mine shows <code>(none)</code> because I left the comment field blank when creating the\nkey and doesn‚Äôt affect functionality.</li>\n</ul>\n<p>Then, in your server‚Äôs NixOS configuration (e.g., <code>configuration.nix</code>): Change\n<code>yourUser</code> to your username. This is how you grant access to a remote machine,\nand the public key from the GPG subkey is what‚Äôs added here, the output of\n<code>ssh-add -L</code>:</p>\n<pre><code class=\"language-nix\">users.users.yourUser = {\nopenssh = {\n  authorizedKeys.keys = [\n    # Replace with the output of `ssh-add -L`\n    \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I (none)\"\n  ];\n};\n};\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: Only the <strong>public</strong> key goes here, it‚Äôs safe to commit to version\ncontrol. If you prefer not to hardcode it in the config, you can reference it\nfrom a <code>.pub</code> file in your repo and read it with\n<code>builtins.readFile ./mykey.pub</code></p>\n</blockquote>\n<p>Rebuild your system and test an SSH connection into the server:</p>\n<pre><code class=\"language-bash\">ssh -p &lt;your-port&gt; user@hostname\n</code></pre>\n<ul>\n<li><code>&lt;your-port&gt;</code> is often <code>22</code> so it would be something like:</li>\n</ul>\n<pre><code class=\"language-bash\">ssh -p 22 bill@xps\n</code></pre>\n<p>Once you successfully sign in to SSH, it will ask you if you‚Äôre sure you trust\nthe remote server‚Äôs SSH host key. Once you type <code>yes</code>, it will automatically be\nused for tasks such as file decryption.</p>\n<h3>Remove and Store your Primary Key offline</h3>\n<blockquote>\n<p>‚ùó NOTE: After you remove your primary key, you will no longer be able to\nderive subkeys from it or sign keys unless you re-import it.</p>\n</blockquote>\n<pre><code class=\"language-bash\"># extract the primary key\ngpg -a --export-secret-key sayls8@proton.me &gt; secret_key\n# extract the subkeys, which we will reimport later\ngpg -a --export-secret-subkeys sayls8@proton.me &gt; secret_subkeys.gpg\n# delete the secret keys from the keyring, so only subkeys are left\ngpg --delete-secret-keys sayls8@proton.me\nDelete this key from the keyring? (y/N) y\nThis is a secret key! - really delete? (y/N) y\n# reimport the subkeys\ngpg --import secret_subkeys.gpg\n# verify everything is in order\ngpg --list-secret-keys\n# remove the subkeys from disk\nrm secret_subkeys.gpg\n</code></pre>\n<p>I recommend also keeping a <code>.gpg</code> version to make it easy to re-import your\nprimary key: <code>gpg --export-secret-keys --armor --output private-key-bak.gpg</code></p>\n<p>Then store <code>secret_key</code> on an encrypted USB drive or somewhere offline. If you\nwant to protect it for now, you can just use the encryption subkey that we\ncreated to encrypt <code>secret_key</code> with a passphrase:</p>\n<pre><code class=\"language-bash\">gpg --list-keys --keyid-format LONG\n</code></pre>\n<p>Copy the KeyID of the subkey with encrypt capabilities for the following\ncommand:</p>\n<pre><code class=\"language-bash\"># Encrypting your secret key for yourself\ngpg --encrypt --recipient Ox37ACA569C5C44787 secret_key\n</code></pre>\n<p>You can check that the secret key material is missing with\n<code>gpg --list-secret-keys</code>, you should see <code>sec#</code> instead of <code>sec</code>.</p>\n<pre><code class=\"language-bash\">gpg --list-secret-keys\n# Output:\nsec#  ed25519/0x\n# ...snip...\n</code></pre>\n<p>The above set of commands are from the\n<a href=\"https://riseup.net/ru/security/message-security/openpgp/gpg-best-practices#keep-your-primary-key-entirely-offline\">RiseUp Keep your primary key offline</a></p>\n<h2>Add your GPG Key to GitHub</h2>\n<p>Plug your own public key from <code>gpg --list-keys</code> in the following command:</p>\n<pre><code class=\"language-bash\">gpg --armor --export &lt;Public-Key&gt;\n</code></pre>\n<p>Copy the entire block from <code>-----BEGIN PGP PUBLIC KEY BLOCK-----</code> to\n<code>-----END PGP PUBLIC KEY BLOCK-----</code></p>\n<blockquote>\n<p>‚ùó You can also paste the above block into a public keyserver such as\n<code>keys.openpgp.org</code>. This allows others to find and use your key to encrypt\nmessages or verify your signatures. Many tools and users rely on public key\nservers to fetch keys automatically. You can also publish your revocation\ncertificates, which help others know if your key is compromised or revoked.\nThis can be a privacy concern as key servers publish (and keep) associated\nuser IDs and metadata linked to your key, such as your email.</p>\n</blockquote>\n<p>It‚Äôs the same process as adding an SSH key, Go to Settings, SSH and GPG keys,\n<code>New GPG key</code> and your all set.</p>\n<h3>Sign your Commits for Git</h3>\n<pre><code class=\"language-nix\"># git.nix\n{...}: {\n    programs.git = {\n        enable = true;\n      extraConfig = {\n          commit.gpgsign = true;\n          user.signingkey = \"0x0666C1A265F156\"\n      };\n    };\n}\n</code></pre>\n<p>After this, you will be prompted for your Private Keys password on every commit.</p>\n<p>If you look at your commits on GitHub, after adding the GPG key and the above\nsettings to your git setup it will show your commits are <code>Verified</code>.</p>\n<h3>Backing up Your Keys</h3>\n<pre><code class=\"language-bash\">gpg --export-secret-keys --armor --output my-private-key-backup.gpg\n</code></pre>\n<p>Your private keys will be encrypted with a passphrase into a .gpg file. Store\nthis backup in a secure location line an encrypted USB drive. This can prevent\nyou from losing access to your keys in the case of disk failure or accidents.</p>\n<p>You can export your public keys and publish them publicly if you choose:</p>\n<pre><code class=\"language-bash\">gpg --export --armor --output my-public-keys.gpg\n</code></pre>\n<p>Now if your keys ever get lost or corrupted, you can import these backups.</p>\n<h2>Encrypt a File with PGP</h2>\n<p>The easy way to do this is with an app like Kleopatra, available as\n<code>pkgs.kdePackages.kleopatra</code>. Kleopatra will automatically recognize your gpg\nkeys and enable you to easily encrypt messages by clicking the Notepad, typing\nyour message and clicking <code>Sign/Encrypt Notepad</code>. You can also choose to encrypt\nthe message with a password, where anyone that has the password can read the\nmessage.</p>\n<p>Using the above and below methods enable you to encrypt any message for\nbasically any service and just copy past the encrypted text into the service for\nadded privacy.</p>\n<p>Encrypting a whole directory is a bit more involved and requires using\ncompression.</p>\n<h3>List your keys and get the key ID</h3>\n<pre><code class=\"language-bash\">gpg --list-keys --keyid-format LONG\n</code></pre>\n<p>Example output, don‚Äôt use RSA keys:</p>\n<pre><code class=\"language-bash\">pub   rsa4096/ABCDEF1234567890 2024-01-01 [SC]\nuid           [ultimate] Your Name &lt;you@example.com&gt;\nsub   rsa4096/1234567890ABCDEF 2024-01-01 [E]\n</code></pre>\n<ul>\n<li>\n<p>Notice the <code>sub</code> and the <code>[E]</code> for the subkey with encrypt capabilities.</p>\n</li>\n<li>\n<p>The part after the slash on the <code>pub</code> line is your key ID (<code>ABCDEF1234567890</code>\nin the example)</p>\n</li>\n<li>\n<p>You can also use your email or name to refer to the key in most commands.</p>\n</li>\n</ul>\n<h3>Encrypt a file</h3>\n<p>In order to encrypt a document you must have the public keys of the intended\nrecipients.</p>\n<pre><code class=\"language-bash\">echo \"This file will be encrypted\" &gt; file.txt\n</code></pre>\n<p>Encrypting for yourself (using a key ID as recipient):</p>\n<pre><code class=\"language-bash\">gpg --encrypt --recipient ABCDEF1234567890 file.txt\n</code></pre>\n<pre><code class=\"language-bash\">ls\n‚îÇ  7 ‚îÇ file.txt            ‚îÇ file ‚îÇ     28 B ‚îÇ now           ‚îÇ\n‚îÇ  8 ‚îÇ file.txt.gpg        ‚îÇ file ‚îÇ    191 B ‚îÇ now           ‚îÇ\n</code></pre>\n<p>Encrypting for someone else with their email (public key identifier):</p>\n<pre><code class=\"language-bash\">gpg --output file.gpg --encrypt --recipient jake@proton.me file.txt\n</code></pre>\n<pre><code class=\"language-bash\">ls\nfile.txt\nfile.gpg\n</code></pre>\n<p><code>gpg --encrypt</code> doesn‚Äôt modify the original file. It creates a new encrypted\nfile by default with <code>gpg</code> amended to the filename.</p>\n<pre><code class=\"language-bash\">gpg --decrypt file.txt.gpg\ngpg: encrypted with cv25519 key, ID 0x4AC131B80CEC833E, created 2025-07-31\n      \"GPG Key &lt;sayls8@proton.me&gt;\"\nThis file will be encrypted\n</code></pre>\n<p>Or, to save the decrypted text to a file:</p>\n<pre><code class=\"language-bash\">gpg --output decrypted_file.txt --decrypt file.txt.gpg\ncat decrypted_file.txt\n# Output\nFile: decrypted.txt\nThis file will be encrypted\n</code></pre>\n<ul>\n<li>You will be asked for the passphrase you used when creating the key in order\nto decrypt the file.</li>\n</ul>\n<h3>Sign and Verify Signatures</h3>\n<p>When you sign a document it is certified and timestamped. If after the doc is\nsigned, if the doc is further modified in any way the verification of the\nsignature will fail.</p>\n<p>A signature is created using the private key of the signer, and verified with\nthe corresponding public key. For example, to verify Jakes signature you would\nuse Jake‚Äôs public key to see that the work indeed came from him and hasn‚Äôt been\nmodified since.</p>\n<p>To sign the above <code>file.txt</code>:</p>\n<pre><code class=\"language-bash\">gpg output doc.sig --sign file.txt\n# To clearsign use:\ngpg --clearsign file.txt\n# For a detached signature use:\ngpg --output doc.sig --detach-sig file.txt\n</code></pre>\n<p>You will be prompted for your passphrase.</p>\n<p>You can either check the signature or check the signature and recover the\noriginal document.</p>\n<pre><code class=\"language-bash\"># To only check:\ngpg --output doc --verify doc.sig\n# To verify and extract the document\ngpg --output doc --decrypt doc.sig\n</code></pre>\n<h2>Email Encryption</h2>\n<p>Email is inherently insecure, and email-based attacks remain one of the top\nvectors for data breaches. Encrypting your email protects your privacy by\nensuring that only the intended recipient can read it. Encrypting your emails\nwith PGP provides valuable security benefits but also has inherent limitations\nthat prevent it from being considered truly ‚Äúsecure communication‚Äù by modern\nstandards.</p>\n<ul>\n<li><a href=\"https://emailselfdefense.fsf.org/en/\">Email Self-Defense</a></li>\n</ul>\n<p>What its Good for:</p>\n<ul>\n<li>\n<p>Confidentiality, it prevents unauthorized third parties (like email providers\nor network eavesdroppers) from reading your email content.</p>\n</li>\n<li>\n<p>Integrity and authenticity: Digital signatures verify that the email genuinely\ncame from the claimed sender and hasn‚Äôt been altered in transit.</p>\n</li>\n<li>\n<p>Long-term confidentiality: Encrypted emails stored on servers or devices\nremain protected even if the storage is later compromised. With companies like\nGmail giving you a ‚Äúfree‚Äù account, that usually means that you are the product\nand you should tread lightly.</p>\n</li>\n</ul>\n<p><strong>To securely communicate with someone never use email, use a dedicated service\nsuch as Threema, Signal or Brair.</strong> It‚Äôs hard to recommend any messaging service\nat the moment, always do your own research and stay informed on the companies\npolicies. Signal has taken some heat for the way it has implemented it‚Äôs\nMobileCoin. The biggest issue I‚Äôve faced is getting other people to care or use\nthe same e2ee app.</p>\n<p>With Thunderbird you can go to settings, Privacy and Security, and scroll to the\nbottom where it says ‚ÄúEnd to End Encryption‚Äù, Click the Settings tab there,\nfinally click End-To-End Encryption on the left.</p>\n<p>From there, you can click <code>+ Add Key</code> next to your email address and either\ngenerate a new key through Thunderbird. If you use this, choose the Curve\nprotocol or whatever isn‚Äôt RSA.</p>\n<p>Or import your own key which is definitely more secure since you‚Äôre not trusting\nsomeone else with your private key:</p>\n<pre><code class=\"language-bash\">gpg --export --armor sayls8@gmail.com &gt; publickey.asc\n</code></pre>\n<p>Then select <code>+ Add Key</code> and choose import your own, this didn‚Äôt work for me.\nWhat did work was to start composing an email and click on the <code>OpenPGP</code> button,\nGo to <code>Key Manager</code>, <code>File</code>, <code>Import Public Key from a File</code> and choose your\n<code>publickey.asc</code>. This way, only you have access to your private key.</p>\n<ul>\n<li><a href=\"https://support.mozilla.org/en-US/kb/introduction-to-e2e-encryption#w_how-e2ee-with-openpgp-works-in-general\">How e2ee with OpenPGP works in general</a></li>\n</ul>\n<p><strong>Import your recipient‚Äôs public key</strong></p>\n<p>When you start composing an email, you‚Äôll see that you need to resolve key\nissues if you don‚Äôt already have the recipients public key. Click <code>Resolve</code>, and\neither Discover Public Keys Online‚Ä¶ or Import Public Keys From File‚Ä¶</p>\n<p>Thunderbird has the option to use the OpenPGP Key Manager to view or manage\npublic keys of your correspondents.</p>\n<p>If you‚Äôre sending encrypted emails to someone you‚Äôll need their public key,\nthere are a few methods of doing this just ensure you verify the Fingerprint\nwith the person your talking to.</p>\n<p>Exporting your public key means creating a copy of the public part of your\ncryptographic key pair that you can share with others.</p>\n<p>For example, say that Jake wants to send you his public key. First he has to\nexport his key:</p>\n<pre><code class=\"language-bash\">gpg --output jake.gpg --export jake@proton.me\n</code></pre>\n<p>The key is exported in binary format, to export in ASCII-armored format use:</p>\n<pre><code class=\"language-bash\">gpg --armor --export jake@proton.me\n</code></pre>\n<p>Now, once he sends this to you, you‚Äôll need to import and validate it:</p>\n<pre><code class=\"language-bash\">gpg --import jake.gpg\n</code></pre>\n<p>Once the key is imported it should be validated. If you need to validate a key\nmanually, it is done by verifying the key‚Äôs fingerprint and then signing the key\nto certify it as a valid key.</p>\n<p>Check that it exists in your keychain:</p>\n<pre><code class=\"language-bash\">gpg --list-keys\n</code></pre>\n<p>You should see Jakes key in the above list.</p>\n<p>To certify the key you need to edit it:</p>\n<pre><code class=\"language-bash\">gpg --edit-key jake@proton.me\n# List the fingerprint\ngpg&gt; fpr\n# once the fingerprint is verified with the owner, sign it\ngpg&gt; sign\n# once signed, you can check the key to list signatures on it\ngpg&gt; check\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: You can use PGP to encrypt any message and paste it into <strong>any</strong>\nsoftware and send it. As long as only you and your recipient are the only\npeople to have the private keys, you will be the only people able to decrypt\nthe messages. Implementing this correctly is a good way to stop government\nmass surveillance.</p>\n</blockquote>\n<h2>Make your Public Key Highly Available</h2>\n<p>You should always make sure that you sign your public key before you publish it.\nWhen you distribute your public key, you‚Äôre distributing the public components\nof your master and subkeys as well as the user IDs. If unsigned, this is a\nsecurity risk because it‚Äôs possible for an attacker to tamper with it. The\npublic key can be modified by adding or substituting keys, or changing user IDs.</p>\n<p>Signing the keys provides a web of trust, only the corresponding public key can\nbe used to verify the signature and ensure it hasn‚Äôt been modified. Since we are\nalready only using subkeys for public keys, they are automatically self-signed.</p>\n<pre><code class=\"language-bash\">gpg --output ~/mygpg.key --armor --export your_email@address.com\n</code></pre>\n<p>You can then send this file to the other party.</p>\n<p>You can also use the GPG interface to upload your key to a key server:</p>\n<pre><code class=\"language-bash\">gpg --list-keys your_email@address.com\n</code></pre>\n<p>Copy the key ID for the following command, remember its on the <code>pub</code> line after\nthe <code>/</code>.</p>\n<pre><code class=\"language-bash\">gpg --send-keys --keyserver pgp.mit.edu key_id\n</code></pre>\n<p>The key will be uploaded to the server and likely be distributed to other key\nservers around the world. This is why expiration dates are important, if your\nkey is lost or stolen, the damage window is limited to the expiration period.\nAlso remember, you can add more time even after the key has expired.</p>\n<h3>Example: Verifying Arch Linux Download</h3>\n<details>\n<summary>\n<p>‚úîÔ∏è Click to Expand Example of verifying and signing the archlinux public key</p>\n</summary>\n<p>First, download both the arch <code>.iso</code> and <code>.sig</code> files.</p>\n<p>I tried a few different methods from <a href=\"https://archlinux.org/download/#checksums\">https://archlinux.org/download/#checksums</a>\nand the easiest by far was using Sequoia available in Nixpkgs as\n<code>pkgs.sequoia-sq</code>:</p>\n<p>Download the archlinux public key:</p>\n<pre><code class=\"language-bash\">sq network wkd search pierre@archlinux.org --output release-key.pgp\n\nFound 2¬†certificates related to the query:\n\n - 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C\n   - Pierre Schmitz &lt;pierre@archlinux.org&gt; (UNAUTHENTICATED)\n   - created 2022-10-31 09:11:51 UTC\n   - found via: WKD\n\n - 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC\n   - Pierre Schmitz &lt;pierre@archlinux.de&gt; (UNAUTHENTICATED)\n   - created 2011-04-10 09:35:33 UTC\n   - found via: WKD\n\nHint: To extract a particular certificate from release-key.pgp, use any of:\n\n  $ sq cert export --keyring=release-key.pgp --cert=3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C\n\n  $ sq cert export --keyring=release-key.pgp --cert=4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC\n</code></pre>\n<p>Export the chosen key to a <code>.pgp</code> file:</p>\n<pre><code class=\"language-bash\">sq cert export --keyring=release-key.pgp --cert=3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C &gt; pierre-archlinux.pgp\n</code></pre>\n<p>Import into your keychain:</p>\n<pre><code class=\"language-bash\"> gpg --import pierre-archlinux.pgp\ngpg: key 0x76A5EF9054449A5C: 9 signatures not checked due to missing keys\ngpg: key 0x76A5EF9054449A5C: public key \"Pierre Schmitz &lt;pierre@archlinux.org&gt;\" imported\ngpg: Total number processed: 1\ngpg:               imported: 1\ngpg: marginals needed: 3  completes needed: 1  trust model: pgp\ngpg: depth: 0  valid:   3  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 3u\ngpg: next trustdb check due at 2026-08-23\n</code></pre>\n<p>Now, you should see <code>&lt;pierre@archlinux.org&gt;</code> and his keys when you run\n<code>gpg --list-keys</code></p>\n<p>Finally, verify the signature:</p>\n<pre><code class=\"language-bash\">sq verify --signer-file release-key.pgp --signature-file archlinux-2025.08.01-x86_64.iso.sig archlinux-2025.08.01-x86_64.iso\nAuthenticated signature made by 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C (Pierre Schmitz &lt;pierre@archlinux.org&gt;)\n\n1¬†authenticated signature.\n</code></pre>\n<p>This shows that the signature was made by the key with the ID\n<code>3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C</code> (Pierre Schmitz).</p>\n<p>GPG authenticated that the signature is valid and that the key used to sign is\ntrusted in our keyring.</p>\n<p>1 authenticated signature confirms the files integrity and authenticity.</p>\n<p>We have successfully verified that the file was signed by Pierr‚Äôs official Arch\nLinux key and has not been tampered with.</p>\n<p>Since the key has been verified we can now sign it. We will have to import our\nprimary key to do so since we are keeping it offline for safety.</p>\n<pre><code class=\"language-bash\">gpg --import backup.gpg\n</code></pre>\n<p>List your keys to get the arch keyID:</p>\n<pre><code class=\"language-bash\">gpg --list-keys\n# ... snip ...\npub   ed25519/0x76A5EF9054449A5C 2022-10-31 [SC] [expires: 2037-10-27]\n      Key fingerprint = 3E80 CA1A 8B89 F69C BA57  D98A 76A5 EF90 5444 9A5C\nuid                   [  full  ] Pierre Schmitz &lt;pierre@archlinux.org&gt;\nuid                   [  full  ] Pierre Schmitz &lt;pierre@archlinux.de&gt;\nsub   ed25519/0xD6D13C45BFCFBAFD 2022-10-31 [A] [expires: 2037-10-27]\nsub   cv25519/0x7F56ADE50CA3D899 2022-10-31 [E] [expires: 2037-10-27]\n</code></pre>\n<p>Sign the key:</p>\n<pre><code class=\"language-bash\">gpg --sign-key 0x76A5EF9054449A5C\n</code></pre>\n<p>Now you can Export and publish the new public key and send it to a keyserver:</p>\n<pre><code class=\"language-bash\">gpg --export --armor 0x76A5EF9054449A5C &gt; archlinux-signed.asc\ngpg --send-keys 0x76A5EF9054449A5C\n</code></pre>\n<p>The more people that verify, sign, and re-export and publish their keys the\nbetter for the web of trust that gpg uses making the network more secure for\neveryone.</p>\n<h3>Edit your trust level of the key</h3>\n<pre><code class=\"language-bash\">gpg --edit-key pierre@archlinux.org\ngpg&gt; trust\nPlease decide how far you trust this user to correctly verify other users' keys\n(by looking at passports, checking fingerprints from different sources, etc.)\n\n  1 = I don't know or won't say\n  2 = I do NOT trust\n  3 = I trust marginally\n  4 = I trust fully\n  5 = I trust ultimately\n  m = back to the main menu\n\nYour decision? 3\n# Output:\npub  ed25519/0x76A5EF9054449A5C\n     created: 2022-10-31  expires: 2037-10-27  usage: SC\n     trust: marginal      validity: full\n</code></pre>\n<p>You can see that the trust is <code>marginal</code> and validity is <code>full</code>.</p>\n</details>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/impermanence.html",
      "url": "https://saylesss88.github.io/nix/impermanence.html",
      "title": "Unencrypted Impermanence",
      "content_html": "<h1>Unencrypted BTRFS Impermanence with Flakes</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p>Figure 1: <strong>Impermanence Logo</strong>: Image of the Impermanence logo. Sourced from\nthe</p>\n<p><a href=\"https://github.com/nix-community/impermanence\">Impermanence repo</a></p>\n<p><img src=\"../images/Impermanence.png\" alt=\"Impermanence Logo\" /></p>\n<p>This guide is for an unencrypted setup, there are a few links at the end for\nencrypted setups. This guide follows the previous\n<a href=\"https://saylesss88.github.io/nix/impermanence.html\">minimal install guide</a> but\nyou should be able to adjust it carefully to meet your needs.</p>\n<p>This section details how to set up impermanence on your NixOS system using BTRFS\nsubvolumes. With impermanence, your operating system‚Äôs root filesystem will\nreset to a pristine state on each reboot, while designated directories and files\nremain persistent. This provides a highly reliable and rollback-friendly system.</p>\n<p>In NixOS, ‚Äústate‚Äù is any data or condition of the system that isn‚Äôt defined in\nyour declarative configuration. The impermanence approach aims to make this\nstate temporary (ephemeral) or easily resettable, so your system always matches\nyour configuration and can recover from unwanted changes or corruption.</p>\n<h2>Impermanence: The Concept and Its BTRFS Implementation</h2>\n<p>In a traditional Linux system, most of this state is stored on the disk and\npersists indefinitely unless manually deleted or modified. However, this can\nlead to configuration drift, where the system accumulates changes (e.g., log\nfiles, temporary files, or unintended configuration tweaks) that make it harder\nto reproduce or maintain.</p>\n<p>Impermanence, in the context of operating systems, refers to a setup where the\nmajority of the system‚Äôs root filesystem (<code>/</code>) is reset to a pristine state on\nevery reboot. This means any changes made to the system (e.g., installing new\npackages, modifying system files outside of configuration management, creating\ntemporary files) are discarded upon shutdown or reboot.</p>\n<h3>What Does Impermanence Do?</h3>\n<p>Impermanence is a NixOS approach that makes the system stateless (or nearly\nstateless) by wiping the root filesystem (<code>/</code>) on each boot, ensuring a clean,\npredictable starting point. Only explicitly designated data (persistent state)\nis preserved across reboots, typically stored in specific locations like the\n<code>/nix/persist</code> subvolume. This is possible because NixOS can boot with only the\n<code>/boot</code>, and <code>/nix</code> directories. This achieves:</p>\n<ol>\n<li>Clean Root Filesystem:</li>\n</ol>\n<ul>\n<li>\n<p>The root subvolume is deleted and recreated on each boot, erasing transient\nstate (e.g., temporary files, runtime data).</p>\n</li>\n<li>\n<p>This ensures the system starts fresh, reducing clutter and making it behave\ncloser to a declarative system defined by your NixOS configuration.</p>\n</li>\n</ul>\n<ol start=\"2\">\n<li>Selective Persistence:</li>\n</ol>\n<ul>\n<li>\n<p>Critical state (e.g., user files, logs, system configuration) is preserved in\ndesignated persistent subvolumes (e.g., <code>/nix/persist</code>, <code>/var/log</code>,\n<code>/var/lib</code>) or files.</p>\n</li>\n<li>\n<p>You control exactly what state persists by configuring\n<code>environment.persistence.\"/nix/persist\"</code> or other mechanisms.</p>\n</li>\n<li>\n<p>‚ùó The understanding around persisting <code>/var/lib/nixos</code> seems to be evolving.\nSee,<a href=\"https://github.com/nix-community/impermanence/issues/178\">The importance of persisting <code>/var/lib/nixos</code></a>\nSee also\n<a href=\"https://github.com/NixOS/nixpkgs/pull/273384\">necessary system state</a></p>\n</li>\n</ul>\n<ol start=\"3\">\n<li>Reproducibility and Security:</li>\n</ol>\n<ul>\n<li>\n<p>By wiping transient state, impermanence prevents unintended changes from\naccumulating, making the system more reproducible.</p>\n</li>\n<li>\n<p>It enhances security by ensuring sensitive temporary data (e.g., <code>/tmp</code>,\nruntime credentials) is erased on reboot.</p>\n</li>\n</ul>\n<h3>Getting Started</h3>\n<ol>\n<li>Add impermanence to your <code>flake.nix</code>. You will change the <code>hostname</code> in the\nflake to match your <code>networking.hostName</code>.</li>\n</ol>\n<pre><code class=\"language-nix\"># flake.nix\n{\n  description = \"NixOS configuration\";\n\n  inputs = {\n    nixpkgs.url = \"github:nixos/nixpkgs/nixos-unstable\";\n    disko.url = \"github:nix-community/disko/latest\";\n    disko.inputs.nixpkgs.follows = \"nixpkgs\";\n    impermanence.url = \"github:nix-community/impermanence\";\n  };\n\n  outputs = inputs@{ nixpkgs, ... }: {\n    nixosConfigurations = {\n      hostname = nixpkgs.lib.nixosSystem {\n        system = \"x86_64-linux\";\n        modules = [\n          ./configuration.nix\n          inputs.disko.nixosModules.disko\n          inputs.impermanence.nixosModules.impermanence\n        ];\n      };\n    };\n  };\n}\n</code></pre>\n<ol start=\"2\">\n<li>Discover where your root subvolume is located with <code>findmnt</code>:</li>\n</ol>\n<p>Before configuring impermanence, it‚Äôs crucial to know the device path and\nsubvolume path of your main BTRFS partition where the root filesystem (<code>/</code>) is\nlocated. This information is needed for the mount command within the\nimpermanence script.</p>\n<pre><code class=\"language-bash\">findmnt /\nTARGET   SOURCE         FSTYPE OPTIONS\n/        /dev/disk/by-partlabel/disk-main-root[/root]\n                        btrfs  rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=275,sub\n</code></pre>\n<p>From the SOURCE column, note the full path, including the device (e.g.,\n<code>/dev/disk/by-partlabel/disk-main-root</code>) and the subvolume in brackets (e.g.,\n<code>[/root]</code>). You will use the device path in the next step</p>\n<p><code>/dev/disk/by-partlabel/disk-main-root</code> is a symlink to the actual device path\n(e.g. <code>/dev/nvme0n1p2</code>), but using the partlabel is generally more robust for\nscripts.</p>\n<ol start=\"3\">\n<li>Create an <code>impermanence.nix</code>:</li>\n</ol>\n<p>Now, create a new file named <code>impermanence.nix</code> in your configuration directory\n(i.e. your flake directory). This file will contain all the specific settings\nfor your impermanent setup, including BTRFS subvolume management and persistent\ndata locations. Since this file is right next to your <code>configuration.nix</code>,\nyou‚Äôll just add an <code>imports = [ ./impermanence.nix ]</code> to your\n<code>configuration.nix</code> apply it to your configuration.</p>\n<pre><code class=\"language-nix\">{lib, ...}: {\n  #  Reset root subvolume on boot\n  boot.initrd.postResumeCommands = lib.mkAfter ''\n    mkdir /btrfs_tmp\n      mount /dev/disk/by-partlabel/disk-main-root /btrfs_tmp # CONFIRM THIS IS CORRECT FROM findmnt\n      if [[ -e /btrfs_tmp/root ]]; then\n        mkdir -p /btrfs_tmp/old_roots\n        timestamp=$(date --date=\"@$(stat -c %Y /btrfs_tmp/root)\" \"+%Y-%m-%-d_%H:%M:%S\")\n        mv /btrfs_tmp/root \"/btrfs_tmp/old_roots/$timestamp\"\n      fi\n\n      delete_subvolume_recursively() {\n        IFS=$'\\n'\n        for i in $(btrfs subvolume list -o \"$1\" | cut -f 9- -d ' '); do\n          delete_subvolume_recursively \"/btrfs_tmp/$i\"\n        done\n        btrfs subvolume delete \"$1\"\n      }\n\n      for i in $(find /btrfs_tmp/old_roots/ -maxdepth 1 -mtime +30); do\n        delete_subvolume_recursively \"$i\"\n      done\n\n      btrfs subvolume create /btrfs_tmp/root\n      umount /btrfs_tmp\n  '';\n\n  # Use /persist as the persistence root, matching Disko's mountpoint\n  environment.persistence.\"/nix/persist\" = {\n    hideMounts = true;\n    directories = [\n      \"/etc\" # System configuration (Keep this here for persistence via bind-mount)\n      \"/var/spool\" # Mail queues, cron jobs\n      \"/srv\" # Web server data, etc.\n      \"/root\"\n    ];\n    files = [\n    ];\n  };\n}\n</code></pre>\n<p>With btrfs subvolumes since each directory is its own subvolume, when the root\nis wiped on reboot the subvolumes are untouched.</p>\n<h3>Applying Your Impermanence Configuration</h3>\n<p>Once you have completed all the steps and created or modified the necessary\nfiles (<code>flake.nix</code>, <code>impermanence.nix</code>), you need to apply these changes to your\nNixOS system.</p>\n<ol>\n<li>Navigate to your NixOS configuration directory (where your <code>flake.nix</code> is\nlocated).</li>\n</ol>\n<pre><code class=\"language-bash\">cd /path/to/your/flake\n</code></pre>\n<ol start=\"2\">\n<li>Rebuild and Switch: Execute the <code>nixos-rebuild switch</code> command. This command\nwill:</li>\n</ol>\n<ul>\n<li>\n<p>Evaluate your <code>flake.nix</code> and the modules it imports (including your new\n<code>impermanence.nix</code>).</p>\n</li>\n<li>\n<p>Build a new NixOS system closure based on your updated configuration.</p>\n</li>\n<li>\n<p>Activate the new system configuration, making it the current running system.</p>\n</li>\n</ul>\n<blockquote>\n<p>‚ùó <strong>NOTE:</strong> On the first rebuild after setting up impermanence, you may find\nthat you‚Äôre not in the password database or cannot log in/sudo. This occurs\nbecause the initial state of your new ephemeral root filesystem, including\n<code>/etc</code> (where user passwords are stored), is fresh. It has to do with the\ntiming of when <code>environment.persistence</code> takes effect during the first boot.</p>\n<p>To avoid this password issue, <strong>before</strong> your first <code>nixos-rebuild switch</code> for\nimpermanence, run:</p>\n<pre><code class=\"language-bash\">sudo mkdir -p /nix/persist/etc # Ensure the target directory exists\nsudo cp -a /etc/* /nix/persist/etc\n</code></pre>\n<ul>\n<li>This copies your <em>current</em> <code>/etc</code> directory contents (including existing\nuser passwords) into your persistent storage.</li>\n<li><strong>Crucially:</strong> You must also ensure that <code>/etc</code> is explicitly included in\nyour <code>environment.persistence.\"/nix/persist\".directories</code> list in your\n<code>impermanence.nix</code> like we did above, (or main configuration). This\nconfigures NixOS to persistently bind-mount <code>/nix/persist/etc</code> over <code>/etc</code>\non every subsequent boot.</li>\n</ul>\n<p>Once these steps are done and you reboot, your user passwords should function\ncorrectly, and future rebuilds will not present this problem.</p>\n</blockquote>\n<pre><code class=\"language-bash\">sudo nixos-rebuild switch --flake .#hostname # Replace 'hostname' with your actual system hostname\n</code></pre>\n<ol start=\"3\">\n<li>Perform an Impermanence Test (Before Reboot):</li>\n</ol>\n<ul>\n<li>Before you reboot, create a temporary directory and file in a non-persistent\nlocation. Since you haven‚Äôt explicitly added <code>/imperm_test</code> to your\n<code>environment.persistence.\"/nix/persist\"</code> directories, this file should not\nsurvive a reboot.</li>\n</ul>\n<pre><code class=\"language-bash\">mkdir /imperm_test\necho \"This should be Gone after Reboot\" | sudo tee /imperm_test/testfile\nls -l /imperm_test/testfile # Verify the file exists\ncat /imperm_test/testfile # Verify content\n</code></pre>\n<ol start=\"4\">\n<li>Reboot Your System: For the impermanence setup to take full effect and for\nyour root filesystem to be reset for the first time, you must reboot your\nmachine.</li>\n</ol>\n<pre><code class=\"language-bash\">sudo reboot\n</code></pre>\n<ol start=\"5\">\n<li>Verify Impermanence (After Reboot):</li>\n</ol>\n<ul>\n<li>After the system has rebooted, check if the test directory and file still\nexist:</li>\n</ul>\n<pre><code class=\"language-bash\">ls -l /imperm_test/testfile\n</code></pre>\n<p>You should see an output like <code>ls: cannot access '/imperm_test/testfile'</code>: No\nsuch file or directory. This confirms that the <code>/imperm_test</code> directory and its\ncontents were indeed ephemeral and were removed during the reboot process,\nindicating your impermanence setup is working correctly!</p>\n<p>Your system should now come up with a fresh root filesystem, and only the data\nspecified in your <code>environment.persistence.\"/nix/persist\"</code> configuration will be\npersistent.</p>\n<h2>Recovery with <code>nixos-enter</code> and chroot</h2>\n<p>This is if you followed the minimal_install guide, it will need to be changed\nfor a different disk layout.</p>\n<p><a href=\"https://en.wikipedia.org/wiki/Chroot\">Chroot</a> is an operation that changes the\napparent root directory for the current running process and their children. A\nprogram that is run in such a modified environment cannot access files and\ncommands outside that environmental directory tree. This modified environment is\ncalled a chroot jail. ‚ÄìNixOS wiki</p>\n<p><code>nixos-enter</code> allows you to access a NixOS installation from a NixOS rescue\nsystem. To use, setup <code>/mnt</code> as described in the\n<a href=\"https://nixos.org/manual/nixos/stable/#sec-installation\">installation manual</a></p>\n<p>üõ†Ô∏è Recovery: Chroot into Your NixOS Btrfs+Impermanence System</p>\n<p>Take note of your layout from commands like:</p>\n<pre><code class=\"language-bash\">sudo fdisk -l\nlsblk\nsudo btrfs subvol list /\n</code></pre>\n<p>Also inspect your <code>disk-config.nix</code> to ensure you refer to the correct <code>subvol=</code>\nnames.</p>\n<p>If you need to repair your system (e.g., forgot root password, fix a broken\nconfig, etc.), follow these steps to chroot into your NixOS install:</p>\n<ol>\n<li>\n<p>Boot a Live ISO</p>\n<p>Boot from a NixOS (or any recent Linux) live USB.</p>\n<p>Open a terminal and become root:</p>\n</li>\n</ol>\n<pre><code class=\"language-bash\">sudo -i\n</code></pre>\n<ol start=\"2\">\n<li>Identify Your Devices</li>\n</ol>\n<p>Your main disk is <code>/dev/nvme0n1</code></p>\n<ul>\n<li>\n<p>EFI partition: <code>/dev/nvme0n1p1</code> (mounted at /boot)</p>\n</li>\n<li>\n<p>Root partition: <code>/dev/nvme0n1p2</code> (Btrfs, with subvolumes)</p>\n</li>\n</ul>\n<ol start=\"3\">\n<li>Mount the Btrfs Root Subvolume</li>\n</ol>\n<p>First, mount the Btrfs partition somewhere temporary (not as / yet):</p>\n<pre><code class=\"language-bash\">mount -o subvol=root,compress=zstd,noatime /dev/nvme0n1p2 /mnt\n</code></pre>\n<ol start=\"4\">\n<li>Mount Other Subvolumes</li>\n</ol>\n<p>Now mount your other subvolumes as defined in your <code>disko.nix</code>:</p>\n<pre><code class=\"language-bash\"># Mount Other Subvolumes\n# (Ensure /mnt directories are created for each *mountpoint*)\n\n# Home\nmkdir -p /mnt/home\nmount -o subvol=home,compress=zstd,noatime /dev/nvme0n1p2 /mnt/home\n\n# IMPORTANT: No separate mount for /mnt/home/user, as it's a nested subvolume\n# and handled by the /home mount.\n\n# Nix store\nmkdir -p /mnt/nix\nmount -o subvol=nix,compress=zstd,noatime /dev/nvme0n1p2 /mnt/nix\n\n# Nix persist\nmkdir -p /mnt/nix/persist\n# CRITICAL: Based our disko.nix, the subvolume name is 'persist', not 'nix/persist'\nmount -o subvol=persist,compress=zstd,noatime /dev/nvme0n1p2 /mnt/nix/persist\n\n# /var/log\nmkdir -p /mnt/var/log\nmount -o subvol=log,compress=zstd,noatime /dev/nvme0n1p2 /mnt/var/log\n\n# /var/lib\nmkdir -p /mnt/var/lib\n# Confirmed: The subvolume named 'lib' is mounted to /var/lib\nmount -o subvol=lib,compress=zstd,noatime /dev/nvme0n1p2 /mnt/var/lib\n</code></pre>\n<p>Note: If you get ‚Äúsubvolume not found,‚Äù check the subvolume names with\n<code>btrfs subvol list /mnt</code>.</p>\n<ol start=\"5\">\n<li>Mount the EFI Partition</li>\n</ol>\n<pre><code class=\"language-bash\">mkdir -p /mnt/boot mount /dev/nvme0n1p1 /mnt/boot\n</code></pre>\n<ol start=\"6\">\n<li>(Optional) Mount Virtual Filesystems</li>\n</ol>\n<pre><code class=\"language-bash\">mount --bind /dev /mnt/dev mount --bind /proc /mnt/proc mount --bind /sys\n/mnt/sys mount --bind /run /mnt/run\n</code></pre>\n<ol start=\"7\">\n<li>Chroot</li>\n</ol>\n<pre><code class=\"language-bash\">chroot /mnt /run/current-system/sw/bin/bash\n</code></pre>\n<p>or, if using a non-NixOS live system:</p>\n<pre><code class=\"language-bash\">nixos-enter\n</code></pre>\n<p>(You may need to install nixos-enter with nix-shell -p nixos-enter.) 8. You‚Äôre\nIn!</p>\n<p>You can now run <code>nixos-rebuild</code>, reset passwords, or fix configs as needed. üîé</p>\n<p>üìì Notes</p>\n<ul>\n<li>\n<p>Adjust <code>compress=zstd,noatime</code> if your config uses different mount options.</p>\n</li>\n<li>\n<p>For impermanence, make sure to mount all persistent subvolumes you need.</p>\n</li>\n<li>\n<p>If you use swap, you may want to enable it too (e.g., <code>swapon /dev/zram0</code> if\nrelevant).</p>\n</li>\n</ul>\n<p>You can now recover, repair, or maintain your NixOS system as needed!</p>\n<h4>Related Material</h4>\n<ul>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Change_root\">Change root (chroot)</a></p>\n</li>\n<li>\n<p><a href=\"https://www.mankier.com/8/nixos-enter\">nixos-enter</a></p>\n</li>\n<li>\n<p><a href=\"https://grahamc.com/blog/erase-your-darlings/\">erase your darlings</a></p>\n</li>\n<li>\n<p><a href=\"https://haseebmajid.dev/posts/2024-07-30-how-i-setup-btrfs-and-luks-on-nixos-using-disko/\">Guide for Btrfs with LUKS</a></p>\n</li>\n<li>\n<p><a href=\"https://notashelf.dev/posts/impermanence\">notashelf impermanence</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Impermanence\">NixOS wiki Impermanence</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/nix-community/impermanence\">nix-community impermanence module</a></p>\n</li>\n</ul>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/nix_package_manager.html",
      "url": "https://saylesss88.github.io/nix/nix_package_manager.html",
      "title": "Nix Package Manager",
      "content_html": "<h1>Nix Package Manager</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<!-- ![nix99](../images/nix99.png) -->\n<h2>Nix Package Manager</h2>\n<p>Nix is a <em>purely functional package manager</em>. This means that it treats packages\nlike values in purely functional programming languages ‚Äì they are built by\nfunctions that don‚Äôt have side-effects, and they never change after they have\nbeen built.</p>\n<p>Nix stores packages in the <em>Nix store</em>, usually the directory <code>/nix/store</code>,\nwhere each package has its own unique subdirectory such as:</p>\n<pre><code class=\"language-bash\">/nix/store/y53c0lamag5wpx7vsiv7wmnjdgq97yd6-yazi-25.5.14pre20250526_74a8ea9\n</code></pre>\n<p>You can use the Nix on most Linux distributions and Mac OS also has good support\nfor Nix. It should work on most platforms that support POSIX threads and have a\nC++11 compiler.</p>\n<p>When I install Nix on a distro like Arch Linux I usually use the Zero to Nix\ninstaller as it automates several steps, such as enabling flakes by default:</p>\n<pre><code class=\"language-bash\">curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install\n</code></pre>\n<p>If you have concerns about the ‚Äúcurl to Bash‚Äù approach you could examine the\ninstallation script\n<a href=\"https://raw.githubusercontent.com/DeterminateSystems/nix-installer/main/nix-installer.sh\">here</a>\nthen download and run it:</p>\n<pre><code class=\"language-bash\">curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix &gt; nix-installer.sh\nchmod +x nix-installer.sh\n./nix-installer.sh install\n</code></pre>\n<p>I got the above commands from\n<a href=\"https://zero-to-nix.com/start/install/\">zero-to-nix</a></p>\n<p>The main difference between using the nix package manager on another\ndistribution and NixOS is that NixOS uses Nix not just for package management\nbut also to manage the system configuration (e.g., to build config files in\n<code>/etc</code>).</p>\n<p><a href=\"https://nix-community.github.io/home-manager/\">Home Manager</a> is a Nix-powered\ntool for reproducible management of the contents of the users‚Äô home directories.\nThis includes programs, configuration files, environment variables, and\narbitrary files. Home manager uses the same module system as NixOS.</p>\n<p>Now that we‚Äôve discussed some of the basics of the Nix package manager, lets see\nhow it is used to build and manage software in NixOS.</p>\n<h2>Channels</h2>\n<p>Nix packages are distributed through Nix channels; mechanisms for distributing\nNix expressions and the associated binary caches for them. Channels are what\ndetermine which versions your packages have. (i.e. <em>stable</em> or <em>unstable</em>). A\nchannel is a name for the latest ‚Äúverified‚Äù git commits in Nixpkgs. Each channel\nrepresents a different policy for what ‚Äúverified‚Äù means. Whenever a new commit\nin <code>Nixpkgs</code> passes the verification process, the respective channel is updated\nto point to that new commit.</p>\n<p>While channels provide a convenient way to get the latest stable or unstable\npackages, they introduce a challenge for strict reproducibility. Because a\nchannel like <code>nixos-unstable</code> is constantly updated, fetching packages from it\ntoday might give you a different set of package versions than fetching from it\ntomorrow, even if your configuration remains unchanged. This ‚Äúrolling release‚Äù\nnature at a global level can make it harder to share and reproduce exact\ndevelopment environments or system configurations across different machines or\nat different points in time.</p>\n<h2>Channels vs. Flakes Enhancing Reproducibility</h2>\n<p>Before the introduction of <strong>Nix Flakes</strong>, channels were the primary mechanism\nfor sourcing <code>Nixpkgs</code>. While functional, they posed a challenge for exact\nreproducibility because they point to a moving target (the latest commit on a\nbranch). This meant that a <code>nix-build</code> command run yesterday might produce a\ndifferent result than one run today, simply because the channel updated.</p>\n<p>Nix Flakes were introduced to address this. Flakes bring a built-in,\nstandardized way to define the exact inputs to a Nix build, including the\nprecise Git revision of <code>Nixpkgs</code> or any other dependency.</p>\n<p>Here‚Äôs a quick comparison:</p>\n<table><thead><tr><th style=\"text-align: left\">Feature</th><th style=\"text-align: left\">Nix Channels (traditional)</th><th style=\"text-align: left\">Nix Flakes (modern approach)</th></tr></thead><tbody>\n<tr><td style=\"text-align: left\"><strong>Input Source</strong></td><td style=\"text-align: left\">Global system configuration (<code>nix-channel --update</code>)</td><td style=\"text-align: left\">Explicitly defined in <code>flake.nix</code> (e.g., <code>github:NixOS/nixpkgs/nixos-23.11</code>)</td></tr>\n<tr><td style=\"text-align: left\"><strong>Reproducibility</strong></td><td style=\"text-align: left\">‚ÄúRolling release‚Äù; less reproducible across time/machines</td><td style=\"text-align: left\">Highly reproducible due to locked inputs (<code>flake.lock</code>)</td></tr>\n<tr><td style=\"text-align: left\"><strong>Dependency Mgmt.</strong></td><td style=\"text-align: left\">Implicitly managed by global channel</td><td style=\"text-align: left\">Explicitly declared and version-locked within <code>flake.nix</code></td></tr>\n<tr><td style=\"text-align: left\"><strong>Sharing</strong></td><td style=\"text-align: left\">Relies on users having same channel version</td><td style=\"text-align: left\">Self-contained; <code>flake.lock</code> ensures everyone gets same inputs</td></tr>\n<tr><td style=\"text-align: left\"><strong>Learning Curve</strong></td><td style=\"text-align: left\">Simpler initial setup, but tricky reproducibility debugging</td><td style=\"text-align: left\">Higher initial learning curve, but simplifies reproducibility</td></tr>\n</tbody></table>\n<p>The ability of Flakes to ‚Äúlock‚Äù the exact version of all dependencies in a\n<code>flake.lock</code> file is a game-changer for collaboration and long-term\nreproducibility, ensuring that your Nix configuration builds the same way, every\ntime, everywhere.</p>\n<h2>Nixpkgs</h2>\n<p><strong>Nixpkgs</strong> is the largest repository of Nix packages and NixOS modules.</p>\n<p>For <strong>NixOS</strong> users, <code>nixos-unstable</code> channel branch is the rolling release,\nwhere the packages are tested and must pass integration tests.</p>\n<p>For <strong>standalone Nix</strong> users, <code>nixpkgs-unstable</code> channel branch is the rolling\nrelease, where packages pass only basic build tests and are upgraded often.</p>\n<p>For Flakes, as mentioned above they don‚Äôt use channels so <code>nixpkgs</code> will be\nlisted as an <code>input</code> to your flake. (e.g.,\n<code>inputs.nixpkgs.url = \"github:nixos/nixpkgs/nixos-unstable\";</code>) When using flakes\nyou can actually disable channels and actually recommended to avoid conflicts\nbetween traditional channel-based workflows and the flake system.</p>\n<h3>Updates</h3>\n<p>The mechanism for updating your Nix environment differs fundamentally between\nchannels and flakes, directly impacting reproducibility and control.</p>\n<h4>Updating with Channels (Traditional Approach)</h4>\n<p>With channels, updates are a global operation that pulls the latest state of a\nspecific branch.</p>\n<p><strong>How it works</strong>: You typically use <code>nix-channel --update</code> to fetch the latest\ncommit from the channels you‚Äôve subscribed to. For instance,\n<code>sudo nix-channel --update nixos</code> (for NixOS) or <code>nix-channel --update nixpkgs</code>\n(for <code>nix-env</code> on other Linux distributions).</p>\n<p><strong>Implication</strong>: This command updates your local system‚Äôs understanding of what\n‚Äúnixos‚Äù or ‚Äúnixpkgs-unstable‚Äù means. From that point on, any\n<code>nixos-rebuild switch</code>, <code>nix-env -iA</code>, or <code>nix-build</code> commands that implicitly\nor explicitly refer to <code>nixpkgs</code> will use this newly updated version.</p>\n<p><strong>Reproducibility Challenge</strong>: The update itself is not recorded in your\nconfiguration files. If you share your <code>configuration.nix</code> with someone, they\nmight run <code>nix-channel --update</code> on a different day and get a different set of\npackage versions because the channel has moved. This makes it challenging to\nguarantee that two users building the ‚Äúsame‚Äù configuration will get identical\nresults. You‚Äôre effectively relying on the implicit, globally managed state of\nyour channels.</p>\n<h4>Updating with Flakes (Modern Approach)</h4>\n<p><strong>Flakes</strong>, by contrast, use a more explicit and localized update mechanism tied\nto your <code>flake.lock</code> file.</p>\n<p><strong>How it works</strong>: When you define a <code>flake.nix</code>, you specify the exact URL\n(e.g., a Git repository with a specific branch or tag) for each input. When you\nfirst use a flake, Nix resolves these URLs to a precise Git commit hash and\nrecords this hash, along with a content hash, in a <code>flake.lock</code> file.</p>\n<p>To update your flake inputs, you run <code>nix flake update</code>.</p>\n<p><strong>Implication</strong>: This command goes to each input‚Äôs specified URL (e.g.,\n<code>github:NixOS/nixpkgs/nixos-unstable</code>) and fetches the latest commit for that\ninput. It then updates your <code>flake.lock</code> file with the new, precise Git commit\nhash and content hash for that input. Your <code>flake.nix</code> itself doesn‚Äôt change,\nbut the <code>flake.lock</code> file now points to newer versions of your dependencies.</p>\n<p><strong>Reproducibility Advantage</strong>: The <code>flake.lock</code> file acts as a manifest of your\nexact dependency versions.</p>\n<p><strong>Sharing</strong>: When you share your flake (the <code>flake.nix</code> and <code>flake.lock</code> files),\nanyone using it will fetch precisely the same Git commit hashes recorded in the\n<code>flake.lock</code>, guaranteeing identical inputs and thus, identical builds (assuming\nthe same system architecture).</p>\n<p><strong>Updating Selectively</strong>: You can update individual inputs within your flake by\nspecifying them: <code>nix flake update nixpkgs</code>. This provides fine-grained control\nover which parts of your dependency graph you want to advance.</p>\n<p><strong>Rolling Back</strong>: Because the <code>flake.lock</code> explicitly records the versions, you\ncan easily revert to a previous state by checking out an older <code>flake.lock</code> from\nyour version control system.</p>\n<p><strong>In essence</strong>: Channels involve a global ‚Äúpull‚Äù of the latest branch state,\nmaking reproducibility harder to guarantee across time and machines. Flakes,\nhowever, explicitly pin all inputs in <code>flake.lock</code>, and updates involve\nexplicitly refreshing these pins, providing strong reproducibility and version\ncontrol out of the box.</p>\n<h3>Managing software with Nix</h3>\n<p><strong>Derivation Overview</strong></p>\n<p>In Nix, the process of managing software starts with <strong>package definitions</strong>.\nThese are files written in the Nix language that describe how a particular piece\nof software should be built. These package definitions, when processed by Nix,\nare translated into derivations.</p>\n<p>At its core, a derivation in Nix is a blueprint or a recipe that describes how\nto build a specific software package or any other kind of file or directory.\nIt‚Äôs a declarative specification of:</p>\n<ul>\n<li>\n<p><strong>Inputs</strong>: What existing files or other derivations are needed as\ndependencies.</p>\n</li>\n<li>\n<p><strong>Build Steps</strong>: The commands that need to be executed to produce the desired\noutput.</p>\n</li>\n<li>\n<p><strong>Environment</strong>: The specific environment (e.g., build tools, environment\nvariables) required for the build process.</p>\n</li>\n<li>\n<p><strong>Outputs</strong>: The resulting files or directories that the derivation produces.</p>\n</li>\n</ul>\n<p>Think of a package definition as the initial instructions, and the derivation as\nthe detailed, low-level plan that Nix uses to actually perform the build.</p>\n<p>Again, a derivation is like a blueprint that describes how to build a specific\nsoftware package or any other kind of file or directory.</p>\n<p><strong>Key Characteristics of Derivations:</strong></p>\n<ul>\n<li>\n<p><strong>Declarative</strong>: You describe the desired outcome and the inputs, not the\nexact sequence of imperative steps. Nix figures out the necessary steps based\non the builder and args.</p>\n</li>\n<li>\n<p><strong>Reproducible</strong>: Given the same inputs and build instructions, a derivation\nwill always produce the same output. This is a cornerstone of Nix‚Äôs\nreproducibility.</p>\n</li>\n<li>\n<p><strong>Tracked by Nix</strong>: Nix keeps track of all derivations and their outputs in\nthe Nix store. This allows for efficient management of dependencies and\nensures that different packages don‚Äôt interfere with each other.</p>\n</li>\n<li>\n<p><strong>Content-Addressed</strong>: The output of a derivation is stored in the Nix store\nunder a unique path that is derived from the hash of all its inputs and build\ninstructions. This means that if anything changes in the derivation, the\noutput will have a different path.</p>\n</li>\n</ul>\n<p>Here‚Äôs a simple Nix derivation that creates a file named hello in the Nix store\ncontaining the text ‚ÄúHello, World!‚Äù:</p>\n<details>\n<summary> ‚úîÔ∏è Hello World Derivation Example (Click to expand):</summary>\n<pre><code class=\"language-nix\">{pkgs ? import &lt;nixpkgs&gt; {}}:\npkgs.stdenv.mkDerivation {\n  name = \"hello-world\";\n\n  dontUnpack = true;\n\n  # No need for src = null; when dontUnpack = true;\n  # src = null;\n\n  buildPhase = ''\n     # Create a shell script that prints \"Hello, World!\"\n    echo '#!${pkgs.bash}/bin/bash' &gt; hello-output-file # Shebang line\n    echo 'echo \"Hello, World!\"' &gt;&gt; hello-output-file # The command to execute\n    chmod +x hello-output-file # Make it executable\n  '';\n\n  installPhase = ''\n    mkdir -p $out/bin\n    cp hello-output-file $out/bin/hello # Copy the file from build directory to $out/bin\n  '';\n\n  meta = {\n    description = \"A simple Hello World program built with Nix\";\n    homepage = null;\n    license = pkgs.lib.licenses.unfree; # licenses.mit is often used as well\n    maintainers = [];\n  };\n}\n</code></pre>\n<p>And a <code>default.nix</code> with the following contents:</p>\n<pre><code class=\"language-nix\">{ pkgs ? import &lt;nixpkgs&gt; {} }:\n\nimport ./hello.nix { pkgs = pkgs; }\n</code></pre>\n<ul>\n<li>\n<p><code>{ pkgs ? import &lt;nixpkgs&gt; {} }</code>: This is a function that takes an optional\nargument <code>pkgs</code>. We need Nixpkgs to access standard build environments like\n<code>stdenv</code>.</p>\n</li>\n<li>\n<p><code>pkgs.stdenv.mkDerivation { ... }:</code> This calls the mkDerivation function from\nthe standard environment (stdenv). mkDerivation is the most common way to\ndefine software packages in Nix.</p>\n</li>\n<li>\n<p><code>name = \"hello-world\";</code>: Human-readable name of the derivation</p>\n</li>\n<li>\n<p>The rest are the build phases and package metadata.</p>\n</li>\n</ul>\n<p>To use the above derivation, save it as a <code>.nix</code> file (e.g. <code>hello.nix</code>). Then\nbuild the derivation using,:</p>\n<pre><code class=\"language-bash\">nix-build\nthis derivation will be built:\n  /nix/store/9mc855ijjdy3r6rdvrbs90cg2gf2q160-hello-world.drv\nbuilding '/nix/store/9mc855ijjdy3r6rdvrbs90cg2gf2q160-hello-world.drv'...\nRunning phase: patchPhase\nRunning phase: updateAutotoolsGnuConfigScriptsPhase\nRunning phase: configurePhase\nno configure script, doing nothing\nRunning phase: buildPhase\nRunning phase: installPhase\nRunning phase: fixupPhase\nshrinking RPATHs of ELF executables and libraries in /nix/store/2ydxh5pd9a6djv7npaqi9rm6gmz2f73b-hello-world\nchecking for references to /build/ in /nix/store/2ydxh5pd9a6djv7npaqi9rm6gmz2f73b-hello-world...\npatching script interpreter paths in /nix/store/2ydxh5pd9a6djv7npaqi9rm6gmz2f73b-hello-world\nstripping (with command strip and flags -S -p) in  /nix/store/2ydxh5pd9a6djv7npaqi9rm6gmz2f73b-hello-world/bin\n/nix/store/2ydxh5pd9a6djv7npaqi9rm6gmz2f73b-hello-world\n</code></pre>\n<ul>\n<li>\n<p>Nix will execute the <code>buildPhase</code> and <code>installPhase</code></p>\n</li>\n<li>\n<p>After a successful build, the output will be in the Nix store. You can find\nthe exact path by looking at the output of the nix build command (it will be\nsomething like <code>/nix/store/your-hash-hello-world</code>).</p>\n</li>\n</ul>\n<p>Run the ‚Äúinstalled‚Äù program:</p>\n<pre><code class=\"language-bash\">./result/bin/hello\n</code></pre>\n<ul>\n<li>This will execute the <code>hello</code> file from the Nix store and print\n<code>\"Hello, World!\"</code>.</li>\n</ul>\n</details>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/cachix_devour.html",
      "url": "https://saylesss88.github.io/nix/cachix_devour.html",
      "title": "Cachix devour-flake",
      "content_html": "<h1>Cachix and the devour-flake</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p>Using devour-flake to Cache All Your Flake Outputs to Cachix</p>\n<p>When working with Nix flakes, it‚Äôs common to have many outputs‚Äîpackages, apps,\ndev shells, NixOS or Darwin configurations, and more. Efficiently building and\ncaching all these outputs can be challenging, especially in CI or when\ncollaborating. This is where devour-flake and Cachix shine. Why Use\ndevour-flake?</p>\n<p>By default, building all outputs of a flake with <code>nix build .#a .#b ... .#z</code> can\nbe slow and inefficient, as Nix will evaluate the flake multiple times‚Äîonce for\neach output. devour-flake solves this by generating a ‚Äúconsumer‚Äù flake that\ndepends on all outputs, allowing you to build everything in one go with a single\nevaluation</p>\n<h2>Installation</h2>\n<p>There quite a few ways to do this, choose a method of installation from the\n<a href=\"https://github.com/srid/devour-flake\">devour-flake</a> repository and then\ncontinue with step 1.</p>\n<p>You can even build it without installing with the following command:</p>\n<pre><code class=\"language-bash\">nix build github:srid/devour-flake \\\n  -L --no-link --print-out-paths \\\n  --override-input flake path/to/flake | cachix push &lt;name&gt;\n</code></pre>\n<pre><code class=\"language-bash\">nix-shell -p cachix\n</code></pre>\n<p>This will push all flake outputs to cachix if you have a valid authentication\ntoken and have created a cache already.</p>\n<p>How to Use devour-flake with Cachix</p>\n<ol>\n<li>Prerequisites</li>\n</ol>\n<ul>\n<li>A Cachix cache: Create one on <a href=\"https://www.cachix.org/\">Cachix</a> and generate a\n‚ÄúWrite + Read‚Äù auth token. You‚Äôll click the cache you just created and select\nSettings, in the settings you‚Äôll find Auth Tokens. When in the Auth Tokens\nsection give your token a Description, Expiration date, and finally click\nGenerate.</li>\n</ul>\n<p>(Optional) Configure your token locally, copy your auth token for the following\ncommand:</p>\n<pre><code class=\"language-bash\">cachix authtoken &lt;YOUR_TOKEN&gt;\n# Use cachix cli for the following\ncachix use your-cache-name\n</code></pre>\n<ul>\n<li><code>cachix use</code> adds your substitutors and trusted-public-keys to your\n<code>~/.config/nix/nix.conf</code> and creates one if it doesn‚Äôt exist.</li>\n</ul>\n<p><strong>Push All Flake Inputs to Cachix</strong></p>\n<p>Replace <code>&lt;mycache&gt;</code> with the name of the cache you just created.</p>\n<pre><code class=\"language-bash\">nix flake archive --json \\\n  | jq -r '.path,(.inputs|to_entries[].value.path)' \\\n  | cachix push &lt;mycache&gt;\n</code></pre>\n<p>You should see output similar to the following:</p>\n<pre><code class=\"language-bash\">Pushing 637 paths (2702 are already present) using zstd to cache sayls8 ‚è≥\n\n‚úì /nix/store/0aqvmjvhkar3j2f7zag2wjl4073apnvk-vimplugin-crates.nvim-2025-05-30 (734.65 KiB)\n‚úì /nix/store/02wm10zck7rb836kr0h3afjxl80866dp-X-Restart-Triggers-keyd (184.00 B)\n‚úì /nix/store/0asdaaax0lf1wa6m6lqqdvc8kp6qn3f6-dconf-cleanup (1008.00 B)\n‚úì /nix/store/09ki2jlh6sqbn01yw6n15h8d55ihxygf-helix-tree-sitter-mojo-3d7c53b8038f9ebbb57cd2e61296180aa5c1cf64 (601.37 KiB)\n‚úì /nix/store/0i2c29nldqvb9pnypvp3ika4i7fhc0ck-devour-output (312.00 B)\n‚úì /nix/store/0c0mwfb78xm862a7g4h9fhgzn55zppj6-helix-term (29.88 MiB)\n‚úì /nix/store/0fhdpb2qck1kbngq1dlc8lyqqadj2pb1-hyprcursor-0.1.12+date=2025-06-05_45fcc10-lib (487.30 KiB)\n‚úì /nix/store/0mfpi51bswgd91l8clqcz6mxy5k5zcd4-vimplugin-auto-pairs-2019-02-27 (40.60 KiB)\n‚úì /nix/store/0k2zq8y78vrhhkf658j6i45vz3y89v11-helix-tree-sitter-tcl-56ad1fa6a34ba800e5495d1025a9b0fda338d5b8 (110.25 KiB)\n‚úì /nix/store/0qxmahrw935136dbxkmvrg14fgnzi6bb-vimplugin-obsidian.nvim-2025-07-01 (493.02 KiB)\n‚úì /nix/store/0wjppqzcbnlf9srhr6k27pz403j3mg2j-hm-session-vars.sh (1.86 KiB)\n‚úì /nix/store/0z41071z33zg1zqyasccc3cfhxj389k0-helix-tree-sitter-swift-57c1c6d6ffa1c44b330182d41717e6fe37430704 (2.77 MiB)\n‚úì /nix/store/0n5f1x8lpc93zm81bxrfh6yccyngvrdl-unit-plymouth-read-write.service (1.19 KiB)\n‚úì /nix/store/0z8ac35n89lv2knzaj6kkp0cfxr6pmgc-hm_face.png (300.60 KiB)\n‚úì /nix/store/0zp5846pry5rknnvzz81zlvj4ghnkxp5-hyprutils-0.8.1+date=2025-07-07_a822973 (421.64 KiB)\n‚úì /nix/store/118ihgwjw6kp0528igns3pnvzbszljmg-unit-dbus.service (1.34 KiB)\n‚úì /nix/store/0pajdq9mfgkcdwbqp38j7d4clc9h9iik-hm_.mozillafirefoxdefault.keep (112.00 B)\n‚úì /nix/store/0nlvffvpx6s8mpd2rpnqb1bl5idd16yk-hm-dconf.ini (224.00 B)\n‚úì /nix/store/1fiqgqvi574rdckav0ikdh8brwdhvh69-vimplugin-alpha-nvim-2025-05-26 (69.38 KiB)\n‚úì /nix/store/1fqxw31p1llag0g7wg7izq22x5msz47r-vimplugin-persistence.nvim-2025-02-25 (37.74\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: The effectiveness of pushing the rest to cachix depend on your\nnetwork speed. I actually noticed a slow down after pushing the <code>nix/store</code>.\nPushing the <code>nix/store</code> is rarely necessary and can be very slow and\nbandwidth-intensive. Most users will only need to push relevent outputs.</p>\n</blockquote>\n<p><strong>Push the Entire /nix/store</strong></p>\n<pre><code class=\"language-bash\">nix path-info --all | cachix push &lt;mycache&gt;\n</code></pre>\n<p><strong>Pushing shell environment</strong></p>\n<pre><code class=\"language-bash\">nix develop --profile dev-profile -c true\n# then run\ncachix push &lt;mycache&gt; dev-profile\n</code></pre>\n<ul>\n<li>For the Flake way of doing things you would create something like the\nfollowing:</li>\n</ul>\n<pre><code class=\"language-nix\">{\n  config,\n  lib,\n  pkgs,\n  ...\n}: let\n  cfg = config.custom.cachix;\nin {\n  options = {\n    custom.cachix.enable = lib.mkEnableOption \"Enable custom cachix configuration\";\n  };\n\n  config = lib.mkIf cfg.enable {\n    environment.systemPackages = with pkgs; [cachix];\n\n    # to prevent garbage collection of outputs immediately after building\n    nix.extraOptions = \"gc-keep-outputs = true\";\n    nix.settings = {\n      substituters = [\n        \"https://nix-community.cachix.org\"\n        \"https://hyprland.cachix.org\"\n        \"https://ghostty.cachix.org\"\n        \"https://neovim-nightly.cachix.org\"\n        \"https://yazi.cachix.org\"\n        \"https://helix.cachix.org\"\n        \"https://nushell-nightly.cachix.org\"\n        \"https://wezterm.cachix.org\"\n        \"https://sayls88.cachix.org\"\n        # \"https://nixpkgs-wayland.cachix.org\"\n      ];\n      trusted-public-keys = [\n        \"nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=\"\n        \"hyprland.cachix.org-1:a7pgxzMz7+chwVL3/pzj6jIBMioiJM7ypFP8PwtkuGc=\"\n        \"ghostty.cachix.org-1:QB389yTa6gTyneehvqG58y0WnHjQOqgnA+wBnpWWxns=\"\n        \"neovim-nightly.cachix.org-1:feIoInHRevVEplgdZvQDjhp11kYASYCE2NGY9hNrwxY=\"\n        \"yazi.cachix.org-1:Dcdz63NZKfvUCbDGngQDAZq6kOroIrFoyO064uvLh8k=\"\n        \"helix.cachix.org-1:ejp9KQpR1FBI2onstMQ34yogDm4OgU2ru6lIwPvuCVs=\"\n        \"nushell-nightly.cachix.org-1:nLwXJzwwVmQ+fLKD6aH6rWDoTC73ry1ahMX9lU87nrc=\"\n        \"wezterm.cachix.org-1:kAbhjYUC9qvblTE+s7S+kl5XM1zVa4skO+E/1IDWdH0=\"\n        \"sayls88.cachix.org-1:LT8JnboX8mKhabC3Mj/ONHb5tyrjlnsdauQkD8Lu0us=\"\n        # \"nixpkgs-wayland.cachix.org-1:3lwxaILxMRkVhehr5StQprHdEo4IrE8sRho9R9HOLYA=\"\n      ];\n    };\n  };\n}\n</code></pre>\n<ul>\n<li>\n<p>The sayls88 entries are my custom cache. To find your trusted key go to the\ncachix website, click on your cache and it is listed near the top.</p>\n</li>\n<li>\n<p>I enable this with <code>custom.cachix.enable = true;</code> in my <code>configuration.nix</code> or\nequivalent.</p>\n</li>\n<li>\n<p>Another option is to use the top-level <code>nixConfig</code> attribute for adding your\nsubstitutors and trusted-public-keys. You only need to choose 1 method FYI:</p>\n</li>\n</ul>\n<pre><code class=\"language-nix\">{\n  description = \"NixOS &amp; Flake Config\";\n\n# the nixConfig here only affects the flake itself, not the system configuration!\n  nixConfig = {\n    experimental-features = [ \"nix-command\" \"flakes\" ];\n    trusted-users = [ \"ryan\" ];\n\n    substituters = [\n      # replace official cache with a mirror located in China\n      \"https://mirrors.ustc.edu.cn/nix-channels/store\"\n      \"https://cache.nixos.org\"\n    ];\n\n    # nix community's cache server\n    extra-substituters = [\n      \"https://nix-community.cachix.org\"\n      \"https://nixpkgs-wayland.cachix.org\"\n    ];\n    extra-trusted-public-keys = [\n      \"cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=\"\n      \"nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=\"\n      \"nixpkgs-wayland.cachix.org-1:3lwxaILxMRkVhehr5StQprHdEo4IrE8sRho9R9HOLYA=\"\n    ];\n  };\n# ... snip\n</code></pre>\n<ol start=\"2\">\n<li>Building and Caching All Outputs</li>\n</ol>\n<p>You can build and push all outputs of your flake to Cachix using the following\ncommand when in your flake directory:</p>\n<pre><code class=\"language-bash\">nix build github:srid/devour-flake \\\n -L --no-link --print-out-paths \\\n --override-input flake . \\\n | cachix push &lt;your-cache-name&gt;\n</code></pre>\n<ul>\n<li>\n<p>Replace <code>your-cache-name</code> with your actual Cachix cache name.</p>\n<p>This command will:</p>\n</li>\n<li>\n<p>Use devour-flake to enumerate and build all outputs of your flake (including\npackages, devShells, NixOS configs, etc.)</p>\n</li>\n<li>\n<p>Pipe the resulting store paths to cachix push, uploading them to your binary\ncache.</p>\n</li>\n</ul>\n<ol start=\"3\">\n<li>Example</li>\n</ol>\n<p>Suppose your cache is named my-flake-cache:</p>\n<pre><code class=\"language-bash\">nix build github:srid/devour-flake \\\n -L --no-link --print-out-paths \\\n --override-input flake . \\\n | cachix push my-flake-cache\n</code></pre>\n<ol start=\"4\">\n<li>Integration in CI</li>\n</ol>\n<p>This approach is particularly useful in CI pipelines, where you want to ensure\nall outputs are built and cached for collaborators and future builds. You can\nadd the above command to your CI workflow, ensuring the Cachix auth token is\nprovided as a secret</p>\n<ol start=\"5\">\n<li>Advanced: Using as a Nix App</li>\n</ol>\n<p>You can add devour-flake as an input to your flake for local development:</p>\n<pre><code class=\"language-nix\">{\n  inputs = {\n    devour-flake.url = \"github:srid/devour-flake\";\n    devour-flake.flake = false;\n  };\n}\n</code></pre>\n<p>And in your flake‚Äôs <code>outputs</code>, add an overlay that makes <code>devour-flake</code>\navailable in your package set:</p>\n<pre><code class=\"language-nix\">outputs = { self, nixpkgs, devour-flake, ... }@inputs: {\n  overlays.default = final: prev: {\n    devour-flake = import devour-flake { inherit (prev) pkgs; };\n  };\n\n  # Example: Add devour-flake to your devShell\n  devShells.x86_64-linux.default = let\n    pkgs = import nixpkgs {\n      system = \"x86_64-linux\";\n      overlays = [ self.overlays.default ];\n    };\n  in pkgs.mkShell {\n    buildInputs = [ pkgs.devour-flake ];\n  };\n};\n</code></pre>\n<p>Use devour-flake in your devShell:</p>\n<pre><code class=\"language-bash\">nix develop\n</code></pre>\n<p>You‚Äôll have the <code>devour-flake</code> command available for local use, so you can\nquickly build and push all outputs as needed.</p>\n<blockquote>\n<p>TIP: Alternatively, use <code>devour-flake</code> as an app:</p>\n<pre><code class=\"language-nix\">apps.x86_64-linux.devour-flake = {\n type = \"app\";\n program = \"${self.packages.x86_64-linux.devour-flake}/bin/devour-flake\";\n};\n\n</code></pre>\n</blockquote>\n<p>What Gets Built and Cached?</p>\n<p><code>devour-flake</code> detects and builds all standard outputs of a flake, including:</p>\n<ul>\n<li>\n<p>packages</p>\n</li>\n<li>\n<p>apps</p>\n</li>\n<li>\n<p>checks</p>\n</li>\n<li>\n<p>devShells</p>\n</li>\n<li>\n<p>nixosConfigurations.*</p>\n</li>\n<li>\n<p>darwinConfigurations.*</p>\n</li>\n<li>\n<p>home-manager configurations</p>\n</li>\n</ul>\n<p>This ensures that everything your flake produces is available in your Cachix\ncache for fast, reproducible builds.</p>\n<p>References:</p>\n<p><a href=\"https://github.com/srid/devour-flake\">devour-flake documentation</a></p>\n<p><a href=\"https://discourse.nixos.org/t/how-to-set-up-cachix-in-flake-based-nixos-config/31781\">Discourse Cachix for Flakes</a></p>\n<p><a href=\"https://docs.cachix.org/installation#flakes\">Cachix docs: Flakes</a></p>\n<p><a href=\"https://www.tweag.io/blog/2020-06-25-eval-cache/#:~:text=The%20overhead%20for%20creating%20the,nixpkgs%20blender%20takes%204.9%20seconds.\">Tweag Evaluation Caching</a></p>\n<p><a href=\"https://scrive.github.io/nix-workshop/06-infrastructure/01-caching-nix.html\">Scrive Caching</a></p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/whonix_kvm.html",
      "url": "https://saylesss88.github.io/nix/whonix_kvm.html",
      "title": "Whonix KVM on NixOS",
      "content_html": "<h1>Whonix KVM on NixOS</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p><img src=\"../images/swappy-20250901-101339.cleaned.png\" alt=\"Whonix Logo\" /></p>\n<blockquote>\n<p>‚ö†Ô∏è WARNING: There is no general software that can guarantee absolute anonymity\nor security; perfect security is a myth. Security is a continuous process, not\na one-time product. It also depends on time and resources: if an adversary has\nenough of either, eventual compromise is probable. However, by layering\ndefenses and following best practices, we can make attacks costly and\ntime-consuming, deterring all but highly targeted adversaries.</p>\n</blockquote>\n<p>It is highly recommended to harden your Host Machine as Type 2 hypervisors are\nonly as secure as their host. KVM is actually a type 1 hypervisor but relies on\nQEMU for emulation which is a Type 2 hypervisor. This actually makes it a sort\nof hybrid in between Type 1 and Type 2 but is in theory less secure than running\na Xen hypervisor (Type 1) on bare-metal.</p>\n<p>Whonix offers many benefits, including the convenience of running within your\ncurrent operating system without needing to reboot or use a separate Tails USB.\nIt provides similar strong anonymity protections by routing all traffic through\nTor in isolated virtual machines. The Whonix documentation is transparent about\nits limitations, which helps build trust and confidence in its security model.</p>\n<ul>\n<li>\n<p><a href=\"https://www.whonix.org/wiki/Comparison_with_Others\">Whonix Compared to Tails</a></p>\n</li>\n<li>\n<p>Tails is great but they add an add blocker to Tor that makes every Tails user\nunique from the rest of Tor Browser users reducing anonymity.</p>\n</li>\n</ul>\n<blockquote>\n<p>‚ö†Ô∏è Never rely solely on the Virtual Machine to protect you, if your host OS\nisn‚Äôt secure a Virtual Machine won‚Äôt protect you. If you have high threat\nmodel, you may want to choose a Host with better support for AppArmor and\nSelinux as they are highly limited on NixOS.</p>\n</blockquote>\n<p>That being said, there is a lot you can do to harden NixOS‚Ä¶</p>\n<h3>Harden NixOS and set up GnuPG</h3>\n<ul>\n<li>\n<p><a href=\"https://saylesss88.github.io/nix/hardening_NixOS.html\">Hardening NixOS</a></p>\n</li>\n<li>\n<p><a href=\"https://saylesss88.github.io/nix/hardening_networking.html\">Hardening Networking</a></p>\n</li>\n<li>\n<p><a href=\"https://saylesss88.github.io/nix/gpg-agent.html\">GnuPG and gpg-agent on NixOS</a></p>\n</li>\n</ul>\n<h3>A Few Things to Consider when using Whonix</h3>\n<ul>\n<li>\n<p>No activity conducted inside <code>Whonix-Workstation</code> can cause IP/DNS leaks so\nlong as <code>Whonix-Gateway</code> is left unchanged or only documented changes are made\nlike configuring bridges, establishing onion services and running updates.</p>\n</li>\n<li>\n<p>Whonix does not and does not claim to protect users against advanced\nadversaries such as nation state actors, if they target you, you will be\ninfected! If used correctly, Whonix can provide partial protection against\npassive surveillance programs, it all depends on whether Tor can provide\nadequate protection or not, which is not clear at this time.</p>\n</li>\n<li>\n<p>You shouldn‚Äôt use a VPN with Whonix and it is obvious that you‚Äôre using Tor\nbecause connections are made to known Tor Relays, which are publicly listed\nand identifiable.</p>\n</li>\n</ul>\n<blockquote>\n<p>‚ö†Ô∏èIt is impossible to Hide Tor use from the internet service provider (ISP).\nIt has been concluded this goal is difficult beyond practicality.\n‚Äì<a href=\"https://www.whonix.org/wiki/Hide_Tor_from_your_Internet_Service_Provider\">Whonix Hide Tor from your ISP</a></p>\n</blockquote>\n<ul>\n<li>\n<p>Millions of people use Tor daily for wholly legitimate reasons, particularly\nto assert their privacy rights when faced with countless corporate /\ngovernment network observers and censors.</p>\n</li>\n<li>\n<p>True anonymity is very difficult to successfully pull off and not something\nthat you can maintain for a long time.</p>\n<ul>\n<li><a href=\"https://www.whonix.org/wiki/Tips_on_Remaining_Anonymous\">Whonix Tips for remaining Anonymous</a></li>\n</ul>\n</li>\n</ul>\n<h2>üîë Key Terms</h2>\n<p>Whonix is an operating system based on Debian base (Kicksecure Hardened) and the\nTor network, which is designed for maximum anonymity and security. Whonix\nconsists of two Debian based VMs, the <code>Whonix-Gateway</code> and <code>Whonix-Workstation</code>.</p>\n<p>In this case NixOS is the <strong>Host Operating System</strong>, NixOS runs the KVM kernel\nmodule, libvirtd service, and QEMU virtualization service which together enable\nhosting VMs. It is recommended to harden the host before moving on.</p>\n<p><strong>Guests</strong> are the virtualized operating systems running inside the host‚Äôs\nvirtual machines. In this case the Whonix VMs are the <strong>Guest Machines</strong>.</p>\n<p><code>Whonix-Gateway</code> the first of 2 VMs runs Tor processes and forces all traffic\nthrough the Tor network using iptables.</p>\n<p><code>Whonix-Workstation</code> the second VM, is responsible for running user applications\nsuch as the Tor Browser. The Whonix-Workstation is isolated from both the\nWhonix-Gateway and the Host OS, if an app misbehaves, it is contained within the\nisolated Whonix-Workstation. It is largely unaware of sensitive info and won‚Äôt\nleak unless an advanced adversary is able to break out of the VM.</p>\n<p>The primary goal of Whonix is to be safer than Tor alone and that no one can\nfind out the user‚Äôs IP, location, or de-anonymize the user. It offers full\nspectrum anti-tracking protection that is much safer than VPNs. Whonix provides\nthis through security by isolation, no app is trusted.</p>\n<p><code>Whonix Concept</code>: Whonix is an Isolating Proxy with an additional Transparent\nProxy, which can be optionally disabled. ‚ÄìWhonix Docs</p>\n<p>Since Whonix is based on Kicksecure which is based on Debian stable, you can\ntypically look up solutions in a Kicksecure, Debian, or Ubuntu forum.</p>\n<ul>\n<li>The Whonix Team recommends KVM over VirtualBox for a number of\nreasons:<a href=\"https://www.whonix.org/wiki/KVM#Why_Use_KVM_Over_VirtualBox?\">Why choose KVM over VirtualBox</a></li>\n</ul>\n<p>If you really want to use VirtualBox, I got it working off of this config:</p>\n<p>VirtualBox = Type 2 hypervisor</p>\n<details>\n<summary> ‚úîÔ∏è Click to Expand VirtualBox Example </summary>\n<p>Change <code>your-user</code> to your username</p>\n<pre><code class=\"language-nix\"># vbox.nix\n{\n  config,\n  lib,\n  ...\n}: let\n  cfg = config.custom.virtualbox;\nin {\n  options.custom.virtualbox = {\n    enable = lib.mkEnableOption \"Enable VirtualBox\";\n  };\n\n  config = lib.mkIf cfg.enable {\n    virtualisation.virtualbox.host = {\n      enable = false;\n      # enableExtensionPack = true;\n    };\n\n    user.user.your-user.extraGroups = [\"vboxusers\"];\n\n    boot.kernelModules =\n      if config.hardware.cpu.amd.updateMicrocode\n      then [\"kvm-amd\"]\n      else [\"kvm-intel\"];\n  };\n}\n</code></pre>\n<p>Enable it with <code>custom.virtualbox.enable = true;</code>.</p>\n<ul>\n<li><a href=\"https://www.whonix.org/wiki/VirtualBox\">Whonix VBox Download</a></li>\n</ul>\n<p>After rebuilding with virtualbox enabled and downloading the virtualbox whonix,\nopen VirtualBox and import the Whonix file.</p>\n<p>Fix the error:: VirtualBox can‚Äôt enable the AMD-V extension. Please disable the\nKVM kernel extension:</p>\n<p>If both of these are active, they compete with each other:</p>\n<pre><code class=\"language-bash\">sudo lsmod | grep -E 'kvm|vbox'\n</code></pre>\n<p>Check the currently in use modules:</p>\n<pre><code class=\"language-bash\">modprobe -r kvm\n</code></pre>\n<p>Disable kvm and kvm_amd:</p>\n<pre><code class=\"language-bash\">sudo rmmod kvm_amd\nsudo rmmod kvm\n# To re-enable them when necessary\n# sudo modprobe kvm\n# sudo modprobe kvm_amd\n</code></pre>\n<ul>\n<li><a href=\"https://atetux.com/quick-fix-virtualbox-cant-enable-the-amd-v-extension\">Quick fix</a></li>\n</ul>\n<p>There is an opposite viewpoint,\n<a href=\"https://www.whonix.org/wiki/Dev/VirtualBox#Why_use_VirtualBox_over_KVM?\">Why choose VirtualBox over KVM</a></p>\n</details>\n<h2>Whonix-Gateway</h2>\n<p>The whonix-gateway is software designed to run Tor.</p>\n<p>The Gateway acts as a firewall and is what is routing all your traffic through\nTor.</p>\n<p>You will spend minimal time in the Gateway, it‚Äôs mainly used for Tor\nconfiguration which is reserved for advanced users.</p>\n<h3>Whonix-Workstation</h3>\n<p>All user applications should only be launched from Whonix-Workstation to ensure\nthey utilize the Tor network. (Never launch the Tor browser or any other user\napp from Whonix-Gateway.)</p>\n<p>Leaky applications can‚Äôt breakout of the Workstation, all network connections\nare forced to go through the Whonix-Gateway where they are torrified and routed\nto the internet.</p>\n<h2>Whonix KVM (Kernel Virtual Machine) on NixOS</h2>\n<p><strong>KVM</strong> (Kernel-based Virtual Machine) is a Linux kernel module that provides\nhardware-assisted virtualization.</p>\n<p>It allows the Linux kernel to act as a hypervisor, enabling virtual machines\n(VMs) to run with near-native speeds by using CPU virtualization extensions\n(Intel VT-x or AMD-V).</p>\n<p>KVM itself doesn‚Äôt handle the entire VM lifecycle; it provides the core\nvirtualization infrastructure.</p>\n<p><strong>QEMU</strong> (Quick Emulator) is an open-source user-space program that emulates\nhardware for virtual machines.</p>\n<p>When combined with KVM, QEMU uses hardware acceleration to run VMs much faster\nby offloading CPU virtualization to KVM.</p>\n<p>So, QEMU provides the device emulation and VM management interface, while KVM\nprovides the fast virtualization engine within the kernel.</p>\n<p><strong>Install Qemu-KVM</strong>:</p>\n<pre><code class=\"language-nix\">{\n  config,\n  pkgs,\n  ...\n}: {\n  ##  QEMU-KVM\n  environment.systemPackages = with pkgs; [\n    qemu\n    # Optional\n    virt-viewer\n  ];\n\n  # Virt-Manager GUI\n  programs.virt-manager.enable = true;\n  virtualisation = {\n    # libvirtd daemon\n    libvirtd = {\n      enable = true;\n      qemu = {\n        # enables a TPM emulator\n        swtpm.enable = true;\n      };\n    };\n    # allow USB device to be forwarded\n    spiceUSBRedirection.enable = true;\n  };\n  # Spice protocol improves VM display and input responsiveness\n  services.spice-vdagentd.enable = true;\n}\n</code></pre>\n<hr />\n<p>The <strong>libvirtd</strong> is the primary daemon (service) in the libvirt virtualization\nmanagement system. It runs on your host machine and acts as the core management\ncomponent for virtual machines (VMs).</p>\n<p>Add <code>libvirtd</code> &amp; <code>kvm</code> to your users <code>extraGroups</code>:</p>\n<pre><code class=\"language-nix\">users.users = {\n    your-user = {\n        extraGroups = [\n            \"libvirtd\"\n            \"kvm\"\n        ];\n    };\n};\n</code></pre>\n<p>Restart <code>libvirtd</code>:</p>\n<pre><code class=\"language-bash\">sudo systemctl restart libvirtd\n</code></pre>\n<hr />\n<h2>Network Start</h2>\n<p>Ensure KVM‚Äôs / QEMU‚Äôs default network is enabled and has started:</p>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-autostart default\n</code></pre>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-start default\n</code></pre>\n<hr />\n<h3>Download Whonix (KVM) (stable)</h3>\n<ol>\n<li>\n<p><a href=\"https://www.whonix.org/download/libvirt/17.4.4.6/Whonix-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz\">Whonix (KVM) (stable) Download</a></p>\n</li>\n<li>\n<p>Go to <a href=\"https://www.whonix.org/wiki/KVM\">whoniix.org</a> to verify the signature.\nDownload the <code>OpenPGP Signature</code>, and the <code>Download Whonix OpenPGP Key</code>. Your\nDownloads directory will look like this:</p>\n</li>\n</ol>\n<pre><code class=\"language-bash\">~/DownloadsÓÇ∫Û∞è´ÓÇ¥ ls\n‚ï≠‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ\n‚îÇ # ‚îÇ                         name                          ‚îÇ type ‚îÇ  size   ‚îÇ   modified    ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ 0 ‚îÇ Whonix-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz     ‚îÇ file ‚îÇ  3.3 GB ‚îÇ 2 minutes ago ‚îÇ\n‚îÇ 1 ‚îÇ Whonix-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz.asc ‚îÇ file ‚îÇ  1.0 kB ‚îÇ a minute ago  ‚îÇ\n‚îÇ 2 ‚îÇ derivative.asc                                        ‚îÇ file ‚îÇ 77.3 kB ‚îÇ 3 minutes ago ‚îÇ\n‚ï∞‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ\n</code></pre>\n<p>Import <code>derivative.asc</code>:</p>\n<pre><code class=\"language-bash\">gpg --import derivative.asc\n</code></pre>\n<p>Verify the Public Key:</p>\n<pre><code class=\"language-bash\">gpg --verify Whonix-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz.asc Whonix-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz\ngpg: Signature made Sun 10 Aug 2025 09:04:13 AM EDT\ngpg:                using RSA key 6E979B28A6F37C43BE30AFA1CB8D50BB77BB3C48\ngpg: Good signature from \"Patrick Schleizer &lt;adrelanos@kicksecure.com&gt;\" [unknown]\ngpg:                 aka \"Patrick Schleizer &lt;adrelanos@riseup.net&gt;\" [unknown]\ngpg:                 aka \"Patrick Schleizer &lt;adrelanos@whonix.org&gt;\" [unknown]\ngpg: WARNING: This key is not certified with a trusted signature!\ngpg:          There is no indication that the signature belongs to the owner.\nPrimary key fingerprint: 916B 8D99 C38E AF5E 8ADC  7A2A 8D66 066A 2EEA CCDA\n     Subkey fingerprint: 6E97 9B28 A6F3 7C43 BE30  AFA1 CB8D 50BB 77BB 3C48\n~/DownloadsÓÇ∫Û∞è´ÓÇ¥                                                                                                 09/04/2025 11:53:10 AM\n</code></pre>\n<p>Now <code>gpg --list-keys</code> will show Patrick Schleizer‚Äôs Key.</p>\n<p>It is good practice to sign your verified key and then push it to the public\nkeyserver to contribute to the web of trust but optional.</p>\n<ol start=\"3\">\n<li><a href=\"https://www.whonix.org/wiki/KVM#Decompress\">Decompress the Image</a> and follow\nthe rest of the Whonix KVM install instructions from there.</li>\n</ol>\n<p>Nixpkgs doesn‚Äôt have the <code>xz-utils</code> package but it does have the <code>xz</code> package.</p>\n<p>Nixpkgs also has <code>nixpkgs.safe-rm</code> if you wanted to follow the suggestions from\nWhonix.</p>\n<pre><code class=\"language-bash\">nix-shell -p xz safe-rm\n</code></pre>\n<pre><code class=\"language-bash\">tar -xvf Whonix*.libvirt.xz\n</code></pre>\n<hr />\n<h3>Import the Whonix VM Templates</h3>\n<p>The following commands come directly from the\n<a href=\"https://www.whonix.org/wiki/KVM#Importing_Whonix_VM_Templates\">Whonix KVM Docs Importing Whonix VM Templates</a></p>\n<ol>\n<li>Add the virtual networks. This step only needs to be done once and not with\nevery upgrade.</li>\n</ol>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-define Whonix_external*.xml\n</code></pre>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-define Whonix_internal*.xml\n</code></pre>\n<ol start=\"2\">\n<li>Activate the virtual networks:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-autostart Whonix-External\n</code></pre>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-start Whonix-External\n</code></pre>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-autostart Whonix-Internal\n</code></pre>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system net-start Whonix-Internal\n</code></pre>\n<ol start=\"3\">\n<li>Import the Whonix Gateway and Workstation images:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system define Whonix-Gateway*.xml\n</code></pre>\n<pre><code class=\"language-bash\">sudo virsh -c qemu:///system define Whonix-Workstation*.xml\n</code></pre>\n<p>After the above steps, either copy or move the <code>qcow2</code> images to\n<code>/var/lib/libvirt/images</code>:</p>\n<blockquote>\n<p>‚ùó It‚Äôs recommended to move the files into place, if you want to copy them you\nneed to use a special command FYI.</p>\n</blockquote>\n<pre><code class=\"language-bash\">sudo mkdir -p /var/lib/libvirt/images\n</code></pre>\n<pre><code class=\"language-bash\">sudo mv Whonix-Gateway*.qcow2 /var/lib/libvirt/images/Whonix-Gateway.qcow2\n</code></pre>\n<pre><code class=\"language-bash\">sudo mv Whonix-Workstation*.qcow2 /var/lib/libvirt/images/Whonix-Workstation.qcow2\n</code></pre>\n<h3>Cleanup</h3>\n<pre><code class=\"language-bash\">safe-rm Whonix*\n</code></pre>\n<pre><code class=\"language-bash\">safe-rm -r WHONIX*\n</code></pre>\n<h3>Launch virt-manager and start the VMs</h3>\n<pre><code class=\"language-bash\">virt-manager\n</code></pre>\n<p>From here it will take a bit to load both VMs, you can click on one and go to\n<code>Edit</code>, <code>Virtual Machine Details</code> and from there you have some options to give\nthe VM more CPUs and memory.</p>\n<p>Considering that the Whonix-Workstation is where all of the user applications\nwill be opened, it makes sense to give it more CPUs and memory.</p>\n<p>I‚Äôve seen recommendations for a minimum of 4G of RAM for the Workstation and 2GB\nfor the Gateway.</p>\n<ul>\n<li>\n<p>Increase vCPU count for better performance</p>\n</li>\n<li>\n<p>Enable XML editing in settings</p>\n</li>\n<li>\n<p>Enable copy pasting by adding <code>&lt;clipboard copypaste=\"yes\"/&gt;</code></p>\n</li>\n</ul>\n<h2>Start Whonix-Gateway</h2>\n<p><img src=\"../images/swappy-20250901-101351.cleaned.png\" alt=\"Whonix Old Logo\" /></p>\n<p>Always start the Whonix-Gateway first.</p>\n<p>Click on Whonix-Gateway, press Play, and choose the default Persistent VM.</p>\n<p>To view the gateway press <code>Open</code>.</p>\n<p>You can use the ‚ÄúSystem Maintenance Panel‚Äù to <code>Check for Updates</code> and then\n<code>Install Updates</code>. This can also be used for user and password creation, the\ndefault user is <code>user</code> with a passwordless login.</p>\n<p>Change the password manually:</p>\n<pre><code class=\"language-bash\">sudo passwd\nchangeme\n</code></pre>\n<p>Change the passwords and disable auto-login.</p>\n<p>Run a systemcheck if it wasn‚Äôt run automatically. Click the Xfce Logo and go to\n<code>System</code>, <code>System Check</code>.</p>\n<ul>\n<li><a href=\"https://www.whonix.org/wiki/Common_CLI_Commands\">Whonix Common CLI Commands</a></li>\n</ul>\n<h2>Whonix-Workstation</h2>\n<p>Whonix-Workstation is another VM, designed to provide users with a secure and\nanonymous environment for running applications and performing online tasks.</p>\n<p>When you first launch <code>Whonix-Workstation</code>, choose the second option down or\nreboot, and then choose ‚ÄúPersistent Mode Sysmaint Session‚Äù. From there, you can\ngo through the same steps as you did for the Gateway.</p>\n<p>With the workstation, a security feature disables <code>sudo</code> for the default user.\nInstead of the <code>user</code> account, a separate <code>sysmaint</code> (system maintenance)\naccount is used for administrative tasks that require root privileges, such as\nupdates and package installations.</p>\n<ul>\n<li>Change all user passwords and disable auto-login</li>\n</ul>\n<p>After you get your system updated and upgraded, you‚Äôll want to reboot the\nWorkstation and start it in the first Persistent mode available rather than the\n<code>sysmaint</code> mode.</p>\n<p>Once Workstation is running and both VMs are updated and upgraded, check that\nyour IP address is a Tor IP:</p>\n<pre><code class=\"language-bash\">curl ip.me\n#\ncurl ip.me\n</code></pre>\n<p>Each consecutive time that you run <code>curl ip.me</code>, Tor establishes a new circuit\nand you will get a different IP returned each time for as many Tor nodes are\navailable. Not that you would want to but it‚Äôs cool functionality giving us a\nvisual of the new circuit.</p>\n<p>Start Tor and check what you are fingerprinted as by typing <code>deviceinfo.me</code> into\nthe URL.</p>\n<h4>Launching Tor Browser</h4>\n<p>Click the Xfce logo and choose Tor Browser. On the first launch, you will need\nto update Tor by clicking in the top right corner.</p>\n<p>Or you can open the terminal and type:</p>\n<pre><code class=\"language-bash\">update-torbrowser\n</code></pre>\n<ul>\n<li>Every time you run the above command, the old browser will be killed, along\nwith your old browser profile, including bookmarks and passwords. If the\nupdate suggests a downgrade from your current version don‚Äôt do it, it is\nlikely a downgrade attack.</li>\n</ul>\n<p>Make sure you don‚Äôt forget to go to the Settings, Privacy and Security, and set\nthe <code>Security Level</code> to <code>Safest</code> to disable JavaScript and more before exploring\nthe dark web.</p>\n<p>Visit <code>https://check.torproject.org</code>, you should see ‚ÄúCongratulations. This\nbrowser is configured to use Tor.‚Äù</p>\n<p>If you need a place to start, check out <code>https://tor.taxi</code> by plugging that into\nthe URL. Always include the <code>https</code> yourself!</p>\n<blockquote>\n<p>‚ùó NOTE: Use HTTPS and TLS wherever possible, since Tor only encrypts traffic\nas it travels through the network of three nodes. Traffic at Exit nodes is\nvulnerable if unencrypted, because when it reaches the Exit node it is plain\ntext. Prefer the use of <code>.onion</code> services because they form a tunnel that is\nencrypted end-to-end, using a random rendezvous point within the Tor network;\nHTTPS isn‚Äôt required within Onion services. Prefer the use of <code>.onion</code>\nservices because they form a tunnel that is encrypted end-to-end, using a\nrandom rendezvous point within the Tor network; HTTPS isn‚Äôt required within\nOnion services.\n‚Äì<a href=\"https://www.whonix.org/wiki/Tor_Myths_and_Misconceptions#All_my_traffic_is_encrypted_by_default\">All my traffic is encrypted by default?</a></p>\n</blockquote>\n<h2>Live Mode</h2>\n<p>To get Whonix to perform more similarly to Tails you could run Whonix in Live\nMode. Live Mode is a privacy-focused mode where nothing is saved at shutdown,\nmaking it great for handling sensitive data.</p>\n<ul>\n<li><a href=\"https://www.kicksecure.com/wiki/Live_Mode\">Live Mode</a></li>\n</ul>\n<p>Same process, reboot the Workstation and Choose\n<code>LIVE Mode | USER Session | disposable use</code></p>\n<ul>\n<li><a href=\"https://www.kicksecure.com/wiki/Anti-Forensics_Precautions\">Anti Forensics Precautions</a></li>\n</ul>\n<h2>Download and Verify Kicksecure KVM</h2>\n<ul>\n<li><a href=\"https://www.kicksecure.com/wiki/KVM\">Kicksecure KVM wiki</a></li>\n</ul>\n<ol>\n<li>\n<p><a href=\"https://www.kicksecure.com/download/libvirt/17.4.4.6/Kicksecure-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz\">Download Kicksecure Xfce (KVM) (stable) (FREE!)</a></p>\n</li>\n<li>\n<p><a href=\"https://www.kicksecure.com/download/libvirt/17.4.4.6/Kicksecure-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz.asc\">Download OpenPGP Signature</a></p>\n</li>\n<li>\n<p><a href=\"https://www.kicksecure.com/keys/derivative.asc\">Download Kicksecure OpenPGP Key</a></p>\n</li>\n<li>\n<p>Import the <code>derivative.asc</code> file:</p>\n</li>\n</ol>\n<pre><code class=\"language-bash\">gpg --import derivative.asc\n</code></pre>\n<ol start=\"5\">\n<li>Make sure both files are done downloading and run the following to verify,\nyour file names might be slightly different:</li>\n</ol>\n<pre><code class=\"language-bash\">gpg --verify Kicksecure-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz.asc Kicksecure-Xfce-17.4.4.6.Intel_AMD64.qcow2.libvirt.xz\ngpg: Signature made Sun 10 Aug 2025 07:32:52 AM EDT\ngpg:                using RSA key 6E979B28A6F37C43BE30AFA1CB8D50BB77BB3C48\ngpg: Good signature from \"Patrick Schleizer &lt;adrelanos@kicksecure.com&gt;\" [unknown]\ngpg:                 aka \"Patrick Schleizer &lt;adrelanos@riseup.net&gt;\" [unknown]\ngpg:                 aka \"Patrick Schleizer &lt;adrelanos@whonix.org&gt;\" [unknown]\ngpg: WARNING: This key is not certified with a trusted signature!\ngpg:          There is no indication that the signature belongs to the owner.\nPrimary key fingerprint: 916B 8D99 C38E AF5E 8ADC  7A2A 8D66 066A 2EEA CCDA\n     Subkey fingerprint: 6E97 9B28 A6F3 7C43 BE30  AFA1 CB8D 50BB 77BB 3C48\n</code></pre>\n<ol start=\"6\">\n<li><strong>Decompress</strong></li>\n</ol>\n<pre><code class=\"language-bash\">tar -xvf Kicksecure*.libvirt.xz\n</code></pre>\n<p>Don‚Äôt use <code>unxz</code>!</p>\n<h3>Resources</h3>\n<ul>\n<li>\n<p><a href=\"https://www.whonix.org/wiki/Documentation\">Whonix Docs</a></p>\n</li>\n<li>\n<p><a href=\"https://www.whonix.org/wiki/About\">Whonix Overview</a></p>\n</li>\n<li>\n<p><a href=\"https://www.whonix.org/wiki/Dev/Technical_Introduction\">Whonix Technical Intro</a></p>\n</li>\n<li>\n<p><a href=\"https://www.kicksecure.com/wiki/Computer_Security_Introduction\">Kicksecure Computer Security Intro</a></p>\n</li>\n<li>\n<p><a href=\"https://www.kicksecure.com/wiki/Computer_Security_Introduction#Advanced_Security_Guide\">Kicksecure Advanced Security Guide</a></p>\n</li>\n</ul>\n<p>k\n<a href=\"https://www.kicksecure.com/wiki/System_Hardening_Checklist\">System Hardening Checklist</a></p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/hardening_networking.html",
      "url": "https://saylesss88.github.io/nix/hardening_networking.html",
      "title": "Hardening Networking",
      "content_html": "<h1>Hardening Networking</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<blockquote>\n<p>Since networks and systems vary, some adjustments may cause unexpected issues,\nespecially around critical components like DNS or firewalls. Always review and\ntest changes in a controlled environment before applying them broadly.</p>\n</blockquote>\n<blockquote>\n<p>Understand the trade-offs and tailor the settings to your threat model and\nworkflow. Take what‚Äôs useful, adapt as needed, and seek expert guidance for\nmore advanced scenarios.</p>\n</blockquote>\n<h2>Introduction</h2>\n<p>Every setup is unique, feel free to adapt or skip sections based on your needs.\nStart with the basics and build up as you gain confidence. The goal is\npractical, tested hardening tailored to you.</p>\n<h3>Safe Browsing / Privacy Enhancing Habits</h3>\n<p><strong>Adopt Encrypted DNS and HTTPS Everywhere</strong></p>\n<ul>\n<li>\n<p>Configure your system and browsers to use DNS over HTTPS (DoH), DNS over TLS\n(DoT), or DNSCrypt to prevent DNS leakage. Use HTTPS-Only mode in browsers to\nencrypt all web traffic. Prefer browsers with strong privacy defaults or add\nrecommended extensions.</p>\n</li>\n<li>\n<p><a href=\"https://www.privacyguides.org/en/dns/#dnscrypt-proxy\">Privacy Guides dnscrypt-proxy recommendation</a></p>\n</li>\n<li>\n<p>Disable browser ‚Äúremember password‚Äù and autofill features, clear cookies and\nsite data upon exit, and carefully vet suspicious URLs with tools like\n<a href=\"https://www.virustotal.com/gui/home/url\">VirusTotal</a>.</p>\n</li>\n</ul>\n<p><strong>Limit Account Linking and Use Unique Credentials</strong></p>\n<ul>\n<li>Create separate accounts with unique passwords instead of signing in with\nGoogle, Facebook, or similar services to limit broad data exposure from\ncompromises.</li>\n</ul>\n<p><strong>Use Metadata Cleaning Tools</strong></p>\n<ul>\n<li>\n<p>Many files like images, PDFs, and office documents contain hidden metadata\ninformation such as location data, device details, and more that can reveal\nyour identity or other sensitive information when you share files publicly.</p>\n</li>\n<li>\n<p>To protect your privacy, always sanitize files by removing this metadata\nbefore sharing. Tools like <a href=\"https://0xacab.org/jvoisin/mat2\">mat2</a> are\ndesigned to strip metadata from a wide range of media files efficiently.\n(<code>pkgs.mat2</code>). You just type <code>mat2 swappy-2025.png</code> for example and there will\nthen be a new <code>mat2 swappy-2025.cleaned.png</code> that can safely be shared.</p>\n</li>\n</ul>\n<p><strong>Use Anonymous File-Sharing Tools</strong></p>\n<ul>\n<li>For sensitive transfers, consiter tools like\n<a href=\"https://github.com/onionshare/onionshare\">OnionShare</a> that provide anonymity\nand security.(<code>pkgs.onionshare</code>)</li>\n</ul>\n<p><strong>Avoid Scanning Random QR Codes Without Verification</strong></p>\n<ul>\n<li>Use QR code scanner apps that check for malicious content before loading\nlinks.</li>\n</ul>\n<p><strong>Understand Your Threat Model</strong></p>\n<ul>\n<li>Apply these basics universally, but tailor advanced hardening according to\nyour unique environment, connectivity needs, and risk profile.</li>\n</ul>\n<p><strong>Delete cookies and site data when the browser is closed</strong>. (security not\nusability).</p>\n<p><strong>Use Strong, Unique Passwords and a Password Manager</strong></p>\n<ul>\n<li>\n<p>Avoid reused passwords by using reliable password managers like KeePassXC or\nBitwarden, both available on NixOS. Pair this with enabling two-factor\nauthentication <strong>(2FA) wherever possible</strong>.</p>\n</li>\n<li>\n<p>It‚Äôs advisable to only use the desktop version and not the browser extension\nfor a number of reasons. One is that you can store your passwords completely\noffline and have complete ownership of them.</p>\n</li>\n</ul>\n<pre><code class=\"language-nix\">environment.systemPackages = [\n    pkgs.keepassxc\n    pkgs.kpcli     # KeePass CLI\n    # OR\n    pkgs.bitwarden-desktop\n    pkgs.bitwarden-cli\n];\n</code></pre>\n<p>With KeePassXC, you can require 3 different authentication methods at the same\ntime. You can choose a password, a keyfile, and a security key where it won‚Äôt\nopen unless all 3 are present giving you additional security. All 3 might not be\nnecessary but it‚Äôs possible. It‚Äôs also easy to migrate to KeePassXC, you can\nimport your vault from many different managers.</p>\n<p>KeepassXC also makes it easy to keep your complete password database offline\nwhich can significantly reduce the risk of a breach.</p>\n<p>With Bitwarden, to enable 2 factor authentication, you need to log in with your\nmaster password through the web interface.</p>\n<ul>\n<li><a href=\"https://www.privacyguides.org/en/basics/passwords-overview/\">PrivacyGuides Intro to Passwords</a></li>\n</ul>\n<hr />\n<h3>Why Follow These Basics?</h3>\n<p>These recommended steps help protect your privacy and security while maintaining\nusability and minimizing system interruptions. They catch common threats like\nnetwork eavesdropping, password reuse, fingerprinting, and data leakage,\nproviding a solid foundation to build on.</p>\n<p>A vast majority of secure and privacy-focused browsers available for NixOS are\nbased on Firefox.</p>\n<blockquote>\n<p>‚ùó NOTE: Firefox does lack some security features available in Chrome and\nsandbox escapes in Linux are relatively easy. People such as madaidan say to\nnever use Linux or Firefox period when you‚Äôre worried about security and\nprivacy. I‚Äôm not personally going to jump to proprietary software with known\nbackdoors in a misguided attempt at increasing security/privacy.</p>\n</blockquote>\n<ul>\n<li><a href=\"https://techstory.in/eu-hits-google-with-3-5-billion-antitrust-fine-over-adtech-practices/\">EU Hits Google with 3.5 Billion Antitrust</a></li>\n</ul>\n<p>This <a href=\"https://grapheneos.org/usage#web-browsing\">GrapheneOS article</a>, breaks\ndown why they use Chromium-based browsers and specifically mentions that it‚Äôs\nnot recommended to use Firefox, especially on Linux because of the weak\nsandboxing.</p>\n<p>As a Chromium-based browser, Brave has been growing on me. Brave uses\nrandomization rather than standardization for fingerprinting protection. If you\nrun Cover Your Tracks with Brave, it will show a randomized fingerprint.</p>\n<details>\n<summary> ‚úîÔ∏è Click To Expand United States Patriot Act Overview </summary>\n<p><a href=\"https://www.csis.org/analysis/fact-sheet-section-215-usa-patriot-act\">Section 215 USA Patriot Act</a>\npermits the collection of ‚ÄúTangible Things‚Äù or ‚ÄúBusiness Records‚Äù, e.g., your\nphone records, medical records, etc. for an investigation to obtain foreign\nintelligence information. If it does relate to a US person it must be relevant\nto preventing terrorism or espionage, and not be based solely on activities\nprotected by the first amendment. ‚ÄúRelevant‚Äù is the key word here and it is at\nthe governments discretion meaning they sweep everything and sift it later.\nCriticized for violating American citizens Fourth Amendment protections against\nwarrantless search and seizure and proven to be ineffective.</p>\n</details>\n<p>What is ‚Äúnormal‚Äù and allowed today might be suppressed tomorrow, look at the UK\n<a href=\"https://en.wikipedia.org/wiki/Online_Safety_Act_2023\">Online Safety Act</a>\npurported to protect children, accused of banning privacy. This is because the\nonly way to verify age is to make everyone submit KYC with their drivers license\nor ID, completely taking away any anonymity of adults and children alike.</p>\n<p>Also see\n<a href=\"https://www.bbc.com/news/articles/cq68j5g2nr1o\">BBC 4chan refuses to pay fine</a></p>\n<p>The mere existence of a surveillance state breeds fear and conformity and\nstifles free\nexpression.‚Äì<a href=\"https://theintercept.com/2016/04/28/new-study-shows-mass-surveillance-breeds-meekness-fear-and-self-censorship/\">The Intercept</a></p>\n<p>There are much more scary examples in\n<a href=\"https://thenewoil.org/en/guides/prologue/why/\">Privacy, The new Oil</a></p>\n<h2>Protections from Surveillance in the U.S.</h2>\n<details>\n<summary> ‚úîÔ∏è Click to Expand U.S. Surveillance protections </summary>\n<blockquote>\n<p>‚ö†Ô∏è A crucial caveat to keep in mind regarding surveillance protections in the\nU.S., whether grounded in the Fourth Amendment, the First Amendment, or\nstatutory laws is that <strong>these protections are not foolproof and have\nrepeatedly failed or been circumvented in practice</strong>.</p>\n</blockquote>\n<ul>\n<li>\n<p><strong>Fourth Amendment Basics</strong>: It demands reasonableness in searches and usually\nrequires a warrant. This means government agents cannot arbitrarily listen to\nyour private communications or search your digital data without judicial\napproval</p>\n</li>\n<li>\n<p><strong>Electronic Surveillance Challenges</strong>: Courts have wrestled with how the\nFourth Amendment applies to modern communications. The Supreme Court has ruled\nin some cases that pervasive or non-consensual electronic surveillance\nviolates reasonable expectations of privacy, but other rulings have allowed\nbroader state actions in national security contexts.</p>\n</li>\n<li>\n<p><strong>The Third-Party Doctrine</strong>: A major limitation arises from the ‚Äúthird-party\ndoctrine,‚Äù which holds that information voluntarily shared with third parties\n(like phone companies or internet providers) has reduced Fourth Amendment\nprotections. This means data held by third parties may be subject to\ngovernment access without a warrant in some cases</p>\n</li>\n<li>\n<p><strong>The First Amendment</strong> guarantees free speech and the freedom to receive\ninformation without government censorship or intimidation. Excessive or\nsecretive government surveillance can chill free speech by making people\nafraid their communications are monitored, discouraging open expression and\nparticipation in public discourse.</p>\n<ul>\n<li>Advocates argue that courts should recognize government surveillance not\nonly as a Fourth Amendment search issue but also as a First Amendment\nviolation where surveillance suppresses or chills constitutionally protected\nexpression.</li>\n</ul>\n</li>\n</ul>\n<p>While the Fourth Amendment traditionally governs searches and surveillance\nlegality, the First Amendment frames the broader impact on free speech and\ndemocratic engagement. Invoking both provides a more comprehensive\nconstitutional shield against intrusive surveillance practices.</p>\n</details>\n<hr />\n<h3>Choosing Secure/Private Browsers and Search Engines</h3>\n<blockquote>\n<p>‚ÄúThe major problem with current systems is their inability to provide\neffective isolation between various programs running on one machine. E.g. if\nthe user‚Äôs Web browser gets compromised (due to a bug exploited by a malicious\nweb site), the OS is usually unable to protect other user‚Äôs applications and\ndata from also being compromised.‚Äù ‚ÄìQubes arch-spec</p>\n</blockquote>\n<p>On a hardened Linux system, the browser is most often the weakest link exposed\nto the internet, and so security, privacy, and anti-tracking features of\nbrowsers are now as important, or even more important than platform-level\nprotections.</p>\n<hr />\n<h3>Fingerprinting</h3>\n<p>There are two main approaches to obfuscating your fingerprint:</p>\n<ul>\n<li>\n<p><strong>Standardization</strong>: Make browsers standardized and therefore have the same\nfingerprint to blend into a crowd. This is what Tor and Mullvad Browser do.\nBest for anonymity; increases the crowd you blend into, but may decrease\nusability (site breakage, CAPTCHAs); adversaries may still find subtle\ndifferences.</p>\n</li>\n<li>\n<p><strong>Randomization</strong>: Randomize fingerprint metrics so it‚Äôs not directly linkable\nto you. Brave has this feature, if you run coveryourtracks with Brave you will\nget a result of ‚Äúyour browser has a randomized fingerprint‚Äù. This is good for\nprivacy but may be detectable by advanced scripts.</p>\n</li>\n</ul>\n<hr />\n<h4>Firefox</h4>\n<p>My understanding here is evolving, Firefox on Linux may be very privacy friendly\nafter some tweaks, but is not necessarily a secure browser.</p>\n<p>Firefox‚Äôs defaults are not privacy respecting or secure but allows a high level\nof customization to make it so. Firefox will be patched with security fixes\nsooner than any fork, and some forks are slow to apply the updates leaving a\nvulnerability open longer to exploit.</p>\n<p>The Tor Uplift Project was a collaboration between the Tor Project and Mozilla\nto integrate key privacy and anti-fingerprinting features from the Tor Browser\ninto Firefox. This enables us to enable/disable a few settings and remove the\nneed for most add-ons.</p>\n<p>If you use Firefox‚Äôs ETP, RFP, and other protections provided by the ghacks or\nArkenfox scripts alongside uBlock configured to use dynamic filtering you can\naccomplish what it used to take 10 extensions to do.</p>\n<p>Firefox does implement Site Isolation with its Project Fission. This is much\nless mature than Chromes site isolation and often disabled by default on\ndifferent versions of Firefox. To ensure it‚Äôs enabled, go to <code>about:config</code> and\ncheck that both <code>fission.autostart</code>, and <code>gfx.webrender.all</code> prefs are set to\n<code>true</code>.</p>\n<p>With uBlock you can <code>Disable JavaScript</code> which functions similar to NoScript,\nenable numerous blocklists and more.</p>\n<ul>\n<li><a href=\"https://github.com/gorhill/uBlock/wiki\">uBlock Wiki</a></li>\n</ul>\n<p>To enable Enhanced Tracking Protection and FPP, go to\n<code>Settings -&gt; Privacy &amp; Security</code> -&gt; <code>Enhanced Tracking Protection -&gt; Custom</code>. If\nit causes breakage, while on the broken site, click the sheild next to the\nsearch bar. From there you can turn off ETP for <strong>just that site</strong>.</p>\n<p>Once you select <code>Custom</code>, you‚Äôll see that among the options is to block\n<code>Known fingerprinters</code> as well as <code>Suspected fingerprinters</code>. The ‚ÄúKnown\nFingerprinters‚Äù protection works by blocking scripts listed in\n<a href=\"https://disconnect.me/trackerprotection#categories_of_trackers\">Disconnect‚Äôs fingerprinting list</a>\nFor most users they suggest using the above FPP to avoid breakage. To go further\nand enable RFP, go to <code>about:config</code> and set <code>privacy.resistFingerprinting</code> to\n<code>true</code>.</p>\n<ul>\n<li>\n<p><a href=\"https://support.mozilla.org/en-US/kb/resist-fingerprinting\">Mozilla Resist Fingerprinting</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.mozilla.org/Project_Fission\">Mozilla Project_Fission</a>, Firefox‚Äôs\nimplementation of Site Isolation.</p>\n<ul>\n<li>To ensure Site Isolation is enabled, in <code>about:config</code>, set\n<code>fission.autostart</code>, and <code>gfx.webrender.all</code> prefs to <code>true</code>.(It‚Äôs disabled\nby default on android).</li>\n</ul>\n</li>\n</ul>\n<hr />\n<h4>Tor Browser</h4>\n<blockquote>\n<p>‚ùó NOTE: Tor is <strong>not</strong> the most secure browser, anonymity and security can\noften be at odds with each other. Having the exact same browser as many other\npeople isn‚Äôt the best security practice, but it is great for anonymity. Tor is\nalso based on Firefox Esr, which only receives patches for vulnerabilities\nconsidered Critical or High which can be taken advantage of.</p>\n</blockquote>\n<p>Tor is a modified version of Firefox specifically designed for use with Tor.</p>\n<p>Tor routes your internet traffic through a global volunteer-operated network,\nmasking your IP address and activities from local observers, ISPs, websites, and\nsurveillance systems. This helps you protect personal information and maintain\nanonymity when browsing, communicating, or using online services.</p>\n<p>Adding browser plugins to Tor can de-anonymize you, don‚Äôt do it. Tor is already\nbuilt with the necessary plugins and privacy protecting rules, so adding more is\nunnecessary and actually dangerous for your anonymity.</p>\n<p>A Tor exit node can easily see your traffic, and if you‚Äôre not using HTTPS then\nit may be able to modify that traffic. Only use HTTPS when browsing the clear\nnet with Tor, this doesn‚Äôt apply to onion services (<code>.onion</code>) as the traffic\nstays inside the Tor network all the way to the destination.</p>\n<p>You can visit both the clear web and <code>.onion</code> sites on Tor. Whenever possible\nyou should utilize Onion Services (<code>.onion</code> addresses) so communications and web\nbrowsing stay within the Tor network. <code>.onion</code> URLS form a tunnel that is\nend-to-end encrypted using a random rendezvous point and incorporating\n<a href=\"https://en.wikipedia.org/wiki/Forward_secrecy\">perfect forward secrecy (PFS)</a>.</p>\n<p>Bridges are only necessary in countries that don‚Äôt allow people to use Tor.\nUsing Bridges when they aren‚Äôt needed takes resources away from people in\noppressive regimes that need, only use them if necessary. Read the guides, and\nuse Tails OS, or Whonix when it really matters.</p>\n<ul>\n<li><a href=\"https://saylesss88.github.io/nix/whonix_kvm.html\">Whonix KVM on NixOS</a></li>\n</ul>\n<p>You will see a lot of conflicting information about using Tor with a VPN. If you\nare in an area that blocks access to Tor or it is dangerous to use Tor, by all\nmeans use a trusted VPN.</p>\n<h3>TorPlusVPN</h3>\n<ul>\n<li>\n<p><a href=\"https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorPlusVPN\">Tor Project Wiki TorPlusVPN</a></p>\n</li>\n<li>\n<p><a href=\"https://www.privacyguides.org/en/advanced/tor-overview/#safely-connecting-to-tor\">Safely Connecting to Tor</a></p>\n</li>\n</ul>\n<p><strong>Learn about Tor</strong></p>\n<p>I recommend starting with\n<a href=\"https://www.privacyguides.org/articles/2025/04/30/in-praise-of-tor/#onion-sites-you-can-visit-using-the-tor-browser\">Privacy Guides In Praise of Tor</a>\nand then reading their\n<a href=\"https://www.privacyguides.org/en/advanced/tor-overview/\">Tor Overview</a> they\nhave been the most informative resources I‚Äôve come across yet.</p>\n<p>The Electronic Frontier Foundation sponsors and helps fund Tor and so does the\nUnited States Government.</p>\n<p>If you are fortunate to live outside of oppressive regimes with extreme\ncensorship, using Tor for every day, mundane activities is likely safe and won‚Äôt\nput you on any harmful ‚Äúlist.‚Äù Even if it did, you‚Äôd be in good company‚Äîthese\nlists mostly contain great people working tirelessly to defend human rights and\nonline privacy worldwide.</p>\n<p>By using Tor regularly for ordinary browsing, you help strengthen the network,\nmaking it more robust and anonymous for everyone. This collective support makes\nstaying private easier for activists, journalists, and anyone facing online\nsurveillance or censorship. The writer of the PrivacyGuides article mentions\nusing Tor when he needs to access Google Maps to protect his privacy</p>\n<p>So, consider embracing Tor not only for sensitive browsing but also for daily\nroutine tasks. Every user adds valuable noise to the network, helping protect\nprivacy and freedom for all.</p>\n<p><strong>Tor is at risk, and needs our help</strong>. Despite its strength and history, Tor\nisn‚Äôt safe from the same attacks oppressive regimes and misinformed legislators\ndirect at encryption and many other privacy-enhancing\ntechnologies.‚Äì<a href=\"https://www.privacyguides.org/articles/2025/04/30/in-praise-of-tor/#how-to-support-tor\">How to Support Tor</a></p>\n<ul>\n<li><a href=\"https://wiki.nixos.org/wiki/Tor\">Tor on NixOS</a>\n<ul>\n<li>\n<p><a href=\"https://tb-manual.torproject.org/\">Tor Browser User Manual</a></p>\n</li>\n<li>\n<p><a href=\"https://support.torproject.org/faq/staying-anonymous/\">Tor staying-anonymous</a></p>\n</li>\n<li>\n<p><a href=\"https://ssd.eff.org/module/how-to-use-tor\">How to Use Tor</a></p>\n</li>\n<li>\n<p><a href=\"https://torproject.github.io/manual/secure-connections/\">Cool Graphic Showing Secure Connections with Tor</a></p>\n</li>\n</ul>\n</li>\n</ul>\n<h4>Mullvad-Browser</h4>\n<p>Rather than try to tweak a browser into fingerprinting submission, I recommend\nusing either Tor or Mullvad-Browser when fingerprintability is the highest\nissue. Both Tor and Mullvad-Browser were designed specifically for this purpose\nand you likely won‚Äôt get as much out of tweaking another browser.</p>\n<p>Mullvad-Browser is free and open-source and was developed by the Tor Project in\ncollaboration with Mullvad VPN.(Another Firefox Derivative). It is also the top\nrecommended browser from PrivacyGuides.</p>\n<p>It is the Tor Browser without the Tor Network, allowing you to use the privacy\nfeatures Tor created along with a VPN if you so choose.</p>\n<ul>\n<li><a href=\"https://mullvad.net/en/browser\">Mullvad-Browser</a>, is in Nixpkgs as:\n<code>pkgs.mullvad-browser</code></li>\n</ul>\n<h2>LibreWolf</h2>\n<p><strong>LibreWolf</strong> is an open-source fork of Firefox with a strong focus on privacy,\nsecurity, and user freedom. LibreWolf enables always HTTPS, includes\nuBlockOrigin, and only includes privacy focused search engines by default.</p>\n<h3>Metasearch Engines</h3>\n<p><strong>Startpage</strong>: Advertised as the world‚Äôs most private search engine. ‚ÄúStartpage\ndelivers Google search results via their proprietary personal data protection\ntechnology.‚Äù</p>\n<ul>\n<li>\n<p><a href=\"https://www.startpage.com/\">Startpage</a></p>\n</li>\n<li>\n<p>To add Startpage as a search engine, add\n<code>https://www.startpage.com/sp/search?query=%s</code>.</p>\n</li>\n</ul>\n<p><strong>SearXNG</strong> an open-source, privacy-respecting metasearch engine that aggregates\nresults from various search services, such as Google, DuckDuckGo, etc. without\ntracking you or profiling your searches. You can add SearXNG to firefox by going\nto <code>about:preferences#search</code> and at the bottom click <code>Add</code>, URL will be\n<code>https://searx.be/search?q=%s</code>.</p>\n<blockquote>\n<p>‚ùóÔ∏è NOTE: SearXNGs google results are not working as of 11-17-25 and haven‚Äôt\nfor a while now leading to bad results being returned for most instances. It‚Äôs\nmy understanding this is because Google is actively blocking automated\nrequests from SearXNG. Devs sometimes publish patches or workarounds, but\nthese are quickly blocked when Google changes their back-end.</p>\n</blockquote>\n<blockquote>\n<p>‚ùóÔ∏è NOTE: The above searx is the default and doesn‚Äôt give many relevant\nresults. To get relevant results find a\n<a href=\"https://searx.space/\">public instance</a> with a good rating from your area and\nadd the <code>search?q=%s</code> to the end of it. For example, I‚Äôm using\n<code>https://priv.au/search?q=%s</code>.</p>\n</blockquote>\n<p>Searx is a bit different, you can choose which search engine you want for your\ncurrent search with <code>!ddg search term</code> to use duckduckgo for example.</p>\n<p>Example LibreWolf config implementing many of the STIG recommendations:</p>\n<details>\n<summary> ‚úîÔ∏è Click to expand LibreWolf Example </summary>\n<pre><code class=\"language-nix\"># librewolf.nix\n{pkgs, lib, config, ...}: let\n  cfg = config.custom.librewolf;\nin {\n  options.custom.librewolf = {\n    enable = lib.mkOption {\n      type = lib.types.bool;\n      default = true;\n      description = \"Enable the LibreWolf Module\";\n    };\n  };\n\n  config = lib.mkIf cfg.enable {\n    programs.librewolf = {\n      enable = true;\n      policies = {\n        # A bit annoying\n        DontCheckDefaultBrowser = true;\n        # Pocket is insecure according to DoD\n        DisablePocket = true;\n        # No imperative updates\n        DisableAppUpdate = true;\n      };\n      settings = {\n        # // SV-16925 - DTBF030\n        \"security.enable_tls\" = true;\n        # // SV-16925 - DTBF030\n        \"security.tls.version.min\" = 2;\n        # // SV-16925 - DTBF030\n        \"security.tls.version.max\" = 4;\n\n        # // SV-111841 - DTBF210\n        \"privacy.trackingprotection.fingerprinting.enabled\" = true;\n\n        # // V-252881 - Retaining Data Upon Shutdown\n        \"browser.sessionstore.privacy_level\" = 0;\n\n        # // SV-251573 - Customizing the New Tab Page\n        \"browser.newtabpage.activity-stream.enabled\" = false;\n        \"browser.newtabpage.activity-stream.feeds.section.topstories\" = false;\n        \"browser.newtabpage.activity-stream.showSponsored\" = false;\n        \"browser.newtabpage.activity-stream.feeds.snippets\" = false;\n\n        # // V-251580 - Disabling Feedback Reporting\n        \"browser.chrome.toolbar_tips\" = false;\n        \"browser.selfsupport.url\" = \"\";\n        \"extensions.abuseReport.enabled\" = false;\n        \"extensions.abuseReport.url\" = \"\";\n\n        # // V-251558 - Controlling Data Submission\n        \"datareporting.policy.dataSubmissionEnabled\" = false;\n        \"datareporting.healthreport.uploadEnabled\" = false;\n        \"datareporting.policy.firstRunURL\" = \"\";\n        \"datareporting.policy.notifications.firstRunURL\" = \"\";\n        \"datareporting.policy.requiredURL\" = \"\";\n\n        # // V-252909 - Disabling Firefox Studies\n        \"app.shield.optoutstudies.enabled\" = false;\n        \"app.normandy.enabled\" = false;\n        \"app.normandy.api_url\" = \"\";\n\n        # // V-252908 - Disabling Pocket\n        \"extensions.pocket.enabled\" = false;\n\n        # // V-251555 - Preventing Improper Script Execution\n        \"dom.disable_window_flip\" = true;\n\n        # // V-251554 - Restricting Window Movement and Resizing\n        \"dom.disable_window_move_resize\" = true;\n\n        # // V-251551 - Disabling Form Fill Assistance\n        \"browser.formfill.enable\" = false;\n\n        # // V-251550 - Blocking Unauthorized MIME Types\n        \"plugin.disable_full_page_plugin_for_types\" = \"application/pdf,application/fdf,application/xfdf,application/lso,application/lss,application/iqy,application/rqy,application/lsl,application/xlk,application/xls,application/xlt,application/pot,application/pps,application/ppt,application/dos,application/dot,application/wks,application/bat,application/ps,application/eps,application/wch,application/wcm,application/wb1,application/wb3,application/rtf,application/doc,application/mdb,application/mde,application/wbk,application/ad,application/adp\";\n      };\n    };\n    xdg.desktopEntries.librewolf = {\n      name = \"LibreWolf\";\n      exec = \"${pkgs.librewolf}/bin/librewolf\";\n    };\n    xdg.mimeApps = {\n      enable = true;\n      defaultApplications = {\n        \"text/html\" = \"librewolf.desktop\";\n        \"x-scheme-handler/http\" = \"librewolf.desktop\";\n        \"x-scheme-handler/https\" = \"librewolf.desktop\";\n        \"x-scheme-handler/about\" = \"librewolf.desktop\";\n        \"x-scheme-handler/unknown\" = \"librewolf.desktop\";\n      };\n    };\n  };\n}\n</code></pre>\n<p>And enable it in your <code>home.nix</code> or equivalent with:</p>\n<pre><code class=\"language-nix\"># home.nix\ncustom.librewolf.enable = true;\n</code></pre>\n<p>The <code>xdg</code> settings at the end make LibreWolf the defaults for what is listed.</p>\n<p>Thanks to <code>JosefKatic</code> for putting the above STIG settings in NixOS format.</p>\n<p>Also, go to\n<a href=\"https://accounts.firefox.com/settings#data-collection\">accounts.firefox</a> and\nturn off ‚ÄúAllow Mozilla accounts to send technical and interaction data to\nMozilla‚Äù. Also set 2-fa in\n<a href=\"https://accounts.firefox.com/settings#security\">Security Settings</a></p>\n<p>I always set <code>Max Protection</code> for DNS over HTTPS and personally set a custom\nresolver to <code>https://dns.quad9.net/dns-query</code></p>\n<ul>\n<li>Mullvad is also a good option:\n<a href=\"https://mullvad.net/en/help/no-logging-data-policy\">Mullvad no-logging-data-policy</a></li>\n</ul>\n<p>Firefox Relay is a pretty cool privacy tool too, it gives you temporary email\nand phone number aliases so you don‚Äôt have to give out your real ones. There is\nan autofill option available also, but you can just click on the Relay button\nand generate a new alias and use it like your normal email.</p>\n<details>\n<summary> ‚úîÔ∏è Alternative LibreWolf Configuration utilizing Arkenfox </summary>\n<pre><code class=\"language-nix\">{\n  pkgs,\n  lib,\n  config,\n  ...\n}: let\n  cfg = config.custom.librewolf;\nin {\n  options.custom.librewolf = {\n    enable = lib.mkOption {\n      type = lib.types.bool;\n      default = true;\n      description = \"Enable the LibreWolf Module\";\n    };\n  };\n\n  config = lib.mkIf cfg.enable {\n    programs.librewolf = {\n      enable = true;\n      policies = {\n        DontCheckDefaultBrowser = true;\n        DisablePocket = true;\n        DisableAppUpdate = true;\n      };\n      profiles.my-default = {\n        isDefault = true;\n        name = \"Default Profile\";\n        extraConfig = ''\n          ${builtins.readFile ./user.js}\n          \"general.autoScroll\" = true;\n          \"sidebar.verticalTabs\" = true;\n        '';\n\n        settings = {\n        };\n      };\n    };\n    xdg.desktopEntries.librewolf = {\n      name = \"LibreWolf\";\n      exec = \"${pkgs.librewolf}/bin/librewolf\";\n    };\n    xdg.mimeApps = {\n      enable = true;\n      defaultApplications = {\n        \"text/html\" = \"librewolf.desktop\";\n        \"x-scheme-handler/http\" = \"librewolf.desktop\";\n        \"x-scheme-handler/https\" = \"librewolf.desktop\";\n        \"x-scheme-handler/about\" = \"librewolf.desktop\";\n        \"x-scheme-handler/unknown\" = \"librewolf.desktop\";\n      };\n    };\n  };\n}\n</code></pre>\n<p>Download the\n<a href=\"https://github.com/arkenfox/user.js/blob/master/user.js\">Arkenfox user.js</a> and\nreview it making sure that you agree with the settings. If you do, place it in\nthe same directory as your <code>librewolf.nix</code>.</p>\n<p>Read the <a href=\"https://github.com/arkenfox/user.js/wiki\">Arkenfox Wiki</a></p>\n<p>The <code>user.js</code> is full of comments and information, read it and adjust it for\nyour needs. The following enables RFP fingerprint protection:</p>\n<pre><code class=\"language-js\">***/ user.js ***/\nuser_pref(\"privacy.resistFingerprinting\", true); // [FF41+]\nuser_pref(\"privacy.resistFingerprinting.pbmode\", true); // [FF114+]\n</code></pre>\n<p>As you learn more, you can get more strict if you so choose.</p>\n<p>Rebuild, launch LibreWolf, and check your <code>~/.librewolf/my-default/user.js</code>. It\nshould match the Arkenfox settings. Initially, only the <code>user.js</code> will be\nlisted, as you run LibreWolf other profile files and folders are created\ndynamically.</p>\n<p>In LibreWolf type <code>Ctrl + Shift + J</code> and look for any errors.</p>\n<p>Type <code>about:config</code> into the address bar and search a few of the settings that\nArkenfox changes, do they match?</p>\n<p>The <code>user.js</code> is read <strong>in order</strong>, if there are 2 of the same setting, the last\none will be applied. Adding overrides to the settings attribute above places the\nchanges at the <strong>beginning</strong> of the <code>user.js</code> which isn‚Äôt what we want. Placing\nthem after the <code>${builtins.readFile ./user.js}</code> in <code>extraConfig</code> amends them to\nthe <strong>end</strong> of the <code>user.js</code> allowing us to override the defaults.</p>\n<p>The process is the same with Firefox but since Arkenfox strongly recommends\nUblock Origin and it is built into LibreWolf it makes sense to use the browser\nwith the stronger defaults.</p>\n<blockquote>\n<p>‚ùó NOTE: There is a home-manager module called <code>arkenfox-nixos</code> that is\nsupposed to make updates easier but IMO the documentation leaves you guessing\nhow to use it. As updates come in to Firefox/LibreWolf some of the settings\nbecome unnecessary so it‚Äôs important to keep an eye on both Firefox and\nArkenfox updates. Which both have RSS feeds that will alert you upon changes.</p>\n</blockquote>\n<p>I personally use <a href=\"https://feeder.co/\">Feeder</a> as my open-source RSS feed reader,\navailable in most app stores including F-Droid. It is listed on\n<a href=\"https://www.privacytools.io/privacy-rss-feed-readers\">PrivacyTools</a>.</p>\n<ul>\n<li>\n<p><a href=\"https://github.com/arkenfox/user.js/commits/master.atom\">Arkenfox Recent Commits RSS feed</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/arkenfox/user.js/releases.atom\">Arkenfox Release Notes RSS</a></p>\n</li>\n<li>\n<p><a href=\"https://www.mozilla.org/en-US/firefox/nightly/notes/feed/\">Firefox Nightly release notes</a></p>\n</li>\n</ul>\n</details>\n</details>\n<h3>Fingerprint Testing</h3>\n<p>You can test your browser to see how well you are protected from tracking and\nfingerprinting at <a href=\"https://coveryourtracks.eff.org/\">Cover Your Tracks</a>.</p>\n<p>Also check out, <a href=\"https://amiunique.org/fingerprint\">Am I Unique</a></p>\n<blockquote>\n<p>‚ö†Ô∏è WARNING: Don‚Äôt put too much weight into the results as people often check\ntheir fingerprint, change one metric and check it again over and over skewing\nthe results. It is helpful for knowing the fingerprint values that trackers\ntrack.</p>\n</blockquote>\n<ul>\n<li>\n<p><a href=\"https://forum.torproject.org/t/browser-fingerprinting/1228/25\">Browser Fingerprinting Tor Forum</a></p>\n</li>\n<li>\n<p><a href=\"https://madaidans-insecurities.github.io/browser-tracking.html\">Madaidans Hot Take on Browser Tracking</a></p>\n</li>\n</ul>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Script to wipe cache and generate new `machine-id` </summary>\n<ul>\n<li>\n<p><a href=\"https://www.man7.org/linux/man-pages/man5/machine-id.5.html\">man page machine-id(5)</a></p>\n</li>\n<li>\n<p>The following example is adapted from\n<a href=\"https://firejail.wordpress.com/all-about-tor/\">Firejail All About Tor</a>\nsection, adapted for NixOS.</p>\n</li>\n</ul>\n<p>Save the following script as <code>cleanup.sh</code>, change <code>Your-User</code> to your username:</p>\n<pre><code class=\"language-bash\">#!/bin/sh -e\nUSER=\"Your-User\"\nHOME_DIR=\"/home/$USER\"\n# clear user cache directly as root\nsudo -u \"$USER\" rm -fr \"$HOME_DIR/.cache\"\n# generate a new machine-id\nrm -f /var/lib/machine-id\ndbus-uuidgen &gt; /var/lib/machine-id\ncp /var/lib/machine-id /etc/machine-id\nchmod 444 /etc/machine-id\nexit 0\n</code></pre>\n<p>The <code>~/.cache</code> directory is where most programs store runtime information:\nwebpages you visited, torrent trackers you connected to, and deleted emails.\nIt‚Äôs a good idea to remove them at shutdown. ‚ÄìFirejail all-about-tor</p>\n<p>Check <code>/etc/machine-id</code> &amp; <code>~/.cache</code> before running the script:</p>\n<pre><code class=\"language-bash\">cat /etc/machine-id\n# Output\n0b46feb27a20469da0ee62baaeb51c5c\nls ~/.cache\n</code></pre>\n<pre><code class=\"language-bash\">chmod +x cleanup.sh\nsudo ./cleanup.sh\n</code></pre>\n<p>Recheck your <code>machine-id</code> and <code>~/.cache</code> directories, you should have a newly\ngenerated <code>machine-id</code> and minimal files in the <code>~/.cache</code> directory. The\nFirejail example shows a systemd unit that runs the above script at every\nshutdown but that may be overkill, I suggest running it occasionally to make it\nharder for sites to link your <code>machine-id</code> to you.</p>\n</details>\n<p>Privacy protection doesn‚Äôt need to be perfect to make a difference. The best\nprotection against tracking and fingerprinting available is to use Tor. Many\nadd-ons are redundant, do some research and avoid using an add-on for something\nthat can be accomplished with built-in settings.</p>\n<ul>\n<li><a href=\"https://ssd.eff.org/module/how-to-use-tor\">Surveillance Self-Defense How to: Use Tor</a></li>\n</ul>\n<p>There are more hardening parameters that can be set but this should be a good\nstarting point for a hardened version of LibreWolf. When testing with Cover your\ntracks, customized LibreWolf tested as having stronger tracking protection than\ndefault Mullvad-Browser and NoScript significantly cuts down the data available\nfor fingerprinting by disabling JavaScript.</p>\n<ul>\n<li>The <a href=\"https://wiki.garudalinux.org/en/privacy-guide\">Garuda Privacy-Guide</a> has\ngood tips and recommendations for browser add-ons.</li>\n</ul>\n<h3>Virtual Private Networks (VPNs)</h3>\n<p>A <strong>VPN</strong> (Virtual Private Network) encrypts your Internet connection and routes\nyour traffic through a VPN provider‚Äôs servers, masking your IP address from\nlocal network observers, ISPs, and websites. Using a VPN can prevent your ISP or\nlocal Wi-Fi owner from tracking what sites you visit (they only see a connection\nto the VPN), and can help circumvent some regional restrictions or filtering.</p>\n<p>However, VPNs simply shift your trust: Instead of your ISP seeing your activity,\nyour VPN provider can, so you must trust their privacy policies and\ninfrastructure. Quality and privacy protections vary widely from one VPN company\nto another.</p>\n<p>I see over and over again that Mullvad VPN is the best, I am in no way\naffiliated with them this is just what I hear. They allow you to pay with cash\ncompletely anonymously and keep very minimal metadata. Metadata is a big deal,\nthe US gov has admitted to killing people based solely on their metadata.</p>\n<p>Your ISP almost certainly does sketchy stuff with your data, personally I would\nrather trust a company like Mullvad whose whole reputation is based on their\ntrustworthiness, transparency, and data protection.</p>\n<p>You can use a VPN with Tor, but it‚Äôs not recommended by the Tor Project unless\nyou‚Äôre an advanced user who knows how to configure both in a way that doesn‚Äôt\ncompromise your privacy.</p>\n<p><strong>Popular VPNs on NixOS</strong></p>\n<ul>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Mullvad_VPN\">Mullvad VPN</a> Mullvad VPN uses\nWireGuard under the hood and only works if <code>systemd-resolvd</code> is enabled.</p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/WireGuard\">WireGuard VPN</a>, WireGuard is a\nprotocol, but also a VPN provider on NixOS.</p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Tailscale\">Tailscale</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/OpenVPN\">OpenVPN</a>, OpenVPN is both a protocol and\nfull-featured VPN provider on NixOS.</p>\n</li>\n</ul>\n<h3>Setting up Tailscale</h3>\n<p>I was surprised at how easy this actually was to set up. Either go to\n<a href=\"https://www.tailscale.com\">https://www.tailscale.com</a> and/or download the app for either Android or IOS,\nsign up with your identity provider, and click <code>Start connecting devices -&gt;</code></p>\n<ul>\n<li><a href=\"https://tailscale.com/kb/1017/install\">Tailscale quickstart</a></li>\n</ul>\n<p>To add tailscale to NixOS:</p>\n<pre><code class=\"language-nix\"># tailscale.nix\n{...}: {\n  services.tailscale.enable = true;\n  # Tell the firewall to implicitly trust packets routed over Tailscale:\n  networking.firewall.trustedInterfaces = [\"tailscale0\"];\n}\n</code></pre>\n<p>Tailscale will automatically use the hostname of your device as the name of the\nnetwork. If you want to change it to something else:</p>\n<pre><code class=\"language-bash\">sudo tailscale set --hostname=&lt;name&gt;\n# You can also give your account a nickname\nsudo tailscale set --nickname=&lt;name&gt;\n</code></pre>\n<p>This allows you to refer to your network by <code>name</code> rather than IP address.</p>\n<p>Tailscale uses <a href=\"https://tailscale.com/kb/1081/magicdns\">MagicDNS</a> which is\nenabled by default, and they recommend you keep it enabled.</p>\n<p>The docs say that by default, devices in your tailnet prefer their local DNS\nsettings and only use the tailnet‚Äôs DNS servers when needed. I had to completely\ndisable my Androids DNS settings for tailscale to access the internet through\nMagicDNS.</p>\n<pre><code class=\"language-bash\">sudo tailscale set --accept-dns=false\n</code></pre>\n<p>To connect to tailscale after rebuilding you can run:</p>\n<pre><code class=\"language-bash\">sudo tailscale up\n</code></pre>\n<p>Use <code>nslookup</code> to review and debug DNS responses:</p>\n<pre><code class=\"language-bash\">nslookup google.com\nServer:         127.0.0.1\nAddress:        127.0.0.1#53\n\nNon-authoritative answer:\nName:   google.com\nAddress: 142.251.40.206\nName:   google.com\nAddress: 2a00:1450:4001:827::200e\n</code></pre>\n<ul>\n<li>The <code>127.0.0.1#53</code> indicate that instead of using the DNS server pushed by\nyour ISP, router, or Tailscale‚Äôs MagicDNS, the system is sending all DNS\nrequests through the loopback device to <code>dnscrypt-proxy</code> in my case.</li>\n</ul>\n<p>Get the status of your connections to other Tailscale devices:</p>\n<pre><code class=\"language-bash\">tailscale status\n1           2         3           4         5\n100.1.2.3   device-a  apenwarr@   linux     active; direct &lt;ip-port&gt;, tx 1116 rx 1124\n100.4.5.6   device-b  crawshaw@   macOS     active; relay &lt;relay-server&gt;, tx 1351 rx 4262\n100.7.8.9   device-c  danderson@  windows   idle; tx 1214 rx 50\n100.0.1.2   device-d  ross@       iOS       ‚Äî\n</code></pre>\n<ul>\n<li>\n<p><a href=\"https://tailscale.com/kb/1196/security-hardening\">Tailscale Best Practices</a></p>\n</li>\n<li>\n<p><a href=\"https://tailscale.com/kb/1080/cli\">Tailscale CLI</a></p>\n</li>\n<li>\n<p>There is much more you can do with Tailscale, including integrating\nMullvad-VPN and using Exit Nodes.</p>\n</li>\n</ul>\n<h2>Encrypted DNS</h2>\n<p>DNS (Domain Name System) resolution is the process of translating a website‚Äôs\ndomain name into its corresponding IP address. By default, this traffic isn‚Äôt\nencrypted, which means anyone on the network, from your ISP to potential\nhackers, can see the websites you‚Äôre trying to visit. <strong>Encrypted DNS</strong> uses\nprotocols to scramble this information, protecting your queries and responses\nfrom being intercepted and viewed by others.</p>\n<blockquote>\n<p>‚ùó NOTE: There are many other ways for someone monitoring your traffic to see\nwhat domain you looked up via DNS that it‚Äôs effectiveness is questionable\nwithout also using Tor or a VPN. Encrypted DNS will not help you hide any of\nyour browsing activity.</p>\n</blockquote>\n<p>There are 3 main types of DNS protection:</p>\n<ul>\n<li>\n<p><strong>DNS over HTTPS (DoH)</strong>: Uses the HTTPS protocol to encrypt data between the\nclient and the resolver.</p>\n</li>\n<li>\n<p><strong>DNS over TLS (DoT)</strong>: Similar to (DoH), differs in the methods used for\nencryption and delivery using a separate port from HTTPS.</p>\n</li>\n<li>\n<p><strong>DNSCrypt</strong>: Uses end-to-end encryption with the added benefit of being able\nto prevent DNS spoofing attacks.</p>\n</li>\n</ul>\n<p>Useful resources:</p>\n<details>\n<summary> ‚úîÔ∏è Click to Expand DNS Resources </summary>\n<ul>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Encrypted_DNS\">NixOS Wiki Encrypted DNS</a></p>\n</li>\n<li>\n<p><a href=\"https://www.cloudflare.com/learning/dns/what-is-dns/\">Domain Name System (DNS)</a></p>\n</li>\n<li>\n<p><a href=\"https://en.wikipedia.org/wiki/DNS_over_HTTPS\">Wikipedia DNS over HTTPS (DoH)</a></p>\n</li>\n<li>\n<p><a href=\"https://en.wikipedia.org/wiki/DNS_over_TLS\">Wikipedia DNS over TLS (DoT)</a></p>\n</li>\n<li>\n<p><a href=\"https://blog.cloudflare.com/dns-encryption-explained/\">Cloudflare Dns Encryption Explained</a></p>\n</li>\n<li>\n<p><a href=\"https://nordvpn.com/blog/encrypted-dns-traffic/\">NordVPN Encrypted Dns Traffic</a></p>\n</li>\n</ul>\n<p><strong>Hot Take</strong>:</p>\n<ul>\n<li><a href=\"https://madaidans-insecurities.github.io/encrypted-dns.html\">Encrypted DNS is ineffective without a VPN or Tor by madaidan</a></li>\n</ul>\n</details>\n<p>The following sets up dnscrypt-proxy using DoH (DNS over HTTPS) with an oisd\nblocklist, they both come directly from the Wiki:</p>\n<p>Add <code>oisd</code> to your flake inputs:</p>\n<pre><code class=\"language-nix\"># flake.nix\ninputs = {\n    oisd = {\n      url = \"https://big.oisd.nl/domainswild\";\n      flake = false;\n    };\n};\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: The <code>oisd</code> blocklist is a plain text file that updates frequently.\nThis can cause <code>nh os switch</code> to fail with a <code>NarHash</code> mismatch error. To fix\nthis, you need to run <code>nix flake update</code> to refresh the blocklist and its hash\nin your <code>flake.lock</code> file. After that, you can run your <code>nh</code> command again.</p>\n</blockquote>\n<p>And the import the following into your <code>configuration.nix</code>:</p>\n<pre><code class=\"language-nix\"># dnscrypt-proxy.nix\n{\n  pkgs,\n  lib,\n  inputs,\n  ...\n}: let\n  blocklist_base = builtins.readFile inputs.oisd;\n  extraBlocklist = '''';\n  blocklist_txt = pkgs.writeText \"blocklist.txt\" ''\n    ${extraBlocklist}\n    ${blocklist_base}\n  '';\n  hasIPv6Internet = true;\n  StateDirectory = \"dnscrypt-proxy\";\nin {\n  networking = {\n    # Set DNS nameservers to the local host addresses for iPv4 (`127.0.0.1`) &amp; iPv6 (::1)\n    nameservers = [\"127.0.0.1\" \"::1\"];\n    # If using dhcpcd\n    # dhcpcd.extraConfig = \"nohook resolv.conf\";\n    # If using NetworkManager\n    networkmanager.dns = \"none\";\n  };\n  services.resolved.enable = lib.mkForce false;\n  # See https://wiki.nixos.org/wiki/Encrypted_DNS\n  services.dnscrypt-proxy2 = {\n    enable = true;\n    # See https://github.com/DNSCrypt/dnscrypt-proxy/blob/master/dnscrypt-proxy/example-dnscrypt-proxy.toml\n    settings = {\n      # See https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md\n      sources.public-resolvers = {\n        urls = [\n          \"https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/public-resolvers.md\"\n          \"https://download.dnscrypt.info/resolvers-list/v3/public-resolvers.md\"\n        ];\n        minisign_key = \"RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3\";\n        cache_file = \"/var/lib/${StateDirectory}/public-resolvers.md\";\n      };\n     # sources.quad9-resolvers = {\n     #   urls = [\n     #     \"https://quad9.net/dnscrypt/quad9-resolvers.md\"\n     #     \"https://raw.githubusercontent.com/Quad9DNS/dnscrypt-settings/main/dnscrypt/quad9-resolvers.md\"\n     #   ];\n     #   minisign_key = \"RWTp2E4t64BrL651lEiDLNon+DqzPG4jhZ97pfdNkcq1VDdocLKvl5FW\";\n     #   cache_file = \"/var/cache/dnscrypt-proxy/quad9-resolvers.md\";\n     # };\n\n      # Use servers reachable over IPv6 -- Do not enable if you don't have IPv6 connectivity\n      ipv6_servers = hasIPv6Internet;\n      block_ipv6 = ! hasIPv6Internet;\n      blocked_names.blocked_names_file = blocklist_txt;\n      require_dnssec = true;\n      # Logs can get large very quickly...\n      require_nolog = false;\n      # This stops dns malware filtering, etc. if true\n      require_nofilter = false;\n      dnscrypt_servers = true;\n\n      # If you want, choose a specific set of servers that come from your sources.\n      # Here it's from https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md\n      # If you don't specify any, dnscrypt-proxy will automatically rank servers\n      # that match your criteria and choose the best one.\n      # server_names = [ ... ];\n      # server_names = ['quad9-dnscrypt-ip6-filter-pri', 'quad9-dnscrypt-ip4-filter-pri', 'mullvad-adblock-d'];\n\n    };\n  };\n\n  systemd.services.dnscrypt-proxy2.serviceConfig.StateDirectory = StateDirectory;\n}\n</code></pre>\n<blockquote>\n<p>‚ùóÔ∏è NOTE: Upon testing dnscrypt-proxy on Arch, it was able to route the browser\nthrough the proxy, removing the need for Max Protection. I‚Äôm still currently\non Arch and plan to test this further ASAP. We test the above settings further\ndown, but I‚Äôm curious why the browser isn‚Äôt routed correctly‚Ä¶</p>\n</blockquote>\n<ul>\n<li>Above, we have a local DNS proxy that encrypts and forwards queries.</li>\n</ul>\n<pre><code class=\"language-bash\"># You should see that dnscrypt-proxy chooses the Server with the lowest initial latency\nsudo systemctl status dnscrypt-proxy2\n# verify that dnscrypt-proxy is listening\nsudo ss -lnp | grep 53\n# Test a DNS query, if you get valid responses it's working\ndig @127.0.0.1 example.com +short\n# check the logs\nsudo journalctl -u dnscrypt-proxy2\n</code></pre>\n<p><code>dnscrypt-proxy2</code> acts as your local DNS resolver listening on your machine\n(<code>127.0.0.1</code>) for IPv4 and <code>::1</code> for iPv6.</p>\n<p>The system‚Äôs DNS settings (<code>networking.nameservers</code>) point to localhost, so\n<strong>all DNS queries</strong> go to dnscrypt-proxy accept for your browser. Your browser\nhas to be configured separately with a local resolver in which I haven‚Äôt figured\nout yet. I recommend setting your browsers DNS over HTTPS to strict with a\nrespected custom DNS resolver such as <code>https://dns.quad9.net/dns-query</code>.</p>\n<p><code>inputs.oisd</code> refers to the flake input oisd blocklist, it prevents your device\nfrom connecting to unwanted or harmful domains.</p>\n<p><code>dnscrypt-proxy2</code> then encrypts and forwards our DNS requests to third-party\npublic DNSCrypt or DoH servers.</p>\n<h2>MAC Randomization</h2>\n<p>All network cards have a unique identifier called a MAC address. They‚Äôre stored\nin hardware and are used to assign an address to computers on the local network.</p>\n<p>The MAC address is typically only traceable on the local network, it‚Äôs not\npassively sent out beyond the local router making it more critical on untrusted,\npublic networks.</p>\n<p>Leak-proof MAC randomization is very difficult to implement:</p>\n<ul>\n<li><a href=\"https://www.kicksecure.com/wiki/Dev/MAC#Leak-proof_MAC_Randomization_-_Technical_Implementation_Challenges\">Leak-proof MAC Randomization Implementation Challenges</a></li>\n</ul>\n<p>Android and iPhone already implement MAC Randomization by default.</p>\n<p>MAC Randomization enhances privacy by making it harder for third parties to\ntrack users across different networks.</p>\n<p>Randomizing MAC adresses obscures a device‚Äôs unique hardware identity when\nscanning for or connecting to Wi-Fi, blocking passive tracking as well as\nlocation tracking across networks.</p>\n<p>If you use NetworkManager you can set MAC randomization with:</p>\n<pre><code class=\"language-nix\">    networking = {\n      networkmanager = {\n        enable = true;\n        wifi.scanRandMacAddress = true;\n        wifi.macAddress = \"random\";\n        plugins = [];\n      };\n</code></pre>\n<p>Right when I rebuilt, I got an alert from my router saying that a new device\njust connected to the network.</p>\n<p>There is also a utility for viewing/manipulating the MAC address of network\ninterfaces, <code>pkgs.macchanger</code>. This is less reliable than the NetworkManager\nsetting.</p>\n<h2>Firewalls</h2>\n<p>NixOS includes an integrated firewall based on iptables/nftables.</p>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Firewall Resources </summary>\n<p><a href=\"https://www.cloudflare.com/learning/security/what-is-a-firewall/\">Cloudflare What is a Firewall</a></p>\n<p><a href=\"https://linux-audit.com/networking/nftables/nftables-beginners-guide-to-traffic-filtering/\">Beginners guide to nftables</a></p>\n<p><a href=\"https://wiki.archlinux.org/title/Nftables\">Arch Wiki nftables</a></p>\n</details>\n<p>The following firewall setup is based on the dnscrypt setup above utilizing\nnftables.</p>\n<p>This nftables firewall configuration is a strong recommended practice for\nenforcing encrypted DNS on your system by restricting all outbound DNS traffic\nto a local dnscrypt-proxy process. It greatly reduces DNS leak risks and\nenforces privacy by limiting DNS queries to trusted, encrypted upstream\nservers.(This was edited on 08-08-25) replace <code>&lt;DNSCRYPT-UID&gt;</code> with the UID\ngiven from the command <code>ps -o uid,user,pid,cmd -C dnscrypt-proxy</code>:</p>\n<pre><code class=\"language-nix\">{ ... }: {\n  networking.nftables = {\n    enable = true;\n\n    ruleset = ''\n      table inet filter {\n        chain output {\n          type filter hook output priority 0; policy accept;\n\n          # Allow localhost DNS for dnscrypt-proxy2\n          ip daddr 127.0.0.1 udp dport 53 accept\n          ip6 daddr ::1 udp dport 53 accept\n          ip daddr 127.0.0.1 tcp dport 53 accept\n          ip6 daddr ::1 tcp dport 53 accept\n\n          # Allow dnscrypt-proxy2 to talk to upstream servers\n          # Replace &lt;DNSCRYPT-UID&gt; with:\n          # ps -o uid,user,pid,cmd -C dnscrypt-proxy\n          meta skuid &lt;DNSCRYPT-UID&gt; udp dport { 443, 853 } accept\n          meta skuid &lt;DNSCRYPT-UID&gt; tcp dport { 443, 853 } accept\n\n          # Block all other outbound DNS\n          udp dport { 53, 853 } drop\n          tcp dport { 53, 853 } drop\n        }\n      }\n    '';\n  };\n  networking.firewall = {\n    enable = true;\n    allowedTCPPorts = [\n      # Ports open for inbound connections.\n      # Limit these to reduce the attack surface.\n\n      22 # SSH ‚Äì Keep open only if you need remote access.\n         # To change the SSH port in NixOS:\n         # services.openssh.ports = [ 2222 ];\n         # Update this list to match the new port.\n\n      # 53  # DNS ‚Äì Only if running a public DNS server.\n      # 80  # HTTP ‚Äì Only if hosting a website.\n      # 443 # HTTPS ‚Äì Only if hosting a secure website.\n    ];\n    allowedUDPPorts = [\n      # Ports open for inbound UDP traffic.\n      # Most NixOS workstations won't need any here.\n\n      # 53 # DNS ‚Äì Only if running a public DNS server.\n    ];\n  };\n}\n</code></pre>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Tip on changing the default SSH Port </summary>\n<blockquote>\n<p>‚ùó TIP: Reduce SSH noise by changing the default port On most systems, SSH\nlistens on TCP port 22 ‚Äî which means automated bots and scanners will hit it\nconstantly. While this doesn‚Äôt replace real security measures, moving SSH to a\ndifferent port drastically cuts down on drive-by brute-force attempts you‚Äôll\nsee in your logs.</p>\n<p>In NixOS, change both the SSH daemon port and your firewall rule:</p>\n<pre><code class=\"language-nix\"> # Example: Move SSH to port 2222\n networking.firewall.allowedTCPPorts = [ 2222 ];\n services.openssh.ports = [ 2222 ];\n</code></pre>\n<ul>\n<li>After rebuilding, test from another terminal/session before closing your\nexisting one:</li>\n</ul>\n<pre><code class=\"language-bash\">ssh -p 2222 user@host\n</code></pre>\n</blockquote>\n</details>\n<p><code>nft</code> is a cli tool used to set up, maintain and inspect packet filtering and\nclassification rules in the Linux kernel, in the nftables framework. The Linux\nkernel subsystem is known as nftables, and ‚Äònf‚Äô stands for Netfilter.‚Äì<code>man nft</code></p>\n<pre><code class=\"language-bash\">sudo nft list ruleset\n</code></pre>\n<ul>\n<li>Since we declare our firewall, we‚Äôll only use <code>nft</code> to inspect our ruleset.</li>\n</ul>\n<h2>NixOS Firewall vs <code>nftables</code> Ruleset</h2>\n<p><code>networking.nftables</code>: This section provides a raw <code>nftables</code> ruleset that gives\nyou granular, low-level control. The rules here are more specific and are meant\nto handle the intricate logic of the DNS proxy setup. They will be applied\ndirectly to the kernel‚Äôs <code>nftables</code> subsystem and prevent DNS leaks.</p>\n<p><code>networking.firewall</code>: This is a higher-level, simpler NixOS option that uses\n<code>iptables</code> rules to open ports for inbound traffic. The rules defined here\n(allowing port 22) is for incoming SSH connections to the machine, not for\noutbound traffic, so they do not interfere with the <code>nftables</code> rules that filter\nthe outgoing traffic. (Make sure to comment out or remove this if you don‚Äôt SSH\ninto your machine).</p>\n<p>The firewall ensures only authorized, local encrypted DNS proxy process can\nspeak DNS with the outside world, and that all other DNS requests from any other\nprocess are blocked unless they‚Äôre to <code>127.0.0.1</code> (our local proxy). This is a\nrobust policy against both DNS leaks and local compromise.</p>\n<h2>Testing</h2>\n<p>Review listening ports: After each rebuild, use <code>ss -tlpn</code>, <code>nmap</code> or <code>netstat</code>\nto see which services are accepting connections. Close or firewall anything\nunnecessary.</p>\n<p>You can also test firewall DNS restrictions using <code>dig</code>:</p>\n<pre><code class=\"language-bash\">dig @127.0.0.1 example.com  # Should work\n\ndig @8.8.8.8 example.com    # Should fail/time out for normal users\n</code></pre>\n<ul>\n<li>This test is actually what alerted me of an improper configuration in the\nabove firewalls nftables rules allowing me to fix it. Initially the second\n<code>dig</code> command gave results letting me know that the restrictions weren‚Äôt being\napplied correctly.</li>\n</ul>\n<p>Since we defined an <code>output</code> chain inside <code>table inet filter</code> with the line:</p>\n<pre><code class=\"language-bash\">type filter hook output priority 0; policy accept;\n</code></pre>\n<p>This attaches the chain to the kernel‚Äôs OUTPUT hook, so all locally generated\npackets, including DNS queries are filtered by this chain.</p>\n<p>Within this chain, the rules:</p>\n<ul>\n<li>\n<p>Explicitly allow DNS queries to localhost addresses (<code>127.0.0.1</code> and <code>::1</code>).</p>\n</li>\n<li>\n<p>Allow the <code>dnscrypt-proxy</code> process (running with UID <code>62396</code>) to send DNS\nqueries on ports 443 and 853 (for DNS-over-HTTPS and DNS-over-TLS).</p>\n</li>\n<li>\n<p>Drop all other outbound DNS traffic on ports <code>53</code> and <code>853</code>.</p>\n</li>\n</ul>\n<p>Because of this setup, dig queries to your local resolver at <code>127.0.0.1</code> pass,\nbut queries directly to public DNS servers like <code>8.8.8.8</code> are blocked for\nusers/processes other than the allowed DNS proxy.</p>\n<h2>OpenSnitch</h2>\n<ul>\n<li><a href=\"https://wiki.nixos.org/wiki/OpenSnitch\">NixOS Wiki OpenSnitch</a></li>\n</ul>\n<p><a href=\"https://github.com/evilsocket/opensnitch\">Opensnitch</a> is an open-source\napplication firewall that focuses on monitoring and controlling outgoing network\nconnections on a per-application basis.</p>\n<p>This can be used to block apps from accessing the internet that shouldn‚Äôt need\nto (i.e., block telemetry and more). Opensnitch will report that the app has\nattempted to make an outbound internet connection and block it or allow it based\non the rules you set.</p>\n<h3>Resources</h3>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Resources </summary>\n<ul>\n<li>\n<p><a href=\"https://cloudflare.com/learning/ssl/what-is-https\">Cloudflare What is HTTPS</a></p>\n</li>\n<li>\n<p><a href=\"https://ssd.eff.org/\">Surveillance Self-Defence</a> has a lot of helpful info to\nprotect your privacy.</p>\n</li>\n<li>\n<p><a href=\"https://ssd.eff.org/module/what-fingerprinting\">What is Fingerprinting</a>, more\nthan you realize is being tracked constantly.</p>\n</li>\n<li>\n<p><a href=\"https://oisd.nl/\">oisd.nl</a> the oisd website</p>\n</li>\n<li>\n<p>For potentially dangerous file types like PDFs, office documents, or images,\nespecially those downloaded from untrusted sources such as torrents, consider\nconverting them to a safe PDF format with\n<a href=\"https://github.com/freedomofpress/dangerzone\">dangerzone</a>. Dangerzone not\nonly removes metadata but also applies robust sanitization to neutralize\nmalicious content.</p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Librewolf\">NixOS Wiki LibreWolf</a>, the options in\nthe wiki make it less secure and aren‚Äôt recommended settings to use. They\nexplicitly disable several of LibreWolf‚Äôs default privacy-enhancing features,\nsuch as fingerprinting resistance and clearing session data on shutdown.</p>\n</li>\n<li>\n<p><a href=\"https://librewolf.net/docs/features/\">LibreWolf Features</a> You still need to\nenable DNS over HTTPS through privacy settings.</p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/SearXNG\">SearXNG on NixOS</a></p>\n<ul>\n<li><a href=\"https://docs.searxng.org/\">Welcome to SearXNG</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://brainfucksec.github.io/firefox-hardening-guide\">Firefox Hardening Guide</a></p>\n</li>\n<li>\n<p><a href=\"https://www.ghacks.net/2015/08/18/a-comprehensive-list-of-firefox-privacy-and-security-settings/\">Firefox ghacks</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/arkenfox/user.js\">Arkenfox</a></p>\n</li>\n<li>\n<p><a href=\"https://www.privacytools.io/private-browser\">PrivacyTools.io</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/simeononsecurity/FireFox-Privacy-Script\">simeononsecurity Firefox-Privacy-Script</a></p>\n</li>\n<li>\n<p><a href=\"https://brainfucksec.github.io/firefox-hardening-guide\">brianfucksec firefox-hardening-Guide 2023</a></p>\n</li>\n<li>\n<p><a href=\"https://simeononsecurity.com/guides/enhance-firefox-security-configuring-guide/\">STIG Firefox Hardening</a></p>\n</li>\n</ul>\n<blockquote>\n<p>If you should trust the U.S. Governments recommendations is another story but\nit can be good to compare and contrast with other trusted resources. You‚Äôll\nhave to think whether the CISA recommending that everyone uses Signal is solid\nadvice or guiding you towards a honeypot, I can‚Äôt say for sure.</p>\n</blockquote>\n<ul>\n<li>\n<p><a href=\"https://stigviewer.com/stigs/mozilla_firefox\">Mozilla Firefox Security Technical Implementation Guide</a>\nThe STIG for Mozilla Firefox (Security Technical Implementation Guide) is a\nset of security configuration standards developed by the U.S. Department of\nDefense. They are created by the Defense Information Systems Agency (DISA) to\nsecure and harden DoD information systems and software.</p>\n</li>\n<li>\n<p><a href=\"https://thenewoil.org/en/guides/prologue/why/\">Privacy, The New Oil (Why Privacy &amp; Security Matter)</a></p>\n</li>\n<li>\n<p><a href=\"https://www.privacyguides.org/en/\">PrivacyGuides</a></p>\n</li>\n<li>\n<p><a href=\"https://relay.firefox.com/accounts/profile/\">Firefox Relay</a> can be used to\ncreate email aliases that forward to your real email address. The paid plan\nalso lets you create phone number aliases that forward to your phone number.</p>\n</li>\n<li>\n<p><a href=\"https://zebracrossing.narwhalacademy.org/\">Zebra Crossing digital safety checklist</a></p>\n</li>\n<li>\n<p><a href=\"https://datadetoxkit.org/en/privacy/essentials#step-1\">DataDetoxKit</a></p>\n</li>\n<li>\n<p><a href=\"https://datadetoxkit.org/en/privacy/degooglise/\">DataDetox Degooglise</a></p>\n</li>\n<li>\n<p><a href=\"https://tb-manual.torproject.org/\">Tor Browser User Manual</a></p>\n</li>\n<li>\n<p><a href=\"https://gitlab.torproject.org/tpo/team/-/wikis/home\">Tor Wiki</a></p>\n</li>\n<li>\n<p><a href=\"https://tldp.org/LDP/nag2/x-087-2-intro.html\">Linux Network Administrators Guide</a></p>\n</li>\n</ul>\n</details>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/kvm.html",
      "url": "https://saylesss88.github.io/nix/kvm.html",
      "title": "KVM",
      "content_html": "<h1>Running NixOS in a VM with Maximum Isolation (Beginner Guide)</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p><img src=\"images/steampunk5.cleaned.png\" alt=\"sp5\" /></p>\n<h2>Why This Setup?</h2>\n<ul>\n<li>\n<p><strong>Host</strong> <code>secureblue</code> = Fedora Atomic with <strong>SELinux enforcing</strong>, <strong>sVirt</strong>,\n<strong>Secure Boot</strong>, and hardened defaults.</p>\n</li>\n<li>\n<p><strong>Guest</strong>: NixOS in a VM ‚Üí full declarative power, near zero risk to host.</p>\n</li>\n<li>\n<p><strong>Isolation</strong>: Mandatory Access Control (MAC) via SELinux + KVM + no direct\nhardware access.</p>\n</li>\n</ul>\n<hr />\n<h3>üîë Key Terms</h3>\n<blockquote>\n<p>NOTE: Secureblue enables the <code>hardened_malloc</code> by default which causes\nproblems for many browsers and will cause screen flashing with Firefox and\nothers within the VM. See:</p>\n</blockquote>\n<ul>\n<li><a href=\"https://secureblue.dev/faq#standard-malloc\">secureblue standard_malloc</a></li>\n</ul>\n<h2>Step 1: Install secureblue (Hardened Host)</h2>\n<ol>\n<li>\n<p>Download a <a href=\"https://secureblue.dev/install\">secureblue image</a></p>\n</li>\n<li>\n<p>Use <strong>Fedora Media Writer</strong> (Flatpak):</p>\n</li>\n</ol>\n<pre><code class=\"language-bash\">flatpak install flathub org.fedoraproject.MediaWriter\n</code></pre>\n<ol start=\"3\">\n<li>\n<p>Flash the secureblue image &amp; enable Secure Boot in UEFI <strong>before</strong> install.\nThis is now possible with Fedora, when you boot into Fedora Media Writer (not\nVentoy or Rufus), you will be allowed to enroll the secure boot key with\nsecure boot pre-enabled.</p>\n</li>\n<li>\n<p>On first boot:</p>\n</li>\n</ol>\n<pre><code class=\"language-bash\">ujust enroll-secureblue-secure-boot-key\n</code></pre>\n<ul>\n<li>Reboot -&gt; Enroll key in MOK manager with password: <code>secureblue</code></li>\n</ul>\n<ol start=\"5\">\n<li>\n<p>Post-install hardening See:\n<a href=\"https://secureblue.dev/post-install\">post-install</a></p>\n</li>\n<li>\n<p>Install virtualization stack:</p>\n</li>\n</ol>\n<pre><code class=\"language-bash\">ujust install-libvirt-packages\n</code></pre>\n<ul>\n<li>\n<p>The above command enables <code>qemu</code>, <code>libvirt</code>, &amp; <code>virt-manager</code> with SELinux\nlabels.</p>\n</li>\n<li>\n<p>Read the <a href=\"https://secureblue.dev/faq\">secureblue FAQ</a> to learn the quirks of\nan atomic fedora image.</p>\n</li>\n</ul>\n<p>Secureblue recommends installing GUI apps with Flatpak, CLI apps with homebrew,\nand apps that require more system access to be layered with rpm-ostree. It takes\nsome getting used to but is very stable.</p>\n<ul>\n<li><a href=\"https://secureblue.dev/faq#software\">secureblue how to install software</a></li>\n</ul>\n<hr />\n<h2>Create NixOS VM (via virt-manager)</h2>\n<ol>\n<li>\n<p>Download: <a href=\"https://nixos.org/download/\">NixOS Graphical ISO</a></p>\n</li>\n<li>\n<p>Open <code>virt-manager</code> -&gt; File -&gt; New Virtual Machine</p>\n</li>\n</ol>\n<ul>\n<li>\n<p>Select ISO</p>\n</li>\n<li>\n<p>CPU: <code>host-passthrough</code> (optional, for performance)</p>\n</li>\n<li>\n<p>Do some research to find the ideal Memory and Storage for your system.</p>\n</li>\n</ul>\n<ol start=\"3\">\n<li>\n<p>Ensure SELinux is enabled (the default for secureblue) with: <code>getenforce</code></p>\n</li>\n<li>\n<p>Ensure sVirt is enabled (the default) with <code>run0 ps -eZ | grep qemu</code>.</p>\n</li>\n</ol>\n<pre><code class=\"language-bash\">run0 ps -eZ | grep qemu\n# Output\nsystem_u:system_r:svirt_t:s0:c383,c416 14793 ?   00:01:37 qemu-system-x86\n</code></pre>\n<ol start=\"5\">\n<li>Boot -&gt; Follow graphical installer:</li>\n</ol>\n<ul>\n<li>\n<p>Enable LUKS</p>\n</li>\n<li>\n<p>Create an admin user</p>\n</li>\n<li>\n<p>Optionally skip desktop -&gt; install your own after first boot.</p>\n</li>\n</ul>\n<p>The attack surface is reduced significantly when running NixOS within a hardened\nhosts VM. The VM operates on virtualized hardware, which is a powerful form of\nattack surface reduction.</p>\n<p>Devices like your host‚Äôs Bluetooth adapter, Wi-Fi card, microphone, webcam, and\nUSB ports are not directly exposed to the guest operating system. The VM only\nsees virtual versions of these devices. If an exploit targets a vulnerability in\nthe Bluetooth stack within the VM, it compromises the VM environment, but it\ncannot typically reach and exploit the physical Bluetooth hardware on the host.</p>\n<p>You can also choose not to pass through certain devices, like Bluetooth or\nwebcam to the VM at all, effectively disabling that attack vector. Since your\nhost likely already has these hardened features you may not need the additional\nfunctionality within the VM.</p>\n<p>If something breaks, you have an option to rollback to the previous generation\nwith <code>rpm-ostree rollback</code>. The previous generation will be applied on next\nreboot. You can also just reboot and choose the previous generation through the\ngrub menu, this way it is temporary and will revert back on next reboot.</p>\n<hr />\n<h2>üîí How Host MAC Secures the NixOS VM</h2>\n<p>The core security principle here is defense-in-depth, where the outer, hardened\nlayer (the host) compensates for potential weaknesses in the inner layer (the\nguest).</p>\n<ol>\n<li>MAC Confinement via SELinux and sVirt sVirt (Secure Virtualization): This is\na critical component running on the secureblue host. It automatically assigns\nunique SELinux labels to all virtualization components.</li>\n</ol>\n<p><strong>QEMU Process Confinement</strong>: The entire QEMU process that runs the NixOS VM is\nconfined by a specific SELinux type, typically <code>svirt_t</code>. This means:</p>\n<p>The host‚Äôs MAC policy strictly controls what the QEMU process can access and do\non the host system.</p>\n<p>If an attacker were to achieve a ‚ÄúVM breakout‚Äù (a worst-case scenario where they\nescape the VM and try to interact with the host OS), their activity would still\nbe confined by the extremely strict rules of the <code>svirt_t</code> label. They would not\nbe able to arbitrarily read host files or compromise the host kernel.</p>\n<p><strong>Disk Image Confinement</strong>: The VM‚Äôs disk images are also labeled, typically as\nvirt_image_t, preventing other processes on the host from accessing or tampering\nwith them.</p>\n<ol start=\"2\">\n<li><strong>KVM and Host Hardening KVM</strong>: KVM provides the low-level, hardware-assisted\nvirtualization. It is an extremely secure and audited hypervisor that creates\na strong barrier between the guest and the host kernel.</li>\n</ol>\n<p><strong>Secureblue Hardening</strong>: The secureblue host is designed with SELinux\nenforcing, Secure Boot, a hardened kernel, and hardened_malloc by default, which\nminimizes the attack surface and ensures the integrity of the base operating\nsystem that‚Äôs running the VM.</p>\n<ol start=\"3\">\n<li><strong>Isolation and Zero Host Risk Decoupling Security</strong>: The security of the\nhost is completely decoupled from the security of the NixOS guest.</li>\n</ol>\n<p>Any compromise within the NixOS VM (e.g., a service vulnerability,\nmisconfiguration, or user error) will be contained by the host‚Äôs isolation\nmechanisms (KVM + SELinux + sVirt). This containment means the host remains\nsecure (‚ÄúZero host compromise‚Äù), regardless of the NixOS VM‚Äôs internal security\nsettings, including its lack of default MAC.</p>\n<p>In short, the security boundary isn‚Äôt the guest OS‚Äôs (NixOS) configuration, but\nthe hypervisor and the host‚Äôs MAC policy that enforces the complete isolation of\nthe VM</p>\n<h2>It‚Äôs still recommended to harden the Guest VM (NixOS)</h2>\n<p>Hardening the NixOS guest VM adds an extra, independent layer of defense,\nhelping to protect the system beyond what the host provides.</p>\n<p><strong>Best Practices for Minimizing VM Device Exposure</strong></p>\n<p>Take a VM snapshot right after a fresh install. This snapshot acts as a clean\nrestore point. Many people safely test malware or potentially dangerous software\nby running it within the VM, then reverting to the snapshot afterward to wipe\nout any changes or infections caused by the malware.</p>\n<p>Avoid unnecessary device passthrough: Only pass through hardware devices (like\nUSB, GPU, or network interfaces) that are essential for your VM‚Äôs operation. For\nexample, if a device isn‚Äôt needed within the VM, do not passthrough the device\nto reduce attack surface.‚Äã</p>\n<p>Use virtual network segmentation: Instead of bridging physical network devices,\nopt for virtual network configurations like isolated networks, VLANs, or\ninternal networks that prevent VM-to-VM or VM-to-host communication unless\nexplicitly allowed.‚Äã</p>\n<p>Implement network filtering and firewall rules: Use libvirt nwfilter, iptables,\nor firewalld rules to restrict communications between VMs and external networks,\nor between guest VMs on the same host.‚Äã</p>\n<ul>\n<li><a href=\"https://libvirt.org/firewall.html\">libvirt Firewall and network filtering</a></li>\n</ul>\n<p>Use virtual device models with minimal capabilities: Prefer virtio or similar\nparavirtualized devices that have a smaller attack surface. Avoid emulated\ndevices when not necessary.‚Äã</p>\n<p>Disable features like USB debugging, audio, or PnP devices: These can\npotentially be exploited or leak information if enabled unnecessarily.</p>\n<ul>\n<li>It‚Äôs still recommended to enable either the <code>graphene-hardened</code> or\n<code>graphene-hardened-light</code> memory allocators on the NixOS guest machine as\nwell.</li>\n</ul>\n<pre><code class=\"language-nix\"># configuration.nix\nenvironment.memoryAllocator.provider = \"graphene-hardened\";\n# OR for a more permissive and better performing allocator:\n# environment.memoryAllocator.provider = \"graphene-hardened-light\";\n</code></pre>\n<ul>\n<li>Remember that certain programs won‚Äôt run with the <code>hardened_malloc</code>. I have\nread that you need to recompile Firefox for it to respect and work with the\n<code>hardened_malloc</code>. I haven‚Äôt attempted this as of yet and use Brave for now.</li>\n</ul>\n<p>Continue\n<a href=\"https://saylesss88.github.io/nix/hardening_NixOS.html\">hardening NixOS</a></p>\n<blockquote>\n<p>‚ùóÔ∏è NOTE: It‚Äôs generally recommended not to enable GPU drivers inside the VM\nunless you are specifically doing GPU passthrough, as this often causes\nstability and compatibility issues. GPU passthrough itself requires careful\nconfiguration and dedicated hardware, and introduces additional attack\nsurfaces.</p>\n</blockquote>\n<blockquote>\n<p>Regarding IPv6 networking, enabling it typically requires using a bridged\nnetwork setup rather than NAT, which connects the VM more directly to the\nhost‚Äôs network. While bridged networking enables full IPv6 functionality, it\nalso reduces the network isolation between the VM and host, potentially\nincreasing security risks. For maximum isolation, consider carefully whether\nyou need IPv6 connectivity inside the VM and weigh that against your security\ngoals.</p>\n</blockquote>\n<p>I have been able to recover from quite a few missteps with Secureblue. I run a\nmini PC and attempted running <code>ujust update-firmware</code>, some systems allow you to\nupdate the firmware of a booted system. On reboot I got a message ‚ÄúSomething\nwent seriously wrong MOK is full‚Äù, it then forced a shutdown. I was familiar\nwith resetting the NVRAM by disassembling the PC and moving the red jumper from\nprongs 1 &amp; 2 to prongs 2 &amp; 3 with the power off for 10 seconds. I then moved the\njumper back to the default position and rebooted. The PC sounds like it‚Äôs\nrevving up a few times and does a few reboots and allowed me to sign right back\nin and re-enroll the secure boot key.</p>\n<h3>Resources</h3>\n<ul>\n<li>\n<p><a href=\"https://www.redhat.com/en/topics/virtualization/what-is-virtualization\">RedHat What is virtualization?</a></p>\n</li>\n<li>\n<p><a href=\"https://sumit-ghosh.com/posts/virtualization-hypervisors-explaining-qemu-kvm-libvirt/\">virtualization &amp; hypervisors</a></p>\n</li>\n<li>\n<p><a href=\"https://bitgrounds.tech/posts/kvm-qemu-libvirt-virtualization/\">Virtualization on Linux using the KVM/QEMU/Libvirt stack</a></p>\n</li>\n</ul>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/hardening_NixOS.html",
      "url": "https://saylesss88.github.io/nix/hardening_NixOS.html",
      "title": "Hardening NixOS",
      "content_html": "<h1>Hardening NixOS</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p><img src=\"../images/guy_fawks.png\" alt=\"guy fawks hacker\" /></p>\n<p>Securing your NixOS system begins with a philosophy of minimalism, explicit\nconfiguration, and proactive control. As desktop Linux attracts more novice\nusers, it has become an increasingly valuable target for attackers. This makes\nit crucial to adopt security best practices early to protect your desktop from\ncommon attack vectors and to avoid configuration mistakes that could expose\nvulnerabilities.</p>\n<blockquote>\n<p>‚ö†Ô∏è Warning: I am not a security expert. This guide presents various options\nfor hardening NixOS, but it is your responsibility to evaluate whether each\nadjustment suits your specific needs and environment. Security hardening and\nprocess isolation can introduce stability challenges, compatibility issues, or\nunexpected behavior. Additionally, these protections often come with\nperformance tradeoffs. Always conduct thorough research, there are no plug and\nplay one size fits all security solutions.</p>\n</blockquote>\n<blockquote>\n<p>That said, I typically write about what I‚Äôm implementing myself to deepen\nunderstanding and share what works for me. <code>--Source</code> means the proceeding\nparagraph came from <code>--Source</code>, you can often click to check for yourself. If\nyou use some common sense with a bit of caution you could end up with a more\nsecure NixOS system that fits your needs.</p>\n</blockquote>\n<blockquote>\n<p>Much of this guide draws inspiration or recommendations from the well-known\n<a href=\"https://madaidans-insecurities.github.io/guides/linux-hardening.html\">Linux Hardening Guide</a>\nby Madaidan‚Äôs Insecurities. Madaidan‚Äôs work is widely regarded in technical\nand security circles as one of the most comprehensive and rigorously\nresearched sources on practical Linux security, frequently cited for its depth\nand actionable advice. For example, much of the original basis for hardening\nfor <a href=\"https://github.com/cynicsketch/nix-mineral\">nix-mineral</a> came from this\nguide as well. This can be a starting point but shouldn‚Äôt be blindly followed\neither, always do your own research, things change frequently.</p>\n</blockquote>\n<p>For an article with apposing perspectives, see\n<a href=\"https://chyrp.cgps.ch/en/debunking-madaidans-insecurities/\">debunking-madaidans-insecurities</a>.\nWe can learn from both and hopefully find something in between that is closer to\nthe truth.</p>\n<blockquote>\n<p>‚ùó <strong>Note on SELinux and AppArmor</strong>: While NixOS can provide a high degree of\nsecurity through its immutable and declarative nature, it‚Äôs important to\nunderstand the limitations regarding Mandatory Access Control (MAC)\nframeworks. Neither SELinux nor AppArmor are fully supported or widely used in\nthe NixOS ecosystem. You can do a lot to secure NixOS but if anonymity and\nisolation are paramount, I recommend booting into a\n<a href=\"https://tails.net/\">Tails USB stick</a>. Or using\n<a href=\"https://www.whonix.org/\">Whonix</a>.</p>\n</blockquote>\n<p>‚òùÔ∏è The unique file structure of NixOS, particularly the immutable <code>/nix/store</code>,\nmakes it difficult to implement and manage the file-labeling mechanisms that\nthese frameworks rely on. There are ongoing community efforts to improve\nsupport, but as of now, they are considered experimental and not a standard part\nof a typical NixOS configuration. For an immutable distro that implements\nSELinux by default at a system level as well as many other hardening techniques,\nsee <a href=\"https://secureblue.dev/\">Fedora secureblue</a>.</p>\n<p>Containers and VMs are beyond the scope of this chapter but can also enhance\nsecurity and sandboxing if configured correctly. See\n<a href=\"https://saylesss88.github.io/nix/kvm.html\">Running NixOS in a VM</a> for more\ndetails on running NixOS in a Secureblue VM for additional security.</p>\n<p>It‚Äôs crucial to <strong>document every change</strong> you make. By creating smaller,\nfeature-complete commits, each with a descriptive message, you‚Äôre building a\nclear history. This approach makes it far simpler to revert a breaking change\nand quickly identify what went wrong. Over time, this discipline allows you to\ncreate security-focused checklists and ensure all angles are covered, building a\nmore robust and secure system.</p>\n<p>Don‚Äôt rely on single solutions or products, develop processes and defense in\ndepth. Think ahead and fail securely so that a single failure doesn‚Äôt mean total\ninsecurity.</p>\n<p>Attackers often monitor the latest Linux CVEs (Common Vulnerabilities and\nExposures) and check if and when specific distributions like NixOS have\nimplemented fixes. The unstable branch will receive the security patches and\nfixes faster than stable which is another thing to keep in mind.</p>\n<p>Check out the\n<a href=\"https://saylesss88.github.io/nix/index.html\">Hardening NixOS Baseline Hardening README</a>\nfor baseline hardening recommendations and best practices.</p>\n<p>There is something to be said about the window manager you use. GNOME, KDE\nPlasma, and Sway secure privileged Wayland protocols like screencopy. This means\nthat on environments outside of GNOME, KDE, and Sway, applications can access\nscreen content of the entire desktop. This implicitly includes the content of\nother applications. It‚Äôs primarily for this reason that Silverblue, Kinoite, and\nSericea images are recommended. COSMIC has plans to fix this.\n‚Äì<a href=\"https://secureblue.dev/images\">secureblue Images</a></p>\n<p>For example, to disable Xwayland for sway on home-manager you would add:</p>\n<pre><code class=\"language-nix\">wayland.windowManager.sway = {\n  enable = true;\n  extraConfig = ''\n    xwayland disable\n  '';\n}\n</code></pre>\n<ul>\n<li>You may get an error saying you‚Äôre only able to disable xwayland at boot,\nrestart your system and you‚Äôll be all set.</li>\n</ul>\n<p>You can explicitly disable <code>xdg-desktop-portal-wlr</code> with systemd in your\n<code>configuration.nix</code> like this:</p>\n<pre><code class=\"language-nix\"># configuration.nix\nsystemd.user.services.\"xdg-desktop-portal-wlr\" = {\n  enable = false;  # Masks/stops the wlr service\n};\nxdg.portal.wlr.enable = false;\n</code></pre>\n<h2>Common Attack Vectors for Linux</h2>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Common Attack Vectors in Linux </summary>\n<p><strong>Privilege escalation</strong>: The unauthorized act of gaining elevated permissions\nrather than legitimate, controlled privilege use. It‚Äôs a very common tactic that\nthreat actors use to take over a system, steal data, delete files, and more.</p>\n<p><strong>Processes to protect against Privilege escalation</strong></p>\n<ul>\n<li>\n<p>Adopt the principle of least privilege, only giving users the permissions that\nthey require to perform their duties.</p>\n</li>\n<li>\n<p>Harden your system: Minimize the attack surface, use strong passwords, and\nfollow best practices.</p>\n</li>\n<li>\n<p>Monitor relevant sources such as the\n<a href=\"https://www.strongdm.com/nist-compliance\">NIST National Vulnerability Database</a>,\n<a href=\"https://github.com/NixOS/nix/security/advisories\">NixOS Security Advisories</a>,\nand\n<a href=\"https://discourse.nixos.org/c/announcements/security/56\">NixOS Discourse Security</a>\nSo you‚Äôll know the latest CVEs and vulnerabilities in Linux and NixOS.</p>\n</li>\n<li>\n<p>While not made for NixOS the\n<a href=\"https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS\">linPEAS Privilege Escalation Awesome Script</a>\ngives you some useful info such as active capabilities and potential risks.</p>\n</li>\n<li>\n<p>Remove unnecessary SUID binaries to reduce the attack surface.</p>\n</li>\n</ul>\n<hr />\n<p><strong>Use after Free/Double free</strong>:</p>\n<p><strong>Use-After-Free (UAF)</strong> is a type of software vulnerability that occurs in\nmemory unsafe languages (C C++) when a program continues to use a memory\nlocation after it has been freed or deallocated.</p>\n<p><strong>Double free</strong>: is a flaw where a program frees the same memory block twice\nusing <code>free()</code> or <code>delete</code>, leading to undefined behavior and potential\nexploitation.</p>\n<p>Mitigation techniques include the use of hardened allocators such as\n<code>hardened_malloc</code>, which improve memory management to detect and prevent UAF and\ndouble-free bugs. Recent versions of <code>glibc</code> also incorporate built-in checks to\ncatch double frees.</p>\n<hr />\n<p><strong>Unauthorized Access</strong>:</p>\n<p>Unauthorized access is the entry or use of your system, networks, or data by\nindividuals without permission. It‚Äôs a common way for adversaries to exfiltrate\ndata, execute malicious code, and cause damage.</p>\n<p><strong>Protections against Unauthorized Access</strong></p>\n<ul>\n<li>\n<p>Strong Passwords, MFA, and robust Secrets management. In 2025, 22% of breaches\ninvolved stolen credentials overall; in basic web app attacks, 88% used stolen\ncredentials.\n‚Äì<a href=\"https://www.strongdm.com/blog/data-breach-statistics\">StrongDM data-breach-statistics</a></p>\n</li>\n<li>\n<p>Close unused ports with a Firewall</p>\n</li>\n<li>\n<p>Encrypt data in transit and at rest</p>\n</li>\n<li>\n<p>Watch your Logs, and deploy intrusion detection systems such as AIDE.</p>\n</li>\n<li>\n<p><a href=\"https://cwe.mitre.org/data/definitions/89.html\">SQL Injection CWE</a>, SQL\ninjection is the most common critical web application vulnerability.</p>\n</li>\n<li>\n<p><a href=\"https://owasp.org/www-community/attacks/xss/\">Cross Site Scripting (XSS)</a></p>\n</li>\n</ul>\n<hr />\n<p><strong>Misconfiguration</strong></p>\n<ul>\n<li>\n<p>With many new users trying NixOS, misconfiguration is common and an easy way\nfor an attacker to gain control over your system.</p>\n</li>\n<li>\n<p>It is recommended to start slowly and try to ensure that you understand your\nconfiguration. Avoid copy-pasting config files that you don‚Äôt understand yet.</p>\n</li>\n</ul>\n<hr />\n<p><strong>Zero Day Exploits</strong>:</p>\n<p>The term ‚ÄúZero-Day‚Äù refers to a security vulnerability or flaw that is unknown\nto the software developers or security teams, meaning they have had zero days to\ncreate a patch or fix for it. This term is often associated with concepts such\nas Vulnerabilities, Exploits, and Threats, and it‚Äôs important to distinguish\namong them:</p>\n<ul>\n<li>\n<p>A <strong>Zero-Day Vulnerability</strong> is a previously undiscovered security weakness or\nflaw in software that malicious actors can exploit.</p>\n</li>\n<li>\n<p>A <strong>Zero-Day Exploit</strong> describes the specific method or technique attackers\nuse to take advantage of that vulnerability to compromise a system.</p>\n</li>\n<li>\n<p>A <strong>Zero-Day Attack</strong> happens when malicious actors launch an attack using a\nzero-day exploit before the software vendor has had a chance to patch or fix\nthe vulnerability.</p>\n</li>\n<li>\n<p><a href=\"https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/view?gid=0#gid=0\">Project Zero‚Äôs 0day spreadsheet</a>.\nYou‚Äôll see that a majority of zero-days are Memory Corruption bugs.</p>\n</li>\n<li>\n<p><a href=\"https://www.zero-day.cz/database/\">Zero-Day tracking project</a></p>\n</li>\n<li>\n<p><a href=\"https://www.zerodayinitiative.com/advisories/published/\"> Trend Micro‚Äôs zero day inituative</a></p>\n</li>\n</ul>\n</details>\n<hr />\n<h2>Minimal Installation with LUKS</h2>\n<p>Begin with NixOS‚Äôs minimal installation image. This gives you a base system with\nonly essential tools and no extras that could introduce vulnerabilities.</p>\n<p>NixOS‚Äôs declarative model makes auditing the installed packages and services\neasy, do so regularly.</p>\n<hr />\n<h2>Manual Encrypted Install Following the Manual</h2>\n<p>Encryption is the process of using an algorithm to scramble plaintext data into\nciphertext, making it unreadable except to a person who has the key to decrypt\nit.</p>\n<p><strong>Data at rest</strong> is data in storage, such as a computer‚Äôs or a servers hard\ndisk.</p>\n<p><strong>Data at rest encryption</strong> (typically hard disk encryption), secures the\ndocuments, directories, and files behind an encryption key. Encrypting your data\nat rest prevents data leakage, physical theft, unauthorized access, and more as\nlong as the key management scheme isn‚Äôt compromised.</p>\n<ul>\n<li>\n<p><a href=\"https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso\">Minimal ISO Download (64-bit Intel/AMD)</a></p>\n</li>\n<li>\n<p><a href=\"https://nixos.org/manual/nixos/stable/#sec-installation\">NixOS Manual Installation</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Full_Disk_Encryption\">NixOS Wiki Full Disk Encryption</a></p>\n</li>\n<li>\n<p>The\n<a href=\"https://www.nsa.gov/Press-Room/Press-Releases-Statements/Press-Release-View/Article/3498776/post-quantum-cryptography-cisa-nist-and-nsa-recommend-how-to-prepare-now/\">NSA, CISA, and NIST warn</a>\nthat nation-state actors are likely stockpiling encrypted data now, preparing\nfor a future when quantum computers could break today‚Äôs most widely used\nencryption algorithms. Sensitive data with long-term secrecy needs is\nespecially at risk.</p>\n</li>\n<li>\n<p>This is a wake-up call to use the strongest encryption available today and to\nplan early for post-quantum security.</p>\n</li>\n<li>\n<p><a href=\"https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards\">NIST First 3 Post-Quantum Encryption Standards</a>\nOrganizations and individuals should prepare to migrate cryptographic systems\nto these new standards as soon as practical.</p>\n</li>\n<li>\n<p>They chose\n<a href=\"https://www.nist.gov/news-events/news/2022/07/nist-announces-first-four-quantum-resistant-cryptographic-algorithms\">Four Quantum-Resistant Cryptographic Algorithms</a>\nwarning that public-key cryptography is especially vulnerable and widely used\nto protect digital information.</p>\n</li>\n</ul>\n<hr />\n<h2>Guided Encrypted BTRFS Subvol install using disko</h2>\n<p>Use LUKS encryption to protect your data at rest, the following guide is a\nminimal disko encrypted installation:\n<a href=\"https://saylesss88.github.io/installation/enc/enc_install.html\">Encrypted Install</a></p>\n<hr />\n<h2>Installing Software</h2>\n<blockquote>\n<p>The 2025 Edgescan study examined full-stack applications and found that\none-third contained critical or severe vulnerabilities, putting them at risk.\nOver 45% of large enterprises leave unresolved vulnerabilities for more than a\nyear. This shows the necessity of containing your apps in sandboxes when\npossible.\n‚Äì<a href=\"https://www.edgescan.com/stats-report/\">edgescan Vulnerability Report</a></p>\n</blockquote>\n<blockquote>\n<p>‚ö†Ô∏è For system security it is strongly advised to not install\n<a href=\"https://en.wikipedia.org/wiki/Proprietary_software\">proprietary</a>,\n<a href=\"https://www.gnu.org/proprietary/proprietary.html\">non-freedom</a> software.\nInstead, use of\n<a href=\"https://www.fsf.org/about/what-is-free-software\">Free Software</a> is\n<a href=\"https://www.gnu.org/philosophy/shouldbefree.html\">recommended</a> ‚ÄìKicksecure</p>\n</blockquote>\n<ul>\n<li><a href=\"https://www.gnu.org/proprietary/proprietary.html\">Proprietary Software is Often Malware</a>\nNOTE: While I respect the importance of software freedom, I choose to focus on\npractical, technical solutions rather than engage with the ideological tone\noften present in related advocacy.\n<ul>\n<li>\n<p><a href=\"https://www.kicksecure.com/wiki/Miscellaneous_Threats_to_User_Freedom\">User Freedom Threats</a></p>\n</li>\n<li>\n<p><a href=\"https://www.gnu.org/proprietary/proprietary-back-doors.html\">Proprietary Back Doors</a></p>\n</li>\n<li>\n<p><a href=\"https://www.eff.org/deeplinks/2015/02/who-really-owns-your-drones\">EFF Back Doors</a></p>\n</li>\n</ul>\n</li>\n</ul>\n<pre><code class=\"language-nix\"># configuration.nix\nnixpkgs.config.allowUnfree = false;\n</code></pre>\n<p>To explicitly disable it for flakes:</p>\n<pre><code class=\"language-nix\"># ...snip...\npkgs = import nixpkgs {\n  system = \"x86_64-linux\";\n  config = {\n    allowUnfree = false;\n  };\n};\n# ...snip...\n</code></pre>\n<p>Most users don‚Äôt fully understand that running any software without sandboxing\ngives it unrestricted access to their user data and system resources. There is a\nwidespread lack of awareness that Linux apps generally run with the full\npermissions of the user. It‚Äôs easy to overlook the fact that ‚Äútrusted source‚Äù\ndoesn‚Äôt mean ‚Äúsafe to run uncontained‚Äù. ‚Äìsummarized from kicksecure docs</p>\n<p><strong>Pre-Install Recommendations</strong></p>\n<p>When installing software, first check\n<a href=\"https://search.nixos.org/packages\">search.nixos</a>, and follow the <code>Homepage</code>\nlink to ensure that said package is maintained.</p>\n<p>For example, when I search for <code>doas</code>, and go to the\n<a href=\"https://github.com/Duncaen/OpenDoas\">Homepage</a> link, I can see that the most\nrecent commit was made 3 years ago. For certain software this might not be an\nissue but <code>doas</code> isn‚Äôt one of them.</p>\n<p>Looking at the <code>sudo-rs</code>\n<a href=\"https://github.com/trifectatechfoundation/sudo-rs\">Homepage</a> I can see that it\nwas updated yesterday (11-19-25) and might be a better alternative. It‚Äôs\nmaintained and written in a memory safe language.</p>\n<p>For critical apps like <code>sudo</code>, you should also check for vulnerabilities in said\nsoftware. If you did so for <code>sudo-rs</code>, you‚Äôd see\n<a href=\"https://nvd.nist.gov/vuln/detail/CVE-2025-64170\">CVE-2025-64170</a> and see that\nit‚Äôs been patched. You can then look at the\n<a href=\"https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/su/sudo-rs/package.nix\">sudo-rs package.nix</a>\nto ensure that the versions match. (As of 11-20-25 they match).</p>\n<hr />\n<p><strong>nixpkgs-unstable Security Overview</strong></p>\n<ul>\n<li>\n<p><code>nixpkgs-unstable</code> tracks the master branch of the Nixpkgs repo and is\nconstantly updated.</p>\n</li>\n<li>\n<p>This branch gets security updates faster, patching vulnerabilities faster.</p>\n</li>\n<li>\n<p>Since it‚Äôs a rolling-release, packages are less thoroughly tested. This\nincreases the risk of new, undiscovered bugs or regressions. Some of which\ncould have security implications.</p>\n</li>\n<li>\n<p>The packages are generally the most recent upstream versions, which is\nimportant for security-sensitive software like browsers and kernels, as old\nversions may have publicly known, unpatched vulnerabilities.</p>\n</li>\n<li>\n<p>As the name states, <code>nixpkgs-unstable</code> is less stable and an update is more\nlikely to cause your system to fail to build due to breaking changes in Nix\nexpressions.</p>\n</li>\n<li>\n<p>I personally use unstable for everything, but I don‚Äôt mind having to fix\nissues that arise.</p>\n</li>\n</ul>\n<hr />\n<p><strong>Stable (e.g., <code>nixos-24.05</code>) Security Overview</strong></p>\n<p>Stable Nixpkgs channels correspond to point release (e.g., released every 6\nmonths) and are supported for a limited period (typically one month past the\nnext release).</p>\n<ul>\n<li>\n<p>Stable channels generally only receive conservative bug and security fixes.\nMajor version bumps for features are typically avoided to maintain ‚Äústability\nagainst deliberate changes‚Äù, which means you won‚Äôt get the latest upstream\nfeatures or general bug fixes.</p>\n</li>\n<li>\n<p>While critical security updates are backported quickly, updates for less\ncritical packages may be slower or not happen at all if they require a\nsignificant refactoring or version bump.</p>\n</li>\n<li>\n<p>Stable channels are generally more stable, meaning updates are less likely to\nintroduce breaking changes to your configuration or system environment.</p>\n</li>\n<li>\n<p>Many packages will be older versions. If a critical security vulnerability\nrequires a major upstream version update (which is often avoided in a stable\nchannel), the maintainers must backport the patch, a process which can\nintroduce its own set of risks and delays.</p>\n</li>\n</ul>\n<hr />\n<p><strong>What should you use?</strong></p>\n<p>The primary security trade-off is between <strong>patching speed for known\nvulnerabilities</strong> and <strong>stability/exposure to new bugs</strong>:</p>\n<ul>\n<li>\n<p>Choose <code>unstable</code> if you prioritize getting the latest security fixes\n(especially for end-user apps like browsers) as soon as they are available\nupstream, accepting a higher risk of non-security-related system breakage or\nnew, undiscovered bugs.</p>\n</li>\n<li>\n<p>Choose <code>stable</code> if you prioritize system predictability and stability, relying\non dedicated backports for critical vulnerabilities, while accepting that\nnon-critical security and bug fixes will be delayed or absent until the next\nmajor release.</p>\n</li>\n</ul>\n<p>A common hybrid approach is to use the <code>stable</code> channel as the base for the OS\nand selectively pin specific packages from <code>unstable</code> to ensure they receive\nrapid security updates.</p>\n<p>With flakes it‚Äôs easy to add both <code>stable</code> and <code>unstable</code> as flake inputs and\naccess each with some simple logic.</p>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Flake example using both stable & unstable </summary>\n<pre><code class=\"language-nix\">{\n  description = \"NixOS configuration with two or more channels\";\n\n inputs = {\n    nixpkgs.url = \"github:NixOS/nixpkgs/nixos-25.05\";\n    nixpkgs-unstable.url = \"github:NixOS/nixpkgs/nixos-unstable\";\n  };\n\n  outputs =\n    { nixpkgs, nixpkgs-unstable, ... }:\n    {\n      nixosConfigurations.\"your-host\" = nixpkgs.lib.nixosSystem {\n        modules = [\n          {\n            nixpkgs.overlays = [\n              (final: prev: {\n                unstable = nixpkgs-unstable.legacyPackages.${prev.system};\n                # use this variant if unfree packages are needed:\n                # unstable = import nixpkgs-unstable {\n                #   inherit prev;\n                #   system = prev.system;\n                #   config.allowUnfree = true;\n                # };\n              })\n            ];\n          }\n          ./configuration.nix\n        ];\n      };\n    };\n}\n</code></pre>\n<ul>\n<li>This is also how you enable unfree packages for flakes rather than in your\n<code>configuration.nix</code>.</li>\n</ul>\n<p>Now you can specify which packages are to be installed with which channel like\nso:</p>\n<pre><code class=\"language-nix\"># configuration.nix\n{ pkgs, ... }:\n{\n  environment.systemPackages = [\n    pkgs.firefox\n    pkgs.unstable.helix\n  ];\n  # ...\n}\n</code></pre>\n</details>\n<hr />\n<h2>Users and SUID Binaries</h2>\n<p><strong>Replacing sudo with run0</strong></p>\n<blockquote>\n<p>NOTE: The point here is to avoid using the setuid binary (<code>sudo</code>), <code>run0</code> is a\nwrapper over <code>systemd-run</code> which speaks over Inter-process Communication\nMechanisms (IPC) to PID1 which is considered safer than running a setuid\nbinary. We separate our daily user from administration tasks and authenticate\nthrough our admin account. This reduces the attack surface by removing sudo as\nwell as reduces the risk of local privilege escalation.</p>\n</blockquote>\n<ul>\n<li>\n<p><strong>IPC</strong> is the mechanism that allows processes to communicate. There are two\nmethods of IPC, shared memory and message passing. An OS can implement both.</p>\n</li>\n<li>\n<p><strong>PID 1</strong> is the first userspace process the kernel starts (the init system),\nwhich becomes the ancestor and reaper of all other processes; because it runs\nas root, is always present, and controls the system lifecycle, any bugs or\ndesign issues in PID 1 have outsized security impact and can translate into\nsystem-wide compromise or denial of service.</p>\n</li>\n</ul>\n<details>\n<summary> Click to Expand SUID and run0 resources </summary>\n<ul>\n<li>\n<p><a href=\"https://mastodon.social/@pid_eins/112353324518585654\">run0 explained by Lennart</a></p>\n</li>\n<li>\n<p><a href=\"https://en.wikipedia.org/wiki/Setuid\">setuid Wikipedia</a></p>\n</li>\n<li>\n<p>Using <code>run0</code> removes of these classes of\n<a href=\"https://ruderich.org/simon/notes/su-sudo-from-root-tty-hijacking\">attacks</a></p>\n</li>\n<li>\n<p>The following lists some of the downsides\n<a href=\"https://www.kicksecure.com/wiki/Dev/secureblue\">kicksecure vs secureblue</a></p>\n</li>\n</ul>\n</details>\n<p><code>run0</code> is not a SUID, it asks the service manager to invoke a command or shell\nunder the target user‚Äôs UID. The target command is invoked in an isolated exec\ncontext, freshly forked off PID1 without inheriting any context from the client.</p>\n<p>The core danger of <strong>setuid</strong> (Set User ID) lies in its ability to allow a\nlow-privilege user to execute a program with the <strong>permissions of the file‚Äôs\nowner</strong>, which is most often the powerful <strong>root user</strong>.</p>\n<h3>üí• The Danger of setuid</h3>\n<p>For granting limited, controlled privilege escalation to apps, the primary\nchoices are broadly between traditional <strong>setuid/setgid permissions</strong> and more\nmodern <strong>Linux capabilities</strong>. <a href=\"#capabilities\">Jump to Capabilities</a></p>\n<ul>\n<li><a href=\"https://www.cbtnuggets.com/blog/technology/system-admin/linux-file-permissions-understanding-setuid-setgid-and-the-sticky-bit\">Understanding setuid/setgid</a></li>\n</ul>\n<p>Use the following command to find all SUID binaries:</p>\n<pre><code class=\"language-bash\">sudo find / -perm -4000 -type f -ls 2&gt;/dev/null\n</code></pre>\n<p>The <code>setuid</code> permission is dangerous because it creates a privilege escalation\npathway that can be exploited for malicious purposes.</p>\n<ul>\n<li>\n<p>Temporary Root Access: When a file has the setuid bit set and is owned by\n<code>root</code>, any user who executes that program instantly and temporarily gains the\nfull power of the root user while the program runs.</p>\n</li>\n<li>\n<p>If a setuid program (such as <code>passwd</code>, or <code>sudo</code>) contain a security flaw,\nsuch as a buffer overflow (Common in C) or improper input validation, an\nattacker can exploit the flaw.</p>\n</li>\n<li>\n<p>Since the program is running with root privileges, the attacker can execute\nshell code or commands with root access, completely compromising the entire\nsystem.</p>\n</li>\n</ul>\n<p>Normally the root user (UID 0) gets unrestricted access to almost everything on\nthe entire system.</p>\n<p>I rebuild/update way too often to completely separate the accounts and allow no\nadmin tasks for my daily user. That may be a better option for servers, etc.</p>\n<p>Create an admin user for administrative tasks and remove your daily user from\nthe <code>wheel</code> group, and disable the <code>sudo</code>, <code>su</code>, and <code>pkexec</code> SUIDs:</p>\n<pre><code class=\"language-users.nix\">{ config, pkgs, lib }:\n{\nusers.users.admin = {\n    isNormalUser = true;\n    description  = \"System administrator\";\n    extraGroups  = [ \"wheel\" ];   # wheel = sudo\n    # run `mkpasswd --method=yescrypt` and replace \"changeme\" w/ the result\n    initialHashedPassword = \"changeme\";           # change with `passwd admin` later\n    openssh.authorizedKeys.keys = [\n      # (optional) paste your SSH public key here\n      # \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI...\"\n    ];\n  };\n    users.groups.admin = {};\n    users.mutableUsers = false;\n\n  # --------------------------------------------------------------------\n  # 2. Existing daily user ‚Äì remove from wheel, keep everything else\n  # --------------------------------------------------------------------\n  users.users.daily = {\n    isNormalUser = true;\n    description  = \"Daily driver account\";\n    extraGroups  = lib.mkForce [ \"networkmanager\" \"audio\" \"video\" ]; # keep useful groups\n    initialHashedPassword = \"changeme\";\n    # Remove `wheel` by *not* listing it (mkForce overrides any default)\n  };\n  users.groups.daily = {};\n\nsecurity = {\npolkit.enable = true;\n# Disable sudo\nsudo.enable = false;\nwrappers = {\n    su.setuid = lib.mkForce = false;\n    sudo.setuid = lib.mkForce = false;\n    sudoedit.setuid = lib.mkForce = false;\n    sg.setuid = lib.mkForce = false;\n    fusermount.setuid = lib.mkForce = false;\n    fusermount3.setuid = lib.mkForce = false;\n    mount.setuid = lib.mkForce = false;\n    pkexec.setuid = lib.mkForce = false;\n    newgrp.setuid = lib.mkForce = false;\n    newgidmap.setuid = lib.mkForce = false;\n    newuidmap.setuid= lib.mkForce = false;\n};\n# Or hyprlock, required for swaylock to accept your password\npam.services.swaylock = {\n  text = ''\n    auth include login\n    account include login\n    password include login\n    session include login\n  '';\n  };\n};\n</code></pre>\n<p>The <code>security.wrappers...</code> removes the setuid bit making the commands unusable\nremoving the SUID vulnerabilities for <code>su</code> and <code>pkexec</code>. You can find the other\nSUID wrappers in <code>/run/wrappers/bin/</code>, such as <code>fusermount</code> and more.</p>\n<p>SUID‚Äôs that can be disabled:</p>\n<ul>\n<li>\n<p><code>umount</code>: Allows unprivileged users to unmount devices listed in your fstab.</p>\n</li>\n<li>\n<p><code>mount</code>: Same as above but for mounting.</p>\n</li>\n<li>\n<p><code>sg</code>: Executes a command as a different group.</p>\n</li>\n<li>\n<p><code>mtr-packet</code>: Used by mtr to create network sockets.</p>\n</li>\n<li>\n<p><code>fusermount</code>, <code>fusermount3</code>: Allows unprivileged users to mount FUSE\nfilesystems. Can be disabled if you don‚Äôt use FUSE (e.g., Appimages, etc.)</p>\n</li>\n<li>\n<p><code>newuidmap</code>, <code>newgidmap</code>: Used for user namespace creation (Often used for\nunprivileged containers). (Disable if you don‚Äôt use unprivileged\ncontainers/namespaces)</p>\n</li>\n</ul>\n<hr />\n<p>Never Disable:</p>\n<ul>\n<li><code>unix_chkpwd</code>: This is a core PAM helper to securely check user passwords\nagainst the root-readable <code>/etc/shadow</code>.</li>\n</ul>\n<p>Check again which SUID binaries are active:</p>\n<pre><code class=\"language-bash\">sudo find / -perm -4000 -type f -ls 2&gt;/dev/null\n</code></pre>\n<hr />\n<p>You will have to use <code>run0</code> to authenticate your daily user, for example:</p>\n<pre><code class=\"language-bash\">run0 nixos-rebuild switch --flake .\n</code></pre>\n<p>Since <code>run0</code> doesn‚Äôt cache results and <code>nixos-rebuild</code> calls on Polkit 3 times,\nso on every rebuild, you will be asked for your password 3 times which isn‚Äôt\nideal. I found the following workaround that will only ask for your password\nonce.</p>\n<p>Add the following to your <code>configuration.nix</code>, replacing <code>user-name</code> with your\nusername:</p>\n<pre><code class=\"language-nix\"> security.polkit.extraConfig = ''\n     polkit.addRule(function(action, subject) {\n       if (subject.user == \"user-name\") {\n         if (action.id.indexOf(\"org.nixos\") == 0) {\n           polkit.log(\"Caching admin authentication for single NixOS operation\");\n           return polkit.Result.AUTH_ADMIN_KEEP;\n         }\n       }\n     });\n   '';\n</code></pre>\n<p>Create a zsh function for easy access:</p>\n<pre><code class=\"language-nix\"># zsh.nix\n#...snip...\ninitContent = ''\n  fr() {\n    run0 nixos-rebuild switch --flake \"/home/$USER/flake#\"$(hostname)\n  }\n'';\n</code></pre>\n<p>Needless to say, this is less secure but much more convenient than entering your\npassword 3 times on every single rebuild.</p>\n<p>Without the <code>pam</code> settings for swaylock, it won‚Äôt accept your password to log\nback in.</p>\n<p><strong>run0 Usage Example</strong></p>\n<p>When you are in a privileged shell, <code>run0</code> changes the color of the background\nto red to remind you of this.</p>\n<p>Example creating a user:</p>\n<ol>\n<li>\n<p><code>run0</code></p>\n</li>\n<li>\n<p><code>adduser admin</code></p>\n</li>\n<li>\n<p><code>usermod -aG wheel admin</code></p>\n</li>\n<li>\n<p><code>passwd admin</code></p>\n</li>\n<li>\n<p><code>exit</code></p>\n</li>\n<li>\n<p><code>reboot</code></p>\n</li>\n</ol>\n<p>This is just an example, since we manage our users declaratively the user\ncreated would be discarded on the next rebuild because of the\n<code>users.mutableUsers = false;</code> setting. You could of course change this to <code>true</code>\nto manage your users imperatively but I don‚Äôt recommend it.</p>\n<hr />\n<h3>Capabilities</h3>\n<details>\n<summary> ‚úîÔ∏è Click to expand capabilities examples </summary>\n<p>One way to help get rid of setuid binaries is to replace them with capabilities.\nI personally only remove the SUID bit and don‚Äôt try to replace with capabilities\nas of now. You can still use the commands from <code>security.wrappers</code> such as\n<code>run0 su -</code>.</p>\n<p>Capabilities provide a subset of what is available to root to a process. This\nbreaks up root privileges into smaller units that can independently grant access\nto processes. This reduces the full set of privileges, decreasing the risk of\nexploitation.</p>\n<p>(This is just an example):</p>\n<pre><code class=\"language-nix\">{\n  # a setuid root program\n  doas =\n    { setuid = true;\n      owner = \"root\";\n      group = \"root\";\n      source = \"${pkgs.doas}/bin/doas\";\n    };\n\n  # a setgid program\n  locate =\n    { setgid = true;\n      owner = \"root\";\n      group = \"mlocate\";\n      source = \"${pkgs.locate}/bin/locate\";\n    };\n\n  # a program with the CAP_NET_RAW capability\n  ping =\n    { owner = \"root\";\n      group = \"root\";\n      capabilities = \"cap_net_raw+ep\";\n      source = \"${pkgs.iputils.out}/bin/ping\";\n    };\n}\n</code></pre>\n<p>List the highest capability number for your kernel with:</p>\n<pre><code class=\"language-bash\">cat /proc/sys/kernel/cap_last_cap\n# Output:\n40\n</code></pre>\n<p>List available Linux capabilities:</p>\n<pre><code class=\"language-bash\">capsh --print\n</code></pre>\n<p>List processes:</p>\n<pre><code class=\"language-bash\">ps\n# Example Output\nPID    TTY     TIME   CMD\n8063   pts/1    02     zsh\n</code></pre>\n<pre><code class=\"language-bash\">cat /proc/8063/status | grep Cap\n# Output\nCapInh: 0000000800000000\nCapPrm: 0000000000000000\nCapEff: 0000000000000000\nCapBnd: 000001ffffffffff\nCapAmb: 0000000000000000\n</code></pre>\n<pre><code class=\"language-bash\">capsh --decode=000001ffffffffff\n# Output\n0x000001ffffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,cap_perfmon,cap_bpf,cap_checkpoint_restore\n</code></pre>\n<p><code>cap_net_raw</code>: Allows the program to use raw and unbuffered network sockets,\nwhich is what <code>ping</code> and <code>mtr-packet</code> need to send ICMP packets.</p>\n<p><code>cap_sys_admin</code>: Grants a variety of system administration operations, including\nthe ability to perform FUSE mounts. This is a powerful capability, but it‚Äôs\nstill more restrictive than full root SUID.</p>\n<ul>\n<li><code>+ep</code>: This is crucial. It stands for:\n<ul>\n<li>\n<p><code>e</code> (Effective): The set of capabilities actually used by the process when\nrunning.</p>\n</li>\n<li>\n<p><code>p</code> (Permitted): The set of capabilities that can be enabled by the process.</p>\n</li>\n</ul>\n</li>\n</ul>\n<p>By using this approach, you are following the security principle of least\nprivilege, significantly reducing the attack surface compared to traditional\nSUID binaries.</p>\n<ul>\n<li>\n<p><a href=\"https://search.nixos.org/options?channel=unstable&amp;show=security.wrappers&amp;query=security.wrappers\">security.wrappers</a></p>\n</li>\n<li>\n<p><a href=\"https://linux-audit.com/kernel/capabilities/linux-capabilities-101/\">Linux Audit capabilities 101</a></p>\n</li>\n<li>\n<p><a href=\"https://www.kicksecure.com/wiki/Dev/secureblue#capabilities\">Kicksecure‚Äôs take on capabilities</a></p>\n</li>\n<li>\n<p><a href=\"https://man7.org/linux/man-pages/man7/capabilities.7.html\">capabilities(7)</a></p>\n</li>\n<li>\n<p><a href=\"https://docs.redhat.com/en/documentation/red_hat_enterprise_linux_atomic_host/7/html/container_security_guide/linux_capabilities_and_seccomp\">capabilities and seccomp</a></p>\n</li>\n</ul>\n</details>\n<hr />\n<h2>Impermanence</h2>\n<p>Impermanence, especially when using a <code>tmpfs</code> as the root filesystem, provides\nseveral significant security benefits. The core principle is that impermanence\ndefeats persistence, a fundamental goal for any attacker.</p>\n<p>When you use a root-as-tmpfs setup on NixOS, the boot process loads the entire\noperating system from the read-only Nix store into a <code>tmpfs</code> in RAM. The mutable\ndirectories, such as <code>/etc</code> and <code>/var</code>, are then created on this RAM disk. When\nthe system is shut down, the <code>tmpfs</code> is wiped, leaving the on-disk storage\nuntouched and secure.</p>\n<p>This means you get a fresh, secure boot every time, making it much harder for an\nattacker to maintain a presence on your system.</p>\n<ul>\n<li>\n<p><a href=\"https://grahamc.com/blog/erase-your-darlings/\">Erase your Darlings (ZFS)</a></p>\n</li>\n<li>\n<p><a href=\"https://saylesss88.github.io/installation/enc/encrypted_impermanence.html\">Encrypted BTRFS Impermanence Guide</a>\nOnly follow this guide if you also followed the encrypted disko install,\nimpermanence is designed to be destructive and needs to match your config\nexactly.</p>\n</li>\n</ul>\n<h2>Replace timesyncd with a chron job that enables Network Time Security (NTS)</h2>\n<p>This is implementing the GrapheneOS/secureblue NTS chrony settings to NixOS:</p>\n<pre><code class=\"language-nix\">{ config\n, ...\n}:\n{\n  services.chrony = {\n    enable = true;\n    enableNTS = true;\n    servers = [\n        \"server time.cloudflare.com iburst nts\"\n        \"server ntppool1.time.nl iburst nts\"\n        \"server nts.netnod.se iburst nts\"\n        \"server ptbtime1.ptb.de iburst nts\"\n        \"server time.dfm.dk iburst nts\"\n        \"server time.cifelli.xyz iburst nts\"\n     ];\n    # havent worked out the kinks yet\n  #  extraConfig = ''\n  #      minsources 3\n  #      authselectmode require\n\n  #      # EF\n  #      dscp 46\n\n  #      driftfile /var/lib/chrony/drift\n  #      dumpdir /var/lib/chrony\n  #      ntsdumpdir /var/lib/chrony\n\n  #      leapseclist /usr/share/zoneinfo/leap-seconds.list\n  #      makestep 1.0 3\n\n  #      rtconutc\n\n  #      cmdport 0\n\n  #      noclientlog\n  #  '';\n  };\n}\n</code></pre>\n<p>Ensure NTS is being used with:</p>\n<pre><code class=\"language-bash\">sudo chronyc -N authdata\n</code></pre>\n<hr />\n<h2>Secure Boot</h2>\n<!-- ![Virus](../images/virus1.png) -->\n<p>Enable a UEFI password or Administrator password where it requires\nauthentication in order to access the UEFI/BIOS.</p>\n<p>Secure Boot helps ensure only signed, trusted kernels and bootloaders are\nexecuted at startup.</p>\n<p>Useful Resources:</p>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Secure Boot Resources </summary>\n<ul>\n<li>\n<p><a href=\"https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html\">The Strange State of Authenticated Boot and Encryption</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Secure_Boot\">NixOS Wiki Secure Boot</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/nix-community/lanzaboote\">lanzaboote repo</a></p>\n</li>\n</ul>\n</details>\n<p>Practical Lanzaboote Secure Boot setup for NixOS:\n<a href=\"https://saylesss88.github.io/installation/enc/lanzaboote.html\">Guide:Secure Boot on NixOS with Lanzaboote</a></p>\n<hr />\n<h3>The Kernel</h3>\n<p>The Kernel Self Protection Project:</p>\n<ul>\n<li><a href=\"https://kspp.github.io/Recommended_Settings\">KSPP Recommended_Settings</a></li>\n</ul>\n<p>Given the kernel‚Äôs central role, it‚Äôs a frequent target for malicious actors,\nmaking robust hardening essential.</p>\n<p>NixOS provides a <code>hardened</code> profile that applies a set of security-focused\nkernel and system configurations.</p>\n<p>For flakes, you could do something like the following in your\n<code>configuration.nix</code> or equivalent to import <code>hardened.nix</code> and enable\n<code>profiles.hardened</code>:</p>\n<pre><code class=\"language-nix\"># configuration.nix\n{ pkgs, inputs, ... }: let\n   modulesPath = \"${inputs.nixpkgs}/nixos/modules\";\n\nin {\n  imports = [ \"${modulesPath}/profiles/hardened.nix\" ];\n\n}\n</code></pre>\n<ul>\n<li>\n<p>There is a proposal to remove it completely that has gained ground, the\nfollowing thread discusses why:\n<a href=\"https://discourse.nixos.org/t/proposal-to-deprecate-the-hardened-profile/63081\">Discourse Thread</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/NixOS/nixpkgs/pull/383438\">PR #383438</a> Proposed removal\nPR.</p>\n</li>\n<li>\n<p>Check\n<a href=\"https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/profiles/hardened.nix\">hardened.nix</a>\nto see exactly what adding it enables to avoid duplicates and conflicts moving\non. I included this for completeness, the choice is yours if you want to use\nit or not.</p>\n</li>\n</ul>\n<h2>Choosing your Kernel</h2>\n<p>See which kernel you‚Äôre currently using with:</p>\n<pre><code class=\"language-bash\"># show the kernel release\nuname -r\n# show kernel version, hostname, and architecture\nuname -a\n</code></pre>\n<p>Show the configuration of your current kernel:</p>\n<pre><code class=\"language-bash\">zcat /proc/config.gz\n# ...snip...\n#\n# Compression\n#\nCONFIG_CRYPTO_DEFLATE=m\nCONFIG_CRYPTO_LZO=y\nCONFIG_CRYPTO_842=m\nCONFIG_CRYPTO_LZ4=m\nCONFIG_CRYPTO_LZ4HC=m\nCONFIG_CRYPTO_ZSTD=y\n# end of Compression\n# ...snip...\n</code></pre>\n<p>The <a href=\"https://nixos.org/manual/nixos/stable/#sec-kernel-config\">NixOS Manual</a>\nstates that the default Linux kernel configuration should be fine for most\nusers.</p>\n<p>The Linux kernel is typically released under two forms: stable and long-term\nsupport (LTS). Choosing either has consequences, do your research.\n<a href=\"https://madaidans-insecurities.github.io/guides/linux-hardening.html#stable-vs-lts\">Stable vs. LTS kernels</a></p>\n<ul>\n<li><a href=\"https://www.kernel.org/category/releases.html\">The Linux Kernel Archives Active kernel releases</a></li>\n</ul>\n<p><strong>OR</strong>, you can choose the hardened kernel for a kernel that prioritizes\nsecurity over everything else.</p>\n<hr />\n<h3>The Hardened Kernel</h3>\n<blockquote>\n<p>NOTE: Expect breakage when using the hardened kernel. <code>linux-hardened</code>\ncompletely disables\n<a href=\"https://secureblue.dev/articles/userns\">unprivileged user namespaces</a>, which\nare required for Flatpak, chromium-based browsers, and more.</p>\n</blockquote>\n<p>The <code>linuxPackages_latest_hardened</code> attribute has been deprecated. If you want\nto use a hardened kernel, it is now recommended to use <code>linux_hardened</code>, which\nis aliased to <code>linux_default.kernel</code>.</p>\n<p>You can find the latest available hardened kernel packages by searching\n<a href=\"https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/linux-kernels.nix\">pkgs/top-level/linux-kernels.nix</a>.</p>\n<p>It is recommended to use <code>linux_hardened</code> without specifying a version, such as:</p>\n<pre><code class=\"language-nix\">boot.kernelPackages = pkgs.linuxPackages_hardened;\n</code></pre>\n<p><code>linux_hardened</code> is aliased to the <code>linux_default.kernel</code>.</p>\n<p>Note that this not only replaces the kernel, but also packages that are specific\nto the kernel version, such as NVIDIA video drivers. This also removes your\nability to use the <code>.extend</code> kernel attribute, they are only available to\n<em>kernel package sets</em> (e.g., <code>linuxPackages_hardened</code>)</p>\n<ul>\n<li>If you decide to use this, read further before rebuilding.</li>\n</ul>\n<p>You can inspect\n<a href=\"https://github.com/NixOS/nixpkgs/blob/master/pkgs/os-specific/linux/kernel/hardened/patches.json\">nixpkgs/pkgs/os-specific/linux/kernel/hardened/patches.json</a>\nto see the metadata of the patches that are applied. You can then follow the\nlinks in the <code>.json</code> file to see the patch diffs.</p>\n<hr />\n<h3>sysctl</h3>\n<p>A tool for checking the security hardening options of the Linux kernel:</p>\n<pre><code class=\"language-nix\">environment.systemPackages = [ pkgs.kernel-hardening-checker ];\n</code></pre>\n<p><code>sysctl</code> is a tool that allows you to view or modify kernel settings and\nenable/disable different features.</p>\n<p>Check all <code>sysctl</code> parameters against the <code>kernel-hardening-checker</code>\nrecommendations:</p>\n<pre><code class=\"language-bash\">sudo sysctl -a &gt; params.txt\nkernel-hardening-checker -l /proc/cmdline -c /proc/config.gz -s ./params.txt\n</code></pre>\n<p>Check the value of a specific parameter:</p>\n<pre><code class=\"language-bash\">sudo sysctl -a | grep \"kernel.kptr_restrict\"\n# Output:\nkernel.kptr_restrict = 2\n</code></pre>\n<p>Check Active Linux Security Modules:</p>\n<pre><code class=\"language-bash\">cat /sys/kernel/security/lsm\n# Output:\nFile: /sys/kernel/security/lsm\ncapability,landlock,yama,bpf,apparmor\n</code></pre>\n<p>Check Kernel Configuration Options:</p>\n<pre><code class=\"language-bash\">zcat /proc/config.gz | grep CONFIG_SECURITY_SELINUX\nzcat /proc/config.gz | grep CONFIG_HARDENED_USERCOPY\nzcat /proc/config.gz | grep CONFIG_STACKPROTECTOR\n</code></pre>\n<p>Since it is difficult to see exactly what enabling the hardened_kernel does.\nBefore rebuilding, you could do something like this to see exactly what is\nadded:</p>\n<pre><code class=\"language-bash\">sudo sysctl -a &gt; before.txt\n</code></pre>\n<p>And after the rebuild:</p>\n<pre><code class=\"language-bash\">sudo sysctl -a &gt; after.txt\n</code></pre>\n<p>And finally run a <code>diff</code> on them:</p>\n<pre><code class=\"language-bash\">diff before.txt after.txt\n</code></pre>\n<p>You can also diff against <code>after.txt</code> for future changes to avoid duplicates,\nthis seems easier to me than trying to parse through the patches.</p>\n<hr />\n<h2>Kernel Security Settings</h2>\n<pre><code class=\"language-nix\">security = {\n      protectKernelImage = true;\n      lockKernelModules = false; # this breaks iptables, wireguard, and virtd\n\n      # force-enable the Page Table Isolation (PTI) Linux kernel feature\n      forcePageTableIsolation = true;\n\n      # User namespaces are required for sandboxing.\n      # this means you cannot set `\"user.max_user_namespaces\" = 0;` in sysctl\n      allowUserNamespaces = true;\n\n      # Disable unprivileged user namespaces, unless containers are enabled\n      unprivilegedUsernsClone = config.virtualisation.containers.enable;\n      allowSimultaneousMultithreading = true;\n}\n</code></pre>\n<hr />\n<h2>Further Hardening with sysctl</h2>\n<p><code>sysctl</code> hardening settings further reinforce kernel-level protections. The\nhardened kernel includes security patches and stricter defaults, but it doesn‚Äôt\ncover all runtime tunables. Refer to the above commands to get a diff of the\nchanges.</p>\n<p><a href=\"https://nixos.org/manual/nixos/stable/options#opt-boot.kernel.sysctl\">boot.kernel.sysctl</a>:\nRuntime parameters of the Linux kernel, as set by sysctl(8). Note that the\nsysctl parameters names must be enclosed in quotes. Values may be a string,\ninteger, boolean, or null.</p>\n<p>Check what each setting does <a href=\"https://sysctl-explorer.net/\">sysctl-explorer</a></p>\n<p>Refer to\n<a href=\"https://madaidans-insecurities.github.io/guides/linux-hardening.html#sysctl-kernel\">madadaidans-insecurities#sysctl-kernel</a>\nfor the following settings and their explainations.</p>\n<p>Also see the\n<a href=\"https://kspp.github.io/Recommended_Settings#sysctls\">Kernel Self Protection Projects sysctls</a></p>\n<pre><code class=\"language-nix\">  boot.kernel.sysctl = {\n    \"fs.suid_dumpable\" = 0;\n    # prevent pointer leaks\n    \"kernel.kptr_restrict\" = 2;\n    # restrict kernel log to CAP_SYSLOG capability\n    \"kernel.dmesg_restrict\" = 1;\n    # Note: certian container runtimes or browser sandboxes might rely on the following\n    # restrict eBPF to the CAP_BPF capability\n    \"kernel.unprivileged_bpf_disabled\" = 1;\n    # should be enabled along with bpf above\n    # \"net.core.bpf_jit_harden\" = 2;\n    # restrict loading TTY line disciplines to the CAP_SYS_MODULE\n    \"dev.tty.ldisk_autoload\" = 0;\n    # prevent exploit of use-after-free flaws\n    \"vm.unprivileged_userfaultfd\" = 0;\n    # kexec is used to boot another kernel during runtime and can be abused\n    \"kernel.kexec_load_disabled\" = 1;\n    # Kernel self-protection\n    # SysRq exposes a lot of potentially dangerous debugging functionality to unprivileged users\n    # 4 makes it so a user can only use the secure attention key. A value of 0 would disable completely\n    \"kernel.sysrq\" = 4;\n    # disable unprivileged user namespaces, Note: Docker, NH, and other apps may need this\n    # \"kernel.unprivileged_userns_clone\" = 0; # Set to 1 because it makes NH and other programs fail\n    # This should be set to 0 if you don't rely on flatpak, NH, Docker, etc.\n    \"kernel.unprivileged_userns_clone\" = 1;\n    # restrict all usage of performance events to the CAP_PERFMON capability\n    \"kernel.perf_event_paranoid\" = 3;\n\n    # Network\n    # protect against SYN flood attacks (denial of service attack)\n    \"net.ipv4.tcp_syncookies\" = 1;\n    # protection against TIME-WAIT assassination\n    \"net.ipv4.tcp_rfc1337\" = 1;\n    # enable source validation of packets received (prevents IP spoofing)\n    \"net.ipv4.conf.default.rp_filter\" = 1;\n    \"net.ipv4.conf.all.rp_filter\" = 1;\n\n    \"net.ipv4.conf.all.accept_redirects\" = 0;\n    \"net.ipv4.conf.default.accept_redirects\" = 0;\n    \"net.ipv4.conf.all.secure_redirects\" = 0;\n    \"net.ipv4.conf.default.secure_redirects\" = 0;\n    # Protect against IP spoofing\n    \"net.ipv6.conf.all.accept_redirects\" = 0;\n    \"net.ipv6.conf.default.accept_redirects\" = 0;\n    \"net.ipv4.conf.all.send_redirects\" = 0;\n    \"net.ipv4.conf.default.send_redirects\" = 0;\n\n    # prevent man-in-the-middle attacks\n    \"net.ipv4.icmp_echo_ignore_all\" = 1;\n\n    # ignore ICMP request, helps avoid Smurf attacks\n    \"net.ipv4.conf.all.forwarding\" = 0;\n    \"net.ipv4.conf.default.accept_source_route\" = 0;\n    \"net.ipv4.conf.all.accept_source_route\" = 0;\n    \"net.ipv6.conf.all.accept_source_route\" = 0;\n    \"net.ipv6.conf.default.accept_source_route\" = 0;\n    # Reverse path filtering causes the kernel to do source validation of\n    \"net.ipv6.conf.all.forwarding\" = 0;\n    \"net.ipv6.conf.all.accept_ra\" = 0;\n    \"net.ipv6.conf.default.accept_ra\" = 0;\n\n    ## TCP hardening\n    # Prevent bogus ICMP errors from filling up logs.\n    \"net.ipv4.icmp_ignore_bogus_error_responses\" = 1;\n\n    # Userspace\n    # restrict usage of ptrace\n    \"kernel.yama.ptrace_scope\" = 2;\n\n    # ASLR memory protection (64-bit systems)\n    \"vm.mmap_rnd_bits\" = 32;\n    \"vm.mmap_rnd_compat_bits\" = 16;\n\n    # only permit symlinks to be followed when outside of a world-writable sticky directory\n    \"fs.protected_symlinks\" = 1;\n    \"fs.protected_hardlinks\" = 1;\n    # Prevent creating files in potentially attacker-controlled environments\n    \"fs.protected_fifos\" = 2;\n    \"fs.protected_regular\" = 2;\n\n    # Randomize memory\n    \"kernel.randomize_va_space\" = 2;\n    # Exec Shield (Stack protection)\n    \"kernel.exec-shield\" = 1;\n\n    ## TCP optimization\n    # TCP Fast Open is a TCP extension that reduces network latency by packing\n    # data in the sender‚Äôs initial TCP SYN. Setting 3 = enable TCP Fast Open for\n    # both incoming and outgoing connections:\n    \"net.ipv4.tcp_fastopen\" = 3;\n    # Bufferbloat mitigations + slight improvement in throughput &amp; latency\n    \"net.ipv4.tcp_congestion_control\" = \"bbr\";\n    \"net.core.default_qdisc\" = \"cake\";\n  };\n</code></pre>\n<blockquote>\n<p>‚ùó Note: The above settings are fairly aggressive and can break common\nprograms, read the comment warnings.</p>\n</blockquote>\n<hr />\n<h2>Hardening Boot Parameters</h2>\n<p><code>boot.kernelParams</code> can be used to set additional kernel command line arguments\nat boot time. It can only be used for built-in modules.</p>\n<p>You can find the following settings in the\n<a href=\"https://madaidans-insecurities.github.io/guides/linux-hardening.html#boot-parameters\">Boot parameters section</a></p>\n<pre><code class=\"language-nix\"># boot.nix\n      boot.kernelParams = [\n        # make it harder to influence slab cache layout\n        \"slab_nomerge\"\n        # enables zeroing of memory during allocation and free time\n        # helps mitigate use-after-free vulnerabilaties\n        \"init_on_alloc=1\"\n        \"init_on_free=1\"\n        # randomizes page allocator freelist, improving security by\n        # making page allocations less predictable\n        \"page_alloc.shuffel=1\"\n        # enables Kernel Page Table Isolation, which mitigates Meltdown and\n        # prevents some KASLR bypasses\n        \"pti=on\"\n        # randomizes the kernel stack offset on each syscall\n        # making attacks that rely on a deterministic stack layout difficult\n        \"randomize_kstack_offset=on\"\n        # disables vsyscalls, they've been replaced with vDSO\n        \"vsyscall=none\"\n        # disables debugfs, which exposes sensitive info about the kernel\n        \"debugfs=off\"\n        # certain exploits cause an \"oops\", this makes the kernel panic if an \"oops\" occurs\n        \"oops=panic\"\n        # only alows kernel modules that have been signed with a valid key to be loaded\n        # making it harder to load malicious kernel modules\n        # can make VirtualBox or Nvidia drivers unusable\n        \"module.sig_enforce=1\"\n        # prevents user space code excalation\n        \"lockdown=confidentiality\"\n        # \"rd.udev.log_level=3\"\n        # \"udev.log_priority=3\"\n      ];\n</code></pre>\n<p>This is a thoughtful start to hardening boot parameters, there are more\nrecommendations in the guide.</p>\n<p>Kernel modules for hardware devices are generally loaded automatically by\n<code>udev</code>. You can force a module to be loaded via <code>boot.kernelModules</code>.</p>\n<hr />\n<p><strong>Hardening Modprobe</strong></p>\n<p>You can use both <code>extraModprobeConfig</code> &amp; <code>blacklistedKernelModules</code> to disable\ndifferent features. If you prefer, you can place these in the next section as\nwell.</p>\n<pre><code class=\"language-nix\">boot.extraModprobeConfig = ''\n     # firewire and thunderbolt\n    install firewire-core /bin/false\n    install firewire_core /bin/false\n    install firewire-ohci /bin/false\n    install firewire_ohci /bin/false\n    install firewire_sbp2 /bin/false\n    install firewire-sbp2 /bin/false\n    install firewire-net /bin/false\n    install thunderbolt /bin/false\n    install ohci1394 /bin/false\n    install sbp2 /bin/false\n    install dv1394 /bin/false\n    install raw1394 /bin/false\n    install video1394 /bin/false\n'';\n# OR\n#boot.blacklistedKernelModules = [\n#  \"firewire-core\"\n#  # ... snip ...\n#];\n</code></pre>\n<hr />\n<p><strong>Blacklisting Kernel Parameters</strong></p>\n<p>Blacklisting unused kernel modules reduces the attack surface.</p>\n<p><a href=\"https://nixos.org/manual/nixos/stable/options#opt-boot.blacklistedKernelModules\">boot.blacklistedKernelModules</a>:\nList of names of kernel modules that should not be loaded automatically by the\nhardware probing code.</p>\n<p>You can find the following settings in the\n<a href=\"https://madaidans-insecurities.github.io/guides/linux-hardening.html#kasr-kernel-modules\">Blacklisting Kernel Modules Section</a></p>\n<pre><code class=\"language-nix\">      boot.blacklistedKernelModules = [\n        # Obscure networking protocols\n        \"dccp\"   # Datagram Congestion Control Protocol\n        \"sctp\"  # Stream Control Transmission Protocol\n        \"rds\"  # Reliable Datagram Sockets\n        \"tipc\"  # Transparent Inter-Process Communication\n        \"n-hdlc\" # High-level Data Link Control\n        \"ax25\"  # Amateur X.25\n        \"netrom\"  # NetRom\n        \"x25\"     # X.25\n        \"rose\"\n        \"decnet\"\n        \"econet\"\n        \"af_802154\"  # IEEE 802.15.4\n        \"ipx\"  # Internetwork Packet Exchange\n        \"appletalk\"\n        \"psnap\"  # SubnetworkAccess Protocol\n        \"p8023\"  # Novell raw IEE 802.3\n        \"p8022\"  # IEE 802.3\n        \"can\"   # Controller Area Network\n        \"atm\"\n        # Various rare filesystems\n        \"cramfs\"\n        \"freevxfs\"\n        \"jffs2\"\n        \"hfs\"\n        \"hfsplus\"\n        \"udf\"\n\n        # \"squashfs\"  # compressed read-only file system used for Live CDs\n        # \"cifs\"  # cmb (Common Internet File System)\n        # \"nfs\"  # Network File System\n        # \"nfsv3\"\n        # \"nfsv4\"\n        # \"ksmbd\"  # SMB3 Kernel Server\n        # \"gfs2\"  # Global File System 2\n        # vivid driver is only useful for testing purposes and has been the\n        # cause of privilege escalation vulnerabilities\n        # \"vivid\"\n      ];\n</code></pre>\n<p>As with the <code>kernelParameters</code> above, there are more suggestions in the guide, I\nhave used the above parameters along with the commented out ones and had no\nissues.</p>\n<p>Also see\n<a href=\"https://github.com/secureblue/secureblue/blob/live/files/system/etc/modprobe.d/blacklist.conf\">SecureBlue‚Äôs blacklist.conf</a>\nfor more ideas.</p>\n<hr />\n<h2>Hardened Memory Allocator</h2>\n<blockquote>\n<p>NOTE: There is a performance cost to enabling a hardened memory allocator, and\nsome apps will not work without a workaround such as Firefox, Thunderbird,\nTorbrowser, LibreWolf, and ZenBrowser to name a few.</p>\n</blockquote>\n<p>With memory corruption bugs being the leading zero day category, it‚Äôs clearly\nsomething that you should be concerned with.</p>\n<p>The grapheneOS <code>hardened_malloc</code> is available for NixOS in two variants, add\neither to your <code>configuration.nix</code> or equivalent to apply them:</p>\n<ol>\n<li>\n<p><code>environment.memoryAllocator.provider = \"graphene-hardened\";</code>: This is the\ndefault configuration template that has all normal optional security features\nenabled. It‚Äôs aggressive, you can expect app breakage and a performance cost.</p>\n</li>\n<li>\n<p><code>environment.memoryAllocator.provider = \"graphene-hardened-light\";</code>: The\nlight template disables the slap quarantines, write after free check, slot\nrandomization and raises the guard slab interval from 1 to 8 but leaves\nzero-on-free and slab canaries enabled. This version has solid performance\nand is still far more secure than the standard allocator.</p>\n</li>\n</ol>\n<p><code>libhardened_malloc.so</code> is typically installed to\n<code>/usr/local/lib/libhardened_malloc.so</code> and referenced from <code>/etc/ld.so.preload</code>.</p>\n<ul>\n<li>\n<p><a href=\"https://nixos.org/manual/nixos/stable/options#opt-environment.memoryAllocator.provider\">NixOS Manual memoryAllocator</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/GrapheneOS/hardened_malloc?tab=readme-ov-file#traditional-linux-based-operating-systems\">GrapheneOS hardened_malloc</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/secureblue/secureblue/issues/193#issuecomment-1953323680\">GrapheneOS/secureblue discussion on hardened_malloc issues</a></p>\n</li>\n<li>\n<p><a href=\"https://man7.org/linux/man-pages/man8/ld.so.8.html\">ld.so man page</a></p>\n</li>\n<li>\n<p><a href=\"https://www.synacktiv.com/en/publications/exploring-grapheneos-secure-allocator-hardened-malloc\">Exploring hardened_malloc</a></p>\n</li>\n</ul>\n<hr />\n<h2>Hardening Systemd</h2>\n<!-- ![Hacker](../images/hacker.png) -->\n<p><code>systemd</code> is the core ‚Äúinit system‚Äù and service manager that controls how\nservices, daemons, and basic system processes are started, stopped and\nsupervised on modern Linux distributions, including NixOS. It provides a suite\nof basic building blocks for a Linux system as well as a system and service\nmanager that runs as <code>PID 1</code> and starts the rest of the system.</p>\n<p>Because it launches and supervises almost all system services, hardening systemd\nmeans raising the baseline security of your entire system.</p>\n<p>Disable coredumps:</p>\n<pre><code class=\"language-nix\">systemd.coredump.enable = false;\n# ‚û°Ô∏è Sets the kernel's resource limit (ulimit -c 0)\n  security.pam.loginLimits = [\n    {\n      domain = \"*\"; # Applies to all users/sessions\n      type = \"-\"; # Set both soft and hard limits\n      item = \"core\"; # The soft/hard limit item\n      value = \"0\";   # Core dumps size is limited to 0 (effectively disabled)\n    }\n  ];\n</code></pre>\n<p>Disabling coredumps helps save space and improves security/privacy because when\na program fails, a coredump contains an exact copy of a programs running memory\nat the time of the crash. This can inadvertently expose sensitive data.</p>\n<p>If a program is handling private information when it crashes, the core dump file\ncould contain:</p>\n<ul>\n<li>\n<p><strong>Passwords</strong>: Stored in memory before being sent or hashed.</p>\n</li>\n<li>\n<p><strong>Encryption Keys</strong>: Used for securing network connections.</p>\n</li>\n<li>\n<p><strong>Personal Info</strong>: Chat messages, website forms, etc.</p>\n</li>\n</ul>\n<p>It can give a minor performance upgrade and does reduce the attack surface. If a\nmalicious program were to gain access to your system, one of the first things it\nmight look for are core dump files to extract sensitive data. By disabling them,\nyou eliminate this potential source of information leakage.</p>\n<p><code>dbus-broker</code> is generally considered more secure and robust but isn‚Äôt the\ndefault as of yet. To set <code>dbus-broker</code> as the default:</p>\n<pre><code class=\"language-nix\">  users.groups.netdev = {};\n  services = {\n    dbus.implementation = \"broker\";\n    logrotate.enable = true;\n    journald = {\n      storage = \"volatile\"; # Store logs in memory\n      upload.enable = false; # Disable remote log upload (the default)\n      extraConfig = ''\n        SystemMaxUse=500M\n        SystemMaxFileSize=50M\n      '';\n    };\n  };\n</code></pre>\n<ul>\n<li>\n<p><code>dbus-broker</code> is more resilient to resource exhaustion attacks and integrates\nbetter with Linux security features.</p>\n</li>\n<li>\n<p><a href=\"https://dvdhrm.github.io/rethinking-the-dbus-message-bus/\">Rethinking-the-dbus-message-bus</a></p>\n</li>\n<li>\n<p>Setting <code>storage = \"volatile\"</code> tells journald to keep log data only in memory.\nThere is a tradeoff though, If you need long-term auditing or troubleshooting\nafter a reboot, this will not preserve system logs.</p>\n</li>\n<li>\n<p><code>upload.enable</code> is for forwarding log messages to remote servers, setting this\nto false prevents accidental leaks of potentially sensitive or internal system\ninformation.</p>\n</li>\n<li>\n<p>Enabling <code>logrotate</code> prevents your disk from filling with excessive\n<strong>legacy/service</strong> log files. These are the classic plain-text logs.</p>\n</li>\n<li>\n<p>Systemd uses <code>journald</code> which stores logs in a binary format</p>\n</li>\n</ul>\n<p>You can check the security status with:</p>\n<pre><code class=\"language-bash\">systemd-analyze security\n# or for a detailed view of individual services security posture\nsystemd-analyze security NetworkManager\n</code></pre>\n<p>Optionally disable vulnerable services to reduce the attack surface, obviously\ndon‚Äôt disable what you need, or change your habits:</p>\n<pre><code class=\"language-nix\">services = {\n    # mDNS/DNS-SD\n    avahi.enable = false;\n    # Geoclue (location services)\n    geoclue2.enable = false;\n    udisks2.enable = false;\n    accounts-daemon.enable = false;\n  };\n  # Only needed for WWAN/3G/4G modems, otherwise it runs `mmcli` unnecessarily\n  networking.modemmanager.enable = false;\n  # Bluetooth has a long history of vulnerabilities\n  hardware.bluetooth.enable = false;\n  # Prefer manual upgrades on a hardened system\n  system.autoUpgrade.enable = false;\n</code></pre>\n<p>Further reading on systemd:</p>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Systemd Resources </summary>\n<ul>\n<li>\n<p><a href=\"https://systemd.io/\">systemd.io</a></p>\n</li>\n<li>\n<p><a href=\"https://0pointer.de/blog/projects/systemd.html\">Rethinking PID 1</a></p>\n</li>\n<li>\n<p><a href=\"https://0pointer.de/blog/projects/the-biggest-myths.html\">Biggest Myths about Systemd</a></p>\n</li>\n</ul>\n</details>\n<p>The following is a repo containing many of the Systemd hardening settings in\nNixOS format:</p>\n<p><a href=\"https://github.com/wallago/nix-system-services-hardened\">nix-system-services-hardened</a></p>\n<p>For example, to harden bluetooth you could add the following to your\n<code>configuration.nix</code> or equivalent:</p>\n<pre><code class=\"language-nix\">systemd.services = {\n      bluetooth.serviceConfig = {\n      ProtectKernelTunables = lib.mkDefault true;\n      ProtectKernelModules = lib.mkDefault true;\n      ProtectKernelLogs = lib.mkDefault true;\n      ProtectHostname = true;\n      ProtectControlGroups = true;\n      ProtectProc = \"invisible\";\n      SystemCallFilter = [\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n        \"~@swap\"\n        \"~@reboot\"\n        \"~@mount\"\n      ];\n      SystemCallArchitectures = \"native\";\n    };\n}\n</code></pre>\n<p>As you can see from above, you typically use the <code>serviceConfig</code> attribute to\nharden settings for systemd services.</p>\n<pre><code class=\"language-bash\">systemd-analyze security bluetooth\n‚Üí Overall exposure level for bluetooth.service: 3.3 OK üôÇ\n</code></pre>\n<details>\n<summary> Click to expand `systemd.nix` example implementing many of the recommendations </summary>\n<pre><code class=\"language-nix\">{lib, ...}: {\n  systemd.services = {\n    # \"home-manager-jr\".after = [\"network-online.target\"];\n    # \"home-manager-jr\".wantedBy = [\"multi-user.target\"];\n    \"user@\".serviceConfig = {\n      ProtectSystem = \"strict\";\n      ProtectClock = true;\n      ProtectHostname = true;\n      ProtectKernelTunables = true;\n      ProtectKernelModules = true;\n      ProtectKernelLogs = true;\n      ProtectProc = \"invisible\";\n      PrivateTmp = true;\n      PrivateNetwork = true;\n      MemoryDenyWriteExecute = false;\n      RestrictAddressFamilies = [\n        \"AF_UNIX\"\n        \"AF_NETLINK\"\n        \"AF_BLUETOOTH\"\n      ];\n      RestrictNamespaces = true;\n      RestrictRealtime = true;\n      RestrictSUIDSGID = true;\n      SystemCallFilter = [\n        \"~@keyring\"\n        \"~@swap\"\n        \"~@debug\"\n        \"~@module\"\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n      ];\n      SystemCallArchitectures = \"native\";\n    };\n    acpid.serviceConfig = {\n      ProtectSystem = \"full\";\n      ProtectHome = true;\n      RestrictAddressFamilies = [\"AF_INET\" \"AF_INET6\"];\n      SystemCallFilter = \"~@clock @cpu-emulation @debug @module @mount @raw-io @reboot @swap\";\n      ProtectKernelTunables = true;\n      ProtectKernelModules = true;\n    };\n\n    auditd.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectSystem = \"full\";\n      ProtectHome = true;\n      ProtectHostname = true;\n      ProtectKernelTunables = true;\n      ProtectKernelModules = true;\n      ProtectControlGroups = true;\n      ProtectProc = \"invisible\";\n      ProtectClock = true;\n      PrivateTmp = true;\n      PrivateNetwork = true;\n      PrivateMounts = true;\n      PrivateDevices = true;\n      RestrictNamespaces = true;\n      RestrictRealtime = true;\n      RestrictSUIDSGID = true;\n      RestrictAddressFamilies = [\n        \"~AF_INET6\"\n        \"~AF_INET\"\n        \"~AF_PACKET\"\n      ];\n      MemoryDenyWriteExecute = true;\n      LockPersonality = true;\n      SystemCallFilter = [\n        \"~@clock\"\n        \"~@module\"\n        \"~@mount\"\n        \"~@swap\"\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n      ];\n      SystemCallArchitectures = \"native\";\n      CapabilityBoundingSet = [\n        \"~CAP_CHOWN\"\n        \"~CAP_FSETID\"\n        \"~CAP_SETFCAP\"\n      ];\n    };\n\n    cups.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectSystem = \"full\";\n      ProtectHome = true;\n      ProtectKernelModules = true;\n      ProtectKernelTunables = true;\n      ProtectKernelLogs = true;\n      ProtectControlGroups = true;\n      ProtectHostname = true;\n      ProtectClock = true;\n      ProtectProc = \"invisible\";\n      RestrictRealtime = true;\n      RestrictNamespaces = true;\n      RestrictSUIDSGID = true;\n      RestrictAddressFamilies = [\n        \"AF_UNIX\"\n        \"AF_NETLINK\"\n        \"AF_INET\"\n        \"AF_INET6\"\n        \"AF_PACKET\"\n      ];\n\n      MemoryDenyWriteExecute = true;\n      SystemCallFilter = [\n        \"~@clock\"\n        \"~@reboot\"\n        \"~@debug\"\n        \"~@module\"\n        \"~@swap\"\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n      ];\n      SystemCallArchitectures = \"native\";\n      LockPersonality = true;\n    };\n\n    NetworkManager.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectHome = true;\n      ProtectKernelModules = true;\n      ProtectKernelLogs = true;\n      ProtectControlGroups = true;\n      ProtectClock = true;\n      ProtectHostname = true;\n      ProtectProc = \"invisible\";\n      PrivateTmp = true;\n      RestrictRealtime = true;\n      RestrictAddressFamilies = [\n        \"AF_UNIX\"\n        \"AF_NETLINK\"\n        \"AF_INET\"\n        \"AF_INET6\"\n        \"AF_PACKET\"\n      ];\n      RestrictNamespaces = true;\n      RestrictSUIDSGID = true;\n      MemoryDenyWriteExecute = true;\n      SystemCallFilter = [\n        \"~@mount\"\n        \"~@module\"\n        \"~@swap\"\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n        \"ptrace\"\n      ];\n      SystemCallArchitectures = \"native\";\n      LockPersonality = true;\n    };\n\n    wpa_supplicant.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectSystem = \"strict\";\n      ProtectHome = true;\n      ProtectKernelModules = true;\n      ProtectKernelLogs = true;\n      ProtectControlGroups = true;\n      ProtectClock = true;\n      ProtectHostname = true;\n      ProtectProc = \"invisible\";\n      PrivateTmp = true;\n      PrivateMounts = true;\n      RestrictRealtime = true;\n      RestrictAddressFamilies = [\n        \"AF_UNIX\"\n        \"AF_NETLINK\"\n        \"AF_INET\"\n        \"AF_INET6\"\n        \"AF_PACKET\"\n      ];\n      RestrictNamespaces = true;\n      RestrictSUIDSGID = true;\n      MemoryDenyWriteExecute = true;\n      SystemCallFilter = [\n        \"~@mount\"\n        \"~@raw-io\"\n        \"~@privileged\"\n        \"~@keyring\"\n        \"~@reboot\"\n        \"~@module\"\n        \"~@swap\"\n        \"~@resources\"\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n        \"ptrace\"\n      ];\n      SystemCallArchitectures = \"native\";\n      LockPersonality = true;\n      CapabilityBoundingSet = \"CAP_NET_ADMIN CAP_NET_RAW\";\n    };\n\n    dbus.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectSystem = \"stric\";\n      ProtectControlGroups = true;\n      ProtectHome = true;\n      ProtectHostname = true;\n      ProtectKernelTunables = true;\n      ProtectKernelModules = true;\n      ProtectKernelLogs = true;\n      PrivateMounts = true;\n      PrivateDevices = true;\n      PrivateTmp = true;\n      RestrictSUIDSGID = true;\n      RestrictRealtime = true;\n      RestrictAddressFamilies = [\n        \"AF_UNIX\"\n      ];\n      RestrictNamespaces = true;\n      SystemCallErrorNumber = \"EPERM\";\n      SystemCallArchitectures = \"native\";\n      SystemCallFilter = [\n        \"~@obsolete\"\n        \"~@resources\"\n        \"~@debug\"\n        \"~@mount\"\n        \"~@reboot\"\n        \"~@swap\"\n        \"~@cpu-emulation\"\n      ];\n      LockPersonality = true;\n      IPAddressDeny = [\"0.0.0.0/0\" \"::/0\"];\n      MemoryDenyWriteExecute = true;\n      DevicePolicy = \"closed\";\n      UMask = 0077;\n    };\n\n    nscd.serviceConfig = {\n      ProtectClock = true;\n      ProtectHostname = true;\n      ProtectKernelTunables = true;\n      ProtectKernelModules = true;\n      ProtectKernelLogs = true;\n      ProtectControlGroups = true;\n      ProtectProc = \"invisible\";\n      RestrictNamespaces = true;\n      RestrictRealtime = true;\n      MemoryDenyWriteExecute = true;\n      LockPersonality = true;\n      SystemCallFilter = [\n        \"~@mount\"\n        \"~@swap\"\n        \"~@clock\"\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n      ];\n      SystemCallArchitectures = \"native\";\n      CapabilityBoundingSet = [\n        \"~CAP_CHOWN\"\n        \"~CAP_FSETID\"\n        \"~CAP_SETFCAP\"\n      ];\n    };\n    bluetooth.serviceConfig = {\n      ProtectKernelTunables = lib.mkDefault true;\n      ProtectKernelModules = lib.mkDefault true;\n      ProtectKernelLogs = lib.mkDefault true;\n      ProtectHostname = true;\n      ProtectControlGroups = true;\n      ProtectProc = \"invisible\";\n      SystemCallFilter = [\n        \"~@obsolete\"\n        \"~@cpu-emulation\"\n        \"~@swap\"\n        \"~@reboot\"\n        \"~@mount\"\n      ];\n      SystemCallArchitectures = \"native\";\n    };\n    systemd-rfkill.serviceConfig = {\n      ProtectSystem = \"strict\";\n      ProtectHome = true;\n      ProtectKernelTunables = true;\n      ProtectKernelModules = true;\n      ProtectControlGroups = true;\n      ProtectClock = true;\n      ProtectProc = \"invisible\";\n      ProcSubset = \"pid\";\n      PrivateTmp = true;\n      MemoryDenyWriteExecute = true;\n      NoNewPrivileges = true;\n      LockPersonality = true;\n      RestrictRealtime = true;\n      SystemCallArchitectures = \"native\";\n      UMask = \"0077\";\n      IPAddressDeny = \"any\";\n    };\n    systemd-machined.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectSystem = \"strict\";\n      ProtectHome = true;\n      ProtectClock = true;\n      ProtectHostname = true;\n      ProtectKernelTunables = true;\n      ProtectKernelModules = true;\n      ProtectKernelLogs = true;\n      ProtectProc = \"invisible\";\n      PrivateTmp = true;\n      PrivateMounts = true;\n      PrivateUsers = true;\n      PrivateNetwork = true;\n      RestrictNamespaces = true;\n      RestrictRealtime = true;\n      RestrictSUIDSGID = true;\n      RestrictAddressFamilies = [\"AF_UNIX\"];\n      MemoryDenyWriteExecute = true;\n      SystemCallArchitectures = \"native\";\n    };\n    systemd-udevd.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectSystem = \"strict\";\n      ProtectHome = true;\n      ProtectKernelLogs = true;\n      ProtectControlGroups = true;\n      ProtectClock = true;\n      ProtectProc = \"invisible\";\n      RestrictNamespaces = true;\n      CapabilityBoundingSet = \"~CAP_SYS_PTRACE ~CAP_SYS_PACCT\";\n    };\n    nix-daemon.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectControlGroups = true;\n      ProtectKernelModules = true;\n      PrivateMounts = true;\n      PrivateTmp = true;\n      PrivateDevices = true;\n      RestrictSUIDSGID = true;\n      RestrictRealtime = true;\n      RestrictNamespaces = [\"~cgroup\"];\n      RestrictAddressFamilies = [\n        \"AF_UNIX\"\n        \"AF_NETLINK\"\n        \"AF_INET6\"\n        \"AF_INET\"\n      ];\n      CapabilityBoundingSet = [\n        \"~CAP_SYS_CHROOT\"\n        \"~CAP_BPF\"\n        \"~CAP_AUDIT_WRITE\"\n        \"~CAP_AUDIT_CONTROL\"\n        \"~CAP_AUDIT_READ\"\n        \"~CAP_SYS_PTRACE\"\n        \"~CAP_SYS_NICE\"\n        \"~CAP_SYS_RESOURCE\"\n        \"~CAP_SYS_RAWIO\"\n        \"~CAP_SYS_TIME\"\n        \"~CAP_SYS_PACCT\"\n        \"~CAP_LINUX_IMMUTABLE\"\n        \"~CAP_IPC_LOCK\"\n        \"~CAP_WAKE_ALARM\"\n        \"~CAP_SYS_TTY_CONFIG\"\n        \"~CAP_SYS_BOOT\"\n        \"~CAP_LEASE\"\n        \"~CAP_BLOCK_SUSPEND\"\n        \"~CAP_MAC_ADMIN\"\n        \"~CAP_MAC_OVERRIDE\"\n      ];\n      SystemCallErrorNumber = \"EPERM\";\n      SystemCallArchitectures = \"native\";\n      SystemCallFilter = [\n        \"~@resources\"\n        \"~@module\"\n        \"~@obsolete\"\n        \"~@debug\"\n        \"~@reboot\"\n        \"~@swap\"\n        \"~@cpu-emulation\"\n        \"~@clock\"\n        \"~@raw-io\"\n      ];\n      LockPersonality = true;\n      MemoryDenyWriteExecute = false;\n      DevicePolicy = \"closed\";\n      UMask = 0077;\n    };\n    systemd-journald.serviceConfig = {\n      NoNewPrivileges = true;\n      ProtectProc = \"invisible\";\n      ProtectHostname = true;\n      PrivateMounts = true;\n    };\n  };\n}\n</code></pre>\n</details>\n<hr />\n<h2>Lynis and other tools</h2>\n<p>Lynis is a security auditing tool for systems based on UNIX like Linux, macOS,\nBSD, and others.‚Äì<a href=\"https://github.com/CISOfy/lynis\">lynis repo</a></p>\n<p><code>chkrootkit</code> was removed as it is unmaintained and archived upstream.</p>\n<p>Installation:</p>\n<pre><code class=\"language-nix\">environment.systemPackages = [\npkgs.lynis\npkgs.clamav\npkgs.aide\n ];\n</code></pre>\n<details>\n<summary> ‚úîÔ∏è Click to Expand AIDE Example </summary>\n<p>AIDE is an intrusion detection system (IDS) that will notify us whenever it\ndetects that a potential intrusion has occurred. When a system is compromised,\nattackers typically will try to change file permissions and escalate to the root\nuser account and start to modify system files, AIDE can detect this.</p>\n<p>To set up AIDE on your system follow these steps:</p>\n<ol>\n<li>Create the <code>aide.conf</code>:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo mkdir -p /var/lib/aide &amp;&amp; cd /var/lib/aide/\nsudo hx aide.conf\n</code></pre>\n<p>Add the following content to <code>/var/lib/aide/aide.conf</code>:</p>\n<pre><code class=\"language-conf\"># aide.conf\n# Example configuration file for AIDE.\n\n@@define DBDIR /var/lib/aide\n\n# The location of the database to be read.\ndatabase_in=file:@@{DBDIR}/aide.db.gz\n\n# The location of the database to be written.\n#database_out=sql:host:port:database:login_name:passwd:table\n#database_out=file:aide.db.new\ndatabase_out=file:@@{DBDIR}/aide.db.new.gz\n\n# Whether to gzip the output to database\ngzip_dbout=yes\n\nlog_level=info\n\nreport_url=file:/var/log/aide/aide.log\nreport_url=stdout\n#report_url=stderr\n#NOT IMPLEMENTED report_url=mailto:root@foo.com\n#NOT IMPLEMENTED report_url=syslog:LOG_AUTH\n\n# These are the default rules.\n#\n#p:      permissions\n#i:      inode:\n#n:      number of links\n#u:      user\n#g:      group\n#s:      size\n#b:      block count\n#m:      mtime\n#a:      atime\n#c:      ctime\n#S:      check for growing size\n#md5:    md5 checksum\n#sha1:   sha1 checksum\n#rmd160: rmd160 checksum\n#tiger:  tiger checksum\n#haval:  haval checksum\n#gost:   gost checksum\n#crc32:  crc32 checksum\n#R:      p+i+n+u+g+s+m+c+md5\n#L:      p+i+n+u+g\n#E:      Empty group\n#&gt;:      Growing logfile p+u+g+i+n+S\n\n# You can create custom rules like this.\n\nNORMAL = R+b+sha512\n\nDIR = p+i+n+u+g\n\n# Next decide what directories/files you want in the database.\n\n/boot   NORMAL\n/bin    NORMAL\n/sbin   NORMAL\n/lib    NORMAL\n/opt    NORMAL\n/usr    NORMAL\n/root   NORMAL\n\n# Check only permissions, inode, user and group for /etc, but\n# cover some important files closely.\n/etc    p+i+u+g\n!/etc/mtab\n/etc/exports  NORMAL\n/etc/fstab    NORMAL\n/etc/passwd   NORMAL\n/etc/group    NORMAL\n/etc/gshadow  NORMAL\n/etc/shadow   NORMAL\n\n/var/log   p+n+u+g\n\n# With AIDE's default verbosity level of 5, these would give lots of\n# warnings upon tree traversal. It might change with future version.\n#\n#=/lost\\+found    DIR\n#=/home           DIR\n</code></pre>\n<p>Create the logfile:</p>\n<pre><code class=\"language-bash\">sudo mkdir -p /var/log/aide\nsudo touch /var/log/aide/aide.log\n</code></pre>\n<ol start=\"2\">\n<li>Generate the initial database, this will store the checksums of all files\nthat it‚Äôs configured to monitor. Take note of the location of the new\ndatabase, mine was <code>/etc/aide.db.new</code></li>\n</ol>\n<pre><code class=\"language-bash\">sudo aide --config /var/lib/aide/aide.conf --init\n</code></pre>\n<ol start=\"3\">\n<li>Move the new database and remove the <code>.new</code>:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz\n</code></pre>\n<pre><code class=\"language-bash\">ls /var/lib/aide/\naide.conf   aide.db.gz\n</code></pre>\n<ol start=\"4\">\n<li>Check with AIDE:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo aide --check --config /var/lib/aide/aide.conf\nStart timestamp: 2025-09-05 09:50:07 -0400 (AIDE 0.19.2)\nAIDE found NO differences between database and filesystem. Looks okay!!\n</code></pre>\n<ol start=\"5\">\n<li>Whenever you make changes to system files, or especially after running a\nsystem update or installing new tools, you have to rescan all files to update\ntheir checksums in the AIDE database:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo aide --update --config /var/lib/aide/aide.conf\n</code></pre>\n<p>Unfortunately, AIDE doesn‚Äôt automatically replace the old database so you have\nto rename the new one again:</p>\n<pre><code class=\"language-bash\">sudo mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz\n</code></pre>\n<p>And finally check again:</p>\n<pre><code class=\"language-bash\">sudo aide --check --config /var/lib/aide/aide.conf\n</code></pre>\n<ul>\n<li><a href=\"https://linux.die.net/man/1/aide\">aide(1) man page</a></li>\n</ul>\n</details>\n<details>\n<summary> ‚úîÔ∏è Click to Expand clamav.nix Example </summary>\n<pre><code class=\"language-nix\">{pkgs, ...}: {\n  environment.systemPackages = with pkgs; [\n    clamav\n  ];\n  services.clamav = {\n    # Enable clamd daemon\n    daemon.enable = true;\n    updater.enable = true;\n    updater.frequency = 12; # Number of database checks per day\n    scanner = {\n      enable = true;\n      # 4:00 AM\n      interval = \"*-*-* 04:00:00\";\n      scanDirectories = [\n        \"/home\"\n        \"/var/lib\"\n        \"/tmp\"\n        \"/etc\"\n        \"/var/tmp\"\n      ];\n    };\n  };\n}\n</code></pre>\n</details>\n<p>Lynis Usage:</p>\n<pre><code class=\"language-bash\">sudo lynis show commands\n# Output:\nCommands:\nlynis audit\nlynis configure\nlynis generate\nlynis show\nlynis update\nlynis upload-only\n\nsudo lynis audit system\n# Output:\n  Lynis security scan details:\n\n  Hardening index : 79 [###############     ]\n  Tests performed : 234\n  Plugins enabled : 0\n\n  Components:\n  - Firewall               [V]\n  - Malware scanner        [V]\n\n  Scan mode:\n  Normal [V]  Forensics [ ]  Integration [ ]  Pentest [ ]\n\n  Lynis modules:\n  - Compliance status      [?]\n  - Security audit         [V]\n  - Vulnerability scan     [V]\n</code></pre>\n<ul>\n<li>\n<p>The ‚ÄúLynis hardening index‚Äù is an overall impression on how well a system is\nhardened. However, this is just an indicator on measures taken - not a\npercentage of how safe a system might be. A score over 75 typically indicates\na system with more than average safety measures implemented.</p>\n</li>\n<li>\n<p>Lynis will give you more recommendations for securing your system as well.</p>\n</li>\n</ul>\n<p>If you use <code>clamscan</code>, create the following log file:</p>\n<pre><code class=\"language-bash\">sudo touch /var/log/clamscan.log\n</code></pre>\n<p>Example cron job for <code>clamav</code> &amp; <code>aide</code>:</p>\n<pre><code class=\"language-nix\">{pkgs, ...}: {\n  services.cron = {\n    enable = true;\n    # messages.enable = true;\n    systemCronJobs = [\n      # Every day at 2:00 AM, run clamscan as root and append output to a log file\n      \"0 2 * * * root ${pkgs.clamav}/bin/clamscan -r /home &gt;&gt; /var/log/clamscan.log\"\n      \"0 11 * * * ${pkgs.aide}/bin/aide --check --config /var/lib/aide/aide.conf\"\n    ];\n  };\n}\n</code></pre>\n<p>ClamAV usage:</p>\n<p>You can run <code>clamav</code> manually with:</p>\n<pre><code class=\"language-bash\"># Recursive Scan:\nsudo clamscan -r ~/home\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: You only need either the individual <code>pkgs.clamav</code> with the cron job\n<strong>OR</strong> the <code>clamd-daemon</code> module. <code>clamdscan</code> is for software integration and\nuses a different user that doesn‚Äôt have permission to scan your files. You can\nuse <code>clamdscan --fdpass /path/to/scan</code> to pass the necessary file permissions.\nNOTE: <code>clamdscan</code> runs in the background, you can watch it with <code>top</code>.</p>\n</blockquote>\n<h2>Securing SSH</h2>\n<blockquote>\n<p><strong>Security information</strong>: Changing SSH configuration settings can\nsignificantly impact the security of your system(s). It is crucial to have a\nsolid understanding of what you are doing before making any adjustments. Avoid\nblindly copying and pasting examples, including those from this Wiki page,\nwithout conducting a thorough analysis. Failure to do so may compromise the\nsecurity of your system(s) and lead to potential vulnerabilities. Take the\ntime to comprehend the implications of your actions and ensure that any\nchanges made are done thoughtfully and with care. ‚ÄìNixOS Wiki</p>\n</blockquote>\n<blockquote>\n<p>‚ùó NOTE: Choose one, either <code>ssh-agent</code> or <code>gpg-agent</code></p>\n</blockquote>\n<ol>\n<li>Use normal SSH keys generated with <code>ssh-keygen</code>, this is recommended unless\nyou have a good reason for not using it.</li>\n</ol>\n<p><strong>OR</strong></p>\n<ol start=\"2\">\n<li>Use a GPG key with <code>gpg-agent</code> (which acts as your SSH agent). Complex, and\nharder to understand in my opinion.</li>\n</ol>\n<p>My setup caused conflicts when enabling <code>programs.ssh.startAgent</code> so I chose\n<code>gpg-agent</code> personally.</p>\n<p>There are situations where you are required to use one or the other like for\nheadless CI/CD environments, <code>ssh-keygen</code> is required.</p>\n<ul>\n<li><a href=\"https://saylesss88.github.io/nix/gpg-agent.html\">Click Here for GnuPG and gpg-agent chapter</a></li>\n</ul>\n<p>Further reading:</p>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Resourses on OpenSSH </summary>\n<ul>\n<li>\n<p><a href=\"https://wiki.archlinux.org/title/OpenSSH\">Arch Wiki OpenSSH</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.gentoo.org/wiki/GnuPG\">Gentoo GnuPG</a></p>\n</li>\n<li>\n<p><a href=\"https://rgoulter.com/blog/posts/programming/2022-06-10-a-visual-explanation-of-gpg-subkeys.html\">A Visual Explanation of GPG Subkeys</a></p>\n</li>\n<li>\n<p><a href=\"https://blog.stribik.technology/2015/01/04/secure-secure-shell.html\">Secure Secure Shell</a></p>\n</li>\n</ul>\n</details>\n<hr />\n<h2>Key generation</h2>\n<h3>ssh-keygen</h3>\n<p>The <code>ed25519</code> algorithm is significantly faster and more secure when compared to\n<code>RSA</code>. You can also specify the key derivation function (KDF) rounds to\nstrengthen protection even more.</p>\n<p>For example, to generate a strong key for GitHub:</p>\n<pre><code class=\"language-bash\">ssh-keygen -t ed25519 -a 32 -f ~/.ssh/id_ed25519_github_$(date +%Y-%m-%d) -C \"SSH Key for GitHub\"\n</code></pre>\n<ul>\n<li>\n<p><code>-t</code> is for type</p>\n</li>\n<li>\n<p><code>-a 32</code> sets the number of KDF rounds. The standard is usually good enough,\nadding extra rounds can make it harder to brute-force.</p>\n</li>\n<li>\n<p><code>-f</code> is for filename</p>\n</li>\n</ul>\n<h3>OpenSSH Server</h3>\n<p>First of all, if you don‚Äôt use SSH don‚Äôt enable it in the first place. If you do\nuse SSH, it‚Äôs important to understand what that opens you up to.</p>\n<p>The following are some recommendations from Mozilla on OpenSSH:</p>\n<ul>\n<li><a href=\"https://infosec.mozilla.org/guidelines/openssh.html\">Mozilla OpenSSH guidelines</a></li>\n</ul>\n<p>The following OpenSSH setup is based on the above guidelines with strong\nalgorithms, and best practices: (EDITED: 10-07-25 to follow best-practices on\npost-quantum crypto)</p>\n<pre><code class=\"language-nix\">{config, ...}: {\n  config = {\n    services = {\n      fail2ban = {\n        enable = true;\n        maxretry = 5;\n        bantime = \"1h\";\n        # ignoreIP = [\n        # \"172.16.0.0/12\"\n        # \"192.168.0.0/16\"\n        # \"2601:881:8100:8de0:31e6:ac52:b5be:462a\"\n        # \"matrix.org\"\n        # \"app.element.io\" # don't ratelimit matrix users\n        # ];\n\n        bantime-increment = {\n          enable = true; # Enable increment of bantime after each violation\n          multipliers = \"1 2 4 8 16 32 64 128 256\";\n          maxtime = \"168h\"; # Do not ban for more than 1 week\n          overalljails = true; # Calculate the bantime based on all the violations\n        };\n      };\n      openssh = {\n        enable = true;\n        settings = {\n          PasswordAuthentication = false;\n          PermitEmptyPasswords = false;\n          PermitTunnel = false;\n          UseDns = false;\n          KbdInteractiveAuthentication = false;\n          X11Forwarding = config.services.xserver.enable;\n          MaxAuthTries = 3;\n          MaxSessions = 2;\n          ClientAliveInterval = 300;\n          ClientAliveCountMax = 0;\n          AllowUsers = [\"your-user\"];\n          TCPKeepAlive = false;\n          AllowTcpForwarding = false;\n          AllowAgentForwarding = false;\n          LogLevel = \"VERBOSE\";\n          PermitRootLogin = \"no\";\n          KexAlgorithms = [\n            # Post-Quantum: https://www.openssh.org/pq.html\n            \"mlkem768x25519-sha256\"\n            \"sntrup761x25519-sha512\"\n            \"curve25519-sha256@libssh.org\"\n            \"ecdh-sha2-nistp521\"\n            \"ecdh-sha2-nistp384\"\n            \"ecdh-sha2-nistp256\"\n            \"diffie-hellman-group-exchange-sha256\"\n          ];\n          Ciphers = [\n            \"aes256-gcm@openssh.com\"\n            \"aes128-gcm@openssh.com\"\n            # stream cipher alternative to aes256, proven to be resilient\n            # Very fast on basically anything\n            \"chacha20-poly1305@openssh.com\"\n            # industry standard, fast if you have AES-NI hardware\n            \"aes256-ctr\"\n            \"aes192-ctr\"\n            \"aes128-ctr\"\n          ];\n          Macs = [\n            # Combines the SHA-512 hash func with a secret key to create a MAC\n            \"hmac-sha2-512-etm@openssh.com\"\n            \"hmac-sha2-256-etm@openssh.com\"\n            \"umac-128-etm@openssh.com\"\n            \"hmac-sha2-512\"\n            \"hmac-sha2-256\"\n            \"umac-128@openssh.com\"\n          ];\n        };\n        # These keys will be generated for you\n        hostKeys = [\n          {\n            path = \"/etc/ssh/ssh_host_ed25519_key\";\n            type = \"ed25519\";\n          }\n        ];\n      };\n    };\n  };\n}\n</code></pre>\n<p>TCP port 22 (ssh) is opened automatically if the SSH daemon is enabled\n(<code>services.openssh.enable = true;</code>)</p>\n<p>Much of the SSH hardening settings came from\n<a href=\"https://ryanseipp.com/post/nixos-secure-ssh/\">ryanseipp‚Äôs secure-ssh Guide</a>\nwith some additions of my own.</p>\n<p>Fail2Ban is an intrusion prevention software framework. It‚Äôs designed to prevent\nbrute-force attacks by scanning log files for suspicious activity, such as\nrepeated failed login attempts.</p>\n<p>OpenSSH is the primary tool for secure remote access for NixOS. Enabling it\nactivates the OpenSSH server on the system, allowing incoming SSH connections.</p>\n<p>The above configuration is a robust setup for securing an SSH server by:</p>\n<ul>\n<li>\n<p>Preventing brute-force attacks with Fail2Ban</p>\n</li>\n<li>\n<p>Eliminating password authentication in favor of more secure SSH keys</p>\n</li>\n<li>\n<p>Restricting user access and preventing root login</p>\n</li>\n<li>\n<p>Disabling potentially risky forwarding features (tunnel, TCP, agent)</p>\n</li>\n<li>\n<p>Enforce the use of strong, modern cryptographic algorithms for all SSH\ncommunications.</p>\n</li>\n<li>\n<p>Enhanced logging for better auditing.</p>\n</li>\n</ul>\n<p>Further Reading:</p>\n<ul>\n<li>\n<p><a href=\"https://www.openssh.com/\">OpenSSH</a></p>\n</li>\n<li>\n<p><a href=\"https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server\">DigitalOcean how fail2ban works</a></p>\n</li>\n</ul>\n<hr />\n<h2>Encrypted Secrets</h2>\n<p>Never store secrets in plain text in repositories. Use something like\n<a href=\"https://github.com/Mic92/sops-nix\">sops-nix</a>, which lets you keep encrypted\nsecrets under version control declaratively.</p>\n<p>Another option is <a href=\"https://github.com/ryantm/agenix\">agenix</a></p>\n<ul>\n<li><a href=\"https://wiki.nixos.org/wiki/Agenix\">NixOS Wiki Agenix</a></li>\n</ul>\n<h3>Sops-nix Guide</h3>\n<p>Protect your secrets, the following guide is on setting up Sops on NixOS:\n<a href=\"https://saylesss88.github.io/installation/enc/sops-nix.html\">Sops Encrypted Secrets</a></p>\n<hr />\n<h2>Auditd</h2>\n<p>To enable the Linux Audit Daemon (<code>auditd</code>) and define a very basic rule set,\nyou can use the following NixOS configuration. This example demonstrates how to\nlog every program execution (<code>execve</code>) on a 64-bit architecture.</p>\n<pre><code class=\"language-nix\"># modules/security/auditd-minimal.nix (or directly in configuration.nix)\n{\n  # start as early in the boot process as possible\n  boot.kernelParams = [\"audit=1\"];\n  security.auditd.enable = true;\n  security.audit.enable = true;\n  security.audit.rules = [\n    # Log all program executions on 64-bit architecture\n    \"-a exit,always -F arch=b64 -S execve\"\n  ];\n}\n</code></pre>\n<ul>\n<li>\n<p><code>audit=1</code> Enables auditing at the kernel level very early in the boot process.\nWithout this, some events could be missed.</p>\n</li>\n<li>\n<p><code>security.auditd.enable = true;</code> Ensures the <code>auditd</code> userspace daemon is\nstarted.</p>\n</li>\n<li>\n<p>While often enabled together, <code>security.audit.enable</code> specifically refers to\nenabling the NixOS module for audit rules generation.</p>\n</li>\n<li>\n<p><code>execve</code> (program executions)</p>\n</li>\n<li>\n<p>This is just a basic configuration, there is much more that can be tracked.</p>\n</li>\n</ul>\n<hr />\n<h2>USB Port Protection</h2>\n<p>It‚Äôs important to protect your USB ports to prevent BadUSB attacks, data\nexfiltration, unauthorized device access, malware injection, etc.</p>\n<p>To get a list of your connected USB devices you can use <code>lsusb</code> from the\n<code>usbutils</code> package.</p>\n<pre><code class=\"language-bash\">lsusb\n</code></pre>\n<p>To list the devices recognized by USBGuard, run:</p>\n<pre><code class=\"language-bash\">sudo usbguard list-devices\n</code></pre>\n<ul>\n<li><a href=\"https://mynixos.com/options/services.usbguard\">MyNixOS services.usbguard</a></li>\n</ul>\n<p>Change <code>your-user</code> to your username:</p>\n<pre><code class=\"language-nix\"># usbguard.nix\n{\n  config,\n  pkgs,\n  lib,\n  ...\n}: let\n  inherit (lib) mkIf;\n  cfg = config.custom.security.usbguard;\nin {\n  options.custom.security.usbguard = {\n    enable = lib.mkEnableOption \"usbguard\";\n  };\n\n  config = mkIf cfg.enable {\n    services.usbguard = {\n      enable = true;\n      IPCAllowedUsers = [\"root\" \"your-user\"];\n    # presentDevicePolicy refers to how to treat USB devices that are already connected when the daemon starts\n      presentDevicePolicy = \"allow\";\n      rules = ''\n        # allow `only` devices with mass storage interfaces (USB Mass Storage)\n        allow with-interface equals { 08:*:* }\n        # allow mice and keyboards\n        # allow with-interface equals { 03:*:* }\n\n        # Reject devices with suspicious combination of interfaces\n        reject with-interface all-of { 08:*:* 03:00:* }\n        reject with-interface all-of { 08:*:* 03:01:* }\n        reject with-interface all-of { 08:*:* e0:*:* }\n        reject with-interface all-of { 08:*:* 02:*:* }\n      '';\n    };\n\n    environment.systemPackages = [pkgs.usbguard];\n  };\n}\n</code></pre>\n<p>The above settings can be found in\n<a href=\"https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/security_guide/sec-using-usbguard\">RedHat UsbGuard</a></p>\n<p>The only <code>allow</code> rule is for devices with <strong>only</strong> mass storage interfaces\n(<code>08:*:*</code>) i.e., USB Mass storage devices, devices like keyboards and mice\n(which use interface class <code>03:*:*</code>) implicitly <strong>not allowed</strong>.</p>\n<p>The <code>reject</code> rules reject devices with a suspicious combination of interfaces. A\nUSB drive that implements a keyboard or a network interface is very suspicious,\nthese <code>reject</code> rules prevent that.</p>\n<p>The <code>presentDevicePolicy = \"allow\";</code> allows any device that is present at daemon\nstart up even if they‚Äôre not explicitly allowed. However, newly plugged in\ndevices must match an <code>allow</code> rule or get denied implicitly.</p>\n<p>The <code>presentDevicePolicy</code> should be one of: # one of <code>\"apply-policy\"</code>(default,\nevaluate the rule set for every present device), <code>\"block\"</code>, <code>\"reject\"</code>, <code>\"keep\"</code>\n(keep whatever state the device is currently in), or <code>\"allow\"</code>, which is used in\nthe example.</p>\n<p>There is also the\n<a href=\"https://github.com/Cropi/usbguard-notifier\">usbguard-notifier</a></p>\n<p>And enable it with the following in your <code>configuration.nix</code> or equivalent:</p>\n<pre><code class=\"language-nix\"># configuration.nix\nimports = [\n    ./usbguard.nix\n];\ncustom.security.usbguard.enable = true;\n</code></pre>\n<blockquote>\n<p>‚ùó If you are ever unsure about a setting that you want to harden and think\nthat it could possibly break your system you can always use a specialisation\nreversing the action and choose it‚Äôs generation at boot up. For example, to\nforce-reverse the above settings you could:</p>\n<pre><code class=\"language-nix\"># configuration.nix\nspecialisation.no-usbguard.configuration = {\n    services.usbguard.enable = lib.mkForce false;\n};\n</code></pre>\n<ul>\n<li>This is a situation where I recommend this, it‚Äôs easy to lock yourself out\nof your keyboard, mouse, etc. when trying to configure this.</li>\n</ul>\n</blockquote>\n<p>Further Reading:</p>\n<ul>\n<li>\n<p><a href=\"https://www.ninjaone.com/it-hub/endpoint-security/what-is-badusb/\">NinjaOne BadUSB</a></p>\n</li>\n<li>\n<p><a href=\"https://usbguard.github.io/\">USBGuard</a></p>\n</li>\n<li>\n<p><a href=\"https://www.cyberciti.biz/security/how-to-protect-linux-against-rogue-usb-devices-using-usbguard/\">NixCraft USBGuard</a></p>\n</li>\n</ul>\n<hr />\n<h2>Doas over sudo (Warning Doas is unmaintained)</h2>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Unmaintained Doas example </summary>\n<blockquote>\n<p>NOTE: I have moved to <code>run0</code> for authentication which is included by default\nwith systemd. It‚Äôs actually a symlink to the existing <code>systemd-run</code> tool. It\nbehaves like a secure <code>sudo</code> alternative: it spawns a transient service under\nPID 1 for privilege escalation, without relying on SUID (set user ID)\nbinaries.</p>\n</blockquote>\n<blockquote>\n<p>‚ö†Ô∏è Warning the Nixpkgs version of <code>doas</code>,\n<a href=\"https://github.com/Duncaen/OpenDoas\">OpenDoas</a> is unmaintained and hasn‚Äôt\nbeen updated in 3 to 4 years. If you don‚Äôt like <code>run0</code>, consider using\n<code>sudo-rs</code>. I‚Äôm leaving this here for now, may remove it in the future to not\npromote using unmaintained software, you‚Äôve been warned.</p>\n</blockquote>\n<ul>\n<li>\n<p><a href=\"https://mastodon.social/@pid_eins/112353324518585654\">Why run0</a></p>\n</li>\n<li>\n<p>SUID = ‚ÄúSet User ID‚Äù: When a binary has the SUID bit set, it runs with the\nprivileges of the file‚Äôs owner (often root). There is a long history of\nvulnerabilities with SUID binaries.</p>\n</li>\n</ul>\n<p>For a more minimalist version of <code>sudo</code> with a smaller codebase and attack\nsurface, consider <code>doas</code>. Replace <code>userName</code> with your username:</p>\n<pre><code class=\"language-nix\"># doas.nix\n{\n  lib,\n  config,\n  pkgs, # Add pkgs if you need to access user information\n  ...\n}: let\n  cfg = config.custom.security.doas;\nin {\n  options.custom.security.doas = {\n    enable = lib.mkEnableOption \"doas\";\n  };\n\n  config = lib.mkIf cfg.enable {\n    # Disable sudo\n    security.sudo.enable = false;\n\n    # Enable and configure `doas`.\n    security.doas = {\n      enable = true;\n      extraRules = [\n        {\n          # Grant doas access specifically to your user\n          users = [\"userName\"]; # &lt;--- Only give access to your user\n          # persist = true; # Convenient but less secure\n          # noPass = true;    # Convenient but even less secure\n          keepEnv = true; # Often necessary\n          # Optional: You can also specify which commands they can run, e.g.:\n          # cmd = \"ALL\"; # Allows running all commands (default if not specified)\n          # cmd = \"/run/current-system/sw/bin/nixos-rebuild\"; # Only allow specific command\n        }\n      ];\n    };\n\n    # Add an alias to the shell for backward-compat and convenience.\n    environment.shellAliases = {\n      sudo = \"doas\";\n    };\n  };\n}\n</code></pre>\n<p>You would then import this into your <code>configuration.nix</code> and enable/disable it\nwith the following:</p>\n<pre><code class=\"language-nix\"># configuration.nix\n\nimports = [\n    ./doas.nix\n];\n\ncustom.security.doas.enable = true;\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: Many people opt for the less secure <code>groups = [\"wheel\"];</code> in the\nabove configuration instead of <code>users = [\"userName\"];</code> to give wider access,\nthe choice is yours.</p>\n</blockquote>\n</details>\n<hr />\n<h2>Firejail</h2>\n<blockquote>\n<p>‚ùóÔ∏è Critics such as madaidan say that Firejail worsens security by acting as a\nprivilege escalation hole. Firejail requires the executable to be setuid,\nmeaning it runs with root privileges.This is risky because any vulnerability\nin Firejail can lead to privilege escalation. This combined with many\nconvenience features and complicated command line flags leads to a large\nattack surface.</p>\n</blockquote>\n<ul>\n<li>\n<p>I haven‚Äôt personally tried\n<a href=\"https://github.com/Naxdy/nix-bwrapper\">nix-bwrapper</a> myself yet, but it‚Äôs\nanother sandboxing option that looks interesting. Bubblewrap is known for\nhaving a more minimal design and smaller attack surface.</p>\n<ul>\n<li>Also see: <a href=\"#flatpak\">Flatpak section</a> for another option for sandboxing.</li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://sr.ht/~fgaz/nix-bubblewrap/\">nix-bubblewrap</a> is another option.</p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Firejail\">NixOS Wiki Firejail</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.archlinux.org/title/Firejail\">Arch Wiki Firejail</a></p>\n</li>\n</ul>\n<blockquote>\n<p>‚ùó WARNING: Running untrusted code is never safe, sandboxing cannot change\nthis. ‚ÄìArch Wiki</p>\n</blockquote>\n<pre><code class=\"language-nix\"># firejail.nix\n{\n  pkgs,\n  lib,\n  ...\n}: {\n  programs.firejail = {\n    enable = true;\n    wrappedBinaries = {\n      # Sandbox a web browser\n      librewolf = {\n        executable = \"${lib.getBin pkgs.librewolf}/bin/librewolf\";\n        profile = \"${pkgs.firejail}/etc/firejail/librewolf.profile\";\n      };\n      # Sandbox a file manager\n      thunar = {\n        executable = \"${lib.getBin pkgs.xfce.thunar}/bin/thunar\";\n        profile = \"${pkgs.firejail}/etc/firejail/thunar.profile\";\n      };\n      # Sandbox a document viewer\n      zathura = {\n        executable = \"${lib.getBin pkgs.zathura}/bin/zathura\";\n        profile = \"${pkgs.firejail}/etc/firejail/zathura.profile\";\n      };\n    };\n  };\n}\n</code></pre>\n<p><code>wrappedBinaries</code> is a list of applications you want to run inside a sandbox.\nOnly the apps in the <code>wrappedBinaries</code> attribute set will be automatically\nfirejailed when launched the usual way.</p>\n<p>Other apps may be started manually using <code>firejail &lt;app&gt;</code>, or added to\n<code>wrappedBinaries</code> if you want automatic sandboxing, just make sure the profile\nexists.</p>\n<p>To inspect which profiles are available, after rebuilding go to <code>/nix/store/</code>, I\nused Yazi to search for <code>/firejail</code> and followed it to <code>firejail/etc</code>, where the\nprofiles are.</p>\n<p>There are many flags and options available with firejail, I suggest checking out\n<code>man firejail</code>.</p>\n<p>There are comments explaining what‚Äôs going on in:\n<a href=\"https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/fi/firejail/package.nix\">firejail/package.nix</a></p>\n<p>Firejail is a SUID program that reduces the risk of security breaches by\nrestricting the running environment of untrusted applications using\n<a href=\"https://lwn.net/Articles/531114/\">Linux namespaces</a> and\n<a href=\"https://l3net.wordpress.com/2015/04/13/firejail-seccomp-guide/\">seccomp-bpf</a>‚Äì<a href=\"https://firejail.wordpress.com/\">Firejail Security Sandbox</a></p>\n<p>It provides sandboxing and access restriction per application, much like what\nAppArmor/SELinux does at a kernel level. However, it‚Äôs not as secure or\ncomprehensive as kernel-enforced MAC systems (AppArmor/SELinux), since it‚Äôs a\nuserspace tool and can potentially be bypassed by privilege escalation exploits.</p>\n<hr />\n<h2>Flatpak</h2>\n<blockquote>\n<p>‚ùóÔ∏èNOTE: You cannot effectively use Firejail with Flatpak apps because of how\ntheir sandboxing technologies operate. Flatpak also won‚Äôt work with the\nhardened kernel because they require unprivileged user namespaces which the\nhardened kernel completely disables.</p>\n</blockquote>\n<p>Apps that don‚Äôt have a flatpak equivalent can be further hardened with\nbubblewrap independently but bubblewrap is not needed on Flatpak apps.</p>\n<p>Because of this limited native MAC (Mandatory Access Control) support on NixOS,\nusing Flatpak is often a good approach to get sandboxing and isolation for many\nGUI apps.</p>\n<ul>\n<li>\n<p>Flatpak bundles runtimes and sandbox mechanisms that provide app isolation\nindependently of the host system‚Äôs AppArmor or SELinux infrastructure. This\ncan improve security and containment for GUI applications running on NixOS\ndespite the system lacking full native MAC coverage.</p>\n</li>\n<li>\n<p>Flatpak apps benefit from sandboxing through bubblewrap, which isolate apps\nand restrict access to user/home and system resources.</p>\n</li>\n</ul>\n<p>Add Flatpak with the FlatHub repository for all users:</p>\n<pre><code class=\"language-nix\">services.flatpak.enable = true;\n  systemd.services.flatpak-repo = {\n    wantedBy = [ \"multi-user.target\" ];\n    path = [ pkgs.flatpak ];\n    script = ''\n      flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo\n      # Only apps that are verified\n      # flatpak remote-add --if-not-exists --subset=verified flathub-verified https://flathub.org/repo/flathub.flatpakrepo\n    '';\n  };\nxdg = {\n  portal = {\n    enable = true;\n    extraPortals = [ pkgs.xdg-desktop-portal-gtk ];\n    config.common.default = [ \"gtk\" ];\n  };\n};\n# Disables screencopy\nsystemd.user.services.\"xdg-desktop-portal-wlr\" = {\n  enable = false;\n};\n</code></pre>\n<ul>\n<li>\n<p><a href=\"https://docs.flathub.org/docs/for-users/verification\">Flathub Verified Apps</a></p>\n</li>\n<li>\n<p><a href=\"https://secureblue.dev/articles/flatpak\">Flatpak the good the bad the ugly</a></p>\n</li>\n</ul>\n<p>Then you can either find apps through <a href=\"https://flathub.org/en\">FlatHub</a> or on\nthe cmdline with <code>flatpak search &lt;app&gt;</code>. Flatpak is best used for GUI apps, some\nCLI apps can be installed through it but not all.</p>\n<ul>\n<li>\n<p>There is also <a href=\"https://github.com/gmodena/nix-flatpak\">nix-flatpak</a>, which\nenables you to manage your flatpaks declaratively.</p>\n</li>\n<li>\n<p><a href=\"https://flathub.org/en/apps/com.github.tchx84.Flatseal\">Flatseal</a> is GUI\nutility that enables you to review and modify permissions from your Flatpak\napps. Many apps by default come with smart-card support, X11 &amp; Wayland\nsupport, and more, disabling unnecessary permissions is recommended.</p>\n</li>\n<li>\n<p><a href=\"https://flathub.org/en/apps/io.github.flattool.Warehouse\">Warehouse</a> provides\na simple UI to control complex Flatpak options, no cmdline required.</p>\n</li>\n</ul>\n<p>I have heard that it is not recommended to use Flatpak browsers because in order\nfor flatpak to work it has to disable some of the built-in browser sandboxing\nwhich can reduce security. I haven‚Äôt found any examples of Flatpak browsers\nbeing exploited but it‚Äôs something to keep in mind.</p>\n<hr />\n<h2>SeLinux/AppArmor MAC (Mandatory Access Control)</h2>\n<p><strong>AppArmor</strong> is available on NixOS, but is still in a somewhat experimental and\nevolving state. There are only a few profiles that have been adapted to NixOS,\nsee here\n<a href=\"https://discourse.nixos.org/t/apparmor-default-profiles/16780\">Discourse on default-profiles</a>\nWhich guides you here\n<a href=\"https://github.com/NixOS/nixpkgs/blob/2acaef7a85356329f750819a0e7c3bb4a98c13fe/nixos/modules/security/apparmor/includes.nix\">apparmor/includes.nix</a>\nwhere you can see some of the abstractions and tunables to follow progress.</p>\n<p><strong>SELinux</strong>: Experimental, not fully integrated, recent progress for\nadvanced/curious users; expect rough edges and manual intervention if you want\nto try it. Most find SELinux more complex to configure and maintain than\nAppArmor.</p>\n<p>This isn‚Äôt meant to be a comprehensive guide, more to get people thinking about\nsecurity on NixOS.</p>\n<p>See the following guide on hardening networking:</p>\n<ul>\n<li><a href=\"https://saylesss88.github.io/nix/hardening_networking.html\">Hardening Networking</a></li>\n</ul>\n<hr />\n<h2>Resources</h2>\n<h3>Advanced Hardening with <code>nix-mineral</code> (Community Project)</h3>\n<details>\n<summary> ‚úîÔ∏è Click to Expand section on `nix-mineral` </summary>\n<p>For users seeking a more comprehensive and opinionated approach to system\nhardening beyond the built-in <code>hardened</code> profile, the community project\n<a href=\"https://github.com/cynicsketch/nix-mineral\"><code>nix-mineral</code></a> offers a declarative\nNixOS module.</p>\n<p><code>nix-mineral</code> aims to apply a wide array of security configurations, focusing on\ntweaking kernel parameters, system settings, and file permissions to reduce the\nattack surface.</p>\n<ul>\n<li><strong>Community Project Status:</strong> <code>nix-mineral</code> is a community-maintained project\nand is not officially part of the Nixpkgs repository or NixOS documentation.\nIts development status is explicitly stated as ‚ÄúAlpha software,‚Äù meaning it\nmay introduce stability issues or unexpected behavior.</li>\n</ul>\n<p>For detailed information on <code>nix-mineral</code>‚Äôs capabilities and current status,\nrefer directly to its\n<a href=\"https://github.com/cynicsketch/nix-mineral\">GitHub repository</a>.</p>\n</details>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Resources </summary>\n<ul>\n<li>\n<p><a href=\"https://hedgedoc.grimmauld.de/s/hWcvJEniW#\">AppArmor and apparmor.d on NixOS</a></p>\n</li>\n<li>\n<p><a href=\"https://tristanxr.com/post/selinux-on-nixos/\">SELinux on NixOS</a></p>\n</li>\n<li>\n<p><a href=\"https://xeiaso.net/blog/paranoid-nixos-2021-07-18/\">Paranoid NixOS</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Security\">NixOS Wiki Security</a></p>\n</li>\n<li>\n<p><a href=\"https://nixos.org/manual/nixos/unstable/index.html#sec-luks-file-systems\">Luks Encrypted File Systems</a></p>\n</li>\n<li>\n<p><a href=\"https://discourse.nixos.org/t/a-modern-and-secure-desktop-setup/41154\">Discourse A Modern and Secure Desktop</a></p>\n</li>\n<li>\n<p><a href=\"https://notashelf.dev/posts/insecurities-remedies-i\">notashelf NixOS Security 1 Systemd</a></p>\n</li>\n<li>\n<p><a href=\"https://ryanseipp.com/post/hardening-nixos/\">ryanseipp hardening-nixos</a></p>\n</li>\n<li>\n<p><a href=\"https://madaidans-insecurities.github.io/guides/linux-hardening.html\">madaidans Linux Hardening Guide</a></p>\n</li>\n<li>\n<p><a href=\"https://cybersecuritynews.com/hardening-linux-servers\">Hardening-Linux-Servers</a></p>\n</li>\n<li>\n<p><a href=\"https://linux-audit.com/linux-server-hardening-most-important-steps-to-secure-systems/\">linux-audit Linux Server hardening best practices</a></p>\n</li>\n<li>\n<p><a href=\"https://linux-audit.com/linux-security-guide-extended-version/\">linux-audit Linux security guide extended</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.archlinux.org/title/Security\">Arch Wiki Security</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.gentoo.org/wiki/Security_Handbook/Concepts\">Gentoo Security_Handbook Concepts</a></p>\n</li>\n<li>\n<p><a href=\"https://secureblue.dev/faq\">secureblue FAQ</a></p>\n</li>\n<li>\n<p><a href=\"https://www.kicksecure.com/wiki/Documentation\">Excellent Kicksecure Docs</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/decalage2/awesome-security-hardening\">Awesome-Security-Hardening List</a></p>\n</li>\n<li>\n<p><a href=\"https://factorable.net/faq.html\">factorable.net (study of RSA and DSA crypto keys) FAQ</a></p>\n</li>\n<li>\n<p><a href=\"https://blog.cr.yp.to/20140205-entropy.html\">The cr.yp.to blog Entropy</a></p>\n</li>\n<li>\n<p><a href=\"https://delroth.net/posts/nixos-security-wishlist/\">NixOS Security wishlist</a></p>\n</li>\n<li>\n<p><a href=\"https://beej.us/guide/bgipc/html/\">Beejus IPC guide</a></p>\n</li>\n<li>\n<p><a href=\"https://www.geeksforgeeks.org/operating-systems/inter-process-communication-ipc/\">GeeksforGeeks IPC</a></p>\n</li>\n</ul>\n<p>neal.codes vulnerability scan script:</p>\n<pre><code class=\"language-bash\">nix-shell -p grype sbomnix --run '\n  sbomnix /run/current-system --csv /dev/null --spdx /dev/null --cdx sbom.cdx.json;\n  grype sbom.cdx.json\n'\n</code></pre>\n<ul>\n<li>\n<p><a href=\"https://github.com/nealfennimore/nixos-stig-anduril\">neal.codes nixos-stig-anduril</a></p>\n</li>\n<li>\n<p><a href=\"https://www.suse.com/c/linux-hardeningthe-complete-guide-to-securing-your-systems/\">Suse Linux Hardening Guide</a></p>\n</li>\n</ul>\n<p><strong>Government Resources 1st 6 come from gentoo‚Äôs Security_Handbook)</strong></p>\n<ul>\n<li>\n<p><a href=\"https://www.cyber.gov.au/sites/default/files/2023-03/Information%20Security%20Manual%20-%20%28March%202023%29.pdf\">The Austrailian Cyber Security Centre‚Äôs Informational Security Manual (ISM)</a></p>\n</li>\n<li>\n<p><a href=\"https://www.protectivesecurity.gov.au/policies\">The Australian Government‚Äôs Protective Security Policy Framework (PSPF)</a></p>\n</li>\n<li>\n<p><a href=\"https://www.cyber.gov.au/protect-yourself\">The Australian Cyber Security Centre‚Äôs Protect Yourself page</a></p>\n</li>\n<li>\n<p><a href=\"https://www.gov.uk/government/publications/security-policy-framework/hmg-security-policy-framework\">The UK Government‚Äôs Security Policy Framework (SPF)</a></p>\n</li>\n<li>\n<p><a href=\"https://www.gov.uk/government/publications/information-security-policy-framework\">The UK Government‚Äôs Information Security Policy Framework (ISF)</a></p>\n</li>\n<li>\n<p><a href=\"https://www.nist.gov/cybersecurity\">The US National Institute of Standards and Technology‚Äôs Cybersecurity page</a></p>\n</li>\n<li>\n<p><a href=\"https://stigviewer.com/stigs/anduril_nixos\">NixOS STIG</a></p>\n</li>\n<li>\n<p>STIGs are configuration standards developed by the Defense Information Systems\nAgency (DISA) to secure systems and software for the U.S. Department of\nDefense (DoD). They are considered a highly authoritative source for system\nhardening.There are recommendations for hardening all kinds of software in the\n<a href=\"https://stigviewer.com/stigs\">Stig Viewer</a></p>\n</li>\n<li>\n<p><a href=\"https://www.cisecurity.org/cis-benchmarks\">CIS Benchmarks</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/nsacyber\">NSA Cybersecurity Directorate</a></p>\n</li>\n</ul>\n</details>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/sops-nix.html",
      "url": "https://saylesss88.github.io/nix/sops-nix.html",
      "title": "Sops-Nix",
      "content_html": "<h1>Sops-Nix encrypted secrets</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p><a href=\"https://github.com/getsops/sops?ref=blog.gitguardian.com\">SOPS</a>, short for\n<strong>S</strong>ecrets<strong>OP</strong>eration<strong>S</strong>, is an editor of encrypted files that supports\nquite a few BINARY formats and encrypts with AWS KMS, GCP KMS, Azure Key Vault,\nage, and PGP.</p>\n<p>Managing secrets‚Äîlike API keys, SSH deploy keys, and password hashes is a\ncritical part of system configuration, but it‚Äôs also one of the trickiest to do\nsecurely and reproducibly. Traditionally, secrets might be stored in ad hoc\nlocations, referenced by absolute paths, or managed manually outside of version\ncontrol. This approach makes it hard to share, rebuild, or audit your\nconfiguration, and increases the risk of accidental leaks or inconsistencies\nbetween systems.</p>\n<p><code>sops-nix</code> solves these problems by integrating Mozilla SOPS directly into your\nNixOS configuration. Instead of relying on hardcoded file paths or copying\nsecrets around, you declare your secrets in your Nix code, encrypt them with\nstrong keys, and let <code>sops-nix</code> handle decryption and placement at activation\ntime.</p>\n<p>Encryption with strong keys, as used by sops-nix, makes brute force attacks\ncomputationally unfeasible with current technology‚Äîthe time and resources\nrequired to try every possible key would be astronomically high. However, this\nprotection relies on using strong, secret keys and good security practices;\nadvances in technology or poor key management can weaken this defense.</p>\n<blockquote>\n<p>‚ùó <strong>CRITICAL SECURITY NOTE:</strong> While the encryption itself is robust, this\nprotection fundamentally relies on using <strong>strong, secret keys</strong> and\n<strong>diligent security practices</strong>. If your PGP passphrase is weak, your Age\nprivate key is easily guessable, or the cleartext secret itself is very short\nand has low entropy (e.g., ‚Äú12345‚Äù, ‚Äútrue‚Äù, ‚Äúadmin‚Äù), an attacker might be\nable to compromise your secrets regardless of the encryption.</p>\n</blockquote>\n<ol>\n<li>Add sops to your <code>flake.nix</code>:</li>\n</ol>\n<pre><code class=\"language-nix\">{\n  inputs.sops-nix.url = \"github:Mic92/sops-nix\";\n  inputs.sops-nix.inputs.nixpkgs.follows = \"nixpkgs\";\n\n  outputs = { self, nixpkgs, sops-nix }: {\n    # change `yourhostname` to your actual hostname\n    nixosConfigurations.yourhostname = nixpkgs.lib.nixosSystem {\n      # customize to your system\n      system = \"x86_64-linux\";\n      modules = [\n        ./configuration.nix\n        sops-nix.nixosModules.sops\n      ];\n    };\n  };\n}\n</code></pre>\n<ol start=\"2\">\n<li>Add <code>sops</code> and <code>age</code> to your <code>environment.systemPackages</code>:</li>\n</ol>\n<pre><code class=\"language-nix\">environment.systemPackages = [\n    pkgs.sops\n    pkgs.age\n];\n</code></pre>\n<ol start=\"3\">\n<li>Generate a key (This is your <strong>private key</strong> and <strong>MUST NEVER BE COMMITTED TO\nGIT OR SHARED</strong>):</li>\n</ol>\n<pre><code class=\"language-bash\">mkdir -p ~/.config/sops/age\nage-keygen -o ~/.config/sops/age/keys.txt\n</code></pre>\n<p>To get the Public Keys Value, run the following command:</p>\n<pre><code class=\"language-bash\">age-keygen -y ~/.config/sops/age/keys.txt\nage12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl\n</code></pre>\n<p>Copy the <code>age</code> value it gives you back.</p>\n<ol start=\"4\">\n<li>Create a <code>.sops.yaml</code> in the same directory as your <code>flake.nix</code>:</li>\n</ol>\n<pre><code class=\"language-yaml\"># .sops.yaml\nkeys:\n  # Your personal age public key (from age-keygen -y ~/.config/sops/age/keys.txt)\n  - &amp;personal_age_key age12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl\n\n  # You can also use PGP keys if you prefer, but age is often simpler\n  # - &amp;personal_pgp_key 0xDEADBEEFCAFE0123\n\ncreation_rules:\n  # This rule applies to any file named 'secrets.yaml' directly in the 'secrets/' directory\n  # or 'secrets/github-deploy-key.yaml' etc.\n  - path_regex: \"secrets/.*\\\\.yaml$\"\n    key_groups:\n      - age:\n          - *personal_age_key\n        # Add host keys for decryption on the target system\n        # sops-nix will automatically pick up the system's SSH host keys\n        # as decryption keys if enabled in your NixOS config.\n        # So you typically don't list them explicitly here unless you\n        # want to restrict it to specific fingerprints, which is rare.\n        # This part ensures your *personal* key can decrypt it.\n</code></pre>\n<p>Save it and move on, this file and <code>sops.nix</code> are safe to version control.</p>\n<ol start=\"5\">\n<li>sops-nix‚Äôs automatic decryption feature using system SSH host keys only works\nwith ed25519 host keys for deriving Age decryption keys. Therefore, for\nsystem decryption, ensure you‚Äôre using ed25519 not rsa keys:</li>\n</ol>\n<pre><code class=\"language-bash\">ssh-keygen -t ed25519 -C \"your_email@example.com\"\n# for multiple keys run something like\nssh-keygen -t ed25519 -f ~/nix-book-deploy-key -C \"deploy-key-nix-book-repo\"\n</code></pre>\n<ol start=\"6\">\n<li>Copy the <strong>PRIVATE</strong> key for each and add them to your secrets directory:</li>\n</ol>\n<p>While in your flake directory:</p>\n<pre><code class=\"language-bash\">mkdir secrets\nsops secrets/github-deploy-key.yaml  # For your github ssh key\n</code></pre>\n<p>When you call a <code>sops</code> command, it will handle the encryption/decryption\ntransparently and open the cleartext file in an editor.</p>\n<p>Editing will happen in the editor that <code>$SOPS_EDITOR</code> or <code>$EDITOR</code> is set to,\nsops will wait for the editor to exit, and then try to reencrypt the file.</p>\n<p>The above command will open a default sops <code>github-deploy-key.yaml</code> in your\n<code>$EDITOR</code>:</p>\n<p>Erase the default <code>sops</code> filler and type <code>github_deploy_key_ed25519: |</code>, move\nyour cursor 1 line down and type <code>:r ~/.ssh/id_ed25519</code> to read the private key\ninto the file and repeat as needed.</p>\n<pre><code class=\"language-yaml\">github_deploy_key_ed25519: |\n  -----BEGIN OPENSSH PRIVATE KEY-----\n  ...\n  -----END OPENSSH PRIVATE KEY-----\n\ngithub_deploy_key_ed25519_nix-book: |\n  -----BEGIN OPENSSH PRIVATE KEY-----\n  ...\n  -----END OPENSSH PRIVATE KEY-----\n</code></pre>\n<p>The <code>-----BEGIN</code> and the rest of the private key <strong>must</strong> be indented 2 spaces</p>\n<p>Ensure sops can decrypt it:</p>\n<pre><code class=\"language-bash\">sops -d secrets/github-deploy-key.yaml\n</code></pre>\n<blockquote>\n<p>‚ùó WARNING: Only ever enter your private keys through the <code>sops</code> command. If\nyou forget and paste them in without the <code>sops</code> command then run <code>git add</code> at\nany point, your git history will have contained an unencrypted secret which is\na nono. Always use the <code>sops</code> command when dealing with files in the <code>secrets</code>\ndirectory, save the file and inspect that it is encrypted on save. If not\nsomething went wrong with the <code>sops</code> process, <strong>do not add it to Git</strong>. If you\ndo, you will be required to rewrite your entire history which can be bad if\nyou‚Äôre collaborating with others. <code>git-filter-repo</code> is one such solution that\nrewrites your history. Just keep this in mind. This happens because Git has a\nprotection that stops you from doing stupid things.</p>\n</blockquote>\n<p>Generate an encrypted password hash with:</p>\n<pre><code class=\"language-bash\">mkpasswd -m SHA-512 -s &gt; /tmp/password-hash.txt\n# Enter your chosen password and copy the encrypted hash it gives you back\n</code></pre>\n<pre><code class=\"language-bash\">sops secrets/password-hash.yaml      # For your `hashedPasswordFile`\n</code></pre>\n<p>The above command will open your <code>$EDITOR</code> with the file <code>password-hash.yaml</code>,\nadd the following content to it. Replace <code>PasteEncryptedHashHere</code> with the\noutput of the <code>mkpasswd</code> command above:</p>\n<p>Delete the default <code>sops</code> filler, type <code>password_hash:</code> and leave your cursor\nafter the <code>:</code> and type <code>:r /tmp/password-hash.txt</code></p>\n<pre><code class=\"language-yaml\">password_hash: PasteEncryptedHashHere\n</code></pre>\n<p>Ensure sops can decrypt it:</p>\n<pre><code class=\"language-bash\">sops -d secrets/password-hash.yaml\n</code></pre>\n<ol start=\"7\">\n<li>Create a <code>sops.nix</code> and import it or add this directly to your\n<code>configuration.nix</code>:</li>\n</ol>\n<p>My <code>sops.nix</code> is located at <code>~/flake/hosts/hostname/sops.nix</code> and the secrets\ndirectory is located at <code>~/flake/secrets</code> so the path from <code>sops.nix</code> to\n<code>secrets/pasword-hash.yaml</code> would be <code>../../secrets/password-hash.yaml</code></p>\n<p>Another step you can take is to copy your key to a persistent location,\npreparing for impermanence:</p>\n<pre><code class=\"language-bash\">sudo mkdir /persist/sops/age\nsudo cp ~/.config/sops/age/keys.txt /persist/sops/age/keys.txt\n</code></pre>\n<p>Then you would change the <code>age.keyFile = \"/persist/sops/age/keys.txt\"</code> to match\nthis location below.</p>\n<pre><code class=\"language-nix\"># ~/flake/hosts/magic/sops.nix  # magic is my hostname\n# hosts/magic/ is also where my configuration.nix is\n{...}: {\n  sops = {\n    defaultSopsFile = ../../.sops.yaml; # Or the correct path to your .sops.yaml\n    age.sshKeyPaths = [];\n    age.keyFile = \"/home/jr/sops/age/keys.txt\";\n\n    secrets = {\n      \"password_hash\" = {\n        sopsFile = ../../secrets/password-hash.yaml; # &lt;-- Points to your password hash file\n        owner = \"root\";\n        group = \"root\";\n        mode = \"0400\";\n        neededForUsers = true;\n      };\n      \"github_deploy_key_ed25519_nix-book\" = {\n        sopsFile = ../../secrets/github-deploy-key.yaml;\n        key = \"github_deploy_key_ed25519_nix-book\";\n        owner = \"root\";\n        group = \"root\";\n        mode = \"0400\";\n      };\n      \"github_deploy_key_ed25519\" = {\n        sopsFile = ../../secrets/github-deploy-key.yaml;\n        key = \"github_deploy_key_ed25519\";\n        owner = \"root\";\n        group = \"root\";\n        mode = \"0400\";\n      };\n    };\n  };\n}\n</code></pre>\n<p>Import <code>sops.nix</code> into your <code>configuration.nix</code> or equivalent:</p>\n<pre><code class=\"language-nix\"># configuration.nix\nimports = [\n  ./sops.nix # Assuming sops.nix is in the same directory as configuration.nix, adjust path as needed\n  # ... other imports\n];\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: You may see in the sops quickstart guide that if you‚Äôre using\nimpermanence, the key used for secret decryption (<code>sops.age.keyFile</code>) must be\nin a persistent directory, loaded early enough during the boot process. If you\nare using the btrfs subvolume layout you don‚Äôt need to worry about this\nbecause your home will be on its own partition when only the root partition is\nwiped on reboot. Adding <code>neededForUsers = true;</code> tells <code>sops-nix</code> to decrypt\nand make that secret available earlier in the boot process‚Äìspecifically,\nbefore user and group accounts are created.</p>\n</blockquote>\n<p>You typically use <code>age.sshKeyPaths</code> for <strong>system-level secrets</strong> with a\npersistent SSH host key</p>\n<p>For <strong>user-level secrets</strong>, use <code>age.keyFile</code> pointing to your Age private key,\nstored in a safe persistent location.</p>\n<p>For reproducibility, keep your key files in a persistent, predictable path and\ndocument which keys are used for which secrets in your <code>.sops.yaml</code>.</p>\n<p>If you don‚Äôt need both <code>age.keyFile</code> and <code>age.sshKeyPaths</code> it can reduce\ncomplexity to use one or the other. Although most people may choose one, it‚Äôs\nnot bad to use both it just adds complexity.</p>\n<p>And finally use the password-hash for your <code>hashedPasswordFile</code> for your user,\nmy user is <code>jr</code> so I added this:</p>\n<pre><code class=\"language-nix\"># ... snip ...\n    users.users = {\n      # ${username} = {\n      jr = {\n        homeMode = \"755\";\n        isNormalUser = true;\n        # description = userVars.gitUsername;\n        hashedPasswordFile = config.sops.secrets.password_hash.path;\n  # ...snip...\n</code></pre>\n<ol start=\"8\">\n<li>Rebuild your configuration and you should see something like this:</li>\n</ol>\n<pre><code class=\"language-bash\">sops-install-secrets: Imported /etc/ssh/ssh_host_ed25519_key as age key with fingerprint age1smamdkzrwpdxw63hrxxcq8kmejsm4olknsrg72vd0qtfpmlzlvnf8uws38mzuj\n</code></pre>\n<p>By integrating SOPS with NixOS through <code>sops-nix</code>, you gain a modern, secure,\nand reproducible way to manage sensitive secrets. Unlike traditional\napproaches‚Äîwhere secrets are often scattered in ad hoc locations, referenced by\nabsolute paths, or managed outside version control‚Äîsops-nix keeps your secrets\nencrypted, declarative, and version-control friendly.</p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/nix/nixLang/nix_paths.html",
      "url": "https://saylesss88.github.io/nix/nixLang/nix_paths.html",
      "title": "Nix Paths",
      "content_html": "<h1>Nix Paths</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p>The following examples are done with a local <code>nixpkgs</code> clone located at\n<code>~/src/nixpkgs</code></p>\n<p>Paths in Nix always need a <code>/</code> in them and always expand to absolute paths\nrelative to your current directory.</p>\n<pre><code class=\"language-bash\">nix repl\nnix-repl&gt; ./.\n/home/jr/src/nixpkgs\nnix-repl&gt; ./. + \"/lib\"\n/home/jr/src/nixpkgs/lib\n</code></pre>\n<p>Nix does <em>path normalization</em> every time you append strings, so if you just add\na slash <code>/</code> its not actually there:</p>\n<pre><code class=\"language-bash\">nix-repl&gt; ./.\n/home/jr/src/nixpkgs\nnix-repl&gt; ./. + \"/\"\n/home/jr/src/nixpkgs\nnix-repl&gt; ./. + \"/\" + \"lib\"\n/home/jr/src/nixpkgslib\nnix-repl&gt; \"${./.}/lib\"\n# using ${./.} causes a store copy\ncopying '/homr/jr/src/nixpkgs' to the store\n\"/nix/store/3z9fzx8z03wslxvri5syv3jnnhn5fkbd-nixpkgs/lib\"\nnix-repl&gt; \"${toString ./.}/lib\"\n# using toString avoids making a store copy\n\"/home/jr/src/nixpkgs/lib\"\nnix-repl&gt; ./lib/..             # nix removes all `..` to avoid redundant path resolutions\n/home/jr/src/nixpkgs\nnix-repl&gt; :q\n</code></pre>\n<pre><code class=\"language-bash\">realpath ./lib/..\n/home/jr/src/nixpkgs\nln -s pkgs/applications lib-symlink\nrealpath ./lib-symlink/..\n/home/jr/src/nixpkgs/pkgs\nnix repl\nnix-repl&gt; ./lib-symlink/..   # Nix doesn't read this file at all like realpath did\n/home/jr/src/nixpkgs\nnix-repl&gt; builtins.readDir ./. # listing of all entries in current dir and their types\n{\n  \".devcontainer\" = \"directory\";\n  \".editorconfig\" = \"regular\";\n  \".git\" = \"directory\";\n  \".git-blame-ignore-revs\" = \"regular\";\n  \".gitattributes\" = \"regular\";\n  \".github\" = \"directory\";\n  \".gitignore\" = \"regular\";\n  \".mailmap\" = \"regular\";\n  \".mergify.yml\" = \"regular\";\n  \".version\" = \"symlink\";\n  \"CONTRIBUTING.md\" = \"regular\";\n  COPYING = \"regular\";\n  \"README.md\" = \"regular\";\n  ci = \"directory\";\n  \"default.nix\" = \"regular\";\n  doc = \"directory\";\n  \"flake.nix\" = \"regular\";\n  lib = \"directory\";\n  maintainers = \"directory\";\n  nixos = \"directory\";\n  pkgs = \"directory\";\n  \"shell.nix\" = \"regular\";\n}\nnix-repl&gt; builtins.readFile ./default.nix\n\"let\\n  requiredVersion = import ./lib/minver.nix;\\nin\\n\\nif !builtins ? nixVersion\n || builtins.compareVersions requiredVersion builtins.nixVersion == 1 then\\n\\n  abort\n ''\\n\\n    This version of Nixpkgs requires Nix &gt;= \\${requiredVersion}, please\n upgrade:\\n\\n    - If you are running NixOS, `nixos-rebuild' can be used to upgrade\n your system.\\n\\n    - Alternatively, with Nix &gt; 2.0 `nix upgrade-nix' can be used\n to imperatively\\n      upgrade Nix. You may use `nix-env --version' to check which\n version you have.\\n\\n    - If you installed Nix using the install script (https://nixos.org/nix/install),\\n\n  it is safe to upgrade by running it again:\\n\\n          curl -L https://nixos.org/nix/install | sh\\n\\n\nFor more information, please see the NixOS release notes at\\n    https://nixos.org/nixos/manual\n or locally at\\n    \\${toString ./nixos/doc/manual/release-notes}.\\n\\n    If you need further help,\n see https://nixos.org/nixos/support.html\\n  ''\\n\\nelse\\n\\n  import ./pkgs/top-level/impure.nix\\n\"\nnix-repl&gt; :l &lt;nixpkgs/lib&gt;\nnix-repl&gt; importJSON ./pkgs/development/python-modules/notebook/missing-hashes.json # Return the nix value for JSON\n{\n  \"@nx/nx-darwin-arm64@npm:16.10.0\" = \"aabcc8499602b98c9fc3b768fe46dfd4e1b818caa84b740bd4f73a2e4528c719b979ecb1c10a0d793a1fead83073a08bc86417588046aa3e587e80af880bffd3\";\n  \"@nx/nx-darwin-x64@npm:16.10.0\" = \"9dd20f45f646d05306f23f5abb7ade69dcb962e23a013101e93365847722079656d30a19c735fdcfa5c4e0fdf08691f9d621073c58aef2861c26741ff4638375\";\n  \"@nx/nx-freebsd-x64@npm:16.10.0\" = \"35b93aabe3b3274d53157a6fc10fec7e341e75e6818e96cfbc89c3d5b955d225ca80a173630b6aa43c448c6b53b23f06a2699a25c0c8bc71396ee20a023d035f\";\n  \"@nx/nx-linux-arm-gnueabihf@npm:16.10.0\" = \"697b9fa4c70f84d3ea8fe32d47635864f2e40b0ceeb1484126598c61851a2ec34b56bb3eeb9654c37d9b14e81ce85a36ac38946b4b90ca403c57fe448be51ccb\";\n  \"@nx/nx-linux-arm64-gnu@npm:16.10.0\" = \"001e71fedfc763a4dedd6c5901b66a4a790d388673fb74675235e19bb8fe031ff3755568ed867513dd003f873901fabda31a7d5628b39095535cb9f6d1dc7191\";\n  \"@nx/nx-linux-arm64-musl@npm:16.10.0\" = \"58e3b71571bdadd2b0ddd24ea6e30cd795e706ada69f685403412c518fba1a2011ac8c2ac46145eab14649aa5a78e0cedcdb4d327ccb3b6ec12e055171f3840b\";\n  \"@nx/nx-linux-x64-gnu@npm:16.10.0\" = \"97729a7efb27301a67ebf34739784114528ddb54047e63ca110a985eaa0763c5b1ea7c623ead1a2266d07107951be81e82ffa0a30e6e4d97506659303f2c8c78\";\n  \"@nx/nx-linux-x64-musl@npm:16.10.0\" = \"442bdbd5e61324a850e4e7bd6f54204108580299d3c7c4ebcec324da9a63e23f48d797a87593400fc32af78a3a03a3c104bfb360f107fe732e6a6c289863853a\";\n  \"@nx/nx-win32-arm64-msvc@npm:16.10.0\" = \"b5c74184ebfc70294e85f8e309f81c3d40b5cf99068891e613f3bef5ddb946bef7c9942d9e6c7688e22006d45d786342359af3b4fc87aadf369afcda55c73187\";\n  \"@nx/nx-win32-x64-msvc@npm:16.10.0\" = \"c5b174ebd7a5916246088e17d3761804b88f010b6b3f930034fa49af00da33b6d1352728c733024f736e4c2287def75bafdc3d60d8738bd24b67e9a4f11763f8\";\n}\nnix-repl&gt; builtins.toJSON  # serialize\n¬´primop toJSON¬ª\nnix-repl&gt; builtins.fromTOML\n¬´primop fromTOML¬ª\nnix-repl&gt; builtins.toXML\n</code></pre>\n<p>For more serialization formats see <code>nixpkgs/lib/generators.nix</code> as well as in\n<code>nixpkgs/pkgs/pkgs-lib/formats/</code> we can see them with the <code>nix repl</code> as follows:</p>\n<pre><code class=\"language-bash\">cd ~/src/nixpkgs\nnix repl\nnix-repl&gt; :l .\nnix-repl&gt; lib.generators.toYAML {} { a = 10; }\n\"{\\\"a\\\":10}\"\nnix-repl&gt; lib.generators.toYAML {} { a.b.c = 10; }\n\"{\\\"a\\\":{\\\"b\\\":{\\\"c\\\":10}}}\"\nnix-repl&gt; builtins.trace (lib.generators.toYAML {} { a.b.c = 10; }) null\ntrace: {\"a\":{\"b\":{\"c\":10}}}\nnull\nnix-repl&gt; yamlFormat = pkgs.formats.yaml {}\n\nnix-repl&gt; yamlFormat\n{\n  generate = ¬´lambda generate @ /home/jr/src/nixpkgs/pkgs/pkgs-lib/formats.nix:111:9¬ª;\n  type = { ... };\n}\n</code></pre>\n<ul>\n<li>We can see that it provides a <code>generate</code> function that we can use. <code>generate</code>\ndoesn‚Äôt just generate a string anymore because if we want to lift the\nrestriction at evaluation time we can‚Äôt return the formatted form at\nevaluation time anymore. We need a name to return a derivation continued\nbelow:</li>\n</ul>\n<pre><code class=\"language-bash\">yamlFormat.generate \"name\" { a.b.c = 10; }\n¬´derivation /nix/store/xakajb2rzbmqqkjbh08bxwqdf0xqvjly-name.drv¬ª\nnix-repl&gt; :b yamlFormat.generate \"name\" { a.b.c = 10; }\nThis derivation produced the following outputs:\nout -&gt; /nix/store/y4c5029k6w3l0qmdw7cq396zrdy5x8yj-name\nnix-repl&gt; :q\n</code></pre>\n<p>Let‚Äôs cat the result to see if it‚Äôs formatted correctly as YAML:</p>\n<pre><code class=\"language-bash\">cat /nix/store/y4c5029k6w3l0qmdw7cq396zrdy5x8yj-name\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n       ‚îÇ File: /nix/store/y4c5029k6w3l0qmdw7cq396zrdy5x8yj-name\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n   1   ‚îÇ a:\n   2   ‚îÇ   b:\n   3   ‚îÇ     c: 10\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n</code></pre>\n<p>Looks good. There is also a <code>type</code>:</p>\n<pre><code class=\"language-bash\">nix repl\nnix-repl&gt; :l .\nnix-repl&gt; yamlFormat = pkgs.format.yaml {}\nnix-repl&gt; yamlFormat.type\n{\n  _type = \"option-type\";\n  check = ¬´lambda check @ /home/jr/src/nixpkgs/lib/types.nix:1029:19¬ª;\n  deprecationMessage = null;\n  description = \"YAML value\";\n  descriptionClass = \"conjunction\";\n  emptyValue = { ... };\n  functor = { ... };\n  getSubModules = null;\n  getSubOptions = ¬´lambda @ /home/jr/src/nixpkgs/lib/types.nix:214:25¬ª;\n  merge = ¬´lambda merge @ /home/jr/src/nixpkgs/lib/types.nix:1031:13¬ª;\n  name = \"nullOr\";\n  nestedTypes = { ... };\n  substSubModules = ¬´lambda substSubModules @ /home/jr/src/nixpkgs/lib/types.nix:1046:29¬ª;\n  typeMerge = ¬´lambda defaultTypeMerge @ /home/jr/src/nixpkgs/lib/types.nix:115:10¬ª;\n}\nnix-repl&gt; lib.modules.mergeDefinitions [] yamlFormat.type [ { value = null; } ]\n{\n  defsFinal = [ ... ];\n  defsFinal' = { ... };\n  isDefined = true;\n  mergedValue = null;\n  optionalValue = { ... };\n}\nnix-repl&gt; (lib.modules.mergeDefinitions [] yamlFormat.type [ { value = null; } ]).mergedValue\nnull\nnix-repl&gt; :p (lib.modules.mergeDefinitions [] yamlFormat.type [ { value = { a.b.c = 10; }; } ]).mergedValue\n{\n  a = {\n    b = { c = 10; };\n  };\n}\nnix-repl&gt; :p (lib.modules.mergeDefinitions [] yamlFormat.type [ { value = { a.b.c = 10; }; } { value = { a.b.d = 20; }; } ]).mergedValue\n{\n  a = {\n    b = {\n      c = 10;\n      d = 20;\n    };\n  };\n}\n</code></pre>\n<ul>\n<li><code>lib</code> can‚Äôt access any packages, it is entirely at evaluation time. It can‚Äôt\naccess any formatters or things like that. If we lift that restriction as is\ndone in <code>pkgs.formats</code> we can make it look much nicer.</li>\n</ul>\n<pre><code class=\"language-bash\">cd ~/src/nixpkgs\nnix-build -A hello\nwarning: Nix search path entry '/nix/var/nix/profiles/per-user/root/channels' does not exist, ignoring\nthis path will be fetched (0.06 MiB download, 0.26 MiB unpacked):\n  /nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\ncopying path '/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2' from 'https://cache.nixos.org'...\n/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\n</code></pre>\n<p>Say we rely on this store path in a derivation:</p>\n<pre><code class=\"language-bash\">nix-repl&gt; thePath = \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\"\nnix-repl&gt; thePath + \"/bin/hello\"\n\"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2/bin/hello\"\n</code></pre>\n<pre><code class=\"language-bash\">hx ~/src/nixpkgs/test2.nix\n</code></pre>\n<pre><code class=\"language-nix\"># test2.nix\nwith import ./. {};\n\nrunCommand \"test\" {\n    nativeBuildInputs = [\n        hello\n    ];\n}''\n  hello &gt; $out\n''\n</code></pre>\n<p>Try building it:</p>\n<pre><code class=\"language-bash\">nix-build test2.nix &amp;&amp; cat result\nwarning: Nix search path entry '/nix/var/nix/profiles/per-user/root/channels' does not exist, ignoring\n/nix/store/m55p4vpb8s7s28s20vs89i467kxbrdac-test\nHello, world!\n</code></pre>\n<p>Now if we try it with the store path:</p>\n<pre><code class=\"language-nix\"># test2.nix\nwith import ./. {};\n\nrunCommand \"test\" {\n}''\n  /nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2/bin/hello &gt; $out\n''\n</code></pre>\n<p>This doesn‚Äôt work</p>\n<pre><code class=\"language-bash\">nix-build test2.nix\nlast 1 log lines:\n&gt; /build/.attr-0l2nkwhif96f51f4amnlf414lhl4rv9vh8iffyp431v6s28gsr90: line 1: /nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2/bin/hello: No such file or directory\nFor full logs, run:\nnix log /nix/store/58zcp9xwgf1sirmzf9sh61j8gz9lkw34-test.drv\nnix-instantiate test2.nix\n/nix/store/58zcp9xwgf1sirmzf9sh61j8gz9lkw34-test.drv\nnix derivation show /nix/store/58zcp9xwgf1sirmzf9sh61j8gz9lkw34-test.drv | jq\n{\n  \"/nix/store/58zcp9xwgf1sirmzf9sh61j8gz9lkw34-test.drv\": {\n    \"args\": [\n      \"-e\",\n      \"/nix/store/vj1c3wf9c11a0qs6p3ymfvrnsdgsdcbq-source-stdenv.sh\",\n      \"/nix/store/shkw4qm9qcw5sc5n1k5jznc83ny02r39-default-builder.sh\"\n    ],\n    \"builder\": \"/nix/store/xy4jjgw87sbgwylm5kn047d9gkbhsr9x-bash-5.2p37/bin/bash\",\n    \"env\": {\n      \"__structuredAttrs\": \"\",\n      \"buildCommand\": \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2/bin/hello &gt; $out\\n\",\n      \"buildInputs\": \"\",\n      \"builder\": \"/nix/store/xy4jjgw87sbgwylm5kn047d9gkbhsr9x-bash-5.2p37/bin/bash\",\n      \"cmakeFlags\": \"\",\n      \"configureFlags\": \"\",\n      \"depsBuildBuild\": \"\",\n      \"depsBuildBuildPropagated\": \"\",\n      \"depsBuildTarget\": \"\",\n      \"depsBuildTargetPropagated\": \"\",\n      \"depsHostHost\": \"\",\n      \"depsHostHostPropagated\": \"\",\n      \"depsTargetTarget\": \"\",\n      \"depsTargetTargetPropagated\": \"\",\n      \"doCheck\": \"\",\n      \"doInstallCheck\": \"\",\n      \"enableParallelBuilding\": \"1\",\n      \"enableParallelChecking\": \"1\",\n      \"enableParallelInstalling\": \"1\",\n      \"mesonFlags\": \"\",\n      \"name\": \"test\",\n      \"nativeBuildInputs\": \"\",\n      \"out\": \"/nix/store/ljrkx5midby3j7p4g96d74jrq8f9rpya-test\",\n      \"outputs\": \"out\",\n      \"passAsFile\": \"buildCommand\",\n      \"patches\": \"\",\n      \"propagatedBuildInputs\": \"\",\n      \"propagatedNativeBuildInputs\": \"\",\n      \"stdenv\": \"/nix/store/aq801xbgs98nxx3lckrym06qfvl8mfsf-stdenv-linux\",\n      \"strictDeps\": \"\",\n      \"system\": \"x86_64-linux\"\n    },\n    \"inputDrvs\": {\n      \"/nix/store/bmncp7arkdhrl6nkyg0g420935x792gl-stdenv-linux.drv\": {\n        \"dynamicOutputs\": {},\n        \"outputs\": [\n          \"out\"\n        ]\n      },\n      \"/nix/store/rfkzz952hz2d58d90mscxvk87v5wa5bz-bash-5.2p37.drv\": {\n        \"dynamicOutputs\": {},\n        \"outputs\": [\n          \"out\"\n        ]\n      }\n    },\n    \"inputSrcs\": [\n      \"/nix/store/shkw4qm9qcw5sc5n1k5jznc83ny02r39-default-builder.sh\",\n      \"/nix/store/vj1c3wf9c11a0qs6p3ymfvrnsdgsdcbq-source-stdenv.sh\"\n    ],\n    \"name\": \"test\",\n    \"outputs\": {\n      \"out\": {\n        \"path\": \"/nix/store/ljrkx5midby3j7p4g96d74jrq8f9rpya-test\"\n      }\n    },\n    \"system\": \"x86_64-linux\"\n  }\n}\n</code></pre>\n<p>You see the <code>\"inputDrvs\"</code>, they are the derivations that we depend on and it\ndoesn‚Äôt know about the <code>hello.drv</code>. In Nix for the builder sandbox it creates a\nsandbox that only contains the derivations that you depend on which ensures that\nyou can‚Äôt depend on any derivation that you haven‚Äôt explicitly decalred.</p>\n<p>Nix does have <code>builtins.storePath</code> that allows you to do this, otherwise it‚Äôs\nkind of an anti pattern.</p>\n<pre><code class=\"language-nix\"># test2.nix\n# test2.nix\n# test2.nix\nwith import ./. {};\n  runCommand \"test\" {\n  } ''\n    ${builtins.storePath \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\"}/bin/hello &gt; $out\n  ''\n</code></pre>\n<p><code>builtins.storePath</code>: Turns a store path into the thing that it represents in\nthe store.</p>\n<pre><code class=\"language-bash\">nix-build test2.nix &amp;&amp; cat result\n/nix/store/x48741w0k9hgqywzv6wc7rk90r1y75js-test\nHello, world!\n</code></pre>\n<p>To demonstrate what <code>builtins.storePath</code> does:</p>\n<pre><code class=\"language-bash\">nix-repl&gt; builtins.storePath \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2/bin/hello\"\n\"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2/bin/hello\"\nnix-repl&gt; builtins.getContext \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\"\n{ }\nnix-repl&gt; builtins.getContext (builtins.storePath \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\")\n{\n  \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\" = { ... };\n}\nnix-repl&gt; :p builtins.getContext (builtins.storePath \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\")\n{\n  \"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\" = { path = true; };\n}\n</code></pre>\n<pre><code class=\"language-bash\">nix-repl&gt; :l .\nwarning: Nix search path entry '/nix/var/nix/profiles/per-user/root/channels' does not exist, ignoring\nAdded 24878 variables.\n\nnix-repl&gt; hello.outPath\n# this is the output path of the hello derivation\n\"/nix/store/29mhfr5g4dsv07d80b7n4bgs45syk3wl-hello-2.12.2\"\nnix-repl&gt; :p builtins.getContext hello.outPath\n# we see that this is a `.drv`, this is because derivations can have multiple outputs\n{\n  \"/nix/store/ljxsxdy1syy03b9kfnnh8x7zsk21fdcq-hello-2.12.2.drv\" = {\n    outputs = [ \"out\" ];\n  };\n}\n# for example\nnix-repl&gt; openssl.outputs\n[\n  \"bin\"\n  \"dev\"\n  \"out\"\n  \"man\"\n  \"doc\"\n  \"debug\"\n]\nnix-repl&gt; openssl.all\n# a list of all the derivations\n[\n  ¬´derivation /nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv¬ª\n  ¬´derivation /nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv¬ª\n  ¬´derivation /nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv¬ª\n  ¬´derivation /nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv¬ª\n  ¬´derivation /nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv¬ª\n  ¬´derivation /nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv¬ª\n]\nnix-repl&gt; lib.concatStringsSep \" \" openssl.all\n\"/nix/store/rjzx8v679rwd6dsb6s08iy3j2rrax72s-openssl-3.4.1-bin /nix/store/kcgqglb4iax0zh5jlrxmjdik93wlgsrq-openssl-3.4.1-dev /nix/store/8pviily4fgsl02ijm65binz236717wfs-openssl-3.4.1 /nix/store/1l5b31cnswnbcdcac9rzs9xixnc2n9r5-openssl-3.4.1-man /nix/store/9fz5qmj0z70cbzy7mapml0sbi8z6ap0a-openssl-3.4.1-doc /nix/store/yk2g2gfcj2fy1ffyi1g91q7jmp4h8pxa-openssl-3.4.1-debug\"\nnix-repl&gt; :p builtins.getContext (builtins.unsafeDiscardOutputDependency (lib.concatStringsSep \" \" openssl.all))\n{\n  \"/nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv\" = {\n    outputs = [\n      \"bin\"\n      \"debug\"\n      \"dev\"\n      \"doc\"\n      \"man\"\n      \"out\"\n    ];\n  };\n}\nnix-repl&gt; :p builtins.getContext openssl.drvPath\n{\n  \"/nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv\" = { allOutputs = true; };\n}\n# useful if you need to create a derivation that copies this derivation to another machine\n# remote builders usually take care of this but you may need it occasionally\nnix-repl&gt; :p builtins.getContext (builtins.unsafeDiscardOutputDependency openssl.drvPath)\n{\n  \"/nix/store/rw3y8k94ib37dc86n0wivr551wyzxgsk-openssl-3.4.1.drv\" = { path = true; };\n}\n</code></pre>\n<p>Relying on paths outside of the nix store is generally not recommended because\nof garbage collection and it‚Äôs considered unsafe.</p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/installation/index.html",
      "url": "https://saylesss88.github.io/installation/index.html",
      "title": "My Chapter",
      "content_html": "<h1>Installation Guides</h1>\n<p>This section provides detailed guides for installing NixOS. You‚Äôll choose\nbetween an <strong>unencrypted</strong> or <strong>encrypted</strong> base setup. After your core\ninstallation, you can explore adding optional features like <code>sops</code> for encrypted\nsecrets, <code>lanzaboote</code> for Secure Boot, or <code>impermanence</code> for a stateless system.</p>\n<hr />\n<h2>1. Unencrypted Disko Btrfs Subvol Installation</h2>\n<ul>\n<li>\n<p><strong>Guide:</strong>\n<a href=\"https://saylesss88.github.io/installation/unencrypted/unencrypted.html\">Minimal Btrfs-Subvol Install with Disko and Flakes</a></p>\n</li>\n<li>\n<p><strong>Best for:</strong></p>\n<ul>\n<li>\n<p>Users who want a straightforward and quick setup.</p>\n</li>\n<li>\n<p><a href=\"https://saylesss88.github.io/installation/unencrypted/impermanence.html\">Unencrypted Impermanence</a></p>\n</li>\n<li>\n<p>You can still add Lanzaboote and sops secrets after the install for a more\nsecure system. To get the full benefits of Lanzaboote it is recommended to\nuse full disk encryption.</p>\n</li>\n</ul>\n</li>\n</ul>\n<hr />\n<h2>2. Encrypted Disko Btrfs Subvol Installation</h2>\n<ul>\n<li>\n<p><strong>Encrypted Install Guide:</strong>\n<a href=\"https://saylesss88.github.io/installation/enc/enc_install.html\">Encrypted Install</a></p>\n</li>\n<li>\n<p><a href=\"https://saylesss88.github.io/installation/enc/encrypted_impermanence.html\">Encrypted Impermanence</a></p>\n</li>\n<li>\n<p><strong>Important Considerations:</strong></p>\n<ul>\n<li>\n<p><a href=\"https://saylesss88.github.io/enc/lanzaboote.html\">Secure Boot with Lanzaboote</a>\nFor the full benefit of Secure Boot (with Lanzaboote), it‚Äôs highly\nrecommended to have a second stage of protection, such as an encrypted disk.</p>\n</li>\n<li>\n<p><a href=\"https://saylesss88.github.io/enc/sops-nix.html\">Adding Sops</a> You can easily\nadd <code>sops</code> (for managing encrypted secrets) to your configuration <em>after</em>\nthe initial encrypted installation and reboot. This can simplify the initial\nsetup process. However, always remember the core goal of using encrypted\nsecrets: <strong>never commit unencrypted or even hashed sensitive data directly\ninto your Git repository.</strong> With modern equipment brute force attacks are a\nreal threat.</p>\n</li>\n</ul>\n</li>\n</ul>\n<hr />\n<h2>3. Post-Installation Security &amp; Features</h2>\n<p>Once your base NixOS system is installed, consider these powerful additions:</p>\n<ul>\n<li>\n<p><strong><code>sops-nix</code>:</strong> For managing encrypted secrets directly within your NixOS\nconfiguration, ensuring sensitive data is never stored in plain text.</p>\n</li>\n<li>\n<p><strong><code>lanzaboote</code>:</strong> For enabling Secure Boot, verifying the integrity of your\nboot chain (requires UEFI and custom keys).</p>\n</li>\n<li>\n<p><strong><code>impermanence</code>:</strong> For setting up a stateless NixOS system, where the root\nfilesystem reverts to a clean state on every reboot.</p>\n</li>\n</ul>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/installation/unenc/unencrypted_setups.html",
      "url": "https://saylesss88.github.io/installation/unenc/unencrypted_setups.html",
      "title": "Unencrypted Install",
      "content_html": "<h1>Minimal BTRFS-Subvol Install with Disko and Flakes</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<h1>Unencrypted Setups</h1>\n<p>Figure 1: BTRFS Logo: Image of the BTRFS logo. Sourced from the BTRFS repo BTRFS\nlogo</p>\n<p>Why I Chose BTRFS I chose BTRFS because I was already familiar with it from\nusing it with Arch Linux and I found it to be very easy to use. From what I‚Äôve\nread, there are licensing issues between the Linux Kernel and ZFS which means\nthat ZFS is not part of the Linux Kernel; it‚Äôs maintained by the OpenZFS project\nand available as a separate kernel module. This can cause issues and make you\nthink more about your filesystem than I personally want to at this point.</p>\n<details>\n<summary>‚úîÔ∏è Click for BTRFS Subvolume Overview</summary>\n<p>A <strong>Btrfs subvolume</strong> is essentially a distinct section within a Btrfs\nfilesystem that maintains its own set of files and directories, along with a\nseparate inode numbering system. Unlike block-level partitions (such as LVM\nlogical volumes), Btrfs subvolumes operate at the file level and are based on\nfile extents.</p>\n<p><strong>Extents</strong> in Btrfs are contiguous blocks of data on disk that store the actual\ncontents of files. When files are created or modified, Btrfs manages these\nextents efficiently, allowing features like deduplication and snapshots.\nMultiple subvolumes can reference the same extents, meaning that identical data\nis not duplicated on disk, which saves space and improves performance.</p>\n<p>A <strong>snapshot</strong> in Btrfs is a special kind of subvolume that starts with the same\ncontent as another subvolume at the time the snapshot is taken. Snapshots are\ntypically writable by default, so you can make changes in the snapshot without\naffecting the original subvolume. This is possible because Btrfs tracks changes\nat the extent level, only creating new extents when files are modified (a\ntechnique called copy-on-write).</p>\n<p>Subvolumes in Btrfs behave much like regular directories from a user‚Äôs\nperspective, but they support additional operations such as renaming, moving,\nand nesting (placing subvolumes within other subvolumes). There are no\nrestrictions on nesting, though it can affect how snapshots are created and\nmanaged. Each subvolume is assigned a unique and unchangeable numeric ID\n(subvolid or rootid).</p>\n<p>You can access a Btrfs subvolume in two main ways:</p>\n<ul>\n<li>\n<p>As a normal directory within the filesystem.</p>\n</li>\n<li>\n<p>By mounting it directly as if it were a separate filesystem, using the subvol\nor subvolid mount options. When mounted this way, you only see the contents of\nthat subvolume, similar to how a bind mount works.</p>\n</li>\n</ul>\n<p>When a new Btrfs filesystem is created, it starts with a ‚Äútop-level‚Äù subvolume\n(with an internal ID of 5). This subvolume is always present and cannot be\ndeleted or replaced, and it is the default mount point unless changed with btrfs\nsubvolume set-default.</p>\n<p>Subvolumes can also have storage quotas set using Btrfs‚Äôs quota groups , but\notherwise, they all draw from the same underlying storage pool. Thanks to\nfeatures like deduplication and snapshots, subvolumes can share data efficiently\nat the extent level.While ZFS is a solid choice and offers some benefits over\nBTRFS, I recommend looking into it before making your own decision.</p>\n<p>If you have a ton of RAM you could most likely skip the minimal install and just\nset your system up as needed or just use\n<a href=\"https://elis.nu/blog/2020/05/nixos-tmpfs-as-root/\">tmpfs as root</a></p>\n</details>\n<h2>Getting Started with Disko</h2>\n<p>Disko allows you to declaratively partition and format your disks, and then\nmount them to your system. I recommend checking out the\n<a href=\"https://github.com/nix-community/disko/tree/master?tab=readme-ov-file\">README</a>\nas it is a disk destroyer if used incorrectly.</p>\n<p>We will mainly be following the\n<a href=\"https://github.com/nix-community/disko/blob/master/docs/quickstart.md\">disko quickstart guide</a></p>\n<p>Figure 2: <strong>Disko Logo</strong>: Image of the logo for Disko, the NixOS declarative\ndisk partitioning tool. Sourced from the\n<a href=\"https://github.com/nix-community/disko\">Disko project</a> disko logo</p>\n<ol>\n<li>Get the\n<a href=\"https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso\">Nixos Minimal ISO</a>\nGet it on a usb stick, I use Ventoy with Ventoy2Disk.sh. The following is the\nlink to the\n<a href=\"https://sourceforge.net/projects/ventoy/files/v1.1.05/ventoy-1.1.05-linux.tar.gz/download\">Ventoy TarBall</a>\ndownload, untar it with <code>tar -xzf ventoy-1.1.05-linux.tar.gz</code>, and make it\nexecutable with <code>chmod +x Ventoy2Disk.sh</code>, and finally execute it with\n<code>sudo ./Ventoy2Disk.sh</code> Follow the prompts to finish the install.</li>\n</ol>\n<p>You‚Äôll have to run it on for the USB drive you‚Äôre trying to use, you can do that\nby unplugging the USB stick and running <code>lsblk</code>, then plug it in again and run:</p>\n<pre><code class=\"language-bash\">lsblk -f\nNAME          FSTYPE      FSVER LABEL   UUID                                 FSAVAIL FSUSE% MOUNTPOINTS\nsda\n‚îî‚îÄsda1        vfat        FAT32 MYUSB   46E8-9304\nsdb           vfat        FAT12         F054-697D                               1.4M     0% /run/media/jr/F054-697D\nnvme0n1\n‚îú‚îÄnvme0n1p1   vfat        FAT32         BCD8-8C51                               1.8G    12% /boot\n</code></pre>\n<ul>\n<li><code>sdb</code> is a USB plugin for a mouse. <code>sda</code> is the USB stick that I want to\ntarget here:</li>\n</ul>\n<pre><code class=\"language-bash\">sudo ./Ventoy2Disk.sh -i /dev/sda\n# Or to force overwrite an existing Ventoy entry\nsudo ./Ventoy2Disk.sh -I /dev/sda\n</code></pre>\n<ol start=\"2\">\n<li>The minimal installer uses wpa_supplicant instead of NetworkManager, to\nenable networking run the following:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo systemctl start wpa_supplicant\nwpa_cli\n</code></pre>\n<pre><code class=\"language-bash\">&gt; add_network\n0\n\n&gt; set_network 0 ssid \"myhomenetwork\"\nOK\n\n&gt; set_network 0 psk \"mypassword\"\nOK\n\n&gt; enable_network 0\nOK\n</code></pre>\n<p>To exit type <code>quit</code>, then check your connection with <code>ping google.com</code>.</p>\n<p>Another option is to do the following, so either the above method or the below\nmethod after starting <code>wpa_supplicant</code>:</p>\n<pre><code class=\"language-bash\"># Alternative for quick setup (less interactive, but often faster)\nsudo wpa_passphrase \"myhomenetwork\" \"mypassword\" &gt;&gt; /etc/wpa_supplicant/wpa_supplicant-wlan0.conf\nsudo systemctl restart wpa_supplicant@wlan0.service\n</code></pre>\n<ol start=\"3\">\n<li>Get your Disk Name with lsblk</li>\n</ol>\n<p>The output should be something like:</p>\n<pre><code class=\"language-bash\">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nnvme0n1     259:0    0   1,8T  0 disk\n</code></pre>\n<ol start=\"4\">\n<li>Copy the disk configuration to your machine. You can choose one from the\nexamples directory.</li>\n</ol>\n<ul>\n<li><strong>Option A</strong>: (Simpler for new users) I also created a starter repo containing\nmuch of what‚Äôs needed. If you choose this option follow the README.md included\nwith the repo.</li>\n</ul>\n<pre><code class=\"language-bash\">cd ~\ngit clone https://github.com/saylesss88/my-flake.git\n</code></pre>\n<blockquote>\n<p>Make sure to change line 7 in disk-config.nix to what you got from step 3\ndevice = ‚Äú/dev/nvme0n1‚Äù;</p>\n</blockquote>\n<ul>\n<li><strong>Option B</strong>: (More flexible, more manual steps) Skip cloning the repo above\nand for the btrfs-subvolume default layout, run the following:</li>\n</ul>\n<pre><code class=\"language-bash\">cd /tmp\ncurl https://raw.githubusercontent.com/nix-community/disko/refs/heads/master/example/btrfs-subvolumes.nix -o /tmp/disk-config.nix\n</code></pre>\n<ol start=\"5\">\n<li>Make Necessary changes, I set mine up for impermanence with the following:</li>\n</ol>\n<pre><code class=\"language-bash\">nano /tmp/disk-config.nix\n</code></pre>\n<pre><code class=\"language-nix\">{\n  disko.devices = {\n    disk = {\n      main = {\n        type = \"disk\";\n        device = \"/dev/nvme0n1\";\n        content = {\n          type = \"gpt\";\n          partitions = {\n            ESP = {\n              priority = 1;\n              name = \"ESP\";\n              start = \"1M\";\n              end = \"512M\";\n              type = \"EF00\";\n              content = {\n                type = \"filesystem\";\n                format = \"vfat\";\n                mountpoint = \"/boot\";\n                mountOptions = [\"umask=0077\"];\n              };\n            };\n            root = {\n              size = \"100%\";\n              content = {\n                type = \"btrfs\";\n                extraArgs = [\"-f\"]; # Override existing partition\n                # Subvolumes must set a mountpoint in order to be mounted,\n                # unless their parent is mounted\n                subvolumes = {\n                  # Subvolume name is different from mountpoint\n                  \"/root\" = {\n                    mountpoint = \"/\";\n                    mountOptions = [\"subvol=root\" \"compress=zstd\" \"noatime\"];\n                  };\n                  # Subvolume name is the same as the mountpoint\n                  \"/home\" = {\n                    mountOptions = [\"subvol=home\" \"compress=zstd\" \"noatime\"];\n                    mountpoint = \"/home\";\n                  };\n                  # Sub(sub)volume doesn't need a mountpoint as its parent is mounted\n                  \"/home/user\" = {};\n                  # Parent is not mounted so the mountpoint must be set\n                  \"/nix\" = {\n                    mountOptions = [\n                      \"subvol=nix\"\n                      \"compress=zstd\"\n                      \"noatime\"\n                    ];\n                    mountpoint = \"/nix\";\n                  };\n                  \"/nix/persist\" = {\n                    mountpoint = \"/nix/persist\";\n                    mountOptions = [\"subvol=persist\" \"compress=zstd\" \"noatime\"];\n                  };\n                  \"/log\" = {\n                    mountpoint = \"/var/log\";\n                    mountOptions = [\"subvol=log\" \"compress=zstd\" \"noatime\"];\n                  };\n                  \"/lib\" = {\n                    mountpoint = \"/var/lib\";\n                    mountOptions = [\"subvol=lib\" \"compress=zstd\" \"noatime\"];\n                  };\n                  # This subvolume will be created but not mounted\n                  \"/test\" = {};\n                };\n              };\n            };\n          };\n        };\n      };\n    };\n  };\n  fileSystems.\"/nix/persist\".neededForBoot = true;\n  fileSystems.\"/var/log\".neededForBoot = true;\n  fileSystems.\"/var/lib\".neededForBoot = true;\n}\n</code></pre>\n<ul>\n<li>For <code>/tmp</code> on RAM use something like the following. I‚Äôve found that having\ndisko manage swaps causes unnecessary issues. Using zram follows the ephemeral\nroute:</li>\n</ul>\n<pre><code class=\"language-nix\">{\n  lib,\n  config,\n  ...\n}: let\n  cfg = config.custom.zram;\nin {\n  options.custom.zram = {\n    enable = lib.mkEnableOption \"Enable utils module\";\n  };\n\n  config = lib.mkIf cfg.enable {\n    zramSwap = {\n      enable = true;\n      # one of \"lzo\", \"lz4\", \"zstd\"\n      algorithm = \"zstd\";\n       priority = 5;\n       memoryPercent = 50;\n    };\n  };\n}\n</code></pre>\n<p>And in your <code>configuration.nix</code> you would add:</p>\n<pre><code class=\"language-nix\"># configuration.nix\ncustom = {\n    zram.enable = true;\n};\n</code></pre>\n<p>After adding the above module, you can see it with:</p>\n<pre><code class=\"language-bash\">swapon --show\nNAME       TYPE      SIZE USED PRIO\n/dev/zram0 partition 7.5G   0B    5\n</code></pre>\n<ol start=\"6\">\n<li>Run disko to partition, format and mount your disks. Warning this will wipe\nEVERYTHING on your disk. Disko doesn‚Äôt work with dual boot.</li>\n</ol>\n<pre><code class=\"language-bash\">sudo nix --experimental-features \"nix-command flakes\" run github:nix-community/disko/latest -- --mode destroy,format,mount /tmp/disk-config.nix\n</code></pre>\n<p>Check it with the following:</p>\n<pre><code class=\"language-bash\">mount | grep /mnt\n</code></pre>\n<p>The output for an nvme0n1 disk would be similar to the following:</p>\n<pre><code class=\"language-bash\">#... snip ...\n/dev/nvme0n1p2 on /mnt type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=285,subvol=/root)\n/dev/nvme0n1p2 on /mnt/persist type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=261,subvol=/persist)\n/dev/nvme0n1p2 on /mnt/etc type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=261,subvol=/persist)\n/dev/nvme0n1p2 on /mnt/nix type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=260,subvol=/nix)\n/dev/nvme0n1p2 on /mnt/var/lib type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=258,subvol=/lib)\n/dev/nvme0n1p2 on /mnt/var/log type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=259,subvol=/log)\n/dev/nvme0n1p2 on /mnt/nix/store type btrfs (ro,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=260,subvol=/nix)\n# ... snip ...\n</code></pre>\n<ol start=\"7\">\n<li>Generate necessary files, here we use ‚Äìno-filesystems because disko handles\nthe fileSystems attribute for us.</li>\n</ol>\n<pre><code class=\"language-bash\">nixos-generate-config --no-filesystems --root /mnt\n</code></pre>\n<p>It may be helpful to add a couple things to your <code>configuration.nix</code> now,\nrebuild and then move on. Such as, your hostname, git, an editor of your choice.\nAfter your additions run <code>sudo nixos-rebuild</code> switch to apply the changes. If\nyou do this, you can skip the <code>nix-shell -p</code> command coming up.</p>\n<pre><code class=\"language-bash\">sudo mv /tmp/disk-config.nix /mnt/etc/nixos\n</code></pre>\n<h2>Setting a Flake for your minimal Install</h2>\n<ol start=\"8\">\n<li>Create the flake in your home directory, then move it to /mnt/etc/nixos. This\navoids needing to use sudo for every command while in the /mnt/etc/nixos\ndirectory.</li>\n</ol>\n<pre><code class=\"language-bash\">cd ~\nmkdir flake &amp;&amp; cd flake\nnix-shell -p git yazi helix\nexport NIX_CONFIG='experimental-features = nix-command flakes'\nexport EDITOR='hx'\nhx flake.nix\n</code></pre>\n<blockquote>\n<p>You‚Äôll change hostname = nixpkgs.lib.nixosSystem to your chosen hostname,\n(e.g. magic = nixpkgs.lib.nixosSystem). This will be the same as your\nnetworking.hostName = ‚Äúmagic‚Äù; in your configuration.nix that we will set up\nshortly.</p>\n</blockquote>\n<pre><code class=\"language-nix\"># flake.nix\n{\n  description = \"NixOS configuration\";\n\n  inputs = {\n    nixpkgs.url = \"github:nixos/nixpkgs/nixos-unstable\";\n    disko.url = \"github:nix-community/disko/latest\";\n    disko.inputs.nixpkgs.follows = \"nixpkgs\";\n    # impermanence.url = \"github:nix-community/impermanence\";\n  };\n\n  outputs = inputs@{ nixpkgs, ... }: {\n    nixosConfigurations = {\n      # Change `my-hostname` to match `networking.hostName`\n      my-hostname = nixpkgs.lib.nixosSystem {\n        system = \"x86_64-linux\";\n        modules = [\n          ./configuration.nix\n          inputs.disko.nixosModules.disko\n          # inputs.impermanence.nixosModules.impermanence\n        ];\n      };\n    };\n  };\n}\n</code></pre>\n<p>Move all the files into your flake:</p>\n<pre><code class=\"language-bash\">cd /mnt/etc/nixos/\nsudo mv disk-config.nix hardware-configuration.nix configuration.nix ~/flake\n</code></pre>\n<ol start=\"9\">\n<li>Edit configuration.nix with what is required, the following is required, I\nclone my original flake repo and move the pieces into place but it‚Äôs fairly\neasy to just type it all out:</li>\n</ol>\n<ul>\n<li>\n<p>Bootloader, (e.g., boot.loader.systemd-boot.enable = true;)</p>\n</li>\n<li>\n<p>User, the example uses username change this to your chosen username. If you\ndon‚Äôt set your hostname it will be nixos.</p>\n</li>\n<li>\n<p>Networking, networking.networkmanager.enable = true;</p>\n</li>\n<li>\n<p><code>hardware-configuration.nix</code> &amp; <code>disk-config.nix</code> for this setup</p>\n</li>\n<li>\n<p><code>initialHashedPassword</code>: Run <code>mkpasswd --method=yescrypt</code>, then enter your\ndesired password. Example output,</p>\n</li>\n</ul>\n<pre><code class=\"language-bash\">mkpasswd --method=yescrypt &gt; /tmp/pass.txt\n</code></pre>\n<ul>\n<li>You can check the quality with pwscore:</li>\n</ul>\n<pre><code class=\"language-bash\">nix-shell -p libpwquality\n\npwscore\nvery-secure-password\n100\n</code></pre>\n<p>read the hashed password into the file with :r /tmp/pass.txt and move it into\nplace.</p>\n<pre><code class=\"language-nix\"># configuration.nix\n{\n  config,\n  lib,\n  pkgs,\n  inputs,\n  ...\n}: {\n  imports = [\n    # Include the results of the hardware scan.\n    ./hardware-configuration.nix\n    ./disk-config.nix\n  ];\n\n  networking.hostName = \"my-hostname\"; # This will match the `hostname` of your flake\n\n  networking.networkmanager.enable = true;\n\n  boot.loader.systemd-boot.enable = true; # (for UEFI systems only)\n  # List packages installed in system profile.\n  # You can use https://search.nixos.org/ to find more packages (and options).\n  environment.systemPackages = with pkgs; [\n    vim # Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.\n    #   wget\n    git\n  ];\n\n  time.timeZone = \"America/New_York\";\n\n# Change `nixos` to your chosen username, change the group to match\n  users.users.nixos = {\n    isNormalUser = true;\n    extraGroups = [ \"wheel\" \"networkmanager\" ]; # Add \"wheel\" for sudo access\n    initialHashedPassword = \"COPY_YOUR_MKPASSWD_OUTPUT_HERE\"; # &lt;-- This is where it goes!\n    # home = \"/home/nixos\"; # Optional: Disko typically handles home subvolumes\n  };\n  # Create a matching group\n  users.groups.nixos = {};\n\n  console.keyMap = \"us\";\n\n  nixpkgs.config.allowUnfree = true;\n\n  system.stateVersion = \"25.05\";\n}\n</code></pre>\n<p>Shred pass.txt:</p>\n<pre><code class=\"language-bash\">shred /tmp/pass.txt\nrm /tmp/pass.txt\n</code></pre>\n<ol start=\"10\">\n<li>Move the flake to /mnt/etc/nixos and run nixos-install:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo mv ~/flake /mnt/etc/nixos/\nsudo nixos-install --flake /mnt/etc/nixos/flake .#hostname\n# if the above command doesn't work try this:\nsudo nixos-install --flake /mnt/etc/nixos/flake#hostname\n</code></pre>\n<p>You will be prompted to enter a new password if everything succeeds.</p>\n<p>If everything checks out, reboot the system and you should be prompted to enter\nyour user and password to login to a shell to get started.</p>\n<p>The flake will be placed at <code>/etc/nixos/flake</code>, I choose to move it to my home\ndirectory. Since the file was first in <code>/etc</code> you‚Äôll need to adjust the\npermissions with something like <code>sudo chown nixos:nixos ~/flake</code>. This is based\noff of the example above where we created both a nixos user and group.</p>\n<p>You can check the layout of your btrfs system with:</p>\n<pre><code class=\"language-bash\">sudo btrfs subvolume list /\n</code></pre>\n<ul>\n<li>You may notice some old_roots in the output, which are snapshots, which are\nlikely created before system upgrades or reboots for rollback purposes. They\ncan be deleted or rolled back as needed.</li>\n</ul>\n<p><a href=\"https://btrfs.readthedocs.io/en/latest/Subvolumes.html\">BTRFS Subvolumes</a></p>\n<p>To continue following along and set up impermanence\n<a href=\"https://saylesss88.github.io/installation/unencrypted/impermanence.html\">Click Here</a></p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/installation/enc/USB_keyfile.html",
      "url": "https://saylesss88.github.io/installation/enc/USB_keyfile.html",
      "title": "USB Keyfile",
      "content_html": "<h1>USB Stick Keyfile</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p>This allows you to use a USB stick for your keyfile, with a backup in case you\nwant or need it. There is a setting <code>fallbackToPassword</code> that protects you in\ncase something fails with the USB key.</p>\n<p>First, I‚Äôll show how to set up a dedicated USB stick for a keyfile. (i.e., one\nthat is only used for this). After that I will show the process of adding the\nkeyfile to a USB stick with existing data on it that you don‚Äôt want to lose.</p>\n<p><strong>Generate the keyfile</strong></p>\n<pre><code class=\"language-bash\">sudo dd if=/dev/urandom of=/root/usb-luks.key bs=4096 count=1\n</code></pre>\n<h2>Keyfile Enrollment Methods</h2>\n<p>This is for a dedicated USB stick that we will wipe first then add the key.</p>\n<p>Disko defaults to LUKS2</p>\n<pre><code class=\"language-bash\"># cryptsetup works for both LUKS1 and LUKS2 formats but doesn't work for\n# TPM2, FIDO2, and smartcards\nsudo cryptsetup luksAddKey /dev/disk/by-partlabel/luks /root/usb-luks.key\n</code></pre>\n<p><strong>OR</strong></p>\n<details>\n<summary> ‚úîÔ∏è Click to expand Experimental TPM2 auto-unlock for LUKS </summary>\n<blockquote>\n<p>‚ö†Ô∏è WARNING: Security Implications of TPM2 Auto-Unlock</p>\n</blockquote>\n<blockquote>\n<p>Enabling TPM2 auto-unlock fundamentally changes your system‚Äôs security model.\nWhile this feature protects against certain forms of malicious software\ninjection by tying the decryption key to the system‚Äôs boot state, it\neliminates the need for a user password at boot. This creates a significant\nrisk if your machine is stolen or seized, do not use this feature if the\nphysical security of your machine is a concern. This is still at a stage where\nyou can expect rough edges and workarounds.</p>\n</blockquote>\n<blockquote>\n<p>‚ö†Ô∏è WARNING: Do NOT use TPM auto-unlock if your CPU is vulnerable to faulTPM!\nAll AMD Zen2 and Zen3 Processors are known to be affected with AMD Zen1 likely\nalso affected and Zen4 unknown! Misconfigurations are also common, do your own\nresearch!</p>\n</blockquote>\n<ul>\n<li>\n<p><a href=\"https://ieeexplore.ieee.org/document/10190531\">faulTPM:Exposing AMD fTPMs‚Äô Deepest Secrets</a></p>\n</li>\n<li>\n<p><a href=\"https://www.techpowerup.com/308124/amd-faultpm-exploit-targets-zen-2-and-zen-3-processors\">AMD faulTPM Exploit Targets Zen 2 and Zen 3 Processors</a></p>\n</li>\n</ul>\n<p>You can add an additional layer by encrypting user data, such as individual home\nfolders, with a different mechanism, such as <code>fscrypt-experimental</code> or\n<code>systemd-homed</code>. Or, you can use a TPM pin to benefit from the security\nproperties of the TPM, while avoiding completely unattended unlocking.\n‚Äì<a href=\"https://wiki.archlinux.org/title/Trusted_Platform_Module\">Arch Wiki</a></p>\n<p>I am reading that <code>fscrypt</code> is no longer experimental.</p>\n<pre><code class=\"language-nix\">security.pam.enableFscrypt = true;\n</code></pre>\n<pre><code class=\"language-bash\">sudo fscrypt setup --all-users\nsudo mv /home/&lt;user&gt; /home/old&lt;user&gt;\nsudo mkdir /home/&lt;user&gt;\nsudo chown &lt;user&gt;:users /home/&lt;user&gt;\nsudo fscrypt encrypt --source pam_passphrase --user &lt;user&gt; --skip-unlock /home/&lt;user&gt;/\n</code></pre>\n<p>‚Äì‚òùÔ∏è<a href=\"https://discourse.nixos.org/t/experienced-with-systemd-homed-or-other-encrypted-home/63516/2\">Discourse</a></p>\n<p>It is fairly complex as to how TPM2 auto-unlock can improve security in some\nways, it has to do with how Linux distributions fail to authenticate the boot\nprocess past the initrd.Even with encryption and Secure Boot enabled, the initrd\nstage often remains unverified, meaning a tampered initrd could be substituted\nwithout detection.</p>\n<ul>\n<li><a href=\"https://0pointer.net/blog/brave-new-trusted-boot-world.html\">Brave New Trusted Boot World</a></li>\n</ul>\n<p>TPMs protect secrets by releasing them only if the boot process can be\nauthenticated through ‚Äúmeasurements.‚Äù During boot, each component involved\n(firmware, bootloader, kernel, etc.) is hashed, and these hashes are extended\ninto special TPM registers called Platform Configuration Registers (PCRs). These\nPCRs hold a cumulative, tamper-evident record of the boot process state.</p>\n<p>If any part of the boot sequence changes (even slightly), the PCR values will\ndiffer from the expected, causing the TPM to refuse to release the bound secret\n(such as a disk decryption key). This ensures that the system only boots or\nunlocks secrets when its software stack is known and trusted, providing strong\nprotection against tampering or unauthorized modifications. The values aren‚Äôt\nonly protected by these PCRs but encrypted with a ‚Äúseed key‚Äù that‚Äôs generated on\nthe TPM chip itself, and cannot leave the TPM.</p>\n<p>Check TPM support:</p>\n<pre><code class=\"language-bash\">cat /sys/class/tpm/tpm0/device/description\nTPM 2.0 Device\n</code></pre>\n<p>Check for necessary software dependencies:</p>\n<pre><code class=\"language-bash\">systemd-analyze has-tpm2\n</code></pre>\n<p>Find your encrypted partition with <code>lsblk</code>:</p>\n<pre><code class=\"language-bash\">lsblk\n</code></pre>\n<p>First, you need to use the <code>systemd-cryptenroll</code> command to add a TPM2 key to\nyour encrypted LUKS partition. This process binds a key slot on your disk to the\nstate of your TPM2 chip‚Äôs PCRs (Platform Configuration Registers).</p>\n<pre><code class=\"language-bash\"># This command adds a new key to the LUKS volume, using a key generated by the TPM2 chip.\n# It binds the key to PCRs 0,2,7,and 15 ensuring the key is only released if the firmware\n# and Secure Boot state of your system is unchanged.\nsudo systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+2+7+15 /dev/disk/by-partlabel/luks\n</code></pre>\n<p>There are quite a few options for the above command, some use the following with\nless pcrs and a wipe feature:</p>\n<pre><code class=\"language-bash\">sudo systemd-cryptenroll --wipe-slot=tpm2 --tpm2-device=auto --tpm2-pcrs=0+7 /dev/disk/by-partlabel/luks\n</code></pre>\n<ul>\n<li>\n<p>Using less pcrs could prevent breakage but reduces security. Check out the PCR\nDefinitions below and decide if you require additional PCRs or less.</p>\n</li>\n<li>\n<p><code>wipe-slot</code> tells the system to delete any key associated with the TPM2 chip\nfrom the LUKS volume‚Äôs keyslot before adding a new one.</p>\n</li>\n</ul>\n<p>You can choose a more complex <code>--tpm2-pcrs</code> for more security but it makes the\nconfiguration more fragile because any legitimate system update altering any\nmeasured component tied to these PCRs will prevent the TPM from releasing the\nkey and lock you out, unless you re-enroll the key with the updated PCR values.</p>\n<ul>\n<li>\n<p><a href=\"https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/\">PCR Definitions</a></p>\n</li>\n<li>\n<p><a href=\"https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html\">Authenticated Boot and FDE</a>\nThis article explains the limitations and remedies very well.</p>\n</li>\n</ul>\n<p>That said, I do often see people mention a firmware update breaking their TPM2\nauto-unlock functionality. Keep this in mind and have a backup plan. This is\nalso incompatible with the encrypted impermanence setup shared in this book, the\n<code>boot.initrd.postDeviceCommands</code> conflict.</p>\n<p>Change <code>YourUser</code> to your username and ensure that <code>cryptroot</code> is the name of\nyours, if you followed this books encrypted disko install it should be:</p>\n<pre><code class=\"language-nix\">  # Adds your user to the 'tss' group, allowing you to interact with the TPM\n  users.users.YourUser.extraGroups = [ \"tss\" ];\n  # Enables TPM2 services and tools on your system\n  security.tpm2.enable = true;\n  # Ensure the necessary kernel modules are in the initrd\n  boot.initrd.kernelModules = [\"tpm_tis\"];\n  # switches the initrd to a systemd-based environment, required for TPM2\n  boot.initrd.systemd.enable = true;\n  # ‚ùó Tell the initrd to use the TPM2 key for the encrypted root\n  boot.initrd.luks.devices.cryptroot = {\n    device = \"/dev/disk/by-partlabel/luks\";\n    # These options tell systemd-cryptsetup to automatically try to unlock the device\n    # using the TPM2 key. 'tpm2-measure=yes' ensures the PCRs are verified but only works if you use one disk\n    crypttabExtraOpts = [\"tpm2-device=auto\" \"tpm2-measure=yes\"];\n    fallbackToPassword = true;\n  };\n  environment.systemPackages = [ pkgs.tpm2-tss ];\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: <code>cryptroot</code> needs to match what your encrypted partition is named, I\nhave seen quite a few different names here.</p>\n</blockquote>\n<p>If you use this, you can‚Äôt also use the USB Keyfile or the included impermanence\nguide.</p>\n</details>\n<p><strong>Description</strong></p>\n<ul>\n<li>\n<p><code>/dev/disk/by-partlabel/luks</code> refers to your encrypted partition by its\npartition label, which is stable and less likely to change than\n<code>/dev/nvme0n1p2</code></p>\n</li>\n<li>\n<p><code>/root/usb-luks.key</code> is the keyfile we generated.</p>\n</li>\n<li>\n<p>You‚Äôll be prompted to enter your existing LUKS passphrase to authorize adding\nthe new key.</p>\n</li>\n<li>\n<p>Now our LUKS volume will accept both our existing passphrase and the new\nkeyfile (from the USB stick) for unlocking.</p>\n</li>\n</ul>\n<ol>\n<li><strong>Clear Data on USB stick and replace with 0‚Äôs</strong></li>\n</ol>\n<pre><code class=\"language-bash\">lsblk\nNAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsda           8:0    1   239M  0 disk\nsdb           8:16   1   1.4M  0 disk  /run/media/jr/7CD1-149A # Example USB mount\nzram0       253:0    0   7.5G  0 disk  [SWAP]\nnvme0n1     259:0    0 476.9G  0 disk\n‚îú‚îÄnvme0n1p1 259:1    0   512M  0 part  /boot\n‚îî‚îÄnvme0n1p2 259:2    0 476.4G  0 part\n  ‚îî‚îÄcryptroot 254:0  0 476.4G  0 crypt /persist  # Main Btrfs mount\n                                               # (other subvolumes are within /persist and bind-mounted by impermanence)\n# unplug the device and run lsblk again so your sure\n</code></pre>\n<ol start=\"2\">\n<li>Before wiping you must unmount any mounted partitions:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo umount /dev/sda1\n</code></pre>\n<pre><code class=\"language-bash\"># Overwrite with Zeros (fast, sufficient for most uses)\nsudo dd if=/dev/zero of=/dev/sda bs=4M status=progress\n# Or overwrite with Random Data (More Secure, Slower)\nsudo dd if=/dev/urandom of=/dev/sda bs=4M status=progress\n# Or for the most secure way run multiple passes of\nsudo shred -v -n 3 /dev/sda\n</code></pre>\n<ol start=\"3\">\n<li>Create a New Partition and Format (Optional)</li>\n</ol>\n<pre><code class=\"language-bash\">sudo fdisk /dev/sda\n</code></pre>\n<ol>\n<li>\n<p>Press <code>o</code> to create a new empty DOS partition table (if you are creating\npartitions on a fresh disk or want to wipe existing partitions and start\nover). Be very careful with this step as it will erase all existing\npartition information on the disk.</p>\n</li>\n<li>\n<p>Press <code>n</code> to create a new partition.</p>\n</li>\n</ol>\n<ul>\n<li>\n<p>You will then be prompted for the partition type:</p>\n<ul>\n<li>\n<p><code>p</code> for a primary partition (you can have up to 4 primary partitions)</p>\n</li>\n<li>\n<p><code>e</code> for an extended partition (which can contain logical partitions)</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Next, you‚Äôll be asked for the partition number (e.g., 1, 2, 3, 4).</p>\n</li>\n<li>\n<p>Then, you‚Äôll be asked for the first sector (press Enter to accept the default,\nwhich is usually the first available sector after the previous partition or\nthe beginning of the disk).</p>\n</li>\n<li>\n<p>Finally, you‚Äôll be asked for the last sector or size (you can specify a size\nlike +10G for 10 Gigabytes, +512M for 512 Megabytes, or press Enter to use the\nrest of the available space).</p>\n</li>\n</ul>\n<ol start=\"3\">\n<li>Press <code>w</code> to write the changes to the partition table and exit fdisk.</li>\n</ol>\n<p>After pressing <code>w</code>, the kernel needs to be aware of the new partition table.\nSometimes this happens automatically, but if you encounter issues, a reboot or a\ncommand like <code>partprobe</code> (if available and needed) can help.</p>\n<p>Formats as FAT32:</p>\n<pre><code class=\"language-bash\">sudo mkfs.vfat /dev/sda1\n# or as ext4\nsudo mkfs.ext4 /dev/sda1\n</code></pre>\n<p>I chose <code>vfat</code> so I ran <code>sudo mkfs.vfat /dev/sda1</code>. In my case this changed the\ndevice path to <code>/run/media/jr/7CD1-149A</code> so it‚Äôs important to find your own UUID\nwith the following command:</p>\n<pre><code class=\"language-bash\">sudo blkid /dev/sda1\n/dev/sda1: SEC_TYPE=\"msdos\" UUID=\"B7B4-863B\" BLOCK_SIZE=\"512\" TYPE=\"vfat\" PARTUUID=\"7d1f9d7f-01\"\n</code></pre>\n<ul>\n<li>\n<p>As you can see the above UUID is <code>\"B7B4-863B\"</code></p>\n</li>\n<li>\n<p>Remove and re-insert the USB stick, this ensures the system recognizes the new\npartition and filesystem.</p>\n</li>\n</ul>\n<ol start=\"4\">\n<li>Copy the keyfile to your USB Stick</li>\n</ol>\n<pre><code class=\"language-bash\">sudo cp /root/usb-luks.key /run/media/jr/B7B4-863B/\nsync\n</code></pre>\n<ol start=\"5\">\n<li>Update your NixOS Configuration</li>\n</ol>\n<p>Note the output of <code>blkid /dev/sda1</code> and if you have a backup device list that\nalso:</p>\n<p>The following is from the wiki edited for my setup, it was created by Tzanko\nMatev:</p>\n<pre><code class=\"language-nix\">let\n  PRIMARYUSBID = \"B7B4-863B\";\n  BACKUPUSBID = \"Ventoy\";\nin {\n\n  boot.initrd.kernelModules = [\n    \"uas\"\n    \"usbcore\"\n    \"usb_storage\"\n    \"vfat\"\n    \"nls_cp437\"\n    \"nls_iso8859_1\"\n  ];\n\n  boot.initrd.postDeviceCommands = lib.mkBefore ''\n    mkdir -p /key\n    sleep 2\n    mount -n -t vfat -o ro $(findfs UUID=${PRIMARYUSBID}) /key || \\\n    mount -n -t vfat -o ro $(findfs UUID=${BACKUPUSBID}) /key || echo \"No USB key found\"\n  '';\n\n  boot.initrd.luks.devices.cryptroot = {\n    device = \"/dev/disk/by-partlabel/luks\";\n    keyFile = \"/key/usb-luks.key\";\n    fallbackToPassword = true;\n    allowDiscards = true;\n    preLVM = false; # Crucial!\n  };\n}\n</code></pre>\n<p>If you have issues or just want to remove the key take note of the path used to\nadd it so you don‚Äôt have to enter the whole key:</p>\n<pre><code class=\"language-bash\">sudo cryptsetup luksRemoveKey /dev/disk/by-partlabel/luks --key-file /root/usb-luks.key\n</code></pre>\n<ol start=\"6\">\n<li>Securely Remove the Keyfile from Your System:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo shred --remove --zero /root/usb-luks.key\n</code></pre>\n<h2>Instructions for Using a USB Stick with Existing Data</h2>\n<ol>\n<li>Generate the Keyfile</li>\n</ol>\n<pre><code class=\"language-bash\">sudo dd if=/dev/urandom of=/root/usb-luks.key bs=4096 count=1\n</code></pre>\n<ol start=\"2\">\n<li>Add the Keyfile to your LUKS Volume</li>\n</ol>\n<pre><code class=\"language-bash\">sudo cryptsetup luksAddKey /dev/disk/by-partlabel/luks /root/usb-luks.key\n</code></pre>\n<p>(enter your existing passphrase when prompted)</p>\n<ol start=\"3\">\n<li>Copy the Keyfile to the USB Stick</li>\n</ol>\n<ul>\n<li>\n<p>Plug in the USB Stick and note its mount point\n(e.g.,<code>/run/media/$USER/YourLabel</code>)</p>\n</li>\n<li>\n<p>Copy the keyfile:</p>\n</li>\n</ul>\n<pre><code class=\"language-bash\">sudo cp /root/usb-luks.key /run/media/$USER/YourLabel/\nsync\n</code></pre>\n<ul>\n<li>\n<p>You run the above as 2 commands, the second being <code>sync</code>.</p>\n</li>\n<li>\n<p>You can rename it if you wish (e.g., <code>luks.key</code>)</p>\n</li>\n</ul>\n<ol start=\"4\">\n<li>Securely Delete the Local Keyfile</li>\n</ol>\n<pre><code class=\"language-bash\">sudo shred --remove --zero /root/usb-luks.key\n</code></pre>\n<ul>\n<li>You need to ensure the keyfile is accessible in the initrd. Since automounting\n(like <code>/run/media/...</code>) does not happen in <code>initrd</code>, you must manually mount\nthe USB in the <code>initrd</code> using its <code>UUID</code> or label.</li>\n</ul>\n<p>Find the USB Partition UUID:</p>\n<pre><code class=\"language-bash\">lsblk -o NAME,UUID\n# or\nblkid /dev/sda1\n</code></pre>\n<p>Suppose the UUID is <code>B7B4-863B</code></p>\n<p>Add to your <code>configuration.nix</code>:</p>\n<pre><code class=\"language-nix\">boot.initrd.kernelModules = [ \"usb_storage\" \"vfat\" \"nls_cp437\" \"nls_iso8859_1\" ];\n\nboot.initrd.postDeviceCommands = lib.mkBefore ''\n  mkdir -p /key\n  sleep 1\n  mount -n -t vfat -o ro $(findfs UUID=B7B4-863B) /key || echo \"USB not found\"\n'';\n\nboot.initrd.luks.devices.cryptroot = {\n  device = \"/dev/disk/by-partlabel/luks\";\n  keyFile = \"/key/usb-luks.key\"; # or whatever you named it\n  fallbackToPassword = true;\n  allowDiscards = true;\n};\n</code></pre>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/installation/enc/encrypted_impermanence.html",
      "url": "https://saylesss88.github.io/installation/enc/encrypted_impermanence.html",
      "title": "Encrypted Impermanence",
      "content_html": "<h1>Encrypted Impermanence</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<blockquote>\n<p>‚ùó Important Note: This guide details a setup involving encrypted partitions\nand impermanent NixOS. While powerful, such configurations require careful\nattention to detail. Incorrect steps, especially concerning encryption keys or\npersistent data paths, can lead to <strong>permanent data loss</strong>. Please read all\ninstructions thoroughly before proceeding and consider backing up any critical\ndata beforehand. This has only been tested with the disk layout described in\n<a href=\"https://saylesss88.github.io/installation/encrypted_manual.html\">Encrypted Setups</a></p>\n</blockquote>\n<p>As a system operates, it gradually accumulates state on its root partition. This\nstate is stored in various directories such as <code>/etc</code> and <code>/var</code>, capturing all\nthe configuration changes, logs, and other modifications‚Äîwhether they‚Äôre\nwell-documented or the result of ad-hoc adjustments made while setting up and\nrunning services.</p>\n<p><strong>Impermanence</strong>,in the context of operating systems, refers to a setup where\nthe majority of the system‚Äôs root filesystem (<code>/</code>) is reset to a pristine state\non every reboot. This means any changes made to the system (e.g., installing new\npackages, modifying system files outside of configuration management, creating\ntemporary files) are discarded upon shutdown or reboot.</p>\n<p>Having an impermanent root and <code>/tmp</code> has some security benefits as well. By\nreducing your persistent footprint you reduce your chance of leaving behind\nsensitive activity or data. Since Nix can boot with only <code>/nix</code> and <code>/boot</code>,\nexperienced users familiar with ‚Äústateless‚Äù systems can take advantage of this\nsmaller attack surface.</p>\n<p>Although this setup does not use <code>/tmp</code> as the root filesystem, the root itself\nis restored to its original state upon each reboot, as it was at installation.\nHowever, by configuring <code>/tmp</code> to reside in RAM, you ensure that temporary files\nincluding sensitive data like passwords are stored only in volatile memory and\nare automatically cleared on shutdown or reboot. This significantly enhances the\nsecurity of temporary data by preventing it from ever being written to disk.</p>\n<h3>Getting Started</h3>\n<ol>\n<li>Add impermanence to your <code>flake.nix</code>. You will change the <code>hostname</code> in the\nflake to match your <code>networking.hostName</code>.</li>\n</ol>\n<pre><code class=\"language-nix\"># flake.nix\n{\n  description = \"NixOS configuration\";\n\n  inputs = {\n    nixpkgs.url = \"github:nixos/nixpkgs/nixos-unstable\";\n    disko.url = \"github:nix-community/disko/latest\";\n    disko.inputs.nixpkgs.follows = \"nixpkgs\";\n    impermanence.url = \"github:nix-community/impermanence\";\n  };\n\n  outputs = inputs@{ nixpkgs, ... }: {\n    nixosConfigurations = {\n      hostname = nixpkgs.lib.nixosSystem {\n        system = \"x86_64-linux\";\n        modules = [\n          ./configuration.nix\n          inputs.disko.nixosModules.disko\n          inputs.impermanence.nixosModules.impermanence\n        ];\n      };\n    };\n  };\n}\n</code></pre>\n<ol start=\"2\">\n<li>Discover where your root subvolume is located with <code>findmnt</code>:</li>\n</ol>\n<p>If you followed the\n<a href=\"https://saylesss88.github.io/installation/encrypted_manual.html\">Encrypted Setups</a>\nguide, your encrypted subvolume should be located at:\n<code>/dev/mapper/cryptroot /mnt</code></p>\n<ul>\n<li>Your encrypted Btrfs partition, once unlocked by LUKS, will be available at\n<code>/dev/mapper/cryptroot</code> as configured here in the <code>disk-config.nix</code>:</li>\n</ul>\n<pre><code class=\"language-nix\"># disk-config2.nix\n# ... snip ...\n            luks = {\n              size = \"100%\";\n              label = \"luks\";\n              content = {\n                type = \"luks\";\n                name = \"cryptroot\";\n                content = {\n# ... snip ...\n</code></pre>\n<p>Double check that the paths exist:</p>\n<pre><code class=\"language-bash\">cd /dev/mapper/crypt&lt;TAB&gt;  # autocomplete should fill out /dev/mapper/cryptroot\n</code></pre>\n<ol start=\"3\">\n<li>Create an <code>impermanence.nix</code>:</li>\n</ol>\n<p>Now, create a new file named <code>impermanence.nix</code> in your configuration directory\n(i.e. your flake directory). This file will contain all the specific settings\nfor your impermanent setup, including BTRFS subvolume management and persistent\ndata locations. Since this file is right next to your <code>configuration.nix</code>,\nyou‚Äôll just add an <code>imports = [ ./impermanence.nix ]</code> to your\n<code>configuration.nix</code> apply it to your configuration.</p>\n<pre><code class=\"language-nix\">{\n  config,\n  lib,\n  ...\n}: {\n  boot.initrd.postDeviceCommands = lib.mkAfter ''\n    echo \"Rollback running\" &gt; /mnt/rollback.log\n     mkdir -p /mnt\n     mount -t btrfs /dev/mapper/cryptroot /mnt\n\n     # Recursively delete all nested subvolumes inside /mnt/root\n     btrfs subvolume list -o /mnt/root | cut -f9 -d' ' | while read subvolume; do\n       echo \"Deleting /$subvolume subvolume...\" &gt;&gt; /mnt/rollback.log\n       btrfs subvolume delete \"/mnt/$subvolume\"\n     done\n\n     echo \"Deleting /root subvolume...\" &gt;&gt; /mnt/rollback.log\n     btrfs subvolume delete /mnt/root\n\n     echo \"Restoring blank /root subvolume...\" &gt;&gt; /mnt/rollback.log\n     btrfs subvolume snapshot /mnt/root-blank /mnt/root\n\n     umount /mnt\n  '';\n\n  environment.persistence.\"/persist\" = {\n    directories = [\n      \"/etc\"\n      \"/var/spool\"\n      \"/root\"\n      \"/srv\"\n      \"/etc/NetworkManager/system-connections\"\n      \"/var/lib/bluetooth\"\n    ];\n    files = [\n      # \"/etc/machine-id\"\n      # Add more files you want to persist\n    ];\n  };\n\n# optional quality of life setting\n  security.sudo.extraConfig = ''\n    Defaults lecture = never\n  '';\n}\n</code></pre>\n<ul>\n<li><code>/mnt/rollback.log</code>: this log will be available during the boot process for\ndebugging if the rollback fails, but won‚Äôt persist.</li>\n</ul>\n<p>With the above impermanence script, the btrfs subvolumes are deleted recursively\nand replaced with the <code>root-blank</code> snapshot we took during the install.</p>\n<p>I have commented out <code>\"/etc/machine-id\"</code> because we already copied over all of\nthe files to their persistent location and the above setting would work once and\nthen cause a conflict.</p>\n<h2>configuration.nix changes</h2>\n<pre><code class=\"language-nix\"># configuration.nix\n  boot.initrd.luks.devices = {\n    cryptroot = {\n      device = \"/dev/disk/by-partlabel/luks\";\n      allowDiscards = true;\n      preLVM = true;\n    };\n  };\n</code></pre>\n<ul>\n<li>This defines how your system‚Äôs initial ramdisk (<code>initrd</code>) should handle a\nspecific encrypted disk during the boot process. It helps with timing and is a\nmore robust way of telling Nix that we are using an encrypted disk.</li>\n</ul>\n<p>The following is optional to enable <code>autoScrub</code> for btrfs, the wiki shows\n<code>interval = \"monthly\";</code> FYI.</p>\n<pre><code class=\"language-nix\"># configuration.nix\n  services.btrfs.autoScrub = {\n    enable = true;\n    interval = \"weekly\";\n    fileSystems = [\"/\"];\n  };\n</code></pre>\n<ul>\n<li>Remember to ensure that your <code>hostname</code> in your <code>configuration.nix</code> matches\nthe <code>hostname</code> in your <code>flake.nix</code>.</li>\n</ul>\n<h3>Applying Your Impermanence Configuration</h3>\n<p>Once you have completed all the steps and created or modified the necessary\nfiles (<code>flake.nix</code>, <code>impermanence.nix</code>), you need to apply these changes to your\nNixOS system.</p>\n<ol>\n<li>Navigate to your NixOS configuration directory (where your <code>flake.nix</code> is\nlocated).</li>\n</ol>\n<pre><code class=\"language-bash\">cd /path/to/your/flake\n</code></pre>\n<ol start=\"2\">\n<li>Rebuild and Switch: Execute the <code>nixos-rebuild switch</code> command. This command\nwill:</li>\n</ol>\n<ul>\n<li>\n<p>Evaluate your <code>flake.nix</code> and the modules it imports (including your new\n<code>impermanence.nix</code>).</p>\n</li>\n<li>\n<p>Build a new NixOS system closure based on your updated configuration.</p>\n</li>\n<li>\n<p>Activate the new system configuration, making it the current running system.</p>\n</li>\n</ul>\n<pre><code class=\"language-bash\">sudo nixos-rebuild switch --flake .#hostname # Replace 'hostname' with your actual system hostname\n</code></pre>\n<ol start=\"3\">\n<li>Perform an Impermanence Test (Before Reboot):</li>\n</ol>\n<ul>\n<li>Before you reboot, create a temporary directory and file in a non-persistent\nlocation. Since you haven‚Äôt explicitly added <code>/imperm_test</code> to your\n<code>environment.persistence.\"/persist\"</code> directories, this file should not survive\na reboot.</li>\n</ul>\n<pre><code class=\"language-bash\">mkdir /imperm_test\necho \"This should be Gone after Reboot\" | sudo tee /imperm_test/testfile\nls -l /imperm_test/testfile # Verify the file exists\ncat /imperm_test/testfile # Verify content\n</code></pre>\n<ol start=\"4\">\n<li>Reboot Your System: For the impermanence setup to take full effect and for\nyour root filesystem to be reset for the first time, you must reboot your\nmachine.</li>\n</ol>\n<pre><code class=\"language-bash\">sudo reboot\n</code></pre>\n<ol start=\"5\">\n<li>Verify Impermanence (After Reboot):</li>\n</ol>\n<ul>\n<li>After the system has rebooted, check if the test directory and file still\nexist:</li>\n</ul>\n<pre><code class=\"language-bash\">ls -l /imperm_test/testfile\n</code></pre>\n<p>You should see an output like <code>ls: cannot access '/imperm_test/testfile'</code>: No\nsuch file or directory. This confirms that the <code>/imperm_test</code> directory and its\ncontents were indeed ephemeral and were removed during the reboot process,\nindicating your impermanence setup is working correctly!</p>\n<p>Your system should now come up with a fresh root filesystem, and only the data\nspecified in your <code>environment.persistence.\"/persist\"</code> configuration will be\npersistent.</p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/installation/enc/lanzaboote.html",
      "url": "https://saylesss88.github.io/installation/enc/lanzaboote.html",
      "title": "Lanzaboote",
      "content_html": "<h1>Secure Boot with Lanzaboote</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p>‚ö†Ô∏è <strong>Warning: This can easily brick your system</strong> ‚ö†Ô∏è</p>\n<p>We will mainly follow the lanzaboote\n<a href=\"https://github.com/nix-community/lanzaboote/blob/master/docs/QUICK_START.md\">Quick Start Guide</a></p>\n<p>For Windows dual-booters and BitLocker users, you should export your BitLocker\nrecovery keys and confirm that they are correct. Refer to this\n<a href=\"https://support.microsoft.com/en-us/windows/find-your-bitlocker-recovery-key-6b71ad27-0b89-ea08-f143-056f5ab347d6\">Microsoft support article</a></p>\n<blockquote>\n<p>‚ùó NOTE: There are some serious limitations to this setup when used without\nencryption, I‚Äôd say it could stop the average person. But an experienced\nhacker could easily bypass this without encryption if they had access to your\ncomputer. For more protection look into TPM2 Hardware Requirements, and full\ndisk encryption.</p>\n</blockquote>\n<h2>Important Considerations</h2>\n<p>I found\n<a href=\"https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html\">This Article</a>\nfairly enlightening as far as the state of Authenticated Boot and Disk\nEncryption on Linux.</p>\n<ul>\n<li><a href=\"https://0pointer.net/blog/brave-new-trusted-boot-world.html\">Brave New Trusted Boot World</a></li>\n</ul>\n<p>Lanzaboote only secures the boot chain. The userspace remains unverified (i.e.,\nthe nix store, etc.), to verify userspace you need to implement additional\nintegrity checks. It‚Äôs common to rely to disk encryption to prevent tampering\nwith and keep the Nix store safe but it‚Äôs not always desirable. (i.e.,\nunattended boot)</p>\n<h2>Requirements</h2>\n<p>To be able to setup Secure Boot on your device, NixOS needs to be installed in\nUEFI mode and systemd-boot must be used as a boot loader. This means if you wish\nto install lanzaboote on a new machine, you need to follow the install\ninstruction for systemd-boot and then switch to lanzaboote after the first boot.</p>\n<p>Check these prerequisits with <code>bootctl status</code>, this is an example output:</p>\n<pre><code class=\"language-bash\">sudo bootctl status\nSystem:\n     Firmware: UEFI 2.70 (Lenovo 0.4720)\n  Secure Boot: disabled (disabled)\n TPM2 Support: yes\n Boot into FW: supported\n\nCurrent Boot Loader:\n      Product: systemd-boot 251.7\n...\n</code></pre>\n<p>The firmware <strong>must</strong> be <code>UEFI</code> and the current bootloader needs to be\n<code>systemd-boot</code>. If you check these boxes, you‚Äôre good to go.</p>\n<h2>Security Requirements</h2>\n<p>To provide any security your system needs to defend against an attacker turning\nUEFI Secure Boot off or being able to sign binaries with the keys we are going\nto generate.</p>\n<p>The easiest way to achieve this is to:</p>\n<ol>\n<li>\n<p>Enable a BIOS password for your system, this will prevent someone from just\nshutting off secure boot.</p>\n</li>\n<li>\n<p>Use full disk encryption.</p>\n</li>\n</ol>\n<h2>Preparation</h2>\n<p><strong>Finding the UEFI System Partition (ESP)</strong></p>\n<p>The UEFI boot process revolves around the ESP, the (U)EFI System Partition. This\npartition is conventionally mounted at <code>/boot</code> on NixOS.</p>\n<p>Verify this with the command <code>sudo bootctl status</code>. Look for <code>ESP:</code></p>\n<p><strong>Creating Your Keys</strong></p>\n<p>First you‚Äôll need to install <code>sbctl</code> which is available in <code>Nixpkgs</code>:</p>\n<pre><code class=\"language-nix\"># configuration.nix or equivalent\nenvironment.systemPackages = [ pkgs.sbctl ];\n</code></pre>\n<p>Create the keys:</p>\n<pre><code class=\"language-bash\">$ sudo sbctl create-keys\n[sudo] password for julian:\nCreated Owner UUID 8ec4b2c3-dc7f-4362-b9a3-0cc17e5a34cd\nCreating secure boot keys...‚úì\nSecure boot keys created!\n</code></pre>\n<p>If you already have keys in <code>/etc/secureboot</code> migrate these to <code>/var/lib/sbctl</code>:</p>\n<pre><code class=\"language-bash\">sbctl setup --migrate\n</code></pre>\n<h2>Configuring Lanzaboote With Flakes</h2>\n<p>Shown all in <code>flake.nix</code> for brevity. Can easily be split up into a <code>boot.nix</code>,\netc:</p>\n<pre><code class=\"language-nix\">{\n  description = \"A SecureBoot-enabled NixOS configurations\";\n\n  inputs = {\n    nixpkgs.url = \"github:NixOS/nixpkgs/nixos-unstable\";\n\n    lanzaboote = {\n      url = \"github:nix-community/lanzaboote/v0.4.2\";\n\n      # Optional but recommended to limit the size of your system closure.\n      inputs.nixpkgs.follows = \"nixpkgs\";\n    };\n  };\n\n  outputs = { self, nixpkgs, lanzaboote, ...}: {\n    nixosConfigurations = {\n      yourHost = nixpkgs.lib.nixosSystem {\n        system = \"x86_64-linux\";\n\n        modules = [\n          # This is not a complete NixOS configuration and you need to reference\n          # your normal configuration here.\n\n          lanzaboote.nixosModules.lanzaboote\n\n          ({ pkgs, lib, ... }: {\n\n            environment.systemPackages = [\n              # For debugging and troubleshooting Secure Boot.\n              pkgs.sbctl\n            ];\n\n            # Lanzaboote currently replaces the systemd-boot module.\n            # This setting is usually set to true in configuration.nix\n            # generated at installation time. So we force it to false\n            # for now.\n            boot.loader.systemd-boot.enable = lib.mkForce false;\n\n            boot.lanzaboote = {\n              enable = true;\n              pkiBundle = \"/var/lib/sbctl\";\n            };\n          })\n        ];\n      };\n    };\n  };\n}\n</code></pre>\n<p><strong>Build it</strong></p>\n<pre><code class=\"language-bash\">sudo nixos-rebuild switch --flake /path/to/flake\n</code></pre>\n<h3>Ensure Your Machine is Ready for Secure Boot enforcement</h3>\n<pre><code class=\"language-bash\">$ sudo sbctl verify\nVerifying file database and EFI images in /boot...\n‚úì /boot/EFI/BOOT/BOOTX64.EFI is signed\n‚úì /boot/EFI/Linux/nixos-generation-355.efi is signed\n‚úì /boot/EFI/Linux/nixos-generation-356.efi is signed\n‚úó /boot/EFI/nixos/0n01vj3mq06pc31i2yhxndvhv4kwl2vp-linux-6.1.3-bzImage.efi is not signed\n‚úì /boot/EFI/systemd/systemd-bootx64.efi is signed\n</code></pre>\n<h3>Enabling Secure Boot and Entering Setup Mode</h3>\n<p>This is where things can get tricky because UEFI/BIOS are widely different and\nuse different conventions.</p>\n<p>You can see your BIOS from the output of <code>bootctl status</code>:</p>\n<pre><code class=\"language-bash\">sudo bootctl status\ndoas (jr@magic) password:\nSystem:\n      Firmware: UEFI 2.70 (American Megatrends)\n</code></pre>\n<p>My UEFI is an American Megatrends, find yours and look up which key you have to\nhit to enter the BIOS on reboot, mine is the delete key. So I reboot and\nrepeatedly hit delete until it brings up the BIOS settings.</p>\n<p>The lanzaboote guide shows a few systems and how to enter setup mode for them.</p>\n<p>For a ThinkPad the steps are:</p>\n<ol>\n<li>\n<p>Select the ‚ÄúSecurity‚Äù tab.</p>\n</li>\n<li>\n<p>Select the ‚ÄúSecure Boot‚Äù entry.</p>\n</li>\n<li>\n<p>Set ‚ÄúSecure Boot‚Äù to enabled.</p>\n</li>\n<li>\n<p>Select ‚ÄúReset to Setup Mode‚Äù.</p>\n</li>\n</ol>\n<hr />\n<p>For my system, it would allow me to do the above steps but when I saved and\nexited I got a red screen then blue screen and it said No Valid Keys or\nsomething like that and eventually brought me to the MOK Manager where you can\nmanually register keys, this is NOT what you want to do.</p>\n<p>Even after this mistake I was able to re-enable secure boot and get back into\nthe system.</p>\n<p>After some tinkering, I found that I was able to enter ‚Äúcustom mode‚Äù without\nenabling secure boot, which in turn allowed me to select the ‚ÄúReset to Setup\nMode‚Äù</p>\n<p>It asks if you are sure you want to erase all of the variables to enter setup\nmode? Hit ‚ÄúYes‚Äù. Then it asks if you want to exit without saving, we want to\nsave our changes so hit ‚ÄúNo‚Äù do not exit without saving.</p>\n<p>After this you should see all No Keys entries.</p>\n<p>Finally, Hit the setting to save and exit, some BIOS list an F4 or F9 keybind\nthat saves and exits.</p>\n<blockquote>\n<p>‚ùó: For my system, choosing ‚Äúsave and reboot‚Äù would not work for some reason,\nI had to choose ‚Äúsave and exit‚Äù.</p>\n</blockquote>\n<p>After hitting ‚Äúsave and exit‚Äù, the system boots into NixOS like normal but you\nare in setup mode if everything worked correctly.</p>\n<p>Open a terminal and type:</p>\n<pre><code class=\"language-bash\">sudo sbctl enroll-keys --microsoft\nEnrolling keys to EFI variables...\nWith vendor keys from microsoft...‚úì\nEnrolled keys to the EFI variables!\n</code></pre>\n<blockquote>\n<p>‚ö†Ô∏è If you used <code>--microsoft</code> while enrolling the keys, you might want to check\nthat the Secure Boot Forbidden Signature Database (dbx) is not empty. A quick\nand dirty way is by checking the file size of\n<code>/sys/firmware/efi/efivars/dbx-\\*</code>. Keeping an up to date dbx reduces Secure\nBoot bypasses, see for example:\n<a href=\"https://uefi.org/sites/default/files/resources/dbx_release_info.pdf\">https://uefi.org/sites/default/files/resources/dbx_release_info.pdf</a></p>\n</blockquote>\n<p>I then Rebooted into BIOS and enabled secure boot, saved and exited. This loads\nNixOS as if you just rebooted.</p>\n<p>And finally check the output of <code>sbctl status</code>:</p>\n<pre><code class=\"language-bash\">sudo sbctl status\nSystem:\n      Firmware: UEFI 2.70 (American Megatrends)\n Firmware Arch: x64\n   Secure Boot: enabled (user)\n  TPM2 Support: yes\n  Measured UKI: yes\n  Boot into FW: supported\n</code></pre>\n<p>We can see the <code>Secure Boot: enabled (user)</code></p>\n<h2>What Lanzaboote (Secure Boot) Actually Secures on NixOS and Limitations</h2>\n<p>As mentioned earlier, this provides some basic protection that may be good\nenough for your desktop in your bedroom but there are some serious limitations.\nI want to be clear that this may stop an average person but an advanced threat\nactor with resources could still fairly easily get in.</p>\n<p>Secure Boot (with Lanzaboote or any other tool) on NixOS primarily protects the\nboot chain‚Äîthe bootloader, kernel, and initrd‚Äîby ensuring only signed, trusted\nbinaries are executed at boot. This is a real and valuable security improvement,\nespecially for defending against ‚Äúevil maid‚Äù attacks (where someone with\nphysical access tampers with your bootloader or kernel) and for preventing many\nforms of persistent malware.</p>\n<p>Here are some of the caveats:</p>\n<ol>\n<li>\n<p>Userspace Remains Unverified</p>\n<p>Once the kernel and initrd have booted, NixOS (by default) does not\ncryptographically verify the integrity of the rest of userspace (the programs\nand libraries in the Nix store, your configs, etc.).</p>\n<p>This means an attacker who can modify userspace (e.g., by gaining root\naccess) can potentially install persistent malware, even if your boot chain\nis protected</p>\n<p>.</p>\n</li>\n<li>\n<p>Kernel Lockdown Is Not Enabled</p>\n<p>The Linux kernel‚Äôs [lockdown mode]</p>\n<p>is designed to prevent even root from tampering with the kernel at runtime\n(e.g., by loading unsigned modules, using kexec, or accessing /dev/mem).</p>\n<p>NixOS does not enable kernel lockdown by default, and enabling it is\nnon-trivial, especially given how the Nix store works (modules and kernels\nare built dynamically and not always signed at install time).</p>\n<p>Without lockdown, a root user (or malware with root) can still compromise the\nkernel after boot.</p>\n</li>\n<li>\n<p>Stage 2 Verification Is Lacking</p>\n<p>Some distributions (like Fedora Silverblue or systems using dm-verity)\ncryptographically verify the entire userspace at boot, making it immutable\nand much harder to tamper with. This is not the default on NixOS, though\nthere are experimental or appliance-focused solutions</p>\n<p>.</p>\n</li>\n<li>\n<p>Disk Encryption Complements Secure Boot</p>\n<p>Full disk encryption (e.g., LUKS) is strongly recommended alongside Secure\nBoot. Encryption protects your data at rest and ensures that even if someone\nbypasses Secure Boot, they cannot read or modify your files without your\npassphrase</p>\n</li>\n</ol>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/installation/enc/enc_install.html",
      "url": "https://saylesss88.github.io/installation/enc/enc_install.html",
      "title": "Encrypted Install",
      "content_html": "<h1>Encrypted Setups</h1>\n<details>\n<summary> ‚úîÔ∏è Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p>NixOS supports file systems that are encrypted using LUKS (Linux Unified Key\nSetup). This guide walks you through an encrypted NixOS installation using Disko\nfor disk management and Btrfs for subvolumes. It is designed for users who want\nfull disk encryption and a modern filesystem layout. If you prefer an\nunencrypted setup, you can skip the LUKS and encryption steps, but this guide\nfocuses on security and flexibility.</p>\n<ul>\n<li>For Unencrypted layout\n<a href=\"https://saylesss88.github.io/installation/unencrypted/unencrypted.html\">Click Here</a></li>\n</ul>\n<p>If you choose to set up impermanence, ensure it matches your install. Encrypted\nSetup with Encrypted Impermanence and Unencrypted Setup with Unencrypted\nImpermanence.</p>\n<blockquote>\n<p>‚ùó NOTE: This is a bit convoluted, there are a few paths you can follow. If\nyou choose to use the starter repo (<a href=\"https://github.com/saylesss88/my-flake\">https://github.com/saylesss88/my-flake</a>)\njust follow the included README and use this for reference.</p>\n</blockquote>\n<h2>What does LUKS Encryption Protect?</h2>\n<p>It‚Äôs important to understand what disk encryption protects and what it doesn‚Äôt\nprotect so you don‚Äôt have any misconceptions about how safe your data is.</p>\n<ul>\n<li>\n<p><a href=\"https://wiki.nixos.org/wiki/Full_Disk_Encryption\">NixOS Wiki FDE</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.archlinux.org/title/Data-at-rest_encryption\">Arch Wiki Data-at-rest encryption</a></p>\n</li>\n<li>\n<p><a href=\"https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html\">Authenticated Booot and DE on Linux</a></p>\n</li>\n<li>\n<p><a href=\"https://oddlama.org/blog/bypassing-disk-encryption-with-tpm2-unlock/\">Bypassing FDE with TPM2 Unlock</a></p>\n</li>\n</ul>\n<p><strong>What LUKS Protects</strong>:</p>\n<ul>\n<li>\n<p><strong>Data Confidentiality at Rest</strong>: LUKS encrypts entire block devices (such as\ndisk partitions or whole drives), ensuring that all data stored on the\nencrypted device is unreadable without the correct decryption key or\npassphrase. This protects sensitive information from unauthorized access if\nthe device is lost, stolen, or physically accessed by an attacker.</p>\n</li>\n<li>\n<p><strong>Physical Security</strong>: If someone gains physical possession of your device\n(for example, by stealing your laptop or removing a hard drive), LUKS ensures\nthe data remains inaccessible and appears as random, meaningless bytes without\nthe correct credentials.</p>\n</li>\n<li>\n<p><strong>Protection Against Offline Attacks</strong>: LUKS defends against attackers who\nattempt to bypass the operating system by booting from another device or\nremoving the drive and mounting it elsewhere. Without the decryption key, the\ndata remains protected.</p>\n</li>\n</ul>\n<p><strong>What LUKS Does Not Protect</strong>:</p>\n<ul>\n<li>\n<p><strong>Data in Use</strong>: Once the system is booted and the encrypted device is\nunlocked, the data becomes accessible to the operating system and any user or\nprocess with the necessary permissions. LUKS does not protect against attacks\non a running system, such as malware, remote exploits, or unauthorized users\nwith access to an unlocked session.</p>\n</li>\n<li>\n<p><strong>File-Level Access Control</strong>: LUKS encrypts entire partitions or disks, not\nindividual files or directories. It does not provide granular file-level\nencryption or access control within the operating system.</p>\n</li>\n<li>\n<p><strong>Network Attacks</strong>: LUKS only protects data stored on disk. It does not\nencrypt data transmitted over networks or protect against network-based\nattacks.</p>\n</li>\n<li>\n<p><strong>Bootloader and EFI Partitions</strong>: The initial bootloader or EFI system\npartition cannot be encrypted with LUKS, so some parts of the boot process may\nremain exposed unless additional measures are taken. (i.e., Secure Boot,\nadditional passwords, TPM2)</p>\n</li>\n</ul>\n<p>To Sum it Up: LUKS encryption protects the confidentiality of all data stored on\nan encrypted block device by making it unreadable without the correct passphrase\nor key. This ensures that, if your device is lost or stolen, your data remains\nsecure and inaccessible to unauthorized users. However, LUKS does not protect\ndata once the system is unlocked and running, nor does it provide file-level\nencryption or protect against malware and network attacks. For comprehensive\nsecurity, LUKS should be combined with strong access controls and other security\nbest practices.</p>\n<h2>The Install</h2>\n<ol>\n<li>\n<p>Get the\n<a href=\"https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso\">Nixos Minimal ISO</a>\nGet it on a usb stick, I use Ventoy with Ventoy2Disk.sh. The following is the\nlink to the\n<a href=\"https://sourceforge.net/projects/ventoy/files/v1.1.05/ventoy-1.1.05-linux.tar.gz/download\">Ventoy TarBall</a>\ndownload, untar it with <code>tar -xzf ventoy-1.1.05-linux.tar.gz</code>, and make it\nexecutable with <code>chmod +x Ventoy2Disk.sh</code>, and finally execute it with\n<code>sudo bash Ventoy2Disk.sh</code> Follow the prompts to finish the install.</p>\n</li>\n<li>\n<p>Configuring Networking</p>\n</li>\n</ol>\n<p>The minimal installer uses <code>wpa_supplicant</code> instead of NetworkManager. Choose\none of the following methods to enable networking:</p>\n<pre><code class=\"language-bash\">sudo systemctl start wpa_supplicant\nwpa_cli\n</code></pre>\n<h3>Option A: Interactive <code>wpa_cli</code></h3>\n<pre><code class=\"language-bash\">&gt; add_network\n0\n\n&gt; set_network 0 ssid \"myhomenetwork\"\nOK\n\n&gt; set_network 0 psk \"mypassword\"\nOK\n\n&gt; enable_network 0\nOK\n</code></pre>\n<p>To exit type <code>quit</code>, then check your connection with <code>ping google.com</code>.</p>\n<h3>Option B: Non-Interactive <code>wpa_passphrase</code></h3>\n<p>This method is quicker for known networks and persists the configuration for the\nlive environment.</p>\n<p>First, identify your wireless interface name (e.g., <code>wlan0</code>) using <code>ip a</code>.</p>\n<pre><code class=\"language-bash\">sudo systemctl start wpa_supplicant # Ensure wpa_supplicant is running\n# This command generates the config and appends it to a file specific to wlan0\nsudo wpa_passphrase \"myhomenetwork\" \"mypassword\" | sudo tee /etc/wpa_supplicant/wpa_supplicant-wlan0.conf\nsudo systemctl restart wpa_supplicant@wlan0.service\n</code></pre>\n<p>After either method, exit <code>wpa_cli</code> with <code>quit</code>. Then test your connection:</p>\n<pre><code class=\"language-bash\">ping 1.1.1.1\n</code></pre>\n<ol start=\"3\">\n<li>Get your Disk Name with <code>lsblk</code></li>\n</ol>\n<p>The output should be something like:</p>\n<pre><code class=\"language-bash\">NAME ¬† ¬† ¬† ¬†MAJ:MIN RM ¬† SIZE RO TYPE MOUNTPOINTS\nnvme0n1 ¬† ¬† 259:0 ¬† ¬†0 ¬† 1,8T ¬†0 disk\n</code></pre>\n<blockquote>\n<p>‚ùó From here, you can either</p>\n</blockquote>\n<ol start=\"4\">\n<li>Copy the disk configuration to your machine. You can choose one from the\n<a href=\"https://github.com/nix-community/disko/tree/master/example\">examples directory</a>.</li>\n</ol>\n<p>There is still a starter repo that can save you some typing, make sure to\ncarefully review if you decide to use it:</p>\n<pre><code class=\"language-bash\">export NIX_CONFIG='experimental-features = nix-command flakes'\nexport EDITOR='hx' # or 'vi'\nnix-shell -p git yazi helix mkpasswd\ngit config --global user.name \"gitUsername\"\ngit config --global user.email \"gitEmail\"\n# OPTIONAL starter repo containing disk-config set up for impermanence\ngit clone https://github.com/saylesss88/my-flake.git\n</code></pre>\n<p>I prefer <code>helix</code> here as it‚Äôs defaults are great. (i.e., auto closing brackets\nand much more)</p>\n<p>If you choose to use the starter repo you won‚Äôt need to run the next command as\nit is already populated in the repo and should use the\n<a href=\"https://github.com/saylesss88/my-flake\">Starter Repo README</a> most of the rest\nof the guide is for manual disko without the starter repo.</p>\n<p>If you click on the layout you want then click the <code>Raw</code> button near the top,\nthen copy the <code>url</code> and use it in the following command:</p>\n<pre><code class=\"language-bash\">cd /tmp\ncurl https://raw.githubusercontent.com/nix-community/disko/refs/heads/master/example/luks-btrfs-subvolumes.nix -o /tmp/disk-config.nix\n</code></pre>\n<p>The above curl command is to the <code>luks-btrfs-subvolumes.nix</code> layout.</p>\n<ol start=\"5\">\n<li>Make Necessary changes, I prepared mine for impermanence with the following:</li>\n</ol>\n<pre><code class=\"language-bash\">hx /tmp/disk-config.nix\n</code></pre>\n<p>Make sure you identify your system disk name with <code>lsblk</code> and change the\n<code>device</code> attribute below to match your disk.</p>\n<pre><code class=\"language-bash\">lsblk\nnvme0n1       259:0    0 476.9G  0 disk\n‚îú‚îÄnvme0n1p1   259:1    0   512M  0 part  /boot\n‚îî‚îÄnvme0n1p2   259:2    0 476.4G  0 part\n</code></pre>\n<p>My disk is <code>nvme0n1</code>, change below to match yours:</p>\n<pre><code class=\"language-nix\">{\n  disko.devices = {\n    disk = {\n      nvme0n1 = {\n        type = \"disk\";\n        # Make sure this is correct with `lsblk`\n        device = \"/dev/nvme0n1\";\n        content = {\n          type = \"gpt\";\n          partitions = {\n            ESP = {\n              label = \"boot\";\n              name = \"ESP\";\n              size = \"1G\";\n              type = \"EF00\";\n              content = {\n                type = \"filesystem\";\n                format = \"vfat\";\n                mountpoint = \"/boot\";\n                mountOptions = [\n                  \"defaults\"\n                ];\n              };\n            };\n            luks = {\n              size = \"100%\";\n              label = \"luks\";\n              content = {\n                type = \"luks\";\n                name = \"cryptroot\";\n                content = {\n                  type = \"btrfs\";\n                  extraArgs = [\"-L\" \"nixos\" \"-f\"];\n                  subvolumes = {\n                    \"/root\" = {\n                      mountpoint = \"/\";\n                      mountOptions = [\"subvol=root\" \"compress=zstd\" \"noatime\"];\n                    };\n                    \"/root-blank\" = {\n                      mountOptions = [\"subvol=root-blank\" \"nodatacow\" \"noatime\"];\n                    };\n                    \"/home\" = {\n                      mountpoint = \"/home\";\n                      mountOptions = [\"subvol=home\" \"compress=zstd\" \"noatime\"];\n                    };\n                    \"/nix\" = {\n                      mountpoint = \"/nix\";\n                      mountOptions = [\"subvol=nix\" \"compress=zstd\" \"noatime\"];\n                    };\n                    \"/persist\" = {\n                      mountpoint = \"/persist\";\n                      mountOptions = [\"subvol=persist\" \"compress=zstd\" \"noatime\"];\n                    };\n                    \"/log\" = {\n                      mountpoint = \"/var/log\";\n                      mountOptions = [\"subvol=log\" \"compress=zstd\" \"noatime\"];\n                    };\n                    \"/lib\" = {\n                      mountpoint = \"/var/lib\";\n                      mountOptions = [\"subvol=lib\" \"compress=zstd\" \"noatime\"];\n                    };\n                    \"/persist/swap\" = {\n                      mountpoint = \"/persist/swap\";\n                      mountOptions = [\"subvol=swap\" \"noatime\" \"nodatacow\" \"compress=no\"];\n                      swap.swapfile.size = \"18G\";\n                    };\n                  };\n                };\n              };\n            };\n          };\n        };\n      };\n    };\n  };\n\n  fileSystems.\"/persist\".neededForBoot = true;\n  fileSystems.\"/var/log\".neededForBoot = true;\n  fileSystems.\"/var/lib\".neededForBoot = true;\n}\n</code></pre>\n<p>I have 16G of RAM so to be safe for hibernation I chose to give it some extra\nspace. The boot partition is 1G, this extra space is for specialisations and\nlanzaboote.</p>\n<p>or for a swapfile:</p>\n<pre><code class=\"language-nix\">swapDevices = [\n  {\n    device = \"/persist/swap/swapfile\";\n    size = 18 * 1024; # Size in MB (18GB)\n    # or\n    # size = 16384; # Size in MB (16G);\n  }\n];\n</code></pre>\n<h2>Setting up zram and /tmp on RAM</h2>\n<p>While <code>/tmp</code> is handled by <code>tmpfs</code> (as shown the below <code>configuration.nix</code>), you\ncan further enhance memory efficiency with <code>zram</code> for compressed swap, as shown\nbelow.</p>\n<blockquote>\n<pre><code class=\"language-nix\">{\n  lib,\n  config,\n  ...\n}: let\n  cfg = config.custom.zram;\nin {\n  options.custom.zram = {\n    enable = lib.mkEnableOption \"Enable utils module\";\n  };\n\n  config = lib.mkIf cfg.enable {\n    zramSwap = {\n      enable = true;\n      # one of \"lzo\", \"lz4\", \"zstd\"\n      algorithm = \"zstd\";\n       priority = 5;\n       memoryPercent = 50;\n    };\n  };\n}\n</code></pre>\n<p>And in your <code>configuration.nix</code> you would add:</p>\n<pre><code class=\"language-nix\"># configuration.nix\ncustom = {\n    zram.enable = true;\n};\n</code></pre>\n</blockquote>\n<p>After adding the above module and rebuilding, you can see it with:</p>\n<pre><code class=\"language-bash\">swapon --show\nNAME       TYPE      SIZE USED PRIO\n/dev/zram0 partition 7.5G   0B    5\n</code></pre>\n<ol start=\"6\">\n<li>Run disko to partition, format and mount your disks. <strong>Warning</strong> this will\nwipe <strong>EVERYTHING</strong> on your disk. Disko doesn‚Äôt work with dual boot.</li>\n</ol>\n<pre><code class=\"language-bash\">sudo nix --experimental-features \"nix-command flakes\" run github:nix-community/disko/latest -- --mode destroy,format,mount /tmp/disk-config.nix\n</code></pre>\n<p>Check it with the following:</p>\n<pre><code class=\"language-bash\">mount | grep /mnt\n</code></pre>\n<p>The output for an <code>nvme0n1</code> disk would be similar to the following:</p>\n<pre><code class=\"language-bash\">#... snip ...\n/dev/nvme0n1p2 on /mnt type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=285,subvol=/root)\n/dev/nvme0n1p2 on /mnt/persist type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=261,subvol=/persist)\n/dev/nvme0n1p2 on /mnt/etc type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=261,subvol=/persist)\n/dev/nvme0n1p2 on /mnt/nix type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=260,subvol=/nix)\n/dev/nvme0n1p2 on /mnt/var/lib type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=258,subvol=/lib)\n/dev/nvme0n1p2 on /mnt/var/log type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=259,subvol=/log)\n/dev/nvme0n1p2 on /mnt/nix/store type btrfs (ro,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=260,subvol=/nix)\n# ... snip ...\n</code></pre>\n<ol start=\"7\">\n<li>Generate necessary files, here we use <code>--no-filesystems</code> because disko\nhandles the <code>fileSystems</code> attribute for us.</li>\n</ol>\n<pre><code class=\"language-bash\">nixos-generate-config --no-filesystems --root /mnt\n</code></pre>\n<ul>\n<li>The above command will place a <code>configuration.nix</code> and\n<code>hardware-configuration.nix</code> in <code>/mnt/etc/nixos/</code></li>\n</ul>\n<p>It may be helpful to add a couple things to your <code>configuration.nix</code> now, while\nit‚Äôs in its default location. You can just add what you want and rebuild once\nwith <code>sudo nixos-rebuild switch</code> and move on. (i.e. <code>git</code>, an editor, etc.).</p>\n<h3>Setting a Flake for your minimal Install</h3>\n<ol start=\"8\">\n<li>Create the flake in your home directory to avoid needing to use sudo for\nevery command:</li>\n</ol>\n<pre><code class=\"language-bash\">cd   # Move to home directory\nmkdir flake\ncd /mnt/etc/nixos/\nsudo mv hardware-configuration.nix configuration.nix ~/flake/\nsudo mv /tmp/disk-config.nix ~/flake/\n</code></pre>\n<pre><code class=\"language-bash\">cd flake\nhx flake.nix\n</code></pre>\n<blockquote>\n<p>You‚Äôll change <code>hostName = nixpkgs.lib.nixosSystem</code> to your chosen hostname,\n(e.g. <code>magic = nixpkgs.lib.nixosSystem</code>). This will be the same as your\n<code>networking.hostName = \"magic\";</code> in your <code>configuration.nix</code> that we will set\nup shortly.</p>\n</blockquote>\n<pre><code class=\"language-nix\"># flake.nix\n{\n  description = \"NixOS configuration\";\n\n  inputs = {\n    nixpkgs.url = \"github:nixos/nixpkgs/nixos-unstable\";\n    disko.url = \"github:nix-community/disko/latest\";\n    disko.inputs.nixpkgs.follows = \"nixpkgs\";\n    # impermanence.url = \"github:nix-community/impermanence\";\n  };\n\n  outputs = inputs@{ nixpkgs, ... }: {\n    nixosConfigurations = {\n      # Change `hostName` to your chosen host name\n      nixos = nixpkgs.lib.nixosSystem {\n        system = \"x86_64-linux\";\n        modules = [\n          ./configuration.nix\n          inputs.disko.nixosModules.disko\n          # inputs.impermanence.nixosModules.impermanence\n        ];\n      };\n    };\n  };\n}\n</code></pre>\n<ol start=\"9\">\n<li>Edit <code>configuration.nix</code> with what is required, the following are required, I\nclone my original flake repo and move the pieces into place but it‚Äôs fairly\neasy to just type it all out:</li>\n</ol>\n<ul>\n<li>\n<p>Bootloader, (e.g., <code>boot.loader.systemd-boot.enable = true;</code>)</p>\n</li>\n<li>\n<p>User, the example uses <code>username</code> change this to your chosen username. If you\ndon‚Äôt set your hostname it will be <code>nixos</code>.</p>\n</li>\n<li>\n<p>Networking, <code>networking.networkmanager.enable = true;</code></p>\n</li>\n<li>\n<p><code>hardware-configuration.nix</code> &amp; <code>disk-config.nix</code> for this setup</p>\n</li>\n<li>\n<p>If you type this out by hand and mess up a single character, you will have to\nstart over completely. A fairly safe way to do this is with <code>vim</code> or <code>hx</code> and\nredirect the hashed pass to a <code>/tmp/pass.txt</code>, you can then read it into your\n<code>users.nix</code>:</p>\n</li>\n</ul>\n<pre><code class=\"language-bash\">mkpasswd --method=yescrypt &gt; /tmp/pass.txt\n# Enter your chosen password\n</code></pre>\n<p>And then when inside <code>configuration.nix</code>, move to the line where you want the\nhashed password and type <code>:r /tmp/pass.txt</code> to read the hash into your current\nfile.</p>\n<pre><code class=\"language-nix\"># configuration.nix\n{\n  config,\n  lib,\n  pkgs,\n  inputs,\n  ...\n}: {\n  imports = [\n    # Include the results of the hardware scan.\n    ./hardware-configuration.nix\n    ./disk-config.nix\n  ];\n\n  # systemd Stage 1: if enabled, it handles unlocking of LUKS-encrypted volumes during boot.\n    boot.initrd.luks.devices = {\n    cryptroot = {\n      device = \"/dev/disk/by-partlabel/luks\";\n      allowDiscards = true;\n    };\n  };\n\n  # This complements using zram, putting /tmp on RAM\n    boot = {\n    tmp = {\n      useTmpfs = true;\n      tmpfsSize = \"50%\";\n    };\n  };\n\n  # Enable autoScrub for btrfs\n    services.btrfs.autoScrub = {\n    enable = true;\n    interval = \"weekly\";\n    fileSystems = [\"/\"];\n  };\n\n\n  # Change me!\n  networking.hostName = \"nixos\"; # This will match the `hostname` of your flake\n\n  networking.networkmanager.enable = true;\n\n  boot.loader.systemd-boot.enable = true; # (for UEFI systems only)\n  # List packages installed in system profile.\n  # You can use https://search.nixos.org/ to find more packages (and options).\n  environment.systemPackages = with pkgs; [\n    vim # Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.\n    #   wget\n    git\n  ];\n\n  time.timeZone = \"America/New_York\";\n\n# Change me to your chosen username (i.e. change nixosUser to your username)\n  users.users.nixosUser = {\n    isNormalUser = true;\n    extraGroups = [ \"wheel\" \"networkmanager\" ]; # Add \"wheel\" for sudo access\n    initialHashedPassword = \"READ_MKPASSWD_OUTPUT_HERE\"; # &lt;-- This is where it goes!\n    # home = \"/home/nixos\"; # Optional: Disko typically handles home subvolumes\n  };\n  # Change me to match your chosen username\n  users.group.nixosUser = {};\n\n  console.keyMap = \"us\";\n\n  nixpkgs.config.allowUnfree = true;\n\n  system.stateVersion = \"25.05\";\n}\n</code></pre>\n<p>Although, just adding the <code>disk-config.nix</code> works for prompting you for your\nencryption passphrase adding the following is a more robust way of ensuring Nix\nis aware of this:</p>\n<pre><code class=\"language-nix\">    boot.initrd.luks.devices = {\n    cryptroot = {\n      device = \"/dev/disk/by-partlabel/luks\";\n      allowDiscards = true;\n    };\n  };\n</code></pre>\n<ol start=\"10\">\n<li>Move the flake to <code>/mnt/etc/nixos</code> and run <code>nixos-install</code>:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo mv ~/flake /mnt/etc/nixos/\n</code></pre>\n<ul>\n<li>Give everything a quick once over, insuring your host is set in both your\n<code>flake.nix</code>, and <code>configuration.nix</code>. Ensure you changed the username in the\n<code>configuration.nix</code> from <code>nixos</code> to your chosen name, this is the name you‚Äôll\nuse to login after you enter your encryption passphrase.</li>\n</ul>\n<p>The below command uses <code>#nixos</code> because that‚Äôs what the defaults are, you‚Äôll\nchange it to your chosen hostname.</p>\n<pre><code class=\"language-bash\">sudo nixos-install --flake /mnt/etc/nixos/flake#nixos\n</code></pre>\n<ul>\n<li>You will be prompted to enter a new password if everything succeeds.</li>\n</ul>\n<h2>Create a Blank Snapshot of /root</h2>\n<p>This is essential if you plan on using impermanence with this encrypted setup.\nWe take a snapshot of <code>/root</code> while it‚Äôs a clean slate, right after we run disko\nto format the disk.</p>\n<p>To access all of the subvolumes, we have to mount the Btrfs partitions\ntop-level.</p>\n<ol>\n<li>Unlock the LUKS device, if not already unlocked as it should be from running\ndisko:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo cryptsetup open /dev/disk/by-partlabel/luks cryptroot\n</code></pre>\n<ol start=\"2\">\n<li>Mount the Btrfs top-level (<code>subvolid=5</code>):</li>\n</ol>\n<pre><code class=\"language-bash\">sudo mount -o subvolid=5 /dev/mapper/cryptroot /mnt\n</code></pre>\n<ol start=\"3\">\n<li>List the contents:</li>\n</ol>\n<pre><code class=\"language-bash\">ls /mnt\n# you should see something like\nroot   home  nix  persist  log  lib  ...\n</code></pre>\n<ol start=\"4\">\n<li>Now we can take a snapshot of the <code>root</code> subvolume:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo btrfs subvolume snapshot -r /mnt/root /mnt/root-blank\n</code></pre>\n<ol start=\"5\">\n<li>Verify Your Blank Snapshot:</li>\n</ol>\n<p>Before continuing, make sure your blank snapshot exists. This is crucial for\nimpermanence to work properly.</p>\n<pre><code class=\"language-bash\">sudo btrfs subvolume list /mnt\n</code></pre>\n<p>You should see output containing both <code>root</code> and <code>root-blank</code> subvolumes:</p>\n<pre><code class=\"language-bash\">ID 256 gen ... path root\nID 257 gen ... path root-blank\n</code></pre>\n<p>Check that the snapshot is read only, this ensures that our snapshot will remain\nthe same as the day we took it. It was set <code>ro</code> in disko but lets check anyways:</p>\n<pre><code class=\"language-bash\">sudo btrfs property get -ts /mnt/root-blank\n# output should be\nro=true\n</code></pre>\n<ol start=\"5\">\n<li>Make sure to unmount:</li>\n</ol>\n<pre><code class=\"language-bash\">sudo umount /mnt\n</code></pre>\n<ul>\n<li>\n<p>If everything checks out, reboot the system and you should be prompted to\nenter your <code>user</code> and <code>password</code> to login to a shell to get started.</p>\n</li>\n<li>\n<p>The flake will be placed at <code>/etc/nixos/flake</code> after the install and reboot, I\nchoose to move it to my home directory. Since the file was first in <code>/etc</code>\nyou‚Äôll need to adjust the permissions with something like\n<code>sudo chown -R $USER:$USER ~/flake</code> and then you can work on it without\nprivilege escalation. This requires that you create a group for your user as\ndone in the <code>configuration.nix</code> above.</p>\n</li>\n<li>\n<p>You can check the layout of your btrfs system with:</p>\n</li>\n</ul>\n<pre><code class=\"language-bash\">sudo btrfs subvolume list /\n</code></pre>\n<h2>Persisting Critical System State</h2>\n<p>The following is a one time operation, we‚Äôre just getting it out of the way now.\nThis moves all of the important system state to a persistant location, further\npreparing for impermanence.</p>\n<p>It‚Äôs essential that you have first run the <code>nixos-install</code> command to populate\nthese directories before copying them over.</p>\n<pre><code class=\"language-bash\">sudo mkdir -p /mnt/persist/etc\nsudo mkdir -p /mnt/persist/var/lib\nsudo mkdir -p /mnt/persist/var/log\nsudo mkdir -p /mnt/persist/home\nsudo mkdir -p /mnt/persist/root\nsudo cp -a /mnt/etc/. /mnt/persist/etc/\nsudo cp -a /mnt/var/lib/. /mnt/persist/var/lib\nsudo cp -a /mnt/var/log/. /mnt/persist/var/log\nsudo cp -a /mnt/home/. /mnt/persist/home/\nsudo cp -a /mnt/root/. /mnt/persist/root/\n</code></pre>\n<p>Since we are in a live environment, after the install and reboot the <code>/mnt</code>\nprefix will be removed.</p>\n<h2>Reboot</h2>\n<p>Now that everything is done, we can safely reboot and ensure that our LUKS\npassword/passphrase is accepted as well as our userlevel password and username.</p>\n<p>After reboot, you can continue to setup\n<a href=\"https://saylesss88.github.io/installation/enc/sops-nix.html\">Sops Encrypted Secrets</a>\nand\n<a href=\"https://saylesss88.github.io/installation/enc/lanzaboote.html\">Lanzaboote Secure Boot</a></p>\n<ul>\n<li>\n<p>To set up impermanence for this specific layout, follow the link\n<a href=\"https://saylesss88.github.io/installation/enc/encrypted_impermanence.html\">Encrypted Impermanence</a></p>\n</li>\n<li>\n<p><a href=\"https://btrfs.readthedocs.io/en/latest/Subvolumes.html\">BTRFS Subvolumes</a></p>\n</li>\n<li>\n<p><a href=\"https://www.freedesktop.org/software/systemd/man/latest/systemd-cryptenroll.html\">systemd-cryptenroll man page</a></p>\n</li>\n<li>\n<p><a href=\"https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/\">Linux TPM PCR Registry</a></p>\n</li>\n<li>\n<p><a href=\"https://oddlama.org/blog/bypassing-disk-encryption-with-tpm2-unlock/\">Bypassing FDE with TPM2</a></p>\n</li>\n</ul>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/installation/enc/sops-nix.html",
      "url": "https://saylesss88.github.io/installation/enc/sops-nix.html",
      "title": "Sops-Nix",
      "content_html": "<h1>Sops-Nix encrypted secrets</h1>\n<details>\n<summary> Click to Expand Table of Contents</summary>\n<!-- toc -->\n</details>\n<p><a href=\"https://github.com/getsops/sops?ref=blog.gitguardian.com\">SOPS</a>, short for\n<strong>S</strong>ecrets<strong>OP</strong>eration<strong>S</strong>, is an editor of encrypted files that supports\nquite a few BINARY formats and encrypts with AWS KMS, GCP KMS, Azure Key Vault,\nage, and PGP.</p>\n<p>Managing secrets‚Äîlike API keys, SSH deploy keys, and password hashes is a\ncritical part of system configuration, but it‚Äôs also one of the trickiest to do\nsecurely and reproducibly. Traditionally, secrets might be stored in ad hoc\nlocations, referenced by absolute paths, or managed manually outside of version\ncontrol. This approach makes it hard to share, rebuild, or audit your\nconfiguration, and increases the risk of accidental leaks or inconsistencies\nbetween systems.</p>\n<p><code>sops-nix</code> solves these problems by integrating Mozilla SOPS directly into your\nNixOS configuration. Instead of relying on hardcoded file paths or copying\nsecrets around, you declare your secrets in your Nix code, encrypt them with\nstrong keys, and let <code>sops-nix</code> handle decryption and placement at activation\ntime.</p>\n<p>Encryption with strong keys, as used by sops-nix, makes brute force attacks\ncomputationally unfeasible with current technology‚Äîthe time and resources\nrequired to try every possible key would be astronomically high. However, this\nprotection relies on using strong, secret keys and good security practices;\nadvances in technology or poor key management can weaken this defense.</p>\n<blockquote>\n<p>‚ùó <strong>CRITICAL SECURITY NOTE:</strong> While the encryption itself is robust, this\nprotection fundamentally relies on using <strong>strong, secret keys</strong> and\n<strong>diligent security practices</strong>. If your PGP passphrase is weak, your Age\nprivate key is easily guessable, or the cleartext secret itself is very short\nand has low entropy (e.g., ‚Äú12345‚Äù, ‚Äútrue‚Äù, ‚Äúadmin‚Äù), an attacker might be\nable to compromise your secrets regardless of the encryption.</p>\n</blockquote>\n<ol>\n<li>Add sops to your <code>flake.nix</code>:</li>\n</ol>\n<pre><code class=\"language-nix\">{\n  inputs.sops-nix.url = \"github:Mic92/sops-nix\";\n  inputs.sops-nix.inputs.nixpkgs.follows = \"nixpkgs\";\n\n  outputs = { self, nixpkgs, sops-nix }: {\n    # change `yourhostname` to your actual hostname\n    nixosConfigurations.yourhostname = nixpkgs.lib.nixosSystem {\n      # customize to your system\n      system = \"x86_64-linux\";\n      modules = [\n        ./configuration.nix\n        sops-nix.nixosModules.sops\n      ];\n    };\n  };\n}\n</code></pre>\n<ol start=\"2\">\n<li>Add <code>sops</code> and <code>age</code> to your <code>environment.systemPackages</code>:</li>\n</ol>\n<pre><code class=\"language-nix\">environment.systemPackages = [\n    pkgs.sops\n    pkgs.age\n];\n</code></pre>\n<ol start=\"3\">\n<li>Generate a key (This is your <strong>private key</strong> and <strong>MUST NEVER BE COMMITTED TO\nGIT OR SHARED</strong>):</li>\n</ol>\n<pre><code class=\"language-bash\">mkdir -p ~/.config/sops/age\nage-keygen -o ~/.config/sops/age/keys.txt\n</code></pre>\n<p>To get the Public Keys Value, run the following command:</p>\n<pre><code class=\"language-bash\">age-keygen -y ~/.config/sops/age/keys.txt\nage12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl\n</code></pre>\n<p>Copy the <code>age</code> value it gives you back.</p>\n<ol start=\"4\">\n<li>Create a <code>.sops.yaml</code> in the same directory as your <code>flake.nix</code>:</li>\n</ol>\n<pre><code class=\"language-yaml\"># .sops.yaml\nkeys:\n  # Your personal age public key (from age-keygen -y ~/.config/sops/age/keys.txt)\n  - &amp;personal_age_key age12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl\n\n  # You can also use PGP keys if you prefer, but age is often simpler\n  # - &amp;personal_pgp_key 0xDEADBEEFCAFE0123\n\ncreation_rules:\n  # This rule applies to any file named 'secrets.yaml' directly in the 'secrets/' directory\n  # or 'secrets/github-deploy-key.yaml' etc.\n  - path_regex: \"secrets/.*\\\\.yaml$\"\n    key_groups:\n      - age:\n          - *personal_age_key\n        # Add host keys for decryption on the target system\n        # sops-nix will automatically pick up the system's SSH host keys\n        # as decryption keys if enabled in your NixOS config.\n        # So you typically don't list them explicitly here unless you\n        # want to restrict it to specific fingerprints, which is rare.\n        # This part ensures your *personal* key can decrypt it.\n</code></pre>\n<p>Save it and move on, this file and <code>sops.nix</code> are safe to version control.</p>\n<ol start=\"5\">\n<li>sops-nix‚Äôs automatic decryption feature using system SSH host keys only works\nwith ed25519 host keys for deriving Age decryption keys. Therefore, for\nsystem decryption, ensure your using ed25519 not rsa keys:</li>\n</ol>\n<pre><code class=\"language-bash\">ssh-keygen -t ed25519 -C \"your_email@example.com\"\n# for multiple keys run something like\nssh-keygen -t ed25519 -f ~/nix-book-deploy-key -C \"deploy-key-nix-book-repo\"\n</code></pre>\n<ol start=\"6\">\n<li>Copy the <strong>PRIVATE</strong> key for each and add them to your secrets directory:</li>\n</ol>\n<p>While in your flake directory:</p>\n<pre><code class=\"language-bash\">mkdir secrets\nsops secrets/github-deploy-key.yaml  # For your github ssh key\n</code></pre>\n<p>When you call a <code>sops</code> command, it will handle the encryption/decryption\ntransparently and open the cleartext file in an editor.</p>\n<p>Editing will happen in the editor that <code>$SOPS_EDITOR</code> or <code>$EDITOR</code> is set to,\nsops will wait for the editor to exit, and then try to reencrypt the file.</p>\n<p>The above command will open a default sops <code>github-deploy-key.yaml</code> in your\n<code>$EDITOR</code>:</p>\n<p>Erase the default <code>sops</code> filler and type <code>github_deploy_key_ed25519: |</code>, move\nyour cursor 1 line down and type <code>:r ~/.ssh/id_ed25519</code> to read the private key\ninto the file and repeat as needed.</p>\n<pre><code class=\"language-yaml\">github_deploy_key_ed25519: |\n  -----BEGIN OPENSSH PRIVATE KEY-----\n  ...\n  -----END OPENSSH PRIVATE KEY-----\n\ngithub_deploy_key_ed25519_nix-book: |\n  -----BEGIN OPENSSH PRIVATE KEY-----\n  ...\n  -----END OPENSSH PRIVATE KEY-----\n</code></pre>\n<p>The <code>-----BEGIN</code> and the rest of the private key <strong>must</strong> be indented 2 spaces</p>\n<p>Ensure sops can decrypt it:</p>\n<pre><code class=\"language-bash\">sops -d secrets/github-deploy-key.yaml\n</code></pre>\n<blockquote>\n<p>‚ùó WARNING: Only ever enter your private keys through the <code>sops</code> command. If\nyou forget and paste them in without the <code>sops</code> command then run <code>git add</code> at\nany point, your git history will have contained an unencrypted secret which is\na nono. Always use the <code>sops</code> command when dealing with files in the <code>secrets</code>\ndirectory, save the file and inspect that it is encrypted on save. If not\nsomething went wrong with the <code>sops</code> process, <strong>do not add it to Git</strong>. If you\ndo, you will be required to rewrite your entire history which can be bad if\nyou‚Äôre collaborating with others. <code>git-filter-repo</code> is one such solution that\nrewrites your history. Just keep this in mind. This happens because Git has a\nprotection that stops you from doing stupid things.</p>\n</blockquote>\n<p>Generate an encrypted password hash with:</p>\n<pre><code class=\"language-bash\">mkpasswd --method=yescrypt &gt; /tmp/password-hash.txt\n# Enter your chosen password and copy the encrypted hash it gives you back\n</code></pre>\n<pre><code class=\"language-bash\">sops secrets/password-hash.yaml      # For your `hashedPasswordFile`\n</code></pre>\n<p>The above command will open your <code>$EDITOR</code> with the file <code>password-hash.yaml</code>,\nadd the following content to it. Replace <code>PasteEncryptedHashHere</code> with the\noutput of the <code>mkpasswd</code> command above:</p>\n<p>Delete the default <code>sops</code> filler, type <code>password_hash:</code> and leave your cursor\nafter the <code>:</code> and type <code>:r /tmp/password-hash.txt</code></p>\n<pre><code class=\"language-yaml\">password_hash: PasteEncryptedHashHere\n</code></pre>\n<p>Ensure sops can decrypt it:</p>\n<pre><code class=\"language-bash\">sops -d secrets/password-hash.yaml\n</code></pre>\n<ol start=\"7\">\n<li>Create a <code>sops.nix</code> and import it or add this directly to your\n<code>configuration.nix</code>:</li>\n</ol>\n<p>My <code>sops.nix</code> is located at <code>~/flake/hosts/hostname/sops.nix</code> and the secrets\ndirectory is located at <code>~/flake/secrets</code> so the path from <code>sops.nix</code> to\n<code>secrets/pasword-hash.yaml</code> would be <code>../../secrets/password-hash.yaml</code></p>\n<p>Another step you can take is to copy your key to a persistent location,\npreparing for impermanence:</p>\n<pre><code class=\"language-bash\">sudo mkdir /persist/sops/age\nsudo cp ~/.config/sops/age/keys.txt /persist/sops/age/keys.txt\n</code></pre>\n<p>Then you would change the <code>age.keyFile = \"/persist/sops/age/keys.txt\"</code> to match\nthis location below.</p>\n<pre><code class=\"language-nix\"># ~/flake/hosts/magic/sops.nix  # magic is my hostname\n# hosts/magic/ is also where my configuration.nix is\n{...}: {\n  sops = {\n    defaultSopsFile = ../../.sops.yaml; # Or the correct path to your .sops.yaml\n    # Don't mix sshKeyPaths and keyFile\n    age.sshKeyPaths = [];\n    age.keyFile = \"/persist/sops/age/keys.txt\";\n\n    secrets = {\n      \"password_hash\" = {\n        sopsFile = ../../secrets/password-hash.yaml; # &lt;-- Points to your password hash file\n        owner = \"root\";\n        group = \"root\";\n        mode = \"0400\";\n        neededForUsers = true;\n      };\n      \"github_deploy_key_ed25519_nix-book\" = {\n        sopsFile = ../../secrets/github-deploy-key.yaml;\n        key = \"github_deploy_key_ed25519_nix-book\";\n        owner = \"root\";\n        group = \"root\";\n        mode = \"0400\";\n      };\n      \"github_deploy_key_ed25519\" = {\n        sopsFile = ../../secrets/github-deploy-key.yaml;\n        key = \"github_deploy_key_ed25519\";\n        owner = \"root\";\n        group = \"root\";\n        mode = \"0400\";\n      };\n    };\n  };\n}\n</code></pre>\n<p>Import <code>sops.nix</code> into your <code>configuration.nix</code> or equivalent:</p>\n<pre><code class=\"language-nix\"># configuration.nix\nimports = [\n  ./sops.nix # Assuming sops.nix is in the same directory as configuration.nix, adjust path as needed\n  # ... other imports\n];\n</code></pre>\n<blockquote>\n<p>‚ùó NOTE: You may see in the sops quickstart guide that if you‚Äôre using\nimpermanence, the key used for secret decryption (<code>sops.age.keyFile</code>) must be\nin a persistent directory, loaded early enough during the boot process. If you\nare using the btrfs subvolume layout you don‚Äôt need to worry about this\nbecause your home will be on its own partition when only the root partition is\nwiped on reboot. Adding <code>neededForUsers = true;</code> tells <code>sops-nix</code> to decrypt\nand make that secret available earlier in the boot process specifically,\nbefore user and group accounts are created.</p>\n</blockquote>\n<p>You typically use <code>age.sshKeyPaths</code> for <strong>system-level secrets</strong> with a\npersistent SSH host key</p>\n<p>For <strong>user-level secrets</strong>, use <code>age.keyFile</code> pointing to your Age private key,\nstored in a safe persistent location.</p>\n<p>For reproducibility, keep your key files in a persistent, predictable path and\ndocument which keys are used for which secrets in your <code>.sops.yaml</code>.</p>\n<p>If you don‚Äôt need both <code>age.keyFile</code> and <code>age.sshKeyPaths</code> it can reduce\ncomplexity to use one or the other. Although most people may choose one, it‚Äôs\nnot bad to use both it just adds complexity.</p>\n<p>And finally use the password-hash for your <code>hashedPasswordFile</code> for your user,\nmy user is <code>jr</code> so I added this:</p>\n<pre><code class=\"language-nix\"># ... snip ...\n    users.users = {\n      # ${username} = {\n      jr = {\n        homeMode = \"755\";\n        isNormalUser = true;\n        # description = userVars.gitUsername;\n        hashedPasswordFile = config.sops.secrets.password_hash.path;\n  # ...snip...\n</code></pre>\n<p>By integrating SOPS with NixOS through <code>sops-nix</code>, you gain a modern, secure,\nand reproducible way to manage sensitive secrets. Unlike traditional approaches\nwhere secrets are often scattered in ad hoc locations, referenced by absolute\npaths, or managed outside version control, <code>sops-nix</code> keeps your secrets\nencrypted, declarative, and version-control friendly.</p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    },
    {
      "id": "https://saylesss88.github.io/functions/practical_functions_2.1.html",
      "url": "https://saylesss88.github.io/functions/practical_functions_2.1.html",
      "title": "Practical Nix Functions",
      "content_html": "<h1>Practical Nix Functions</h1>\n<details>\n<summary>\n‚úîÔ∏è\nIf you want to follow along with this example you'll have to place the following\nin your project directory. Section is collapsed to focus on functions:\n</summary>\n<p><img src=\"images/coding6.png\" alt=\"coding6\" /></p>\n<ol>\n<li>\n<p><a href=\"https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/2.49.3/graphviz-2.49.3.tar.gz\">graphviz</a></p>\n</li>\n<li>\n<p><a href=\"https://ftp.gnu.org/gnu/hello/hello-2.12.1.tar.gz\">hello</a></p>\n</li>\n<li>\n<p><code>autotools.nix</code>:</p>\n</li>\n</ol>\n<pre><code class=\"language-nix\"># autotools.nix\npkgs: attrs:\nwith pkgs; let\n  defaultAttrs = {\n    builder = \"${bash}/bin/bash\";\n    args = [./builder.sh];\n    setup = ./setup.sh;\n    baseInputs = [gnutar gzip gnumake gcc binutils-unwrapped coreutils gawk gnused gnugrep patchelf findutils];\n    buildInputs = [];\n    system = builtins.currentSystem;\n  };\nin\n  derivation (defaultAttrs // attrs)\n</code></pre>\n<ol start=\"4\">\n<li><code>setup.sh</code>:</li>\n</ol>\n<pre><code class=\"language-bash\"># setup.sh (This is a library of functions setting up the environment, not directly executable)\nunset PATH\nfor p in $baseInputs $buildInputs; do\n  if [ -d $p/bin ]; then\n    export PATH=\"$p/bin${PATH:+:}$PATH\"\n  fi\n  if [ -d $p/lib/pkgconfig ]; then\n    export PKG_CONFIG_PATH=\"$p/lib/pkgconfig${PKG_CONFIG_PATH:+:}$PKG_CONFIG_PATH\"\n  fi\ndone\n\nfunction unpackPhase() {\n  tar -xzf $src\n\n  for d in *; do\n    if [ -d \"$d\" ]; then\n      cd \"$d\"\n      break\n    fi\n  done\n}\n\nfunction configurePhase() {\n  ./configure --prefix=$out\n}\n\nfunction buildPhase() {\n  make\n}\n\nfunction installPhase() {\n  make install\n}\n\nfunction fixupPhase() {\n  find $out -type f -exec patchelf --shrink-rpath '{}' \\; -exec strip '{}' \\; 2&gt;/dev/null\n}\n\nfunction genericBuild() {\n  unpackPhase\n  configurePhase\n  buildPhase\n  installPhase\n  fixupPhase\n}\n</code></pre>\n<ol start=\"5\">\n<li>And finally <code>builder.sh</code>:</li>\n</ol>\n<pre><code class=\"language-bash\"># builder.sh (This is the actual builder script specified in the derivation and\n# what `nix-build` expects)\nset -e\nsource $setup\ngenericBuild\n</code></pre>\n</details>\n<p>This is another example from the Nix-Pill series shown in another way to show\nsome powerful aspects of functions.</p>\n<p>If you have a <code>default.nix</code> like this:</p>\n<pre><code class=\"language-nix\"># default.nix\n{\n  hello = import ./hello.nix;\n  graphviz = import ./graphviz.nix;\n}\n</code></pre>\n<p>It expects the files that it imports to look like this:</p>\n<pre><code class=\"language-nix\"># graphviz.nix\nlet\n  pkgs = import &lt;nixpkgs&gt; { };\n  mkDerivation = import ./autotools.nix pkgs;\nin\nmkDerivation {\n  name = \"graphviz\";\n  src = ./graphviz-2.49.3.tar.gz;\n}\n</code></pre>\n<p>And <code>hello.nix</code>:</p>\n<pre><code class=\"language-nix\"># hello.nix\nlet\n  pkgs = import &lt;nixpkgs&gt; { };\n  mkDerivation = import ./autotools.nix pkgs;\nin\nmkDerivation {\n  name = \"hello\";\n  src = ./hello-2.12.1.tar.gz;\n}\n</code></pre>\n<p>You would build these with:</p>\n<pre><code class=\"language-bash\">nix-build -A hello\nnix-build -A graphviz\n</code></pre>\n<p>As you can see both derivations are dependendent on <code>nixpkgs</code> which they\n<strong>both</strong> import directly. To centralize our dependencies and avoid redundant\nimports, we‚Äôll refactor our individual package definitions (<code>hello.nix</code>,\n<code>graphviz.nix</code>) into functions. Our <code>default.nix</code> will then be responsible for\nsetting up the common inputs (like <code>pkgs</code> and <code>mkDerivation</code>) and passing them\nas arguments when it imports and calls these package functions.</p>\n<p>Here is what our <code>default.nix</code> will look like:</p>\n<pre><code class=\"language-nix\">let\n  pkgs = import &lt;nixpkgs&gt; { };\n  mkDerivation = import ./autotools.nix pkgs;\nin\nwith pkgs;\n{\n  hello = import ./hello.nix { inherit mkDerivation; };\n  graphviz = import ./graphviz.nix {\n    inherit\n      mkDerivation\n      lib\n      gd\n      pkg-config\n      ;\n  };\n  graphvizCore = import ./graphviz.nix {\n    inherit\n      mkDerivation\n      lib\n      gd\n      pkg-config\n      ;\n    gdSupport = false;\n  };\n}\n</code></pre>\n<p>We define some local variables in the <code>let</code> expression and pass them around.</p>\n<p>The whole expression in the above <code>default.nix</code> returns an attribute set with\nthe keys <code>hello</code>, <code>graphviz</code>, and <code>graphvizCore</code></p>\n<p>We import <code>hello.nix</code> and <code>graphviz.nix</code>, which both return a function. We call\nthe functions, passing them a set of inputs with the <code>inherit</code> construct.</p>\n<p>Let‚Äôs change <code>hello.nix</code> into a function to match what the <code>default.nix</code> now\nexpects.</p>\n<pre><code class=\"language-nix\"># hello.nix\n{mkDerivation}:\nmkDerivation {\n  name = \"hello\";\n  src = ./hello-2.12.1.tar.gz;\n}\n</code></pre>\n<p>Now our <code>graphviz</code> attribute expects <code>graphviz.nix</code> to be a function that takes\nthe arguments listed in the above <code>default.nix</code>, here‚Äôs what <code>graphviz.nix</code> will\nlook like as a function:</p>\n<pre><code class=\"language-nix\"># graphviz.nix\n{\n  mkDerivation,\n  lib,\n  gdSupport ? true,\n  gd,\n  pkg-config,\n}:\nmkDerivation {\n  name = \"graphviz\";\n  src = ./graphviz-2.49.3.tar.gz;\n  buildInputs =\n    if gdSupport\n    then [\n      pkg-config\n      (lib.getLib gd)\n      (lib.getDev gd)\n    ]\n    else [];\n}\n</code></pre>\n<p>We factorized the import of <code>nixpkgs</code> and <code>mkDerivation</code>, and also added a\nvariant of <code>graphviz</code> with gd support disabled. The result is that both\n<code>hello.nix</code> and <code>graphviz.nix</code> are independent of the repository and\ncustomizable by passing specific inputs.</p>\n<p>Now, we can build the package with <code>gd</code> support disabled with the <code>graphvizCore</code>\nattribute:</p>\n<pre><code class=\"language-bash\">nix-build -A graphvizCore\n# or we can still build the package that now defaults to gd support\nnix-build -A graphviz\n</code></pre>\n<p>This example showed us how to turn expressions into functions. We saw how\nfunctions are passed around and shared between Nix expressions and derivations.</p>\n",
      "date_published": "2025-11-22T00:00:00+00:00",
      "author": {
        "name": "saylesss88"
      }
    }
  ]
}