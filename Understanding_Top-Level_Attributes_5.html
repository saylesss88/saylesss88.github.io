<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Understanding Top-Level Attributes - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="chapter-5"><a class="header" href="#chapter-5">Chapter 5</a></h1>
<details>
<summary> ✔️ Click to Expand Table of Contents</summary>
<!-- toc -->
</details>
<img src="images/gruv9.png" width="800" height="600">
<h2 id="understanding-top-level-attributes-in-nixos-modules"><a class="header" href="#understanding-top-level-attributes-in-nixos-modules">Understanding Top-Level Attributes in NixOS Modules</a></h2>
<p>This explanation is based on insights from Infinisil, a prominent figure in the
Nix community, to help clarify the concept of top-level attributes within
NixOS modules.</p>
<h3 id="the-core-of-a-nixos-system-systembuildtoplevel"><a class="header" href="#the-core-of-a-nixos-system-systembuildtoplevel">The Core of a NixOS System: <code>system.build.toplevel</code></a></h3>
<details>
<summary> ✔️ `system.build.toplevel` Explained (Click to Expand) </summary>
<p>In a NixOS system, everything is built from a single "system derivation." The
command <code>nix-build '&lt;nixpkgs/nixos&gt;' -A system</code> initiates this build process.</p>
<p>The <code>-A system</code> part tells Nix to focus on the <code>system</code> attribute defined in
the <code>'&lt;nixpkgs/nixos&gt;'</code> file (which is essentially <code>./default.nix</code> within the
Nixpkgs repository).</p>
<p>This <code>system</code> attribute is specifically the NixOS option <code>system.build.toplevel</code>
. Think of <code>system.build.toplevel</code> as the <strong>very top of the configuration
hierarchy</strong> for your entire NixOS system. Almost every setting you configure
eventually influences this top-level derivation, often through a series of
intermediate steps.</p>
<p><strong>Key Takeaway:</strong> <code>system.build.toplevel</code> is the ultimate output that defines your entire NixOS system.</p>
</details>
<h3 id="how-options-relate-a-chain-of-influence"><a class="header" href="#how-options-relate-a-chain-of-influence">How Options Relate: A Chain of Influence</a></h3>
<p>Options in NixOS are not isolated; they often build upon each other.</p>
<details>
<summary>Example: Nginx Option Chain (Click to Expand)</summary>
<p>Here's an example of how a high-level option can lead down to a low-level system
configuration:</p>
<ul>
<li>You enable Nginx with <code>services.nginx.enable = true;</code>.</li>
<li>This setting influences the lower-level option <code>systemd.services.nginx</code>.</li>
<li>Which, in turn, affects the even lower-level option
<code>systemd.units."nginx.service"</code>.</li>
<li>Ultimately, this leads to the creation of a systemd unit file within
<code>environment.etc."systemd/system"</code>.</li>
<li>Finally, this unit file ends up as <code>result/etc/systemd/system/nginx.service</code>
within the final <code>system.build.toplevel</code> derivation.</li>
</ul>
</details>
<p><strong>Key Takeaway:</strong> Higher-level, user-friendly options are translated into
lower-level system configurations that are part of the final system build.</p>
<h3 id="the-nixos-module-system-evaluating-options"><a class="header" href="#the-nixos-module-system-evaluating-options">The NixOS Module System: Evaluating Options</a></h3>
<p>So, how do these options get processed and turned into the final system
configuration? That's the job of the <strong>NixOS module system</strong>, located in the
<code>./lib</code> directory of Nixpkgs (specifically in <code>modules.nix</code>, <code>options.nix</code>,
and <code>types.nix</code>).</p>
<p>Interestingly, the module system isn't exclusive to NixOS; you can use it to
manage option sets in your own Nix projects.</p>
<p>Here's a simplified example of using the module system outside of NixOS:</p>
<pre><code class="language-nix">let
  systemModule = { lib, config, ... }: {
    options.toplevel = lib.mkOption {
      type = lib.types.str;
    };

    options.enableFoo = lib.mkOption {
      type = lib.types.bool;
      default = false;
    };

    config.toplevel = ''
      Is foo enabled? ${lib.boolToString config.enableFoo}
    '';
  };

  userModule = {
    enableFoo = true;
  };

in (import &lt;nixpkgs/lib&gt;).evalModules {
  modules = [ systemModule userModule ];
}
</code></pre>
<p><strong>You can evaluate the <code>config.toplevel</code> option from this example using:</strong></p>
<pre><code class="language-bash">nix-instantiate --eval file.nix -A config.toplevel
</code></pre>
<p><strong>Key Takeaway</strong>: The NixOS module system is responsible for evaluating and
merging option configurations from different modules.</p>
<h3 id="how-the-module-system-works-a-simplified-overview"><a class="header" href="#how-the-module-system-works-a-simplified-overview">How the Module System Works: A Simplified Overview</a></h3>
<p>The module system processes a set of "modules" through these general steps:</p>
<details>
<summary> ✔️ Detailed Steps (Click to Expand)</summary>
<ol>
<li>
<p><strong>Importing Modules</strong>: It recursively finds and includes all modules
specified in <code>imports = [ ... ];</code> statements.</p>
</li>
<li>
<p><strong>Declaring Options</strong>: It collects all option declarations defined using
<code>options = { ... };</code> from all the modules and merges them. If the same option
is declared in multiple modules, the module system handles this
(details omitted for simplicity).</p>
</li>
<li>
<p><strong>Defining Option Values</strong>: For each declared option, it gathers all the
value assignments (defined using <code>config = { ... };</code> or directly at the top
level if no <code>options</code> or <code>config</code> are present) from all modules and merges
them according to the option's defined type.</p>
</li>
</ol>
<blockquote>
<p><strong>Important Note</strong>: Option evaluation is lazy, meaning an option's value is
only computed when it's actually needed. It can also depend on the values of
other options.</p>
</blockquote>
</details>
<p><strong>Key Takeaway</strong>: The module system imports, declares, and then evaluates
option values from various modules to build the final configuration.</p>
<p><strong>Top-Level Attributes in a Module: <code>imports</code>, <code>options</code>, and <code>config</code></strong></p>
<p>Within a NixOS module (the files that define parts of your system configuration)
, the attributes defined directly at the top level of the module's function
have specific meanings:</p>
<ul>
<li>
<p><code>imports</code>: This attribute is a list of other module files to include. Their
options and configurations will also be part of the evaluation.</p>
</li>
<li>
<p><code>options</code>: This attribute is where you declare new configuration options. You
define their type, default value, description, etc., using functions like
<code>lib.mkOption</code> or <code>lib.mkEnableOption</code>.</p>
</li>
<li>
<p><code>config</code>: This attribute is where you assign values to the options that have
been declared (either in the current module or in imported modules).</p>
</li>
</ul>
<p><strong>Key Takeaway</strong>: The top-level attributes <code>imports</code>, <code>options</code>, and <code>config</code>
are the primary ways to structure a NixOS module.</p>
<p><strong>The Rule: Move Non-Option Attributes Under <code>config</code></strong></p>
<p>If you define either an <code>options</code> or a <code>config</code> attribute at the top level of
your module, any other attributes that are not option declarations must be
moved inside the config attribute.</p>
<details>
<summary> ✔️ Examples of Correct and Incorrect Usage (Click to Expand)</summary>
<p>Let's look at an example of what not to do:</p>
<pre><code class="language-nix">{ pkgs, lib, config, ... }:
{
imports = [];

# Defining an option at the top level

options.mine.desktop.enable = lib.mkEnableOption "desktop settings";

# This will cause an error because 'environment' and 'appstream'

# are not 'options' and 'config' is also present at the top level.

environment.systemPackages =
lib.mkIf config.appstream.enable [ pkgs.git ];

appstream.enable = true;
}
</code></pre>
<p>This will result in the error: <code>error: Module has an unsupported attribute 'appstream' This is caused by introducing a top-level 'config' or 'options' attribute. Add configuration attributes immediately on the top level instead, or move all of them into the explicit 'config' attribute</code>.</p>
<p><strong>Key Takeaway</strong>: When you have <code>options</code> or <code>config</code> at the top level, all
value assignments need to go inside the config block.</p>
<p><strong>The Correct Way</strong>): Using the <code>config</code> Attribute</p>
<p>To fix the previous example, you need to move the value assignments for
<code>environment.systemPackages</code> and <code>appstream.enable</code> inside the config attribute:</p>
<pre><code class="language-nix">{ pkgs, lib, config, ... }:
{
imports = [];

# Defining an option at the top level

options.mine.desktop.enable = lib.mkEnableOption "desktop settings";

config = {
environment.systemPackages =
lib.mkIf config.appstream.enable [ pkgs.git ];

    appstream.enable = true;

};
}
</code></pre>
<p>Now, Nix knows that you are declaring an option (<code>options.mine.desktop.enable</code>)
and then setting values for other options (<code>environment.systemPackages</code>,
<code>appstream.enable</code>) within the <code>config</code> block.</p>
<p><strong>Key Takeaway</strong>: The <code>config</code> attribute is used to define the values of
options.</p>
<p><strong>Implicit <code>config</code>: When <code>options</code> is Absent</strong></p>
<p>If your module does not define either <code>options</code> or <code>config</code> at the top level,
then any attributes you define directly at the top level are implicitly
treated as being part of the config.</p>
<p>For example, this is valid:</p>
<pre><code class="language-nix">{ pkgs, lib, config, ... }:
{
environment.systemPackages =
lib.mkIf config.appstream.enable [ pkgs.git ];

appstream.enable = true;
}
</code></pre>
<p>Nix will implicitly understand that <code>environment.systemPackages</code> and
<code>appstream.enable</code> are configuration settings.</p>
<p><strong>Key Takeaway</strong>: If no explicit options or config are present, top-level
attributes are automatically considered part of the configuration.</p>
<p><strong>Removing an Option: What Happens to <code>config</code></strong></p>
<p>Even if you remove the <code>options</code> declaration from a module that has a <code>config</code>
section, the <code>config = { environment.systemPackages = ... };</code> part will still
function correctly, assuming the option it's referencing (<code>appstream.enable</code>
in this case) is defined elsewhere (e.g., in an imported module).</p>
</details>
<p><strong>Key Takeaway</strong>: The <code>config</code> section defines values for options, regardless
of whether those options are declared in the same module.</p>
<h4 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h4>
<p>Understanding the nuances of top-level attributes within NixOS modules, particularly
<code>imports</code>, <code>options</code>, and <code>config</code>, is fundamental to structuring and managing
your system's configuration effectively. As we've seen, the module system
provides a powerful and declarative way to define and evaluate system settings,
ultimately contributing to the construction of the <code>system.build.toplevel</code>
derivation that represents your entire NixOS environment.</p>
<p>The concepts of option declaration and value assignment, along with the crucial
rule of organizing non-option attributes under the <code>config</code> attribute when
<code>options</code> is present, provide a clear framework for building modular and
maintainable configurations.</p>
<p>Now that we have a solid grasp of how NixOS modules are structured and how they
contribute to the final system derivation, it's a natural next step to explore
the tangible results of these configurations: the software and system
components themselves. These are built and managed by a core concept in Nix,
known as <strong>derivations</strong>.</p>
<p>In the next chapter, <a href="https://saylesss88.github.io/Package_Definitions_Explained_6.html">Package Definitions Explained</a>
we will shift our focus from the abstract configuration to the concrete software
packages. We will learn how Nix uses <em>package definitions</em> to create
<em>derivations</em>, which are the actual build plans that produce the software
we use on our NixOS systems. This will bridge the gap between configuring your
system and understanding how the software within it is managed.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="flakes/overlays_4.5.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="Package_Definitions_Explained_6.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="flakes/overlays_4.5.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="Package_Definitions_Explained_6.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
