<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://saylesss88.github.io/favicon.ico><meta property="og:url" content="https://saylesss88.github.io/posts/working_with_nixpkgs_locally/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Working_with_nixpkgs_locally"><meta property="og:description" content="Working with Nixpkgs Locally: Benefits and Best Practices TOC
Working with Nixpkgs Locally: Benefits and Best Practices I. Why Work with Nixpkgs Locally? A. Faster Development Cycle B. Enhanced Version Control C. Flexible Debugging Capabilities D. Streamlined Contribution Workflow E. Up-to-Date Documentation Source F. Optimized Storage and Performance II. Flake vs. Non-Flake Syntax for Local Nixpkgs A. Flake Syntax (nix build .#<package>) B. Non-Flake Syntax (nix-build -f . <package> or nix build -f . <package>) III. Setting Up a Local Nixpkgs Repository Efficiently A. Initial Clone: Shallow Cloning B. Managing Branches with Worktrees IV. Debugging Missing Dependencies: A Practical Example B. Local Source Code Search with rg (ripgrep) V. Local Derivation Search with nix-locate VI. Key Benefits of Working with Nixpkgs Locally (Recap) VII. Best Practices and Tips from the Community Nixpkgs, the package repository for NixOS, is a powerful resource for building and customizing software. Working with a local copy enhances development, debugging, and contribution workflows. This post covers setting up a local Nixpkgs repository, searching for dependencies, and leveraging its advantages, incorporating tips from the Nix community. I. Why Work with Nixpkgs Locally? A local Nixpkgs repository offers significant advantages for Nix developers:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-14T19:23:32-04:00"><meta property="article:modified_time" content="2025-05-14T19:23:32-04:00"><title>NixOS Blog | Working_with_nixpkgs_locally</title>
<link rel=stylesheet href=/css/main.min.9d7861a670d885bddfdca28e2bec973020e2e1f1b049a5849a85a2e0fa249e4c.css integrity="sha256-nXhhpnDYhb3f3KKOK+yXMCDi4fGwSaWEmoWi4Poknkw=" crossorigin=anonymous><link rel=stylesheet href=/css/palette/default.min.cfcbb0f894da76afbc5a46072e5cbec733a983f27395920a3cfdf6977053c351.css integrity="sha256-z8uw+JTadq+8WkYHLly+xzOpg/JzlZIKPP32l3BTw1E=" crossorigin=anonymous><script src=/js/main.86bb3d8e6f46df0fc97c2731e6b99175a13b87a4086acf578ff9b6992fcf32c1.js integrity="sha256-hrs9jm9G3w/JfCcx5rmRdaE7h6QIas9Xj/m2mS/PMsE=" crossorigin=anonymous></script><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH crossorigin=anonymous></head><body class=dark><main><div class="container pt-5"><div class="row mt-5 pt-5"></div><div class=post><header class=mb-4><h1 class=text-uppercase>Working_with_nixpkgs_locally</h1><div aria-label=breadcrumb><ol class=breadcrumb><li class="breadcrumb-item small"><time datetime=2025-05-14T19:23:32-04:00>May 14, 2025</time></li><li class="breadcrumb-item small">6 minutes</li></ol></div></header><article><h1 id=working-with-nixpkgs-locally-benefits-and-best-practices>Working with Nixpkgs Locally: Benefits and Best Practices</h1><p><strong>TOC</strong></p><ul><li><a href=#working-with-nixpkgs-locally-benefits-and-best-practices>Working with Nixpkgs Locally: Benefits and Best Practices</a></li><li><a href=#i-why-work-with-nixpkgs-locally>I. Why Work with Nixpkgs Locally?</a><ul><li><a href=#a-faster-development-cycle>A. Faster Development Cycle</a></li><li><a href=#b-enhanced-version-control>B. Enhanced Version Control</a></li><li><a href=#c-flexible-debugging-capabilities>C. Flexible Debugging Capabilities</a></li><li><a href=#d-streamlined-contribution-workflow>D. Streamlined Contribution Workflow</a></li><li><a href=#e-up-to-date-documentation-source>E. Up-to-Date Documentation Source</a></li><li><a href=#f-optimized-storage-and-performance>F. Optimized Storage and Performance</a></li></ul></li><li><a href=#ii-flake-vs-non-flake-syntax-for-local-nixpkgs>II. Flake vs. Non-Flake Syntax for Local Nixpkgs</a><ul><li><a href=#a-flake-syntax-nix-build-package>A. Flake Syntax (<code>nix build .#&lt;package></code>)</a></li><li><a href=#b-non-flake-syntax-nix-build-f-package-or-nix-build-f-package>B. Non-Flake Syntax (<code>nix-build -f . &lt;package></code> or <code>nix build -f . &lt;package></code>)</a></li><li><a href=#iii-setting-up-a-local-nixpkgs-repository-efficiently>III. Setting Up a Local Nixpkgs Repository Efficiently</a></li><li><a href=#a-initial-clone-shallow-cloning>A. Initial Clone: Shallow Cloning</a></li><li><a href=#b-managing-branches-with-worktrees>B. Managing Branches with Worktrees</a></li></ul></li><li><a href=#iv-debugging-missing-dependencies-a-practical-example>IV. Debugging Missing Dependencies: A Practical Example</a><ul><li><a href=#b-local-source-code-search-with-rg-ripgrep>B. Local Source Code Search with <code>rg</code> (ripgrep)</a></li></ul></li><li><a href=#v-local-derivation-search-with-nix-locate>V. Local Derivation Search with <code>nix-locate</code></a></li><li><a href=#vi-key-benefits-of-working-with-nixpkgs-locally-recap>VI. Key Benefits of Working with Nixpkgs Locally (Recap)</a></li><li><a href=#vii-best-practices-and-tips-from-the-community>VII. Best Practices and Tips from the Community</a></li></ul><figure><img src=/images/gruv18.png alt=gruv18 width=700></figure><ul><li>Nixpkgs, the package repository for NixOS, is a powerful resource for building and customizing software.</li><li>Working with a local copy enhances development, debugging, and contribution workflows.</li><li>This post covers setting up a local Nixpkgs repository, searching for dependencies, and leveraging its advantages, incorporating tips from the Nix community.</li></ul><h1 id=i-why-work-with-nixpkgs-locally>I. Why Work with Nixpkgs Locally?</h1><ul><li><p>A local Nixpkgs repository offers significant advantages for Nix developers:</p><h2 id=a-faster-development-cycle>A. Faster Development Cycle</h2><ul><li>Local searches for packages and dependencies are significantly quicker than querying remote repositories or channels.</li><li>This speedup is crucial for efficient debugging and rapid prototyping of Nix expressions.</li></ul><h2 id=b-enhanced-version-control>B. Enhanced Version Control</h2><ul><li>By pinning your local repository to specific commits or branches (e.g., <code>nixos-unstable</code>), you ensure build reproducibility.</li><li>This prevents unexpected issues arising from upstream changes in Nixpkgs.</li></ul><h2 id=c-flexible-debugging-capabilities>C. Flexible Debugging Capabilities</h2><ul><li>You can directly test and modify package derivations within your local copy.</li><li>This allows for quick fixes to issues like missing dependencies without waiting for upstream updates or releases.</li></ul><h2 id=d-streamlined-contribution-workflow>D. Streamlined Contribution Workflow</h2><ul><li>Developing and testing new packages or patches locally is essential before submitting them as pull requests to Nixpkgs.</li><li>A local setup provides an isolated environment for experimentation.</li></ul><h2 id=e-up-to-date-documentation-source>E. Up-to-Date Documentation Source</h2><ul><li>The source code and comments within the Nixpkgs repository often contain the most current information about packages.</li><li>This can sometimes be more up-to-date than official, external documentation.</li></ul><h2 id=f-optimized-storage-and-performance>F. Optimized Storage and Performance</h2><ul><li>Employing efficient cloning strategies (e.g., shallow clones) and avoiding unnecessary practices (like directly using Nixpkgs as a flake for local development) minimizes disk usage and build times.</li></ul></li></ul><h1 id=ii-flake-vs-non-flake-syntax-for-local-nixpkgs>II. Flake vs. Non-Flake Syntax for Local Nixpkgs</h1><ul><li><p>When working with Nixpkgs locally, the choice between Flake and non-Flake syntax has implications for performance and storage:</p><h2 id=a-flake-syntax-nix-build-package>A. Flake Syntax (<code>nix build .#&lt;package></code>)</h2><ul><li>Treats the current directory as a flake, requiring evaluation of <code>flake.nix</code>.</li><li>For local Nixpkgs, this evaluates the flake definition in the repository root.</li><li><strong>Performance and Storage Overhead:</strong> Flakes copy the entire working directory (including Git history if present) to <code>/nix/store</code> for evaluation. This can be slow and storage-intensive for large repositories like Nixpkgs.</li></ul><h2 id=b-non-flake-syntax-nix-build--f--package-or-nix-build--f--package>B. Non-Flake Syntax (<code>nix-build -f . &lt;package></code> or <code>nix build -f . &lt;package></code>)</h2><ul><li><code>-f .</code> specifies the Nix expression (e.g., <code>default.nix</code> or a specific file) in the current directory.</li><li><strong>Efficiency:</strong> Evaluates the Nix expression directly <em>without</em> copying the entire worktree to <code>/nix/store</code>. This is significantly faster and more storage-efficient for local development on large repositories.</li></ul></li></ul><h2 id=iii-setting-up-a-local-nixpkgs-repository-efficiently>III. Setting Up a Local Nixpkgs Repository Efficiently</h2><ul><li><p>Cloning Nixpkgs requires careful consideration due to its size.</p><h2 id=a-initial-clone-shallow-cloning>A. Initial Clone: Shallow Cloning</h2><ul><li>To avoid downloading the entire history, perform a shallow clone:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone <span style=color:#f92672>[</span>https://github.com/NixOS/nixpkgs<span style=color:#f92672>](</span>https://github.com/NixOS/nixpkgs<span style=color:#f92672>)</span> --depth <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>cd nixpkgs
</span></span></code></pre></div></li></ul><h2 id=b-managing-branches-with-worktrees>B. Managing Branches with Worktrees</h2><ul><li>Use Git worktrees to manage different branches efficiently:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git fetch --all --prune --depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>git worktree add -b nixos-unstable nixos-unstable <span style=color:#75715e># For just unstable</span>
</span></span></code></pre></div></li><li><strong>Explanation of <code>git worktree</code>:</strong> Allows multiple working directories attached to the same <code>.git</code> directory, sharing history and objects but with separate checked-out files.</li><li><code>git worktree add</code>: Creates a new working directory for the specified branch (<code>nixos-unstable</code> in this case).</li></ul></li></ul><h1 id=iv-debugging-missing-dependencies-a-practical-example>IV. Debugging Missing Dependencies: A Practical Example</h1><ul><li><p>Let&rsquo;s say you&rsquo;re trying to build <code>icat</code> locally and encounter a missing dependency error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>nix-build <span style=color:#960050;background-color:#1e0010>-</span>A icat
</span></span><span style=display:flex><span><span style=color:#75715e># ... (Error log showing &#34;fatal error: X11/Xlib.h: No such file or directory&#34;)</span>
</span></span></code></pre></div><ul><li>The error <code>fatal error: X11/Xlib.h: No such file or directory</code> indicates a missing X11 dependency.</li></ul><h2 id=a-online-search-with-searchnixosorg>A. Online Search with <code>search.nixos.org</code></h2><ul><li>The Nixpkgs package search website (<a href=https://search.nixos.org/packages>https://search.nixos.org/packages</a>) is a valuable first step.</li><li>However, broad terms like &ldquo;x11&rdquo; can yield many irrelevant results.</li><li><strong>Tip:</strong> Utilize the left sidebar to filter by package sets (e.g., &ldquo;xorg&rdquo;).</li></ul><h2 id=b-local-source-code-search-with-rg-ripgrep>B. Local Source Code Search with <code>rg</code> (ripgrep)</h2><ul><li><p>Familiarity with searching the Nixpkgs source code is crucial for finding dependencies.</p></li><li><p>Navigate to your local <code>nixpkgs/</code> directory and use <code>rg</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rg <span style=color:#e6db74>&#34;x11 =&#34;</span> pkgs <span style=color:#75715e># Case-sensitive search</span>
</span></span></code></pre></div><p><strong>Output:</strong></p><pre tabindex=0><code>pkgs/tools/X11/primus/default.nix
21:  primus = if useNvidia then primusLib_ else primusLib_.override { nvidia_x11 = null; };
22:  primus_i686 = if useNvidia then primusLib_i686_ else primusLib_i686_.override { nvidia_x11 = null; };

pkgs/applications/graphics/imv/default.nix
38:    x11 = [ libGLU xorg.libxcb xorg.libX11 ];
</code></pre></li><li><p>Refining the search (case-insensitive):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rg -i <span style=color:#e6db74>&#34;libx11 =&#34;</span> pkgs
</span></span></code></pre></div><p><strong>Output:</strong></p><pre tabindex=0><code># ... (Output showing &#34;xorg.libX11&#34;)
</code></pre></li><li><p>The key result is <code>xorg.libX11</code>, which is likely the missing dependency.</p></li></ul></li></ul><h1 id=v-local-derivation-search-with-nix-locate>V. Local Derivation Search with <code>nix-locate</code></h1><ul><li><p><code>nix-locate</code> (from the <code>nix-index</code> package) allows searching for derivations on the command line.</p><blockquote><p><strong>Note:</strong> Install <code>nix-index</code> and run <code>nix-index</code> to create the initial index.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-locate libx11
</span></span><span style=display:flex><span><span style=color:#75715e># ... (Output showing paths related to libx11)</span>
</span></span></code></pre></div></li><li><p>Combining online and local search tools (<code>search.nixos.org</code>, <code>rg</code>, <code>nix-locate</code>) provides a comprehensive approach to finding dependencies.</p></li></ul><h1 id=vi-key-benefits-of-working-with-nixpkgs-locally-recap>VI. Key Benefits of Working with Nixpkgs Locally (Recap)</h1><ul><li><strong>Speed:</strong> Faster searches and builds compared to remote operations.</li><li><strong>Control:</strong> Full control over the Nixpkgs version.</li><li><strong>Up-to-Date Information:</strong> Repository source often has the latest details.</li></ul><h1 id=vii-best-practices-and-tips-from-the-community>VII. Best Practices and Tips from the Community</h1><ul><li><p><strong>Rebasing over Merging:</strong> Never merge upstream changes into your local branch. Always rebase your branch onto the upstream (e.g., <code>master</code> or <code>nixos-unstable</code>) to avoid accidental large-scale pings in pull requests (Tip from <code>soulsssx3</code> on Reddit).</p></li><li><p><strong>Tip from <code>ElvishJErrico</code>:</strong> Avoid using Nixpkgs directly as a flake for local development due to slow copying to <code>/nix/store</code> and performance issues with garbage collection on large numbers of small files. Use <code>nix build -f . &lt;package></code> instead of <code>nix build .#&lt;package></code>.</p></li><li><p><strong>Edge Cases for Flake Syntax:</strong> Flake syntax might be necessary in specific scenarios, such as NixOS installer tests where copying the Git history should be avoided.</p></li><li><p><strong>Base Changes on <code>nixos-unstable</code>:</strong> For better binary cache hits, base your changes on the <code>nixos-unstable</code> branch instead of <code>master</code>. Consider the merge-base for staging branches as well.</p></li><li><p><strong>Consider <code>jujutsu</code>:</strong> Explore <code>jujutsu</code>, a Git-compatible alternative that can offer a more intuitive workflow, especially for large monorepos like Nixpkgs. While it has a learning curve, it can significantly improve parallel work and branch management.</p></li></ul></article><div class=row><div class=col-md><a href=https://saylesss88.github.io/posts/building_your_config_as_a_package/><span>previous: </span><span>Building_your_config_as_a_package</span></a></div><div class="col-md text-md-end"><a href=https://saylesss88.github.io/posts/nix_flakes_tips/><span>next: </span><span>Nix_flakes_tips</span></a></div></div></div></div><footer><div class="container mt-4 pb-1"><p class="small opacity-75"></p></div></footer></main><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js integrity=sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz crossorigin=anonymous></script></body></html>