<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Working_with_nixpkgs_locally | NixOS Blog</title>
<link rel=icon href=favicon.svg sizes=any type=image/svg+xml><meta property="og:url" content="https://saylesss88.github.io/posts/working_with_nixpkgs_locally/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Working_with_nixpkgs_locally"><meta property="og:description" content="Working with Nixpkgs Locally: Benefits and Best Practices Nixpkgs, the package repository for NixOS, is a powerful resource for building and customizing software. Working with a local copy enhances development, debugging, and contribution workflows. This post covers setting up a local Nixpkgs repository, searching for dependencies, and leveraging its advantages, incorporating tips from the Nix community. I. Why Work with Nixpkgs Locally? A local Nixpkgs repository offers significant advantages for Nix developers:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-14T19:23:32-04:00"><meta property="article:modified_time" content="2025-05-14T19:23:32-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Working_with_nixpkgs_locally"><meta name=twitter:description content="Working with Nixpkgs Locally: Benefits and Best Practices Nixpkgs, the package repository for NixOS, is a powerful resource for building and customizing software. Working with a local copy enhances development, debugging, and contribution workflows. This post covers setting up a local Nixpkgs repository, searching for dependencies, and leveraging its advantages, incorporating tips from the Nix community. I. Why Work with Nixpkgs Locally? A local Nixpkgs repository offers significant advantages for Nix developers:"><link rel=stylesheet href=/css/root.min.0e732b812b9751962e01a7c4798a1211cd5f8ac8abec7f99793fe306989e459f.css integrity="sha256-DnMrgSuXUZYuAafEeYoSEc1fisir7H+ZeT/jBpieRZ8=" crossorigin=anonymous><link rel=stylesheet href=/css/bundle.min.e139b0e3b3aff8f0e8e0272554b671a06c857a42278b36c539d96c69ddee2ca2.css integrity="sha256-4Tmw47Ov+PDo4CclVLZxoGyFekInizbFOdlsad3uLKI=" crossorigin=anonymous><script src=/js/bundle.995e4ec99401021e081ec256bee66154ef7f4e5136809432513b2e6d014b4b1d.js integrity="sha256-mV5OyZQBAh4IHsJWvuZhVO9/TlE2gJQyUTsubQFLSx0=" crossorigin=anonymous></script><script defer src=/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js integrity="sha256-ZFlLEl97eL30+oMWlVkiu+uxzWuu8/FmVL/KIDCfGPg="></script><script defer src=/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js integrity="sha256-HZgPhN8R8+t8jF8X9UHUmgYRYI3xed10+n8GIl61as4="></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet></head><body class=notransition><div id=container><header id=main-header><div role=navigation aria-label=Main><div class=nav-left><a href=https://saylesss88.github.io/ style=color:inherit>NixOS Blog</a></div><div class=nav-right><div style=position:absolute;width:0;height:0><div id=nav-dropdown-menu class=hidden href=#><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div></div><a href=https://saylesss88.github.io//index.xml><img src=/images/rss.png alt="RSS Feed" width=24>
</a><a id=nav-dropdown-button href=#><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div id=nav-menu><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div><a id=theme-switcher href=#><svg class="light-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3V4m0 16v1M4 12H3M6.31412 6.31412 5.5 5.5m12.1859.81412L18.5 5.5M6.31412 17.69 5.5 18.5001M17.6859 17.69 18.5 18.5001M21 12H20m-4 0c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="dark-icon" viewBox="0 0 24 24" fill="none"><path d="M3.32031 11.6835c0 4.9706 4.02944 9 8.99999 9 3.7872.0 7.028-2.3392 8.3565-5.6515C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834c-4.9706.0-8.99999-4.0294-8.99999-8.99998C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996 5.65605 4.66028 3.32031 7.89912 3.32031 11.6835z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></div></div></header><div class="flex grow"><div id=main-pane><main id=main-content><div class=single-header><ol class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://saylesss88.github.io/><span itemprop=name>Home</span>
</a><meta itemprop=position content='1'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://saylesss88.github.io/posts/><span itemprop=name>Posts</span>
</a><meta itemprop=position content='2'></li><span>&nbsp»&nbsp</span></ol><h1>Working_with_nixpkgs_locally</h1><time class=dim datetime=2025-05-14T19:23:32-04:00>May 14, 2025</time></div><section class=page-section><h1 id=working-with-nixpkgs-locally-benefits-and-best-practices>Working with Nixpkgs Locally: Benefits and Best Practices</h1><figure><img src=/images/gruv18.png alt=gruv18 width=1000></figure><ul><li>Nixpkgs, the package repository for NixOS, is a powerful resource for building and customizing software.</li><li>Working with a local copy enhances development, debugging, and contribution workflows.</li><li>This post covers setting up a local Nixpkgs repository, searching for dependencies, and leveraging its advantages, incorporating tips from the Nix community.</li></ul><h1 id=i-why-work-with-nixpkgs-locally>I. Why Work with Nixpkgs Locally?</h1><ul><li><p>A local Nixpkgs repository offers significant advantages for Nix developers:</p><h2 id=a-faster-development-cycle>A. Faster Development Cycle</h2><ul><li>Local searches for packages and dependencies are significantly quicker than querying remote repositories or channels.</li><li>This speedup is crucial for efficient debugging and rapid prototyping of Nix expressions.</li></ul><h2 id=b-enhanced-version-control>B. Enhanced Version Control</h2><ul><li>By pinning your local repository to specific commits or branches (e.g., <code>nixos-unstable</code>), you ensure build reproducibility.</li><li>This prevents unexpected issues arising from upstream changes in Nixpkgs.</li></ul><h2 id=c-flexible-debugging-capabilities>C. Flexible Debugging Capabilities</h2><ul><li>You can directly test and modify package derivations within your local copy.</li><li>This allows for quick fixes to issues like missing dependencies without waiting for upstream updates or releases.</li></ul><h2 id=d-streamlined-contribution-workflow>D. Streamlined Contribution Workflow</h2><ul><li>Developing and testing new packages or patches locally is essential before submitting them as pull requests to Nixpkgs.</li><li>A local setup provides an isolated environment for experimentation.</li></ul><h2 id=e-up-to-date-documentation-source>E. Up-to-Date Documentation Source</h2><ul><li>The source code and comments within the Nixpkgs repository often contain the most current information about packages.</li><li>This can sometimes be more up-to-date than official, external documentation.</li></ul><h2 id=f-optimized-storage-and-performance>F. Optimized Storage and Performance</h2><ul><li>Employing efficient cloning strategies (e.g., shallow clones) and avoiding unnecessary practices (like directly using Nixpkgs as a flake for local development) minimizes disk usage and build times.</li></ul></li></ul><h1 id=ii-flake-vs-non-flake-syntax-for-local-nixpkgs>II. Flake vs. Non-Flake Syntax for Local Nixpkgs</h1><ul><li><p>When working with Nixpkgs locally, the choice between Flake and non-Flake syntax has implications for performance and storage:</p><h2 id=a-flake-syntax-nix-build-package>A. Flake Syntax (<code>nix build .#&lt;package></code>)</h2><ul><li>Treats the current directory as a flake, requiring evaluation of <code>flake.nix</code>.</li><li>For local Nixpkgs, this evaluates the flake definition in the repository root.</li><li><strong>Performance and Storage Overhead:</strong> Flakes copy the entire working directory (including Git history if present) to <code>/nix/store</code> for evaluation. This can be slow and storage-intensive for large repositories like Nixpkgs.</li></ul><h2 id=b-non-flake-syntax-nix-build--f--package-or-nix-build--f--package>B. Non-Flake Syntax (<code>nix-build -f . &lt;package></code> or <code>nix build -f . &lt;package></code>)</h2><ul><li><code>-f .</code> specifies the Nix expression (e.g., <code>default.nix</code> or a specific file) in the current directory.</li><li><strong>Efficiency:</strong> Evaluates the Nix expression directly <em>without</em> copying the entire worktree to <code>/nix/store</code>. This is significantly faster and more storage-efficient for local development on large repositories.</li></ul></li></ul><h2 id=iii-setting-up-a-local-nixpkgs-repository-efficiently>III. Setting Up a Local Nixpkgs Repository Efficiently</h2><ul><li><p>Cloning Nixpkgs requires careful consideration due to its size.</p><h2 id=a-initial-clone-shallow-cloning>A. Initial Clone: Shallow Cloning</h2><ul><li>To avoid downloading the entire history, perform a shallow clone:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone <span style=color:#f92672>[</span>https://github.com/NixOS/nixpkgs<span style=color:#f92672>](</span>https://github.com/NixOS/nixpkgs<span style=color:#f92672>)</span> --depth <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>cd nixpkgs
</span></span></code></pre></div></li></ul><h2 id=b-managing-branches-with-worktrees>B. Managing Branches with Worktrees</h2><ul><li>Use Git worktrees to manage different branches efficiently:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git fetch --all --prune --depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>git worktree add -b nixos-unstable nixos-unstable <span style=color:#75715e># For just unstable</span>
</span></span></code></pre></div></li><li><strong>Explanation of <code>git worktree</code>:</strong> Allows multiple working directories attached to the same <code>.git</code> directory, sharing history and objects but with separate checked-out files.</li><li><code>git worktree add</code>: Creates a new working directory for the specified branch (<code>nixos-unstable</code> in this case).</li></ul></li></ul><h1 id=iv-debugging-missing-dependencies-a-practical-example>IV. Debugging Missing Dependencies: A Practical Example</h1><ul><li><p>Let&rsquo;s say you&rsquo;re trying to build <code>icat</code> locally and encounter a missing dependency error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>nix-build <span style=color:#960050;background-color:#1e0010>-</span>A icat
</span></span><span style=display:flex><span><span style=color:#75715e># ... (Error log showing &#34;fatal error: X11/Xlib.h: No such file or directory&#34;)</span>
</span></span></code></pre></div><ul><li>The error <code>fatal error: X11/Xlib.h: No such file or directory</code> indicates a missing X11 dependency.</li></ul><h2 id=a-online-search-with-searchnixosorg>A. Online Search with <code>search.nixos.org</code></h2><ul><li>The Nixpkgs package search website (<a href=https://search.nixos.org/packages>https://search.nixos.org/packages</a>) is a valuable first step.</li><li>However, broad terms like &ldquo;x11&rdquo; can yield many irrelevant results.</li><li><strong>Tip:</strong> Utilize the left sidebar to filter by package sets (e.g., &ldquo;xorg&rdquo;).</li></ul><h2 id=b-local-source-code-search-with-rg-ripgrep>B. Local Source Code Search with <code>rg</code> (ripgrep)</h2><ul><li><p>Familiarity with searching the Nixpkgs source code is crucial for finding dependencies.</p></li><li><p>Navigate to your local <code>nixpkgs/</code> directory and use <code>rg</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rg <span style=color:#e6db74>&#34;x11 =&#34;</span> pkgs <span style=color:#75715e># Case-sensitive search</span>
</span></span></code></pre></div><p><strong>Output:</strong></p><pre tabindex=0><code>pkgs/tools/X11/primus/default.nix
21:  primus = if useNvidia then primusLib_ else primusLib_.override { nvidia_x11 = null; };
22:  primus_i686 = if useNvidia then primusLib_i686_ else primusLib_i686_.override { nvidia_x11 = null; };

pkgs/applications/graphics/imv/default.nix
38:    x11 = [ libGLU xorg.libxcb xorg.libX11 ];
</code></pre></li><li><p>Refining the search (case-insensitive):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rg -i <span style=color:#e6db74>&#34;libx11 =&#34;</span> pkgs
</span></span></code></pre></div><p><strong>Output:</strong></p><pre tabindex=0><code># ... (Output showing &#34;xorg.libX11&#34;)
</code></pre></li><li><p>The key result is <code>xorg.libX11</code>, which is likely the missing dependency.</p></li></ul></li></ul><h1 id=v-local-derivation-search-with-nix-locate>V. Local Derivation Search with <code>nix-locate</code></h1><ul><li><p><code>nix-locate</code> (from the <code>nix-index</code> package) allows searching for derivations on the command line.</p><blockquote><p><strong>Note:</strong> Install <code>nix-index</code> and run <code>nix-index</code> to create the initial index.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-locate libx11
</span></span><span style=display:flex><span><span style=color:#75715e># ... (Output showing paths related to libx11)</span>
</span></span></code></pre></div></li><li><p>Combining online and local search tools (<code>search.nixos.org</code>, <code>rg</code>, <code>nix-locate</code>) provides a comprehensive approach to finding dependencies.</p></li></ul><h1 id=vi-key-benefits-of-working-with-nixpkgs-locally-recap>VI. Key Benefits of Working with Nixpkgs Locally (Recap)</h1><ul><li><strong>Speed:</strong> Faster searches and builds compared to remote operations.</li><li><strong>Control:</strong> Full control over the Nixpkgs version.</li><li><strong>Up-to-Date Information:</strong> Repository source often has the latest details.</li></ul><h1 id=vii-best-practices-and-tips-from-the-community>VII. Best Practices and Tips from the Community</h1><ul><li><p><strong>Rebasing over Merging:</strong> Never merge upstream changes into your local branch. Always rebase your branch onto the upstream (e.g., <code>master</code> or <code>nixos-unstable</code>) to avoid accidental large-scale pings in pull requests (Tip from <code>soulsssx3</code> on Reddit).</p></li><li><p><strong>Tip from <code>ElvishJErrico</code>:</strong> Avoid using Nixpkgs directly as a flake for local development due to slow copying to <code>/nix/store</code> and performance issues with garbage collection on large numbers of small files. Use <code>nix build -f . &lt;package></code> instead of <code>nix build .#&lt;package></code>.</p></li><li><p><strong>Edge Cases for Flake Syntax:</strong> Flake syntax might be necessary in specific scenarios, such as NixOS installer tests where copying the Git history should be avoided.</p></li><li><p><strong>Base Changes on <code>nixos-unstable</code>:</strong> For better binary cache hits, base your changes on the <code>nixos-unstable</code> branch instead of <code>master</code>. Consider the merge-base for staging branches as well.</p></li><li><p><strong>Consider <code>jujutsu</code>:</strong> Explore <code>jujutsu</code>, a Git-compatible alternative that can offer a more intuitive workflow, especially for large monorepos like Nixpkgs. While it has a learning curve, it can significantly improve parallel work and branch management.</p></li></ul></section></main><footer id=main-footer><div class=footer><a href=#>Scroll to Top</a><div class=footer-copyright><div class=dim>© 2025</div><div>Made with ❤️ and powered by <a href=https://github.com/math-queiroz/rusty-typewriter target=_blank>Rusty Typewriter</a> theme for <a href=https://gohugo.io/ target=_blank>Hugo</a></div></div></div></footer></div><aside id=side-pane class=side-sticky><div class=side-details><span>961 words</span>
<span>6 - 8 minutes read</span></div><h3>Table Of Contents</h3><nav id=TableOfContents><ul><li><a href=#a-faster-development-cycle>A. Faster Development Cycle</a></li><li><a href=#b-enhanced-version-control>B. Enhanced Version Control</a></li><li><a href=#c-flexible-debugging-capabilities>C. Flexible Debugging Capabilities</a></li><li><a href=#d-streamlined-contribution-workflow>D. Streamlined Contribution Workflow</a></li><li><a href=#e-up-to-date-documentation-source>E. Up-to-Date Documentation Source</a></li><li><a href=#f-optimized-storage-and-performance>F. Optimized Storage and Performance</a></li></ul><ul><li><a href=#a-flake-syntax-nix-build-package>A. Flake Syntax (<code>nix build .#&lt;package></code>)</a></li><li><a href=#b-non-flake-syntax-nix-build--f--package-or-nix-build--f--package>B. Non-Flake Syntax (<code>nix-build -f . &lt;package></code> or <code>nix build -f . &lt;package></code>)</a></li><li><a href=#iii-setting-up-a-local-nixpkgs-repository-efficiently>III. Setting Up a Local Nixpkgs Repository Efficiently</a></li><li><a href=#a-initial-clone-shallow-cloning>A. Initial Clone: Shallow Cloning</a></li><li><a href=#b-managing-branches-with-worktrees>B. Managing Branches with Worktrees</a></li></ul><ul><li><a href=#a-online-search-with-searchnixosorg>A. Online Search with <code>search.nixos.org</code></a></li><li><a href=#b-local-source-code-search-with-rg-ripgrep>B. Local Source Code Search with <code>rg</code> (ripgrep)</a></li></ul></nav></aside></div></div></body></html>