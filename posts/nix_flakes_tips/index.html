<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Nix_flakes_tips | NixOS Blog</title>
<link rel=icon href=favicon.svg sizes=any type=image/svg+xml><meta property="og:url" content="https://saylesss88.github.io/posts/nix_flakes_tips/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Nix_flakes_tips"><meta property="og:description" content='Shallow Clone Nixpkgs TOC
Shallow Clone Nixpkgs Import your Non-Flake Wallpaper Repo Understanding @-patterns Understanding specialArgs Set up Flake Check and Formatter Outputs - Add a devShell Output Shallow clone nixpkgs, the full Git history isn’t always necessary and this can speed up build times. The only issue I’ve had is nix-index-database not working well with the shallow clone… Other than that no issues after running for a few months. # flake.nix inputs = { nixpkgs.url = "git+https://github.com/NixOS/nixpkgs?shallow=1&amp;ref=nixos-unstable"; }; Some times when you might need a full clone are debugging and working with repository history but those are rare. Import your Non-Flake Wallpaper Repo Importing your non-flake wallpapers repo: # flake.nix inputs = { wallpapers = { url = "github:saylesss88/wallpapers"; flake = false; }; } After adding the input I can access individual wallpapers by adding the inputs argument and something like path = "${inputs.wallpapers}/Aesthetic Scenery.jpg"; Understanding @-patterns Understanding @-patterns, being able to reference your outputs argument set as a whole. An @-pattern is a way for a function can access variadic attributes (i.e. varying number of arguments). # flake.nix inputs = { home-manager.url = "github:nix-community/home-manager/master"; home-manager.inputs.nixpkgs.follows = "nixpkgs"; stylix.url = "github:danth/stylix"; }; outputs = { self, nixpkgs, home-manager, } @ inputs: With the above example to add the modules to your nixosConfigurations you would add something like this:'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-14T19:24:27-04:00"><meta property="article:modified_time" content="2025-05-14T19:24:27-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nix_flakes_tips"><meta name=twitter:description content='Shallow Clone Nixpkgs TOC
Shallow Clone Nixpkgs Import your Non-Flake Wallpaper Repo Understanding @-patterns Understanding specialArgs Set up Flake Check and Formatter Outputs - Add a devShell Output Shallow clone nixpkgs, the full Git history isn’t always necessary and this can speed up build times. The only issue I’ve had is nix-index-database not working well with the shallow clone… Other than that no issues after running for a few months. # flake.nix inputs = { nixpkgs.url = "git+https://github.com/NixOS/nixpkgs?shallow=1&amp;ref=nixos-unstable"; }; Some times when you might need a full clone are debugging and working with repository history but those are rare. Import your Non-Flake Wallpaper Repo Importing your non-flake wallpapers repo: # flake.nix inputs = { wallpapers = { url = "github:saylesss88/wallpapers"; flake = false; }; } After adding the input I can access individual wallpapers by adding the inputs argument and something like path = "${inputs.wallpapers}/Aesthetic Scenery.jpg"; Understanding @-patterns Understanding @-patterns, being able to reference your outputs argument set as a whole. An @-pattern is a way for a function can access variadic attributes (i.e. varying number of arguments). # flake.nix inputs = { home-manager.url = "github:nix-community/home-manager/master"; home-manager.inputs.nixpkgs.follows = "nixpkgs"; stylix.url = "github:danth/stylix"; }; outputs = { self, nixpkgs, home-manager, } @ inputs: With the above example to add the modules to your nixosConfigurations you would add something like this:'><link rel=stylesheet href=/css/root.min.0e732b812b9751962e01a7c4798a1211cd5f8ac8abec7f99793fe306989e459f.css integrity="sha256-DnMrgSuXUZYuAafEeYoSEc1fisir7H+ZeT/jBpieRZ8=" crossorigin=anonymous><link rel=stylesheet href=/css/bundle.min.e139b0e3b3aff8f0e8e0272554b671a06c857a42278b36c539d96c69ddee2ca2.css integrity="sha256-4Tmw47Ov+PDo4CclVLZxoGyFekInizbFOdlsad3uLKI=" crossorigin=anonymous><script src=/js/bundle.995e4ec99401021e081ec256bee66154ef7f4e5136809432513b2e6d014b4b1d.js integrity="sha256-mV5OyZQBAh4IHsJWvuZhVO9/TlE2gJQyUTsubQFLSx0=" crossorigin=anonymous></script><script defer src=/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js integrity="sha256-ZFlLEl97eL30+oMWlVkiu+uxzWuu8/FmVL/KIDCfGPg="></script><script defer src=/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js integrity="sha256-HZgPhN8R8+t8jF8X9UHUmgYRYI3xed10+n8GIl61as4="></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel=stylesheet></head><body class=notransition><div id=container><header id=main-header><div role=navigation aria-label=Main><div class=nav-left><a href=https://saylesss88.github.io/ style=color:inherit>NixOS Blog</a></div><div class=nav-right><div style=position:absolute;width:0;height:0><div id=nav-dropdown-menu class=hidden href=#><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div></div><a id=nav-dropdown-button href=#><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a><div id=nav-menu><div class=nav-item><a aria-current=true class=ancestor href=/posts/>Posts</a></div></div><a id=theme-switcher href=#><svg class="light-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3V4m0 16v1M4 12H3M6.31412 6.31412 5.5 5.5m12.1859.81412L18.5 5.5M6.31412 17.69 5.5 18.5001M17.6859 17.69 18.5 18.5001M21 12H20m-4 0c0 2.2091-1.7909 4-4 4-2.20914.0-4-1.7909-4-4 0-2.20914 1.79086-4 4-4 2.2091.0 4 1.79086 4 4z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="dark-icon" viewBox="0 0 24 24" fill="none"><path d="M3.32031 11.6835c0 4.9706 4.02944 9 8.99999 9 3.7872.0 7.028-2.3392 8.3565-5.6515C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834c-4.9706.0-8.99999-4.0294-8.99999-8.99998C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996 5.65605 4.66028 3.32031 7.89912 3.32031 11.6835z" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></div></div></header><div class="flex grow"><div id=main-pane><main id=main-content><div class=single-header><ol class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://saylesss88.github.io/><span itemprop=name>Home</span>
</a><meta itemprop=position content='1'></li><span>&nbsp»&nbsp</span><li itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=https://saylesss88.github.io/posts/><span itemprop=name>Posts</span>
</a><meta itemprop=position content='2'></li><span>&nbsp»&nbsp</span></ol><h1>Nix_flakes_tips</h1><time class=dim datetime=2025-05-14T19:24:27-04:00>May 14, 2025</time></div><section class=page-section><h1 id=shallow-clone-nixpkgs>Shallow Clone Nixpkgs</h1><p><strong>TOC</strong></p><ul><li><a href=#shallow-clone-nixpkgs>Shallow Clone Nixpkgs</a><ul><li><a href=#import-your-non-flake-wallpaper-repo>Import your Non-Flake Wallpaper Repo</a></li><li><a href=#understanding-patterns>Understanding @-patterns</a></li><li><a href=#understanding-specialargs>Understanding <code>specialArgs</code></a></li><li><a href=#set-up-flake-check-and-formatter-outputs>Set up Flake Check and Formatter Outputs</a> - <a href=#add-a-devshell-output>Add a devShell Output</a></li></ul></li></ul><figure><img src=/images/gruv8.png alt=gruv8 width=700></figure><ol><li>Shallow clone nixpkgs, the full Git history isn&rsquo;t always necessary and this
can speed up build times.</li></ol><ul><li>The only issue I&rsquo;ve had is <code>nix-index-database</code> not working well with the
shallow clone&mldr; Other than that no issues after running for a few months.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;git+https://github.com/NixOS/nixpkgs?shallow=1&amp;ref=nixos-unstable&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><ul><li>Some times when you might need a full clone are debugging and working with
repository history but those are rare.</li></ul><h2 id=import-your-non-flake-wallpaper-repo>Import your Non-Flake Wallpaper Repo</h2><ol start=2><li>Importing your non-flake wallpapers repo:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    wallpapers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:saylesss88/wallpapers&#34;</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>After adding the input I can access individual wallpapers by adding the <code>inputs</code> argument and
something like <code>path = "${inputs.wallpapers}/Aesthetic Scenery.jpg";</code></li></ul><h2 id=understanding--patterns>Understanding @-patterns</h2><ol start=3><li>Understanding <code>@-patterns</code>, being able to reference your outputs argument set as a whole. An
<code>@-pattern</code> is a way for a function can access variadic attributes (i.e. varying number of
arguments).</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    home-manager<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:nix-community/home-manager/master&#34;</span>;
</span></span><span style=display:flex><span>    home-manager<span style=color:#f92672>.</span>inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#f92672>.</span>follows <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixpkgs&#34;</span>;
</span></span><span style=display:flex><span>    stylix<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:danth/stylix&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>outputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    self<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    home-manager<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>} <span style=color:#f92672>@</span> inputs:
</span></span></code></pre></div><p>With the above example to add the modules to your nixosConfigurations you would add something
like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>nixosConfigurations<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>  specialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inherit</span> inputs username host email systemSettings;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>./hosts</span><span style=color:#960050;background-color:#1e0010>/$</span>{host}<span style=color:#e6db74>/config.nix</span>
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>.</span>stylix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>stylix
</span></span><span style=display:flex><span>  home-manager<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>home-manager
</span></span><span style=display:flex><span>  <span style=color:#75715e># .. snip ..</span>
</span></span><span style=display:flex><span>];
</span></span></code></pre></div><ul><li>Notice that since home-manager was explicitly listed in the outputs arguments:
<code>outputs = { self, nixpkgs, home-manager, }; </code>the <code>inputs</code> prefix is unnecessary.
If home-manager was removed from the outputs arguments: <code>outputs = { self, ... }</code>
then you would need <code>modules = [ inputs.home-manager.nixosModules.home-manager];</code> This can be confusing
because many docs assume your not using an @-pattern so if you have one in your flake you need to prefix
with <code>inputs</code>. I use this to reference my personal wallpapers repo mentioned earlier.</li></ul><h2 id=understanding-specialargs>Understanding <code>specialArgs</code></h2><ol start=4><li>Understanding <code>specialArgs</code> (nixos) and <code>extraSpecialArgs</code> (home-manager). Building on the @-patterns, using
<code>specialArgs</code> and <code>extraSpecialArgs</code> is a way to pass arguments from your flake to your NixOS and home-manager
modules.</li></ol><p>For example, here is a snippet of some variables I set:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>outputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  self<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  nixpkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  home-manager<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>} <span style=color:#f92672>@</span> inputs: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>  host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;magic&#34;</span>;
</span></span><span style=display:flex><span>  username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jr&#34;</span>;
</span></span><span style=display:flex><span>  userVars <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    timezone <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;America/New_York&#34;</span>;
</span></span><span style=display:flex><span>    locale <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>;
</span></span><span style=display:flex><span>    gitUsername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TSawyer87&#34;</span>;
</span></span><span style=display:flex><span>    dotfilesDir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;~/.dotfiles&#34;</span>;
</span></span><span style=display:flex><span>    wm <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hyprland&#34;</span>;
</span></span><span style=display:flex><span>    browser <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;firefox&#34;</span>;
</span></span><span style=display:flex><span>    term <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ghostty&#34;</span>;
</span></span><span style=display:flex><span>    editor <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hx&#34;</span>;
</span></span><span style=display:flex><span>    keyboardLayout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>in</span>
</span></span></code></pre></div><p>Now I can pass them as special args like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>nixosConfigurations <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>        specialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>inherit</span>
</span></span><span style=display:flex><span>            inputs
</span></span><span style=display:flex><span>            username
</span></span><span style=display:flex><span>            system
</span></span><span style=display:flex><span>            host
</span></span><span style=display:flex><span>            userVars
</span></span><span style=display:flex><span>            ;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>./hosts</span><span style=color:#960050;background-color:#1e0010>/$</span>{host}<span style=color:#e6db74>/configuration.nix</span>
</span></span><span style=display:flex><span>        home-manager<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>home-manager
</span></span><span style=display:flex><span>        inputs<span style=color:#f92672>.</span>stylix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>stylix
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>useGlobalPkgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>useUserPackages <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>users<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>username<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./hosts</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>/home.nix</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>backupFileExtension <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;backup&#34;</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>extraSpecialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>inherit</span>
</span></span><span style=display:flex><span>              inputs
</span></span><span style=display:flex><span>              username
</span></span><span style=display:flex><span>              system
</span></span><span style=display:flex><span>              host
</span></span><span style=display:flex><span>              userVars
</span></span><span style=display:flex><span>              ;
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ];
</span></span></code></pre></div><ul><li>To access values in <code>userVars</code> for example:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># git.nix</span>
</span></span><span style=display:flex><span>{ userVars<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>  programs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    git <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      userName <span style=color:#f92672>=</span> userVars<span style=color:#f92672>.</span>gitUsername;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=set-up-flake-check-and-formatter-outputs>Set up Flake Check and Formatter Outputs</h2><ol start=5><li>Set up <code>checks</code> and <code>formatter</code> outputs with <code>treefmt-nix</code>. Add <code>treefmt-nix</code> to your inputs and outputs arguments.
Inside the <code>let</code> expression from tip 4 I would add:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ... snip ...</span>
</span></span><span style=display:flex><span>pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> nixpkgs {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>allowUnfree <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>treefmtEval <span style=color:#f92672>=</span> treefmt-nix<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>evalModule pkgs <span style=color:#e6db74>./treefmt.nix</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  checks<span style=color:#f92672>.</span>x86_64-linux<span style=color:#f92672>.</span>style <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>check self;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  formatter<span style=color:#f92672>.</span>x86_64-linux <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>wrapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ... snip ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And in the <code>treefmt.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># treefmt.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>projectRootFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;flake.nix&#34;</span>;
</span></span><span style=display:flex><span>programs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  deadnix<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  statix<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  keep-sorted<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  nixfmt <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    strict <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>settings<span style=color:#f92672>.</span>excludes <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.age&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.jpg&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.nu&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.png&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;.jj/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;flake.lock&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;justfile&#34;</span>
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>settings<span style=color:#f92672>.</span>formatter <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  deadnix <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  statix <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  nixfmt <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>Use <code>treefmt-nix</code> to manage code formatters and linters as flake outputs. This ensures consistent styling
and catches issues with tools like <code>deadnix</code>, <code>statix</code>, and <code>nixfmt</code>.</p></li><li><p>Use <code>nix fmt</code> in the flake directory to format your whole configuration.</p></li><li><p>Now you can run <code>nix flake check</code> to run your checks. Running <code>nix flake show</code> will list your outputs.</p></li><li><p>Tools like <code>nix-fast-build</code> rely on flake checks and can be used after setting this up.</p></li></ul><h3 id=add-a-devshell-output>Add a devShell Output</h3><ol start=6><li>Make a devShell output:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span> in
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      checks<span style=color:#f92672>.</span>x86_64-linux<span style=color:#f92672>.</span>style <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>check self;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      formatter<span style=color:#f92672>.</span>x86_64-linux <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>wrapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      devShells<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#f92672>.</span>default <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./lib/dev-shell.nix</span> { <span style=color:#66d9ef>inherit</span> inputs; };
</span></span></code></pre></div><p>and in the <code>dev-shell.nix</code> you could put something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># dev-shell.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  system <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>}:
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Instantiate nixpkgs with the given system and allow unfree packages</span>
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> inputs<span style=color:#f92672>.</span>nixpkgs {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>    config<span style=color:#f92672>.</span>allowUnfree <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    overlays <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add overlays if needed, e.g., inputs.neovim-nightly-overlay.overlays.default</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>pkgs<span style=color:#f92672>.</span>mkShell {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixos-dev&#34;</span>;
</span></span><span style=display:flex><span>  packages <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nix tools</span>
</span></span><span style=display:flex><span>    nixfmt-rfc-style <span style=color:#75715e># Formatter</span>
</span></span><span style=display:flex><span>    deadnix <span style=color:#75715e># Dead code detection</span>
</span></span><span style=display:flex><span>    nixd <span style=color:#75715e># Nix language server</span>
</span></span><span style=display:flex><span>    nil <span style=color:#75715e># Alternative Nix language server</span>
</span></span><span style=display:flex><span>    nh <span style=color:#75715e># Nix helper</span>
</span></span><span style=display:flex><span>    nix-diff <span style=color:#75715e># Compare Nix derivations</span>
</span></span><span style=display:flex><span>    nix-tree <span style=color:#75715e># Visualize Nix dependencies</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Code editing</span>
</span></span><span style=display:flex><span>    helix
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># General utilities</span>
</span></span><span style=display:flex><span>    git
</span></span><span style=display:flex><span>    ripgrep
</span></span><span style=display:flex><span>    jq
</span></span><span style=display:flex><span>    tree
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  shellHook <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;Welcome to the NixOS development shell!&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;System: </span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;Tools available: nixfmt, deadnix, nixd, nil, nh, nix-diff, nix-tree, helix, git, ripgrep, jq, tree&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>You can enter this devshell with <code>nix develop</code> or automatically with <code>direnv</code>.</li></ul></section></main><footer id=main-footer><div class=footer><a href=#>Scroll to Top</a><div class=footer-copyright><div class=dim>© 2025</div><div>Made with ❤️ and powered by <a href=https://github.com/math-queiroz/rusty-typewriter target=_blank>Rusty Typewriter</a> theme for <a href=https://gohugo.io/ target=_blank>Hugo</a></div></div></div></footer></div><aside id=side-pane class=side-sticky><div class=side-details><span>910 words</span>
<span>6 - 8 minutes read</span></div><h3>Table Of Contents</h3><nav id=TableOfContents><ul><li><a href=#import-your-non-flake-wallpaper-repo>Import your Non-Flake Wallpaper Repo</a></li><li><a href=#understanding--patterns>Understanding @-patterns</a></li><li><a href=#understanding-specialargs>Understanding <code>specialArgs</code></a></li><li><a href=#set-up-flake-check-and-formatter-outputs>Set up Flake Check and Formatter Outputs</a><ul><li><a href=#add-a-devshell-output>Add a devShell Output</a></li></ul></li></ul></nav></aside></div></div></body></html>