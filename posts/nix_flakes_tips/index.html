<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://saylesss88.github.io/favicon.ico><meta property="og:url" content="https://saylesss88.github.io/posts/nix_flakes_tips/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Nix_flakes_tips"><meta property="og:description" content='Shallow Clone Nixpkgs TOC
Shallow Clone Nixpkgs Import your Non-Flake Wallpaper Repo Understanding @-patterns Understanding specialArgs Set up Flake Check and Formatter Outputs - Add a devShell Output Shallow clone nixpkgs, the full Git history isn’t always necessary and this can speed up build times. The only issue I’ve had is nix-index-database not working well with the shallow clone… Other than that no issues after running for a few months. # flake.nix inputs = { nixpkgs.url = "git+https://github.com/NixOS/nixpkgs?shallow=1&amp;ref=nixos-unstable"; }; Some times when you might need a full clone are debugging and working with repository history but those are rare. Import your Non-Flake Wallpaper Repo Importing your non-flake wallpapers repo: # flake.nix inputs = { wallpapers = { url = "github:saylesss88/wallpapers"; flake = false; }; } After adding the input I can access individual wallpapers by adding the inputs argument and something like path = "${inputs.wallpapers}/Aesthetic Scenery.jpg"; Understanding @-patterns Understanding @-patterns, being able to reference your outputs argument set as a whole. An @-pattern is a way for a function can access variadic attributes (i.e. varying number of arguments). # flake.nix inputs = { home-manager.url = "github:nix-community/home-manager/master"; home-manager.inputs.nixpkgs.follows = "nixpkgs"; stylix.url = "github:danth/stylix"; }; outputs = { self, nixpkgs, home-manager, } @ inputs: With the above example to add the modules to your nixosConfigurations you would add something like this:'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-14T19:24:27-04:00"><meta property="article:modified_time" content="2025-05-14T19:24:27-04:00"><title>NixOS Blog | Nix_flakes_tips</title>
<link rel=stylesheet href=/css/main.min.9d7861a670d885bddfdca28e2bec973020e2e1f1b049a5849a85a2e0fa249e4c.css integrity="sha256-nXhhpnDYhb3f3KKOK+yXMCDi4fGwSaWEmoWi4Poknkw=" crossorigin=anonymous><link rel=stylesheet href=/css/palette/default.min.cfcbb0f894da76afbc5a46072e5cbec733a983f27395920a3cfdf6977053c351.css integrity="sha256-z8uw+JTadq+8WkYHLly+xzOpg/JzlZIKPP32l3BTw1E=" crossorigin=anonymous><script src=/js/main.86bb3d8e6f46df0fc97c2731e6b99175a13b87a4086acf578ff9b6992fcf32c1.js integrity="sha256-hrs9jm9G3w/JfCcx5rmRdaE7h6QIas9Xj/m2mS/PMsE=" crossorigin=anonymous></script><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH crossorigin=anonymous></head><body class=dark><main><div class="container pt-5"><div class="row mt-5 pt-5"></div><div class=post><header class=mb-4><h1 class=text-uppercase>Nix_flakes_tips</h1><div aria-label=breadcrumb><ol class=breadcrumb><li class="breadcrumb-item small"><time datetime=2025-05-14T19:24:27-04:00>May 14, 2025</time></li><li class="breadcrumb-item small">5 minutes</li></ol></div></header><article><h1 id=shallow-clone-nixpkgs>Shallow Clone Nixpkgs</h1><p><strong>TOC</strong></p><ul><li><a href=#shallow-clone-nixpkgs>Shallow Clone Nixpkgs</a><ul><li><a href=#import-your-non-flake-wallpaper-repo>Import your Non-Flake Wallpaper Repo</a></li><li><a href=#understanding-patterns>Understanding @-patterns</a></li><li><a href=#understanding-specialargs>Understanding <code>specialArgs</code></a></li><li><a href=#set-up-flake-check-and-formatter-outputs>Set up Flake Check and Formatter Outputs</a> - <a href=#add-a-devshell-output>Add a devShell Output</a></li></ul></li></ul><figure><img src=/images/gruv8.png alt=gruv8 width=700></figure><ol><li>Shallow clone nixpkgs, the full Git history isn&rsquo;t always necessary and this
can speed up build times.</li></ol><ul><li>The only issue I&rsquo;ve had is <code>nix-index-database</code> not working well with the
shallow clone&mldr; Other than that no issues after running for a few months.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;git+https://github.com/NixOS/nixpkgs?shallow=1&amp;ref=nixos-unstable&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><ul><li>Some times when you might need a full clone are debugging and working with
repository history but those are rare.</li></ul><h2 id=import-your-non-flake-wallpaper-repo>Import your Non-Flake Wallpaper Repo</h2><ol start=2><li>Importing your non-flake wallpapers repo:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    wallpapers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:saylesss88/wallpapers&#34;</span>;
</span></span><span style=display:flex><span>      flake <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>After adding the input I can access individual wallpapers by adding the <code>inputs</code> argument and
something like <code>path = "${inputs.wallpapers}/Aesthetic Scenery.jpg";</code></li></ul><h2 id=understanding--patterns>Understanding @-patterns</h2><ol start=3><li>Understanding <code>@-patterns</code>, being able to reference your outputs argument set as a whole. An
<code>@-pattern</code> is a way for a function can access variadic attributes (i.e. varying number of
arguments).</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>inputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    home-manager<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:nix-community/home-manager/master&#34;</span>;
</span></span><span style=display:flex><span>    home-manager<span style=color:#f92672>.</span>inputs<span style=color:#f92672>.</span>nixpkgs<span style=color:#f92672>.</span>follows <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixpkgs&#34;</span>;
</span></span><span style=display:flex><span>    stylix<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;github:danth/stylix&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>outputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    self<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    home-manager<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>} <span style=color:#f92672>@</span> inputs:
</span></span></code></pre></div><p>With the above example to add the modules to your nixosConfigurations you would add something
like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>nixosConfigurations<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>  specialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inherit</span> inputs username host email systemSettings;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>./hosts</span><span style=color:#960050;background-color:#1e0010>/$</span>{host}<span style=color:#e6db74>/config.nix</span>
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>.</span>stylix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>stylix
</span></span><span style=display:flex><span>  home-manager<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>home-manager
</span></span><span style=display:flex><span>  <span style=color:#75715e># .. snip ..</span>
</span></span><span style=display:flex><span>];
</span></span></code></pre></div><ul><li>Notice that since home-manager was explicitly listed in the outputs arguments:
<code>outputs = { self, nixpkgs, home-manager, }; </code>the <code>inputs</code> prefix is unnecessary.
If home-manager was removed from the outputs arguments: <code>outputs = { self, ... }</code>
then you would need <code>modules = [ inputs.home-manager.nixosModules.home-manager];</code> This can be confusing
because many docs assume your not using an @-pattern so if you have one in your flake you need to prefix
with <code>inputs</code>. I use this to reference my personal wallpapers repo mentioned earlier.</li></ul><h2 id=understanding-specialargs>Understanding <code>specialArgs</code></h2><ol start=4><li>Understanding <code>specialArgs</code> (nixos) and <code>extraSpecialArgs</code> (home-manager). Building on the @-patterns, using
<code>specialArgs</code> and <code>extraSpecialArgs</code> is a way to pass arguments from your flake to your NixOS and home-manager
modules.</li></ol><p>For example, here is a snippet of some variables I set:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>outputs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  self<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  nixpkgs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  home-manager<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>} <span style=color:#f92672>@</span> inputs: <span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>  host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;magic&#34;</span>;
</span></span><span style=display:flex><span>  username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jr&#34;</span>;
</span></span><span style=display:flex><span>  userVars <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    timezone <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;America/New_York&#34;</span>;
</span></span><span style=display:flex><span>    locale <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>;
</span></span><span style=display:flex><span>    gitUsername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TSawyer87&#34;</span>;
</span></span><span style=display:flex><span>    dotfilesDir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;~/.dotfiles&#34;</span>;
</span></span><span style=display:flex><span>    wm <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hyprland&#34;</span>;
</span></span><span style=display:flex><span>    browser <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;firefox&#34;</span>;
</span></span><span style=display:flex><span>    term <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ghostty&#34;</span>;
</span></span><span style=display:flex><span>    editor <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hx&#34;</span>;
</span></span><span style=display:flex><span>    keyboardLayout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>in</span>
</span></span></code></pre></div><p>Now I can pass them as special args like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span>nixosConfigurations <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>nixosSystem {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>        specialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>inherit</span>
</span></span><span style=display:flex><span>            inputs
</span></span><span style=display:flex><span>            username
</span></span><span style=display:flex><span>            system
</span></span><span style=display:flex><span>            host
</span></span><span style=display:flex><span>            userVars
</span></span><span style=display:flex><span>            ;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        modules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>./hosts</span><span style=color:#960050;background-color:#1e0010>/$</span>{host}<span style=color:#e6db74>/configuration.nix</span>
</span></span><span style=display:flex><span>        home-manager<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>home-manager
</span></span><span style=display:flex><span>        inputs<span style=color:#f92672>.</span>stylix<span style=color:#f92672>.</span>nixosModules<span style=color:#f92672>.</span>stylix
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>useGlobalPkgs <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>useUserPackages <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>users<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>username<span style=color:#e6db74>}</span> <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./hosts</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#e6db74>${</span>host<span style=color:#e6db74>}</span><span style=color:#e6db74>/home.nix</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>backupFileExtension <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;backup&#34;</span>;
</span></span><span style=display:flex><span>          home-manager<span style=color:#f92672>.</span>extraSpecialArgs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>inherit</span>
</span></span><span style=display:flex><span>              inputs
</span></span><span style=display:flex><span>              username
</span></span><span style=display:flex><span>              system
</span></span><span style=display:flex><span>              host
</span></span><span style=display:flex><span>              userVars
</span></span><span style=display:flex><span>              ;
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ];
</span></span></code></pre></div><ul><li>To access values in <code>userVars</code> for example:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># git.nix</span>
</span></span><span style=display:flex><span>{ userVars<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }: {
</span></span><span style=display:flex><span>  programs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    git <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      userName <span style=color:#f92672>=</span> userVars<span style=color:#f92672>.</span>gitUsername;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=set-up-flake-check-and-formatter-outputs>Set up Flake Check and Formatter Outputs</h2><ol start=5><li>Set up <code>checks</code> and <code>formatter</code> outputs with <code>treefmt-nix</code>. Add <code>treefmt-nix</code> to your inputs and outputs arguments.
Inside the <code>let</code> expression from tip 4 I would add:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># flake.nix</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ... snip ...</span>
</span></span><span style=display:flex><span>pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> nixpkgs {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>allowUnfree <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>treefmtEval <span style=color:#f92672>=</span> treefmt-nix<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>evalModule pkgs <span style=color:#e6db74>./treefmt.nix</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  checks<span style=color:#f92672>.</span>x86_64-linux<span style=color:#f92672>.</span>style <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>check self;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  formatter<span style=color:#f92672>.</span>x86_64-linux <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>wrapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ... snip ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And in the <code>treefmt.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># treefmt.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>projectRootFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;flake.nix&#34;</span>;
</span></span><span style=display:flex><span>programs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  deadnix<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  statix<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  keep-sorted<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  nixfmt <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    strict <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>settings<span style=color:#f92672>.</span>excludes <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.age&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.jpg&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.nu&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*.png&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;.jj/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;flake.lock&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;justfile&#34;</span>
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>settings<span style=color:#f92672>.</span>formatter <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  deadnix <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  statix <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  nixfmt <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>Use <code>treefmt-nix</code> to manage code formatters and linters as flake outputs. This ensures consistent styling
and catches issues with tools like <code>deadnix</code>, <code>statix</code>, and <code>nixfmt</code>.</p></li><li><p>Use <code>nix fmt</code> in the flake directory to format your whole configuration.</p></li><li><p>Now you can run <code>nix flake check</code> to run your checks. Running <code>nix flake show</code> will list your outputs.</p></li><li><p>Tools like <code>nix-fast-build</code> rely on flake checks and can be used after setting this up.</p></li></ul><h3 id=add-a-devshell-output>Add a devShell Output</h3><ol start=6><li>Make a devShell output:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span> in
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      checks<span style=color:#f92672>.</span>x86_64-linux<span style=color:#f92672>.</span>style <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>check self;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      formatter<span style=color:#f92672>.</span>x86_64-linux <span style=color:#f92672>=</span> treefmtEval<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>build<span style=color:#f92672>.</span>wrapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      devShells<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#f92672>.</span>default <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>./lib/dev-shell.nix</span> { <span style=color:#66d9ef>inherit</span> inputs; };
</span></span></code></pre></div><p>and in the <code>dev-shell.nix</code> you could put something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#75715e># dev-shell.nix</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  inputs<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>  system <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>}:
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Instantiate nixpkgs with the given system and allow unfree packages</span>
</span></span><span style=display:flex><span>  pkgs <span style=color:#f92672>=</span> <span style=color:#f92672>import</span> inputs<span style=color:#f92672>.</span>nixpkgs {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inherit</span> system;
</span></span><span style=display:flex><span>    config<span style=color:#f92672>.</span>allowUnfree <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    overlays <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add overlays if needed, e.g., inputs.neovim-nightly-overlay.overlays.default</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span><span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>pkgs<span style=color:#f92672>.</span>mkShell {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nixos-dev&#34;</span>;
</span></span><span style=display:flex><span>  packages <span style=color:#f92672>=</span> <span style=color:#66d9ef>with</span> pkgs; [
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nix tools</span>
</span></span><span style=display:flex><span>    nixfmt-rfc-style <span style=color:#75715e># Formatter</span>
</span></span><span style=display:flex><span>    deadnix <span style=color:#75715e># Dead code detection</span>
</span></span><span style=display:flex><span>    nixd <span style=color:#75715e># Nix language server</span>
</span></span><span style=display:flex><span>    nil <span style=color:#75715e># Alternative Nix language server</span>
</span></span><span style=display:flex><span>    nh <span style=color:#75715e># Nix helper</span>
</span></span><span style=display:flex><span>    nix-diff <span style=color:#75715e># Compare Nix derivations</span>
</span></span><span style=display:flex><span>    nix-tree <span style=color:#75715e># Visualize Nix dependencies</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Code editing</span>
</span></span><span style=display:flex><span>    helix
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># General utilities</span>
</span></span><span style=display:flex><span>    git
</span></span><span style=display:flex><span>    ripgrep
</span></span><span style=display:flex><span>    jq
</span></span><span style=display:flex><span>    tree
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  shellHook <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;Welcome to the NixOS development shell!&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;System: </span><span style=color:#e6db74>${</span>system<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;Tools available: nixfmt, deadnix, nixd, nil, nh, nix-diff, nix-tree, helix, git, ripgrep, jq, tree&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>You can enter this devshell with <code>nix develop</code> or automatically with <code>direnv</code>.</li></ul></article><div class=row><div class=col-md><a href=https://saylesss88.github.io/posts/working_with_nixpkgs_locally/><span>previous: </span><span>Working_with_nixpkgs_locally</span></a></div><div class="col-md text-md-end"><a href=https://saylesss88.github.io/posts/simple_nix_service/><span>next: </span><span>Simple_nix_service</span></a></div></div></div></div><footer><div class="container mt-4 pb-1"><p class="small opacity-75"></p><p><a href=https://saylesss88.github.io//index.xml><img src=/images/rss.png alt="RSS Feed" width=24></a></p></div></footer></main><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js integrity=sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz crossorigin=anonymous></script></body></html>