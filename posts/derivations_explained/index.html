<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://saylesss88.github.io/favicon.ico><meta property="og:url" content="https://saylesss88.github.io/posts/derivations_explained/"><meta property="og:site_name" content="NixOS Blog"><meta property="og:title" content="Derivations_explained"><meta property="og:description" content="Introduction to Nix Derivations TOC
Introduction to Nix Derivations Creating Derivations in Nix Our First Simple Derivation: Understanding the Builder Why a Builder Script? The Challenge with Shebangs in Nix The Importance of Statelessness in Nix Our builder Script Our Second Derivation Links To Articles about Derivations A derivation in Nix is a fundamental concept that describes how to build a piece of software or a resource (e.g., a package, library, or configuration file). Think of it as a recipe for creating something within the Nix ecosystem."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-14T19:25:48-04:00"><meta property="article:modified_time" content="2025-05-14T19:25:48-04:00"><title>NixOS Blog | Derivations_explained</title>
<link rel=stylesheet href=/css/main.min.9d7861a670d885bddfdca28e2bec973020e2e1f1b049a5849a85a2e0fa249e4c.css integrity="sha256-nXhhpnDYhb3f3KKOK+yXMCDi4fGwSaWEmoWi4Poknkw=" crossorigin=anonymous><link rel=stylesheet href=/css/palette/default.min.cfcbb0f894da76afbc5a46072e5cbec733a983f27395920a3cfdf6977053c351.css integrity="sha256-z8uw+JTadq+8WkYHLly+xzOpg/JzlZIKPP32l3BTw1E=" crossorigin=anonymous><script src=/js/main.86bb3d8e6f46df0fc97c2731e6b99175a13b87a4086acf578ff9b6992fcf32c1.js integrity="sha256-hrs9jm9G3w/JfCcx5rmRdaE7h6QIas9Xj/m2mS/PMsE=" crossorigin=anonymous></script><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH crossorigin=anonymous></head><body class=dark><main><div class="container pt-5"><div class="row mt-5 pt-5"></div><div class=post><header class=mb-4><h1 class=text-uppercase>Derivations_explained</h1><div aria-label=breadcrumb><ol class=breadcrumb><li class="breadcrumb-item small"><time datetime=2025-05-14T19:25:48-04:00>May 14, 2025</time></li><li class="breadcrumb-item small">4 minutes</li></ol></div></header><article><h1 id=introduction-to-nix-derivations>Introduction to Nix Derivations</h1><p><strong>TOC</strong></p><ul><li><a href=#introduction-to-nix-derivations>Introduction to Nix Derivations</a><ul><li><a href=#creating-derivations-in-nix>Creating Derivations in Nix</a></li><li><a href=#our-first-simple-derivation-understanding-the-builder>Our First Simple Derivation: Understanding the Builder</a><ul><li><a href=#why-a-builder-script>Why a Builder Script?</a></li><li><a href=#the-challenge-with-shebangs-in-nix>The Challenge with Shebangs in Nix</a></li><li><a href=#the-importance-of-statelessness-in-nix>The Importance of Statelessness in Nix</a><ul><li><a href=#our-builder-script>Our builder Script</a></li><li><a href=#our-second-derivation>Our Second Derivation</a></li><li><a href=#links-to-articles-about-derivations>Links To Articles about Derivations</a></li></ul></li></ul></li></ul></li></ul><figure><img src=/images/gruv10.png alt=gruv10 width=700></figure><ul><li><p>A derivation in Nix is a fundamental concept that describes how to build a piece of software or a resource (e.g., a package, library, or configuration file). Think of it as a recipe for creating something within the Nix ecosystem.</p></li><li><p>For beginners, the analogy of a cooking recipe is helpful:</p><ul><li><strong>Ingredients (Dependencies):</strong> What other software or libraries are needed.</li><li><strong>Steps (Build Instructions):</strong> The commands to compile, configure, and install.</li><li><strong>Final Dish (Output):</strong> The resulting package or resource.</li></ul></li><li><p>A Nix derivation encapsulates all this information, telling Nix what inputs
to use, how to build it, and what the final output should be.</p></li></ul><h2 id=creating-derivations-in-nix>Creating Derivations in Nix</h2><ul><li><p>The primary way to define packages in Nix is through the <code>mkDerivation</code> function, which is part of the standard environment (<code>stdenv</code>). While a
lower-level <code>derivation</code> function exists for advanced use cases,
<code>mkDerivation</code> simplifies the process by automatically managing dependencies
and the build environment.</p></li><li><p><code>mkDerivation</code> (and <code>derivation</code>) takes a set of attributes as its argument.
At a minimum, you&rsquo;ll often encounter these essential attributes:</p><ol><li><strong>name:</strong> A human-readable identifier for the derivation
(e.g., &ldquo;foo&rdquo;, &ldquo;hello.txt&rdquo;). This helps you and Nix refer to the package.</li><li><strong>system:</strong> Specifies the target architecture for the build
(e.g., <code>builtins.currentSystem</code> for your current machine).</li><li><strong>builder:</strong> Defines the program that will execute the build instructions
(e.g., <code>bash</code>).</li></ol></li></ul><h2 id=our-first-simple-derivation-understanding-the-builder>Our First Simple Derivation: Understanding the Builder</h2><ul><li>To understand how derivations work, let&rsquo;s create a very basic example using a
bash script as our <code>builder</code>.</li></ul><h3 id=why-a-builder-script>Why a Builder Script?</h3><ul><li>The <code>builder</code> attribute in a derivation tells Nix <em>how</em> to perform the build
steps. A simple and common way to define these steps is with a bash script.</li></ul><h3 id=the-challenge-with-shebangs-in-nix>The Challenge with Shebangs in Nix</h3><ul><li><p>In typical Unix-like systems, you might start a bash script with a shebang
(<code>#!/bin/bash</code> or <code>#!/usr/bin/env bash</code>) to tell the system how to execute it.
However, in Nix derivations, we generally avoid this.</p></li><li><p><strong>Reason:</strong> Nix builds happen in an isolated environment where the exact path
to common tools like <code>bash</code> isn&rsquo;t known beforehand (it resides within the Nix
store). Hardcoding a path or relying on the system&rsquo;s <code>PATH</code> would break Nix&rsquo;s
stateless property.</p></li></ul><h3 id=the-importance-of-statelessness-in-nix>The Importance of Statelessness in Nix</h3><ul><li><p><strong>Stateful Systems (Traditional):</strong> When you install software traditionally,
it often modifies the core system environment directly. This can lead to
dependency conflicts and makes rollbacks difficult.</p></li><li><p><strong>Stateless Systems (Nix):</strong> Nix takes a different approach. When installing
a package, it creates a unique, immutable directory in the Nix store. This
means:</p><ul><li><strong>No Conflicts:</strong> Different versions of the same package can coexist
without interfering with each other.</li><li><strong>Reliable Rollback:</strong> You can easily switch back to previous versions
without affecting system-wide files.</li><li><strong>Reproducibility:</strong> Builds are more likely to produce the same result
across different machines if they are &ldquo;pure&rdquo; (don&rsquo;t rely on external
system state).</li></ul></li></ul><h4 id=our-builder-script>Our builder Script</h4><ul><li>For our first derivation, we&rsquo;ll create a simple <code>builder.sh</code> file in the current directory:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># builder.sh</span>
</span></span><span style=display:flex><span>declare -xp
</span></span><span style=display:flex><span>echo foo &gt; $out
</span></span></code></pre></div><ul><li><p>The command <code>declare -xp</code> lists exported variables (it&rsquo;s a bash builtin
function).</p></li><li><p>Nix needs to know where the final built product (the &ldquo;cake&rdquo; in our earlier
analogy) should be placed. So, during the derivation process, Nix calculates
a unique output path within the Nix store. This path is then made available
to our builder script as an environment variable named <code>$out</code>. The <code>.drv</code>
file, which is the recipe, contains instructions for the builder, including
setting up this <code>$out</code> variable. Our builder script will then put the result
of its work (in this case, the &ldquo;foo&rdquo; file) into this specific <code>$out</code> directory.</p></li><li><p>As mentioned earlier we need to find the nix store path to the bash
executable, common way to do this is to load Nixpkgs into the repl
and check:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-repl&gt; :l &lt;nixpkgs&gt;
</span></span><span style=display:flex><span>Added <span style=color:#ae81ff>3950</span> variables.
</span></span><span style=display:flex><span>nix-repl&gt; <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>bash<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;/nix/store/ihmkc7z2wqk3bbipfnlh0yjrlfkkgnv6-bash-4.2-p45&#34;</span>
</span></span></code></pre></div><p>So, with this little trick we are able to refer to <code>bin/bash</code> and create
our derivation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-repl&gt; d <span style=color:#f92672>=</span> derivation <span style=color:#f92672>{</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;foo&#34;</span>; builder <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>bash<span style=color:#e6db74>}</span><span style=color:#e6db74>/bin/bash&#34;</span>;
</span></span><span style=display:flex><span> args <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> ./builder.sh <span style=color:#f92672>]</span>; system <span style=color:#f92672>=</span> builtins.currentSystem; <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>nix-repl&gt; :b d
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#ae81ff>1</span> built, 0.0 MiB DL<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>this derivation produced the following outputs:
</span></span><span style=display:flex><span>  out -&gt; /nix/store/gczb4qrag22harvv693wwnflqy7lx5pb-foo
</span></span></code></pre></div><ul><li><p>Boom! The contents of <code>/nix/store/w024zci0x1hh1wj6gjq0jagkc1sgrf5r-foo</code>
is really foo! We&rsquo;ve built our first derivation.</p></li><li><p>Derivations are the primitive that Nix uses to define packages. “Package”
is a loosely defined term, but a derivation is simply the result of calling
<code>builtins.derivation</code>.</p></li></ul><h4 id=our-second-derivation>Our Second Derivation</h4><p>The following is a simple <code>hello-drv</code> derivation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>nix-repl<span style=color:#f92672>&gt;</span> hello-drv <span style=color:#f92672>=</span> nixpkgs<span style=color:#f92672>.</span>stdenv<span style=color:#f92672>.</span>mkDerivation {
</span></span><span style=display:flex><span>            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello.txt&#34;</span>;
</span></span><span style=display:flex><span>            unpackPhase <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>;
</span></span><span style=display:flex><span>            installPhase <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              echo -n &#34;Hello World!&#34; &gt; $out
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#39;&#39;</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nix-repl<span style=color:#f92672>&gt;</span> hello-drv
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>«</span>derivation <span style=color:#e6db74>/nix/store/ad6c51ia15p9arjmvvqkn9fys9sf1kdw-hello.txt.drv</span><span style=color:#960050;background-color:#1e0010>»</span>
</span></span></code></pre></div><ul><li>Derivations have a <code>.drv</code> suffix, as you can see the result of calling
<code>hello-drv</code> is the nix store path to a derivation.</li></ul><h4 id=links-to-articles-about-derivations>Links To Articles about Derivations</h4><ul><li><p><a href=https://nixos.org/guides/nix-pills/06-our-first-derivation>NixPillsOurFirstDerivation</a></p></li><li><p><a href=https://nixos.org/guides/nix-pills/07-working-derivation>NixPills-WorkingDerivation</a></p></li><li><p><a href=https://nix.dev/manual/nix/2.24/language/derivations>nix.dev-Derivations</a></p></li><li><p><a href=https://nix.dev/tutorials/packaging-existing-software>nix.dev-packagingExistingSoftware</a></p></li><li><p><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>howToLearnNix-MyFirstDerivation</a></p></li><li><p><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>howToLearnNix-DerivationsInDetail</a></p></li><li><p><a href=https://www.sam.today/blog/creating-a-super-simple-derivation-learning-nix-pt-3>Sparky/blog-creatingASuperSimpleDerivation</a> # How to learn Nix</p></li><li><p><a href=https://www.sam.today/blog/derivations-102-learning-nix-pt-4>Sparky/blog-Derivations102</a></p></li><li><p><a href=https://scrive.github.io/nix-workshop/04-derivations/01-derivation-basics.html>ScriveNixWorkshop-nixDerivationBasics</a></p></li><li><p><a href=https://zero-to-nix.com/concepts/derivations/>zeroToNix-Derivations</a></p></li><li><p><a href=https://www.tweag.io/blog/2021-02-17-derivation-outputs-and-output-paths/>Tweag-derivationOutputs</a></p></li><li><p><a href=https://ayats.org/blog/nix-tuto-2>theNixLectures-Derivations</a></p></li><li><p><a href=https://bmcgee.ie/posts/2023/02/nix-what-are-fixed-output-derivations-and-why-use-them/>bmcgee-whatAreFixed-OutputDerivations</a></p></li></ul></article><div class=row><div class=col-md><a href=https://saylesss88.github.io/posts/simple_nix_service/><span>previous: </span><span>Simple_nix_service</span></a></div><div class="col-md text-md-end"><a href=https://saylesss88.github.io/posts/declarative_depinject/><span>next: </span><span>Declarative_depinject</span></a></div></div></div></div><footer><div class="container mt-4 pb-1"><p class="small opacity-75"></p></div></footer></main><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js integrity=sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz crossorigin=anonymous></script></body></html>