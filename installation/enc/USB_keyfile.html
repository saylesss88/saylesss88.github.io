<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>USB Stick Keyfile - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="usb-stick-keyfile"><a class="header" href="#usb-stick-keyfile">USB Stick Keyfile</a></h1>
<details>
<summary> ✔️ Click to Expand Table of Contents</summary>
<ul>
<li><a href="#keyfile-enrollment-methods">Keyfile Enrollment Methods</a></li>
<li><a href="#instructions-for-using-a-usb-stick-with-existing-data">Instructions for Using a USB Stick with Existing Data</a></li>
</ul>
</details>
<p>This allows you to use a USB stick for your keyfile, with a backup in case you
want or need it. There is a setting <code>fallbackToPassword</code> that protects you in
case something fails with the USB key.</p>
<p>First, I'll show how to set up a dedicated USB stick for a keyfile. (i.e., one
that is only used for this). After that I will show the process of adding the
keyfile to a USB stick with existing data on it that you don't want to lose.</p>
<p><strong>Generate the keyfile</strong></p>
<pre><code class="language-bash">sudo dd if=/dev/urandom of=/root/usb-luks.key bs=4096 count=1
</code></pre>
<h2 id="keyfile-enrollment-methods"><a class="header" href="#keyfile-enrollment-methods">Keyfile Enrollment Methods</a></h2>
<p>This is for a dedicated USB stick that we will wipe first then add the key.</p>
<p>Disko defaults to LUKS2</p>
<pre><code class="language-bash"># cryptsetup works for both LUKS1 and LUKS2 formats but doesn't work for
# TPM2, FIDO2, and smartcards
sudo cryptsetup luksAddKey /dev/disk/by-partlabel/luks /root/usb-luks.key
</code></pre>
<p><strong>OR</strong></p>
<details>
<summary> ✔️ Click to expand Experimental TPM2 auto-unlock </summary>
<p>Find your encrypted partition with <code>lsblk</code>:</p>
<pre><code class="language-bash">lsblk
</code></pre>
<p>First, you need to use the <code>systemd-cryptenroll</code> command to add a TPM2 key to
your encrypted LUKS partition. This process binds a key slot on your disk to the
state of your TPM2 chip's PCRs (Platform Configuration Registers).</p>
<pre><code class="language-bash"># This command adds a new key to the LUKS volume, using a key generated by the TPM2 chip.
# It binds the key to PCRs 0,2,7,and 15 ensuring the key is only released if the firmware
# and Secure Boot state of your system is unchanged.
sudo systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+2+7+15 /dev/nvme0n1p2
</code></pre>
<p>You can choose a more complex <code>--tpm2-pcrs</code> for more security but it makes the
configuration more fragile because any legitimate system update altering any
measured component tied to these PCRs will prevent the TPM from releasing the
key and lock you out, unless you re-enroll the key with the updated PCR values.</p>
<ul>
<li><a href="https://uapi-group.org/specifications/specs/linux_tpm_pcr_registry/">PCR Definitions</a></li>
</ul>
<p>That said, I do often see people mention a firmware update breaking their TPM2
auto-unlock functionality. Keep this in mind and have a backup plan. This is
also incompatible with the encrypted impermanence setup shared in this book, the
<code>boot.initrd.postDeviceCommands</code> conflict.</p>
<p>Change <code>YourUser</code> to your username and ensure that <code>cryptroot</code> is the name of
yours, if you followed this books encrypted disko install it should be:</p>
<pre><code class="language-nix">  # Adds your user to the 'tss' group, allowing you to interact with the TPM
  users.users.YourUser.extraGroups = [ "tss" ];
  # Enables TPM2 services and tools on your system
  security.tpm2.enable = true;
  # Ensure the necessary kernel modules are in the initrd
  boot.initrd.kernelModules = ["tpm_tis"];
  # switches the initrd to a systemd-based environment, required for TPM2
  boot.initrd.systemd.enable = true;
  # ❗ Tell the initrd to use the TPM2 key for the encrypted root
  boot.initrd.luks.devices.cryptroot = {
    device = "/dev/disk/by-partlabel/luks";
    # These options tell systemd-cryptsetup to automatically try to unlock the device
    # using the TPM2 key. 'tpm2-measure=yes' ensures the PCRs are verified but only works if you use one disk
    crypttabExtraOpts = ["tpm2-device=auto" "tpm2-measure=yes"];
    fallbackToPassword = true;
  };
</code></pre>
<p>If you use this, you can't also use the USB Keyfile.</p>
</details>
<p><strong>Description</strong></p>
<ul>
<li>
<p><code>/dev/disk/by-partlabel/luks</code> refers to your encrypted partition by its
partition label, which is stable and less likely to change than
<code>/dev/nvme0n1p2</code></p>
</li>
<li>
<p><code>/root/usb-luks.key</code> is the keyfile we generated.</p>
</li>
<li>
<p>You'll be prompted to enter your existing LUKS passphrase to authorize adding
the new key.</p>
</li>
<li>
<p>Now our LUKS volume will accept both our existing passphrase and the new
keyfile (from the USB stick) for unlocking.</p>
</li>
</ul>
<ol>
<li><strong>Clear Data on USB stick and replace with 0's</strong></li>
</ol>
<pre><code class="language-bash">lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda           8:0    1   239M  0 disk
sdb           8:16   1   1.4M  0 disk  /run/media/jr/7CD1-149A # Example USB mount
zram0       253:0    0   7.5G  0 disk  [SWAP]
nvme0n1     259:0    0 476.9G  0 disk
├─nvme0n1p1 259:1    0   512M  0 part  /boot
└─nvme0n1p2 259:2    0 476.4G  0 part
  └─cryptroot 254:0  0 476.4G  0 crypt /persist  # Main Btrfs mount
                                               # (other subvolumes are within /persist and bind-mounted by impermanence)
# unplug the device and run lsblk again so your sure
</code></pre>
<ol start="2">
<li>Before wiping you must unmount any mounted partitions:</li>
</ol>
<pre><code class="language-bash">sudo umount /dev/sda1
</code></pre>
<pre><code class="language-bash"># Overwrite with Zeros (fast, sufficient for most uses)
sudo dd if=/dev/zero of=/dev/sda bs=4M status=progress
# Or overwrite with Random Data (More Secure, Slower)
sudo dd if=/dev/urandom of=/dev/sda bs=4M status=progress
# Or for the most secure way run multiple passes of
sudo shred -v -n 3 /dev/sda
</code></pre>
<ol start="3">
<li>Create a New Partition and Format (Optional)</li>
</ol>
<pre><code class="language-bash">sudo fdisk /dev/sda
</code></pre>
<ol>
<li>
<p>Press <code>o</code> to create a new empty DOS partition table (if you are creating
partitions on a fresh disk or want to wipe existing partitions and start
over). Be very careful with this step as it will erase all existing
partition information on the disk.</p>
</li>
<li>
<p>Press <code>n</code> to create a new partition.</p>
</li>
</ol>
<ul>
<li>
<p>You will then be prompted for the partition type:</p>
<ul>
<li>
<p><code>p</code> for a primary partition (you can have up to 4 primary partitions)</p>
</li>
<li>
<p><code>e</code> for an extended partition (which can contain logical partitions)</p>
</li>
</ul>
</li>
<li>
<p>Next, you'll be asked for the partition number (e.g., 1, 2, 3, 4).</p>
</li>
<li>
<p>Then, you'll be asked for the first sector (press Enter to accept the default,
which is usually the first available sector after the previous partition or
the beginning of the disk).</p>
</li>
<li>
<p>Finally, you'll be asked for the last sector or size (you can specify a size
like +10G for 10 Gigabytes, +512M for 512 Megabytes, or press Enter to use the
rest of the available space).</p>
</li>
</ul>
<ol start="3">
<li>Press <code>w</code> to write the changes to the partition table and exit fdisk.</li>
</ol>
<p>After pressing <code>w</code>, the kernel needs to be aware of the new partition table.
Sometimes this happens automatically, but if you encounter issues, a reboot or a
command like <code>partprobe</code> (if available and needed) can help.</p>
<p>Formats as FAT32:</p>
<pre><code class="language-bash">sudo mkfs.vfat /dev/sda1
# or as ext4
sudo mkfs.ext4 /dev/sda1
</code></pre>
<p>I chose <code>vfat</code> so I ran <code>sudo mkfs.vfat /dev/sda1</code>. In my case this changed the
device path to <code>/run/media/jr/7CD1-149A</code> so it's important to find your own UUID
with the following command:</p>
<pre><code class="language-bash">sudo blkid /dev/sda1
/dev/sda1: SEC_TYPE="msdos" UUID="B7B4-863B" BLOCK_SIZE="512" TYPE="vfat" PARTUUID="7d1f9d7f-01"
</code></pre>
<ul>
<li>
<p>As you can see the above UUID is <code>"B7B4-863B"</code></p>
</li>
<li>
<p>Remove and re-insert the USB stick, this ensures the system recognizes the new
partition and filesystem.</p>
</li>
</ul>
<ol start="4">
<li>Copy the keyfile to your USB Stick</li>
</ol>
<pre><code class="language-bash">sudo cp /root/usb-luks.key /run/media/jr/B7B4-863B/
sync
</code></pre>
<ol start="5">
<li>Update your NixOS Configuration</li>
</ol>
<p>Note the output of <code>blkid /dev/sda1</code> and if you have a backup device list that
also:</p>
<p>The following is from the wiki edited for my setup, it was created by Tzanko
Matev:</p>
<pre><code class="language-nix">let
  PRIMARYUSBID = "B7B4-863B";
  BACKUPUSBID = "Ventoy";
in {

  boot.initrd.kernelModules = [
    "uas"
    "usbcore"
    "usb_storage"
    "vfat"
    "nls_cp437"
    "nls_iso8859_1"
  ];

  boot.initrd.postDeviceCommands = lib.mkBefore ''
    mkdir -p /key
    sleep 2
    mount -n -t vfat -o ro $(findfs UUID=${PRIMARYUSBID}) /key || \
    mount -n -t vfat -o ro $(findfs UUID=${BACKUPUSBID}) /key || echo "No USB key found"
  '';

  boot.initrd.luks.devices.cryptroot = {
    device = "/dev/disk/by-partlabel/luks";
    keyFile = "/key/usb-luks.key";
    fallbackToPassword = true;
    allowDiscards = true;
    preLVM = false; # Crucial!
  };
}
</code></pre>
<p>If you have issues or just want to remove the key take note of the path used to
add it so you don't have to enter the whole key:</p>
<pre><code class="language-bash">sudo cryptsetup luksRemoveKey /dev/disk/by-partlabel/luks --key-file /root/usb-luks.key
</code></pre>
<ol start="6">
<li>Securely Remove the Keyfile from Your System:</li>
</ol>
<pre><code class="language-bash">sudo shred --remove --zero /root/usb-luks.key
</code></pre>
<h2 id="instructions-for-using-a-usb-stick-with-existing-data"><a class="header" href="#instructions-for-using-a-usb-stick-with-existing-data">Instructions for Using a USB Stick with Existing Data</a></h2>
<ol>
<li>Generate the Keyfile</li>
</ol>
<pre><code class="language-bash">sudo dd if=/dev/urandom of=/root/usb-luks.key bs=4096 count=1
</code></pre>
<ol start="2">
<li>Add the Keyfile to your LUKS Volume</li>
</ol>
<pre><code class="language-bash">sudo cryptsetup luksAddKey /dev/disk/by-partlabel/luks /root/usb-luks.key
</code></pre>
<p>(enter your existing passphrase when prompted)</p>
<ol start="3">
<li>Copy the Keyfile to the USB Stick</li>
</ol>
<ul>
<li>
<p>Plug in the USB Stick and note its mount point
(e.g.,<code>/run/media/$USER/YourLabel</code>)</p>
</li>
<li>
<p>Copy the keyfile:</p>
</li>
</ul>
<pre><code class="language-bash">sudo cp /root/usb-luks.key /run/media/$USER/YourLabel/
sync
</code></pre>
<ul>
<li>
<p>You run the above as 2 commands, the second being <code>sync</code>.</p>
</li>
<li>
<p>You can rename it if you wish (e.g., <code>luks.key</code>)</p>
</li>
</ul>
<ol start="4">
<li>Securely Delete the Local Keyfile</li>
</ol>
<pre><code class="language-bash">sudo shred --remove --zero /root/usb-luks.key
</code></pre>
<ul>
<li>You need to ensure the keyfile is accessible in the initrd. Since automounting
(like <code>/run/media/...</code>) does not happen in <code>initrd</code>, you must manually mount
the USB in the <code>initrd</code> using its <code>UUID</code> or label.</li>
</ul>
<p>Find the USB Partition UUID:</p>
<pre><code class="language-bash">lsblk -o NAME,UUID
# or
blkid /dev/sda1
</code></pre>
<p>Suppose the UUID is <code>B7B4-863B</code></p>
<p>Add to your <code>configuration.nix</code>:</p>
<pre><code class="language-nix">boot.initrd.kernelModules = [ "usb_storage" "vfat" "nls_cp437" "nls_iso8859_1" ];

boot.initrd.postDeviceCommands = lib.mkBefore ''
  mkdir -p /key
  sleep 1
  mount -n -t vfat -o ro $(findfs UUID=B7B4-863B) /key || echo "USB not found"
'';

boot.initrd.luks.devices.cryptroot = {
  device = "/dev/disk/by-partlabel/luks";
  keyFile = "/key/usb-luks.key"; # or whatever you named it
  fallbackToPassword = true;
  allowDiscards = true;
};
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../installation/enc/encrypted_impermanence.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../installation/enc/sops-nix.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../installation/enc/encrypted_impermanence.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../installation/enc/sops-nix.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
