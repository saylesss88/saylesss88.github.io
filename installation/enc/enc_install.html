<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encrypted Setups - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="encrypted-setups"><a class="header" href="#encrypted-setups">Encrypted Setups</a></h1>
<details>
<summary> ✔️ Click to Expand Table of Contents</summary>
<ul>
<li><a href="#what-does-luks-encryption-protect">What does LUKS Encryption Protect?</a></li>
<li><a href="#the-install">The Install</a>
<ul>
<li><a href="#option-a-interactive-wpa_cli">Option A: Interactive <code>wpa_cli</code></a></li>
<li><a href="#option-b-non-interactive-wpa_passphrase">Option B: Non-Interactive <code>wpa_passphrase</code></a></li>
</ul>
</li>
<li><a href="#create-a-blank-snapshot-of-root">Create a Blank Snapshot of /root</a></li>
<li><a href="#persisting-critical-system-state">Persisting Critical System State</a></li>
<li><a href="#setting-up-zram-and-tmp-on-ram">Setting up zram and /tmp on RAM</a>
<ul>
<li><a href="#setting-a-flake-for-your-minimal-install">Setting a Flake for your minimal Install</a></li>
</ul>
</li>
</ul>
</details>
<p>NixOS supports file systems that are encrypted using LUKS (Linux Unified Key
Setup). This guide walks you through an encrypted NixOS installation using Disko
for disk management and Btrfs for subvolumes. It is designed for users who want
full disk encryption and a modern filesystem layout. If you prefer an
unencrypted setup, you can skip the LUKS and encryption steps, but this guide
focuses on security and flexibility.</p>
<ul>
<li>For Unencrypted layout
<a href="https://saylesss88.github.io/installation/unencrypted/unencrypted.html">Click Here</a></li>
</ul>
<p>If you choose to set up impermanence, ensure it matches your install. Encrypted
Setup with Encrypted Impermanence and Unencrypted Setup with Unencrypted
Impermanence.</p>
<h2 id="what-does-luks-encryption-protect"><a class="header" href="#what-does-luks-encryption-protect">What does LUKS Encryption Protect?</a></h2>
<p>It's important to understand what disk encryption protects and what it doesn't
protect so you don't have any misconceptions about how safe your data is.</p>
<ul>
<li>
<p><a href="https://wiki.nixos.org/wiki/Full_Disk_Encryption">NixOS Wiki FDE</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Data-at-rest_encryption">Arch Wiki Data-at-rest encryption</a></p>
</li>
<li>
<p><a href="https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html">Authenticated Booot and DE on Linux</a></p>
</li>
<li></li>
</ul>
<p><strong>What LUKS Protects</strong>:</p>
<ul>
<li>
<p><strong>Data Confidentiality at Rest</strong>: LUKS encrypts entire block devices (such as
disk partitions or whole drives), ensuring that all data stored on the
encrypted device is unreadable without the correct decryption key or
passphrase. This protects sensitive information from unauthorized access if
the device is lost, stolen, or physically accessed by an attacker.</p>
</li>
<li>
<p><strong>Physical Security</strong>: If someone gains physical possession of your device
(for example, by stealing your laptop or removing a hard drive), LUKS ensures
the data remains inaccessible and appears as random, meaningless bytes without
the correct credentials.</p>
</li>
<li>
<p><strong>Protection Against Offline Attacks</strong>: LUKS defends against attackers who
attempt to bypass the operating system by booting from another device or
removing the drive and mounting it elsewhere. Without the decryption key, the
data remains protected.</p>
</li>
</ul>
<p><strong>What LUKS Does Not Protect</strong>:</p>
<ul>
<li>
<p><strong>Data in Use</strong>: Once the system is booted and the encrypted device is
unlocked, the data becomes accessible to the operating system and any user or
process with the necessary permissions. LUKS does not protect against attacks
on a running system, such as malware, remote exploits, or unauthorized users
with access to an unlocked session.</p>
</li>
<li>
<p><strong>File-Level Access Control</strong>: LUKS encrypts entire partitions or disks, not
individual files or directories. It does not provide granular file-level
encryption or access control within the operating system.</p>
</li>
<li>
<p><strong>Network Attacks</strong>: LUKS only protects data stored on disk. It does not
encrypt data transmitted over networks or protect against network-based
attacks.</p>
</li>
<li>
<p><strong>Bootloader and EFI Partitions</strong>: The initial bootloader or EFI system
partition cannot be encrypted with LUKS, so some parts of the boot process may
remain exposed unless additional measures are taken. (i.e., Secure Boot,
additional passwords, TPM2)</p>
</li>
</ul>
<p>To Sum it Up: LUKS encryption protects the confidentiality of all data stored on
an encrypted block device by making it unreadable without the correct passphrase
or key. This ensures that, if your device is lost or stolen, your data remains
secure and inaccessible to unauthorized users. However, LUKS does not protect
data once the system is unlocked and running, nor does it provide file-level
encryption or protect against malware and network attacks. For comprehensive
security, LUKS should be combined with strong access controls and other security
best practices.</p>
<h2 id="the-install"><a class="header" href="#the-install">The Install</a></h2>
<ol>
<li>
<p>Get the
<a href="https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso">Nixos Minimal ISO</a>
Get it on a usb stick, I use Ventoy with Ventoy2Disk.sh. The following is the
link to the
<a href="https://sourceforge.net/projects/ventoy/files/v1.1.05/ventoy-1.1.05-linux.tar.gz/download">Ventoy TarBall</a>
download, untar it with <code>tar -xzf ventoy-1.1.05-linux.tar.gz</code>, and make it
executable with <code>chmod +x Ventoy2Disk.sh</code>, and finally execute it with
<code>sudo bash Ventoy2Disk.sh</code> Follow the prompts to finish the install.</p>
</li>
<li>
<p>Configuring Networking</p>
</li>
</ol>
<p>The minimal installer uses <code>wpa_supplicant</code> instead of NetworkManager. Choose
one of the following methods to enable networking:</p>
<pre><code class="language-bash">sudo systemctl start wpa_supplicant
wpa_cli
</code></pre>
<h3 id="option-a-interactive-wpa_cli"><a class="header" href="#option-a-interactive-wpa_cli">Option A: Interactive <code>wpa_cli</code></a></h3>
<pre><code class="language-bash">&gt; add_network
0

&gt; set_network 0 ssid "myhomenetwork"
OK

&gt; set_network 0 psk "mypassword"
OK

&gt; enable_network 0
OK
</code></pre>
<p>To exit type <code>quit</code>, then check your connection with <code>ping google.com</code>.</p>
<h3 id="option-b-non-interactive-wpa_passphrase"><a class="header" href="#option-b-non-interactive-wpa_passphrase">Option B: Non-Interactive <code>wpa_passphrase</code></a></h3>
<p>This method is quicker for known networks and persists the configuration for the
live environment.</p>
<p>First, identify your wireless interface name (e.g., <code>wlan0</code>) using <code>ip a</code>.</p>
<pre><code class="language-bash">sudo systemctl start wpa_supplicant # Ensure wpa_supplicant is running
# This command generates the config and appends it to a file specific to wlan0
sudo wpa_passphrase "myhomenetwork" "mypassword" | sudo tee /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
sudo systemctl restart wpa_supplicant@wlan0.service
</code></pre>
<p>After either method, exit <code>wpa_cli</code> with <code>quit</code>. Then test your connection:</p>
<pre><code class="language-bash">ping google.com
</code></pre>
<ol start="3">
<li>Get your Disk Name with <code>lsblk</code></li>
</ol>
<p>The output should be something like:</p>
<pre><code class="language-bash">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
nvme0n1     259:0    0   1,8T  0 disk
</code></pre>
<ol start="4">
<li>Copy the disk configuration to your machine. You can choose one from the
<a href="https://github.com/nix-community/disko/tree/master/example">examples directory</a>.</li>
</ol>
<p>There is still a starter repo that can save you some typing, make sure to
carefully review if you decide to use it:</p>
<pre><code class="language-bash">export NIX_CONFIG='experimental-features = nix-command flakes'
export EDITOR='hx' # or 'vi'
nix-shell -p git yazi helix mkpasswd
git config --global user.name "gitUsername"
git config --global user.email "gitEmail"
# starter repo containing disk-config set up for impermanence
git clone https://github.com/saylesss88/my-flake.git
</code></pre>
<p>I prefer <code>helix</code> here as it's defaults are great. (i.e., auto closing brackets
and much more)</p>
<p>If you choose to use the starter repo you won't need to run the next command as
it is already populated in the repo.</p>
<p>If you click on the layout you want then click the <code>Raw</code> button near the top,
then copy the <code>url</code> and use it in the following command:</p>
<pre><code class="language-bash">cd /tmp
curl https://raw.githubusercontent.com/nix-community/disko/refs/heads/master/example/luks-btrfs-subvolumes.nix -o /tmp/disk-config.nix
</code></pre>
<p>The above curl command is to the <code>luks-btrfs-subvolumes.nix</code> layout.</p>
<ol start="5">
<li>Make Necessary changes, I prepared mine for impermanence with the following:</li>
</ol>
<pre><code class="language-bash">hx /tmp/disk-config.nix
</code></pre>
<p>Make sure you identify your system disk name with <code>lsblk</code> and change the
<code>device</code> attribute below to match your disk.</p>
<pre><code class="language-bash">lsblk
nvme0n1       259:0    0 476.9G  0 disk
├─nvme0n1p1   259:1    0   512M  0 part  /boot
└─nvme0n1p2   259:2    0 476.4G  0 part
</code></pre>
<p>My disk is <code>nvme0n1</code>, change below to match yours:</p>
<pre><code class="language-nix">{
  disko.devices = {
    disk = {
      nvme0n1 = {
        type = "disk";
        # Make sure this is correct with `lsblk`
        device = "/dev/nvme0n1";
        content = {
          type = "gpt";
          partitions = {
            ESP = {
              label = "boot";
              name = "ESP";
              size = "512M";
              type = "EF00";
              content = {
                type = "filesystem";
                format = "vfat";
                mountpoint = "/boot";
                mountOptions = [
                  "defaults"
                ];
              };
            };
            luks = {
              size = "100%";
              label = "luks";
              content = {
                type = "luks";
                name = "cryptroot";
                content = {
                  type = "btrfs";
                  extraArgs = ["-L" "nixos" "-f"];
                  subvolumes = {
                    "/root" = {
                      mountpoint = "/";
                      mountOptions = ["subvol=root" "compress=zstd" "noatime"];
                    };
                    "/root-blank" = {
                      mountOptions = ["subvol=root-blank" "nodatacow" "noatime"];
                    };
                    "/home" = {
                      mountpoint = "/home";
                      mountOptions = ["subvol=home" "compress=zstd" "noatime"];
                    };
                    "/nix" = {
                      mountpoint = "/nix";
                      mountOptions = ["subvol=nix" "compress=zstd" "noatime"];
                    };
                    "/persist" = {
                      mountpoint = "/persist";
                      mountOptions = ["subvol=persist" "compress=zstd" "noatime"];
                    };
                    "/log" = {
                      mountpoint = "/var/log";
                      mountOptions = ["subvol=log" "compress=zstd" "noatime"];
                    };
                    "/lib" = {
                      mountpoint = "/var/lib";
                      mountOptions = ["subvol=lib" "compress=zstd" "noatime"];
                    };
                  };
                };
              };
            };
          };
        };
      };
    };
  };

  fileSystems."/persist".neededForBoot = true;
  fileSystems."/var/log".neededForBoot = true;
  fileSystems."/var/lib".neededForBoot = true;
}
</code></pre>
<p>If you want to add swap space for hibernation, you’ll need enough swap to store
the contents of your system’s RAM. For example, if you have 16GB of RAM, your
swapfile should be at least 16GB.</p>
<p>To create a swap subvolume for hibernation, you could add something like the
following to your configuration:</p>
<pre><code class="language-nix">"/persist/swap" = {
      mountpoint = "/persist/swap";
      swap.swapfile.size = "16G";
    };
</code></pre>
<p>or for a swapfile:</p>
<pre><code class="language-nix">swapDevices = [
  {
    device = "/persist/swap/swapfile";
    size = 16 * 1024; # Size in MB (16GB)
    # or
    # size = 16384; # Size in MB (16G);
  }
];
</code></pre>
<h2 id="create-a-blank-snapshot-of-root"><a class="header" href="#create-a-blank-snapshot-of-root">Create a Blank Snapshot of /root</a></h2>
<p>This will give us more options when it comes to impermanence. (i.e. being able
to rollback to a fresh snapshot of root on reboot)</p>
<p>To access all of the subvolumes, we have to mount the Btrfs partitions
top-level.</p>
<ol>
<li>Unlock the LUKS device:</li>
</ol>
<pre><code class="language-bash">sudo cryptsetup open /dev/disk/by-partlabel/luks cryptroot
</code></pre>
<ol start="2">
<li>Mount the Btrfs top-level (<code>subvolid=5</code>):</li>
</ol>
<pre><code class="language-bash">sudo mount -o subvolid=5 /dev/mapper/cryptroot /mnt
</code></pre>
<ol start="3">
<li>List the contents:</li>
</ol>
<pre><code class="language-bash">ls /mnt
# you should see something like
root   home  nix  persist  log  lib  ...
</code></pre>
<ol start="4">
<li>Now we can take a snapshot of the <code>root</code> subvolume:</li>
</ol>
<pre><code class="language-bash">sudo btrfs subvolume snapshot -r /mnt/root /mnt/root-blank
</code></pre>
<ol start="5">
<li>Make sure to unmount:</li>
</ol>
<pre><code class="language-bash">sudo umount /mnt
</code></pre>
<h2 id="persisting-critical-system-state"><a class="header" href="#persisting-critical-system-state">Persisting Critical System State</a></h2>
<p>The following is a one time operation, we're just getting it out of the way now.
This moves all of the important system state to a persistant location, further
preparing for impermanence.</p>
<pre><code class="language-bash">sudo mkdir -p /persist/etc
sudo mkdir -p /persist/var/lib
sudo mkdir -p /persist/var/log
sudo mkdir -p /persist/home
sudo mkdir -p /persist/root
sudo cp -a /etc/. /persist/etc/
sudo cp -a /var/lib/. /persist/var/lib
sudo cp -a /var/log/. /persist/var/log
sudo cp -a /home/. /persist/home/
sudo cp -a /root/. /persist/root/
</code></pre>
<h2 id="setting-up-zram-and-tmp-on-ram"><a class="header" href="#setting-up-zram-and-tmp-on-ram">Setting up zram and /tmp on RAM</a></h2>
<p>While <code>/tmp</code> is handled by <code>tmpfs</code> (as shown the below <code>configuration.nix</code>), you
can further enhance memory efficiency with <code>zram</code> for compressed swap, as shown
below.</p>
<blockquote>
<pre><code class="language-nix">{
  lib,
  config,
  ...
}: let
  cfg = config.custom.zram;
in {
  options.custom.zram = {
    enable = lib.mkEnableOption "Enable utils module";
  };

  config = lib.mkIf cfg.enable {
    zramSwap = {
      enable = true;
      # one of "lzo", "lz4", "zstd"
      algorithm = "zstd";
       priority = 5;
       memoryPercent = 50;
    };
  };
}
</code></pre>
<p>And in your <code>configuration.nix</code> you would add:</p>
<pre><code class="language-nix"># configuration.nix
custom = {
    zram.enable = true;
};
</code></pre>
</blockquote>
<p>After adding the above module and rebuilding, you can see it with:</p>
<pre><code class="language-bash">swapon --show
NAME       TYPE      SIZE USED PRIO
/dev/zram0 partition 7.5G   0B    5
</code></pre>
<ol start="6">
<li>Run disko to partition, format and mount your disks. <strong>Warning</strong> this will
wipe <strong>EVERYTHING</strong> on your disk. Disko doesn't work with dual boot.</li>
</ol>
<pre><code class="language-bash">sudo nix --experimental-features "nix-command flakes" run github:nix-community/disko/latest -- --mode destroy,format,mount /tmp/disk-config.nix
</code></pre>
<p>Check it with the following:</p>
<pre><code class="language-bash">mount | grep /mnt
</code></pre>
<p>The output for an <code>nvme0n1</code> disk would be similar to the following:</p>
<pre><code class="language-bash">#... snip ...
/dev/nvme0n1p2 on /mnt type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=285,subvol=/root)
/dev/nvme0n1p2 on /mnt/persist type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=261,subvol=/persist)
/dev/nvme0n1p2 on /mnt/etc type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=261,subvol=/persist)
/dev/nvme0n1p2 on /mnt/nix type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=260,subvol=/nix)
/dev/nvme0n1p2 on /mnt/var/lib type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=258,subvol=/lib)
/dev/nvme0n1p2 on /mnt/var/log type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=259,subvol=/log)
/dev/nvme0n1p2 on /mnt/nix/store type btrfs (ro,noatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=260,subvol=/nix)
# ... snip ...
</code></pre>
<ol start="7">
<li>Generate necessary files, here we use <code>--no-filesystems</code> because disko
handles the <code>fileSystems</code> attribute for us.</li>
</ol>
<pre><code class="language-bash">nixos-generate-config --no-filesystems --root /mnt
</code></pre>
<ul>
<li>The above command will place a <code>configuration.nix</code> and
<code>hardware-configuration.nix</code> in <code>/mnt/etc/nixos/</code></li>
</ul>
<p>It may be helpful to add a couple things to your <code>configuration.nix</code> now, while
it's in it's default location. You can just add what you want and rebuild once
with <code>sudo nixos-rebuild switch</code> and move on. (i.e. <code>git</code>, an editor, etc.).</p>
<h3 id="setting-a-flake-for-your-minimal-install"><a class="header" href="#setting-a-flake-for-your-minimal-install">Setting a Flake for your minimal Install</a></h3>
<ol start="8">
<li>Create the flake in your home directory to avoid needing to use sudo for
every command:</li>
</ol>
<pre><code class="language-bash">cd   # Move to home directory
mkdir flake
cd /mnt/etc/nixos/
sudo mv hardware-configuration.nix configuration.nix ~/flake/
sudo mv /tmp/disk-config.nix ~/flake/
</code></pre>
<pre><code class="language-bash">cd flake
hx flake.nix
</code></pre>
<blockquote>
<p>You'll change <code>hostName = nixpkgs.lib.nixosSystem</code> to your chosen hostname,
(e.g. <code>magic = nixpkgs.lib.nixosSystem</code>). This will be the same as your
<code>networking.hostName = "magic";</code> in your <code>configuration.nix</code> that we will set
up shortly.</p>
</blockquote>
<pre><code class="language-nix"># flake.nix
{
  description = "NixOS configuration";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
    disko.url = "github:nix-community/disko/latest";
    disko.inputs.nixpkgs.follows = "nixpkgs";
    # impermanence.url = "github:nix-community/impermanence";
  };

  outputs = inputs@{ nixpkgs, ... }: {
    nixosConfigurations = {
      # Change `hostName` to your chosen host name
      nixos = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        modules = [
          ./configuration.nix
          inputs.disko.nixosModules.disko
          # inputs.impermanence.nixosModules.impermanence
        ];
      };
    };
  };
}
</code></pre>
<ol start="9">
<li>Edit <code>configuration.nix</code> with what is required, the following are required, I
clone my original flake repo and move the pieces into place but it's fairly
easy to just type it all out:</li>
</ol>
<ul>
<li>
<p>Bootloader, (e.g., <code>boot.loader.systemd-boot.enable = true;</code>)</p>
</li>
<li>
<p>User, the example uses <code>username</code> change this to your chosen username. If you
don't set your hostname it will be <code>nixos</code>.</p>
</li>
<li>
<p>Networking, <code>networking.networkmanager.enable = true;</code></p>
</li>
<li>
<p><code>hardware-configuration.nix</code> &amp; <code>disk-config.nix</code> for this setup</p>
</li>
<li>
<p>If you type this out by hand and mess up a single character, you will have to
start over completely. A fairly safe way to do this is with <code>vim</code> or <code>hx</code> and
redirect the hashed pass to a <code>/tmp/pass.txt</code>, you can then read it into your
<code>users.nix</code>:</p>
</li>
</ul>
<pre><code class="language-bash">mkpasswd -m SHA-512 -s &gt; /tmp/pass.txt
# Enter your chosen password
</code></pre>
<p>And then when inside <code>configuration.nix</code>, move to the line where you want the
hashed password and type <code>:r /tmp/pass.txt</code> to read the hash into your current
file.</p>
<pre><code class="language-nix"># configuration.nix
{
  config,
  lib,
  pkgs,
  inputs,
  ...
}: {
  imports = [
    # Include the results of the hardware scan.
    ./hardware-configuration.nix
    ./disk-config.nix
  ];

  # systemd Stage 1: if enabled, it handles unlocking of LUKS-encrypted volumes during boot.
    boot.initrd.luks.devices = {
    cryptroot = {
      device = "/dev/disk/by-partlabel/luks";
      allowDiscards = true;
    };
  };

  # This complements using zram, putting /tmp on RAM
    boot = {
    tmp = {
      useTmpfs = true;
      tmpfsSize = "50%";
    };
  };

  # Enable autoScrub for btrfs
    services.btrfs.autoScrub = {
    enable = true;
    interval = "weekly";
    fileSystems = ["/"];
  };


  # Change me!
  networking.hostName = "nixos"; # This will match the `hostname` of your flake

  networking.networkmanager.enable = true;

  boot.loader.systemd-boot.enable = true; # (for UEFI systems only)
  # List packages installed in system profile.
  # You can use https://search.nixos.org/ to find more packages (and options).
  environment.systemPackages = with pkgs; [
    vim # Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.
    #   wget
    git
  ];

  time.timeZone = "America/New_York";

# Change me to your chosen username (i.e. change nixosUser to your username)
  users.users.nixosUser = {
    isNormalUser = true;
    extraGroups = [ "wheel" "networkmanager" ]; # Add "wheel" for sudo access
    initialHashedPassword = "READ_MKPASSWD_OUTPUT_HERE"; # &lt;-- This is where it goes!
    # home = "/home/nixos"; # Optional: Disko typically handles home subvolumes
  };

  console.keyMap = "us";

  nixpkgs.config.allowUnfree = true;

  system.stateVersion = "25.05";
}
</code></pre>
<p>Although, just adding the <code>disk-config.nix</code> works for prompting you for your
encryption passphrase adding the following is a more robust way of ensuring Nix
is aware of this:</p>
<pre><code class="language-nix">    boot.initrd.luks.devices = {
    cryptroot = {
      device = "/dev/disk/by-partlabel/luks";
      allowDiscards = true;
    };
  };
</code></pre>
<ol start="10">
<li>Move the flake to <code>/mnt/etc/nixos</code> and run <code>nixos-install</code>:</li>
</ol>
<pre><code class="language-bash">sudo mv ~/flake /mnt/etc/nixos/
</code></pre>
<ul>
<li>Give everything a quick once over, insuring your host is set in both your
<code>flake.nix</code>, and <code>configuration.nix</code>. Ensure you changed the username in the
<code>configuration.nix</code> from <code>nixos</code> to your chosen name, this is the name you'll
use to login after you enter your encryption passphrase.</li>
</ul>
<p>The below command uses <code>#nixos</code> because that's what the defaults are, you'll
change it to your chosen hostname.</p>
<pre><code class="language-bash">sudo nixos-install --flake /mnt/etc/nixos/flake#nixos
</code></pre>
<ul>
<li>
<p>You will be prompted to enter a new password if everything succeeds.</p>
</li>
<li>
<p>If everything checks out, reboot the system and you should be prompted to
enter your <code>user</code> and <code>password</code> to login to a shell to get started.</p>
</li>
<li>
<p>The flake will be placed at <code>/etc/nixos/flake</code> after the install and reboot, I
choose to move it to my home directory. Since the file was first in <code>/etc</code>
you'll need to adjust the permissions with something like
<code>sudo chown -R $USER:users ~/flake</code> and then you can work on it without
privilege escalation.</p>
</li>
<li>
<p>You can check the layout of your btrfs system with:</p>
</li>
</ul>
<pre><code class="language-bash">sudo btrfs subvolume list /
</code></pre>
<ul>
<li>
<p><a href="https://btrfs.readthedocs.io/en/latest/Subvolumes.html">BTRFS Subvolumes</a></p>
</li>
<li>
<p>To set up impermanence for this specific layout, follow the link
<a href="https://saylesss88.github.io/installation/enc/encrypted_impermanence.html">Encrypted Impermanence</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../installation/unencrypted/impermanence.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../installation/enc/encrypted_impermanence.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../installation/unencrypted/impermanence.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../installation/enc/encrypted_impermanence.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
