<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encrypted Setups - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="encrypted-setups"><a class="header" href="#encrypted-setups">Encrypted Setups</a></h1>
<h1 id="minimal-luks-encrypted-install-with-btrfs-subvolumes"><a class="header" href="#minimal-luks-encrypted-install-with-btrfs-subvolumes">Minimal LUKS Encrypted Install with Btrfs Subvolumes</a></h1>
<p>Follow this guide to set up a minimal NixOS install with LUKS, Btrfs, and
encrypted secrets. This guide aims for a manually entered LUKS passphrase at
boot and uses SOPS for other system/user secrets.</p>
<ol>
<li>Prepare the Minimal ISO and Networking</li>
</ol>
<pre><code class="language-bash">sudo systemctl start wpa_supplicant.service # Ensure wpa_supplicant is running
sudo wpa_cli
&gt; add_network
0
&gt; set_network 0 ssid "myhomenetwork"
OK
&gt; set_network 0 psk "mypassword"
OK
&gt; enable_network 0
OK
&gt; quit
</code></pre>
<p>Test your connection: Bash</p>
<pre><code class="language-bash">ping google.com
</code></pre>
<ol start="2">
<li>Enable Experimental Nix Features Bash</li>
</ol>
<pre><code class="language-bash">export NIX_CONFIG='experimental-features = nix-command flakes'
</code></pre>
<ol start="3">
<li>Install Initial Essential Tools &amp; Clone Repo</li>
</ol>
<p>These tools are needed for the initial configuration and running disko. Bash</p>
<pre><code class="language-bash">sudo nix-env -iA nixos.{git,helix,yazi} # Install globally for the installer environment
export EDITOR='hx' #  Set your preferred editor for this session
git config --global user.name "YourUsername"
git config --global user.email "YourGitEmail"
</code></pre>
<ul>
<li>
<p>You may be put off by the <code>nix-env</code> commands, the live installer runs from RAM
and a read-only filesystem. Any packages you install with <code>nix-env</code> are only
available while you're in the live environment. When you reboot, the system is
discarded, and everything reverts to the original state.</p>
</li>
<li>
<p>The only persistent changes are those you deliberately make to the mounted
filesystem (e.g., <code>/mnt</code> during installation), which is the target for your
new NixOS installation.</p>
</li>
</ul>
<h1 id="clone-the-starter-repo"><a class="header" href="#clone-the-starter-repo">Clone the Starter Repo</a></h1>
<pre><code class="language-bash">git clone https://github.com/saylesss88/my-flake.git
</code></pre>
<ol start="4">
<li>Customize Configuration Files (Pre-Disko)</li>
</ol>
<ul>
<li>Navigate into your cloned flake:</li>
</ul>
<pre><code class="language-bash">cd ~/my-flake
</code></pre>
<ul>
<li>
<p>Modify <code>flake.nix</code>, <code>users.nix</code>, and <code>configuration.nix</code> to set your desired
hostname and username.</p>
</li>
<li>
<p>Check your disk device with <code>lsblk</code> and update <code>disk-config2.nix</code> accordingly
(i.e., the device needs to match your actual disk device, e.g., <code>/dev/nvme0n1</code>
or <code>/dev/sda</code>).</p>
</li>
</ul>
<ol start="5">
<li>Apply Initial Configuration &amp; Prepare Disko</li>
</ol>
<p>This step builds a temporary NixOS system in the installer's RAM disk that
includes your disko configuration.</p>
<ul>
<li>Generate your <code>hardware-configuration.nix</code> based on the installer's view of
your hardware.</li>
</ul>
<pre><code class="language-bash">sudo nixos-generate-config --no-filesystems --root /mnt
sudo mv /mnt/etc/nixos/hardware-configuration.nix ~/my-flake/hardware-configuration.nix
</code></pre>
<p>Run Disko to wipe, partition, and format your disk (WARNING: This destroys ALL
data on the target disk, disko doesn't work with dual boot!)</p>
<pre><code class="language-bash">sudo nix --experimental-features "nix-command flakes" run github:nix-community/disko/latest -- --mode destroy,format,mount ~/my-flake/disk-config2.nix
</code></pre>
<ul>
<li>Crucial: You will be prompted for your LUKS passphrase. This is the password
you will use to unlock your disk every time you boot. Choose a strong,
memorable passphrase.</li>
</ul>
<p>Verify your partitions are mounted to <code>/mnt</code>:</p>
<pre><code class="language-bash">mount | grep /mnt
</code></pre>
<p><code>/mnt</code> is a temporary mount point used during installation to access and
configure the target filesystem. Disko uses <code>/mnt</code> to mount the filesystems it
creates, but these mounts are only for the installation process. After
installation and reboot, <code>/mnt</code> is no longer used unless you manually mount
something there.</p>
<p>After installation and reboot:</p>
<ul>
<li>
<p>All files and directories under <code>/mnt</code> (for example, <code>/mnt/etc/nixos/</code>) are
now accessible at their normal system locations.</p>
</li>
<li>
<p>So, <code>/mnt/etc/nixos/</code> becomes <code>/etc/nixos/</code> on your new NixOS system.</p>
</li>
<li>
<p><code>/mnt</code> itself is no longer used as a mount point unless you manually mount
something there again.</p>
</li>
</ul>
<ol start="6">
<li>Install SOPS-Related Tools &amp; Generate Secrets (Post-Disko)</li>
</ol>
<p>Now that your disk is formatted and mounted to <code>/mnt</code>, we can generate and
encrypt your secrets directly onto the target filesystem. This ensures the Age
key is located where the installed system can always find it.</p>
<p>Change into the mounted flake directory:</p>
<pre><code class="language-bash">sudo mv ~/my-flake /mnt/etc/nixos/
cd /mnt/etc/nixos/my-flake
</code></pre>
<p>Install SOPS-related tools:</p>
<pre><code class="language-bash">sudo nix-env -iA nixos.{age,sops,mkpasswd} # Install these into the installer environment
</code></pre>
<p>6.1. Set Up Age Key for SOPS</p>
<p>This generates your Age private key directly on the target root partition.</p>
<p>Create the directory for your Age key and generate the key pair:</p>
<pre><code class="language-bash">sudo mkdir -p /mnt/root/.config/sops/age
sudo age-keygen -o /mnt/root/.config/sops/age/keys.txt
</code></pre>
<p>The above location will persist after the install and reboot.</p>
<p>Display your Public Key and Manually Transcribe:</p>
<pre><code class="language-bash">sudo age-keygen -y /mnt/root/.config/sops/age/keys.txt
</code></pre>
<p>Carefully read and manually type the <code>age1...</code> public key string into your
<code>.sops.yaml</code> file within your flake directory
(<code>/mnt/etc/nixos/my-flake/.sops.yaml</code>).</p>
<p>Example <code>.sops.yaml</code> (after editing):</p>
<pre><code class="language-yaml">keys:
  - &amp;personal_age_key age1yuvx83vtxr8rf6t8vmwjeymt9u83h4cwktnqvmn49rhy36chj3tqlgunhz # &lt;-- Your public key goes here
creation_rules:
  - path_regex: "secrets/.*\\.yaml$"
    key_groups:
      - age:
          - *personal_age_key
</code></pre>
<p>Add <code>.sops.yaml</code> to Git</p>
<pre><code class="language-bash">git add .sops.yaml
</code></pre>
<ul>
<li>
<p>Note: If you forget to add the <code>.sops.yaml</code> to Git, sops won't be able to
decrypt your secrets after reboot.</p>
<p>6.2. Generate SSH Key &amp; Add to SOPS</p>
</li>
<li>
<p>Generate your SSH key and save the private key to a temporary file:</p>
</li>
</ul>
<pre><code class="language-bash">ssh-keygen -t ed25519 -C "your_email@example.com" -f /tmp/ssh_key
</code></pre>
<ul>
<li>Encrypt the private key into <code>secrets/github-deploy-key.yaml</code> using SOPS:</li>
</ul>
<pre><code class="language-bash">sops secrets/github-deploy-key.yaml
</code></pre>
<p>Inside the editor (e.g., <code>helix</code>, <code>vim</code>, <code>nano</code>):</p>
<ol>
<li>
<p>Add the YAML key: <code>github_deploy_key_ed25519: |</code></p>
</li>
<li>
<p>Move your cursor to the line below, indented by 2 spaces.</p>
</li>
<li>
<p>To read the content from <code>/tmp/ssh_key</code>:</p>
</li>
</ol>
<ul>
<li>
<p>For vim: In Normal mode, type <code>:r /tmp/ssh_key</code> and press Enter.</p>
</li>
<li>
<p>For nano: Press <code>Ctrl+R</code>, type <code>/tmp/ssh_key</code>, and press Enter.</p>
</li>
</ul>
<ol start="4">
<li>Save and exit the editor.</li>
</ol>
<ul>
<li>Securely delete the temporary file:</li>
</ul>
<pre><code class="language-bash">shred -u /tmp/ssh_key
</code></pre>
<p>6.3. Add Hashed Password to SOPS</p>
<ul>
<li>Generate your hashed password for the user and save it to a temporary file:</li>
</ul>
<pre><code class="language-bash">mkpasswd -m SHA-512 -s &gt; /tmp/user_hashed_pass.txt
</code></pre>
<ul>
<li>Encrypt the hashed password into <code>secrets/password-hash.yaml</code> using SOPS:</li>
</ul>
<pre><code class="language-bash">sops secrets/password-hash.yaml
</code></pre>
<p>Inside the editor:</p>
<ol>
<li>
<p>Add the YAML key: password_hash:</p>
</li>
<li>
<p>Move your cursor to the end of that line (or the line below, if your editor
prefers).</p>
</li>
<li>
<p>To read the content from <code>/tmp/user_hashed_pass.txt</code>:</p>
</li>
</ol>
<ul>
<li>
<p>For vim: In Normal mode, type <code>:r /tmp/user_hashed_pass.txt</code> and press Enter.
(You may need to join the lines using Shift+J and add 2 spaces of indentation
if it pastes on a new line).</p>
</li>
<li>
<p>For nano: Press <code>Ctrl+R</code>, type <code>/tmp/user_hashed_pass.txt</code>, and press Enter.
Save and exit the editor.</p>
</li>
</ul>
<p>Securely delete the temporary file:</p>
<pre><code class="language-bash">shred -u /tmp/user_hashed_pass.txt
</code></pre>
<ol start="7">
<li>Configure SOPS in Nix (sops.nix)</li>
</ol>
<p>Ensure your <code>sops.nix</code> looks like this, adjusting <code>age.keyFile</code> to the new path
(which is on your root filesystem).</p>
<pre><code class="language-nix">{ config, ... }: { sops = { defaultSopsFile = ./sops.yaml; # If your host's SSH key is Ed25519 and you want SOPS to use it for decryption, # you can add:
age.sshKeyPaths = ["/etc/ssh/ssh_host_ed25519_key"];
age.keyFile = "/root/.config/sops/age/keys.txt"; # Crucial: This path is now on your installed system's root

    secrets = {
      "password_hash" = {
        sopsFile = ./secrets/password-hash.yaml;
        owner = "root";
        group = "root";
        mode = "0400";
        neededForUsers = true; # Ensures it's available for user creation/login
      };
      "github_deploy_key_ed25519" = {
        sopsFile = ./secrets/github-deploy-key.yaml;
        key = "github_deploy_key_ed25519"; # Specifies the key within the YAML file
        owner = "root";
        group = "root";
        mode = "0400";
      };
    };

}; }
</code></pre>
<ol start="8">
<li>Final Configuration &amp; Apply</li>
</ol>
<ul>
<li>Update <code>configuration.nix</code>: Review and update your <code>configuration.nix</code> with
your hostname, desired packages, services, etc.</li>
</ul>
<p>Final rebuild to apply all changes:</p>
<pre><code class="language-bash">sudo nixos-rebuild switch --flake .#your-hostname # Use . since you are in the flake directory
</code></pre>
<ol start="9">
<li>Install NixOS</li>
</ol>
<p>Execute the installation command:</p>
<pre><code class="language-bash">sudo nixos-install --flake /mnt/etc/nixos/my-flake#your-hostname
</code></pre>
<ul>
<li>You will be prompted to set a new password. This is for the root user on your
newly installed system.</li>
</ul>
<ol start="10">
<li>Post-Installation</li>
</ol>
<p>First Boot: After reboot, your system will pause to ask for your encryption
password (the LUKS passphrase you set during the Disko command in Step 5). Enter
it to proceed with booting. Move your flake to your user's home directory (if
desired) and fix permissions:</p>
<pre><code class="language-bash">sudo mv /etc/nixos/my-flake ~ sudo chown -R $USER:users ~/my-flake
</code></pre>
<p>Optional: It is possible to use sops to auto-decrypt your LUKS partition, but
this guide focuses on manual entry for enhanced security awareness at boot. If
you're interested, you could explore that option, but it negates some of the
benefits of manually entering your passphrase. I'm currently working on an
impermanence guide for this setup, which has presented some challenges. I'm open
to suggestions!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/impermanence.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../nix/sops-nix.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/impermanence.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../nix/sops-nix.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
