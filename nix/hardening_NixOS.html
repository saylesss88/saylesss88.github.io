<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hardening NixOS - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hardening-nixos"><a class="header" href="#hardening-nixos">Hardening NixOS</a></h1>
<details>
<summary> Click to Expand Table of Contents</summary>
<ul>
<li><a href="#minimal-installation-with-luks">Minimal Installation with LUKS</a></li>
<li><a href="#manual-encrypted-install-following-the-manual">Manual Encrypted Install Following the Manual</a></li>
<li><a href="#guided-encrypted-btrfs-subvol-install-using-disko">Guided Encrypted BTRFS Subvol install using disko</a></li>
<li><a href="#impermanence">Impermanence</a></li>
<li><a href="#secure-boot">Secure Boot</a>
<ul>
<li><a href="#the-kernel">The Kernel</a></li>
</ul>
</li>
<li><a href="#choosing-your-kernel">Choosing your Kernel</a>
<ul>
<li><a href="#the-hardened-kernel">The Hardened Kernel</a></li>
<li><a href="#sysctl">sysctl</a></li>
</ul>
</li>
<li><a href="#kernel-security-settings">Kernel Security Settings</a></li>
<li><a href="#further-hardening-with-sysctl">Further Hardening with sysctl</a></li>
<li><a href="#hardening-boot-parameters">Hardening Boot Parameters</a></li>
<li><a href="#hardening-systemd">Hardening Systemd</a></li>
<li><a href="#lynis-and-other-tools">Lynis and other tools</a></li>
<li><a href="#securing-ssh">Securing SSH</a></li>
<li><a href="#key-generation">Key generation</a>
<ul>
<li><a href="#ssh-keygen">ssh-keygen</a></li>
</ul>
</li>
<li><a href="#install-gnupg-and-gpg-agent-for-home-manager">Install GNUPG and gpg-agent for Home Manager</a></li>
<li><a href="#encrypt-a-file-with-pgp">Encrypt a File with PGP</a>
<ul>
<li><a href="#list-your-keys-and-get-the-key-id">List your keys and get the key ID</a></li>
<li><a href="#encrypt-a-file-for-yourself">Encrypt a file for yourself</a></li>
<li><a href="#openssh-server">OpenSSH Server</a></li>
</ul>
</li>
<li><a href="#encrypted-secrets">Encrypted Secrets</a>
<ul>
<li><a href="#sops-nix-guide">Sops-nix Guide</a></li>
</ul>
</li>
<li><a href="#auditd">Auditd</a></li>
<li><a href="#usb-port-protection">USB Port Protection</a></li>
<li><a href="#doas-over-sudo">Doas over sudo</a></li>
<li><a href="#firejail">Firejail</a></li>
<li><a href="#selinuxapparmor-mac-mandatory-access-control">SeLinux/AppArmor MAC (Mandatory Access Control)</a></li>
<li><a href="#resources">Resources</a>
<ul>
<li><a href="#advanced-hardening-with-nix-mineral-community-project">Advanced Hardening with <code>nix-mineral</code> (Community Project)</a></li>
</ul>
</li>
</ul>
</details>
<!-- ![guy fawks hacker](../images/guy_fawks.png) -->
<p>Securing your NixOS system begins with a philosophy of minimalism, explicit
configuration, and proactive control.</p>
<blockquote>
<p>⚠️ Warning: I am not a security expert. This guide presents various options
for hardening NixOS, but it is your responsibility to evaluate whether each
adjustment suits your specific needs and environment. Security hardening and
process isolation can introduce stability challenges, compatibility issues, or
unexpected behavior. Additionally, these protections often come with
performance tradeoffs. Always conduct thorough research, there are no plug and
play one size fits all security solutions.</p>
</blockquote>
<blockquote>
<p>That said, I typically write about what I'm implementing myself to deepen
understanding and share what works for me. <code>--Source</code> means the proceeding
paragraph came from <code>--Source</code>, you can often click to check for yourself. If
you use some common sense with a bit of caution you could end up with a more
secure NixOS system that fits your needs.</p>
</blockquote>
<blockquote>
<p>Much of this guide draws inspiration or recommendations from the well-known
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html">Linux Hardening Guide</a>
by Madaidan's Insecurities. Madaidan’s work is widely regarded in technical
and security circles as one of the most comprehensive and rigorously
researched sources on practical Linux security, frequently cited for its depth
and actionable advice. For example, much of the original basis for hardening
for <a href="https://github.com/cynicsketch/nix-mineral">nix-mineral</a> came from this
guide as well.</p>
</blockquote>
<blockquote>
<p>❗ <strong>Note on SELinux and AppArmor</strong>: While NixOS can provide a high degree of
security through its immutable and declarative nature, it's important to
understand the limitations regarding Mandatory Access Control (MAC)
frameworks. Neither SELinux nor AppArmor are fully supported or widely used in
the NixOS ecosystem. You can do a lot to secure NixOS but if anonymity and
isolation are paramount, I recommend booting into a
<a href="https://tails.net/">Tails USB stick</a>.</p>
</blockquote>
<p>☝️ The unique file structure of NixOS, particularly the immutable <code>/nix/store</code>,
makes it difficult to implement and manage the file-labeling mechanisms that
these frameworks rely on. There are ongoing community efforts to improve
support, but as of now, they are considered experimental and not a standard part
of a typical NixOS configuration.</p>
<p>Containers and VMs are beyond the scope of this chapter but can also enhance
security if configured correctly.</p>
<p>It's crucial to <strong>document every change</strong> you make. By creating smaller,
feature-complete commits, each with a descriptive message, you're building a
clear history. This approach makes it far simpler to revert a breaking change
and quickly identify what went wrong. Over time, this discipline allows you to
create security-focused checklists and ensure all angles are covered, building a
more robust and secure system.</p>
<p>Check out the
<a href="https://saylesss88.github.io/nix/index.html">Hardening NixOS Baseline Hardening README</a>
for baseline hardening recommendations and best practices.</p>
<h2 id="minimal-installation-with-luks"><a class="header" href="#minimal-installation-with-luks">Minimal Installation with LUKS</a></h2>
<p>Begin with NixOS’s minimal installation image. This gives you a base system with
only essential tools and no extras that could introduce vulnerabilities.</p>
<h2 id="manual-encrypted-install-following-the-manual"><a class="header" href="#manual-encrypted-install-following-the-manual">Manual Encrypted Install Following the Manual</a></h2>
<p>Encryption is the process of using an algorithm to scramble plaintext data into
ciphertext, making it unreadable except to a person who has the key to decrypt
it.</p>
<p><strong>Data at rest</strong> is data in storage, such as a computer's or a servers hard
disk.</p>
<p><strong>Data at rest encryption</strong> (typically hard disk encryption), secures the
documents, directories, and files behind an encryption key. Encrypting your data
at rest prevents data leakage, physical theft, unauthorized access, and more as
long as the key management scheme isn't compromised.</p>
<ul>
<li>
<p><a href="https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso">Minimal ISO Download (64-bit Intel/AMD)</a></p>
</li>
<li>
<p><a href="https://nixos.org/manual/nixos/stable/#sec-installation">NixOS Manual Installation</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Full_Disk_Encryption">NixOS Wiki Full Disk Encryption</a></p>
</li>
<li>
<p>The
<a href="https://www.nsa.gov/Press-Room/Press-Releases-Statements/Press-Release-View/Article/3498776/post-quantum-cryptography-cisa-nist-and-nsa-recommend-how-to-prepare-now/">NSA, CISA, and NIST warn</a>
that nation-state actors are likely stockpiling encrypted data now, preparing
for a future when quantum computers could break today’s most widely used
encryption algorithms. Sensitive data with long-term secrecy needs is
especially at risk.</p>
</li>
<li>
<p>This is a wake-up call to use the strongest encryption available today and to
plan early for post-quantum security.</p>
</li>
<li>
<p><a href="https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards">NIST First 3 Post-Quantum Encryption Standards</a>
Organizations and individuals should prepare to migrate cryptographic systems
to these new standards as soon as practical.</p>
</li>
<li>
<p>They chose
<a href="https://www.nist.gov/news-events/news/2022/07/nist-announces-first-four-quantum-resistant-cryptographic-algorithms">Four Quantum-Resistant Cryptographic Algorithms</a>
warning that public-key cryptography is especially vulnerable and widely used
to protect digital information.</p>
</li>
</ul>
<h2 id="guided-encrypted-btrfs-subvol-install-using-disko"><a class="header" href="#guided-encrypted-btrfs-subvol-install-using-disko">Guided Encrypted BTRFS Subvol install using disko</a></h2>
<p>Use LUKS encryption to protect your data at rest, the following guide is a
minimal disko encrypted installation:
<a href="https://saylesss88.github.io/installation/enc/enc_install.html">Encrypted Install</a></p>
<h2 id="impermanence"><a class="header" href="#impermanence">Impermanence</a></h2>
<p>Impermanence, especially when using a <code>tmpfs</code> as the root filesystem, provides
several significant security benefits. The core principle is that impermanence
defeats persistence, a fundamental goal for any attacker.</p>
<p>When you use a root-as-tmpfs setup on NixOS, the boot process loads the entire
operating system from the read-only Nix store into a <code>tmpfs</code> in RAM. The mutable
directories, such as <code>/etc</code> and <code>/var</code>, are then created on this RAM disk. When
the system is shut down, the <code>tmpfs</code> is wiped, leaving the on-disk storage
untouched and secure.</p>
<p>This means you get a fresh, secure boot every time, making it much harder for an
attacker to maintain a presence on your system.</p>
<ul>
<li>
<p><a href="https://grahamc.com/blog/erase-your-darlings/">Erase your Darlings (ZFS)</a></p>
</li>
<li>
<p><a href="https://saylesss88.github.io/installation/enc/encrypted_impermanence.html">Encrypted BTRFS Impermanence Guide</a>
Only follow this guide if you also followed the encrypted disko install,
impermanence is designed to be destructive and needs to match your config
exactly.</p>
</li>
</ul>
<h2 id="secure-boot"><a class="header" href="#secure-boot">Secure Boot</a></h2>
<!-- ![Virus](../images/virus1.png) -->
<p>Enable a UEFI password or Administrator password where it requires
authentication in order to access the UEFI/BIOS.</p>
<p>Secure Boot helps ensure only signed, trusted kernels and bootloaders are
executed at startup.</p>
<p>Useful Resources:</p>
<details>
<summary> ✔️ Click to Expand Secure Boot Resources </summary>
<ul>
<li>
<p><a href="https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html">The Strange State of Authenticated Boot and Encryption</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Secure_Boot">NixOS Wiki Secure Boot</a></p>
</li>
<li>
<p><a href="https://github.com/nix-community/lanzaboote">lanzaboote repo</a></p>
</li>
</ul>
</details>
<p>Practical Lanzaboote Secure Boot setup for NixOS:
<a href="https://saylesss88.github.io/installation/enc/lanzaboote.html">Guide:Secure Boot on NixOS with Lanzaboote</a></p>
<h3 id="the-kernel"><a class="header" href="#the-kernel">The Kernel</a></h3>
<p>Given the kernel's central role, it's a frequent target for malicious actors,
making robust hardening essential.</p>
<p>NixOS provides a <code>hardened</code> profile that applies a set of security-focused
kernel and system configurations.</p>
<p>For flakes, you could do something like the following in your
<code>configuration.nix</code> or equivalent to import <code>hardened.nix</code> and enable
<code>profiles.hardened</code>:</p>
<pre><code class="language-nix"># configuration.nix
{ pkgs, inputs, ... }: let
   modulesPath = "${inputs.nixpkgs}/nixos/modules";

in {
  imports = [ "${modulesPath}/profiles/hardened.nix" ];

}
</code></pre>
<ul>
<li>
<p>There is a proposal to remove it completely that has gained ground, the
following thread discusses why:
<a href="https://discourse.nixos.org/t/proposal-to-deprecate-the-hardened-profile/63081">Discourse Thread</a></p>
</li>
<li>
<p><a href="https://github.com/NixOS/nixpkgs/pull/383438">PR #383438</a> Proposed removal
PR.</p>
</li>
<li>
<p>Check
<a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/profiles/hardened.nix">hardened.nix</a>
to see exactly what adding it enables to avoid duplicates and conflicts moving
on. I included this for completeness, the choice is yours if you want to use
it or not.</p>
</li>
</ul>
<h2 id="choosing-your-kernel"><a class="header" href="#choosing-your-kernel">Choosing your Kernel</a></h2>
<p>See which kernel you're currently using with:</p>
<pre><code class="language-bash"># show the kernel release
uname -r
# show kernel version, hostname, and architecture
uname -a
</code></pre>
<p>Show the configuration of your current kernel:</p>
<pre><code class="language-bash">zcat /proc/config.gz
# ...snip...
#
# Compression
#
CONFIG_CRYPTO_DEFLATE=m
CONFIG_CRYPTO_LZO=y
CONFIG_CRYPTO_842=m
CONFIG_CRYPTO_LZ4=m
CONFIG_CRYPTO_LZ4HC=m
CONFIG_CRYPTO_ZSTD=y
# end of Compression
# ...snip...
</code></pre>
<p>The <a href="https://nixos.org/manual/nixos/stable/#sec-kernel-config">NixOS Manual</a>
states that the default Linux kernel configuration should be fine for most
users.</p>
<p>The Linux kernel is typically released under two forms: stable and long-term
support (LTS). Choosing either has consequences, do your research.
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#stable-vs-lts">Stable vs. LTS kernels</a></p>
<ul>
<li><a href="https://www.kernel.org/category/releases.html">The Linux Kernel Archives Active kernel releases</a></li>
</ul>
<p><strong>OR</strong>, you can choose the hardened kernel for a kernel that prioritizes
security over everything else.</p>
<h3 id="the-hardened-kernel"><a class="header" href="#the-hardened-kernel">The Hardened Kernel</a></h3>
<p>The <code>linuxPackages_latest_hardened</code> attribute has been deprecated. If you want
to use a hardened kernel, you must specify a versioned package that is currently
supported.</p>
<p>You can find the latest available hardened kernel packages by searching
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/linux-kernels.nix">pkgs/top-level/linux-kernels.nix</a></p>
<p>For example, to use the latest available <code>6.12</code>, you would configure it like
this:</p>
<pre><code class="language-nix">boot.kernelPackages = pkgs.linux_6_12_hardened;
</code></pre>
<p>Note that this not only replaces the kernel, but also packages that are specific
to the kernel version, such as NVIDIA video drivers.</p>
<ul>
<li>If you decide to use this, read further before rebuilding.</li>
</ul>
<p>You can inspect
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/os-specific/linux/kernel/hardened/patches.json">nixpkgs/pkgs/os-specific/linux/kernel/hardened/patches.json</a>
to see the metadata of the patches that are applied. You can then follow the
links in the <code>.json</code> file to see the patch diffs.</p>
<blockquote>
<p>❗ NOTE: Always check the <code>linux-kernels.nix</code> file for the latest available
versions, as older kernels are regularly removed from Nixpkgs.</p>
</blockquote>
<h3 id="sysctl"><a class="header" href="#sysctl">sysctl</a></h3>
<p>A tool for checking the security hardening options of the Linux kernel:</p>
<pre><code class="language-nix">environment.systemPackages = [ pkgs.kernel-hardening-checker ];
</code></pre>
<p><code>sysctl</code> is a tool that allows you to view or modify kernel settings and
enable/disable different features.</p>
<p>Check all <code>sysctl</code> parameters against the <code>kernel-hardening-checker</code>
recommendations:</p>
<pre><code class="language-bash">sudo sysctl -a &gt; params.txt
kernel-hardening-checker -l /proc/cmdline -c /proc/config.gz -s ./params.txt
</code></pre>
<p>Check the value of a specific parameter:</p>
<pre><code class="language-bash">sudo sysctl -a | grep "kernel.kptr_restrict"
# Output:
kernel.kptr_restrict = 2
</code></pre>
<p>Check Active Linux Security Modules:</p>
<pre><code class="language-bash">cat /sys/kernel/security/lsm
# Output:
File: /sys/kernel/security/lsm
capability,landlock,yama,bpf,apparmor
</code></pre>
<p>Check Kernel Configuration Options:</p>
<pre><code class="language-bash">zcat /proc/config.gz | grep CONFIG_SECURITY_SELINUX
zcat /proc/config.gz | grep CONFIG_HARDENED_USERCOPY
zcat /proc/config.gz | grep CONFIG_STACKPROTECTOR
</code></pre>
<p>Since it is difficult to see exactly what enabling the hardened_kernel does.
Before rebuilding, you could do something like this to see exactly what is
added:</p>
<pre><code class="language-bash">sudo sysctl -a &gt; before.txt
</code></pre>
<p>And after the rebuild:</p>
<pre><code class="language-bash">sudo sysctl -a &gt; after.txt
</code></pre>
<p>And finally run a <code>diff</code> on them:</p>
<pre><code class="language-bash">diff before.txt after.txt
</code></pre>
<p>You can also diff against <code>after.txt</code> for future changes to avoid duplicates,
this seems easier to me than trying to parse through the patches.</p>
<h2 id="kernel-security-settings"><a class="header" href="#kernel-security-settings">Kernel Security Settings</a></h2>
<pre><code class="language-nix">security = {
      protectKernelImage = true;
      lockKernelModules = false; # this breaks iptables, wireguard, and virtd

      # force-enable the Page Table Isolation (PTI) Linux kernel feature
      forcePageTableIsolation = true;

      # User namespaces are required for sandboxing.
      # this means you cannot set `"user.max_user_namespaces" = 0;` in sysctl
      allowUserNamespaces = true;

      # Disable unprivileged user namespaces, unless containers are enabled
      unprivilegedUsernsClone = config.virtualisation.containers.enable;
      allowSimultaneousMultithreading = true;
}
</code></pre>
<h2 id="further-hardening-with-sysctl"><a class="header" href="#further-hardening-with-sysctl">Further Hardening with sysctl</a></h2>
<p><code>sysctl</code> hardening settings further reinforce kernel-level protections. The
hardened kernel includes security patches and stricter defaults, but it doesn't
cover all runtime tunables. Refer to the above commands to get a diff of the
changes.</p>
<p><a href="https://nixos.org/manual/nixos/stable/options#opt-boot.kernel.sysctl">boot.kernel.sysctl</a>:
Runtime parameters of the Linux kernel, as set by sysctl(8). Note that the
sysctl parameters names must be enclosed in quotes. Values may be a string,
integer, boolean, or null.</p>
<p>Check what each setting does <a href="https://sysctl-explorer.net/">sysctl-explorer</a></p>
<p>Refer to
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#sysctl-kernel">madadaidans-insecurities#sysctl-kernel</a>
for the following settings and their explainations.</p>
<pre><code class="language-nix">  boot.kernel.sysctl = {
    "fs.suid_dumpable" = 0;
    # prevent pointer leaks
    "kernel.kptr_restrict" = 2;
    # restrict kernel log to CAP_SYSLOG capability
    "kernel.dmesg_restrict" = 1;
    # Note: certian container runtimes or browser sandboxes might rely on the following
    # restrict eBPF to the CAP_BPF capability
    "kernel.unprivileged_bpf_disabled" = 1;
    # should be enabled along with bpf above
    # "net.core.bpf_jit_harden" = 2;
    # restrict loading TTY line disciplines to the CAP_SYS_MODULE
    "dev.tty.ldisk_autoload" = 0;
    # prevent exploit of use-after-free flaws
    "vm.unprivileged_userfaultfd" = 0;
    # kexec is used to boot another kernel during runtime and can be abused
    "kernel.kexec_load_disabled" = 1;
    # Kernel self-protection
    # SysRq exposes a lot of potentially dangerous debugging functionality to unprivileged users
    # 4 makes it so a user can only use the secure attention key. A value of 0 would disable completely
    "kernel.sysrq" = 4;
    # disable unprivileged user namespaces, Note: Docker, NH, and other apps may need this
    # "kernel.unprivileged_userns_clone" = 0; # commented out because it makes NH and other programs fail
    # restrict all usage of performance events to the CAP_PERFMON capability
    "kernel.perf_event_paranoid" = 3;

    # Network
    # protect against SYN flood attacks (denial of service attack)
    "net.ipv4.tcp_syncookies" = 1;
    # protection against TIME-WAIT assassination
    "net.ipv4.tcp_rfc1337" = 1;
    # enable source validation of packets received (prevents IP spoofing)
    "net.ipv4.conf.default.rp_filter" = 1;
    "net.ipv4.conf.all.rp_filter" = 1;

    "net.ipv4.conf.all.accept_redirects" = 0;
    "net.ipv4.conf.default.accept_redirects" = 0;
    "net.ipv4.conf.all.secure_redirects" = 0;
    "net.ipv4.conf.default.secure_redirects" = 0;
    # Protect against IP spoofing
    "net.ipv6.conf.all.accept_redirects" = 0;
    "net.ipv6.conf.default.accept_redirects" = 0;
    "net.ipv4.conf.all.send_redirects" = 0;
    "net.ipv4.conf.default.send_redirects" = 0;

    # prevent man-in-the-middle attacks
    "net.ipv4.icmp_echo_ignore_all" = 1;

    # ignore ICMP request, helps avoid Smurf attacks
    "net.ipv4.conf.all.forwarding" = 0;
    "net.ipv4.conf.default.accept_source_route" = 0;
    "net.ipv4.conf.all.accept_source_route" = 0;
    "net.ipv6.conf.all.accept_source_route" = 0;
    "net.ipv6.conf.default.accept_source_route" = 0;
    # Reverse path filtering causes the kernel to do source validation of
    "net.ipv6.conf.all.forwarding" = 0;
    "net.ipv6.conf.all.accept_ra" = 0;
    "net.ipv6.conf.default.accept_ra" = 0;

    ## TCP hardening
    # Prevent bogus ICMP errors from filling up logs.
    "net.ipv4.icmp_ignore_bogus_error_responses" = 1;

    # Disable TCP SACK
    "net.ipv4.tcp_sack" = 0;
    "net.ipv4.tcp_dsack" = 0;
    "net.ipv4.tcp_fack" = 0;

    # Userspace
    # restrict usage of ptrace
    "kernel.yama.ptrace_scope" = 2;

    # ASLR memory protection (64-bit systems)
    "vm.mmap_rnd_bits" = 32;
    "vm.mmap_rnd_compat_bits" = 16;

    # only permit symlinks to be followed when outside of a world-writable sticky directory
    "fs.protected_symlinks" = 1;
    "fs.protected_hardlinks" = 1;
    # Prevent creating files in potentially attacker-controlled environments
    "fs.protected_fifos" = 2;
    "fs.protected_regular" = 2;

    # Randomize memory
    "kernel.randomize_va_space" = 2;
    # Exec Shield (Stack protection)
    "kernel.exec-shield" = 1;

    ## TCP optimization
    # TCP Fast Open is a TCP extension that reduces network latency by packing
    # data in the sender’s initial TCP SYN. Setting 3 = enable TCP Fast Open for
    # both incoming and outgoing connections:
    "net.ipv4.tcp_fastopen" = 3;
    # Bufferbloat mitigations + slight improvement in throughput &amp; latency
    "net.ipv4.tcp_congestion_control" = "bbr";
    "net.core.default_qdisc" = "cake";
  };
</code></pre>
<blockquote>
<p>❗ Note: The above settings are fairly aggressive and can break common
programs, read the comment warnings.</p>
</blockquote>
<h2 id="hardening-boot-parameters"><a class="header" href="#hardening-boot-parameters">Hardening Boot Parameters</a></h2>
<p><code>boot.kernelParams</code> can be used to set additional kernel command line arguments
at boot time. It can only be used for built-in modules.</p>
<p>You can find the following settings in the above guide in the
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#boot-parameters">Boot parameters section</a></p>
<pre><code class="language-nix"># boot.nix
      boot.kernelParams = [
        # make it harder to influence slab cache layout
        "slab_nomerge"
        # enables zeroing of memory during allocation and free time
        # helps mitigate use-after-free vulnerabilaties
        "init_on_alloc=1"
        "init_on_free=1"
        # randomizes page allocator freelist, improving security by
        # making page allocations less predictable
        "page_alloc.shuffel=1"
        # enables Kernel Page Table Isolation, which mitigates Meltdown and
        # prevents some KASLR bypasses
        "pti=on"
        # randomizes the kernel stack offset on each syscall
        # making attacks that rely on a deterministic stack layout difficult
        "randomize_kstack_offset=on"
        # disables vsyscalls, they've been replaced with vDSO
        "vsyscall=none"
        # disables debugfs, which exposes sensitive info about the kernel
        "debugfs=off"
        # certain exploits cause an "oops", this makes the kernel panic if an "oops" occurs
        "oops=panic"
        # only alows kernel modules that have been signed with a valid key to be loaded
        # making it harder to load malicious kernel modules
        # can make VirtualBox or Nvidia drivers unusable
        "module.sig_enforce=1"
        # prevents user space code excalation
        "lockdown=confidentiality"
        # "rd.udev.log_level=3"
        # "udev.log_priority=3"
      ];
</code></pre>
<p>This is a thoughtful start to hardening boot parameters, there are more
recommendations in the guide.</p>
<p>Kernel modules for hardware devices are generally loaded automatically by
<code>udev</code>. You can force a module to be loaded via <code>boot.kernelModules</code>.</p>
<p><a href="https://nixos.org/manual/nixos/stable/options#opt-boot.blacklistedKernelModules">boot.blacklistedKernelModules</a>:
List of names of kernel modules that should not be loaded automatically by the
hardware probing code.</p>
<p>You can find the following settings in the
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#kasr-kernel-modules">Blacklisting Kernel Modules Section</a></p>
<pre><code class="language-nix">      boot.blacklistedKernelModules = [
        # Obscure networking protocols
        "dccp"   # Datagram Congestion Control Protocol
        "sctp"  # Stream Control Transmission Protocol
        "rds"  # Reliable Datagram Sockets
        "tipc"  # Transparent Inter-Process Communication
        "n-hdlc" # High-level Data Link Control
        "ax25"  # Amateur X.25
        "netrom"  # NetRom
        "x25"     # X.25
        "rose"
        "decnet"
        "econet"
        "af_802154"  # IEEE 802.15.4
        "ipx"  # Internetwork Packet Exchange
        "appletalk"
        "psnap"  # SubnetworkAccess Protocol
        "p8023"  # Novell raw IEE 802.3
        "p8022"  # IEE 802.3
        "can"   # Controller Area Network
        "atm"
        # Various rare filesystems
        "cramfs"
        "freevxfs"
        "jffs2"
        "hfs"
        "hfsplus"
        "udf"

        # "squashfs"  # compressed read-only file system used for Live CDs
        # "cifs"  # cmb (Common Internet File System)
        # "nfs"  # Network File System
        # "nfsv3"
        # "nfsv4"
        # "ksmbd"  # SMB3 Kernel Server
        # "gfs2"  # Global File System 2
        # vivid driver is only useful for testing purposes and has been the
        # cause of privilege escalation vulnerabilities
        # "vivid"
      ];
</code></pre>
<p>As with the <code>kernelParameters</code> above, there are more suggestions in the guide, I
have used the above parameters along with the commented out ones and had no
issues.</p>
<h2 id="hardening-systemd"><a class="header" href="#hardening-systemd">Hardening Systemd</a></h2>
<!-- ![Hacker](../images/hacker.png) -->
<p><code>systemd</code> is the core "init system" and service manager that controls how
services, daemons, and basic system processes are started, stopped and
supervised on modern Linux distributions, including NixOS. It provides a suite
of basic building blocks for a Linux system as well as a system and service
manager that runs as <code>PID 1</code> and starts the rest of the system.</p>
<p>Because it launches and supervises almost all system services, hardening systemd
means raising the baseline security of your entire system.</p>
<p><code>dbus-broker</code> is generally considered more secure and robust but isn't the
default as of yet. To set <code>dbus-broker</code> as the default:</p>
<pre><code class="language-nix">  users.groups.netdev = {};
  services = {
    dbus.implementation = "broker";
    logrotate.enable = true;
    journald = {
      storage = "volatile"; # Store logs in memory
      upload.enable = false; # Disable remote log upload (the default)
      extraConfig = ''
        SystemMaxUse=500M
        SystemMaxFileSize=50M
      '';
    };
  };
</code></pre>
<ul>
<li>
<p><code>dbus-broker</code> is more resilient to resource exhaustion attacks and integrates
better with Linux security features.</p>
</li>
<li>
<p>Setting <code>storage = "volatile"</code> tells journald to keep log data only in memory.
There is a tradeoff though, If you need long-term auditing or troubleshooting
after a reboot, this will not preserve system logs.</p>
</li>
<li>
<p><code>upload.enable</code> is for forwarding log messages to remote servers, setting this
to false prevents accidental leaks of potentially sensitive or internal system
information.</p>
</li>
<li>
<p>Enabling <code>logrotate</code> prevents your disk from filling with excessive
<strong>legacy/service</strong> log files. These are the classic plain-text logs.</p>
</li>
<li>
<p>Systemd uses <code>journald</code> which stores logs in a binary format</p>
</li>
</ul>
<p>You can check the security status with:</p>
<pre><code class="language-bash">systemd-analyze security
# or for a detailed view of individual services security posture
systemd-analyze security NetworkManager
</code></pre>
<p>Further reading on systemd:</p>
<details>
<summary> ✔️ Click to Expand Systemd Resources </summary>
<ul>
<li>
<p><a href="https://systemd.io/">systemd.io</a></p>
</li>
<li>
<p><a href="https://0pointer.de/blog/projects/systemd.html">Rethinking PID 1</a></p>
</li>
<li>
<p><a href="https://0pointer.de/blog/projects/the-biggest-myths.html">Biggest Myths about Systemd</a></p>
</li>
</ul>
</details>
<p>The following is a repo containing many of the Systemd hardening settings in
NixOS format:</p>
<p><a href="https://github.com/wallago/nix-system-services-hardened">nix-system-services-hardened</a></p>
<p>For example, to harden bluetooth you could add the following to your
<code>configuration.nix</code> or equivalent:</p>
<pre><code class="language-nix">systemd.services = {
      bluetooth.serviceConfig = {
      ProtectKernelTunables = lib.mkDefault true;
      ProtectKernelModules = lib.mkDefault true;
      ProtectKernelLogs = lib.mkDefault true;
      ProtectHostname = true;
      ProtectControlGroups = true;
      ProtectProc = "invisible";
      SystemCallFilter = [
        "~@obsolete"
        "~@cpu-emulation"
        "~@swap"
        "~@reboot"
        "~@mount"
      ];
      SystemCallArchitectures = "native";
    };
}
</code></pre>
<p>As you can see from above, you typically use the <code>serviceConfig</code> attribute to
harden settings for systemd services.</p>
<pre><code class="language-bash">systemd-analyze security bluetooth
→ Overall exposure level for bluetooth.service: 3.3 OK 🙂
</code></pre>
<h2 id="lynis-and-other-tools"><a class="header" href="#lynis-and-other-tools">Lynis and other tools</a></h2>
<p>Lynis is a security auditing tool for systems based on UNIX like Linux, macOS,
BSD, and others.--<a href="https://github.com/CISOfy/lynis">lynis repo</a></p>
<p>Installation:</p>
<pre><code class="language-nix">environment.systemPackages = [
pkgs.lynis
pkgs.chkrootkit
pkgs.clamav
pkgs.aide
 ];
</code></pre>
<details>
<summary> ✔️ Click to Expand clamav.nix Example </summary>
<pre><code class="language-nix">{pkgs, ...}: {
  environment.systemPackages = with pkgs; [
    clamav
  ];
  services.clamav = {
    # Enable clamd daemon
    daemon.enable = true;
    updater.enable = true;
    updater.frequency = 12; # Number of database checks per day
    scanner = {
      enable = true;
      # 4:00 AM
      interval = "*-*-* 04:00:00";
      scanDirectories = [
        "/home"
        "/var/lib"
        "/tmp"
        "/etc"
        "/var/tmp"
      ];
    };
  };
}
</code></pre>
</details>
<p>Lynis Usage:</p>
<pre><code class="language-bash">sudo lynis show commands
# Output:
Commands:
lynis audit
lynis configure
lynis generate
lynis show
lynis update
lynis upload-only

sudo lynis audit system
# Output:
  Lynis security scan details:

  Hardening index : 79 [###############     ]
  Tests performed : 234
  Plugins enabled : 0

  Components:
  - Firewall               [V]
  - Malware scanner        [V]

  Scan mode:
  Normal [V]  Forensics [ ]  Integration [ ]  Pentest [ ]

  Lynis modules:
  - Compliance status      [?]
  - Security audit         [V]
  - Vulnerability scan     [V]
</code></pre>
<ul>
<li>
<p>The "Lynis hardening index" is an overall impression on how well a system is
hardened. However, this is just an indicator on measures taken - not a
percentage of how safe a system might be. A score over 75 typically indicates
a system with more than average safety measures implemented.</p>
</li>
<li>
<p>Lynis will give you more recommendations for securing your system as well.</p>
</li>
</ul>
<p>If you use <code>clamscan</code>, create the following log file:</p>
<pre><code class="language-bash">sudo touch /var/log/clamscan.log
</code></pre>
<p>Example cron job for <code>chkrootkit</code> &amp; <code>clamav</code>:</p>
<pre><code class="language-nix">{pkgs, ...}: {
  services.cron = {
    enable = true;
    # messages.enable = true;
    systemCronJobs = [
      # Every Sunday at 2:10 AM, run chkrootkit as root, log output for review
      "10 2 * * 0 root ${pkgs.chkrootkit}/bin/chkrootkit | logger -t chkrootkit"
      # Every day at 2:00 AM, run clamscan as root and append output to a log file
      "0 2 * * * root ${pkgs.clamav}/bin/clamscan -r /home &gt;&gt; /var/log/clamscan.log"
    ];
  };
}
</code></pre>
<p>The above cron job will use <code>chkrootkit</code> to automatically scan for known rootkit
signatures. It can detect hidden processes and network connections.</p>
<p>ClamAV usage:</p>
<p>You can run <code>clamav</code> manually with:</p>
<pre><code class="language-bash"># Recursive Scan:
clamscan -r ~/home
</code></pre>
<blockquote>
<p>❗ NOTE: You only need either the individual <code>pkgs.clamav</code> with the cron job
<strong>OR</strong> the <code>clamd-daemon</code> module. When testing, I was unable to get
<code>clamdscan</code> to work properly with <strong>Permission denied</strong> errors. You may have
better luck so I included both ways, the <code>clamscan -r ~/home</code> command was
successful although lengthy.</p>
</blockquote>
<h2 id="securing-ssh"><a class="header" href="#securing-ssh">Securing SSH</a></h2>
<blockquote>
<p><strong>Security information</strong>: Changing SSH configuration settings can
significantly impact the security of your system(s). It is crucial to have a
solid understanding of what you are doing before making any adjustments. Avoid
blindly copying and pasting examples, including those from this Wiki page,
without conducting a thorough analysis. Failure to do so may compromise the
security of your system(s) and lead to potential vulnerabilities. Take the
time to comprehend the implications of your actions and ensure that any
changes made are done thoughtfully and with care. --NixOS Wiki</p>
</blockquote>
<blockquote>
<p>❗ NOTE: I am going to show two approaches for SSH authentication. You should
typically choose <strong>one</strong>:</p>
</blockquote>
<ol>
<li>Use normal SSH keys generated with <code>ssh-keygen</code>, this is recommended unless
you have a good reason for not using it.</li>
</ol>
<p><strong>OR</strong></p>
<ol start="2">
<li>Use a GPG key with <code>gpg-agent</code> (which acts as your SSH agent). Complex, and
harder to understand in my opinion.</li>
</ol>
<p>My setup caused conflicts when enabling <code>programs.ssh.startAgent</code> so I chose
<code>gpg-agent</code> personally.</p>
<p>There are situations where you are required to use one or the other like for
headless CI/CD environments, <code>ssh-keygen</code> is required.</p>
<p>Further reading:</p>
<details>
<summary> ✔️ Click to Expand Resourses on OpenSSH </summary>
<ul>
<li>
<p><a href="https://wiki.archlinux.org/title/OpenSSH">Arch Wiki OpenSSH</a></p>
</li>
<li>
<p><a href="https://wiki.gentoo.org/wiki/GnuPG">Gentoo GnuPG</a></p>
</li>
<li>
<p><a href="https://rgoulter.com/blog/posts/programming/2022-06-10-a-visual-explanation-of-gpg-subkeys.html">A Visual Explanation of GPG Subkeys</a></p>
</li>
<li>
<p><a href="https://blog.stribik.technology/2015/01/04/secure-secure-shell.html">Secure Secure Shell</a></p>
</li>
</ul>
</details>
<h2 id="key-generation"><a class="header" href="#key-generation">Key generation</a></h2>
<h3 id="ssh-keygen"><a class="header" href="#ssh-keygen">ssh-keygen</a></h3>
<p>The <code>ed25519</code> algorithm is significantly faster and more secure when compared to
<code>RSA</code>. You can also specify the key derivation function (KDF) rounds to
strengthen protection even more.</p>
<p>For example, to generate a strong key for MdBook:</p>
<pre><code class="language-bash">ssh-keygen -t ed25519 -a 32 -f ~/.ssh/id_ed25519_github_$(date +%Y-%m-%d) -C "SSH Key for MdBook"
</code></pre>
<ul>
<li>
<p><code>-t</code> is for type</p>
</li>
<li>
<p><code>-a 32</code> sets the number of KDF rounds. The standard is usually good enough,
adding extra rounds can make it harder to brute-force.</p>
</li>
<li>
<p><code>-f</code> is for filename</p>
</li>
</ul>
<p><strong>OR</strong></p>
<h2 id="install-gnupg-and-gpg-agent-for-home-manager"><a class="header" href="#install-gnupg-and-gpg-agent-for-home-manager">Install GNUPG and gpg-agent for Home Manager</a></h2>
<details>
<summary> ✔️ Click to expand PGP installation and key generation example </summary>
<p><strong>PGP (Pretty Good Privacy)</strong> and <strong>GPG (GNU Privacy Guard)</strong>. While distinct,
they are deeply interconnected and, for the rest of this section, I'll use the
terms interchangeably.</p>
<p><strong>PGP</strong> was the original, groundbreaking software that brought robust public-key
cryptography to the masses. It set the standard for secure email communication.
However, PGP later became a commercial product.</p>
<p>To provide a free and open-source alternative that anyone could use and inspect,
<strong>GPG</strong> was created. Crucially, <strong>GPG</strong> is a complete implementation of the
OpenPGP standard. This open standard acts as a universal language for encryption
and digital signatures.</p>
<p><strong>What’s safe to share?</strong></p>
<ul>
<li>
<p>Your public key (used to encrypt files and verify signatures)</p>
</li>
<li>
<p>Your key ID (identifies your key, useful for sharing public keys or configs)</p>
</li>
</ul>
<p><strong>What must never be shared?</strong></p>
<ul>
<li>
<p>Your private (secret) key, usually in your <code>~/.gnupg/private-keys-v1.d/</code>
directory.</p>
</li>
<li>
<p>Your passphrase for your private key.</p>
</li>
</ul>
<p>Home Manager module with <code>gpg-agent</code>, <code>gnupg</code>, and <code>pinentry-gnome3</code>:</p>
<pre><code class="language-nix"># gpg-agent.nix
{
  config,
  lib,
  pkgs,
  ...
}: {
  options = {
    custom.pgp = {
      enable = lib.mkEnableOption {
        description = "Enable PGP Gnupgp";
        default = false;
      };
    };
  };

  config = lib.mkIf config.custom.pgp.enable {
    services = {
      ## Enable gpg-agent with ssh support
      gpg-agent = {
        enable = true;
        enableSshSupport = true;
        enableZshIntegration = true;
        pinentryPackage = pkgs.pinentry-gnome3;
      };

      ## We will put our keygrip here
      gpg-agent.sshKeys = [];
    };
    home.packages = [pkgs.gnupg];
    programs = {
      gpg = {
        ## Enable GnuPG
        enable = true;

        # homedir = "/home/userName/.config/gnupg";
        settings = {
          # Default/trusted key ID (helpful with throw-keyids)
          # Example, you will put your own keyid here
          default-key = "0x37ACBCDA569C5C44788";
          trusted-key = "0x37ACBCDA569C5C44788";
          # https://github.com/drduh/config/blob/master/gpg.conf
          # https://www.gnupg.org/documentation/manuals/gnupg/GPG-Configuration-Options.html
          # https://www.gnupg.org/documentation/manuals/gnupg/GPG-Esoteric-Options.html
          # Some Best Practices, stronger algos etc
          # Use AES256, 192, or 128 as cipher
          personal-cipher-preferences = "AES256 AES192 AES";
          # Use SHA512, 384, or 256 as digest
          personal-digest-preferences = "SHA512 SHA384 SHA256";
          # Use ZLIB, BZIP2, ZIP, or no compression
          personal-compress-preferences = "ZLIB BZIP2 ZIP Uncompressed";
          # Default preferences for new keys
          default-preference-list = "SHA512 SHA384 SHA256 AES256 AES192 AES ZLIB BZIP2 ZIP Uncompressed";
          # SHA512 as digest to sign keys
          cert-digest-algo = "SHA512";
          # SHA512 as digest for symmetric ops
          s2k-digest-algo = "SHA512";
          # AES256 as cipher for symmetric ops
          s2k-cipher-algo = "AES256";
          # UTF-8 support for compatibility
          charset = "utf-8";
          # Show Unix timestamps
          fixed-list-mode = "";
          # No comments in signature
          no-comments = "";
          # No version in signature
          no-emit-version = "";
          # Disable banner
          no-greeting = "";
          # Long hexidecimal key format
          keyid-format = "0xlong";
          # Display UID validity
          list-options = "show-uid-validity";
          verify-options = "show-uid-validity";
          # Display all keys and their fingerprints
          with-fingerprint = "";
          # Cross-certify subkeys are present and valid
          require-cross-certification = "";
          # Disable caching of passphrase for symmetrical ops
          no-symkey-cache = "";
          # Enable smartcard
          use-agent = "";
        };
      };
    };
  };
}
</code></pre>
<ul>
<li>
<p>The default path is <code>~/.gnupg</code>, if you prefer placing it in the <code>~/.config</code>
directory or elsewhere, uncomment the <code>homedir</code> line and change <code>userName</code> to
your username.</p>
</li>
<li>
<p>I use hyprland so <code>pinentry-gnome3</code> works for me, there is also the following
options for this attribute:</p>
</li>
<li>
<p><code>pinentry-tty</code></p>
</li>
<li>
<p><code>pinentry-qt</code></p>
</li>
<li>
<p><code>pinentry-gtk2</code></p>
</li>
</ul>
<p>And more, research what you need and use the correct one.</p>
<p>Enable in your <code>home.nix</code> or equivalent:</p>
<pre><code class="language-nix"># home.nix
# ... snip ...
imports = [
    ./gpg-agent.nix
];
custom.pgp.enable = true;
# ... snip ...
</code></pre>
<p><code>gpg --full-generate-key</code> can be used to generate a basic keypair, adding
<code>--expert</code> gives more options and capabilities needed for <code>gpg-agent</code>.</p>
<p>To generate a pgp key you can do the following:</p>
<pre><code class="language-bash">gpg --expert --full-generate-key
</code></pre>
<ul>
<li>
<p>Choose the default (11) ECC (set your own capabilities)</p>
</li>
<li>
<p>Choose <code>A</code> for Authenticate capabilities, which is the only setting required
for this. Additional subkeys may be created for encryption, sign, and/or
authentication capabilities.</p>
</li>
<li>
<p>Choose (1) Default Curve 25519</p>
</li>
<li>
<p>Give it a name and description</p>
</li>
<li>
<p>Give it an expiration date, 1y is common</p>
</li>
<li>
<p>Use a strong passphrase or password</p>
</li>
</ul>
<p>If you see a warning about incorrect permissions, you can run the following:</p>
<pre><code class="language-bash">chmod 700 ~/.gnupg
chmod 600 ~/.gnupg/*
</code></pre>
<p>Verify:</p>
<pre><code class="language-bash">ls -ld ~/.gnupg
# Should show: drwx------

ls -l ~/.gnupg
# Files should show: -rw-------
</code></pre>
<p>After fixing, run:</p>
<pre><code class="language-bash">gpg --list-keys
</code></pre>
<p>The warning should be gone.</p>
<p><strong>Add Keygrip to <code>sshcontrol</code> for gpg-agent</strong></p>
<pre><code class="language-bash">gpg --list-secret-keys --with-keygrip --with-colons
</code></pre>
<ul>
<li>Copy the <code>grp</code> line - that's your keygrip</li>
</ul>
<p>Add the keygrip number to your <code>gpg-agent.sshKeys</code> and rebuild, this adds an SSH
key to gpg-agent:</p>
<pre><code class="language-nix"># gpg-agent.nix
gpg-agent.sshKeys = ["6BD11826F3845BC222127FE3D22C92C91BB3FB32"];
</code></pre>
<p>Add the KeyId to your <code>gpg-agent.nix</code>, this declares your default-key to persist
through rebuilds:</p>
<pre><code class="language-bash">gpg --list-keys
</code></pre>
<p>Copy your public key:</p>
<pre><code class="language-nix"># gpg-agent.nix
gpg.settings = {
    default-key = "Ox37ACA569C5C44787";
    trusted-key = "Ox37ACA569C5C44787";
};
</code></pre>
<p>Rebuild, and check that everything is correct with:</p>
<pre><code class="language-bash">ssh-add -L
# you should see something like:
ssh-ed25519 AABCC3NzaC1lZDI1NTE5ABBAIHyujgyCjjBTqIuFM3EMUSo6RGklmOXQW3uWRhWdJ1Mm (none)
</code></pre>
<p>After adding the keygrip of the key with Authenticate capabilities and
rebuilding, you can then add a subkey with Encrypt capabilities. For some reason
doing both at the same time and adding that keys keygrip makes gpg-agent fail.</p>
<p>Copy your public key:</p>
<pre><code class="language-bash">gpg --edit-key 0xD35CEB9322AC054E
gpg&gt; addkey
</code></pre>
<p>Choose ECC Encrypt capabilities, and type <code>save</code> to save changes and exit the
<code>gpg&gt;</code>.</p>
<ul>
<li>By itself, a keygrip cannot be used to reconstruct your private key. It's
derived from the public key material, not from the secret key itself so it's
safe to version control. Don't put your keygrip in a public repo if you don't
want people to know you use that key for signing/authentication. It's not a
security risk, but it leaks a tiny bit of metadata.</li>
</ul>
<p>The following article mentions the keygrip being computed from public elements
of the key:</p>
<ul>
<li>
<p><a href="https://gnupg-users.gnupg.narkive.com/q5JtahdV/gpg-agent-what-is-a-keygrip">gnupg-users what-is-a-keygrip</a></p>
</li>
<li>
<p>Never version-control your private key files or <code>.gnupg</code> contents.</p>
</li>
</ul>
<p>Add the following to your shell config:</p>
<pre><code class="language-bash"># zsh.nix
# ... snip ...
initContent = ''
      # GPG Agent
        export GPG_TTY=$(tty) # which terminal to use for passphrase prompts
        export SSH_AUTH_SOCK="$(gpgconf --list-dirs agent-ssh-socket)" # points SSH_AUTH_SOCK to the socket created by gpg-agent
        gpg-connect-agent updatestartuptty /bye # refresh gpg-agent so it knows which terminal is active

        # Optional: confirm it's set correctly
        echo "SSH_AUTH_SOCK is set to: $SSH_AUTH_SOCK"
'';
# ... snip ...
</code></pre>
<p>Rebuild and then restart gpg-agent:</p>
<pre><code class="language-bash">gpgconf --kill gpg-agent
gpgconf --launch gpg-agent
</code></pre>
<p>Test, these should match:</p>
<pre><code class="language-bash">echo "$SSH_AUTH_SOCK"
# output
/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76534j/S.gpg-agent.ssh

gpgconf --list-dirs agent-ssh-socket
# output
/run/user/1000/gnupg/d.wft5hcsny4qqq3g31c76834j/S.gpg-agent.ssh
</code></pre>
<pre><code class="language-bash">ssh-add -L
# Copy the entire following line:
ssh-ed25519 AABBC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I (none)
</code></pre>
<ul>
<li>Mine shows <code>(none)</code> because I left the comment field blank when creating the
key and doesn't affect functionality.</li>
</ul>
<p>Then, in your server's NixOS configuration (e.g., <code>configuration.nix</code>): Change
<code>yourUser</code> to your username</p>
<pre><code class="language-nix">users.users.yourUser = {
openssh = {
  authorizedKeys.keys = [
    "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGXwhVokJ6cKgodYT+0+0ZrU0sBqMPPRDPJqFxqRtM+I"
  ];
};
};
</code></pre>
<blockquote>
<p>❗ NOTE: Only the <strong>public</strong> key goes here, it's safe to commit to version
control. If you prefer not to hardcode it in the config, you can reference it
from a <code>.pub</code> file in your repo and read it with
<code>builtins.readFile ./mykey.pub</code></p>
</blockquote>
<p>Rebuild your system and test an SSH connection into the server:</p>
<pre><code class="language-bash">ssh -p &lt;your-port&gt; user@hostname
</code></pre>
<ul>
<li><code>&lt;your-port&gt;</code> is often <code>22</code> so it would be something like:</li>
</ul>
<pre><code class="language-bash">ssh -p 22 bill@xps
</code></pre>
<h2 id="encrypt-a-file-with-pgp"><a class="header" href="#encrypt-a-file-with-pgp">Encrypt a File with PGP</a></h2>
<h3 id="list-your-keys-and-get-the-key-id"><a class="header" href="#list-your-keys-and-get-the-key-id">List your keys and get the key ID</a></h3>
<pre><code class="language-bash">gpg --list-keys --keyid-format LONG
</code></pre>
<p>Example output:</p>
<pre><code class="language-bash">pub   rsa4096/ABCDEF1234567890 2024-01-01 [SC]
uid           [ultimate] Your Name &lt;you@example.com&gt;
sub   rsa4096/1234567890ABCDEF 2024-01-01 [E]
</code></pre>
<ul>
<li>
<p>The part after the slash on the <code>pub</code> line is your key ID (<code>ABCDEF1234567890</code>
in the example)</p>
</li>
<li>
<p>You can also use your email or name to refer to the key in most commands.</p>
</li>
</ul>
<h3 id="encrypt-a-file-for-yourself"><a class="header" href="#encrypt-a-file-for-yourself">Encrypt a file for yourself</a></h3>
<pre><code class="language-bash">echo "This file will be encrypted" &gt; file.txt
</code></pre>
<pre><code class="language-bash">gpg --encrypt --recipient ABCDEF1234567890 file.txt
</code></pre>
<pre><code class="language-bash">ls
│  7 │ file.txt            │ file │     28 B │ now           │
│  8 │ file.txt.gpg        │ file │    191 B │ now           │
</code></pre>
<p><code>gpg --encrypt</code> doesn't modify the original file. It creates a new encrypted
file by default with <code>gpg</code> amended to the filename.</p>
<pre><code class="language-bash">gpg --decrypt file.txt.gpg
gpg: encrypted with cv25519 key, ID 0x4AC131B80CEC833E, created 2025-07-31
      "GPG Key &lt;sayls8@proton.me&gt;"
This file will be encrypted
</code></pre>
<ul>
<li>You will be asked for the passphrase you used when creating the key in order
to decrypt the file.</li>
</ul>
<p>There is much more you can do with PGP beyond simple file encryption:</p>
<ul>
<li>
<p>Sign files and commits: Prove that content really came from you.</p>
</li>
<li>
<p>Encrypt for multiple recipients: Share encrypted data with teammates using
their public keys.</p>
</li>
<li>
<p>Use smartcards or YubiKeys: Store your private key on hardware for extra
security.</p>
</li>
<li>
<p>Verify software releases: Check that downloaded files are genuine using the
developer’s signature.</p>
</li>
<li>
<p>Integrate with Git: Sign tags and commits so others can trust your repository
history.</p>
</li>
</ul>
<p>This guide only scratches the surface — once your PGP key and <code>gpg-agent</code> are
set up, these capabilities become easy to add to your workflow.</p>
</details>
<h3 id="openssh-server"><a class="header" href="#openssh-server">OpenSSH Server</a></h3>
<p>First of all, if you don't use SSH don't enable it in the first place. If you do
use SSH, it's important to understand what that opens you up to.</p>
<p>The following are some recommendations from Mozilla on OpenSSH:</p>
<ul>
<li><a href="https://infosec.mozilla.org/guidelines/openssh.html">Mozilla OpenSSH guidelines</a></li>
</ul>
<p>The following OpenSSH setup is based on the above guidelines with strong
algorithms, and best practices:</p>
<pre><code class="language-nix">{config, ...}: {
  config = {
    services = {
      fail2ban = {
        enable = true;
        maxretry = 5;
        bantime = "1h";
        # ignoreIP = [
        # "172.16.0.0/12"
        # "192.168.0.0/16"
        # "2601:881:8100:8de0:31e6:ac52:b5be:462a"
        # "matrix.org"
        # "app.element.io" # don't ratelimit matrix users
        # ];

        bantime-increment = {
          enable = true; # Enable increment of bantime after each violation
          multipliers = "1 2 4 8 16 32 64 128 256";
          maxtime = "168h"; # Do not ban for more than 1 week
          overalljails = true; # Calculate the bantime based on all the violations
        };
      };
      openssh = {
        enable = true;
        settings = {
          PasswordAuthentication = false;
          PermitEmptyPasswords = false;
          PermitTunnel = false;
          UseDns = false;
          KbdInteractiveAuthentication = false;
          X11Forwarding = config.services.xserver.enable;
          MaxAuthTries = 3;
          MaxSessions = 2;
          ClientAliveInterval = 300;
          ClientAliveCountMax = 0;
          AllowUsers = ["your-user"];
          TCPKeepAlive = false;
          AllowTcpForwarding = false;
          AllowAgentForwarding = false;
          LogLevel = "VERBOSE";
          PermitRootLogin = "no";
          KexAlgorithms = [
            "curve25519-sha256@libssh.org"
            "ecdh-sha2-nistp521"
            "ecdh-sha2-nistp384"
            "ecdh-sha2-nistp256"
            "diffie-hellman-group-exchange-sha256"
          ];
          Ciphers = [
            "chacha20-poly1305@openssh.com"
            "aes256-gcm@openssh.com"
            "aes128-gcm@openssh.com"
            "aes256-ctr"
            "aes192-ctr"
            "aes128-ctr"
          ];
          Macs = [
            "hmac-sha2-512-etm@openssh.com"
            "hmac-sha2-256-etm@openssh.com"
            "umac-128-etm@openssh.com"
            "hmac-sha2-512"
            "hmac-sha2-256"
            "umac-128@openssh.com"
          ];
        };
        hostKeys = [
          {
            path = "/etc/ssh/ssh_host_ed25519_key";
            type = "ed25519";
          }
        ];
      };
    };
  };
}
</code></pre>
<p>TCP port 22 (ssh) is opened automatically if the SSH daemon is enabled
(<code>services.openssh.enable = true;</code>)</p>
<p>Much of the SSH hardening settings came from
<a href="https://ryanseipp.com/post/nixos-secure-ssh/">ryanseipp's secure-ssh Guide</a>
with some additions of my own.</p>
<p>Fail2Ban is an intrusion prevention software framework. It's designed to prevent
brute-force attacks by scanning log files for suspicious activity, such as
repeated failed login attempts.</p>
<p>OpenSSH is the primary tool for secure remote access for NixOS. Enabling it
activates the OpenSSH server on the system, allowing incoming SSH connections.</p>
<p>The above configuration is a robust setup for securing an SSH server by:</p>
<ul>
<li>
<p>Preventing brute-force attacks with Fail2Ban</p>
</li>
<li>
<p>Eliminating password authentication in favor of more secure SSH keys</p>
</li>
<li>
<p>Restricting user access and preventing root login</p>
</li>
<li>
<p>Disabling potentially risky forwarding features (tunnel, TCP, agent)</p>
</li>
<li>
<p>Enforce the use of strong, modern cryptographic algorithms for all SSH
communications.</p>
</li>
<li>
<p>Enhanced logging for better auditing.</p>
</li>
</ul>
<p>Further Reading:</p>
<ul>
<li>
<p><a href="https://www.openssh.com/">OpenSSH</a></p>
</li>
<li>
<p><a href="https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server">DigitalOcean how fail2ban works</a></p>
</li>
</ul>
<h2 id="encrypted-secrets"><a class="header" href="#encrypted-secrets">Encrypted Secrets</a></h2>
<p>Never store secrets in plain text in repositories. Use something like
<a href="https://github.com/Mic92/sops-nix">sops-nix</a>, which lets you keep encrypted
secrets under version control declaratively.</p>
<p>Another option is <a href="https://github.com/ryantm/agenix">agenix</a></p>
<ul>
<li><a href="https://wiki.nixos.org/wiki/Agenix">NixOS Wiki Agenix</a></li>
</ul>
<h3 id="sops-nix-guide"><a class="header" href="#sops-nix-guide">Sops-nix Guide</a></h3>
<p>Protect your secrets, the following guide is on setting up Sops on NixOS:
<a href="https://saylesss88.github.io/installation/enc/sops-nix.html">Sops Encrypted Secrets</a></p>
<h2 id="auditd"><a class="header" href="#auditd">Auditd</a></h2>
<p>To enable the Linux Audit Daemon (<code>auditd</code>) and define a very basic rule set,
you can use the following NixOS configuration. This example demonstrates how to
log every program execution (<code>execve</code>) on a 64-bit architecture.</p>
<pre><code class="language-nix"># modules/security/auditd-minimal.nix (or directly in configuration.nix)
{
  # start as early in the boot process as possible
  boot.kernelParams = ["audit=1"];
  security.auditd.enable = true;
  security.audit.enable = true;
  security.audit.rules = [
    # Log all program executions on 64-bit architecture
    "-a exit,always -F arch=b64 -S execve"
  ];
}
</code></pre>
<ul>
<li>
<p><code>audit=1</code> Enables auditing at the kernel level very early in the boot process.
Without this, some events could be missed.</p>
</li>
<li>
<p><code>security.auditd.enable = true;</code> Ensures the <code>auditd</code> userspace daemon is
started.</p>
</li>
<li>
<p>While often enabled together, <code>security.audit.enable</code> specifically refers to
enabling the NixOS module for audit rules generation.</p>
</li>
<li>
<p><code>execve</code> (program executions)</p>
</li>
<li>
<p>This is just a basic configuration, there is much more that can be tracked.</p>
</li>
</ul>
<h2 id="usb-port-protection"><a class="header" href="#usb-port-protection">USB Port Protection</a></h2>
<p>It's important to protect your USB ports to prevent BadUSB attacks, data
exfiltration, unauthorized device access, malware injection, etc.</p>
<p>To get a list of your connected USB devices you can use <code>lsusb</code> from the
<code>usbutils</code> package.</p>
<pre><code class="language-bash">lsusb
</code></pre>
<p>To list the devices recognized by USBGuard, run:</p>
<pre><code class="language-bash">sudo usbguard list-devices
</code></pre>
<ul>
<li><a href="https://mynixos.com/options/services.usbguard">MyNixOS services.usbguard</a></li>
</ul>
<p>Change <code>your-user</code> to your username:</p>
<pre><code class="language-nix"># usbguard.nix
{
  config,
  pkgs,
  lib,
  ...
}: let
  inherit (lib) mkIf;
  cfg = config.custom.security.usbguard;
in {
  options.custom.security.usbguard = {
    enable = lib.mkEnableOption "usbguard";
  };

  config = mkIf cfg.enable {
    services.usbguard = {
      enable = true;
      IPCAllowedUsers = ["root" "your-user"];
    # presentDevicePolicy refers to how to treat USB devices that are already connected when the daemon starts
      presentDevicePolicy = "allow";
      rules = ''
        # allow `only` devices with mass storage interfaces (USB Mass Storage)
        allow with-interface equals { 08:*:* }
        # allow mice and keyboards
        # allow with-interface equals { 03:*:* }

        # Reject devices with suspicious combination of interfaces
        reject with-interface all-of { 08:*:* 03:00:* }
        reject with-interface all-of { 08:*:* 03:01:* }
        reject with-interface all-of { 08:*:* e0:*:* }
        reject with-interface all-of { 08:*:* 02:*:* }
      '';
    };

    environment.systemPackages = [pkgs.usbguard];
  };
}
</code></pre>
<p>The above settings can be found in
<a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/security_guide/sec-using-usbguard">RedHat UsbGuard</a></p>
<p>The only <code>allow</code> rule is for devices with <strong>only</strong> mass storage interfaces
(<code>08:*:*</code>) i.e., USB Mass storage devices, devices like keyboards and mice
(which use interface class <code>03:*:*</code>) implicitly <strong>not allowed</strong>.</p>
<p>The <code>reject</code> rules reject devices with a suspicious combination of interfaces. A
USB drive that implements a keyboard or a network interface is very suspicious,
these <code>reject</code> rules prevent that.</p>
<p>The <code>presentDevicePolicy = "allow";</code> allows any device that is present at daemon
start up even if they're not explicitly allowed. However, newly plugged in
devices must match an <code>allow</code> rule or get denied implicitly.</p>
<p>The <code>presentDevicePolicy</code> should be one of: # one of <code>"apply-policy"</code>(default,
evaluate the rule set for every present device), <code>"block"</code>, <code>"reject"</code>, <code>"keep"</code>
(keep whatever state the device is currently in), or <code>"allow"</code>, which is used in
the example.</p>
<p>There is also the
<a href="https://github.com/Cropi/usbguard-notifier">usbguard-notifier</a></p>
<p>And enable it with the following in your <code>configuration.nix</code> or equivalent:</p>
<pre><code class="language-nix"># configuration.nix
imports = [
    ./usbguard.nix
];
custom.security.usbguard.enable = true;
</code></pre>
<blockquote>
<p>❗ If you are ever unsure about a setting that you want to harden and think
that it could possibly break your system you can always use a specialisation
reversing the action and choose it's generation at boot up. For example, to
force-reverse the above settings you could:</p>
<pre><code class="language-nix"># configuration.nix
specialisation.no-usbguard.configuration = {
    services.usbguard.enable = lib.mkForce false;
};
</code></pre>
<ul>
<li>This is a situation where I recommend this, it's easy to lock yourself out
of your keyboard, mouse, etc. when trying to configure this.</li>
</ul>
</blockquote>
<p>Further Reading:</p>
<ul>
<li>
<p><a href="https://www.ninjaone.com/it-hub/endpoint-security/what-is-badusb/">NinjaOne BadUSB</a></p>
</li>
<li>
<p><a href="https://usbguard.github.io/">USBGuard</a></p>
</li>
<li>
<p><a href="https://www.cyberciti.biz/security/how-to-protect-linux-against-rogue-usb-devices-using-usbguard/">NixCraft USBGuard</a></p>
</li>
</ul>
<h2 id="doas-over-sudo"><a class="header" href="#doas-over-sudo">Doas over sudo</a></h2>
<p>For a more minimalist version of <code>sudo</code> with a smaller codebase and attack
surface, consider <code>doas</code>. Replace <code>userName</code> with your username:</p>
<pre><code class="language-nix"># doas.nix
{
  lib,
  config,
  pkgs, # Add pkgs if you need to access user information
  ...
}: let
  cfg = config.custom.security.doas;
in {
  options.custom.security.doas = {
    enable = lib.mkEnableOption "doas";
  };

  config = lib.mkIf cfg.enable {
    # Disable sudo
    security.sudo.enable = false;

    # Enable and configure `doas`.
    security.doas = {
      enable = true;
      extraRules = [
        {
          # Grant doas access specifically to your user
          users = ["userName"]; # &lt;--- Only give access to your user
          # persist = true; # Convenient but less secure
          # noPass = true;    # Convenient but even less secure
          keepEnv = true; # Often necessary
          # Optional: You can also specify which commands they can run, e.g.:
          # cmd = "ALL"; # Allows running all commands (default if not specified)
          # cmd = "/run/current-system/sw/bin/nixos-rebuild"; # Only allow specific command
        }
      ];
    };

    # Add an alias to the shell for backward-compat and convenience.
    environment.shellAliases = {
      sudo = "doas";
    };
  };
}
</code></pre>
<p>You would then import this into your <code>configuration.nix</code> and enable/disable it
with the following:</p>
<pre><code class="language-nix"># configuration.nix

imports = [
    ./doas.nix
];

custom.security.doas.enable = true;
</code></pre>
<blockquote>
<p>❗ NOTE: Many people opt for the less secure <code>groups = ["wheel"];</code> in the
above configuration instead of <code>users = ["userName"];</code> to give wider access,
the choice is yours.</p>
</blockquote>
<h2 id="firejail"><a class="header" href="#firejail">Firejail</a></h2>
<ul>
<li>
<p><a href="https://wiki.nixos.org/wiki/Firejail">NixOS Wiki Firejail</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Firejail">Arch Wiki Firejail</a></p>
</li>
</ul>
<blockquote>
<p>❗ WARNING: Running untrusted code is never safe, sandboxing cannot change
this. --Arch Wiki</p>
</blockquote>
<pre><code class="language-nix"># firejail.nix
{
  pkgs,
  lib,
  ...
}: {
  programs.firejail = {
    enable = true;
    wrappedBinaries = {
      # Sandbox a web browser
      librewolf = {
        executable = "${lib.getBin pkgs.librewolf}/bin/librewolf";
        profile = "${pkgs.firejail}/etc/firejail/librewolf.profile";
      };
      # Sandbox a file manager
      thunar = {
        executable = "${lib.getBin pkgs.xfce.thunar}/bin/thunar";
        profile = "${pkgs.firejail}/etc/firejail/thunar.profile";
      };
      # Sandbox a document viewer
      zathura = {
        executable = "${lib.getBin pkgs.zathura}/bin/zathura";
        profile = "${pkgs.firejail}/etc/firejail/zathura.profile";
      };
    };
  };
}
</code></pre>
<p><code>wrappedBinaries</code> is a list of applications you want to run inside a sandbox.
Only the apps in the <code>wrappedBinaries</code> attribute set will be automatically
firejailed when launched the usual way.</p>
<p>Other apps may be started manually using <code>firejail &lt;app&gt;</code>, or added to
<code>wrappedBinaries</code> if you want automatic sandboxing, just make sure the profile
exists.</p>
<p>To inspect which profiles are available, after rebuilding go to <code>/nix/store/</code>, I
used Yazi to search for <code>/firejail</code> and followed it to <code>firejail/etc</code>, where the
profiles are.</p>
<p>There are many flags and options available with firejail, I suggest checking out
<code>man firejail</code>.</p>
<p>There are comments explaining what's going on in:
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/fi/firejail/package.nix">firejail/package.nix</a></p>
<p>Firejail is a SUID program that reduces the risk of security breaches by
restricting the running environment of untrusted applications using
<a href="https://lwn.net/Articles/531114/">Linux namespaces</a> and
<a href="https://l3net.wordpress.com/2015/04/13/firejail-seccomp-guide/">seccomp-bpf</a>--<a href="https://firejail.wordpress.com/">Firejail Security Sandbox</a></p>
<p>It provides sandboxing and access restriction per application, much like what
AppArmor/SELinux does at a kernel level. However, it's not as secure or
comprehensive as kernel-enforced MAC systems (AppArmor/SELinux), since it's a
userspace tool and can potentially be bypassed by privilege escalation exploits.</p>
<h2 id="selinuxapparmor-mac-mandatory-access-control"><a class="header" href="#selinuxapparmor-mac-mandatory-access-control">SeLinux/AppArmor MAC (Mandatory Access Control)</a></h2>
<p><strong>AppArmor</strong> is available on NixOS, but is still in a somewhat experimental and
evolving state. There are only a few profiles that have been adapted to NixOS,
see here
<a href="https://discourse.nixos.org/t/apparmor-default-profiles/16780">Discourse on default-profiles</a>
Which guides you here
<a href="https://github.com/NixOS/nixpkgs/blob/2acaef7a85356329f750819a0e7c3bb4a98c13fe/nixos/modules/security/apparmor/includes.nix">apparmor/includes.nix</a>
where you can see some of the abstractions and tunables to follow progress.</p>
<p><strong>SELinux</strong>: Experimental, not fully integrated, recent progress for
advanced/curious users; expect rough edges and manual intervention if you want
to try it. Most find SELinux more complex to configure and maintain than
AppArmor.</p>
<p>This isn't meant to be a comprehensive guide, more to get people thinking about
security on NixOS.</p>
<p>See the following guide on hardening networking:</p>
<ul>
<li><a href="https://saylesss88.github.io/nix/hardening_networking.html">Hardening Networking</a></li>
</ul>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<h3 id="advanced-hardening-with-nix-mineral-community-project"><a class="header" href="#advanced-hardening-with-nix-mineral-community-project">Advanced Hardening with <code>nix-mineral</code> (Community Project)</a></h3>
<details>
<summary> ✔️ Click to Expand section on `nix-mineral` </summary>
<p>For users seeking a more comprehensive and opinionated approach to system
hardening beyond the built-in <code>hardened</code> profile, the community project
<a href="https://github.com/cynicsketch/nix-mineral"><code>nix-mineral</code></a> offers a declarative
NixOS module.</p>
<p><code>nix-mineral</code> aims to apply a wide array of security configurations, focusing on
tweaking kernel parameters, system settings, and file permissions to reduce the
attack surface.</p>
<ul>
<li><strong>Community Project Status:</strong> <code>nix-mineral</code> is a community-maintained project
and is not officially part of the Nixpkgs repository or NixOS documentation.
Its development status is explicitly stated as "Alpha software," meaning it
may introduce stability issues or unexpected behavior.</li>
</ul>
<p>For detailed information on <code>nix-mineral</code>'s capabilities and current status,
refer directly to its
<a href="https://github.com/cynicsketch/nix-mineral">GitHub repository</a>.</p>
</details>
<ul>
<li>
<p><a href="https://hedgedoc.grimmauld.de/s/hWcvJEniW#">AppArmor and apparmor.d on NixOS</a></p>
</li>
<li>
<p><a href="https://tristanxr.com/post/selinux-on-nixos/">SELinux on NixOS</a></p>
</li>
<li>
<p><a href="https://xeiaso.net/blog/paranoid-nixos-2021-07-18/">Paranoid NixOS</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Security">NixOS Wiki Security</a></p>
</li>
<li>
<p><a href="https://nixos.org/manual/nixos/unstable/index.html#sec-luks-file-systems">Luks Encrypted File Systems</a></p>
</li>
<li>
<p><a href="https://discourse.nixos.org/t/a-modern-and-secure-desktop-setup/41154">Discourse A Modern and Secure Desktop</a></p>
</li>
<li>
<p><a href="https://notashelf.dev/posts/insecurities-remedies-i">notashelf NixOS Security 1 Systemd</a></p>
</li>
<li>
<p><a href="https://ryanseipp.com/post/hardening-nixos/">ryanseipp hardening-nixos</a></p>
</li>
<li>
<p><a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html">madaidans Linux Hardening Guide</a></p>
</li>
<li>
<p><a href="https://cybersecuritynews.com/hardening-linux-servers">Hardening-Linux-Servers</a></p>
</li>
<li>
<p><a href="https://linux-audit.com/linux-server-hardening-most-important-steps-to-secure-systems/">linux-audit Linux Server hardening best practices</a></p>
</li>
<li>
<p><a href="https://linux-audit.com/linux-security-guide-extended-version/">linux-audit Linux security guide extended</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Security">Arch Wiki Security</a></p>
</li>
<li>
<p><a href="https://wiki.gentoo.org/wiki/Security_Handbook/Concepts">Gentoo Security_Handbook Concepts</a></p>
</li>
<li>
<p>STIGs are configuration standards developed by the Defense Information Systems
Agency (DISA) to secure systems and software for the U.S. Department of
Defense (DoD). They are considered a highly authoritative source for system
hardening.There are recommendations for hardening all kinds of software in the
<a href="https://stigviewer.com/stigs">Stig Viewer</a></p>
</li>
<li>
<p><a href="https://www.cisecurity.org/cis-benchmarks">CIS Benchmarks</a></p>
</li>
<li>
<p><a href="https://github.com/nsacyber">NSA Cybersecurity Directorate</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../nix/hardening_networking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../nix/hardening_networking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
