<!DOCTYPE HTML>
<html lang="en" class="navy sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hardening NixOS - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-df2c71f3.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/extra-c3f37c9a.css">
        <link rel="stylesheet" href="../theme/rss-button-d84d8455.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "navy";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-6248cc19.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-e88b5bcf.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/saylesss88/nix-book.git" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="hardening-nixos"><a class="header" href="#hardening-nixos">Hardening NixOS</a></h1>
<details>
<summary> Click to Expand Table of Contents</summary>
<ul>
<li><a href="#common-attack-vectors-for-linux">Common Attack Vectors for Linux</a></li>
<li><a href="#minimal-installation-with-luks">Minimal Installation with LUKS</a></li>
<li><a href="#manual-encrypted-install-following-the-manual">Manual Encrypted Install Following the Manual</a></li>
<li><a href="#guided-encrypted-btrfs-subvol-install-using-disko">Guided Encrypted BTRFS Subvol install using disko</a></li>
<li><a href="#installing-software">Installing Software</a></li>
<li><a href="#users-and-suid-binaries">Users and SUID Binaries</a>
<ul>
<li><a href="#-the-danger-of-setuid">üí• The Danger of setuid</a></li>
<li><a href="#capabilities">Capabilities</a></li>
</ul>
</li>
<li><a href="#impermanence">Impermanence</a></li>
<li><a href="#replace-timesyncd-with-a-chron-job-that-enables-network-time-security-nts">Replace timesyncd with a chron job that enables Network Time Security (NTS)</a></li>
<li><a href="#secure-boot">Secure Boot</a>
<ul>
<li><a href="#the-kernel">The Kernel</a></li>
</ul>
</li>
<li><a href="#choosing-your-kernel">Choosing your Kernel</a>
<ul>
<li><a href="#the-hardened-kernel">The Hardened Kernel</a></li>
<li><a href="#sysctl">sysctl</a></li>
</ul>
</li>
<li><a href="#kernel-security-settings">Kernel Security Settings</a></li>
<li><a href="#further-hardening-with-sysctl">Further Hardening with sysctl</a></li>
<li><a href="#hardening-boot-parameters">Hardening Boot Parameters</a></li>
<li><a href="#hardened-memory-allocator">Hardened Memory Allocator</a></li>
<li><a href="#hardening-systemd">Hardening Systemd</a></li>
<li><a href="#lynis-and-other-tools">Lynis and other tools</a></li>
<li><a href="#securing-ssh">Securing SSH</a></li>
<li><a href="#key-generation">Key generation</a>
<ul>
<li><a href="#ssh-keygen">ssh-keygen</a></li>
<li><a href="#openssh-server">OpenSSH Server</a></li>
</ul>
</li>
<li><a href="#encrypted-secrets">Encrypted Secrets</a>
<ul>
<li><a href="#sops-nix-guide">Sops-nix Guide</a></li>
</ul>
</li>
<li><a href="#auditd">Auditd</a></li>
<li><a href="#usb-port-protection">USB Port Protection</a></li>
<li><a href="#doas-over-sudo-warning-doas-is-unmaintained">Doas over sudo (Warning Doas is unmaintained)</a></li>
<li><a href="#firejail">Firejail</a></li>
<li><a href="#flatpak">Flatpak</a></li>
<li><a href="#selinuxapparmor-mac-mandatory-access-control">SeLinux/AppArmor MAC (Mandatory Access Control)</a></li>
<li><a href="#resources">Resources</a>
<ul>
<li><a href="#advanced-hardening-with-nix-mineral-community-project">Advanced Hardening with <code>nix-mineral</code> (Community Project)</a></li>
</ul>
</li>
</ul>
</details>
<p><img src="../images/guy_fawks.png" alt="guy fawks hacker"></p>
<p>Securing your NixOS system begins with a philosophy of minimalism, explicit
configuration, and proactive control. As desktop Linux attracts more novice
users, it has become an increasingly valuable target for attackers. This makes
it crucial to adopt security best practices early to protect your desktop from
common attack vectors and to avoid configuration mistakes that could expose
vulnerabilities.</p>
<blockquote>
<p>‚ö†Ô∏è Warning: I am not a security expert. This guide presents various options
for hardening NixOS, but it is your responsibility to evaluate whether each
adjustment suits your specific needs and environment. Security hardening and
process isolation can introduce stability challenges, compatibility issues, or
unexpected behavior. Additionally, these protections often come with
performance tradeoffs. Always conduct thorough research, there are no plug and
play one size fits all security solutions.</p>
</blockquote>
<blockquote>
<p>That said, I typically write about what I‚Äôm implementing myself to deepen
understanding and share what works for me. <code>--Source</code> means the proceeding
paragraph came from <code>--Source</code>, you can often click to check for yourself. If
you use some common sense with a bit of caution you could end up with a more
secure NixOS system that fits your needs.</p>
</blockquote>
<blockquote>
<p>Much of this guide draws inspiration or recommendations from the well-known
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html">Linux Hardening Guide</a>
by Madaidan‚Äôs Insecurities. Madaidan‚Äôs work is widely regarded in technical
and security circles as one of the most comprehensive and rigorously
researched sources on practical Linux security, frequently cited for its depth
and actionable advice. For example, much of the original basis for hardening
for <a href="https://github.com/cynicsketch/nix-mineral">nix-mineral</a> came from this
guide as well. This can be a starting point but shouldn‚Äôt be blindly followed
either, always do your own research, things change frequently.</p>
</blockquote>
<p>For an article with apposing perspectives, see
<a href="https://chyrp.cgps.ch/en/debunking-madaidans-insecurities/">debunking-madaidans-insecurities</a>.
We can learn from both and hopefully find something in between that is closer to
the truth.</p>
<blockquote>
<p>‚ùó <strong>Note on SELinux and AppArmor</strong>: While NixOS can provide a high degree of
security through its immutable and declarative nature, it‚Äôs important to
understand the limitations regarding Mandatory Access Control (MAC)
frameworks. Neither SELinux nor AppArmor are fully supported or widely used in
the NixOS ecosystem. You can do a lot to secure NixOS but if anonymity and
isolation are paramount, I recommend booting into a
<a href="https://tails.net/">Tails USB stick</a>. Or using
<a href="https://www.whonix.org/">Whonix</a>.</p>
</blockquote>
<p>‚òùÔ∏è The unique file structure of NixOS, particularly the immutable <code>/nix/store</code>,
makes it difficult to implement and manage the file-labeling mechanisms that
these frameworks rely on. There are ongoing community efforts to improve
support, but as of now, they are considered experimental and not a standard part
of a typical NixOS configuration. For an immutable distro that implements
SELinux by default at a system level as well as many other hardening techniques,
see <a href="https://secureblue.dev/">Fedora secureblue</a>.</p>
<p>Containers and VMs are beyond the scope of this chapter but can also enhance
security and sandboxing if configured correctly. See
<a href="https://saylesss88.github.io/nix/kvm.html">Running NixOS in a VM</a> for more
details on running NixOS in a Secureblue VM for additional security.</p>
<p>It‚Äôs crucial to <strong>document every change</strong> you make. By creating smaller,
feature-complete commits, each with a descriptive message, you‚Äôre building a
clear history. This approach makes it far simpler to revert a breaking change
and quickly identify what went wrong. Over time, this discipline allows you to
create security-focused checklists and ensure all angles are covered, building a
more robust and secure system.</p>
<p>Don‚Äôt rely on single solutions or products, develop processes and defense in
depth. Think ahead and fail securely so that a single failure doesn‚Äôt mean total
insecurity.</p>
<p>Attackers often monitor the latest Linux CVEs (Common Vulnerabilities and
Exposures) and check if and when specific distributions like NixOS have
implemented fixes. The unstable branch will receive the security patches and
fixes faster than stable which is another thing to keep in mind.</p>
<p>Check out the
<a href="https://saylesss88.github.io/nix/index.html">Hardening NixOS Baseline Hardening README</a>
for baseline hardening recommendations and best practices.</p>
<p>There is something to be said about the window manager you use. GNOME, KDE
Plasma, and Sway secure privileged Wayland protocols like screencopy. This means
that on environments outside of GNOME, KDE, and Sway, applications can access
screen content of the entire desktop. This implicitly includes the content of
other applications. It‚Äôs primarily for this reason that Silverblue, Kinoite, and
Sericea images are recommended. COSMIC has plans to fix this.
‚Äì<a href="https://secureblue.dev/images">secureblue Images</a></p>
<p>For example, to disable Xwayland for sway on home-manager you would add:</p>
<pre><code class="language-nix">wayland.windowManager.sway = {
  enable = true;
  extraConfig = ''
    xwayland disable
  '';
}
</code></pre>
<ul>
<li>You may get an error saying you‚Äôre only able to disable xwayland at boot,
restart your system and you‚Äôll be all set.</li>
</ul>
<p>You can explicitly disable <code>xdg-desktop-portal-wlr</code> with systemd in your
<code>configuration.nix</code> like this:</p>
<pre><code class="language-nix"># configuration.nix
systemd.user.services."xdg-desktop-portal-wlr" = {
  enable = false;  # Masks/stops the wlr service
};
xdg.portal.wlr.enable = false;
</code></pre>
<h2 id="common-attack-vectors-for-linux"><a class="header" href="#common-attack-vectors-for-linux">Common Attack Vectors for Linux</a></h2>
<details>
<summary> ‚úîÔ∏è Click to Expand Common Attack Vectors in Linux </summary>
<p><strong>Privilege escalation</strong>: The unauthorized act of gaining elevated permissions
rather than legitimate, controlled privilege use. It‚Äôs a very common tactic that
threat actors use to take over a system, steal data, delete files, and more.</p>
<p><strong>Processes to protect against Privilege escalation</strong></p>
<ul>
<li>
<p>Adopt the principle of least privilege, only giving users the permissions that
they require to perform their duties.</p>
</li>
<li>
<p>Harden your system: Minimize the attack surface, use strong passwords, and
follow best practices.</p>
</li>
<li>
<p>Monitor relevant sources such as the
<a href="https://www.strongdm.com/nist-compliance">NIST National Vulnerability Database</a>,
<a href="https://github.com/NixOS/nix/security/advisories">NixOS Security Advisories</a>,
and
<a href="https://discourse.nixos.org/c/announcements/security/56">NixOS Discourse Security</a>
So you‚Äôll know the latest CVEs and vulnerabilities in Linux and NixOS.</p>
</li>
<li>
<p>While not made for NixOS the
<a href="https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS">linPEAS Privilege Escalation Awesome Script</a>
gives you some useful info such as active capabilities and potential risks.</p>
</li>
<li>
<p>Remove unnecessary SUID binaries to reduce the attack surface.</p>
</li>
</ul>
<hr>
<p><strong>Use after Free/Double free</strong>:</p>
<p><strong>Use-After-Free (UAF)</strong> is a type of software vulnerability that occurs in
memory unsafe languages (C C++) when a program continues to use a memory
location after it has been freed or deallocated.</p>
<p><strong>Double free</strong>: is a flaw where a program frees the same memory block twice
using <code>free()</code> or <code>delete</code>, leading to undefined behavior and potential
exploitation.</p>
<p>Mitigation techniques include the use of hardened allocators such as
<code>hardened_malloc</code>, which improve memory management to detect and prevent UAF and
double-free bugs. Recent versions of <code>glibc</code> also incorporate built-in checks to
catch double frees.</p>
<hr>
<p><strong>Unauthorized Access</strong>:</p>
<p>Unauthorized access is the entry or use of your system, networks, or data by
individuals without permission. It‚Äôs a common way for adversaries to exfiltrate
data, execute malicious code, and cause damage.</p>
<p><strong>Protections against Unauthorized Access</strong></p>
<ul>
<li>
<p>Strong Passwords, MFA, and robust Secrets management. In 2025, 22% of breaches
involved stolen credentials overall; in basic web app attacks, 88% used stolen
credentials.
‚Äì<a href="https://www.strongdm.com/blog/data-breach-statistics">StrongDM data-breach-statistics</a></p>
</li>
<li>
<p>Close unused ports with a Firewall</p>
</li>
<li>
<p>Encrypt data in transit and at rest</p>
</li>
<li>
<p>Watch your Logs, and deploy intrusion detection systems such as AIDE.</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/89.html">SQL Injection CWE</a>, SQL
injection is the most common critical web application vulnerability.</p>
</li>
<li>
<p><a href="https://owasp.org/www-community/attacks/xss/">Cross Site Scripting (XSS)</a></p>
</li>
</ul>
<hr>
<p><strong>Misconfiguration</strong></p>
<ul>
<li>
<p>With many new users trying NixOS, misconfiguration is common and an easy way
for an attacker to gain control over your system.</p>
</li>
<li>
<p>It is recommended to start slowly and try to ensure that you understand your
configuration. Avoid copy-pasting config files that you don‚Äôt understand yet.</p>
</li>
</ul>
<hr>
<p><strong>Zero Day Exploits</strong>:</p>
<p>The term ‚ÄúZero-Day‚Äù refers to a security vulnerability or flaw that is unknown
to the software developers or security teams, meaning they have had zero days to
create a patch or fix for it. This term is often associated with concepts such
as Vulnerabilities, Exploits, and Threats, and it‚Äôs important to distinguish
among them:</p>
<ul>
<li>
<p>A <strong>Zero-Day Vulnerability</strong> is a previously undiscovered security weakness or
flaw in software that malicious actors can exploit.</p>
</li>
<li>
<p>A <strong>Zero-Day Exploit</strong> describes the specific method or technique attackers
use to take advantage of that vulnerability to compromise a system.</p>
</li>
<li>
<p>A <strong>Zero-Day Attack</strong> happens when malicious actors launch an attack using a
zero-day exploit before the software vendor has had a chance to patch or fix
the vulnerability.</p>
</li>
<li>
<p><a href="https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/view?gid=0#gid=0">Project Zero‚Äôs 0day spreadsheet</a>.
You‚Äôll see that a majority of zero-days are Memory Corruption bugs.</p>
</li>
<li>
<p><a href="https://www.zero-day.cz/database/">Zero-Day tracking project</a></p>
</li>
<li>
<p><a href="https://www.zerodayinitiative.com/advisories/published/"> Trend Micro‚Äôs zero day inituative</a></p>
</li>
</ul>
</details>
<hr>
<h2 id="minimal-installation-with-luks"><a class="header" href="#minimal-installation-with-luks">Minimal Installation with LUKS</a></h2>
<p>Begin with NixOS‚Äôs minimal installation image. This gives you a base system with
only essential tools and no extras that could introduce vulnerabilities.</p>
<p>NixOS‚Äôs declarative model makes auditing the installed packages and services
easy, do so regularly.</p>
<hr>
<h2 id="manual-encrypted-install-following-the-manual"><a class="header" href="#manual-encrypted-install-following-the-manual">Manual Encrypted Install Following the Manual</a></h2>
<p>Encryption is the process of using an algorithm to scramble plaintext data into
ciphertext, making it unreadable except to a person who has the key to decrypt
it.</p>
<p><strong>Data at rest</strong> is data in storage, such as a computer‚Äôs or a servers hard
disk.</p>
<p><strong>Data at rest encryption</strong> (typically hard disk encryption), secures the
documents, directories, and files behind an encryption key. Encrypting your data
at rest prevents data leakage, physical theft, unauthorized access, and more as
long as the key management scheme isn‚Äôt compromised.</p>
<ul>
<li>
<p><a href="https://channels.nixos.org/nixos-25.05/latest-nixos-minimal-x86_64-linux.iso">Minimal ISO Download (64-bit Intel/AMD)</a></p>
</li>
<li>
<p><a href="https://nixos.org/manual/nixos/stable/#sec-installation">NixOS Manual Installation</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Full_Disk_Encryption">NixOS Wiki Full Disk Encryption</a></p>
</li>
<li>
<p>The
<a href="https://www.nsa.gov/Press-Room/Press-Releases-Statements/Press-Release-View/Article/3498776/post-quantum-cryptography-cisa-nist-and-nsa-recommend-how-to-prepare-now/">NSA, CISA, and NIST warn</a>
that nation-state actors are likely stockpiling encrypted data now, preparing
for a future when quantum computers could break today‚Äôs most widely used
encryption algorithms. Sensitive data with long-term secrecy needs is
especially at risk.</p>
</li>
<li>
<p>This is a wake-up call to use the strongest encryption available today and to
plan early for post-quantum security.</p>
</li>
<li>
<p><a href="https://www.nist.gov/news-events/news/2024/08/nist-releases-first-3-finalized-post-quantum-encryption-standards">NIST First 3 Post-Quantum Encryption Standards</a>
Organizations and individuals should prepare to migrate cryptographic systems
to these new standards as soon as practical.</p>
</li>
<li>
<p>They chose
<a href="https://www.nist.gov/news-events/news/2022/07/nist-announces-first-four-quantum-resistant-cryptographic-algorithms">Four Quantum-Resistant Cryptographic Algorithms</a>
warning that public-key cryptography is especially vulnerable and widely used
to protect digital information.</p>
</li>
</ul>
<hr>
<h2 id="guided-encrypted-btrfs-subvol-install-using-disko"><a class="header" href="#guided-encrypted-btrfs-subvol-install-using-disko">Guided Encrypted BTRFS Subvol install using disko</a></h2>
<p>Use LUKS encryption to protect your data at rest, the following guide is a
minimal disko encrypted installation:
<a href="https://saylesss88.github.io/installation/enc/enc_install.html">Encrypted Install</a></p>
<hr>
<h2 id="installing-software"><a class="header" href="#installing-software">Installing Software</a></h2>
<blockquote>
<p>The 2025 Edgescan study examined full-stack applications and found that
one-third contained critical or severe vulnerabilities, putting them at risk.
Over 45% of large enterprises leave unresolved vulnerabilities for more than a
year. This shows the necessity of containing your apps in sandboxes when
possible.
‚Äì<a href="https://www.edgescan.com/stats-report/">edgescan Vulnerability Report</a></p>
</blockquote>
<blockquote>
<p>‚ö†Ô∏è For system security it is strongly advised to not install
<a href="https://en.wikipedia.org/wiki/Proprietary_software">proprietary</a>,
<a href="https://www.gnu.org/proprietary/proprietary.html">non-freedom</a> software.
Instead, use of
<a href="https://www.fsf.org/about/what-is-free-software">Free Software</a> is
<a href="https://www.gnu.org/philosophy/shouldbefree.html">recommended</a> ‚ÄìKicksecure</p>
</blockquote>
<ul>
<li><a href="https://www.gnu.org/proprietary/proprietary.html">Proprietary Software is Often Malware</a>
NOTE: While I respect the importance of software freedom, I choose to focus on
practical, technical solutions rather than engage with the ideological tone
often present in related advocacy.
<ul>
<li>
<p><a href="https://www.kicksecure.com/wiki/Miscellaneous_Threats_to_User_Freedom">User Freedom Threats</a></p>
</li>
<li>
<p><a href="https://www.gnu.org/proprietary/proprietary-back-doors.html">Proprietary Back Doors</a></p>
</li>
<li>
<p><a href="https://www.eff.org/deeplinks/2015/02/who-really-owns-your-drones">EFF Back Doors</a></p>
</li>
</ul>
</li>
</ul>
<pre><code class="language-nix"># configuration.nix
nixpkgs.config.allowUnfree = false;
</code></pre>
<p>To explicitly disable it for flakes:</p>
<pre><code class="language-nix"># ...snip...
pkgs = import nixpkgs {
  system = "x86_64-linux";
  config = {
    allowUnfree = false;
  };
};
# ...snip...
</code></pre>
<p>Most users don‚Äôt fully understand that running any software without sandboxing
gives it unrestricted access to their user data and system resources. There is a
widespread lack of awareness that Linux apps generally run with the full
permissions of the user. It‚Äôs easy to overlook the fact that ‚Äútrusted source‚Äù
doesn‚Äôt mean ‚Äúsafe to run uncontained‚Äù. ‚Äìsummarized from kicksecure docs</p>
<p><strong>Pre-Install Recommendations</strong></p>
<p>When installing software, first check
<a href="https://search.nixos.org/packages">search.nixos</a>, and follow the <code>Homepage</code>
link to ensure that said package is maintained.</p>
<p>For example, when I search for <code>doas</code>, and go to the
<a href="https://github.com/Duncaen/OpenDoas">Homepage</a> link, I can see that the most
recent commit was made 3 years ago. For certain software this might not be an
issue but <code>doas</code> isn‚Äôt one of them.</p>
<p>Looking at the <code>sudo-rs</code>
<a href="https://github.com/trifectatechfoundation/sudo-rs">Homepage</a> I can see that it
was updated yesterday (11-19-25) and might be a better alternative. It‚Äôs
maintained and written in a memory safe language.</p>
<p>For critical apps like <code>sudo</code>, you should also check for vulnerabilities in said
software. If you did so for <code>sudo-rs</code>, you‚Äôd see
<a href="https://nvd.nist.gov/vuln/detail/CVE-2025-64170">CVE-2025-64170</a> and see that
it‚Äôs been patched. You can then look at the
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/su/sudo-rs/package.nix">sudo-rs package.nix</a>
to ensure that the versions match. (As of 11-20-25 they match).</p>
<hr>
<p><strong>nixpkgs-unstable Security Overview</strong></p>
<ul>
<li>
<p><code>nixpkgs-unstable</code> tracks the master branch of the Nixpkgs repo and is
constantly updated.</p>
</li>
<li>
<p>This branch gets security updates faster, patching vulnerabilities faster.</p>
</li>
<li>
<p>Since it‚Äôs a rolling-release, packages are less thoroughly tested. This
increases the risk of new, undiscovered bugs or regressions. Some of which
could have security implications.</p>
</li>
<li>
<p>The packages are generally the most recent upstream versions, which is
important for security-sensitive software like browsers and kernels, as old
versions may have publicly known, unpatched vulnerabilities.</p>
</li>
<li>
<p>As the name states, <code>nixpkgs-unstable</code> is less stable and an update is more
likely to cause your system to fail to build due to breaking changes in Nix
expressions.</p>
</li>
<li>
<p>I personally use unstable for everything, but I don‚Äôt mind having to fix
issues that arise.</p>
</li>
</ul>
<hr>
<p><strong>Stable (e.g., <code>nixos-24.05</code>) Security Overview</strong></p>
<p>Stable Nixpkgs channels correspond to point release (e.g., released every 6
months) and are supported for a limited period (typically one month past the
next release).</p>
<ul>
<li>
<p>Stable channels generally only receive conservative bug and security fixes.
Major version bumps for features are typically avoided to maintain ‚Äústability
against deliberate changes‚Äù, which means you won‚Äôt get the latest upstream
features or general bug fixes.</p>
</li>
<li>
<p>While critical security updates are backported quickly, updates for less
critical packages may be slower or not happen at all if they require a
significant refactoring or version bump.</p>
</li>
<li>
<p>Stable channels are generally more stable, meaning updates are less likely to
introduce breaking changes to your configuration or system environment.</p>
</li>
<li>
<p>Many packages will be older versions. If a critical security vulnerability
requires a major upstream version update (which is often avoided in a stable
channel), the maintainers must backport the patch, a process which can
introduce its own set of risks and delays.</p>
</li>
</ul>
<hr>
<p><strong>What should you use?</strong></p>
<p>The primary security trade-off is between <strong>patching speed for known
vulnerabilities</strong> and <strong>stability/exposure to new bugs</strong>:</p>
<ul>
<li>
<p>Choose <code>unstable</code> if you prioritize getting the latest security fixes
(especially for end-user apps like browsers) as soon as they are available
upstream, accepting a higher risk of non-security-related system breakage or
new, undiscovered bugs.</p>
</li>
<li>
<p>Choose <code>stable</code> if you prioritize system predictability and stability, relying
on dedicated backports for critical vulnerabilities, while accepting that
non-critical security and bug fixes will be delayed or absent until the next
major release.</p>
</li>
</ul>
<p>A common hybrid approach is to use the <code>stable</code> channel as the base for the OS
and selectively pin specific packages from <code>unstable</code> to ensure they receive
rapid security updates.</p>
<p>With flakes it‚Äôs easy to add both <code>stable</code> and <code>unstable</code> as flake inputs and
access each with some simple logic.</p>
<details>
<summary> ‚úîÔ∏è Click to Expand Flake example using both stable &amp; unstable </summary>
<pre><code class="language-nix">{
  description = "NixOS configuration with two or more channels";

 inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.05";
    nixpkgs-unstable.url = "github:NixOS/nixpkgs/nixos-unstable";
  };

  outputs =
    { nixpkgs, nixpkgs-unstable, ... }:
    {
      nixosConfigurations."your-host" = nixpkgs.lib.nixosSystem {
        modules = [
          {
            nixpkgs.overlays = [
              (final: prev: {
                unstable = nixpkgs-unstable.legacyPackages.${prev.system};
                # use this variant if unfree packages are needed:
                # unstable = import nixpkgs-unstable {
                #   inherit prev;
                #   system = prev.system;
                #   config.allowUnfree = true;
                # };
              })
            ];
          }
          ./configuration.nix
        ];
      };
    };
}
</code></pre>
<ul>
<li>This is also how you enable unfree packages for flakes rather than in your
<code>configuration.nix</code>.</li>
</ul>
<p>Now you can specify which packages are to be installed with which channel like
so:</p>
<pre><code class="language-nix"># configuration.nix
{ pkgs, ... }:
{
  environment.systemPackages = [
    pkgs.firefox
    pkgs.unstable.helix
  ];
  # ...
}
</code></pre>
</details>
<hr>
<h2 id="users-and-suid-binaries"><a class="header" href="#users-and-suid-binaries">Users and SUID Binaries</a></h2>
<p><strong>Replacing sudo with run0</strong></p>
<blockquote>
<p>NOTE: The point here is to avoid using the setuid binary (<code>sudo</code>), <code>run0</code> is a
wrapper over <code>systemd-run</code> which speaks over Inter-process Communication
Mechanisms (IPC) to PID1 which is considered safer than running a setuid
binary. We separate our daily user from administration tasks and authenticate
through our admin account. This reduces the attack surface by removing sudo as
well as reduces the risk of local privilege escalation.</p>
</blockquote>
<ul>
<li>
<p><strong>IPC</strong> is the mechanism that allows processes to communicate. There are two
methods of IPC, shared memory and message passing. An OS can implement both.</p>
</li>
<li>
<p><strong>PID 1</strong> is the first userspace process the kernel starts (the init system),
which becomes the ancestor and reaper of all other processes; because it runs
as root, is always present, and controls the system lifecycle, any bugs or
design issues in PID 1 have outsized security impact and can translate into
system-wide compromise or denial of service.</p>
</li>
</ul>
<details>
<summary> Click to Expand SUID and run0 resources </summary>
<ul>
<li>
<p><a href="https://mastodon.social/@pid_eins/112353324518585654">run0 explained by Lennart</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Setuid">setuid Wikipedia</a></p>
</li>
<li>
<p>Using <code>run0</code> removes of these classes of
<a href="https://ruderich.org/simon/notes/su-sudo-from-root-tty-hijacking">attacks</a></p>
</li>
<li>
<p>The following lists some of the downsides
<a href="https://www.kicksecure.com/wiki/Dev/secureblue">kicksecure vs secureblue</a></p>
</li>
</ul>
</details>
<p><code>run0</code> is not a SUID, it asks the service manager to invoke a command or shell
under the target user‚Äôs UID. The target command is invoked in an isolated exec
context, freshly forked off PID1 without inheriting any context from the client.</p>
<p>The core danger of <strong>setuid</strong> (Set User ID) lies in its ability to allow a
low-privilege user to execute a program with the <strong>permissions of the file‚Äôs
owner</strong>, which is most often the powerful <strong>root user</strong>.</p>
<h3 id="-the-danger-of-setuid"><a class="header" href="#-the-danger-of-setuid">üí• The Danger of setuid</a></h3>
<p>For granting limited, controlled privilege escalation to apps, the primary
choices are broadly between traditional <strong>setuid/setgid permissions</strong> and more
modern <strong>Linux capabilities</strong>. <a href="#capabilities">Jump to Capabilities</a></p>
<ul>
<li><a href="https://www.cbtnuggets.com/blog/technology/system-admin/linux-file-permissions-understanding-setuid-setgid-and-the-sticky-bit">Understanding setuid/setgid</a></li>
</ul>
<p>Use the following command to find all SUID binaries:</p>
<pre><code class="language-bash">sudo find / -perm -4000 -type f -ls 2&gt;/dev/null
</code></pre>
<p>The <code>setuid</code> permission is dangerous because it creates a privilege escalation
pathway that can be exploited for malicious purposes.</p>
<ul>
<li>
<p>Temporary Root Access: When a file has the setuid bit set and is owned by
<code>root</code>, any user who executes that program instantly and temporarily gains the
full power of the root user while the program runs.</p>
</li>
<li>
<p>If a setuid program (such as <code>passwd</code>, or <code>sudo</code>) contain a security flaw,
such as a buffer overflow (Common in C) or improper input validation, an
attacker can exploit the flaw.</p>
</li>
<li>
<p>Since the program is running with root privileges, the attacker can execute
shell code or commands with root access, completely compromising the entire
system.</p>
</li>
</ul>
<p>Normally the root user (UID 0) gets unrestricted access to almost everything on
the entire system.</p>
<p>I rebuild/update way too often to completely separate the accounts and allow no
admin tasks for my daily user. That may be a better option for servers, etc.</p>
<p>Create an admin user for administrative tasks and remove your daily user from
the <code>wheel</code> group, and disable the <code>sudo</code>, <code>su</code>, and <code>pkexec</code> SUIDs:</p>
<pre><code class="language-users.nix">{ config, pkgs, lib }:
{
users.users.admin = {
    isNormalUser = true;
    description  = "System administrator";
    extraGroups  = [ "wheel" ];   # wheel = sudo
    # run `mkpasswd --method=yescrypt` and replace "changeme" w/ the result
    initialHashedPassword = "changeme";           # change with `passwd admin` later
    openssh.authorizedKeys.keys = [
      # (optional) paste your SSH public key here
      # "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI..."
    ];
  };
    users.groups.admin = {};
    users.mutableUsers = false;

  # --------------------------------------------------------------------
  # 2. Existing daily user ‚Äì remove from wheel, keep everything else
  # --------------------------------------------------------------------
  users.users.daily = {
    isNormalUser = true;
    description  = "Daily driver account";
    extraGroups  = lib.mkForce [ "networkmanager" "audio" "video" ]; # keep useful groups
    initialHashedPassword = "changeme";
    # Remove `wheel` by *not* listing it (mkForce overrides any default)
  };
  users.groups.daily = {};

security = {
polkit.enable = true;
# Disable sudo
sudo.enable = false;
wrappers = {
    su.setuid = lib.mkForce = false;
    sudo.setuid = lib.mkForce = false;
    sudoedit.setuid = lib.mkForce = false;
    sg.setuid = lib.mkForce = false;
    fusermount.setuid = lib.mkForce = false;
    fusermount3.setuid = lib.mkForce = false;
    mount.setuid = lib.mkForce = false;
    pkexec.setuid = lib.mkForce = false;
    newgrp.setuid = lib.mkForce = false;
    newgidmap.setuid = lib.mkForce = false;
    newuidmap.setuid= lib.mkForce = false;
};
# Or hyprlock, required for swaylock to accept your password
pam.services.swaylock = {
  text = ''
    auth include login
    account include login
    password include login
    session include login
  '';
  };
};
</code></pre>
<p>The <code>security.wrappers...</code> removes the setuid bit making the commands unusable
removing the SUID vulnerabilities for <code>su</code> and <code>pkexec</code>. You can find the other
SUID wrappers in <code>/run/wrappers/bin/</code>, such as <code>fusermount</code> and more.</p>
<p>SUID‚Äôs that can be disabled:</p>
<ul>
<li>
<p><code>umount</code>: Allows unprivileged users to unmount devices listed in your fstab.</p>
</li>
<li>
<p><code>mount</code>: Same as above but for mounting.</p>
</li>
<li>
<p><code>sg</code>: Executes a command as a different group.</p>
</li>
<li>
<p><code>mtr-packet</code>: Used by mtr to create network sockets.</p>
</li>
<li>
<p><code>fusermount</code>, <code>fusermount3</code>: Allows unprivileged users to mount FUSE
filesystems. Can be disabled if you don‚Äôt use FUSE (e.g., Appimages, etc.)</p>
</li>
<li>
<p><code>newuidmap</code>, <code>newgidmap</code>: Used for user namespace creation (Often used for
unprivileged containers). (Disable if you don‚Äôt use unprivileged
containers/namespaces)</p>
</li>
</ul>
<hr>
<p>Never Disable:</p>
<ul>
<li><code>unix_chkpwd</code>: This is a core PAM helper to securely check user passwords
against the root-readable <code>/etc/shadow</code>.</li>
</ul>
<p>Check again which SUID binaries are active:</p>
<pre><code class="language-bash">sudo find / -perm -4000 -type f -ls 2&gt;/dev/null
</code></pre>
<hr>
<p>You will have to use <code>run0</code> to authenticate your daily user, for example:</p>
<pre><code class="language-bash">run0 nixos-rebuild switch --flake .
</code></pre>
<p>Since <code>run0</code> doesn‚Äôt cache results and <code>nixos-rebuild</code> calls on Polkit 3 times,
so on every rebuild, you will be asked for your password 3 times which isn‚Äôt
ideal. I found the following workaround that will only ask for your password
once.</p>
<p>Add the following to your <code>configuration.nix</code>, replacing <code>user-name</code> with your
username:</p>
<pre><code class="language-nix"> security.polkit.extraConfig = ''
     polkit.addRule(function(action, subject) {
       if (subject.user == "user-name") {
         if (action.id.indexOf("org.nixos") == 0) {
           polkit.log("Caching admin authentication for single NixOS operation");
           return polkit.Result.AUTH_ADMIN_KEEP;
         }
       }
     });
   '';
</code></pre>
<p>Create a zsh function for easy access:</p>
<pre><code class="language-nix"># zsh.nix
#...snip...
initContent = ''
  fr() {
    run0 nixos-rebuild switch --flake "/home/$USER/flake#"$(hostname)
  }
'';
</code></pre>
<p>Needless to say, this is less secure but much more convenient than entering your
password 3 times on every single rebuild.</p>
<p>Without the <code>pam</code> settings for swaylock, it won‚Äôt accept your password to log
back in.</p>
<p><strong>run0 Usage Example</strong></p>
<p>When you are in a privileged shell, <code>run0</code> changes the color of the background
to red to remind you of this.</p>
<p>Example creating a user:</p>
<ol>
<li>
<p><code>run0</code></p>
</li>
<li>
<p><code>adduser admin</code></p>
</li>
<li>
<p><code>usermod -aG wheel admin</code></p>
</li>
<li>
<p><code>passwd admin</code></p>
</li>
<li>
<p><code>exit</code></p>
</li>
<li>
<p><code>reboot</code></p>
</li>
</ol>
<p>This is just an example, since we manage our users declaratively the user
created would be discarded on the next rebuild because of the
<code>users.mutableUsers = false;</code> setting. You could of course change this to <code>true</code>
to manage your users imperatively but I don‚Äôt recommend it.</p>
<hr>
<h3 id="capabilities"><a class="header" href="#capabilities">Capabilities</a></h3>
<details>
<summary> ‚úîÔ∏è Click to expand capabilities examples </summary>
<p>One way to help get rid of setuid binaries is to replace them with capabilities.
I personally only remove the SUID bit and don‚Äôt try to replace with capabilities
as of now. You can still use the commands from <code>security.wrappers</code> such as
<code>run0 su -</code>.</p>
<p>Capabilities provide a subset of what is available to root to a process. This
breaks up root privileges into smaller units that can independently grant access
to processes. This reduces the full set of privileges, decreasing the risk of
exploitation.</p>
<p>(This is just an example):</p>
<pre><code class="language-nix">{
  # a setuid root program
  doas =
    { setuid = true;
      owner = "root";
      group = "root";
      source = "${pkgs.doas}/bin/doas";
    };

  # a setgid program
  locate =
    { setgid = true;
      owner = "root";
      group = "mlocate";
      source = "${pkgs.locate}/bin/locate";
    };

  # a program with the CAP_NET_RAW capability
  ping =
    { owner = "root";
      group = "root";
      capabilities = "cap_net_raw+ep";
      source = "${pkgs.iputils.out}/bin/ping";
    };
}
</code></pre>
<p>List the highest capability number for your kernel with:</p>
<pre><code class="language-bash">cat /proc/sys/kernel/cap_last_cap
# Output:
40
</code></pre>
<p>List available Linux capabilities:</p>
<pre><code class="language-bash">capsh --print
</code></pre>
<p>List processes:</p>
<pre><code class="language-bash">ps
# Example Output
PID    TTY     TIME   CMD
8063   pts/1    02     zsh
</code></pre>
<pre><code class="language-bash">cat /proc/8063/status | grep Cap
# Output
CapInh: 0000000800000000
CapPrm: 0000000000000000
CapEff: 0000000000000000
CapBnd: 000001ffffffffff
CapAmb: 0000000000000000
</code></pre>
<pre><code class="language-bash">capsh --decode=000001ffffffffff
# Output
0x000001ffffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read,cap_perfmon,cap_bpf,cap_checkpoint_restore
</code></pre>
<p><code>cap_net_raw</code>: Allows the program to use raw and unbuffered network sockets,
which is what <code>ping</code> and <code>mtr-packet</code> need to send ICMP packets.</p>
<p><code>cap_sys_admin</code>: Grants a variety of system administration operations, including
the ability to perform FUSE mounts. This is a powerful capability, but it‚Äôs
still more restrictive than full root SUID.</p>
<ul>
<li><code>+ep</code>: This is crucial. It stands for:
<ul>
<li>
<p><code>e</code> (Effective): The set of capabilities actually used by the process when
running.</p>
</li>
<li>
<p><code>p</code> (Permitted): The set of capabilities that can be enabled by the process.</p>
</li>
</ul>
</li>
</ul>
<p>By using this approach, you are following the security principle of least
privilege, significantly reducing the attack surface compared to traditional
SUID binaries.</p>
<ul>
<li>
<p><a href="https://search.nixos.org/options?channel=unstable&amp;show=security.wrappers&amp;query=security.wrappers">security.wrappers</a></p>
</li>
<li>
<p><a href="https://linux-audit.com/kernel/capabilities/linux-capabilities-101/">Linux Audit capabilities 101</a></p>
</li>
<li>
<p><a href="https://www.kicksecure.com/wiki/Dev/secureblue#capabilities">Kicksecure‚Äôs take on capabilities</a></p>
</li>
<li>
<p><a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities(7)</a></p>
</li>
<li>
<p><a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux_atomic_host/7/html/container_security_guide/linux_capabilities_and_seccomp">capabilities and seccomp</a></p>
</li>
</ul>
</details>
<hr>
<h2 id="impermanence"><a class="header" href="#impermanence">Impermanence</a></h2>
<p>Impermanence, especially when using a <code>tmpfs</code> as the root filesystem, provides
several significant security benefits. The core principle is that impermanence
defeats persistence, a fundamental goal for any attacker.</p>
<p>When you use a root-as-tmpfs setup on NixOS, the boot process loads the entire
operating system from the read-only Nix store into a <code>tmpfs</code> in RAM. The mutable
directories, such as <code>/etc</code> and <code>/var</code>, are then created on this RAM disk. When
the system is shut down, the <code>tmpfs</code> is wiped, leaving the on-disk storage
untouched and secure.</p>
<p>This means you get a fresh, secure boot every time, making it much harder for an
attacker to maintain a presence on your system.</p>
<ul>
<li>
<p><a href="https://grahamc.com/blog/erase-your-darlings/">Erase your Darlings (ZFS)</a></p>
</li>
<li>
<p><a href="https://saylesss88.github.io/installation/enc/encrypted_impermanence.html">Encrypted BTRFS Impermanence Guide</a>
Only follow this guide if you also followed the encrypted disko install,
impermanence is designed to be destructive and needs to match your config
exactly.</p>
</li>
</ul>
<h2 id="replace-timesyncd-with-a-chron-job-that-enables-network-time-security-nts"><a class="header" href="#replace-timesyncd-with-a-chron-job-that-enables-network-time-security-nts">Replace timesyncd with a chron job that enables Network Time Security (NTS)</a></h2>
<p>This is implementing the GrapheneOS/secureblue NTS chrony settings to NixOS:</p>
<pre><code class="language-nix">{ config
, ...
}:
{
  services.chrony = {
    enable = true;
    enableNTS = true;
    servers = [
        "server time.cloudflare.com iburst nts"
        "server ntppool1.time.nl iburst nts"
        "server nts.netnod.se iburst nts"
        "server ptbtime1.ptb.de iburst nts"
        "server time.dfm.dk iburst nts"
        "server time.cifelli.xyz iburst nts"
     ];
    # havent worked out the kinks yet
  #  extraConfig = ''
  #      minsources 3
  #      authselectmode require

  #      # EF
  #      dscp 46

  #      driftfile /var/lib/chrony/drift
  #      dumpdir /var/lib/chrony
  #      ntsdumpdir /var/lib/chrony

  #      leapseclist /usr/share/zoneinfo/leap-seconds.list
  #      makestep 1.0 3

  #      rtconutc

  #      cmdport 0

  #      noclientlog
  #  '';
  };
}
</code></pre>
<p>Ensure NTS is being used with:</p>
<pre><code class="language-bash">sudo chronyc -N authdata
</code></pre>
<hr>
<h2 id="secure-boot"><a class="header" href="#secure-boot">Secure Boot</a></h2>
<!-- ![Virus](../images/virus1.png) -->
<p>Enable a UEFI password or Administrator password where it requires
authentication in order to access the UEFI/BIOS.</p>
<p>Secure Boot helps ensure only signed, trusted kernels and bootloaders are
executed at startup.</p>
<p>Useful Resources:</p>
<details>
<summary> ‚úîÔ∏è Click to Expand Secure Boot Resources </summary>
<ul>
<li>
<p><a href="https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html">The Strange State of Authenticated Boot and Encryption</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Secure_Boot">NixOS Wiki Secure Boot</a></p>
</li>
<li>
<p><a href="https://github.com/nix-community/lanzaboote">lanzaboote repo</a></p>
</li>
</ul>
</details>
<p>Practical Lanzaboote Secure Boot setup for NixOS:
<a href="https://saylesss88.github.io/installation/enc/lanzaboote.html">Guide:Secure Boot on NixOS with Lanzaboote</a></p>
<hr>
<h3 id="the-kernel"><a class="header" href="#the-kernel">The Kernel</a></h3>
<p>The Kernel Self Protection Project:</p>
<ul>
<li><a href="https://kspp.github.io/Recommended_Settings">KSPP Recommended_Settings</a></li>
</ul>
<p>Given the kernel‚Äôs central role, it‚Äôs a frequent target for malicious actors,
making robust hardening essential.</p>
<p>NixOS provides a <code>hardened</code> profile that applies a set of security-focused
kernel and system configurations.</p>
<p>For flakes, you could do something like the following in your
<code>configuration.nix</code> or equivalent to import <code>hardened.nix</code> and enable
<code>profiles.hardened</code>:</p>
<pre><code class="language-nix"># configuration.nix
{ pkgs, inputs, ... }: let
   modulesPath = "${inputs.nixpkgs}/nixos/modules";

in {
  imports = [ "${modulesPath}/profiles/hardened.nix" ];

}
</code></pre>
<ul>
<li>
<p>There is a proposal to remove it completely that has gained ground, the
following thread discusses why:
<a href="https://discourse.nixos.org/t/proposal-to-deprecate-the-hardened-profile/63081">Discourse Thread</a></p>
</li>
<li>
<p><a href="https://github.com/NixOS/nixpkgs/pull/383438">PR #383438</a> Proposed removal
PR.</p>
</li>
<li>
<p>Check
<a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/profiles/hardened.nix">hardened.nix</a>
to see exactly what adding it enables to avoid duplicates and conflicts moving
on. I included this for completeness, the choice is yours if you want to use
it or not.</p>
</li>
</ul>
<h2 id="choosing-your-kernel"><a class="header" href="#choosing-your-kernel">Choosing your Kernel</a></h2>
<p>See which kernel you‚Äôre currently using with:</p>
<pre><code class="language-bash"># show the kernel release
uname -r
# show kernel version, hostname, and architecture
uname -a
</code></pre>
<p>Show the configuration of your current kernel:</p>
<pre><code class="language-bash">zcat /proc/config.gz
# ...snip...
#
# Compression
#
CONFIG_CRYPTO_DEFLATE=m
CONFIG_CRYPTO_LZO=y
CONFIG_CRYPTO_842=m
CONFIG_CRYPTO_LZ4=m
CONFIG_CRYPTO_LZ4HC=m
CONFIG_CRYPTO_ZSTD=y
# end of Compression
# ...snip...
</code></pre>
<p>The <a href="https://nixos.org/manual/nixos/stable/#sec-kernel-config">NixOS Manual</a>
states that the default Linux kernel configuration should be fine for most
users.</p>
<p>The Linux kernel is typically released under two forms: stable and long-term
support (LTS). Choosing either has consequences, do your research.
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#stable-vs-lts">Stable vs. LTS kernels</a></p>
<ul>
<li><a href="https://www.kernel.org/category/releases.html">The Linux Kernel Archives Active kernel releases</a></li>
</ul>
<p><strong>OR</strong>, you can choose the hardened kernel for a kernel that prioritizes
security over everything else.</p>
<hr>
<h3 id="the-hardened-kernel"><a class="header" href="#the-hardened-kernel">The Hardened Kernel</a></h3>
<blockquote>
<p>NOTE: Expect breakage when using the hardened kernel. <code>linux-hardened</code>
completely disables
<a href="https://secureblue.dev/articles/userns">unprivileged user namespaces</a>, which
are required for Flatpak, chromium-based browsers, and more.</p>
</blockquote>
<p>The <code>linuxPackages_latest_hardened</code> attribute has been deprecated. If you want
to use a hardened kernel, it is now recommended to use <code>linux_hardened</code>, which
is aliased to <code>linux_default.kernel</code>.</p>
<p>You can find the latest available hardened kernel packages by searching
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/linux-kernels.nix">pkgs/top-level/linux-kernels.nix</a>.</p>
<p>It is recommended to use <code>linux_hardened</code> without specifying a version, such as:</p>
<pre><code class="language-nix">boot.kernelPackages = pkgs.linuxPackages_hardened;
</code></pre>
<p><code>linux_hardened</code> is aliased to the <code>linux_default.kernel</code>.</p>
<p>Note that this not only replaces the kernel, but also packages that are specific
to the kernel version, such as NVIDIA video drivers. This also removes your
ability to use the <code>.extend</code> kernel attribute, they are only available to
<em>kernel package sets</em> (e.g., <code>linuxPackages_hardened</code>)</p>
<ul>
<li>If you decide to use this, read further before rebuilding.</li>
</ul>
<p>You can inspect
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/os-specific/linux/kernel/hardened/patches.json">nixpkgs/pkgs/os-specific/linux/kernel/hardened/patches.json</a>
to see the metadata of the patches that are applied. You can then follow the
links in the <code>.json</code> file to see the patch diffs.</p>
<hr>
<h3 id="sysctl"><a class="header" href="#sysctl">sysctl</a></h3>
<p>A tool for checking the security hardening options of the Linux kernel:</p>
<pre><code class="language-nix">environment.systemPackages = [ pkgs.kernel-hardening-checker ];
</code></pre>
<p><code>sysctl</code> is a tool that allows you to view or modify kernel settings and
enable/disable different features.</p>
<p>Check all <code>sysctl</code> parameters against the <code>kernel-hardening-checker</code>
recommendations:</p>
<pre><code class="language-bash">sudo sysctl -a &gt; params.txt
kernel-hardening-checker -l /proc/cmdline -c /proc/config.gz -s ./params.txt
</code></pre>
<p>Check the value of a specific parameter:</p>
<pre><code class="language-bash">sudo sysctl -a | grep "kernel.kptr_restrict"
# Output:
kernel.kptr_restrict = 2
</code></pre>
<p>Check Active Linux Security Modules:</p>
<pre><code class="language-bash">cat /sys/kernel/security/lsm
# Output:
File: /sys/kernel/security/lsm
capability,landlock,yama,bpf,apparmor
</code></pre>
<p>Check Kernel Configuration Options:</p>
<pre><code class="language-bash">zcat /proc/config.gz | grep CONFIG_SECURITY_SELINUX
zcat /proc/config.gz | grep CONFIG_HARDENED_USERCOPY
zcat /proc/config.gz | grep CONFIG_STACKPROTECTOR
</code></pre>
<p>Since it is difficult to see exactly what enabling the hardened_kernel does.
Before rebuilding, you could do something like this to see exactly what is
added:</p>
<pre><code class="language-bash">sudo sysctl -a &gt; before.txt
</code></pre>
<p>And after the rebuild:</p>
<pre><code class="language-bash">sudo sysctl -a &gt; after.txt
</code></pre>
<p>And finally run a <code>diff</code> on them:</p>
<pre><code class="language-bash">diff before.txt after.txt
</code></pre>
<p>You can also diff against <code>after.txt</code> for future changes to avoid duplicates,
this seems easier to me than trying to parse through the patches.</p>
<hr>
<h2 id="kernel-security-settings"><a class="header" href="#kernel-security-settings">Kernel Security Settings</a></h2>
<pre><code class="language-nix">security = {
      protectKernelImage = true;
      lockKernelModules = false; # this breaks iptables, wireguard, and virtd

      # force-enable the Page Table Isolation (PTI) Linux kernel feature
      forcePageTableIsolation = true;

      # User namespaces are required for sandboxing.
      # this means you cannot set `"user.max_user_namespaces" = 0;` in sysctl
      allowUserNamespaces = true;

      # Disable unprivileged user namespaces, unless containers are enabled
      unprivilegedUsernsClone = config.virtualisation.containers.enable;
      allowSimultaneousMultithreading = true;
}
</code></pre>
<hr>
<h2 id="further-hardening-with-sysctl"><a class="header" href="#further-hardening-with-sysctl">Further Hardening with sysctl</a></h2>
<p><code>sysctl</code> hardening settings further reinforce kernel-level protections. The
hardened kernel includes security patches and stricter defaults, but it doesn‚Äôt
cover all runtime tunables. Refer to the above commands to get a diff of the
changes.</p>
<p><a href="https://nixos.org/manual/nixos/stable/options#opt-boot.kernel.sysctl">boot.kernel.sysctl</a>:
Runtime parameters of the Linux kernel, as set by sysctl(8). Note that the
sysctl parameters names must be enclosed in quotes. Values may be a string,
integer, boolean, or null.</p>
<p>Check what each setting does <a href="https://sysctl-explorer.net/">sysctl-explorer</a></p>
<p>Refer to
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#sysctl-kernel">madadaidans-insecurities#sysctl-kernel</a>
for the following settings and their explainations.</p>
<p>Also see the
<a href="https://kspp.github.io/Recommended_Settings#sysctls">Kernel Self Protection Projects sysctls</a></p>
<pre><code class="language-nix">  boot.kernel.sysctl = {
    "fs.suid_dumpable" = 0;
    # prevent pointer leaks
    "kernel.kptr_restrict" = 2;
    # restrict kernel log to CAP_SYSLOG capability
    "kernel.dmesg_restrict" = 1;
    # Note: certian container runtimes or browser sandboxes might rely on the following
    # restrict eBPF to the CAP_BPF capability
    "kernel.unprivileged_bpf_disabled" = 1;
    # should be enabled along with bpf above
    # "net.core.bpf_jit_harden" = 2;
    # restrict loading TTY line disciplines to the CAP_SYS_MODULE
    "dev.tty.ldisk_autoload" = 0;
    # prevent exploit of use-after-free flaws
    "vm.unprivileged_userfaultfd" = 0;
    # kexec is used to boot another kernel during runtime and can be abused
    "kernel.kexec_load_disabled" = 1;
    # Kernel self-protection
    # SysRq exposes a lot of potentially dangerous debugging functionality to unprivileged users
    # 4 makes it so a user can only use the secure attention key. A value of 0 would disable completely
    "kernel.sysrq" = 4;
    # disable unprivileged user namespaces, Note: Docker, NH, and other apps may need this
    # "kernel.unprivileged_userns_clone" = 0; # Set to 1 because it makes NH and other programs fail
    # This should be set to 0 if you don't rely on flatpak, NH, Docker, etc.
    "kernel.unprivileged_userns_clone" = 1;
    # restrict all usage of performance events to the CAP_PERFMON capability
    "kernel.perf_event_paranoid" = 3;

    # Network
    # protect against SYN flood attacks (denial of service attack)
    "net.ipv4.tcp_syncookies" = 1;
    # protection against TIME-WAIT assassination
    "net.ipv4.tcp_rfc1337" = 1;
    # enable source validation of packets received (prevents IP spoofing)
    "net.ipv4.conf.default.rp_filter" = 1;
    "net.ipv4.conf.all.rp_filter" = 1;

    "net.ipv4.conf.all.accept_redirects" = 0;
    "net.ipv4.conf.default.accept_redirects" = 0;
    "net.ipv4.conf.all.secure_redirects" = 0;
    "net.ipv4.conf.default.secure_redirects" = 0;
    # Protect against IP spoofing
    "net.ipv6.conf.all.accept_redirects" = 0;
    "net.ipv6.conf.default.accept_redirects" = 0;
    "net.ipv4.conf.all.send_redirects" = 0;
    "net.ipv4.conf.default.send_redirects" = 0;

    # prevent man-in-the-middle attacks
    "net.ipv4.icmp_echo_ignore_all" = 1;

    # ignore ICMP request, helps avoid Smurf attacks
    "net.ipv4.conf.all.forwarding" = 0;
    "net.ipv4.conf.default.accept_source_route" = 0;
    "net.ipv4.conf.all.accept_source_route" = 0;
    "net.ipv6.conf.all.accept_source_route" = 0;
    "net.ipv6.conf.default.accept_source_route" = 0;
    # Reverse path filtering causes the kernel to do source validation of
    "net.ipv6.conf.all.forwarding" = 0;
    "net.ipv6.conf.all.accept_ra" = 0;
    "net.ipv6.conf.default.accept_ra" = 0;

    ## TCP hardening
    # Prevent bogus ICMP errors from filling up logs.
    "net.ipv4.icmp_ignore_bogus_error_responses" = 1;

    # Userspace
    # restrict usage of ptrace
    "kernel.yama.ptrace_scope" = 2;

    # ASLR memory protection (64-bit systems)
    "vm.mmap_rnd_bits" = 32;
    "vm.mmap_rnd_compat_bits" = 16;

    # only permit symlinks to be followed when outside of a world-writable sticky directory
    "fs.protected_symlinks" = 1;
    "fs.protected_hardlinks" = 1;
    # Prevent creating files in potentially attacker-controlled environments
    "fs.protected_fifos" = 2;
    "fs.protected_regular" = 2;

    # Randomize memory
    "kernel.randomize_va_space" = 2;
    # Exec Shield (Stack protection)
    "kernel.exec-shield" = 1;

    ## TCP optimization
    # TCP Fast Open is a TCP extension that reduces network latency by packing
    # data in the sender‚Äôs initial TCP SYN. Setting 3 = enable TCP Fast Open for
    # both incoming and outgoing connections:
    "net.ipv4.tcp_fastopen" = 3;
    # Bufferbloat mitigations + slight improvement in throughput &amp; latency
    "net.ipv4.tcp_congestion_control" = "bbr";
    "net.core.default_qdisc" = "cake";
  };
</code></pre>
<blockquote>
<p>‚ùó Note: The above settings are fairly aggressive and can break common
programs, read the comment warnings.</p>
</blockquote>
<hr>
<h2 id="hardening-boot-parameters"><a class="header" href="#hardening-boot-parameters">Hardening Boot Parameters</a></h2>
<p><code>boot.kernelParams</code> can be used to set additional kernel command line arguments
at boot time. It can only be used for built-in modules.</p>
<p>You can find the following settings in the
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#boot-parameters">Boot parameters section</a></p>
<pre><code class="language-nix"># boot.nix
      boot.kernelParams = [
        # make it harder to influence slab cache layout
        "slab_nomerge"
        # enables zeroing of memory during allocation and free time
        # helps mitigate use-after-free vulnerabilaties
        "init_on_alloc=1"
        "init_on_free=1"
        # randomizes page allocator freelist, improving security by
        # making page allocations less predictable
        "page_alloc.shuffel=1"
        # enables Kernel Page Table Isolation, which mitigates Meltdown and
        # prevents some KASLR bypasses
        "pti=on"
        # randomizes the kernel stack offset on each syscall
        # making attacks that rely on a deterministic stack layout difficult
        "randomize_kstack_offset=on"
        # disables vsyscalls, they've been replaced with vDSO
        "vsyscall=none"
        # disables debugfs, which exposes sensitive info about the kernel
        "debugfs=off"
        # certain exploits cause an "oops", this makes the kernel panic if an "oops" occurs
        "oops=panic"
        # only alows kernel modules that have been signed with a valid key to be loaded
        # making it harder to load malicious kernel modules
        # can make VirtualBox or Nvidia drivers unusable
        "module.sig_enforce=1"
        # prevents user space code excalation
        "lockdown=confidentiality"
        # "rd.udev.log_level=3"
        # "udev.log_priority=3"
      ];
</code></pre>
<p>This is a thoughtful start to hardening boot parameters, there are more
recommendations in the guide.</p>
<p>Kernel modules for hardware devices are generally loaded automatically by
<code>udev</code>. You can force a module to be loaded via <code>boot.kernelModules</code>.</p>
<hr>
<p><strong>Hardening Modprobe</strong></p>
<p>You can use both <code>extraModprobeConfig</code> &amp; <code>blacklistedKernelModules</code> to disable
different features. If you prefer, you can place these in the next section as
well.</p>
<pre><code class="language-nix">boot.extraModprobeConfig = ''
     # firewire and thunderbolt
    install firewire-core /bin/false
    install firewire_core /bin/false
    install firewire-ohci /bin/false
    install firewire_ohci /bin/false
    install firewire_sbp2 /bin/false
    install firewire-sbp2 /bin/false
    install firewire-net /bin/false
    install thunderbolt /bin/false
    install ohci1394 /bin/false
    install sbp2 /bin/false
    install dv1394 /bin/false
    install raw1394 /bin/false
    install video1394 /bin/false
'';
# OR
#boot.blacklistedKernelModules = [
#  "firewire-core"
#  # ... snip ...
#];
</code></pre>
<hr>
<p><strong>Blacklisting Kernel Parameters</strong></p>
<p>Blacklisting unused kernel modules reduces the attack surface.</p>
<p><a href="https://nixos.org/manual/nixos/stable/options#opt-boot.blacklistedKernelModules">boot.blacklistedKernelModules</a>:
List of names of kernel modules that should not be loaded automatically by the
hardware probing code.</p>
<p>You can find the following settings in the
<a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html#kasr-kernel-modules">Blacklisting Kernel Modules Section</a></p>
<pre><code class="language-nix">      boot.blacklistedKernelModules = [
        # Obscure networking protocols
        "dccp"   # Datagram Congestion Control Protocol
        "sctp"  # Stream Control Transmission Protocol
        "rds"  # Reliable Datagram Sockets
        "tipc"  # Transparent Inter-Process Communication
        "n-hdlc" # High-level Data Link Control
        "ax25"  # Amateur X.25
        "netrom"  # NetRom
        "x25"     # X.25
        "rose"
        "decnet"
        "econet"
        "af_802154"  # IEEE 802.15.4
        "ipx"  # Internetwork Packet Exchange
        "appletalk"
        "psnap"  # SubnetworkAccess Protocol
        "p8023"  # Novell raw IEE 802.3
        "p8022"  # IEE 802.3
        "can"   # Controller Area Network
        "atm"
        # Various rare filesystems
        "cramfs"
        "freevxfs"
        "jffs2"
        "hfs"
        "hfsplus"
        "udf"

        # "squashfs"  # compressed read-only file system used for Live CDs
        # "cifs"  # cmb (Common Internet File System)
        # "nfs"  # Network File System
        # "nfsv3"
        # "nfsv4"
        # "ksmbd"  # SMB3 Kernel Server
        # "gfs2"  # Global File System 2
        # vivid driver is only useful for testing purposes and has been the
        # cause of privilege escalation vulnerabilities
        # "vivid"
      ];
</code></pre>
<p>As with the <code>kernelParameters</code> above, there are more suggestions in the guide, I
have used the above parameters along with the commented out ones and had no
issues.</p>
<p>Also see
<a href="https://github.com/secureblue/secureblue/blob/live/files/system/etc/modprobe.d/blacklist.conf">SecureBlue‚Äôs blacklist.conf</a>
for more ideas.</p>
<hr>
<h2 id="hardened-memory-allocator"><a class="header" href="#hardened-memory-allocator">Hardened Memory Allocator</a></h2>
<blockquote>
<p>NOTE: There is a performance cost to enabling a hardened memory allocator, and
some apps will not work without a workaround such as Firefox, Thunderbird,
Torbrowser, LibreWolf, and ZenBrowser to name a few.</p>
</blockquote>
<p>With memory corruption bugs being the leading zero day category, it‚Äôs clearly
something that you should be concerned with.</p>
<p>The grapheneOS <code>hardened_malloc</code> is available for NixOS in two variants, add
either to your <code>configuration.nix</code> or equivalent to apply them:</p>
<ol>
<li>
<p><code>environment.memoryAllocator.provider = "graphene-hardened";</code>: This is the
default configuration template that has all normal optional security features
enabled. It‚Äôs aggressive, you can expect app breakage and a performance cost.</p>
</li>
<li>
<p><code>environment.memoryAllocator.provider = "graphene-hardened-light";</code>: The
light template disables the slap quarantines, write after free check, slot
randomization and raises the guard slab interval from 1 to 8 but leaves
zero-on-free and slab canaries enabled. This version has solid performance
and is still far more secure than the standard allocator.</p>
</li>
</ol>
<p><code>libhardened_malloc.so</code> is typically installed to
<code>/usr/local/lib/libhardened_malloc.so</code> and referenced from <code>/etc/ld.so.preload</code>.</p>
<ul>
<li>
<p><a href="https://nixos.org/manual/nixos/stable/options#opt-environment.memoryAllocator.provider">NixOS Manual memoryAllocator</a></p>
</li>
<li>
<p><a href="https://github.com/GrapheneOS/hardened_malloc?tab=readme-ov-file#traditional-linux-based-operating-systems">GrapheneOS hardened_malloc</a></p>
</li>
<li>
<p><a href="https://github.com/secureblue/secureblue/issues/193#issuecomment-1953323680">GrapheneOS/secureblue discussion on hardened_malloc issues</a></p>
</li>
<li>
<p><a href="https://man7.org/linux/man-pages/man8/ld.so.8.html">ld.so man page</a></p>
</li>
<li>
<p><a href="https://www.synacktiv.com/en/publications/exploring-grapheneos-secure-allocator-hardened-malloc">Exploring hardened_malloc</a></p>
</li>
</ul>
<hr>
<h2 id="hardening-systemd"><a class="header" href="#hardening-systemd">Hardening Systemd</a></h2>
<!-- ![Hacker](../images/hacker.png) -->
<p><code>systemd</code> is the core ‚Äúinit system‚Äù and service manager that controls how
services, daemons, and basic system processes are started, stopped and
supervised on modern Linux distributions, including NixOS. It provides a suite
of basic building blocks for a Linux system as well as a system and service
manager that runs as <code>PID 1</code> and starts the rest of the system.</p>
<p>Because it launches and supervises almost all system services, hardening systemd
means raising the baseline security of your entire system.</p>
<p>Disable coredumps:</p>
<pre><code class="language-nix">systemd.coredump.enable = false;
# ‚û°Ô∏è Sets the kernel's resource limit (ulimit -c 0)
  security.pam.loginLimits = [
    {
      domain = "*"; # Applies to all users/sessions
      type = "-"; # Set both soft and hard limits
      item = "core"; # The soft/hard limit item
      value = "0";   # Core dumps size is limited to 0 (effectively disabled)
    }
  ];
</code></pre>
<p>Disabling coredumps helps save space and improves security/privacy because when
a program fails, a coredump contains an exact copy of a programs running memory
at the time of the crash. This can inadvertently expose sensitive data.</p>
<p>If a program is handling private information when it crashes, the core dump file
could contain:</p>
<ul>
<li>
<p><strong>Passwords</strong>: Stored in memory before being sent or hashed.</p>
</li>
<li>
<p><strong>Encryption Keys</strong>: Used for securing network connections.</p>
</li>
<li>
<p><strong>Personal Info</strong>: Chat messages, website forms, etc.</p>
</li>
</ul>
<p>It can give a minor performance upgrade and does reduce the attack surface. If a
malicious program were to gain access to your system, one of the first things it
might look for are core dump files to extract sensitive data. By disabling them,
you eliminate this potential source of information leakage.</p>
<p><code>dbus-broker</code> is generally considered more secure and robust but isn‚Äôt the
default as of yet. To set <code>dbus-broker</code> as the default:</p>
<pre><code class="language-nix">  users.groups.netdev = {};
  services = {
    dbus.implementation = "broker";
    logrotate.enable = true;
    journald = {
      storage = "volatile"; # Store logs in memory
      upload.enable = false; # Disable remote log upload (the default)
      extraConfig = ''
        SystemMaxUse=500M
        SystemMaxFileSize=50M
      '';
    };
  };
</code></pre>
<ul>
<li>
<p><code>dbus-broker</code> is more resilient to resource exhaustion attacks and integrates
better with Linux security features.</p>
</li>
<li>
<p><a href="https://dvdhrm.github.io/rethinking-the-dbus-message-bus/">Rethinking-the-dbus-message-bus</a></p>
</li>
<li>
<p>Setting <code>storage = "volatile"</code> tells journald to keep log data only in memory.
There is a tradeoff though, If you need long-term auditing or troubleshooting
after a reboot, this will not preserve system logs.</p>
</li>
<li>
<p><code>upload.enable</code> is for forwarding log messages to remote servers, setting this
to false prevents accidental leaks of potentially sensitive or internal system
information.</p>
</li>
<li>
<p>Enabling <code>logrotate</code> prevents your disk from filling with excessive
<strong>legacy/service</strong> log files. These are the classic plain-text logs.</p>
</li>
<li>
<p>Systemd uses <code>journald</code> which stores logs in a binary format</p>
</li>
</ul>
<p>You can check the security status with:</p>
<pre><code class="language-bash">systemd-analyze security
# or for a detailed view of individual services security posture
systemd-analyze security NetworkManager
</code></pre>
<p>Optionally disable vulnerable services to reduce the attack surface, obviously
don‚Äôt disable what you need, or change your habits:</p>
<pre><code class="language-nix">services = {
    # mDNS/DNS-SD
    avahi.enable = false;
    # Geoclue (location services)
    geoclue2.enable = false;
    udisks2.enable = false;
    accounts-daemon.enable = false;
  };
  # Only needed for WWAN/3G/4G modems, otherwise it runs `mmcli` unnecessarily
  networking.modemmanager.enable = false;
  # Bluetooth has a long history of vulnerabilities
  hardware.bluetooth.enable = false;
  # Prefer manual upgrades on a hardened system
  system.autoUpgrade.enable = false;
</code></pre>
<p>Further reading on systemd:</p>
<details>
<summary> ‚úîÔ∏è Click to Expand Systemd Resources </summary>
<ul>
<li>
<p><a href="https://systemd.io/">systemd.io</a></p>
</li>
<li>
<p><a href="https://0pointer.de/blog/projects/systemd.html">Rethinking PID 1</a></p>
</li>
<li>
<p><a href="https://0pointer.de/blog/projects/the-biggest-myths.html">Biggest Myths about Systemd</a></p>
</li>
</ul>
</details>
<p>The following is a repo containing many of the Systemd hardening settings in
NixOS format:</p>
<p><a href="https://github.com/wallago/nix-system-services-hardened">nix-system-services-hardened</a></p>
<p>For example, to harden bluetooth you could add the following to your
<code>configuration.nix</code> or equivalent:</p>
<pre><code class="language-nix">systemd.services = {
      bluetooth.serviceConfig = {
      ProtectKernelTunables = lib.mkDefault true;
      ProtectKernelModules = lib.mkDefault true;
      ProtectKernelLogs = lib.mkDefault true;
      ProtectHostname = true;
      ProtectControlGroups = true;
      ProtectProc = "invisible";
      SystemCallFilter = [
        "~@obsolete"
        "~@cpu-emulation"
        "~@swap"
        "~@reboot"
        "~@mount"
      ];
      SystemCallArchitectures = "native";
    };
}
</code></pre>
<p>As you can see from above, you typically use the <code>serviceConfig</code> attribute to
harden settings for systemd services.</p>
<pre><code class="language-bash">systemd-analyze security bluetooth
‚Üí Overall exposure level for bluetooth.service: 3.3 OK üôÇ
</code></pre>
<details>
<summary> Click to expand `systemd.nix` example implementing many of the recommendations </summary>
<pre><code class="language-nix">{lib, ...}: {
  systemd.services = {
    # "home-manager-jr".after = ["network-online.target"];
    # "home-manager-jr".wantedBy = ["multi-user.target"];
    "user@".serviceConfig = {
      ProtectSystem = "strict";
      ProtectClock = true;
      ProtectHostname = true;
      ProtectKernelTunables = true;
      ProtectKernelModules = true;
      ProtectKernelLogs = true;
      ProtectProc = "invisible";
      PrivateTmp = true;
      PrivateNetwork = true;
      MemoryDenyWriteExecute = false;
      RestrictAddressFamilies = [
        "AF_UNIX"
        "AF_NETLINK"
        "AF_BLUETOOTH"
      ];
      RestrictNamespaces = true;
      RestrictRealtime = true;
      RestrictSUIDSGID = true;
      SystemCallFilter = [
        "~@keyring"
        "~@swap"
        "~@debug"
        "~@module"
        "~@obsolete"
        "~@cpu-emulation"
      ];
      SystemCallArchitectures = "native";
    };
    acpid.serviceConfig = {
      ProtectSystem = "full";
      ProtectHome = true;
      RestrictAddressFamilies = ["AF_INET" "AF_INET6"];
      SystemCallFilter = "~@clock @cpu-emulation @debug @module @mount @raw-io @reboot @swap";
      ProtectKernelTunables = true;
      ProtectKernelModules = true;
    };

    auditd.serviceConfig = {
      NoNewPrivileges = true;
      ProtectSystem = "full";
      ProtectHome = true;
      ProtectHostname = true;
      ProtectKernelTunables = true;
      ProtectKernelModules = true;
      ProtectControlGroups = true;
      ProtectProc = "invisible";
      ProtectClock = true;
      PrivateTmp = true;
      PrivateNetwork = true;
      PrivateMounts = true;
      PrivateDevices = true;
      RestrictNamespaces = true;
      RestrictRealtime = true;
      RestrictSUIDSGID = true;
      RestrictAddressFamilies = [
        "~AF_INET6"
        "~AF_INET"
        "~AF_PACKET"
      ];
      MemoryDenyWriteExecute = true;
      LockPersonality = true;
      SystemCallFilter = [
        "~@clock"
        "~@module"
        "~@mount"
        "~@swap"
        "~@obsolete"
        "~@cpu-emulation"
      ];
      SystemCallArchitectures = "native";
      CapabilityBoundingSet = [
        "~CAP_CHOWN"
        "~CAP_FSETID"
        "~CAP_SETFCAP"
      ];
    };

    cups.serviceConfig = {
      NoNewPrivileges = true;
      ProtectSystem = "full";
      ProtectHome = true;
      ProtectKernelModules = true;
      ProtectKernelTunables = true;
      ProtectKernelLogs = true;
      ProtectControlGroups = true;
      ProtectHostname = true;
      ProtectClock = true;
      ProtectProc = "invisible";
      RestrictRealtime = true;
      RestrictNamespaces = true;
      RestrictSUIDSGID = true;
      RestrictAddressFamilies = [
        "AF_UNIX"
        "AF_NETLINK"
        "AF_INET"
        "AF_INET6"
        "AF_PACKET"
      ];

      MemoryDenyWriteExecute = true;
      SystemCallFilter = [
        "~@clock"
        "~@reboot"
        "~@debug"
        "~@module"
        "~@swap"
        "~@obsolete"
        "~@cpu-emulation"
      ];
      SystemCallArchitectures = "native";
      LockPersonality = true;
    };

    NetworkManager.serviceConfig = {
      NoNewPrivileges = true;
      ProtectHome = true;
      ProtectKernelModules = true;
      ProtectKernelLogs = true;
      ProtectControlGroups = true;
      ProtectClock = true;
      ProtectHostname = true;
      ProtectProc = "invisible";
      PrivateTmp = true;
      RestrictRealtime = true;
      RestrictAddressFamilies = [
        "AF_UNIX"
        "AF_NETLINK"
        "AF_INET"
        "AF_INET6"
        "AF_PACKET"
      ];
      RestrictNamespaces = true;
      RestrictSUIDSGID = true;
      MemoryDenyWriteExecute = true;
      SystemCallFilter = [
        "~@mount"
        "~@module"
        "~@swap"
        "~@obsolete"
        "~@cpu-emulation"
        "ptrace"
      ];
      SystemCallArchitectures = "native";
      LockPersonality = true;
    };

    wpa_supplicant.serviceConfig = {
      NoNewPrivileges = true;
      ProtectSystem = "strict";
      ProtectHome = true;
      ProtectKernelModules = true;
      ProtectKernelLogs = true;
      ProtectControlGroups = true;
      ProtectClock = true;
      ProtectHostname = true;
      ProtectProc = "invisible";
      PrivateTmp = true;
      PrivateMounts = true;
      RestrictRealtime = true;
      RestrictAddressFamilies = [
        "AF_UNIX"
        "AF_NETLINK"
        "AF_INET"
        "AF_INET6"
        "AF_PACKET"
      ];
      RestrictNamespaces = true;
      RestrictSUIDSGID = true;
      MemoryDenyWriteExecute = true;
      SystemCallFilter = [
        "~@mount"
        "~@raw-io"
        "~@privileged"
        "~@keyring"
        "~@reboot"
        "~@module"
        "~@swap"
        "~@resources"
        "~@obsolete"
        "~@cpu-emulation"
        "ptrace"
      ];
      SystemCallArchitectures = "native";
      LockPersonality = true;
      CapabilityBoundingSet = "CAP_NET_ADMIN CAP_NET_RAW";
    };

    dbus.serviceConfig = {
      NoNewPrivileges = true;
      ProtectSystem = "stric";
      ProtectControlGroups = true;
      ProtectHome = true;
      ProtectHostname = true;
      ProtectKernelTunables = true;
      ProtectKernelModules = true;
      ProtectKernelLogs = true;
      PrivateMounts = true;
      PrivateDevices = true;
      PrivateTmp = true;
      RestrictSUIDSGID = true;
      RestrictRealtime = true;
      RestrictAddressFamilies = [
        "AF_UNIX"
      ];
      RestrictNamespaces = true;
      SystemCallErrorNumber = "EPERM";
      SystemCallArchitectures = "native";
      SystemCallFilter = [
        "~@obsolete"
        "~@resources"
        "~@debug"
        "~@mount"
        "~@reboot"
        "~@swap"
        "~@cpu-emulation"
      ];
      LockPersonality = true;
      IPAddressDeny = ["0.0.0.0/0" "::/0"];
      MemoryDenyWriteExecute = true;
      DevicePolicy = "closed";
      UMask = 0077;
    };

    nscd.serviceConfig = {
      ProtectClock = true;
      ProtectHostname = true;
      ProtectKernelTunables = true;
      ProtectKernelModules = true;
      ProtectKernelLogs = true;
      ProtectControlGroups = true;
      ProtectProc = "invisible";
      RestrictNamespaces = true;
      RestrictRealtime = true;
      MemoryDenyWriteExecute = true;
      LockPersonality = true;
      SystemCallFilter = [
        "~@mount"
        "~@swap"
        "~@clock"
        "~@obsolete"
        "~@cpu-emulation"
      ];
      SystemCallArchitectures = "native";
      CapabilityBoundingSet = [
        "~CAP_CHOWN"
        "~CAP_FSETID"
        "~CAP_SETFCAP"
      ];
    };
    bluetooth.serviceConfig = {
      ProtectKernelTunables = lib.mkDefault true;
      ProtectKernelModules = lib.mkDefault true;
      ProtectKernelLogs = lib.mkDefault true;
      ProtectHostname = true;
      ProtectControlGroups = true;
      ProtectProc = "invisible";
      SystemCallFilter = [
        "~@obsolete"
        "~@cpu-emulation"
        "~@swap"
        "~@reboot"
        "~@mount"
      ];
      SystemCallArchitectures = "native";
    };
    systemd-rfkill.serviceConfig = {
      ProtectSystem = "strict";
      ProtectHome = true;
      ProtectKernelTunables = true;
      ProtectKernelModules = true;
      ProtectControlGroups = true;
      ProtectClock = true;
      ProtectProc = "invisible";
      ProcSubset = "pid";
      PrivateTmp = true;
      MemoryDenyWriteExecute = true;
      NoNewPrivileges = true;
      LockPersonality = true;
      RestrictRealtime = true;
      SystemCallArchitectures = "native";
      UMask = "0077";
      IPAddressDeny = "any";
    };
    systemd-machined.serviceConfig = {
      NoNewPrivileges = true;
      ProtectSystem = "strict";
      ProtectHome = true;
      ProtectClock = true;
      ProtectHostname = true;
      ProtectKernelTunables = true;
      ProtectKernelModules = true;
      ProtectKernelLogs = true;
      ProtectProc = "invisible";
      PrivateTmp = true;
      PrivateMounts = true;
      PrivateUsers = true;
      PrivateNetwork = true;
      RestrictNamespaces = true;
      RestrictRealtime = true;
      RestrictSUIDSGID = true;
      RestrictAddressFamilies = ["AF_UNIX"];
      MemoryDenyWriteExecute = true;
      SystemCallArchitectures = "native";
    };
    systemd-udevd.serviceConfig = {
      NoNewPrivileges = true;
      ProtectSystem = "strict";
      ProtectHome = true;
      ProtectKernelLogs = true;
      ProtectControlGroups = true;
      ProtectClock = true;
      ProtectProc = "invisible";
      RestrictNamespaces = true;
      CapabilityBoundingSet = "~CAP_SYS_PTRACE ~CAP_SYS_PACCT";
    };
    nix-daemon.serviceConfig = {
      NoNewPrivileges = true;
      ProtectControlGroups = true;
      ProtectKernelModules = true;
      PrivateMounts = true;
      PrivateTmp = true;
      PrivateDevices = true;
      RestrictSUIDSGID = true;
      RestrictRealtime = true;
      RestrictNamespaces = ["~cgroup"];
      RestrictAddressFamilies = [
        "AF_UNIX"
        "AF_NETLINK"
        "AF_INET6"
        "AF_INET"
      ];
      CapabilityBoundingSet = [
        "~CAP_SYS_CHROOT"
        "~CAP_BPF"
        "~CAP_AUDIT_WRITE"
        "~CAP_AUDIT_CONTROL"
        "~CAP_AUDIT_READ"
        "~CAP_SYS_PTRACE"
        "~CAP_SYS_NICE"
        "~CAP_SYS_RESOURCE"
        "~CAP_SYS_RAWIO"
        "~CAP_SYS_TIME"
        "~CAP_SYS_PACCT"
        "~CAP_LINUX_IMMUTABLE"
        "~CAP_IPC_LOCK"
        "~CAP_WAKE_ALARM"
        "~CAP_SYS_TTY_CONFIG"
        "~CAP_SYS_BOOT"
        "~CAP_LEASE"
        "~CAP_BLOCK_SUSPEND"
        "~CAP_MAC_ADMIN"
        "~CAP_MAC_OVERRIDE"
      ];
      SystemCallErrorNumber = "EPERM";
      SystemCallArchitectures = "native";
      SystemCallFilter = [
        "~@resources"
        "~@module"
        "~@obsolete"
        "~@debug"
        "~@reboot"
        "~@swap"
        "~@cpu-emulation"
        "~@clock"
        "~@raw-io"
      ];
      LockPersonality = true;
      MemoryDenyWriteExecute = false;
      DevicePolicy = "closed";
      UMask = 0077;
    };
    systemd-journald.serviceConfig = {
      NoNewPrivileges = true;
      ProtectProc = "invisible";
      ProtectHostname = true;
      PrivateMounts = true;
    };
  };
}
</code></pre>
</details>
<hr>
<h2 id="lynis-and-other-tools"><a class="header" href="#lynis-and-other-tools">Lynis and other tools</a></h2>
<p>Lynis is a security auditing tool for systems based on UNIX like Linux, macOS,
BSD, and others.‚Äì<a href="https://github.com/CISOfy/lynis">lynis repo</a></p>
<p><code>chkrootkit</code> was removed as it is unmaintained and archived upstream.</p>
<p>Installation:</p>
<pre><code class="language-nix">environment.systemPackages = [
pkgs.lynis
pkgs.clamav
pkgs.aide
 ];
</code></pre>
<details>
<summary> ‚úîÔ∏è Click to Expand AIDE Example </summary>
<p>AIDE is an intrusion detection system (IDS) that will notify us whenever it
detects that a potential intrusion has occurred. When a system is compromised,
attackers typically will try to change file permissions and escalate to the root
user account and start to modify system files, AIDE can detect this.</p>
<p>To set up AIDE on your system follow these steps:</p>
<ol>
<li>Create the <code>aide.conf</code>:</li>
</ol>
<pre><code class="language-bash">sudo mkdir -p /var/lib/aide &amp;&amp; cd /var/lib/aide/
sudo hx aide.conf
</code></pre>
<p>Add the following content to <code>/var/lib/aide/aide.conf</code>:</p>
<pre><code class="language-conf"># aide.conf
# Example configuration file for AIDE.

@@define DBDIR /var/lib/aide

# The location of the database to be read.
database_in=file:@@{DBDIR}/aide.db.gz

# The location of the database to be written.
#database_out=sql:host:port:database:login_name:passwd:table
#database_out=file:aide.db.new
database_out=file:@@{DBDIR}/aide.db.new.gz

# Whether to gzip the output to database
gzip_dbout=yes

log_level=info

report_url=file:/var/log/aide/aide.log
report_url=stdout
#report_url=stderr
#NOT IMPLEMENTED report_url=mailto:root@foo.com
#NOT IMPLEMENTED report_url=syslog:LOG_AUTH

# These are the default rules.
#
#p:      permissions
#i:      inode:
#n:      number of links
#u:      user
#g:      group
#s:      size
#b:      block count
#m:      mtime
#a:      atime
#c:      ctime
#S:      check for growing size
#md5:    md5 checksum
#sha1:   sha1 checksum
#rmd160: rmd160 checksum
#tiger:  tiger checksum
#haval:  haval checksum
#gost:   gost checksum
#crc32:  crc32 checksum
#R:      p+i+n+u+g+s+m+c+md5
#L:      p+i+n+u+g
#E:      Empty group
#&gt;:      Growing logfile p+u+g+i+n+S

# You can create custom rules like this.

NORMAL = R+b+sha512

DIR = p+i+n+u+g

# Next decide what directories/files you want in the database.

/boot   NORMAL
/bin    NORMAL
/sbin   NORMAL
/lib    NORMAL
/opt    NORMAL
/usr    NORMAL
/root   NORMAL

# Check only permissions, inode, user and group for /etc, but
# cover some important files closely.
/etc    p+i+u+g
!/etc/mtab
/etc/exports  NORMAL
/etc/fstab    NORMAL
/etc/passwd   NORMAL
/etc/group    NORMAL
/etc/gshadow  NORMAL
/etc/shadow   NORMAL

/var/log   p+n+u+g

# With AIDE's default verbosity level of 5, these would give lots of
# warnings upon tree traversal. It might change with future version.
#
#=/lost\+found    DIR
#=/home           DIR
</code></pre>
<p>Create the logfile:</p>
<pre><code class="language-bash">sudo mkdir -p /var/log/aide
sudo touch /var/log/aide/aide.log
</code></pre>
<ol start="2">
<li>Generate the initial database, this will store the checksums of all files
that it‚Äôs configured to monitor. Take note of the location of the new
database, mine was <code>/etc/aide.db.new</code></li>
</ol>
<pre><code class="language-bash">sudo aide --config /var/lib/aide/aide.conf --init
</code></pre>
<ol start="3">
<li>Move the new database and remove the <code>.new</code>:</li>
</ol>
<pre><code class="language-bash">sudo mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
</code></pre>
<pre><code class="language-bash">ls /var/lib/aide/
aide.conf   aide.db.gz
</code></pre>
<ol start="4">
<li>Check with AIDE:</li>
</ol>
<pre><code class="language-bash">sudo aide --check --config /var/lib/aide/aide.conf
Start timestamp: 2025-09-05 09:50:07 -0400 (AIDE 0.19.2)
AIDE found NO differences between database and filesystem. Looks okay!!
</code></pre>
<ol start="5">
<li>Whenever you make changes to system files, or especially after running a
system update or installing new tools, you have to rescan all files to update
their checksums in the AIDE database:</li>
</ol>
<pre><code class="language-bash">sudo aide --update --config /var/lib/aide/aide.conf
</code></pre>
<p>Unfortunately, AIDE doesn‚Äôt automatically replace the old database so you have
to rename the new one again:</p>
<pre><code class="language-bash">sudo mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
</code></pre>
<p>And finally check again:</p>
<pre><code class="language-bash">sudo aide --check --config /var/lib/aide/aide.conf
</code></pre>
<ul>
<li><a href="https://linux.die.net/man/1/aide">aide(1) man page</a></li>
</ul>
</details>
<details>
<summary> ‚úîÔ∏è Click to Expand clamav.nix Example </summary>
<pre><code class="language-nix">{pkgs, ...}: {
  environment.systemPackages = with pkgs; [
    clamav
  ];
  services.clamav = {
    # Enable clamd daemon
    daemon.enable = true;
    updater.enable = true;
    updater.frequency = 12; # Number of database checks per day
    scanner = {
      enable = true;
      # 4:00 AM
      interval = "*-*-* 04:00:00";
      scanDirectories = [
        "/home"
        "/var/lib"
        "/tmp"
        "/etc"
        "/var/tmp"
      ];
    };
  };
}
</code></pre>
</details>
<p>Lynis Usage:</p>
<pre><code class="language-bash">sudo lynis show commands
# Output:
Commands:
lynis audit
lynis configure
lynis generate
lynis show
lynis update
lynis upload-only

sudo lynis audit system
# Output:
  Lynis security scan details:

  Hardening index : 79 [###############     ]
  Tests performed : 234
  Plugins enabled : 0

  Components:
  - Firewall               [V]
  - Malware scanner        [V]

  Scan mode:
  Normal [V]  Forensics [ ]  Integration [ ]  Pentest [ ]

  Lynis modules:
  - Compliance status      [?]
  - Security audit         [V]
  - Vulnerability scan     [V]
</code></pre>
<ul>
<li>
<p>The ‚ÄúLynis hardening index‚Äù is an overall impression on how well a system is
hardened. However, this is just an indicator on measures taken - not a
percentage of how safe a system might be. A score over 75 typically indicates
a system with more than average safety measures implemented.</p>
</li>
<li>
<p>Lynis will give you more recommendations for securing your system as well.</p>
</li>
</ul>
<p>If you use <code>clamscan</code>, create the following log file:</p>
<pre><code class="language-bash">sudo touch /var/log/clamscan.log
</code></pre>
<p>Example cron job for <code>clamav</code> &amp; <code>aide</code>:</p>
<pre><code class="language-nix">{pkgs, ...}: {
  services.cron = {
    enable = true;
    # messages.enable = true;
    systemCronJobs = [
      # Every day at 2:00 AM, run clamscan as root and append output to a log file
      "0 2 * * * root ${pkgs.clamav}/bin/clamscan -r /home &gt;&gt; /var/log/clamscan.log"
      "0 11 * * * ${pkgs.aide}/bin/aide --check --config /var/lib/aide/aide.conf"
    ];
  };
}
</code></pre>
<p>ClamAV usage:</p>
<p>You can run <code>clamav</code> manually with:</p>
<pre><code class="language-bash"># Recursive Scan:
sudo clamscan -r ~/home
</code></pre>
<blockquote>
<p>‚ùó NOTE: You only need either the individual <code>pkgs.clamav</code> with the cron job
<strong>OR</strong> the <code>clamd-daemon</code> module. <code>clamdscan</code> is for software integration and
uses a different user that doesn‚Äôt have permission to scan your files. You can
use <code>clamdscan --fdpass /path/to/scan</code> to pass the necessary file permissions.
NOTE: <code>clamdscan</code> runs in the background, you can watch it with <code>top</code>.</p>
</blockquote>
<h2 id="securing-ssh"><a class="header" href="#securing-ssh">Securing SSH</a></h2>
<blockquote>
<p><strong>Security information</strong>: Changing SSH configuration settings can
significantly impact the security of your system(s). It is crucial to have a
solid understanding of what you are doing before making any adjustments. Avoid
blindly copying and pasting examples, including those from this Wiki page,
without conducting a thorough analysis. Failure to do so may compromise the
security of your system(s) and lead to potential vulnerabilities. Take the
time to comprehend the implications of your actions and ensure that any
changes made are done thoughtfully and with care. ‚ÄìNixOS Wiki</p>
</blockquote>
<blockquote>
<p>‚ùó NOTE: Choose one, either <code>ssh-agent</code> or <code>gpg-agent</code></p>
</blockquote>
<ol>
<li>Use normal SSH keys generated with <code>ssh-keygen</code>, this is recommended unless
you have a good reason for not using it.</li>
</ol>
<p><strong>OR</strong></p>
<ol start="2">
<li>Use a GPG key with <code>gpg-agent</code> (which acts as your SSH agent). Complex, and
harder to understand in my opinion.</li>
</ol>
<p>My setup caused conflicts when enabling <code>programs.ssh.startAgent</code> so I chose
<code>gpg-agent</code> personally.</p>
<p>There are situations where you are required to use one or the other like for
headless CI/CD environments, <code>ssh-keygen</code> is required.</p>
<ul>
<li><a href="https://saylesss88.github.io/nix/gpg-agent.html">Click Here for GnuPG and gpg-agent chapter</a></li>
</ul>
<p>Further reading:</p>
<details>
<summary> ‚úîÔ∏è Click to Expand Resourses on OpenSSH </summary>
<ul>
<li>
<p><a href="https://wiki.archlinux.org/title/OpenSSH">Arch Wiki OpenSSH</a></p>
</li>
<li>
<p><a href="https://wiki.gentoo.org/wiki/GnuPG">Gentoo GnuPG</a></p>
</li>
<li>
<p><a href="https://rgoulter.com/blog/posts/programming/2022-06-10-a-visual-explanation-of-gpg-subkeys.html">A Visual Explanation of GPG Subkeys</a></p>
</li>
<li>
<p><a href="https://blog.stribik.technology/2015/01/04/secure-secure-shell.html">Secure Secure Shell</a></p>
</li>
</ul>
</details>
<hr>
<h2 id="key-generation"><a class="header" href="#key-generation">Key generation</a></h2>
<h3 id="ssh-keygen"><a class="header" href="#ssh-keygen">ssh-keygen</a></h3>
<p>The <code>ed25519</code> algorithm is significantly faster and more secure when compared to
<code>RSA</code>. You can also specify the key derivation function (KDF) rounds to
strengthen protection even more.</p>
<p>For example, to generate a strong key for GitHub:</p>
<pre><code class="language-bash">ssh-keygen -t ed25519 -a 32 -f ~/.ssh/id_ed25519_github_$(date +%Y-%m-%d) -C "SSH Key for GitHub"
</code></pre>
<ul>
<li>
<p><code>-t</code> is for type</p>
</li>
<li>
<p><code>-a 32</code> sets the number of KDF rounds. The standard is usually good enough,
adding extra rounds can make it harder to brute-force.</p>
</li>
<li>
<p><code>-f</code> is for filename</p>
</li>
</ul>
<h3 id="openssh-server"><a class="header" href="#openssh-server">OpenSSH Server</a></h3>
<p>First of all, if you don‚Äôt use SSH don‚Äôt enable it in the first place. If you do
use SSH, it‚Äôs important to understand what that opens you up to.</p>
<p>The following are some recommendations from Mozilla on OpenSSH:</p>
<ul>
<li><a href="https://infosec.mozilla.org/guidelines/openssh.html">Mozilla OpenSSH guidelines</a></li>
</ul>
<p>The following OpenSSH setup is based on the above guidelines with strong
algorithms, and best practices: (EDITED: 10-07-25 to follow best-practices on
post-quantum crypto)</p>
<pre><code class="language-nix">{config, ...}: {
  config = {
    services = {
      fail2ban = {
        enable = true;
        maxretry = 5;
        bantime = "1h";
        # ignoreIP = [
        # "172.16.0.0/12"
        # "192.168.0.0/16"
        # "2601:881:8100:8de0:31e6:ac52:b5be:462a"
        # "matrix.org"
        # "app.element.io" # don't ratelimit matrix users
        # ];

        bantime-increment = {
          enable = true; # Enable increment of bantime after each violation
          multipliers = "1 2 4 8 16 32 64 128 256";
          maxtime = "168h"; # Do not ban for more than 1 week
          overalljails = true; # Calculate the bantime based on all the violations
        };
      };
      openssh = {
        enable = true;
        settings = {
          PasswordAuthentication = false;
          PermitEmptyPasswords = false;
          PermitTunnel = false;
          UseDns = false;
          KbdInteractiveAuthentication = false;
          X11Forwarding = config.services.xserver.enable;
          MaxAuthTries = 3;
          MaxSessions = 2;
          ClientAliveInterval = 300;
          ClientAliveCountMax = 0;
          AllowUsers = ["your-user"];
          TCPKeepAlive = false;
          AllowTcpForwarding = false;
          AllowAgentForwarding = false;
          LogLevel = "VERBOSE";
          PermitRootLogin = "no";
          KexAlgorithms = [
            # Post-Quantum: https://www.openssh.org/pq.html
            "mlkem768x25519-sha256"
            "sntrup761x25519-sha512"
            "curve25519-sha256@libssh.org"
            "ecdh-sha2-nistp521"
            "ecdh-sha2-nistp384"
            "ecdh-sha2-nistp256"
            "diffie-hellman-group-exchange-sha256"
          ];
          Ciphers = [
            "aes256-gcm@openssh.com"
            "aes128-gcm@openssh.com"
            # stream cipher alternative to aes256, proven to be resilient
            # Very fast on basically anything
            "chacha20-poly1305@openssh.com"
            # industry standard, fast if you have AES-NI hardware
            "aes256-ctr"
            "aes192-ctr"
            "aes128-ctr"
          ];
          Macs = [
            # Combines the SHA-512 hash func with a secret key to create a MAC
            "hmac-sha2-512-etm@openssh.com"
            "hmac-sha2-256-etm@openssh.com"
            "umac-128-etm@openssh.com"
            "hmac-sha2-512"
            "hmac-sha2-256"
            "umac-128@openssh.com"
          ];
        };
        # These keys will be generated for you
        hostKeys = [
          {
            path = "/etc/ssh/ssh_host_ed25519_key";
            type = "ed25519";
          }
        ];
      };
    };
  };
}
</code></pre>
<p>TCP port 22 (ssh) is opened automatically if the SSH daemon is enabled
(<code>services.openssh.enable = true;</code>)</p>
<p>Much of the SSH hardening settings came from
<a href="https://ryanseipp.com/post/nixos-secure-ssh/">ryanseipp‚Äôs secure-ssh Guide</a>
with some additions of my own.</p>
<p>Fail2Ban is an intrusion prevention software framework. It‚Äôs designed to prevent
brute-force attacks by scanning log files for suspicious activity, such as
repeated failed login attempts.</p>
<p>OpenSSH is the primary tool for secure remote access for NixOS. Enabling it
activates the OpenSSH server on the system, allowing incoming SSH connections.</p>
<p>The above configuration is a robust setup for securing an SSH server by:</p>
<ul>
<li>
<p>Preventing brute-force attacks with Fail2Ban</p>
</li>
<li>
<p>Eliminating password authentication in favor of more secure SSH keys</p>
</li>
<li>
<p>Restricting user access and preventing root login</p>
</li>
<li>
<p>Disabling potentially risky forwarding features (tunnel, TCP, agent)</p>
</li>
<li>
<p>Enforce the use of strong, modern cryptographic algorithms for all SSH
communications.</p>
</li>
<li>
<p>Enhanced logging for better auditing.</p>
</li>
</ul>
<p>Further Reading:</p>
<ul>
<li>
<p><a href="https://www.openssh.com/">OpenSSH</a></p>
</li>
<li>
<p><a href="https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server">DigitalOcean how fail2ban works</a></p>
</li>
</ul>
<hr>
<h2 id="encrypted-secrets"><a class="header" href="#encrypted-secrets">Encrypted Secrets</a></h2>
<p>Never store secrets in plain text in repositories. Use something like
<a href="https://github.com/Mic92/sops-nix">sops-nix</a>, which lets you keep encrypted
secrets under version control declaratively.</p>
<p>Another option is <a href="https://github.com/ryantm/agenix">agenix</a></p>
<ul>
<li><a href="https://wiki.nixos.org/wiki/Agenix">NixOS Wiki Agenix</a></li>
</ul>
<h3 id="sops-nix-guide"><a class="header" href="#sops-nix-guide">Sops-nix Guide</a></h3>
<p>Protect your secrets, the following guide is on setting up Sops on NixOS:
<a href="https://saylesss88.github.io/installation/enc/sops-nix.html">Sops Encrypted Secrets</a></p>
<hr>
<h2 id="auditd"><a class="header" href="#auditd">Auditd</a></h2>
<p>To enable the Linux Audit Daemon (<code>auditd</code>) and define a very basic rule set,
you can use the following NixOS configuration. This example demonstrates how to
log every program execution (<code>execve</code>) on a 64-bit architecture.</p>
<pre><code class="language-nix"># modules/security/auditd-minimal.nix (or directly in configuration.nix)
{
  # start as early in the boot process as possible
  boot.kernelParams = ["audit=1"];
  security.auditd.enable = true;
  security.audit.enable = true;
  security.audit.rules = [
    # Log all program executions on 64-bit architecture
    "-a exit,always -F arch=b64 -S execve"
  ];
}
</code></pre>
<ul>
<li>
<p><code>audit=1</code> Enables auditing at the kernel level very early in the boot process.
Without this, some events could be missed.</p>
</li>
<li>
<p><code>security.auditd.enable = true;</code> Ensures the <code>auditd</code> userspace daemon is
started.</p>
</li>
<li>
<p>While often enabled together, <code>security.audit.enable</code> specifically refers to
enabling the NixOS module for audit rules generation.</p>
</li>
<li>
<p><code>execve</code> (program executions)</p>
</li>
<li>
<p>This is just a basic configuration, there is much more that can be tracked.</p>
</li>
</ul>
<hr>
<h2 id="usb-port-protection"><a class="header" href="#usb-port-protection">USB Port Protection</a></h2>
<p>It‚Äôs important to protect your USB ports to prevent BadUSB attacks, data
exfiltration, unauthorized device access, malware injection, etc.</p>
<p>To get a list of your connected USB devices you can use <code>lsusb</code> from the
<code>usbutils</code> package.</p>
<pre><code class="language-bash">lsusb
</code></pre>
<p>To list the devices recognized by USBGuard, run:</p>
<pre><code class="language-bash">sudo usbguard list-devices
</code></pre>
<ul>
<li><a href="https://mynixos.com/options/services.usbguard">MyNixOS services.usbguard</a></li>
</ul>
<p>Change <code>your-user</code> to your username:</p>
<pre><code class="language-nix"># usbguard.nix
{
  config,
  pkgs,
  lib,
  ...
}: let
  inherit (lib) mkIf;
  cfg = config.custom.security.usbguard;
in {
  options.custom.security.usbguard = {
    enable = lib.mkEnableOption "usbguard";
  };

  config = mkIf cfg.enable {
    services.usbguard = {
      enable = true;
      IPCAllowedUsers = ["root" "your-user"];
    # presentDevicePolicy refers to how to treat USB devices that are already connected when the daemon starts
      presentDevicePolicy = "allow";
      rules = ''
        # allow `only` devices with mass storage interfaces (USB Mass Storage)
        allow with-interface equals { 08:*:* }
        # allow mice and keyboards
        # allow with-interface equals { 03:*:* }

        # Reject devices with suspicious combination of interfaces
        reject with-interface all-of { 08:*:* 03:00:* }
        reject with-interface all-of { 08:*:* 03:01:* }
        reject with-interface all-of { 08:*:* e0:*:* }
        reject with-interface all-of { 08:*:* 02:*:* }
      '';
    };

    environment.systemPackages = [pkgs.usbguard];
  };
}
</code></pre>
<p>The above settings can be found in
<a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/security_guide/sec-using-usbguard">RedHat UsbGuard</a></p>
<p>The only <code>allow</code> rule is for devices with <strong>only</strong> mass storage interfaces
(<code>08:*:*</code>) i.e., USB Mass storage devices, devices like keyboards and mice
(which use interface class <code>03:*:*</code>) implicitly <strong>not allowed</strong>.</p>
<p>The <code>reject</code> rules reject devices with a suspicious combination of interfaces. A
USB drive that implements a keyboard or a network interface is very suspicious,
these <code>reject</code> rules prevent that.</p>
<p>The <code>presentDevicePolicy = "allow";</code> allows any device that is present at daemon
start up even if they‚Äôre not explicitly allowed. However, newly plugged in
devices must match an <code>allow</code> rule or get denied implicitly.</p>
<p>The <code>presentDevicePolicy</code> should be one of: # one of <code>"apply-policy"</code>(default,
evaluate the rule set for every present device), <code>"block"</code>, <code>"reject"</code>, <code>"keep"</code>
(keep whatever state the device is currently in), or <code>"allow"</code>, which is used in
the example.</p>
<p>There is also the
<a href="https://github.com/Cropi/usbguard-notifier">usbguard-notifier</a></p>
<p>And enable it with the following in your <code>configuration.nix</code> or equivalent:</p>
<pre><code class="language-nix"># configuration.nix
imports = [
    ./usbguard.nix
];
custom.security.usbguard.enable = true;
</code></pre>
<blockquote>
<p>‚ùó If you are ever unsure about a setting that you want to harden and think
that it could possibly break your system you can always use a specialisation
reversing the action and choose it‚Äôs generation at boot up. For example, to
force-reverse the above settings you could:</p>
<pre><code class="language-nix"># configuration.nix
specialisation.no-usbguard.configuration = {
    services.usbguard.enable = lib.mkForce false;
};
</code></pre>
<ul>
<li>This is a situation where I recommend this, it‚Äôs easy to lock yourself out
of your keyboard, mouse, etc. when trying to configure this.</li>
</ul>
</blockquote>
<p>Further Reading:</p>
<ul>
<li>
<p><a href="https://www.ninjaone.com/it-hub/endpoint-security/what-is-badusb/">NinjaOne BadUSB</a></p>
</li>
<li>
<p><a href="https://usbguard.github.io/">USBGuard</a></p>
</li>
<li>
<p><a href="https://www.cyberciti.biz/security/how-to-protect-linux-against-rogue-usb-devices-using-usbguard/">NixCraft USBGuard</a></p>
</li>
</ul>
<hr>
<h2 id="doas-over-sudo-warning-doas-is-unmaintained"><a class="header" href="#doas-over-sudo-warning-doas-is-unmaintained">Doas over sudo (Warning Doas is unmaintained)</a></h2>
<details>
<summary> ‚úîÔ∏è Click to Expand Unmaintained Doas example </summary>
<blockquote>
<p>NOTE: I have moved to <code>run0</code> for authentication which is included by default
with systemd. It‚Äôs actually a symlink to the existing <code>systemd-run</code> tool. It
behaves like a secure <code>sudo</code> alternative: it spawns a transient service under
PID 1 for privilege escalation, without relying on SUID (set user ID)
binaries.</p>
</blockquote>
<blockquote>
<p>‚ö†Ô∏è Warning the Nixpkgs version of <code>doas</code>,
<a href="https://github.com/Duncaen/OpenDoas">OpenDoas</a> is unmaintained and hasn‚Äôt
been updated in 3 to 4 years. If you don‚Äôt like <code>run0</code>, consider using
<code>sudo-rs</code>. I‚Äôm leaving this here for now, may remove it in the future to not
promote using unmaintained software, you‚Äôve been warned.</p>
</blockquote>
<ul>
<li>
<p><a href="https://mastodon.social/@pid_eins/112353324518585654">Why run0</a></p>
</li>
<li>
<p>SUID = ‚ÄúSet User ID‚Äù: When a binary has the SUID bit set, it runs with the
privileges of the file‚Äôs owner (often root). There is a long history of
vulnerabilities with SUID binaries.</p>
</li>
</ul>
<p>For a more minimalist version of <code>sudo</code> with a smaller codebase and attack
surface, consider <code>doas</code>. Replace <code>userName</code> with your username:</p>
<pre><code class="language-nix"># doas.nix
{
  lib,
  config,
  pkgs, # Add pkgs if you need to access user information
  ...
}: let
  cfg = config.custom.security.doas;
in {
  options.custom.security.doas = {
    enable = lib.mkEnableOption "doas";
  };

  config = lib.mkIf cfg.enable {
    # Disable sudo
    security.sudo.enable = false;

    # Enable and configure `doas`.
    security.doas = {
      enable = true;
      extraRules = [
        {
          # Grant doas access specifically to your user
          users = ["userName"]; # &lt;--- Only give access to your user
          # persist = true; # Convenient but less secure
          # noPass = true;    # Convenient but even less secure
          keepEnv = true; # Often necessary
          # Optional: You can also specify which commands they can run, e.g.:
          # cmd = "ALL"; # Allows running all commands (default if not specified)
          # cmd = "/run/current-system/sw/bin/nixos-rebuild"; # Only allow specific command
        }
      ];
    };

    # Add an alias to the shell for backward-compat and convenience.
    environment.shellAliases = {
      sudo = "doas";
    };
  };
}
</code></pre>
<p>You would then import this into your <code>configuration.nix</code> and enable/disable it
with the following:</p>
<pre><code class="language-nix"># configuration.nix

imports = [
    ./doas.nix
];

custom.security.doas.enable = true;
</code></pre>
<blockquote>
<p>‚ùó NOTE: Many people opt for the less secure <code>groups = ["wheel"];</code> in the
above configuration instead of <code>users = ["userName"];</code> to give wider access,
the choice is yours.</p>
</blockquote>
</details>
<hr>
<h2 id="firejail"><a class="header" href="#firejail">Firejail</a></h2>
<blockquote>
<p>‚ùóÔ∏è Critics such as madaidan say that Firejail worsens security by acting as a
privilege escalation hole. Firejail requires the executable to be setuid,
meaning it runs with root privileges.This is risky because any vulnerability
in Firejail can lead to privilege escalation. This combined with many
convenience features and complicated command line flags leads to a large
attack surface.</p>
</blockquote>
<ul>
<li>
<p>I haven‚Äôt personally tried
<a href="https://github.com/Naxdy/nix-bwrapper">nix-bwrapper</a> myself yet, but it‚Äôs
another sandboxing option that looks interesting. Bubblewrap is known for
having a more minimal design and smaller attack surface.</p>
<ul>
<li>Also see: <a href="#flatpak">Flatpak section</a> for another option for sandboxing.</li>
</ul>
</li>
<li>
<p><a href="https://sr.ht/~fgaz/nix-bubblewrap/">nix-bubblewrap</a> is another option.</p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Firejail">NixOS Wiki Firejail</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Firejail">Arch Wiki Firejail</a></p>
</li>
</ul>
<blockquote>
<p>‚ùó WARNING: Running untrusted code is never safe, sandboxing cannot change
this. ‚ÄìArch Wiki</p>
</blockquote>
<pre><code class="language-nix"># firejail.nix
{
  pkgs,
  lib,
  ...
}: {
  programs.firejail = {
    enable = true;
    wrappedBinaries = {
      # Sandbox a web browser
      librewolf = {
        executable = "${lib.getBin pkgs.librewolf}/bin/librewolf";
        profile = "${pkgs.firejail}/etc/firejail/librewolf.profile";
      };
      # Sandbox a file manager
      thunar = {
        executable = "${lib.getBin pkgs.xfce.thunar}/bin/thunar";
        profile = "${pkgs.firejail}/etc/firejail/thunar.profile";
      };
      # Sandbox a document viewer
      zathura = {
        executable = "${lib.getBin pkgs.zathura}/bin/zathura";
        profile = "${pkgs.firejail}/etc/firejail/zathura.profile";
      };
    };
  };
}
</code></pre>
<p><code>wrappedBinaries</code> is a list of applications you want to run inside a sandbox.
Only the apps in the <code>wrappedBinaries</code> attribute set will be automatically
firejailed when launched the usual way.</p>
<p>Other apps may be started manually using <code>firejail &lt;app&gt;</code>, or added to
<code>wrappedBinaries</code> if you want automatic sandboxing, just make sure the profile
exists.</p>
<p>To inspect which profiles are available, after rebuilding go to <code>/nix/store/</code>, I
used Yazi to search for <code>/firejail</code> and followed it to <code>firejail/etc</code>, where the
profiles are.</p>
<p>There are many flags and options available with firejail, I suggest checking out
<code>man firejail</code>.</p>
<p>There are comments explaining what‚Äôs going on in:
<a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/fi/firejail/package.nix">firejail/package.nix</a></p>
<p>Firejail is a SUID program that reduces the risk of security breaches by
restricting the running environment of untrusted applications using
<a href="https://lwn.net/Articles/531114/">Linux namespaces</a> and
<a href="https://l3net.wordpress.com/2015/04/13/firejail-seccomp-guide/">seccomp-bpf</a>‚Äì<a href="https://firejail.wordpress.com/">Firejail Security Sandbox</a></p>
<p>It provides sandboxing and access restriction per application, much like what
AppArmor/SELinux does at a kernel level. However, it‚Äôs not as secure or
comprehensive as kernel-enforced MAC systems (AppArmor/SELinux), since it‚Äôs a
userspace tool and can potentially be bypassed by privilege escalation exploits.</p>
<hr>
<h2 id="flatpak"><a class="header" href="#flatpak">Flatpak</a></h2>
<blockquote>
<p>‚ùóÔ∏èNOTE: You cannot effectively use Firejail with Flatpak apps because of how
their sandboxing technologies operate. Flatpak also won‚Äôt work with the
hardened kernel because they require unprivileged user namespaces which the
hardened kernel completely disables.</p>
</blockquote>
<p>Apps that don‚Äôt have a flatpak equivalent can be further hardened with
bubblewrap independently but bubblewrap is not needed on Flatpak apps.</p>
<p>Because of this limited native MAC (Mandatory Access Control) support on NixOS,
using Flatpak is often a good approach to get sandboxing and isolation for many
GUI apps.</p>
<ul>
<li>
<p>Flatpak bundles runtimes and sandbox mechanisms that provide app isolation
independently of the host system‚Äôs AppArmor or SELinux infrastructure. This
can improve security and containment for GUI applications running on NixOS
despite the system lacking full native MAC coverage.</p>
</li>
<li>
<p>Flatpak apps benefit from sandboxing through bubblewrap, which isolate apps
and restrict access to user/home and system resources.</p>
</li>
</ul>
<p>Add Flatpak with the FlatHub repository for all users:</p>
<pre><code class="language-nix">services.flatpak.enable = true;
  systemd.services.flatpak-repo = {
    wantedBy = [ "multi-user.target" ];
    path = [ pkgs.flatpak ];
    script = ''
      flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      # Only apps that are verified
      # flatpak remote-add --if-not-exists --subset=verified flathub-verified https://flathub.org/repo/flathub.flatpakrepo
    '';
  };
xdg = {
  portal = {
    enable = true;
    extraPortals = [ pkgs.xdg-desktop-portal-gtk ];
    config.common.default = [ "gtk" ];
  };
};
# Disables screencopy
systemd.user.services."xdg-desktop-portal-wlr" = {
  enable = false;
};
</code></pre>
<ul>
<li>
<p><a href="https://docs.flathub.org/docs/for-users/verification">Flathub Verified Apps</a></p>
</li>
<li>
<p><a href="https://secureblue.dev/articles/flatpak">Flatpak the good the bad the ugly</a></p>
</li>
</ul>
<p>Then you can either find apps through <a href="https://flathub.org/en">FlatHub</a> or on
the cmdline with <code>flatpak search &lt;app&gt;</code>. Flatpak is best used for GUI apps, some
CLI apps can be installed through it but not all.</p>
<ul>
<li>
<p>There is also <a href="https://github.com/gmodena/nix-flatpak">nix-flatpak</a>, which
enables you to manage your flatpaks declaratively.</p>
</li>
<li>
<p><a href="https://flathub.org/en/apps/com.github.tchx84.Flatseal">Flatseal</a> is GUI
utility that enables you to review and modify permissions from your Flatpak
apps. Many apps by default come with smart-card support, X11 &amp; Wayland
support, and more, disabling unnecessary permissions is recommended.</p>
</li>
<li>
<p><a href="https://flathub.org/en/apps/io.github.flattool.Warehouse">Warehouse</a> provides
a simple UI to control complex Flatpak options, no cmdline required.</p>
</li>
</ul>
<p>I have heard that it is not recommended to use Flatpak browsers because in order
for flatpak to work it has to disable some of the built-in browser sandboxing
which can reduce security. I haven‚Äôt found any examples of Flatpak browsers
being exploited but it‚Äôs something to keep in mind.</p>
<hr>
<h2 id="selinuxapparmor-mac-mandatory-access-control"><a class="header" href="#selinuxapparmor-mac-mandatory-access-control">SeLinux/AppArmor MAC (Mandatory Access Control)</a></h2>
<p><strong>AppArmor</strong> is available on NixOS, but is still in a somewhat experimental and
evolving state. There are only a few profiles that have been adapted to NixOS,
see here
<a href="https://discourse.nixos.org/t/apparmor-default-profiles/16780">Discourse on default-profiles</a>
Which guides you here
<a href="https://github.com/NixOS/nixpkgs/blob/2acaef7a85356329f750819a0e7c3bb4a98c13fe/nixos/modules/security/apparmor/includes.nix">apparmor/includes.nix</a>
where you can see some of the abstractions and tunables to follow progress.</p>
<p><strong>SELinux</strong>: Experimental, not fully integrated, recent progress for
advanced/curious users; expect rough edges and manual intervention if you want
to try it. Most find SELinux more complex to configure and maintain than
AppArmor.</p>
<p>This isn‚Äôt meant to be a comprehensive guide, more to get people thinking about
security on NixOS.</p>
<p>See the following guide on hardening networking:</p>
<ul>
<li><a href="https://saylesss88.github.io/nix/hardening_networking.html">Hardening Networking</a></li>
</ul>
<hr>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<h3 id="advanced-hardening-with-nix-mineral-community-project"><a class="header" href="#advanced-hardening-with-nix-mineral-community-project">Advanced Hardening with <code>nix-mineral</code> (Community Project)</a></h3>
<details>
<summary> ‚úîÔ∏è Click to Expand section on `nix-mineral` </summary>
<p>For users seeking a more comprehensive and opinionated approach to system
hardening beyond the built-in <code>hardened</code> profile, the community project
<a href="https://github.com/cynicsketch/nix-mineral"><code>nix-mineral</code></a> offers a declarative
NixOS module.</p>
<p><code>nix-mineral</code> aims to apply a wide array of security configurations, focusing on
tweaking kernel parameters, system settings, and file permissions to reduce the
attack surface.</p>
<ul>
<li><strong>Community Project Status:</strong> <code>nix-mineral</code> is a community-maintained project
and is not officially part of the Nixpkgs repository or NixOS documentation.
Its development status is explicitly stated as ‚ÄúAlpha software,‚Äù meaning it
may introduce stability issues or unexpected behavior.</li>
</ul>
<p>For detailed information on <code>nix-mineral</code>‚Äôs capabilities and current status,
refer directly to its
<a href="https://github.com/cynicsketch/nix-mineral">GitHub repository</a>.</p>
</details>
<details>
<summary> ‚úîÔ∏è Click to Expand Resources </summary>
<ul>
<li>
<p><a href="https://hedgedoc.grimmauld.de/s/hWcvJEniW#">AppArmor and apparmor.d on NixOS</a></p>
</li>
<li>
<p><a href="https://tristanxr.com/post/selinux-on-nixos/">SELinux on NixOS</a></p>
</li>
<li>
<p><a href="https://xeiaso.net/blog/paranoid-nixos-2021-07-18/">Paranoid NixOS</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Security">NixOS Wiki Security</a></p>
</li>
<li>
<p><a href="https://nixos.org/manual/nixos/unstable/index.html#sec-luks-file-systems">Luks Encrypted File Systems</a></p>
</li>
<li>
<p><a href="https://discourse.nixos.org/t/a-modern-and-secure-desktop-setup/41154">Discourse A Modern and Secure Desktop</a></p>
</li>
<li>
<p><a href="https://notashelf.dev/posts/insecurities-remedies-i">notashelf NixOS Security 1 Systemd</a></p>
</li>
<li>
<p><a href="https://ryanseipp.com/post/hardening-nixos/">ryanseipp hardening-nixos</a></p>
</li>
<li>
<p><a href="https://madaidans-insecurities.github.io/guides/linux-hardening.html">madaidans Linux Hardening Guide</a></p>
</li>
<li>
<p><a href="https://cybersecuritynews.com/hardening-linux-servers">Hardening-Linux-Servers</a></p>
</li>
<li>
<p><a href="https://linux-audit.com/linux-server-hardening-most-important-steps-to-secure-systems/">linux-audit Linux Server hardening best practices</a></p>
</li>
<li>
<p><a href="https://linux-audit.com/linux-security-guide-extended-version/">linux-audit Linux security guide extended</a></p>
</li>
<li>
<p><a href="https://wiki.archlinux.org/title/Security">Arch Wiki Security</a></p>
</li>
<li>
<p><a href="https://wiki.gentoo.org/wiki/Security_Handbook/Concepts">Gentoo Security_Handbook Concepts</a></p>
</li>
<li>
<p><a href="https://secureblue.dev/faq">secureblue FAQ</a></p>
</li>
<li>
<p><a href="https://www.kicksecure.com/wiki/Documentation">Excellent Kicksecure Docs</a></p>
</li>
<li>
<p><a href="https://github.com/decalage2/awesome-security-hardening">Awesome-Security-Hardening List</a></p>
</li>
<li>
<p><a href="https://factorable.net/faq.html">factorable.net (study of RSA and DSA crypto keys) FAQ</a></p>
</li>
<li>
<p><a href="https://blog.cr.yp.to/20140205-entropy.html">The cr.yp.to blog Entropy</a></p>
</li>
<li>
<p><a href="https://delroth.net/posts/nixos-security-wishlist/">NixOS Security wishlist</a></p>
</li>
<li>
<p><a href="https://beej.us/guide/bgipc/html/">Beejus IPC guide</a></p>
</li>
<li>
<p><a href="https://www.geeksforgeeks.org/operating-systems/inter-process-communication-ipc/">GeeksforGeeks IPC</a></p>
</li>
</ul>
<p>neal.codes vulnerability scan script:</p>
<pre><code class="language-bash">nix-shell -p grype sbomnix --run '
  sbomnix /run/current-system --csv /dev/null --spdx /dev/null --cdx sbom.cdx.json;
  grype sbom.cdx.json
'
</code></pre>
<ul>
<li>
<p><a href="https://github.com/nealfennimore/nixos-stig-anduril">neal.codes nixos-stig-anduril</a></p>
</li>
<li>
<p><a href="https://www.suse.com/c/linux-hardeningthe-complete-guide-to-securing-your-systems/">Suse Linux Hardening Guide</a></p>
</li>
</ul>
<p><strong>Government Resources 1st 6 come from gentoo‚Äôs Security_Handbook)</strong></p>
<ul>
<li>
<p><a href="https://www.cyber.gov.au/sites/default/files/2023-03/Information%20Security%20Manual%20-%20%28March%202023%29.pdf">The Austrailian Cyber Security Centre‚Äôs Informational Security Manual (ISM)</a></p>
</li>
<li>
<p><a href="https://www.protectivesecurity.gov.au/policies">The Australian Government‚Äôs Protective Security Policy Framework (PSPF)</a></p>
</li>
<li>
<p><a href="https://www.cyber.gov.au/protect-yourself">The Australian Cyber Security Centre‚Äôs Protect Yourself page</a></p>
</li>
<li>
<p><a href="https://www.gov.uk/government/publications/security-policy-framework/hmg-security-policy-framework">The UK Government‚Äôs Security Policy Framework (SPF)</a></p>
</li>
<li>
<p><a href="https://www.gov.uk/government/publications/information-security-policy-framework">The UK Government‚Äôs Information Security Policy Framework (ISF)</a></p>
</li>
<li>
<p><a href="https://www.nist.gov/cybersecurity">The US National Institute of Standards and Technology‚Äôs Cybersecurity page</a></p>
</li>
<li>
<p><a href="https://stigviewer.com/stigs/anduril_nixos">NixOS STIG</a></p>
</li>
<li>
<p>STIGs are configuration standards developed by the Defense Information Systems
Agency (DISA) to secure systems and software for the U.S. Department of
Defense (DoD). They are considered a highly authoritative source for system
hardening.There are recommendations for hardening all kinds of software in the
<a href="https://stigviewer.com/stigs">Stig Viewer</a></p>
</li>
<li>
<p><a href="https://www.cisecurity.org/cis-benchmarks">CIS Benchmarks</a></p>
</li>
<li>
<p><a href="https://github.com/nsacyber">NSA Cybersecurity Directorate</a></p>
</li>
</ul>
</details>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../nix/gpg-agent.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../nix/gpg-agent.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/extra-e0f03105.js"></script>
        <script src="../theme/rss-button-7a13e6a0.js"></script>



    </div>
    </body>
</html>
