<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Minimal LUKS Encrypted Install with Btrfs-Subvols - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="minimal-luks-encrypted-install-with-btrfs-subvolumes"><a class="header" href="#minimal-luks-encrypted-install-with-btrfs-subvolumes">Minimal LUKS Encrypted Install with Btrfs Subvolumes</a></h1>
<p>Follow this guide to set up a minimal NixOS install with LUKS, Btrfs, and
encrypted secrets.</p>
<ol>
<li>Prepare the Minimal ISO and Networking</li>
</ol>
<ul>
<li>
<p>Download the NixOS minimal ISO and boot it.</p>
</li>
<li>
<p>Set up networking:</p>
</li>
</ul>
<pre><code class="language-bash">sudo systemctl start wpa_supplicant wpa_cli
wpa_cli
&gt; add_network
0
&gt; set_network 0 ssid "myhomenetwork"
OK
&gt; set_network 0 psk "mypassword"
OK
&gt; enable_network 0
OK
&gt; quit
</code></pre>
<p>Or, use:</p>
<pre><code class="language-bash">sudo wpa_passphrase "myhomenetwork" "mypassword" &gt;&gt;
/etc/wpa_supplicant/wpa_supplicant-wlan0.conf
sudo systemctl restart wpa_supplicant@wlan0.service
</code></pre>
<p>Test your connection:</p>
<pre><code class="language-bash">ping google.com
</code></pre>
<ol start="2">
<li>Enable Experimental Nix Features</li>
</ol>
<pre><code class="language-bash">export NIX_CONFIG='experimental-features = nix-command flakes'
</code></pre>
<ol start="3">
<li>Install Essential Tools</li>
</ol>
<pre><code class="language-bash">nix-shell -p git helix yazi age sops mkpasswd
export EDITOR='hx'
git config --global user.name "YourUsername"
git config --global user.email "YourGitEmail"
```

4. Clone the Configuration Repository

```bash
git clone https://github.com/saylesss88/my-flake.git
</code></pre>
<ol start="5">
<li>Customize Configuration Files</li>
</ol>
<ul>
<li>
<p>Modify <code>flake.nix</code>, <code>users.nix</code>, and <code>configuration.nix</code> to set your desired
<code>hostname</code> and <code>username</code>.</p>
<p>Check your disk device with <code>lsblk</code> and update line 5 of <code>disk-config2.nix</code>
accordingly. (i.e. the <code>device</code> needs to match your device)</p>
</li>
</ul>
<ol start="6">
<li>
<p>Generate Hashed Passwords and LUKS Passphrase</p>
<p>Generate a hashed password:</p>
</li>
</ol>
<pre><code class="language-bash">mkpasswd -m SHA-512 -s &gt; /tmp/user_hashed_pass.txt
</code></pre>
<ol start="7">
<li>Set Up Age Key for SOPS</li>
</ol>
<pre><code class="language-bash">mkdir -p ~/.config/sops/age age-keygen -o ~/.config/sops/age/keys.txt
</code></pre>
<ul>
<li>Copy the public key and add it to .sops.yaml in your repo:</li>
</ul>
<pre><code class="language-yaml">keys:

- &amp;personal_age_key
  age1yuvx83vtxr8rf6t8vmwjeymt9u83h4cwktnqvmn49rhy36chj3tqlgunhz creation_rules:
- path_regex: "secrets/.\*\\.yaml$" key_groups:

  - age:
    - \*personal_age_key
</code></pre>
<ul>
<li>Add <code>.sops.yaml</code> to git:</li>
</ul>
<pre><code class="language-bash">git add .sops.yaml
</code></pre>
<ul>
<li>If using Git and you forget to add the <code>.sops.yaml</code>, sops won't be able to
decrypt your secrets.</li>
</ul>
<ol start="8">
<li>Generate SSH Key</li>
</ol>
<pre><code class="language-bash">ssh-keygen -t ed25519 -C "your_email@example.com" &gt; /tmp/ssh_key.txt
</code></pre>
<ul>
<li>Copy the private key into <code>secrets/github-deploy-key.yaml</code> using SOPS:</li>
</ul>
<pre><code class="language-bash">sops secrets/github-deploy-key.yaml
</code></pre>
<p>Inside, paste:</p>
<pre><code class="language-yaml">github_deploy_key_ed25519: |
  -----BEGIN OPENSSH PRIVATE KEY----- ...
  -----END OPENSSH PRIVATE KEY-----
</code></pre>
<ul>
<li>Indent the key content by 2 spaces.</li>
</ul>
<ol start="9">
<li>Add Hashed Password to SOPS</li>
</ol>
<pre><code class="language-bash">sops secrets/password-hash.yaml
</code></pre>
<p>Inside, paste:</p>
<pre><code class="language-yaml">password_hash:
</code></pre>
<ul>
<li>Read in your hashed password:</li>
</ul>
<pre><code class="language-yaml">:r /tmp/user_hashed_pass.txt
</code></pre>
<ol start="10">
<li>Configure SOPS in Nix</li>
</ol>
<p>Ensure your sops.nix looks like this (adjust paths as needed):</p>
<pre><code class="language-nix">{...}: {
sops = { defaultSopsFile = ./sops.yaml;
    age.sshKeyPaths = ["/etc/ssh/ssh_host_ed25519_key"];
    age.keyFile = "/home/jr/sops/age/keys.txt";

    secrets = {
      "password_hash" = {
        sopsFile = ./secrets/password-hash.yaml;
        owner = "root";
        group = "root";
        mode = "0400";
        neededForUsers = true;
      };
      "github_deploy_key_ed25519" = {
        sopsFile = ./secrets/github-deploy-key.yaml;
        key = "github_deploy_key_ed25519";
        owner = "root";
        group = "root";
        mode = "0400";
      };
    };

}; }
</code></pre>
<ol start="11">
<li>Apply Configuration</li>
</ol>
<p>First generate your <code>hardware-configuration.nix</code> and replace the repos existing
<code>hardware-configuration.nix</code> with the freshly generated one:</p>
<pre><code class="language-bash">nixos-generate-config --no-filesystems --root /mnt
sudo mv /tmp/etc/nixos/hardware-configuration.nix ~/my-flake
</code></pre>
<p>Now you can rebuild to apply the changes:</p>
<pre><code class="language-bash">sudo nixos-rebuild switch --flake ~/my-flake#your-hostname
</code></pre>
<ol start="12">
<li>Prepare Disko for Partitioning and Formatting</li>
</ol>
<ul>
<li>Run Disko to wipe, partition, and format your disk (WARNING: this destroys
data):</li>
</ul>
<pre><code class="language-bash">sudo nix --experimental-features "nix-command flakes" run github:nix-community/disko/latest -- --mode destroy,format,mount ~/my-flake/disk-config2.nix
</code></pre>
<ul>
<li>You will be prompted for your LUKS passphrase.</li>
</ul>
<p>Check mounts:</p>
<pre><code class="language-bash">mount | grep /mnt
</code></pre>
<ol start="13">
<li>Update and Apply Configuration</li>
</ol>
<ul>
<li>
<p>Update <code>configuration.nix</code> with your hostname, packages, etc.</p>
</li>
<li>
<p>Replace your flake's <code>hardware-configuration.nix</code> with the newly generated
one:</p>
</li>
</ul>
<pre><code class="language-bash">rm ~/my-flake/hardware-configuration.nix
sudo mv /mnt/etc/nixos/hardware-configuration.nix ~/my-flake
</code></pre>
<ol start="14">
<li>Move Flake and Install NixOS</li>
</ol>
<pre><code class="language-bash">sudo mv ~/my-flake /mnt/etc/nixos/
sudo nixos-install --flake /mnt/etc/nixos/my-flake#hostname
</code></pre>
<ul>
<li>You will be prompted to set a new password and reboot.</li>
</ul>
<ol start="15">
<li>Post-Installation</li>
</ol>
<ul>
<li>After reboot, you will be asked to enter your encryption password for the boot
process to continue. Enter the passphrase you used for the <code>disko</code> command.</li>
</ul>
<pre><code class="language-bash">sudo mv /etc/nixos/my-flake ~
sudo chown -R $USER:users ~/my-flake
</code></pre>
<ul>
<li>
<p>It is possible to use sops to auto decrypt your luks partition but it negates
many of the benefits in my opinion. It's something you could look into if you
wanted, as it still does provide some benefits.</p>
</li>
<li>
<p>I'm working on the impermanence guide for this setup, had quite a few
headaches so far. I'm open to suggestions.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/minimal_install.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../nix/impermanence.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/minimal_install.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../nix/impermanence.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
