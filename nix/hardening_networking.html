<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hardening Networking - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hardening-networking"><a class="header" href="#hardening-networking">Hardening Networking</a></h1>
<details>
<summary> Click to Expand Table of Contents</summary>
<ul>
<li><a href="#simple-tips">Simple Tips</a>
<ul>
<li><a href="#choosing-a-secure-browser">Choosing a secure Browser</a>
<ul>
<li><a href="#tor-browser">Tor Browser</a></li>
<li><a href="#searxng">SearXNG</a></li>
<li><a href="#hardening-other-browsers">Hardening Other Browsers</a></li>
</ul>
</li>
<li><a href="#virtual-private-networks-vpns">Virtual Private Networks (VPNs)</a></li>
</ul>
</li>
<li><a href="#encrypted-dns">Encrypted DNS</a></li>
<li><a href="#firewalls">Firewalls</a></li>
<li><a href="#opensnitch">OpenSnitch</a></li>
</ul>
</details>
<blockquote>
<p>⚠️ I am not a security expert, but I have carefully researched and tested the
configurations in this chapter personally.Not every setting or method will be
appropriate or necessary for all setups; some may cause compatibility or
connectivity issues depending on your environment and needs.</p>
<p>Always carefully research any changes before applying them, especially when
they affect critical components like DNS or firewalls. Network hardening can
occasionally disrupt legitimate services, degrade performance, or block access
in unexpected ways.</p>
<p>Test adjustments in a controlled environment first, understand the tradeoffs
involved, and only use what fits your threat model and workflow. Security is
complex, and it’s important to tailor your approach to your unique
requirements. Take what’s useful, adapt as needed, and don’t hesitate to seek
expert guidance for advanced scenarios.</p>
</blockquote>
<h2 id="simple-tips"><a class="header" href="#simple-tips">Simple Tips</a></h2>
<p>A few simple things you can do to help protect your network:</p>
<ul>
<li>
<p>HTTPS encrypts the data between a web browser and a website. This is
especially important for services that need logging into such as a bank
account, email, etc. Most browsers either have a setting or an extension to
enforce HTTPS everywhere, use it.</p>
</li>
<li>
<p><a href="https://discourse.nixos.org/t/declare-firefox-extensions-and-settings/36265">Discourse Declare Firefox extensions and settings</a></p>
</li>
<li>
<p><a href="https://cloudflare.com/learning/ssl/what-is-https">Cloudflare What is HTTPS</a></p>
</li>
<li>
<p>Check sketchy urls first with
<a href="https://www.virustotal.com/gui/home/url">VirusTotal</a> where you can plug the
URL into a scanner to ensure it's safe.</p>
</li>
<li>
<p><a href="https://ssd.eff.org/">Surveillance Self-Defence</a> has a lot of helpful info to
protect your privacy.</p>
</li>
<li>
<p>Take potentially dangerous PDFs, office documents, or images and convert them
to a safe PDF with <a href="https://github.com/freedomofpress/dangerzone">dangerzone</a>
Be especially careful with torrents.</p>
</li>
<li>
<p>Use a metadata-cleaner before you publish or share images, audio, video, etc.
Nixpkgs has <code>pkgs.metadata-cleaner</code> and <code>pkgs.mat2</code></p>
</li>
<li>
<p>This may be unrelated but don't scan random QR codes either, you can download
a QR scan checker to ensure the code isn't malicious. There are different apps
for this on Android and IOS.</p>
</li>
<li>
<p>Don't use your browsers "remember my password" or "Autofill" functions,
disable and delete the history. Use a password manager instead. (security not
usability)</p>
</li>
<li>
<p>If you need to enter your credentials for something, don't click use Google or
FaceBook to create the account. Doing so opens up all of those services if one
of them gets compromised. Take the extra time to create an account with it's
own unique password and user.</p>
</li>
<li>
<p>Delete cookies and site data when the browser is closed. (security not
usability). I believe this is the default on LibreWolf, I recently started
using this and it's not too bad with bitwarden.</p>
</li>
<li>
<p>Use passkeys to store complex passwords, use your password manager to generate
unique and complex passphrases/passwords for you and save them right away.
Make sure to follow the next suggestion for your password manager.</p>
</li>
<li>
<p>Use 2 factor authentication everywhere possible.</p>
</li>
</ul>
<p>I never liked the argument, "I'm not doing anything illegal so I don't care if
they spy on me and make a profit off of my data". Regardless of what you do
online, I think it's your business and yours alone. Why make it easy on them if
you can limit your exposure?</p>
<h3 id="choosing-a-secure-browser"><a class="header" href="#choosing-a-secure-browser">Choosing a secure Browser</a></h3>
<p>On a hardened Linux system, the browser is most often the weakest link exposed
to the internet, and so security, privacy, and anti-tracking features of
browsers are now as important, or even more important than platform-level
protections.</p>
<h4 id="tor-browser"><a class="header" href="#tor-browser">Tor Browser</a></h4>
<p>Tor routes your internet traffic through a global volunteer-operated network,
masking your IP address and activities from local observers, ISPs, websites, and
surveillance systems. This helps you protect personal information and maintain
anonymity when browsing, communicating, or using online services.</p>
<ul>
<li><a href="https://wiki.nixos.org/wiki/Tor">Tor on NixOS</a>
<ul>
<li>
<p><a href="https://tb-manual.torproject.org/">Tor Browser User Manual</a></p>
</li>
<li>
<p><a href="https://support.torproject.org/faq/staying-anonymous/">Tor staying-anonymous</a></p>
</li>
<li>
<p><a href="https://ssd.eff.org/module/how-to-use-tor">How to Use Tor</a></p>
</li>
<li>
<p><a href="https://torproject.github.io/manual/secure-connections/">Cool Graphic Showing Secure Connections with Tor</a></p>
</li>
</ul>
</li>
</ul>
<h4 id="searxng"><a class="header" href="#searxng">SearXNG</a></h4>
<p>SearXNG is a privacy-respecting metasearch engine that aggregates results from
various search services, such as Google, DuckDuckGo, etc without tracking you or
profiling your searches.</p>
<ul>
<li><a href="https://wiki.nixos.org/wiki/SearXNG">SearXNG on NixOS</a>
<ul>
<li><a href="https://docs.searxng.org/">Welcome to SearXNG</a></li>
</ul>
</li>
</ul>
<h4 id="hardening-other-browsers"><a class="header" href="#hardening-other-browsers">Hardening Other Browsers</a></h4>
<p>If the above browsers aren't for you, you can harden the browser you're using
now. For example, Firefox has a lot of documentation on hardening:</p>
<ul>
<li>
<p><a href="https://brainfucksec.github.io/firefox-hardening-guide">Firefox Hardening Guide</a></p>
</li>
<li>
<p><a href="https://simeononsecurity.com/guides/enhance-firefox-security-configuring-guide/">STIG Firefox Hardening</a></p>
</li>
<li>
<p><a href="https://stigviewer.com/stigs/mozilla_firefox">Mozilla Firefox Security Technical Implementation Guide</a>
The STIG for Mozilla Firefox (Security Technical Implementation Guide) is a
set of security configuration standards developed by the U.S. Department of
Defense. They are created by the Defense Information Systems Agency (DISA) to
secure and harden DoD information systems and software.</p>
</li>
</ul>
<p><strong>LibreWolf</strong> is an open-source fork of Firefox with a strong focus on privacy,
security, and user freedom. LibreWolf enables always HTTPS, includes
uBlockOrigin, and only includes privacy focused search engines by default among
other strong defaults. Also, since LibreWolf is a fork of Firefox most of the
other hardening options work for it as well.</p>
<ul>
<li>
<p><a href="https://wiki.nixos.org/wiki/Librewolf">NixOS Wiki LibreWolf</a>, the options in
the wiki make it less secure and aren't recommended settings to use. They
explicitly disable several of LibreWolf's default privacy-enhancing features,
such as fingerprinting resistance and clearing session data on shutdown.</p>
</li>
<li>
<p><a href="https://librewolf.net/docs/features/">LibreWolf Features</a> You still need to
enable DNS over HTTPS through privacy settings.</p>
</li>
</ul>
<p>Example LibreWolf config implementing many of the STIG recommendations:</p>
<details>
<summary> ✔️ Click to expand LibreWolf Example </summary>
<pre><code class="language-nix"># librewolf.nix
{pkgs, lib, config, ...}: let
  cfg = config.custom.librewolf;
in {
  options.custom.librewolf = {
    enable = lib.mkOption {
      type = lib.types.bool;
      default = true;
      description = "Enable the LibreWolf Module";
    };
  };

  config = lib.mkIf cfg.enable {
    programs.librewolf = {
      enable = true;
      policies = {
        # A bit annoying
        DontCheckDefaultBrowser = true;
        # Pocket is insecure according to DoD
        DisablePocket = true;
        # No imperative updates
        DisableAppUpdate = true;
      };
      settings = {
        # // SV-16925 - DTBF030
        "security.enable_tls" = true;
        # // SV-16925 - DTBF030
        "security.tls.version.min" = 2;
        # // SV-16925 - DTBF030
        "security.tls.version.max" = 4;

        # // SV-111841 - DTBF210
        "privacy.trackingprotection.fingerprinting.enabled" = true;

        # // V-252881 - Retaining Data Upon Shutdown
        "browser.sessionstore.privacy_level" = 0;

        # // SV-251573 - Customizing the New Tab Page
        "browser.newtabpage.activity-stream.enabled" = false;
        "browser.newtabpage.activity-stream.feeds.section.topstories" = false;
        "browser.newtabpage.activity-stream.showSponsored" = false;
        "browser.newtabpage.activity-stream.feeds.snippets" = false;

        # // V-251580 - Disabling Feedback Reporting
        "browser.chrome.toolbar_tips" = false;
        "browser.selfsupport.url" = "";
        "extensions.abuseReport.enabled" = false;
        "extensions.abuseReport.url" = "";

        # // V-251558 - Controlling Data Submission
        "datareporting.policy.dataSubmissionEnabled" = false;
        "datareporting.healthreport.uploadEnabled" = false;
        "datareporting.policy.firstRunURL" = "";
        "datareporting.policy.notifications.firstRunURL" = "";
        "datareporting.policy.requiredURL" = "";

        # // V-252909 - Disabling Firefox Studies
        "app.shield.optoutstudies.enabled" = false;
        "app.normandy.enabled" = false;
        "app.normandy.api_url" = "";

        # // V-252908 - Disabling Pocket
        "extensions.pocket.enabled" = false;

        # // V-251555 - Preventing Improper Script Execution
        "dom.disable_window_flip" = true;

        # // V-251554 - Restricting Window Movement and Resizing
        "dom.disable_window_move_resize" = true;

        # // V-251551 - Disabling Form Fill Assistance
        "browser.formfill.enable" = false;

        # // V-251550 - Blocking Unauthorized MIME Types
        "plugin.disable_full_page_plugin_for_types" = "application/pdf,application/fdf,application/xfdf,application/lso,application/lss,application/iqy,application/rqy,application/lsl,application/xlk,application/xls,application/xlt,application/pot,application/pps,application/ppt,application/dos,application/dot,application/wks,application/bat,application/ps,application/eps,application/wch,application/wcm,application/wb1,application/wb3,application/rtf,application/doc,application/mdb,application/mde,application/wbk,application/ad,application/adp";
      };
    };
    xdg.desktopEntries.librewolf = {
      name = "LibreWolf";
      exec = "${pkgs.librewolf}/bin/librewolf";
    };
    xdg.mimeApps = {
      enable = true;
      defaultApplications = {
        "text/html" = "librewolf.desktop";
        "x-scheme-handler/http" = "librewolf.desktop";
        "x-scheme-handler/https" = "librewolf.desktop";
        "x-scheme-handler/about" = "librewolf.desktop";
        "x-scheme-handler/unknown" = "librewolf.desktop";
      };
    };
  };
}
</code></pre>
<p>And enable it in your <code>home.nix</code> or equivalent with:</p>
<pre><code class="language-nix"># home.nix
custom.librewolf.enable = true;
</code></pre>
<p>The <code>xdg</code> settings at the end make LibreWolf the defaults for what is listed.</p>
<p>Thanks to <code>JosefKatic</code> for putting the above settings in NixOS format.</p>
<p>There are more hardening parameters that can be set but this should be a good
starting point for a hardened version of LibreWolf.</p>
</details>
<h3 id="virtual-private-networks-vpns"><a class="header" href="#virtual-private-networks-vpns">Virtual Private Networks (VPNs)</a></h3>
<p>A <strong>VPN</strong> (Virtual Private Network) encrypts your Internet connection and routes
your traffic through a VPN provider’s servers, masking your IP address from
local network observers, ISPs, and websites. Using a VPN can prevent your ISP or
local Wi-Fi owner from tracking what sites you visit (they only see a connection
to the VPN), and can help circumvent some regional restrictions or filtering.</p>
<p>However, VPNs simply shift your trust: Instead of your ISP seeing your activity,
your VPN provider can, so you must trust their privacy policies and
infrastructure. Quality and privacy protections vary widely from one VPN company
to another.</p>
<p>You can use a VPN with Tor, but it's not recommended unless you're an advanced
user who knows how to configure both in a way that doesn't compromise your
privacy.</p>
<p><strong>Popular VPNs on NixOS</strong></p>
<ul>
<li>
<p><a href="https://wiki.nixos.org/wiki/Mullvad_VPN">Mullvad VPN</a> Mullvad VPN uses
WireGuard under the hood and only works if <code>systemd-resolvd</code> is enabled.</p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/WireGuard">WireGuard VPN</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/Tailscale">Tailscale</a></p>
</li>
<li>
<p><a href="https://wiki.nixos.org/wiki/OpenVPN">OpenVPN</a></p>
</li>
</ul>
<h2 id="encrypted-dns"><a class="header" href="#encrypted-dns">Encrypted DNS</a></h2>
<p>DNS (Domain Name System) resolution is the process of translating a website's
domain name into its corresponding IP address. By default, this traffic isn't
encrypted, which means anyone on the network, from your ISP to potential
hackers, can see the websites you're trying to visit. <strong>Encrypted DNS</strong> uses
protocols to scramble this information, protecting your queries and responses
from being intercepted and viewed by others.</p>
<p>There are 3 main types of DNS protection:</p>
<ul>
<li>
<p><strong>DNS over HTTPS (DoH)</strong>: Uses the HTTPS protocol to encrypt data between the
client and the resolver.</p>
</li>
<li>
<p><strong>DNS over TLS (DoT)</strong>: Similar to (DoH), differs in the methods used for
encryption and delivery using a separate port from HTTPS.</p>
</li>
<li>
<p><strong>DNSCrypt</strong>: Uses end-to-end encryption with the added benefit of being able
to prevent DNS spoofing attacks.</p>
</li>
</ul>
<p>Useful resources:</p>
<details>
<summary> ✔️ Click to Expand DNS Resources </summary>
<ul>
<li>
<p><a href="https://wiki.nixos.org/wiki/Encrypted_DNS">NixOS Wiki Encrypted DNS</a></p>
</li>
<li>
<p><a href="https://www.cloudflare.com/learning/dns/what-is-dns/">Domain Name System (DNS)</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/DNS_over_HTTPS">Wikipedia DNS over HTTPS (DoH)</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/DNS_over_TLS">Wikipedia DNS over TLS (DoT)</a></p>
</li>
<li>
<p><a href="https://blog.cloudflare.com/dns-encryption-explained/">Cloudflare Dns Encryption Explained</a></p>
</li>
<li>
<p><a href="https://nordvpn.com/blog/encrypted-dns-traffic/">NordVPN Encrypted Dns Traffic</a></p>
</li>
</ul>
</details>
<p>The following sets up dnscrypt-proxy using DoH (DNS over HTTPS) with an oisd
blocklist, they both come directly from the Wiki:</p>
<p>Add <code>oisd</code> to your flake inputs:</p>
<pre><code class="language-nix"># flake.nix
inputs = {
    oisd = {
      url = "https://big.oisd.nl/domainswild";
      flake = false;
    };
};
</code></pre>
<p>And the import the following into your <code>configuration.nix</code>:</p>
<pre><code class="language-nix"># dnscrypt-proxy.nix
{
  pkgs,
  lib,
  inputs,
  ...
}: let
  blocklist_base = builtins.readFile inputs.oisd;
  extraBlocklist = '''';
  blocklist_txt = pkgs.writeText "blocklist.txt" ''
    ${extraBlocklist}
    ${blocklist_base}
  '';
  hasIPv6Internet = true;
  StateDirectory = "dnscrypt-proxy";
in {
  networking = {
    # Set DNS nameservers to the local host addresses for iPv4 (`127.0.0.1`) &amp; iPv6 (::1)
    nameservers = ["127.0.0.1" "::1"];
    # If using dhcpcd
    # dhcpcd.extraConfig = "nohook resolv.conf";
    # If using NetworkManager
    networkmanager.dns = "none";
  };
  services.resolved.enable = lib.mkForce false;
  # See https://wiki.nixos.org/wiki/Encrypted_DNS
  services.dnscrypt-proxy2 = {
    enable = true;
    # See https://github.com/DNSCrypt/dnscrypt-proxy/blob/master/dnscrypt-proxy/example-dnscrypt-proxy.toml
    settings = {
      # See https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md
      sources.public-resolvers = {
        urls = [
          "https://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/public-resolvers.md"
          "https://download.dnscrypt.info/resolvers-list/v3/public-resolvers.md"
        ];
        minisign_key = "RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3";
        cache_file = "/var/lib/${StateDirectory}/public-resolvers.md";
      };

      # Use servers reachable over IPv6 -- Do not enable if you don't have IPv6 connectivity
      ipv6_servers = hasIPv6Internet;
      block_ipv6 = ! hasIPv6Internet;
      blocked_names.blocked_names_file = blocklist_txt;
      require_dnssec = true;
      # Logs can get large very quickly...
      require_nolog = false;
      require_nofilter = true;

      # If you want, choose a specific set of servers that come from your sources.
      # Here it's from https://github.com/DNSCrypt/dnscrypt-resolvers/blob/master/v3/public-resolvers.md
      # If you don't specify any, dnscrypt-proxy will automatically rank servers
      # that match your criteria and choose the best one.
      # server_names = [ ... ];
    };
  };

  systemd.services.dnscrypt-proxy2.serviceConfig.StateDirectory = StateDirectory;
}
</code></pre>
<pre><code class="language-bash"># You should see that dnscrypt-proxy chooses the Server with the lowest initial latency
sudo systemctl status dnscrypt-proxy2
# verify that dnscrypt-proxy is listening
sudo ss -lnp | grep 53
# Test a DNS query, if you get valid responses it's working
dig @127.0.0.1 example.com +short
# check the logs
sudo journalctl -u dnscrypt-proxy2
</code></pre>
<p><code>dnscrypt-proxy2</code> acts as your local DNS resolver listening on your machine
(<code>127.0.0.1</code>) for IPv4 and <code>::1</code> for iPv6.</p>
<p><code>inputs.oisd</code> refers to the flake input oisd blocklist, it prevents your device
from connecting to unwanted or harmful domains.</p>
<ul>
<li><a href="https://oisd.nl/">oisd.nl</a> the oisd website</li>
</ul>
<p><code>dnscrypt-proxy2</code> filters ads/trackers (using oisd), enforces DNSSEC, and uses
encrypted transports (DNS-over-HTTPS/DoH, DNSCrypt, optionally
DNS-over-TLS/DoT).</p>
<h2 id="firewalls"><a class="header" href="#firewalls">Firewalls</a></h2>
<p><a href="https://www.cloudflare.com/learning/security/what-is-a-firewall/">Cloudflare What is a Firewall</a></p>
<p>NixOS includes an integrated firewall based on iptables/nftables.</p>
<p><a href="https://linux-audit.com/networking/nftables/nftables-beginners-guide-to-traffic-filtering/">Beginners guide to nftables</a></p>
<p><a href="https://wiki.archlinux.org/title/Nftables">Arch Wiki nftables</a></p>
<p>The following firewall setup is based on the dnscrypt setup above utilizing
nftables:</p>
<pre><code class="language-nix">{...}: {
  networking.nftables = {
    enable = true;

    ruleset = ''
      table inet filter {
        chain output {
          # Allow localhost DNS for dnscrypt-proxy2
          ip daddr 127.0.0.1 udp dport 53 accept
          ip6 daddr ::1 udp dport 53 accept
          ip daddr 127.0.0.1 tcp dport 53 accept
          ip6 daddr ::1 tcp dport 53 accept
          # Allow dnscrypt-proxy2 to talk to upstream
          # ps -o uid,user,pid,cmd -C dnscrypt-proxy; Copy UID #
          meta skuid 62396 udp dport { 443, 853 } accept
          meta skuid 62396 tcp dport { 443, 853 } accept
          # Block all other outbound DNS
          udp dport { 53, 853 } drop
          tcp dport { 53, 853 } drop
        }
      }
    '';
  };

  networking.firewall = {
    enable = true;
    allowedTCPPorts = [
      53 # DNS
      22 # SSH
      80 # HTTP
      443 # HTTPS
    ];
    allowedUDPPorts = [
      53 # DNS
    ];
  };
}
</code></pre>
<p>The firewall ensures only your authorized, local encrypted DNS proxy process can
speak DNS with the outside world, and that all other DNS requests from any other
process are blocked unless they're to <code>127.0.0.1</code> (our local proxy). This is a
robust policy against both DNS leaks and local compromise.</p>
<p>Review listening ports: After each rebuild, use <code>ss -tlpn</code>, <code>nmap</code> or <code>netstat</code>
to see which services are accepting connections. Close or firewall anything
unnecessary.</p>
<h2 id="opensnitch"><a class="header" href="#opensnitch">OpenSnitch</a></h2>
<ul>
<li><a href="https://wiki.nixos.org/wiki/OpenSnitch">NixOS Wiki OpenSnitch</a></li>
</ul>
<p><a href="https://github.com/evilsocket/opensnitch">Opensnitch</a> is an open-source
application firewall that focuses on monitoring and controlling outgoing network
connections on a per-application basis.</p>
<p>This can be used to block apps from accessing the internet that shouldn't need
to (i.e., block telemetry and more). Opensnitch will report that the app has
attempted to make an outbound internet connection and block it or allow it based
on the rules you set.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/hardening_NixOS.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../vcs/git.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/hardening_NixOS.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../vcs/git.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
