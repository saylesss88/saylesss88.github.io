<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Running NixOS as a VM - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">‚Üë</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="running-nixos-in-a-vm-with-maximum-isolation-beginner-guide"><a class="header" href="#running-nixos-in-a-vm-with-maximum-isolation-beginner-guide">Running NixOS in a VM with Maximum Isolation (Beginner Guide)</a></h1>
<details>
<summary> Click to Expand Table of Contents</summary>
<!-- toc -->
</details>
<p><img src="images/steampunk5.cleaned.png" alt="sp5" /></p>
<h2 id="why-this-setup"><a class="header" href="#why-this-setup">Why This Setup?</a></h2>
<ul>
<li>
<p><strong>Host</strong> <code>secureblue</code> = Fedora Atomic with <strong>SELinux enforcing</strong>, <strong>sVirt</strong>,
<strong>Secure Boot</strong>, and hardened defaults.</p>
</li>
<li>
<p><strong>Guest</strong>: NixOS in a VM ‚Üí full declarative power, zero risk to host.</p>
</li>
<li>
<p><strong>Isolation</strong>: MAC via SELinux + KVM + no direct hardware access.</p>
</li>
</ul>
<hr />
<h2 id="step-1-install-secureblue-hardened-host"><a class="header" href="#step-1-install-secureblue-hardened-host">Step 1: Install secureblue (Hardened Host)</a></h2>
<blockquote>
<p>NOTE: Secureblue enables the hardened_malloc by default which causes problems
for many browsers and will cause screen flashing with Firefox and others
within the VM. See:</p>
</blockquote>
<ul>
<li><a href="https://secureblue.dev/faq#standard-malloc">secureblue standard_malloc</a></li>
</ul>
<ol>
<li>
<p>Download a <a href="https://secureblue.dev/install">secureblue image</a></p>
</li>
<li>
<p>Use <strong>Fedora Media Writer</strong> (Flatpak):</p>
</li>
</ol>
<pre><code class="language-bash">flatpak install flathub org.fedoraproject.MediaWriter
</code></pre>
<ol start="3">
<li>
<p>Flash the secureblue image &amp; enable Secure Boot in UEFI <strong>before</strong> install.
This is now possible with Fedora, when you boot into Fedora Media Writer (not
Ventoy or Rufus), you will be allowed to enroll the secure boot key with
secure boot pre-enabled.</p>
</li>
<li>
<p>On first boot:</p>
</li>
</ol>
<pre><code class="language-bash">ujust enroll-secureblue-secure-boot-key
</code></pre>
<ul>
<li>Reboot -&gt; Enroll key in MOK manager with password: <code>secureblue</code></li>
</ul>
<ol start="5">
<li>
<p>Post-install hardening See:
<a href="https://secureblue.dev/post-install">post-install</a></p>
</li>
<li>
<p>Install virtualization stack:</p>
</li>
</ol>
<pre><code class="language-bash">ujust install-libvirt-packages
</code></pre>
<ul>
<li>
<p>The above command enables <code>qemu</code>, <code>libvirt</code>, &amp; <code>virt-manager</code> with SELinux
labels.</p>
</li>
<li>
<p>Read the <a href="https://secureblue.dev/faq">secureblue FAQ</a> to learn the quirks of
an atomic fedora image.</p>
</li>
</ul>
<p>Secureblue recommends installing GUI apps with Flatpak, CLI apps with homebrew,
and apps that require more system access to be layered with rpm-ostree. It takes
some getting used to but is very stable.</p>
<ul>
<li><a href="https://secureblue.dev/faq#software">secureblue how to install software</a></li>
</ul>
<hr />
<h2 id="create-nixos-vm-via-virt-manager"><a class="header" href="#create-nixos-vm-via-virt-manager">Create NixOS VM (via virt-manager)</a></h2>
<ol>
<li>
<p>Download: <a href="https://nixos.org/download/">NixOS Graphical ISO</a></p>
</li>
<li>
<p>Open <code>virt-manager</code> -&gt; File -&gt; New Virtual Machine</p>
</li>
</ol>
<ul>
<li>
<p>Select ISO</p>
</li>
<li>
<p>CPU: <code>host-passthrough</code> (optional, for performance)</p>
</li>
<li>
<p>Do some research to find the ideal Memory and Storage for your system.</p>
</li>
</ul>
<ol start="3">
<li>
<p>Ensure SELinux is enabled (the default for secureblue) with: <code>getenforce</code></p>
</li>
<li>
<p>Ensure sVirt is enabled (the default) with <code>run0 ps -eZ | grep qemu</code>.</p>
</li>
</ol>
<pre><code class="language-bash">run0 ps -eZ | grep qemu
# Output
system_u:system_r:svirt_t:s0:c383,c416 14793 ?   00:01:37 qemu-system-x86
</code></pre>
<ol start="5">
<li>Boot -&gt; Follow graphical installer:</li>
</ol>
<ul>
<li>
<p>Enable LUKS</p>
</li>
<li>
<p>Create an admin user</p>
</li>
<li>
<p>Optionally skip desktop -&gt; install your own after first boot.</p>
</li>
</ul>
<p>The attack surface is reduced significantly when running NixOS within a hardened
hosts VM. The VM operates on virtualized hardware, which is a powerful form of
attack surface reduction.</p>
<p>Devices like your host's Bluetooth adapter, Wi-Fi card, microphone, webcam, and
USB ports are not directly exposed to the guest operating system. The VM only
sees virtual versions of these devices. If an exploit targets a vulnerability in
the Bluetooth stack within the VM, it compromises the VM environment, but it
cannot typically reach and exploit the physical Bluetooth hardware on the host.</p>
<p>You can also choose not to pass through certain devices, like Bluetooth or
webcam to the VM at all, effectively disabling that attack vector. Since your
host likely already has these hardened features you may not need the additional
functionality within the VM.</p>
<p>If something breaks, you have an option to rollback to the previous generation
with <code>rpm-ostree rollback</code>. The previous generation will be applied on next
reboot. You can also just reboot and choose the previous generation through the
grub menu, this way it is temporary and will revert back on next reboot.</p>
<hr />
<h2 id="-how-host-mac-secures-the-nixos-vm"><a class="header" href="#-how-host-mac-secures-the-nixos-vm">üîí How Host MAC Secures the NixOS VM</a></h2>
<p>The core security principle here is defense-in-depth, where the outer, hardened
layer (the host) compensates for potential weaknesses in the inner layer (the
guest).</p>
<ol>
<li>MAC Confinement via SELinux and sVirt sVirt (Secure Virtualization): This is
a critical component running on the secureblue host. It automatically assigns
unique SELinux labels to all virtualization components.</li>
</ol>
<p><strong>QEMU Process Confinement</strong>: The entire QEMU process that runs the NixOS VM is
confined by a specific SELinux type, typically <code>svirt_t</code>. This means:</p>
<p>The host's MAC policy strictly controls what the QEMU process can access and do
on the host system.</p>
<p>If an attacker were to achieve a "VM breakout" (a worst-case scenario where they
escape the VM and try to interact with the host OS), their activity would still
be confined by the extremely strict rules of the <code>svirt_t</code> label. They would not
be able to arbitrarily read host files or compromise the host kernel.</p>
<p><strong>Disk Image Confinement</strong>: The VM's disk images are also labeled, typically as
virt_image_t, preventing other processes on the host from accessing or tampering
with them.</p>
<ol start="2">
<li><strong>KVM and Host Hardening KVM</strong>: KVM provides the low-level, hardware-assisted
virtualization. It is an extremely secure and audited hypervisor that creates
a strong barrier between the guest and the host kernel.</li>
</ol>
<p><strong>Secureblue Hardening</strong>: The secureblue host is designed with SELinux
enforcing, Secure Boot, a hardened kernel, and hardened_malloc by default, which
minimizes the attack surface and ensures the integrity of the base operating
system that's running the VM.</p>
<ol start="3">
<li><strong>Isolation and Zero Host Risk Decoupling Security</strong>: The security of the
host is completely decoupled from the security of the NixOS guest.</li>
</ol>
<p>Any compromise within the NixOS VM (e.g., a service vulnerability,
misconfiguration, or user error) will be contained by the host's isolation
mechanisms (KVM + SELinux + sVirt). This containment means the host remains
secure ("Zero host compromise"), regardless of the NixOS VM's internal security
settings, including its lack of default MAC.</p>
<p>In short, the security boundary isn't the guest OS's (NixOS) configuration, but
the hypervisor and the host's MAC policy that enforces the complete isolation of
the VM</p>
<h2 id="its-still-recommended-to-harden-the-guest-vm-nixos"><a class="header" href="#its-still-recommended-to-harden-the-guest-vm-nixos">It's still recommended to harden the Guest VM (NixOS)</a></h2>
<p>Hardening the NixOS guest VM adds an extra, independent layer of defense,
helping to protect the system beyond what the host provides.</p>
<p><strong>Best Practices for Minimizing VM Device Exposure</strong></p>
<blockquote>
<p>Much of the Host hardening is taken care of by secureblue with the ujust
command.</p>
</blockquote>
<p>Take a VM snapshot right after a fresh install. This snapshot acts as a clean
restore point. Many people safely test malware or potentially dangerous software
by running it within the VM, then reverting to the snapshot afterward to wipe
out any changes or infections caused by the malware.</p>
<p>Avoid unnecessary device passthrough: Only pass through hardware devices (like
USB, GPU, or network interfaces) that are essential for your VM's operation. For
example, if a device isn't needed within the VM, do not passthrough the device
to reduce attack surface.‚Äã</p>
<p>Use virtual network segmentation: Instead of bridging physical network devices,
opt for virtual network configurations like isolated networks, VLANs, or
internal networks that prevent VM-to-VM or VM-to-host communication unless
explicitly allowed.‚Äã</p>
<p>Implement network filtering and firewall rules: Use libvirt nwfilter, iptables,
or firewalld rules to restrict communications between VMs and external networks,
or between guest VMs on the same host.‚Äã</p>
<ul>
<li><a href="https://libvirt.org/firewall.html">libvirt Firewall and network filtering</a></li>
</ul>
<p>Use virtual device models with minimal capabilities: Prefer virtio or similar
paravirtualized devices that have a smaller attack surface. Avoid emulated
devices when not necessary.‚Äã</p>
<p>Disable features like USB debugging, audio, or PnP devices: These can
potentially be exploited or leak information if enabled unnecessarily.</p>
<ul>
<li>It's still recommended to enable either the <code>graphene-hardened</code> or
<code>graphene-hardened-light</code> memory allocators on the NixOS guest machine as
well.</li>
</ul>
<pre><code class="language-nix"># configuration.nix
environment.memoryAllocator.provider = "graphene-hardened";
# OR for a more permissive and better performing allocator:
# environment.memoryAllocator.provider = "graphene-hardened-light";
</code></pre>
<p>Continue
<a href="https://saylesss88.github.io/nix/hardening_NixOS.html">hardening NixOS</a></p>
<blockquote>
<p>‚ùóÔ∏è NOTE: It‚Äôs generally recommended not to enable GPU drivers inside the VM
unless you are specifically doing GPU passthrough, as this often causes
stability and compatibility issues. GPU passthrough itself requires careful
configuration and dedicated hardware, and introduces additional attack
surfaces.</p>
</blockquote>
<blockquote>
<p>Regarding IPv6 networking, enabling it typically requires using a bridged
network setup rather than NAT, which connects the VM more directly to the
host's network. While bridged networking enables full IPv6 functionality, it
also reduces the network isolation between the VM and host, potentially
increasing security risks. For maximum isolation, consider carefully whether
you need IPv6 connectivity inside the VM and weigh that against your security
goals.</p>
</blockquote>
<p>I have been able to recover from quite a few missteps with Secureblue. I run a
mini PC and attempted running <code>ujust update-firmware</code>, some systems allow you to
update the firmware of a booted system. On reboot I got a message "Something
went seriously wrong MOK is full", it then forced a shutdown. I was familiar
with resetting the NVRAM by disassembling the PC and moving the red jumper from
prongs 1 &amp; 2 to prongs 2 &amp; 3 with the power off for 10 seconds. I then moved the
jumper back to the default position and rebooted. The PC sounds like it's
revving up a few times and does a few reboots and allowed me to sign right back
in and re-enroll the secure boot key.</p>
<h3 id="resources"><a class="header" href="#resources">Resources</a></h3>
<ul>
<li>
<p><a href="https://www.redhat.com/en/topics/virtualization/what-is-virtualization">RedHat What is virtualization?</a></p>
</li>
<li>
<p><a href="https://sumit-ghosh.com/posts/virtualization-hypervisors-explaining-qemu-kvm-libvirt/">virtualization &amp; hypervisors</a></p>
</li>
<li>
<p><a href="https://bitgrounds.tech/posts/kvm-qemu-libvirt-virtualization/">Virtualization on Linux using the KVM/QEMU/Libvirt stack</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/whonix_kvm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../vcs/git.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/whonix_kvm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../vcs/git.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
