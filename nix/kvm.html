<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Running NixOS as a VM - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="running-nixos-in-a-vm-with-maximum-isolation-beginner-guide"><a class="header" href="#running-nixos-in-a-vm-with-maximum-isolation-beginner-guide">Running NixOS in a VM with Maximum Isolation (Beginner Guide)</a></h1>
<h2 id="why-this-setup"><a class="header" href="#why-this-setup">Why This Setup?</a></h2>
<ul>
<li>
<p><strong>Host</strong>: <code>secureblue</code> = Fedora Atomic with <strong>SELinux enforcing</strong>, <strong>sVirt</strong>,
<strong>Secure Boot</strong>, and hardened defaults.</p>
</li>
<li>
<p><strong>Guest</strong>: NixOS in a VM → full declarative power, zero risk to host.</p>
</li>
<li>
<p><strong>Isolation</strong>: MAC via SELinux + KVM + no direct hardware access.</p>
</li>
</ul>
<hr />
<h2 id="step-1-install-secureblue-hardened-host"><a class="header" href="#step-1-install-secureblue-hardened-host">Step 1: Install secureblue (Hardened Host)</a></h2>
<ol>
<li>
<p>Download a secureblue image:<br />
<a href="https://secureblue.dev/install">https://secureblue.dev/install</a></p>
</li>
<li>
<p>Use <strong>Fedora Media Writer</strong> (Flatpak):</p>
</li>
</ol>
<pre><code class="language-bash">flatpak install flathub org.fedoraproject.MediaWriter
</code></pre>
<ol start="3">
<li>
<p>Flash the secureblue image &amp; enable Secure Boot in UEFI <strong>before</strong> install.</p>
</li>
<li>
<p>On first boot:</p>
</li>
</ol>
<pre><code class="language-bash">ujust enroll-secureblue-secure-boot-key
</code></pre>
<ul>
<li>Reboot -&gt; Enroll key in MOK manager with password: <code>secureblue</code></li>
</ul>
<ol start="5">
<li>
<p>Post-install hardening: <a href="https://secureblue.dev/post-install">https://secureblue.dev/post-install</a></p>
</li>
<li>
<p>Install virtualization stack:</p>
</li>
</ol>
<pre><code class="language-bash">ujust install-libvirt-packages
</code></pre>
<ul>
<li>
<p>The above command enables <code>qemu</code>, <code>libvirt</code>, &amp; <code>virt-manager</code> with SELinux
labels.</p>
</li>
<li>
<p>Read the <a href="https://secureblue.dev/faq">secureblue FAQ</a> to learn the quirks of
an atomic fedora image.</p>
</li>
</ul>
<p>Secureblue recommends installing GUI apps with Flatpak, CLI apps with homebrew,
and apps that require more system access to be layered with rpm-ostree. It takes
some getting used to but is very stable.</p>
<ul>
<li><a href="https://secureblue.dev/faq#software">secureblue how to install software</a></li>
</ul>
<hr />
<h2 id="create-nixos-vm-via-virt-manager"><a class="header" href="#create-nixos-vm-via-virt-manager">Create NixOS VM (via virt-manager)</a></h2>
<ol>
<li>
<p>Download: NixOS Graphical ISO (GNOME): <a href="https://nixos.org/download/">https://nixos.org/download/</a></p>
</li>
<li>
<p>Open <code>virt-manager</code> -&gt; File -&gt; New Virtual Machine</p>
</li>
</ol>
<ul>
<li>
<p>Select ISO</p>
</li>
<li>
<p>CPU: <code>host-passthrough</code> (optional, for performance)</p>
</li>
<li>
<p>Do some research to find the ideal Memory and Storage for your system.</p>
</li>
</ul>
<ol start="3">
<li>
<p>Ensure SELinux is enabled (the default for secureblue) with: <code>getenforce</code></p>
</li>
<li>
<p>Ensure sVirt is enabled (the default) with <code>run0 ps -eZ | grep qemu</code>.</p>
</li>
</ol>
<pre><code class="language-bash">run0 ps -eZ | grep qemu
# Output
system_u:system_r:svirt_t:s0:c383,c416 14793 ?   00:01:37 qemu-system-x86
</code></pre>
<ol start="5">
<li>Boot -&gt; Follow graphical installer:</li>
</ol>
<ul>
<li>
<p>Enable LUKS</p>
</li>
<li>
<p>Create an admin user</p>
</li>
<li>
<p>Optionally skip desktop -&gt; install your own after first boot.</p>
</li>
</ul>
<hr />
<h2 id="-how-host-mac-secures-the-nixos-vm"><a class="header" href="#-how-host-mac-secures-the-nixos-vm">🔒 How Host MAC Secures the NixOS VM</a></h2>
<p>The core security principle here is defense-in-depth, where the outer, hardened
layer (the host) compensates for potential weaknesses in the inner layer (the
guest).</p>
<ol>
<li>MAC Confinement via SELinux and sVirt sVirt (Secure Virtualization): This is
a critical component running on the secureblue host. It automatically assigns
unique SELinux labels to all virtualization components.</li>
</ol>
<p><strong>QEMU Process Confinement</strong>: The entire QEMU process that runs the NixOS VM is
confined by a specific SELinux type, typically <code>svirt_t</code>. This means:</p>
<p>The host's MAC policy strictly controls what the QEMU process can access and do
on the host system.</p>
<p>If an attacker were to achieve a "VM breakout" (a worst-case scenario where they
escape the VM and try to interact with the host OS), their activity would still
be confined by the extremely strict rules of the <code>svirt_t</code> label. They would not
be able to arbitrarily read host files or compromise the host kernel.</p>
<p><strong>Disk Image Confinement</strong>: The VM's disk images are also labeled, typically as
virt_image_t, preventing other processes on the host from accessing or tampering
with them.</p>
<ol start="2">
<li>KVM and Host Hardening KVM: KVM provides the low-level, hardware-assisted
virtualization. It is an extremely secure and audited hypervisor that creates
a strong barrier between the guest and the host kernel.</li>
</ol>
<p><strong>Secureblue Hardening</strong>: The secureblue host is designed with SELinux
enforcing, Secure Boot, a hardened kernel, and hardened_malloc by default, which
minimizes the attack surface and ensures the integrity of the base operating
system that's running the VM.</p>
<ol start="3">
<li><strong>Isolation and Zero Host Risk Decoupling Security</strong>: The security of the
host is completely decoupled from the security of the NixOS guest.</li>
</ol>
<p>Any compromise within the NixOS VM (e.g., a service vulnerability,
misconfiguration, or user error) will be contained by the host's isolation
mechanisms (KVM + SELinux + sVirt). This containment means the host remains
secure ("Zero host compromise"), regardless of the NixOS VM's internal security
settings, including its lack of default MAC.</p>
<p>In short, the security boundary isn't the guest OS's (NixOS) configuration, but
the hypervisor and the host's MAC policy that enforces the complete isolation of
the VM</p>
<h2 id="its-still-recommended-to-harden-the-guest-vm-nixos"><a class="header" href="#its-still-recommended-to-harden-the-guest-vm-nixos">It's still recommended to harden the Guest VM (NixOS)</a></h2>
<p>Hardening the NixOS guest creates an additional, independent layer of defense.</p>
<ul>
<li>
<p>Helps mitigate VM Breakout: If a zero-day allows an attacker to acheive a VM
breakout, the security of your system depends entirely on the host's controls.
Hardening the guest makes it much harder to compromise the initial VM,
reducing the chance of even attempting to breakout.</p>
</li>
<li>
<p>Containment within the VM: Hardening prevents an attacker from gaining full
control or moving laterally within the VM.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/whonix_kvm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../vcs/git.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/whonix_kvm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../vcs/git.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
