<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hardening README - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">‚Üë</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hardening-readme"><a class="header" href="#hardening-readme">Hardening README</a></h1>
<p>üìå <strong>How to Use This Guide</strong></p>
<p><strong>Read warnings</strong>: Advanced hardening can break compatibility or cause data
loss! Pause and research before enabling anything not listed above unless you
understand the consequences.</p>
<p>The guide is broken up into 2 chapters:</p>
<ul>
<li>
<p><a href="https://saylesss88.github.io/nix/hardening_NixOS.html">Hardening NixOS</a></p>
</li>
<li>
<p><a href="https://saylesss88.github.io/nix/hardening_networking.html">Hardening Networking</a></p>
</li>
</ul>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>There is a lot covered in this guide which can get overwhelming when trying to
decide what is worth implementing. Here, I will list some common recommendations
that most users should follow to harden their stance.</p>
<h3 id="baseline-hardening"><a class="header" href="#baseline-hardening">Baseline Hardening</a></h3>
<p>Before diving into advanced or specialized hardening, apply these baseline
security measures suitable for all NixOS users. These settings help protect your
system with minimal risk of breaking workflows or causing admin headaches.</p>
<p>There is something to be said about the window manager you use. GNOME, KDE
Plasma, and Sway secure privileged Wayland protocols like screencopy. This means
that on environments outside of GNOME, KDE, and Sway, applications can access
screen content of the entire desktop. This implicitly includes the content of
other applications. It's primarily for this reason that Silverblue, Kinoite, and
Sericea images are recommended. COSMIC has plans to fix this.
--<a href="https://secureblue.dev/images">secureblue Images</a></p>
<p>Secureblue recommends disabling Xwayland and finding alternatives for those apps
as well as disabling <code>xdg-desktop-portal-wlr</code>, this is because the wlroots
desktop portal reintroduces the screencopy vulnerability.</p>
<ul>
<li>
<p>Use Disk Encryption (LUKS) to protect your data at rest.</p>
</li>
<li>
<p>Keep your system up to date (update regularly).</p>
</li>
<li>
<p>Use strong, unique passwords.</p>
</li>
<li>
<p>Avoid reusing passwords, use a password manager.</p>
</li>
<li>
<p>Only enable what you use, and actively disable what's no longer in use.</p>
</li>
<li>
<p>Enable at least a basic firewall, a more complex firewall example that
utilizes nftables is shared in the
<a href="https://saylesss88.github.io/nix/hardening_networking.html">Hardening Networking Chapter</a></p>
</li>
</ul>
<p>The firewall is enabled by default on NixOS. To explicitly ensure it's enabled,
add the following to your <code>configuration.nix</code> or equivalent:</p>
<pre><code class="language-nix"># configuration.nix
# this denies incoming connections but allows outgoing and established connections
networking.firewall.enable = true;
</code></pre>
<p>Many services provide an option to open the required firewall ports
automatically. For example:</p>
<pre><code class="language-nix">services.tor.openFirewall = true;
</code></pre>
<p>This prevents you from having to manually open ports</p>
<p><strong>Audit and remove local user accounts that are no longer needed</strong>: Regularly
review and remove unused or outdated accounts to reduce your system‚Äôs attack
surface, improve compliance, and ensure only authorized users have access. The
following setting ensures that user (and group) management is fully declarative:</p>
<pre><code class="language-nix"># configuration.nix
# All users must be declared
users.mutableUsers = false;
</code></pre>
<p>With <code>users.mutableUsers = false;</code>, all non-declaratively managed (imperative)
user management including creation, modification, or password changes will fail
or be reset on rebuild. User and group definitions become entirely controlled by
your system configuration for maximum reproducibility and security. If you need
to add, remove, or modify users, you must do so in your <code>configuration.nix</code> and
rebuild the system.</p>
<hr />
<blockquote>
<p>NOTE: This reduces the attack surface but</p>
</blockquote>
<p>Create an admin user for administrative tasks and remove your daily user from
the <code>wheel</code> group:</p>
<pre><code class="language-users.nix">{ config, pkgs, lib }:
{
users.users.admin = {
    isNormalUser = true;
    description  = "System administrator";
    extraGroups  = [ "wheel" "libvirtd" ];   # wheel = sudo, libvirtd for VMs
    # run `mkpasswd --method=yescrypt` and replace "changeme" w/ the result
    initialHashedPassword = "changeme";           # change with `passwd admin` later
    openssh.authorizedKeys.keys = [
      # (optional) paste your SSH public key here
      # "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI..."
    ];
  };

  # --------------------------------------------------------------------
  # 2. Existing daily user ‚Äì remove from wheel, keep everything else
  # --------------------------------------------------------------------
  users.users.daily = {
    isNormalUser = true;
    description  = "Daily driver account";
    extraGroups  = lib.mkForce [ "networkmanager" "audio" "video" ]; # keep useful groups
    # Remove `wheel` by *not* listing it (mkForce overrides any default)
  };

security.polkit.enable = true;
security.sudo.enable = false;
# Required for swaylock re-login
security.pam.services.swaylock = {
  text = ''
    auth include login
    account include login
    password include login
    session include login
  '';
 };
}
</code></pre>
<p>You will have to use <code>run0</code> to authenticate your daily user, for example:</p>
<pre><code class="language-bash">run0 nixos-rebuild switch --flake .
</code></pre>
<p>Since <code>run0</code> doesn't cache results and <code>nixos-rebuild</code> calls on Polkit 3 times
so on every rebuild, you will be asked for your password 3 times which isn't
ideal. I found the following workaround that will only ask for your password
once.</p>
<p>I added the following to my <code>configuration.nix</code>, replacing <code>user-name</code> with your
username:</p>
<pre><code class="language-nix"> security.polkit.extraConfig = ''
     polkit.addRule(function(action, subject) {
       if (subject.user == "user-name") {
         if (action.id.indexOf("org.nixos") == 0) {
           polkit.log("Caching admin authentication for single NixOS operation");
           return polkit.Result.AUTH_ADMIN_KEEP;
         }
       }
     });
   '';

</code></pre>
<p>Create a zsh function for easy access:</p>
<pre><code class="language-nix"># zsh.nix
#...snip...
initContent = ''
  fr() {
    run0 nixos-rebuild switch --flake "/home/$USER/flake#"$(hostname)
  }
'';
</code></pre>
<p>Needless to say, this is less secure but much more convenient than entering your
password 3 times on every single rebuild.</p>
<p>Without the <code>pam</code> settings for swaylock, it won't accept your password to log
back in.</p>
<hr />
<blockquote>
<p>NOTE: There is mention of making
<a href="https://github.com/nikstur/userborn">userborn</a> the default for NixOS in the
future. It can be more secure by prohibiting UID/GID re-use and giving
warnings about insecure password hashing schemes.</p>
</blockquote>
<p>I have personally had nothing but problems with <code>userborn</code> and find the docs
extremely lacking, you need to read the source code to figure anything out which
is ridiculous. I don't personally use this but if you figure it out, more power
to ya.</p>
<p>To enable <code>userborn</code>, just add the following to your <code>configuration.nix</code> or
equivalent:</p>
<pre><code class="language-nix"># users.nix
{pkgs,...}:{
services.userborn = {
    enable = true;
    # Only needed if `/etc` is immutable
    # passwordFilesLocation = "/var/lib/nixos/userborn"
};
    users.users = {
       "newuser" = {
         homeMode = "755";
         uid = 1000;
         isNormalUser = true;
         description = "New user account";
         extraGroups = [ "networkmanager" "wheel" "libvirtd" ];
         shell = pkgs.bash;
         ignoreShellProgramCheck = true;
         packages = with pkgs; [];
       };
    };
    }
</code></pre>
<p>With <code>userborn</code>, you configure your users as you normally would declaratively
with NixOS with <code>users.users</code>, change <code>"newuser"</code> to your desired username.</p>
<p>Explicitly setting <code>uid = 1000;</code> is a best practice for compatibility and
predictability.</p>
<hr />
<p>EDITED: 10-29-25 Removed <code>trusted-users</code> section</p>
<p><strong>Only install, enable, and run what is needed</strong>: Disable or uninstall
unnecessary software and services to minimize potential vulnerabilities. Take
advantage of NixOS‚Äôs easy package management and minimalism to keep your system
lean and secure.</p>
<p><strong>Avoid permanently installing temporary tools</strong>: Use tools like <code>nix-shell</code>,
<code>comma</code>, <code>devShells</code> and <code>nix-direnv</code> to test or run software temporarily. This
prevents clutter and reduces potential risks from unused software lingering on
the system.</p>
<p><strong>Update regularly</strong>: Keep your system and software up to date to receive the
latest security patches. Delaying updates leaves known vulnerabilities open to
exploitation.</p>
<p><strong>Apply the Principle of Least Privilege</strong>: Never run tools or services as root
unless absolutely necessary. Create dedicated users and groups with the minimum
required permissions to limit potential damage if compromised.</p>
<p><strong>Use strong passwords and passphrases</strong>: Aim for at least 14‚Äì16 characters by
combining several unrelated words, symbols, and numbers. For example:
<code>sunset-CoffeeHorse$guitar!</code>. Strong passphrases are both memorable and secure.</p>
<p><strong>Use a password manager and enable multi-factor authentication (MFA)</strong>: Manage
unique, strong passwords effectively with a trusted manager and protect accounts
with MFA wherever possible for a second layer of defense.</p>
<p><strong>Check logs regularly</strong>: Reviewing your system logs helps you spot unusual
activity, errors, or failed login attempts that could indicate a security
problem. NixOS uses <code>journald</code> by default, which makes this easy. For example,
to see the logs for your current boot session:</p>
<pre><code class="language-bash">journalctl -b
# for the previous session
journalctl -b -1
</code></pre>
<p>After establishing some standard best practices and a hardened base, it‚Äôs time
to dive deeper into system hardening, the process of adding layered safeguards
throughout your NixOS setup. This next section guides you through concrete steps
and options for hardening critical areas of your system: from encryption and
secure boot to managing secrets, tightening kernel security, and leveraging
platform-specific tools.
<a href="https://saylesss88.github.io/nix/hardening_NixOS.html">Hardening NixOS</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/nixLang/nix_paths.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../nix/hardening_NixOS.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/nixLang/nix_paths.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../nix/hardening_NixOS.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
