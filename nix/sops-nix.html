<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sops-Nix encrypted secrets - nix-book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <a href="#" class="top-link" id="back-to-top">↑</a>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nix-book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sops-nix-encrypted-secrets"><a class="header" href="#sops-nix-encrypted-secrets">Sops-Nix encrypted secrets</a></h1>
<details>
<summary> Click to Expand Table of Contents</summary>
</details>
<p><a href="https://github.com/getsops/sops?ref=blog.gitguardian.com">SOPS</a>, short for
<strong>S</strong>ecrets<strong>OP</strong>eration<strong>S</strong>, is an editor of encrypted files that supports
quite a few BINARY formats and encrypts with AWS KMS, GCP KMS, Azure Key Vault,
age, and PGP.</p>
<p>Managing secrets—like API keys, SSH deploy keys, and password hashes is a
critical part of system configuration, but it’s also one of the trickiest to do
securely and reproducibly. Traditionally, secrets might be stored in ad hoc
locations, referenced by absolute paths, or managed manually outside of version
control. This approach makes it hard to share, rebuild, or audit your
configuration, and increases the risk of accidental leaks or inconsistencies
between systems.</p>
<p><code>sops-nix</code> solves these problems by integrating Mozilla SOPS directly into your
NixOS configuration. Instead of relying on hardcoded file paths or copying
secrets around, you declare your secrets in your Nix code, encrypt them with
strong keys, and let <code>sops-nix</code> handle decryption and placement at activation
time.</p>
<p>Encryption with strong keys, as used by sops-nix, makes brute force attacks
computationally unfeasible with current technology—the time and resources
required to try every possible key would be astronomically high. However, this
protection relies on using strong, secret keys and good security practices;
advances in technology or poor key management can weaken this defense.</p>
<blockquote>
<p>❗ <strong>CRITICAL SECURITY NOTE:</strong> While the encryption itself is robust, this
protection fundamentally relies on using <strong>strong, secret keys</strong> and
<strong>diligent security practices</strong>. If your PGP passphrase is weak, your Age
private key is easily guessable, or the cleartext secret itself is very short
and has low entropy (e.g., "12345", "true", "admin"), an attacker might be
able to compromise your secrets regardless of the encryption.</p>
</blockquote>
<ol>
<li>Add sops to your <code>flake.nix</code>:</li>
</ol>
<pre><code class="language-nix">{
  inputs.sops-nix.url = "github:Mic92/sops-nix";
  inputs.sops-nix.inputs.nixpkgs.follows = "nixpkgs";

  outputs = { self, nixpkgs, sops-nix }: {
    # change `yourhostname` to your actual hostname
    nixosConfigurations.yourhostname = nixpkgs.lib.nixosSystem {
      # customize to your system
      system = "x86_64-linux";
      modules = [
        ./configuration.nix
        sops-nix.nixosModules.sops
      ];
    };
  };
}
</code></pre>
<ol start="2">
<li>Add <code>sops</code> and <code>age</code> to your <code>environment.systemPackages</code>:</li>
</ol>
<pre><code class="language-nix">environment.systemPackages = [
    pkgs.sops
    pkgs.age
];
</code></pre>
<ol start="3">
<li>Generate a key (This is your <strong>private key</strong> and <strong>MUST NEVER BE COMMITTED TO
GIT OR SHARED</strong>):</li>
</ol>
<pre><code class="language-bash">mkdir -p ~/.config/sops/age
age-keygen -o ~/.config/sops/age/keys.txt
</code></pre>
<p>To get the Public Keys Value, run the following command:</p>
<pre><code class="language-bash">age-keygen -y ~/.config/sops/age/keys.txt
age12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl
</code></pre>
<p>Copy the <code>age</code> value it gives you back.</p>
<ol start="4">
<li>Create a <code>.sops.yaml</code> in the same directory as your <code>flake.nix</code>:</li>
</ol>
<pre><code class="language-yaml"># .sops.yaml
keys:
  # Your personal age public key (from age-keygen -y ~/.config/sops/age/keys.txt)
  - &amp;personal_age_key age12zlz6lvcdk6eqaewfylg35w0syh58sm7gh53q5vvn7hd7c6nngyseftjxl

  # You can also use PGP keys if you prefer, but age is often simpler
  # - &amp;personal_pgp_key 0xDEADBEEFCAFE0123

creation_rules:
  # This rule applies to any file named 'secrets.yaml' directly in the 'secrets/' directory
  # or 'secrets/github-deploy-key.yaml' etc.
  - path_regex: "secrets/.*\\.yaml$"
    key_groups:
      - age:
          - *personal_age_key
        # Add host keys for decryption on the target system
        # sops-nix will automatically pick up the system's SSH host keys
        # as decryption keys if enabled in your NixOS config.
        # So you typically don't list them explicitly here unless you
        # want to restrict it to specific fingerprints, which is rare.
        # This part ensures your *personal* key can decrypt it.
</code></pre>
<p>Save it and move on, this file and <code>sops.nix</code> are safe to version control.</p>
<ol start="5">
<li>sops-nix's automatic decryption feature using system SSH host keys only works
with ed25519 host keys for deriving Age decryption keys. Therefore, for
system decryption, ensure your using ed25519 not rsa keys:</li>
</ol>
<pre><code class="language-bash">ssh-keygen -t ed25519 -C "your_email@example.com"
# for multiple keys run something like
ssh-keygen -t ed25519 -f ~/nix-book-deploy-key -C "deploy-key-nix-book-repo"
</code></pre>
<ol start="6">
<li>Copy the <strong>PRIVATE</strong> key for each and add them to your secrets directory:</li>
</ol>
<p>While in your flake directory:</p>
<pre><code class="language-bash">mkdir secrets
sops secrets/github-deploy-key.yaml  # For your github ssh key
</code></pre>
<p>When you call a <code>sops</code> command, it will handle the encryption/decryption
transparently and open the cleartext file in an editor.</p>
<p>Editing will happen in the editor that <code>$SOPS_EDITOR</code> or <code>$EDITOR</code> is set to,
sops will wait for the editor to exit, and then try to reencrypt the file.</p>
<p>The above command will open a default sops <code>github-deploy-key.yaml</code> in your
<code>$EDITOR</code>:</p>
<p>Erase the default <code>sops</code> filler and type <code>github_deploy_key_ed25519: |</code>, move
your cursor 1 line down and type <code>:r ~/.ssh/id_ed25519</code> to read the private key
into the file and repeat as needed.</p>
<pre><code class="language-yaml">github_deploy_key_ed25519: |
  -----BEGIN OPENSSH PRIVATE KEY-----
  ...
  -----END OPENSSH PRIVATE KEY-----

github_deploy_key_ed25519_nix-book: |
  -----BEGIN OPENSSH PRIVATE KEY-----
  ...
  -----END OPENSSH PRIVATE KEY-----
</code></pre>
<p>The <code>-----BEGIN</code> and the rest of the private key <strong>must</strong> be indented 2 spaces</p>
<p>Ensure sops can decrypt it:</p>
<pre><code class="language-bash">sops -d secrets/github-deploy-key.yaml
</code></pre>
<blockquote>
<p>❗ WARNING: Only ever enter your private keys through the <code>sops</code> command. If
you forget and paste them in without the <code>sops</code> command then run <code>git add</code> at
any point, your git history will have contained an unencrypted secret which is
a nono. Always use the <code>sops</code> command when dealing with files in the <code>secrets</code>
directory, save the file and inspect that it is encrypted on save. If not
something went wrong with the <code>sops</code> process, <strong>do not add it to Git</strong>. If you
do, you will be required to rewrite your entire history which can be bad if
you're collaborating with others. <code>git-filter-repo</code> is one such solution that
rewrites your history. Just keep this in mind. This happens because Git has a
protection that stops you from doing stupid things.</p>
</blockquote>
<p>Generate an encrypted password hash with:</p>
<pre><code class="language-bash">mkpasswd -m SHA-512 -s &gt; /tmp/password-hash.txt
# Enter your chosen password and copy the encrypted hash it gives you back
</code></pre>
<pre><code class="language-bash">sops secrets/password-hash.yaml      # For your `hashedPasswordFile`
</code></pre>
<p>The above command will open your <code>$EDITOR</code> with the file <code>password-hash.yaml</code>,
add the following content to it. Replace <code>PasteEncryptedHashHere</code> with the
output of the <code>mkpasswd</code> command above:</p>
<p>Delete the default <code>sops</code> filler, type <code>password_hash:</code> and leave your cursor
after the <code>:</code> and type <code>:r /tmp/password-hash.txt</code></p>
<pre><code class="language-yaml">password_hash: PasteEncryptedHashHere
</code></pre>
<p>Ensure sops can decrypt it:</p>
<pre><code class="language-bash">sops -d secrets/password-hash.yaml
</code></pre>
<ol start="7">
<li>Create a <code>sops.nix</code> and import it or add this directly to your
<code>configuration.nix</code>:</li>
</ol>
<p>My <code>sops.nix</code> is located at <code>~/flake/hosts/hostname/sops.nix</code> and the secrets
directory is located at <code>~/flake/secrets</code> so the path from <code>sops.nix</code> to
<code>secrets/pasword-hash.yaml</code> would be <code>../../secrets/password-hash.yaml</code></p>
<p>Another step you can take is to copy your key to a persistent location,
preparing for impermanence:</p>
<pre><code class="language-bash">sudo mkdir /persist/sops/age
sudo cp ~/.config/sops/age/keys.txt /persist/sops/age/keys.txt
</code></pre>
<p>Then you would change the <code>age.keyFile = "/persist/sops/age/keys.txt"</code> to match
this location below.</p>
<pre><code class="language-nix"># ~/flake/hosts/magic/sops.nix  # magic is my hostname
# hosts/magic/ is also where my configuration.nix is
{...}: {
  sops = {
    defaultSopsFile = ../../.sops.yaml; # Or the correct path to your .sops.yaml
    age.sshKeyPaths = ["/etc/ssh/ssh_host_ed25519_key"];
    age.keyFile = "/home/jr/sops/age/keys.txt";

    secrets = {
      "password_hash" = {
        sopsFile = ../../secrets/password-hash.yaml; # &lt;-- Points to your password hash file
        owner = "root";
        group = "root";
        mode = "0400";
        neededForUsers = true;
      };
      "github_deploy_key_ed25519_nix-book" = {
        sopsFile = ../../secrets/github-deploy-key.yaml;
        key = "github_deploy_key_ed25519_nix-book";
        owner = "root";
        group = "root";
        mode = "0400";
      };
      "github_deploy_key_ed25519" = {
        sopsFile = ../../secrets/github-deploy-key.yaml;
        key = "github_deploy_key_ed25519";
        owner = "root";
        group = "root";
        mode = "0400";
      };
    };
  };
}
</code></pre>
<p>Import <code>sops.nix</code> into your <code>configuration.nix</code> or equivalent:</p>
<pre><code class="language-nix"># configuration.nix
imports = [
  ./sops.nix # Assuming sops.nix is in the same directory as configuration.nix, adjust path as needed
  # ... other imports
];
</code></pre>
<blockquote>
<p>❗ NOTE: You may see in the sops quickstart guide that if you're using
impermanence, the key used for secret decryption (<code>sops.age.keyFile</code>) must be
in a persistent directory, loaded early enough during the boot process. If you
are using the btrfs subvolume layout you don't need to worry about this
because your home will be on its own partition when only the root partition is
wiped on reboot. Adding <code>neededForUsers = true;</code> tells <code>sops-nix</code> to decrypt
and make that secret available earlier in the boot process--specifically,
before user and group accounts are created.</p>
</blockquote>
<p>You typically use <code>age.sshKeyPaths</code> for <strong>system-level secrets</strong> with a
persistent SSH host key</p>
<p>For <strong>user-level secrets</strong>, use <code>age.keyFile</code> pointing to your Age private key,
stored in a safe persistent location.</p>
<p>For reproducibility, keep your key files in a persistent, predictable path and
document which keys are used for which secrets in your <code>.sops.yaml</code>.</p>
<p>If you don't need both <code>age.keyFile</code> and <code>age.sshKeyPaths</code> it can reduce
complexity to use one or the other. Although most people may choose one, it's
not bad to use both it just adds complexity.</p>
<p>And finally use the password-hash for your <code>hashedPasswordFile</code> for your user,
my user is <code>jr</code> so I added this:</p>
<pre><code class="language-nix"># ... snip ...
    users.users = {
      # ${username} = {
      jr = {
        homeMode = "755";
        isNormalUser = true;
        # description = userVars.gitUsername;
        hashedPasswordFile = config.sops.secrets.password_hash.path;
  # ...snip...
</code></pre>
<ol start="8">
<li>Rebuild your configuration and you should see something like this:</li>
</ol>
<pre><code class="language-bash">sops-install-secrets: Imported /etc/ssh/ssh_host_ed25519_key as age key with fingerprint age1smamdkzrwpdxw63hrxxcq8kmejsm4olknsrg72vd0qtfpmlzlvnf8uws38mzuj
</code></pre>
<p>By integrating SOPS with NixOS through <code>sops-nix</code>, you gain a modern, secure,
and reproducible way to manage sensitive secrets. Unlike traditional
approaches—where secrets are often scattered in ad hoc locations, referenced by
absolute paths, or managed outside version control—sops-nix keeps your secrets
encrypted, declarative, and version-control friendly.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nix/encrypted_impermanence.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../nix/lanzaboote.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nix/encrypted_impermanence.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../nix/lanzaboote.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
