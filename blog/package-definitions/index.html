<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My-Nix-Blog</title>
    <style>
      body {
        background-color: #282828; /* Dark background */
        color: #ebdbb2; /* Light text for readability */
      }
      ul li {
        margin-bottom: 0.75em; /* Add space below each link item */
      }

      code {
        font-family: monospace, monospace; /* Use a monospace font */
        font-size: 0.85em; /* Slightly smaller font size can help */
        background-color: #444444; /* A slightly lighter dark background */
        color: #f8f8f2; /* A common light code text color (like Monokai) */
        padding: 2px 5px; /* Add some padding around the text */
        border-radius: 3px; /* Slightly rounded corners */
        border: 1px solid #666666; /* Optional: Add a subtle border */
      }
      </style>
    <link rel="stylesheet" type="text/css" href="https://saylesss88.github.io/static/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
    <link rel="stylesheet" type="text/css" href="https://saylesss88.github.io/static/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  </head>

  <body>
    <section class="section">
      <div class="container">
<h1 class="title">Package Definitions Explained</h1>
<p class="subtitle"><strong>2025-05-08</strong></p>
<h2 id="package-definitions-explained">Package Definitions Explained</h2>
<p>A <em>package</em> refers to either a collection of files and other data, or a Nix
expression representing such a collection before it comes into being. You start
by writing a <em>package definition</em> in the Nix language, this definition contains
instructions and metadata about the software or artifact you want to "package".</p>
<ul>
<li>
<p>This package definition, when evaluated by Nix, results in a <em>derivation</em>. A
package definition is essentially a Nix language function. And Nix Language
is similar to JSON with functions.</p>
</li>
<li>
<p>The derivation is the concrete build plan that Nix uses to fetch sources,
build dependencies, compile code, and ultimately produce the desired output
(the package).</p>
</li>
</ul>
<p>So, the <em>package definition</em> is the blueprint, and the <em>derivation</em> is the
detailed plan that Nix follows to build the package. You don't directly get a
"package" in the sense of a pre-built artifact until Nix executes the derivation.</p>
<p>The following is a skeleton derivation:</p>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{ </span><span style="color:#ffcc66;">stdenv </span><span>}:
</span><span>
</span><span style="color:#ffcc66;">stdenv</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">mkDerivation </span><span>{ }
</span></code></pre>
<ul>
<li>This is a function which takes an attribute set containing <code>stdenv</code>, and
produces a derivation (which currently does nothing).
<a href="https://ryantm.github.io/nixpkgs/stdenv/stdenv/">The Standard Environment</a>
<a href="https://nixos.org/guides/nix-pills/19-fundamentals-of-stdenv.html">Fundamentals of Stdenv</a></li>
</ul>
<h3 id="a-package-function">A Package Function</h3>
<p>The following is a package definition that is a Nix function that will
evaluate to a derivation.</p>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="font-style:italic;color:#5c6773;"># hello.nix
</span><span>{
</span><span>  </span><span style="color:#ffcc66;">stdenv</span><span style="color:#f29e74;">,
</span><span>  </span><span style="color:#ffcc66;">fetchzip</span><span style="color:#f29e74;">,
</span><span>}:
</span><span>
</span><span style="color:#ffcc66;">stdenv</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">mkDerivation </span><span>{
</span><span>  </span><span style="color:#ffd580;">pname </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;hello&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">version </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;2.12.1&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>  </span><span style="color:#ffd580;">src </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">fetchzip </span><span>{
</span><span>    </span><span style="color:#ffd580;">url </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;https://ftp.gnu.org/gnu/hello/hello-2.12.1.tar.gz&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">sha256 </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  }</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<ul>
<li>
<p>If you save and try to run this file with <code>nix-build hello.nix</code> it will fail
because <code>stdenv</code> is a part of Nixpkgs which we haven't included yet. So it
only produces its intended output if it's passed the correct arguments which
we haven't done yet.</p>
</li>
<li>
<p><code>stdenv</code> is available from <code>nixpkgs</code>, which must be imported with another
Nix expression in order to pass it as an argument to this derivation.</p>
</li>
</ul>
<p>The recommended way is to create a <code>default.nix</code> file in the same directory as
<code>hello.nix</code>, with the following contents:</p>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="font-style:italic;color:#5c6773;"># default.nix
</span><span style="color:#ffa759;">let
</span><span>  </span><span style="color:#ffd580;">nixpkgs </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">fetchTarball </span><span style="color:#bae67e;">&quot;https://github.com/NixOS/nixpkgs/tarball/nixos-24.05&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">pkgs </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">import </span><span style="color:#ffcc66;">nixpkgs </span><span>{ </span><span style="color:#ffd580;">config </span><span style="color:#f29e74;">= </span><span>{}</span><span style="color:#ccc9c2cc;">; </span><span style="color:#ffd580;">overlays </span><span style="color:#f29e74;">= </span><span>[]</span><span style="color:#ccc9c2cc;">; </span><span>}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">in
</span><span>{
</span><span>  </span><span style="color:#ffd580;">hello </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">pkgs</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">callPackage </span><span style="color:#bae67e;">./hello.nix </span><span>{ }</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<p>Now you can run <code>nix-build -A hello</code> to realize the derivation from the package
definition in <code>hello.nix</code>.</p>
<ul>
<li>
<p>While the terms "realize" and "evaluate" are related, "realize" is often used specifically in the context of building a derivation and producing the output in the Nix store.</p>
</li>
<li>
<p>The <code>-A</code> tells Nix to build a specific attribute named <code>hello</code> from the
top-level expression.</p>
</li>
<li>
<p>Notice the <code>hello.nix</code> has a placeholder <code>""</code> for the sha256. This is because
it's impossible for Nix to know the value before the derivation is realized.
After running <code>nix-build -A hello</code> the compiler will give it to you:</p>
</li>
</ul>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">nix-build</span><span style="color:#ffcc66;"> -A</span><span> hello
</span><span style="color:#ffd580;">error:</span><span> hash mismatch in fixed-output derivation </span><span style="color:#bae67e;">&#39;/nix/store/pd2kiyfa0c06giparlhd1k31bvllypbb-source.drv&#39;</span><span>:
</span><span>         </span><span style="color:#ffd580;">specified:</span><span> sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
</span><span>            </span><span style="color:#ffd580;">got:</span><span>    sha256-1kJjhtlsAkpNB7f6tZEs+dbKd8z7KoNHyDHEJ0tmhnc=
</span><span style="color:#ffd580;">error:</span><span> 1 dependencies of derivation </span><span style="color:#bae67e;">&#39;/nix/store/b4mjwlv73nmiqgkdabsdjc4zq9gnma1l-hello-2.12.1.drv&#39;</span><span> failed to build
</span></code></pre>
<ul>
<li>Replace the placeholder sha256 with <code>sha256 = "1kJjhtlsAkpNB7f6tZEs+dbKd8z7KoNHyDHEJ0tmhnc="</code>
in the <code>hello.nix</code>.</li>
</ul>
<h3 id="build-the-result">Build the Result</h3>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">./result/bin/hello
</span><span style="color:#ffd580;">Hello,</span><span> world!
</span></code></pre>
<h3 id="swaytools-package-definition">Swaytools Package Definition</h3>
<p>The following is the swaytools package definition located at <code>nixpkgs/pkgs/tools/wayland/swaytools/default.nix</code> part of the Nixpkgs collection:</p>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="font-style:italic;color:#5c6773;"># default.nix
</span><span>{
</span><span>  </span><span style="color:#ffcc66;">lib</span><span style="color:#f29e74;">,
</span><span>  </span><span style="color:#ffcc66;">setuptools</span><span style="color:#f29e74;">,
</span><span>  </span><span style="color:#ffcc66;">buildPythonApplication</span><span style="color:#f29e74;">,
</span><span>  </span><span style="color:#ffcc66;">fetchFromGitHub</span><span style="color:#f29e74;">,
</span><span>  </span><span style="color:#ffcc66;">slurp</span><span style="color:#f29e74;">,
</span><span>}:
</span><span>
</span><span style="color:#ffcc66;">buildPythonApplication </span><span style="color:#ffa759;">rec </span><span>{
</span><span>  </span><span style="color:#ffd580;">pname </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;swaytools&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">version </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;0.1.2&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>  </span><span style="color:#ffd580;">format </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;pyproject&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>  </span><span style="color:#ffd580;">src </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">fetchFromGitHub </span><span>{
</span><span>    </span><span style="color:#ffd580;">owner </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;tmccombs&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">repo </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;swaytools&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">rev </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">version</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">sha256 </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;sha256-UoWK53B1DNmKwNLFwJW1ZEm9dwMOvQeO03+RoMl6M0Q=&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  }</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>  </span><span style="color:#ffd580;">nativeBuildInputs </span><span style="color:#f29e74;">= </span><span>[ </span><span style="color:#ffcc66;">setuptools </span><span>]</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>  </span><span style="color:#ffd580;">propagatedBuildInputs </span><span style="color:#f29e74;">= </span><span>[ </span><span style="color:#ffcc66;">slurp </span><span>]</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>  </span><span style="color:#ffd580;">meta </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">with </span><span style="color:#ffcc66;">lib</span><span>; {
</span><span>    </span><span style="color:#ffd580;">homepage </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;https://github.com/tmccombs/swaytools&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">description </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;Collection of simple tools for sway (and i3)&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">license </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">licenses</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">gpl3Only</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">maintainers </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">with </span><span style="color:#ffcc66;">maintainers</span><span>; [ </span><span style="color:#ffcc66;">atila </span><span>]</span><span style="color:#ccc9c2cc;">;
</span><span>    </span><span style="color:#ffd580;">platforms </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">platforms</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">linux</span><span style="color:#ccc9c2cc;">;
</span><span>  }</span><span style="color:#ccc9c2cc;">;
</span><span>}
</span></code></pre>
<ol>
<li>Function Structure:</li>
</ol>
<ul>
<li>The file starts with a function that takes an attribute set as input:</li>
</ul>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{ </span><span style="color:#ffcc66;">lib</span><span style="color:#f29e74;">, </span><span style="color:#ffcc66;">setuptools</span><span style="color:#f29e74;">, </span><span style="color:#ffcc66;">buildPythonApplication</span><span style="color:#f29e74;">, </span><span style="color:#ffcc66;">fetchFromGitHub</span><span style="color:#f29e74;">, </span><span style="color:#ffcc66;">slurp </span><span>}:
</span></code></pre>
<ul>
<li>These arguments are dependencies or utilities provided by Nixpkgs commonly
used in package definitions.</li>
</ul>
<ol start="2">
<li>Derivation Creation:</li>
</ol>
<ul>
<li>The function calls <code>buildPythonApplication</code>, a helper function for creating
python based packages, which produces a derivation:</li>
</ul>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#ffcc66;">buildPythonApplication </span><span style="color:#ffa759;">rec </span><span>{ ... }
</span></code></pre>
<ul>
<li>This is similar to <code>stdenv.mkDerivation</code> but tailored for Python apps</li>
</ul>
<ol start="3">
<li>Package Metadata:</li>
</ol>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#ffcc66;">pname </span><span style="color:#ff3333;">= </span><span style="color:#bae67e;">&quot;swaytools&quot;</span><span style="color:#ff3333;">;
</span><span style="color:#ffcc66;">version </span><span style="color:#ff3333;">= </span><span style="color:#bae67e;">&quot;0.1.2&quot;</span><span style="color:#ff3333;">;
</span></code></pre>
<ul>
<li><code>meta</code> provides additional metadata (e.g. description, license) which is standard for package defs:</li>
</ul>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#ffcc66;">meta </span><span style="color:#ff3333;">= with </span><span style="color:#ffcc66;">lib</span><span style="color:#ff3333;">; </span><span>{
</span><span>  </span><span style="color:#ffd580;">homepage </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;https://github.com/tmccombs/swaytools&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">description </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;Collection of simple tools for sway (and i3)&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">license </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">licenses</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">gpl3Only</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">maintainers </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">with </span><span style="color:#ffcc66;">maintainers</span><span>; [ </span><span style="color:#ffcc66;">atila </span><span>]</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">platforms </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">platforms</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">linux</span><span style="color:#ccc9c2cc;">;
</span><span>}</span><span style="color:#ff3333;">;
</span></code></pre>
<ol start="4">
<li>Source Specification:</li>
</ol>
<ul>
<li>The <code>src</code> attribute tells where to fetch the source code, using <code>fetchFromGithub</code>:</li>
</ul>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#ffcc66;">src </span><span style="color:#ff3333;">= </span><span style="color:#ffcc66;">fetchFromGitHub </span><span>{
</span><span>  </span><span style="color:#ffd580;">owner </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;tmccombs&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">repo </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;swaytools&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">rev </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">version</span><span style="color:#ccc9c2cc;">;
</span><span>  </span><span style="color:#ffd580;">sha256 </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;sha256-UoWK53B1DNmKwNLFwJW1ZEm9dwMOvQeO03+RoMl6M0Q=&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>}</span><span style="color:#ff3333;">;
</span></code></pre>
<ol start="5">
<li>Build and Runtime Dependencies:</li>
</ol>
<ul>
<li>
<p><code>nativeBuildInputs</code> lists tools needed during the build process</p>
</li>
<li>
<p><code>propagatedBuildInputs</code> lists runtime deps (e.g. <code>slurp</code>)</p>
</li>
</ul>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#ffcc66;">nativeBuildInputs </span><span style="color:#ff3333;">= </span><span>[ </span><span style="color:#ffcc66;">setuptools </span><span>]</span><span style="color:#ff3333;">;
</span><span style="color:#ffcc66;">propagatedBuildInputs </span><span style="color:#ff3333;">= </span><span>[ </span><span style="color:#ffcc66;">slurp </span><span>]</span><span style="color:#ff3333;">;
</span></code></pre>
<ol start="6">
<li>Build Format:</li>
</ol>
<ul>
<li>
<p>The <code>format = "pyproject";</code> attribute indicates that the packages uses a <code>pyproject.toml</code> file for its build configuration.</p>
</li>
<li>
<p>Location: The file is located at <code>pkgs/tools/wayland/swaytools/default.nix</code></p>
</li>
<li>
<p>Integration: This package is referenced in <code>/pkgs/top-level/all-packages.nix</code>
like this:</p>
</li>
</ul>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="font-style:italic;color:#5c6773;"># all-packages.nix
</span><span style="color:#ffcc66;">swaytools </span><span style="color:#ff3333;">= </span><span style="color:#ffcc66;">python3Packages</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">callPackage </span><span style="color:#bae67e;">../tools/wayland/swaytools </span><span>{ }</span><span style="color:#ff3333;">;
</span></code></pre>
<ul>
<li>This allows Nix to instantiate the package by passing the required arguments (<code>lib</code>, <code>setuptools</code>, etc) from Nixpkgs.</li>
</ul>
<h3 id="resources">Resources</h3>
<ul>
<li><a href="https://nix.dev/tutorials/packaging-existing-software.html">Packaging Existing Software</a></li>
</ul>
 </div>
    </section>
  </body>
</html>
