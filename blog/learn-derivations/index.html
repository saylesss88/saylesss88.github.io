<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My-Nix-Blog</title>
    <style>
      body {
        background-color: #282828; /* Dark background */
        color: #ebdbb2; /* Light text for readability */
      }
      ul li {
        margin-bottom: 0.75em; /* Add space below each link item */
      }

     /* style for inline code blocks */
      :not(pre) > code {
        font-family: monospace, monospace; /* Use a monospace font */
        font-size: 0.85em; /* Slightly smaller font size can help */
        background-color: #444444; /* A slightly lighter dark background */
        color: #f8f8f2; /* A common light code text color (like Monokai) */
        padding: 2px 5px; /* Add some padding around the text */
        border-radius: 3px; /* Slightly rounded corners */
        border: 1px solid #666666; /* Optional: Add a subtle border */
      }
    </style>
    <link rel="stylesheet" type="text/css" href="https://saylesss88.github.io/static/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
    <link rel="stylesheet" type="text/css" href="https://saylesss88.github.io/static/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  </head>

  <body>
    <section class="section">
      <div class="container">
<h1 class="title">Derivations Explained &amp; Resources</h1>
<p class="subtitle"><strong>2025-05-09</strong></p>
<h2 id="derivations">Derivations</h2>
<ul>
<li>
<p>A derivation in Nix is a core concept that describes how to build a piece of software or a resource (e.g., a package, library, or configuration file). For beginners, you can think of a derivation as a recipe for cooking a dish. Just as a recipe lists ingredients (dependencies), steps (build instructions), and the final dish (output), a derivation tells Nix what inputs to use, how to build something, and what the result will be.</p>
</li>
<li>
<p>To create a package definition in Nix, developers typically use mkDerivation, which is the standard approach provided by stdenv. While the built-in derivation function exists for lower-level use cases requiring fine-grained control, mkDerivation streamlines the process by handling dependencies and build environments automatically. This function takes a set of attributes as its main input, defining all the details of how to build your software or resource. At a minimum, this set needs to include the following three essential attributes:</p>
</li>
</ul>
<ol>
<li><strong>name:</strong> This is a human-readable name for your derivation, like "foo" in our upcoming example. It helps identify the package you are building.</li>
<li><strong>system:</strong> This attribute specifies the target system architecture for which you are building (e.g., <code>builtins.currentSystem</code>, which means build for the system Nix is currently running on).</li>
<li><strong>builder:</strong> This attribute tells Nix <em>how</em> to build the output. It's the program that will execute the build steps, like our <code>bash</code> example.</li>
</ol>
<h3 id="the-builder">The Builder</h3>
<p>So the derivation is like the recipe, the builder is what executes the recipe.</p>
<ul>
<li>
<p>The most simple way to execute a sequence of commands is probably a bash script, so we'll use bash as our builder with the script being the sequence of commands. The problem with Nix is that upfront it has no way of knowing what the path to <code>bash</code> will be until we actually build it preventing us from using hashbang or shebang in our script (i.e. <code>#!/usr/bin/env bash</code>). While you might have bash installed on your current system and could use a hashbang, doing so would tie your build to that specific system's environment, thus losing the cool stateless property of Nix. (stateful = traditional where if you make a change the changes are saved directly to the computer) (stateless = When you "install" a program in Nix, it doesn't directly modify the core system. Instead it creates a unique store path allowing multiple versions of the same program)</p>
</li>
<li>
<p>To further clarify, Traditional package management systems modify a system’s core environment when installing a program (stateful installation). This means changes persist directly within the system, which can lead to dependency conflicts and make rollback difficult.</p>
</li>
</ul>
<p>Nix, on the other hand, ensures stateless installations—instead of modifying the base system, it creates immutable store paths for each package, allowing multiple versions to coexist seamlessly. This approach:</p>
<ul>
<li>
<p>Eliminates conflicts (different versions of the same package can exist side by side).</p>
</li>
<li>
<p>Enables reliable rollback (switch back to a previous version without affecting system-wide files).</p>
</li>
<li>
<p>Guarantees reproducibility (builds behave the same way regardless of the machine, if built pure).</p>
</li>
<li>
<p>With all of that noted, we'll create our <code>builder.sh</code> in the current directory:</p>
</li>
</ul>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="font-style:italic;color:#5c6773;"># builder.sh
</span><span style="color:#ffa759;">declare </span><span style="color:#ffcc66;">-x</span><span>p
</span><span style="color:#f28779;">echo</span><span> foo </span><span style="color:#f29e74;">&gt; </span><span>$out
</span></code></pre>
<ul>
<li>
<p>The command <code>declare -xp</code> lists exported variables (it's a bash builtin function).</p>
</li>
<li>
<ul>
<li>Nix needs to know where the final built product (the "cake" in our earlier analogy) should be placed. So, during the derivation process, Nix calculates a unique output path within the Nix store. This path is then made available to our builder script as an environment variable named <code>$out</code>. The <code>.drv</code> file, which is the recipe, contains instructions for the builder, including setting up this <code>$out</code> variable. Our builder script will then put the result of its work (in this case, the "foo" file) into this specific <code>$out</code> directory.</li>
</ul>
</li>
<li>
<p>As mentioned earlier we need to find the nix store path to the bash executable, common way to do this is to load Nixpkgs into the repl and check:</p>
</li>
</ul>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">nix-repl</span><span style="color:#f29e74;">&gt;</span><span> :l </span><span style="color:#f29e74;">&lt;</span><span>nixpkgs</span><span style="color:#f29e74;">&gt;
</span><span style="color:#ffd580;">Added</span><span> 3950 variables.
</span><span style="color:#ffd580;">nix-repl</span><span style="color:#f29e74;">&gt; </span><span style="color:#bae67e;">&quot;$</span><span>{bash}</span><span style="color:#bae67e;">&quot;
</span><span style="color:#bae67e;">&quot;/nix/store/ihmkc7z2wqk3bbipfnlh0yjrlfkkgnv6-bash-4.2-p45&quot;
</span></code></pre>
<p>So, with this little trick we are able to refer to <code>bin/bash</code> and create our derivation:</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">nix-repl</span><span style="color:#f29e74;">&gt;</span><span> d = derivation { name = </span><span style="color:#bae67e;">&quot;foo&quot;</span><span>; builder = </span><span style="color:#bae67e;">&quot;$</span><span>{bash}</span><span style="color:#bae67e;">/bin/bash&quot;</span><span>; args = </span><span style="color:#ffa759;">[</span><span> ./builder.sh </span><span style="color:#ffa759;">]</span><span>; system = builtins.currentSystem; }
</span><span style="color:#ffd580;">nix-repl</span><span style="color:#f29e74;">&gt;</span><span> :b d
</span><span style="color:#ffd580;">[1</span><span> built, 0.0 MiB DL]
</span><span>
</span><span style="color:#ffd580;">this</span><span> derivation produced the following outputs:
</span><span>  </span><span style="color:#ffd580;">out</span><span> -</span><span style="color:#f29e74;">&gt;</span><span> /nix/store/gczb4qrag22harvv693wwnflqy7lx5pb-foo
</span></code></pre>
<ul>
<li>
<p>Boom! The contents of <code>/nix/store/w024zci0x1hh1wj6gjq0jagkc1sgrf5r-foo</code> is really foo! We've built our first derivation.</p>
</li>
<li>
<p>Derivations are the primitive that Nix uses to define packages. “Package” is a loosely defined term, but a derivation is simply the result of calling <code>builtins.derivation</code>.</p>
</li>
</ul>
<h2 id="another-more-simple-example">Another More Simple Example</h2>
<p>The following is a simple <code>hello-drv</code> derivation:</p>
<pre data-lang="nix" style="background-color:#212733;color:#ccc9c2;" class="language-nix "><code class="language-nix" data-lang="nix"><span style="color:#ffcc66;">nix-repl</span><span style="color:#f29e74;">&gt; </span><span style="color:#ffcc66;">hello-drv </span><span style="color:#ff3333;">= </span><span style="color:#ffcc66;">nixpkgs</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">stdenv</span><span style="color:#f29e74;">.</span><span style="color:#ffcc66;">mkDerivation </span><span>{
</span><span>            </span><span style="color:#ffd580;">name </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;hello.txt&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>            </span><span style="color:#ffd580;">unpackPhase </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;true&quot;</span><span style="color:#ccc9c2cc;">;
</span><span>            </span><span style="color:#ffd580;">installPhase </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&#39;&#39;
</span><span style="color:#bae67e;">              echo -n &quot;Hello World!&quot; &gt; $out
</span><span style="color:#bae67e;">            &#39;&#39;</span><span style="color:#ccc9c2cc;">;
</span><span>          }
</span><span>
</span><span style="color:#ffcc66;">nix-repl</span><span style="color:#f29e74;">&gt; </span><span style="color:#ffcc66;">hello-drv
</span><span style="color:#ff3333;">«</span><span style="color:#f28779;">derivation </span><span style="color:#bae67e;">/nix/store/ad6c51ia15p9arjmvvqkn9fys9sf1kdw-hello.txt.drv</span><span style="color:#ff3333;">»
</span></code></pre>
<ul>
<li>Derivations have a <code>.drv</code> suffix, as you can see the result of calling <code>hello-drv</code> is the nix store path to a derivation.</li>
</ul>
<h3 id="links-and-short-overview">Links and short Overview</h3>
<ul>
<li>
<p><a href="https://nixos.org/guides/nix-pills/06-our-first-derivation">NixPillsOurFirstDerivation</a></p>
</li>
<li>
<p><a href="https://nixos.org/guides/nix-pills/07-working-derivation">NixPills-WorkingDerivation</a></p>
</li>
<li>
<p><a href="https://nix.dev/manual/nix/2.24/language/derivations">nix.dev-Derivations</a></p>
</li>
<li>
<p><a href="https://nix.dev/tutorials/packaging-existing-software">nix.dev-packagingExistingSoftware</a></p>
</li>
<li>
<p><a href="https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/">howToLearnNix-MyFirstDerivation</a></p>
</li>
<li>
<p><a href="https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/">howToLearnNix-DerivationsInDetail</a></p>
</li>
<li>
<p><a href="https://www.sam.today/blog/creating-a-super-simple-derivation-learning-nix-pt-3">Sparky/blog-creatingASuperSimpleDerivation</a> # How to learn Nix</p>
</li>
<li>
<p><a href="https://www.sam.today/blog/derivations-102-learning-nix-pt-4">Sparky/blog-Derivations102</a></p>
</li>
<li>
<p><a href="https://scrive.github.io/nix-workshop/04-derivations/01-derivation-basics.html">ScriveNixWorkshop-nixDerivationBasics</a></p>
</li>
<li>
<p><a href="https://zero-to-nix.com/concepts/derivations/">zeroToNix-Derivations</a></p>
</li>
<li>
<p><a href="https://www.tweag.io/blog/2021-02-17-derivation-outputs-and-output-paths/">Tweag-derivationOutputs</a></p>
</li>
<li>
<p><a href="https://ayats.org/blog/nix-tuto-2">theNixLectures-Derivations</a></p>
</li>
<li>
<p><a href="https://bmcgee.ie/posts/2023/02/nix-what-are-fixed-output-derivations-and-why-use-them/">bmcgee-whatAreFixed-OutputDerivations</a></p>
</li>
</ul>
 </div>
    </section>
  </body>
</html>
